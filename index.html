<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âœ¨ æ¢¨æ¢¨çš„ç™¾å®ç®± (æœ€ç»ˆå®Œç¾ç‰ˆ v15.0) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
            --lock-bg: #fff0f5;

            /* ğŸ‘‡ ğŸŸ¢ é˜…è¯»å™¨è®¾ç½® ğŸŸ¢ ğŸ‘‡ */
            --reader-bubble-width: 90%; /* æ°”æ³¡å®½åº¦ */
            --reader-line-height: 1.5; /* è¡Œé—´è· */
            --reader-letter-spacing: 0.8px; /* å­—é—´è· */
            --reader-row-spacing: 2px; /* æ®µé—´è· */
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        /* ==================== ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ & é”å±æ ·å¼ ==================== */
        
        #lockScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff5f7; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(#fff 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* é£˜è½æ¨±èŠ± */
        .sakura {
            position: absolute;
            background: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0.5;
            animation: fall linear infinite; pointer-events: none;
        }
        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(100px, 110vh) rotate(360deg); opacity: 0; }
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .lock-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 30px;
            width: 85%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 10;
            transition: transform 0.3s;
        }

        .lock-title { font-size: 24px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; }
        .lock-subtitle { color: #999; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .welcome-btn {
            display: block;
            width: 100%; padding: 18px; border-radius: 50px;
            margin-bottom: 15px; border: none; font-size: 16px; color: white;
            font-family: inherit; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .welcome-btn:active { transform: scale(0.98); }
        .btn-gesture { background: #ffb7c5; }
        .btn-pin { background: linear-gradient(90deg, #a8edea 0%, #ffb7c5 100%); }
        .btn-login-pink { background: #ff9eb5; box-shadow: 0 8px 20px rgba(255, 158, 181, 0.4); }

        .pin-display { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .pin-dot {
            width: 16px;
            height: 16px; border-radius: 50%;
            background: #eee; border: 2px solid #ddd; transition: all 0.2s;
        }
        .pin-dot.active { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 280px; margin: 0 auto; }
        .num-btn {
            width: 60px;
            height: 60px; border-radius: 50%; border: none;
            background: #fff; color: var(--text-color); font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            font-family: inherit; display: flex; align-items: center; justify-content: center;
        }
        .num-btn:active { background: var(--secondary-color); }

        .gesture-container { position: relative; width: 300px; height: 300px; margin: 0 auto; touch-action: none; }
        .gesture-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; }
        .gesture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;
        }
        .gesture-point { display: flex; align-items: center; justify-content: center; }
        .point-inner {
            width: 18px;
            height: 18px; background: #ddd; border-radius: 50%;
            transition: 0.3s;
        }
        .point-inner.active { background: var(--accent-color); box-shadow: 0 0 0 10px rgba(255, 143, 163, 0.2); }

        .lock-input {
            width: 100%;
            padding: 12px; margin: 10px 0; border: 2px solid #ffe6eb;
            border-radius: 12px; text-align: center; font-family: inherit;
            outline: none; color: var(--text-color);
        }
        .lock-input:focus { border-color: var(--accent-color); }

        .back-link { margin-top: 20px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline; }

        .toast {
            position: fixed;
            top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 14px; opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s; z-index: 20000;
        }

        /* ==================== ğŸ”® æŠ½ç­¾ç³»ç»Ÿæ ·å¼ ==================== */
        .lottery-panel { margin-bottom: 15px; text-align: center; }
        .lottery-btn {
            background: linear-gradient(135deg, #fff0f5 0%, #ffc0cb 100%);
            border: 2px solid #fff; color: #d66a80;
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; width: 100%;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3);
            font-weight: bold; transition: transform 0.2s;
        }
        .lottery-btn:active { transform: scale(0.95); }

        .lottery-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 230, 235, 0.9); backdrop-filter: blur(8px);
            z-index: 12000; display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
        }
        .lottery-overlay.active { display: flex; animation: fadeInLottery 0.3s ease; }
        @keyframes fadeInLottery { from {opacity:0;} to {opacity:1;} }

        .lottery-box-container { text-align: center; position: relative; }
        .magic-gift { font-size: 100px; display: block; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        .magic-gift.shaking { animation: shakeBox 0.5s infinite; }
        @keyframes shakeBox {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        .lottery-result-card {
            display: none;
            flex-direction: column; align-items: center;
            background: white; padding: 20px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(255, 100, 150, 0.3);
            border: 4px solid #fff;
            width: 260px; animation: popIn 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from {transform: scale(0) rotate(-20deg); opacity: 0;} to {transform: scale(1) rotate(0); opacity: 1;} }

        .lottery-img-wrapper {
            width: 220px;
            height: 220px; border-radius: 20px; overflow: hidden;
            margin-bottom: 15px; border: 2px solid #ffe6eb; background: #fff5f7;
            display: flex; align-items: center; justify-content: center;
        }
        .lottery-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .lottery-name { font-size: 20px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px; }
        .lottery-hint { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        
        .go-btn {
            background: var(--accent-color);
            color: white; border: none;
            padding: 10px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 143, 163, 0.4);
            animation: pulse 2s infinite; font-family: inherit;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .close-lottery { position: absolute;
            top: 30px; right: 30px; font-size: 30px; color: #fff; background: rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; }

        /* ==================== åŸæœ‰ CSS ==================== */
        #appContainer {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸ¶ æ‚¬æµ®çª— --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn {
            width: 48px;
            height: 48px; border-radius: 50%;
            background: #fff; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex;
            justify-content: center; align-items: center;
            font-size: 24px; cursor: move; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .float-btn:active { transform: scale(0.9); }
        .float-btn::after { content: 'ğŸ¶'; }
        
        .float-menu {
            position: absolute;
            bottom: 60px; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; width: 260px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff;
            transform-origin: bottom right; transform: scale(0); opacity: 0;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; max-height: 60vh; display: flex; flex-direction: column;
        }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 10px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px;
            height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 10px; }
        .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; font-size: 13px; }
        
        .search-container { max-width: 600px; margin: 0 auto 10px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }

        /* ğŸŸ¢ è§†å›¾åˆ‡æ¢æ  */
        .layout-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; margin: 0 auto 25px auto;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
            padding: 6px 12px 6px 15px; border-radius: 50px; width: fit-content;
            border: 2px solid #fff0f5; box-shadow: 0 5px 15px rgba(255, 183, 197, 0.25);
        }
        .layout-label { font-size: 13px; color: var(--accent-color); font-weight: bold; margin-right: 8px; display: flex; align-items: center; }
        .layout-btn {
            background: none; border: none; width: 36px; height: 36px;
            cursor: pointer; border-radius: 50%; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex; align-items: center; justify-content: center; opacity: 0.6; font-size: 18px;
        }
        .layout-btn.active { background: #fff; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3); opacity: 1; transform: scale(1.1); }

        /* ğŸŸ¢ æ“ä½œæŒ‰é’®ç½‘æ ¼ */
        .action-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 98%; margin: 0 auto 20px auto; }
        .action-card {
            background: #fff; border: 2px solid #ffb7c5; border-radius: 20px;
            padding: 10px 2px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: #ff8fa3; font-weight: bold; font-size: 12px;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2); height: 70px;
        }
        .action-card:active { transform: scale(0.95); }
        .action-card.primary { background: #fff; border: 2px solid #ff8fa3; color: #ff8fa3; box-shadow: 0 4px 12px rgba(255, 143, 163, 0.3); }
        .kitty-icon { font-size: 24px; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(255,183,197,0.3)); }

        /* æ‰¹é‡åˆ é™¤ç›¸å…³æ ·å¼ */
        .card.is-selecting { animation: shake 0.3s ease; }
        .card.selected { border-color: #ff6b6b !important; background-color: #fff0f0; position: relative; }
        .card.selected::after { content: 'âœ…'; position: absolute; top: 5px; right: 5px; font-size: 20px; background: rgba(255,255,255,0.8); border-radius: 50%; }

        /* ğŸ”´ å…³é”®ä¿®å¤ï¼šéšè—åˆ é™¤æ¡ */
        .delete-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px);
            opacity: 0; pointer-events: none;
            background: #fff; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 15px;
            z-index: 10000; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); border: 2px solid #ff6b6b;
        }
        .delete-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .delete-btn-confirm { background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: bold; }
        .delete-btn-cancel { background: #f0f0f0; color: #666; border: none; padding: 8px 20px; border-radius: 30px; }
        .controls { display: none; }

        /* ğŸŸ¢ Grid å¸ƒå±€æ¨¡å¼ */
        .grid-container { display: grid; gap: 20px; max-width: 1200px; margin: 0 auto; transition: all 0.3s ease; }
        .grid-container.mode-default { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        .grid-container.mode-large { grid-template-columns: repeat(auto-fill, minmax(40%, 1fr)); }
        .grid-container.mode-mini { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
        .grid-container.mode-mini .card-img-wrapper { height: 120px; }
        .grid-container.mode-mini .card-title { font-size: 14px; }
        .grid-container.mode-list { grid-template-columns: 1fr; }
        .grid-container.mode-list .card { flex-direction: row; height: 100px; }
        .grid-container.mode-list .card-img-wrapper { width: 100px; height: 100%; flex-shrink: 0; }
        .grid-container.mode-list .card-content { justify-content: center; }
        .grid-container.mode-list .tags-container { margin-top: 5px; }

        .card { background: #fff; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; }
        .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color);
            border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }

        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: flex-start; gap: 10px; background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap;}
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        
        .resource-name-input { width: 100%; border: none; border-bottom: 1px dashed #ccc; padding: 2px 0; font-size: 14px; color: #333; border-radius: 0; background: transparent; outline: none; }
        .resource-name-input:focus { border-bottom-color: var(--accent-color); }
        
        .resource-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; width: auto; flex-grow: 1; max-width: 120px; }
        .custom-type-input { font-size: 12px; padding: 2px 5px; border: 1px solid #ffb7c5; border-radius: 4px; width: 80px; display: none; }

        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-left: auto; align-self: center;}

        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn { font-size: 14px; padding: 5px 12px; }

        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; }
        .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        
        .detail-list { margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        
        .action-link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .action-link:hover { background: var(--primary-color); color: white; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; }
        .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        
        input[type="file"] { display: none; }
        
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        button.primary-btn { background: var(--accent-color); color: white; border: none; }

        /* ==================== ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤ (é˜…è¯»æ¨¡å¼) ==================== */
        
        .reader-modal {
            background: #f5f5f5;
            width: 100%; height: 100%; top: 0; left: 0;
            max-width: none; max-height: none; border-radius: 0;
            display: flex; flex-direction: column; padding: 0;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
            flex-shrink: 0;
        }

        .reader-title { font-weight: bold; color: var(--text-color); font-size: 16px; }
        .reader-subtitle { font-size: 10px; color: #999; margin-top: 2px; }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto; padding: 20px; padding-bottom: 80px;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        .chat-row {
            display: flex;
            margin-bottom: var(--reader-row-spacing); 
            align-items: flex-end;
            position: relative;
            animation: fadeInUp 0.3s ease;
        }

        .floor-tag {
            position: absolute;
            top: -18px; font-size: 10px; color: #ccc;
            font-family: monospace; background: rgba(255,255,255,0.5);
            padding: 0 4px; border-radius: 4px;
        }

        .chat-bubble {
            max-width: var(--reader-bubble-width);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            
            padding: 12px 16px; border-radius: 18px;
            font-size: 15px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }

        .chat-name {
            font-size: 11px;
            color: #999; margin-bottom: 4px; margin-left: 4px;
            text-align: left;
        }

        .chat-row.left { justify-content: flex-start; }
        .chat-row.left .floor-tag { left: 10px; }
        .chat-row.left .chat-bubble { background: #fff; color: #333; border-bottom-left-radius: 4px; }

        .chat-row.right { justify-content: flex-end; }
        .chat-row.right .chat-name { margin-right: 4px; } 
        .chat-row.right .floor-tag { right: 10px; }
        .chat-row.right .chat-bubble { background: var(--accent-color); color: #fff; border-bottom-right-radius: 4px; }

        .close-reader {
            background: #eee;
            border: none; width: 32px; height: 32px; border-radius: 50%;
            font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .reader-footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            flex-shrink: 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .page-btn {
            padding: 8px 15px;
            border-radius: 20px; border: 1px solid #ddd;
            background: #fff; color: #666; font-size: 13px; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .page-btn:active { transform: scale(0.95); background: #f0f0f0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 13px; color: var(--accent-color); font-weight: bold; }

             /* ... ä¸Šé¢çš„ CSS ä¿æŒä¸å˜ ... */

        /* ==================== ğŸŸ¢ æ–°å¢ï¼šé˜…è¯»å™¨ç¼–è¾‘ä¸ä¹¦ç­¾æ ·å¼ ==================== */

        /* 1. ç¼–è¾‘æ¨¡å¼æ ·å¼ (ä¿®æ”¹ç‰ˆï¼šæ›´å¤§ã€æ›´æ¸…æ™°) */
        .bubble-edit-wrapper {
            width: 100%;
        }
        .bubble-textarea {
            width: 100%;
            min-height: 200px; /* ğŸŸ¢ æ”¹åŠ¨ï¼šé»˜è®¤é«˜åº¦åŠ å¤§åˆ° 200px */
            padding: 12px;     /* ğŸŸ¢ æ”¹åŠ¨ï¼šå†…è¾¹è·åŠ å¤§ */
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;   /* ğŸŸ¢ æ”¹åŠ¨ï¼šç¼–è¾‘æ—¶å­—ä½“æ”¾å¤§ï¼Œçœ‹å­—æ›´æ¸…æ¥š */
            line-height: 1.6;
            resize: vertical;  /* å…è®¸ä¸Šä¸‹æ‹‰ä¼¸ */
            outline: none;
            background: #fff;
            color: #333;
            margin-bottom: 8px;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹é˜´å½±è®©å®ƒæµ®èµ·æ¥çš„æ„Ÿè§‰ */
        }
        .edit-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px; /* æŒ‰é’®é—´è·æ‹‰å¤§ */
        }
        .edit-confirm-btn {
            background: var(--accent-color);
            color: white; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .edit-cancel-btn {
            background: #eee;
            color: #666; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
        }

        /* ... ä¸‹é¢çš„ CSS (ä¹¦ç­¾æ ·å¼ç­‰) ä¿æŒä¸å˜ ... */

        /* 2. ä¹¦ç­¾æŒ‰é’® */
        .bookmark-icon { margin-left: 5px; cursor: pointer; font-size: 14px; color: #ddd; transition: color 0.2s; }
        .bookmark-icon.active { color: #ffd700; text-shadow: 0 0 2px rgba(255, 215, 0, 0.5); }
        .floor-tag { display: flex; align-items: center; pointer-events: auto; }

        /* 3. ä¹¦ç­¾åˆ—è¡¨ - å±…ä¸­å¼¹çª—æ ·å¼ (ä¿®å¤ç‰ˆ) */
        .bookmark-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 80%; max-width: 320px; height: 60%; max-height: 500px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(255, 183, 197, 0.5); z-index: 6000;
            display: flex; flex-direction: column; border: 2px solid #fff;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .bookmark-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        /* ğŸŸ¢ æ–°å¢ï¼šCSS ç¼–è¾‘æŠ½å±‰æ ·å¼ (å¤ç”¨ä¹¦ç­¾æŠ½å±‰çš„é€»è¾‘) */
        .css-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 85%; max-width: 400px; height: 70%; max-height: 600px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(100, 100, 255, 0.2); 
            z-index: 6001; /* æ¯”ä¹¦ç­¾å±‚çº§å†é«˜ä¸€ç‚¹ */
            display: flex; flex-direction: column; border: 2px solid #e0f7fa;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .css-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        .bookmark-header {
            padding: 15px 20px; font-weight: bold; color: var(--accent-color);
            border-bottom: 1px solid #ffe6eb; display: flex; justify-content: space-between; align-items: center;
            background: #fff0f5; border-radius: 25px 25px 0 0;
        }
        .bookmark-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .bookmark-item {
            background: #fff; border: 1px solid #ffe6eb; border-radius: 10px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .bookmark-item:hover { background: #fff0f5; transform: translateX(-2px); }
        .bm-floor { font-size: 12px; color: #999; margin-bottom: 4px; font-weight: bold; }
        .bm-note { font-size: 14px; color: #555; word-break: break-all; }
        .bm-empty { text-align: center; color: #ccc; font-size: 13px; margin-top: 50px; }
        
        .highlight-row { animation: flashRow 2s ease; }
        @keyframes flashRow { 0% { background: rgba(255, 215, 0, 0.3); } 100% { background: transparent; } }

        /* ==================== ğŸ’­ å°è±¡æ·±åˆ»çš„è¯ (èƒŒæ™¯å¼¹å¹•ç‰¹æ•ˆ) ==================== */
        .memory-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
            z-index: 0; /* æ”¾åœ¨æœ€åº•å±‚ */
        }

        .memory-text {
            position: absolute;
            font-family: 'MyCustomFont', sans-serif; /* ç”¨ä½ æŒ‡å®šçš„å¯çˆ±å­—ä½“ */
            white-space: nowrap;
            color: rgba(255, 183, 197, 0.6); /* æ·¡æ·¡çš„ç²‰è‰²ï¼ŒåŠé€æ˜ */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: floatUp linear forwards;
        }

        /* æ–‡å­—å‘ä¸Šé£˜åŠ¨çš„åŠ¨ç”» */
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.9) rotate(-5deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-20vh) scale(1.1) rotate(5deg);
                opacity: 0;
            }
        }

        /* ä¸ºäº†é˜²æ­¢èƒŒæ™¯æ–‡å­—é®æŒ¡å†…å®¹ï¼Œæˆ‘ä»¬è¦ç»™å†…å®¹åŠ ä¸ªå±‚çº§ */
        .modal-content-wrapper {
            position: relative;
            z-index: 2; /* ç¡®ä¿å†…å®¹åœ¨æ–‡å­—ä¸Šé¢ */
        }

        /* ==================== ğŸ’® å¿ƒæƒ…å°ç« ç³»ç»Ÿ ==================== */
        
        /* å°ç« é€‰æ‹©æ  */
        .stamp-bar {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px 0;
            padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 50px;
        }
        
        .stamp-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent;
            background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); opacity: 0.7; filter: grayscale(0.8);
        }
        
        .stamp-btn:hover { transform: translateY(-3px); }
        
        /* æ¿€æ´»çŠ¶æ€ï¼šå˜æˆå½©è‰²ï¼Œå‘å…‰ */
        .stamp-btn.active {
            border-color: var(--accent-color); opacity: 1; filter: grayscale(0);
            transform: scale(1.1); box-shadow: 0 5px 15px rgba(255, 143, 163, 0.3);
        }

        /* ç›–åœ¨å³ä¸Šè§’çš„å¤§å°ç«  */
        .big-stamp-mark {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 100px;
            opacity: 0;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸æŒ¡æ“ä½œ */
            transform: scale(3) rotate(-30deg); /* åˆå§‹çŠ¶æ€ï¼šå¾ˆå¤§ï¼Œæ‚¬ç©º */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§åŠ¨ç”» */
            z-index: 0; /* æ”¾åœ¨åº•å±‚ï¼ŒèƒŒæ™¯å­—ä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
            filter: drop-shadow(0 0 0 transparent); /* åˆå§‹æ— é˜´å½± */
        }

        /* ç›–ä¸‹å»çš„çŠ¶æ€ */
        .big-stamp-mark.stamped {
            opacity: 0.15; /* æ·¡æ·¡çš„å°è®° */
            transform: scale(1) rotate(-20deg); /* ç ¸ä¸‹æ¥ */
            filter: drop-shadow(2px 2px 0px rgba(255, 100, 100, 0.2));
        }

        /* ==================== ğŸ™ˆ é˜²çª¥æ¨¡å¼ (Privacy Blur) ==================== */
        
        /* 1. å½“ body åŠ ä¸Š privacy-active ç±»æ—¶ï¼Œæ¨¡ç³Šæ‰€æœ‰å›¾ç‰‡ */
        body.privacy-active .card img,       /* é¦–é¡µå¡ç‰‡å°é¢ */
        body.privacy-active .gallery-img,    /* è¯¦æƒ…é¡µå¤§å›¾ */
        body.privacy-active .resource-preview img { /* ç¼–è¾‘åˆ—è¡¨é‡Œçš„ç¼©ç•¥å›¾ */
            filter: blur(20px) !important;   /* å¼ºåŠ›é«˜æ–¯æ¨¡ç³Š */
            opacity: 0.8;                    /* ç¨å¾®å˜æ·¡ä¸€ç‚¹ */
            transition: all 0.3s ease;       /* ä¸æ»‘è¿‡æ¸¡ */
        }

        /* 2. å³ä¸Šè§’çš„çœ¼ç›æŒ‰é’®æ ·å¼ */
        .privacy-toggle-btn {
            position: absolute;
            top: 20px; 
            right: 20px;
            font-size: 22px;
            cursor: pointer;
            z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2);
            transition: all 0.2s;
            color: var(--accent-color);
        }
        
        .privacy-toggle-btn:active { transform: scale(0.9); }

        /* ==================== âœ¨ æŒ‡å°–é­”æ³• (é¼ æ ‡+ç‚¹å‡»ç‰¹æ•ˆ) ==================== */
        
        /* 1. å…¨å±€é¼ æ ‡å˜å¯çˆ± (æ¢æˆçŒ«çˆªæˆ–é­”æ³•æ£’) */
        body {
            /* è¿™é‡Œç”¨çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„å¯çˆ±å…‰æ ‡é“¾æ¥ï¼Œå¦‚æœå¤±æ•ˆäº†ä¼šé€€åŒ–æˆé»˜è®¤çš„ */
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat120.cur'), auto; 
        }
        
        /* æŒ‰é’®å˜æˆæ‰‹æŒ‡ */
        button, .card, .action-card, .stamp-btn {
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat122.cur'), pointer;
        }

        /* 2. ç‚¹å‡»çˆ†å‡ºçš„ç²’å­ */
        .magic-particle {
            position: fixed;
            pointer-events: none; /* ä¸æŒ¡é¼ æ ‡ */
            animation: particleFloat 1s ease-out forwards;
            font-size: 20px;
            z-index: 9999;
            user-select: none;
        }

        @keyframes particleFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

    </style>

    <style id="custom-reader-style"></style> 
</head>

</head>
<body>

    <div id="lotteryOverlay" class="lottery-overlay">
        <div class="close-lottery" onclick="closeLottery()">Ã—</div>
        <div class="lottery-box-container" id="lotteryBox">
            <div class="magic-gift" id="magicGift">ğŸ</div>
            <div class="lottery-result-card" id="lotteryResult">
                <div class="lottery-img-wrapper"><img id="lotteryImg" src=""></div>
                <div class="lottery-name" id="lotteryName">???</div>
                <div class="lottery-hint">âœ¨ å‘½è¿é€‰æ‹©äº†å®ƒ âœ¨</div>
                <button class="go-btn" onclick="goToLotteryItem()">ğŸ‘‰ å°±æ˜¯ä½ äº†ï¼</button>
            </div>
        </div>
    </div>

    <div id="lockScreen">
        <div id="sakuraContainer"></div>

        <div id="view-landing" class="lock-card" style="display:none; text-align:center;">
            <div style="font-size:50px; margin-bottom:20px;">ğŸŒ¸</div>
            <div class="lock-title" style="font-size:28px;">æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="lock-subtitle">âœ¨ æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ âœ¨</div>
            <button class="welcome-btn btn-login-pink" style="color:white; margin-top:30px; font-size:18px;" onclick="auth.proceedFromLanding()">âœ¨ ç«‹å³ç™»å½• âœ¨</button>
        </div>

        <div id="view-welcome" class="lock-card" style="display:none;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸŒ¸</div>
            <div class="lock-title">è®¾ç½®è§£é”æ–¹å¼</div>
            <div class="lock-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            <button class="welcome-btn btn-gesture" onclick="auth.startSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="welcome-btn btn-pin" onclick="auth.startSetup('pin')">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div id="view-setup-question" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ” å®‰å…¨ä¿éšœ</div>
            <div class="lock-subtitle">ä¸‡ä¸€å¿˜äº†å¯†ç ï¼Œè¿™ä¸ªå¯ä»¥æ•‘ä½ ï¼</div>
            <div class="form-group" style="text-align:left;">
                <label>è®¾ç½®ä¸€ä¸ªå®‰å…¨é—®é¢˜</label>
                <input type="text" id="secQuestion" class="lock-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€åªå® ç‰©æ˜¯ï¼Ÿ">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>é—®é¢˜çš„ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            </div>
            <button class="welcome-btn btn-gesture" onclick="auth.saveSecurityQuestion()">å®Œæˆè®¾ç½®</button>
        </div>

        <div id="view-pin" class="lock-card" style="display:none;">
            <div class="lock-title" id="pinTitle">è¯·è¾“å…¥å¯†ç </div>
            <div class="lock-subtitle" id="pinSub">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            <div class="pin-display" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="numpad">
                <button class="num-btn" onclick="auth.inputPin(1)">1</button>
                <button class="num-btn" onclick="auth.inputPin(2)">2</button>
                <button class="num-btn" onclick="auth.inputPin(3)">3</button>
                <button class="num-btn" onclick="auth.inputPin(4)">4</button>
                <button class="num-btn" onclick="auth.inputPin(5)">5</button>
                <button class="num-btn" onclick="auth.inputPin(6)">6</button>
                <button class="num-btn" onclick="auth.inputPin(7)">7</button>
                <button class="num-btn" onclick="auth.inputPin(8)">8</button>
                <button class="num-btn" onclick="auth.inputPin(9)">9</button>
                <div></div>
                <button class="num-btn" onclick="auth.inputPin(0)">0</button>
                <button class="num-btn" style="color:#ff6b6b" onclick="auth.clearPin()">ğŸ”™</button>
            </div>
            <div class="back-link" id="pinForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
        </div>

        <div id="view-gesture" class="lock-card" style="display:none;">
            <div class="lock-title" id="gestTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <div class="lock-subtitle" id="gestSub">è¯·ç»˜åˆ¶ä½ çš„è§£é”å›¾æ¡ˆ</div>
            <div class="gesture-container" id="gestureArea">
                <div class="gesture-grid">
                    <div class="gesture-point"><div class="point-inner" data-idx="0"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="1"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="2"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="3"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="4"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="5"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="6"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="7"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="8"></div></div>
                </div>
                <canvas id="gestureCanvas" width="300" height="300"></canvas>
            </div>
            <div class="back-link" id="gestForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
            <div class="back-link" id="gestResetBtn" onclick="auth.resetGesture()" style="display:none">é‡ç»˜</div>
        </div>

        <div id="view-recovery" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ˜Ÿ å¿˜è®°å¯†ç äº†ï¼Ÿ</div>
            <div class="lock-subtitle" id="recoveryQText">å›ç­”ä½ çš„å®‰å…¨é—®é¢˜</div>
            <input type="text" id="recoveryAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            <button class="welcome-btn btn-gesture" onclick="auth.checkRecovery()">éªŒè¯</button>
            <div class="back-link" onclick="location.reload()">è¿”å›</div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div id="appContainer">
        
        <div class="privacy-toggle-btn" id="privacyBtn" onclick="togglePrivacyMode()" title="ç‚¹å‡»å¼€å¯é˜²çª¥/æ¨¡ç³Šæ¨¡å¼">
            ğŸ‘ï¸
        </div>

        <h1>ğŸŒ¸ æˆ‘çš„ç™¾å®ç®±  ğŸŒ¸</h1>

        <div class="float-widget" id="floatWidget">
            <div class="float-menu" id="floatMenu">
                <div class="music-panel">
                    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
                    <div class="music-controls">
                        <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
                        <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
                    </div>
                    <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
                    <audio id="bgMusic" loop></audio>
                </div>
                
                <div class="lottery-panel">
                    <button class="lottery-btn" onclick="startLottery()">ğŸ”® å‘½è¿çš„æŠ‰æ‹©</button>
                </div>

                           <div class="tavern-portal-panel" style="margin-bottom:15px; position:relative; width:100%;">
                    
                    <button id="tavernJumpBtn" 
                            style="width:100%; box-sizing: border-box; background:linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border:2px solid #fff; color:#fa8c16; padding:8px 15px; border-radius:20px; font-size:13px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(255, 169, 64, 0.2); transition:transform 0.2s;"
                            onclick="jumpToTavern()">
                        ğŸº å¯åŠ¨é…’é¦†
                    </button>
                    
                    <button style="position:absolute; right:2px; top:2px; height:calc(100% - 4px); width:35px; background:transparent; border:none; color:#fa8c16; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0.6;"
                            onclick="changeTavernLink()"
                            title="ä¿®æ”¹é…’é¦†é“¾æ¥">
                        âš™ï¸
                    </button>
                </div>
               
                <div class="nav-panel" id="navPanel">
                    <div class="nav-title">ğŸ·ï¸ å¿«é€Ÿè·³è½¬</div>
                </div>
            </div>
            <div class="float-btn" id="floatBtn"></div>
        </div>

              <div class="search-container" style="display:flex; align-items:center; gap:10px;">
            <div style="position:relative; flex-grow:1;">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="handleSearch()">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <label style="font-size:12px; color:var(--accent-color); cursor:pointer; display:flex; align-items:center; gap:4px; white-space:nowrap;">
                <input type="checkbox" id="deepSearchCheck" onchange="handleSearch()" style="width:auto;">
                æœå†…å®¹
            </label>
        </div>


        <div class="layout-bar">
            <span class="layout-label">ğŸ‘€ è§†å›¾:</span>
            <button class="layout-btn" title="é»˜è®¤ç½‘æ ¼" onclick="switchLayout('default')">ğŸ©¶</button>
            <button class="layout-btn" title="é•¿åˆ—è¡¨" onclick="switchLayout('list')">ğŸ©µ</button>
            <button class="layout-btn" title="å¤§å›¾æ¨¡å¼" onclick="switchLayout('large')">ğŸ¤</button>
            <button class="layout-btn" title="è¿·ä½ æ¨¡å¼" onclick="switchLayout('mini')">ğŸ©·</button>
        </div>

        <div class="action-grid">
            <div class="action-card primary" onclick="openAddModal()">
                <div class="kitty-icon">ğŸ€</div>
                <div>æ·»åŠ </div>
            </div>
            
            <div class="action-card" onclick="document.getElementById('batchImgInput').click()">
                <div class="kitty-icon">ğŸ“¸</div>
                <div>æ‰¹é‡åŠ </div>
                <input type="file" id="batchImgInput" multiple style="display:none" onchange="handleBatchImageImport(this)">
            </div>

            <div class="action-card" onclick="toggleBatchDeleteMode()">
                <div class="kitty-icon">ğŸ§¹</div>
                <div>æ‰¹é‡åˆ </div>
            </div>

            <div class="action-card" onclick="exportAllData()">
                <div class="kitty-icon">ğŸ’¾</div>
                <div>å¤‡ä»½</div>
            </div>

            <div class="action-card" onclick="document.getElementById('importAllInput').click()">
                <div class="kitty-icon">ğŸ‘œ</div>
                <div>å¯¼å…¥</div>
                <input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)">
            </div>
        </div>

        <div class="grid-container mode-default" id="gridContainer">
            <div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            <div class="form-group"><label>ğŸ’– åå­—</label><input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—..."></div>
            <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾ (è¾“å…¥åç‚¹+å·æˆ–å›è½¦)</label><div style="display:flex; align-items:center; gap:10px;"><div class="tag-input-area" id="tagInputArea" style="flex-grow:1;" onclick="document.getElementById('tagInput').focus()"><input type="text" id="tagInput" onkeydown="handleTagInput(event)"></div><button class="small-btn primary-btn" style="height:40px; width:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0;" onclick="manualAddTag()">ï¼‹</button></div><div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                       <div class="form-group">
                <label>ğŸ’­ å°è±¡æœ€æ·±çš„è¯ (ä¸€è¡Œä¸€å¥ï¼Œä¼šé£˜åœ¨èƒŒæ™¯é‡Œå“¦)</label>
                <textarea id="itemMemories" placeholder="ä¾‹å¦‚ï¼š
ç¬¬ä¸€æ¬¡è§ä½ çš„æ—¶å€™...
é‚£å¤©æ™šä¸Šçš„æœˆäº®å¾ˆåœ†...
(æŒ‰å›è½¦æ¢è¡Œï¼Œå¯ä»¥å†™å¾ˆå¤šå¥)" style="width:100%; height:100px; padding:10px; border:2px solid var(--secondary-color); border-radius:12px; outline:none; font-family:inherit; resize:vertical; background:#fff;"></textarea>
            </div>
                     <div class="form-group">
               <label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label><div class="resource-list" id="resourceList"><div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div></div><div class="add-btn-row"><label class="upload-area small-btn" style="flex-grow:1; text-align:center;">ğŸ“‚ åŠ æ–‡ä»¶ (å›¾ç‰‡/æ–‡æ¡£/å…¶ä»–)<input type="file" multiple onchange="handleUniversalSelect(this)"></label><button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button></div><div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;"><input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;"><div style="text-align:right;"><button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button><button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button></div></div></div>
            <div class="modal-buttons"><button onclick="closeAddModal()">å–æ¶ˆ</button><button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button></div>
        </div>
    </div>

                <div class="modal-overlay" id="detailModal">
        <div class="modal" style="position: relative; max-height: 85vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;"> 
            
            <div class="memory-layer" id="memoryLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;"></div>

            <div id="bigStamp" class="big-stamp-mark"></div>

            <div class="modal-content-wrapper" style="overflow-y: auto; flex-grow: 1; position: relative; z-index: 2; padding: 25px;">
                
                <button class="close-modal" onclick="closeDetailModal()" style="position: absolute; top: 15px; right: 15px;">Ã—</button>
                <h2 id="detailName" style="text-align:center; margin-bottom:5px; margin-top: 0;"></h2>
                <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>
                
                <div class="stamp-bar">
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ¬')" title="è¶…ç”œ">ğŸ¬</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ‹')" title="åƒé†‹/é…¸æ¶©">ğŸ‹</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ”ª')" title="åˆ€å­/è™å¿ƒ">ğŸ”ª</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸš—')" title="é£™è½¦/åˆºæ¿€">ğŸš—</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ’¤')" title="æ—¥å¸¸/ç¡è§‰">ğŸ’¤</div>
                </div>
                <div id="galleryArea">
                    <div class="gallery-container">
                        <div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div>
                        <img id="detailImg" class="gallery-img" src="">
                        <div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div>
                        <div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div>
                        <button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button>
                        <button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button>
                        <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;">
                            <span id="imgIndex">1</span> / <span id="imgTotal">1</span>
                        </div>
                    </div>
                </div>
                
                <div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>
                <div class="form-group"><label>ğŸ“‚ ç›’å­å†…å®¹</label><div id="detailListContainer" class="detail-list"></div></div>
                
                <div class="modal-buttons" style="justify-content: center; flex-wrap:wrap; margin-top: 20px;">
                    <button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘ç›’å­å†…å®¹</button>
                    <button onclick="deleteCurrentItem()" style="border-color: #ffcccc; color: #ff6b6b;">ğŸ—‘ï¸ åˆ é™¤ç›’å­</button>
                </div>
            
            </div> 
        </div>
    </div>
               
    <div class="modal-overlay" id="readerModal" style="z-index: 5000;">
        <div class="modal reader-modal">
                       <div class="reader-header">
                <button class="close-reader" onclick="closeReader()">â†</button>
                
                <div style="text-align:center">
                    <div class="reader-title" id="readerTitle">å›å¿†è®°å½•</div>
                    <div class="reader-subtitle" id="readerCount" style="cursor:pointer" onclick="toggleBookmarkDrawer()">0 æ¡è®°å½• (ç‚¹å‡»æŸ¥çœ‹ä¹¦ç­¾)</div>
                </div>
                
                <div style="display:flex; gap:5px;">
                    <button class="close-reader" style="font-size:16px;" onclick="toggleCssDrawer()">ğŸ¨</button>
                    <button class="close-reader" style="font-size:16px;" onclick="toggleBookmarkDrawer()">â­</button> 
                </div>
            </div>

<div class="css-drawer" id="cssDrawer">
    <div class="bookmark-header">
        <span>ğŸ¨ çš®è‚¤è®¾è®¡å¸ˆ</span>
        <span style="font-size:12px;cursor:pointer" onclick="toggleCssDrawer()">å…³é—­</span>
    </div>
    <div style="padding:15px; display:flex; flex-direction:column; height:100%;">
        <select id="themeSelect" onchange="loadSelectedTheme()" style="margin-bottom:10px; padding:5px;">
            <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>
        </select>

        <textarea id="cssInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ CSS ä»£ç ... ä¾‹å¦‚: .chat-bubble { background: pink; }" style="flex-grow:1; width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family:monospace; margin-bottom:10px; resize:none;"></textarea>

        <div style="display:flex; gap:5px;">
            <input type="text" id="themeNameInput" placeholder="ç»™ä¸»é¢˜èµ·ä¸ªå..." style="flex-grow:1; padding:5px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="saveCustomTheme()" style="background:var(--accent-color); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
            <button onclick="deleteCustomTheme()" style="background:#ffcccc; color:#ff6b6b; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">åˆ </button>
        </div>

        <button onclick="previewCss()" style="margin-top:10px; background:#e0f7fa; color:#006064; border:none; padding:8px; border-radius:5px; cursor:pointer; width:100%;">âš¡ ç«‹å³ç”Ÿæ•ˆ (é¢„è§ˆ)</button>
    </div>
</div>

            <div class="bookmark-drawer" id="bookmarkDrawer">
                <div class="bookmark-header">
                    <span>ğŸ“‘ æˆ‘çš„ä¹¦ç­¾</span>
                    <span style="font-size:12px;color:#999;cursor:pointer" onclick="toggleBookmarkDrawer()">å…³é—­</span>
                </div>
                <div class="bookmark-list" id="bookmarkList">
                    </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
            </div>

            <div class="reader-footer" id="readerFooter">
                <button class="page-btn" onclick="prevPage()">â—€ ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">1 / 1</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>
    </div>

    <div id="deleteBar" class="delete-bar">
        <button class="delete-btn-cancel" onclick="toggleBatchDeleteMode()">å–æ¶ˆ</button>
        <button class="delete-btn-confirm" onclick="confirmBatchDelete()">ğŸ—‘ï¸ åˆ é™¤ (<span id="deleteCount">0</span>)</button>
    </div>

    <script>
        // ================= ğŸ”’ å®‰å…¨ç³»ç»Ÿ (AuthSystem) =================
        const auth = {
            mode: 'login', type: null, step: 0, tempSecret: null, inputBuffer: '', failCount: 0,
            
            init: function() {
                this.createSakura();
                this.showView('view-landing');
            },

            proceedFromLanding: function() {
                const savedType = localStorage.getItem('magic_auth_type');
                const savedSecret = localStorage.getItem('magic_auth_secret');
                if (!savedType || !savedSecret) { this.showView('view-welcome'); } 
                else {
                    this.mode = 'login';
                    this.type = savedType;
                    if (this.type === 'pin') this.showView('view-pin'); else this.showView('view-gesture');
                    if (this.type === 'gesture') setTimeout(() => this.initGesture(), 100);
                }
            },

            createSakura: function() {
                const container = document.getElementById('sakuraContainer');
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    el.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(el);
                }
            },
            showView: function(id) {
                ['view-landing', 'view-welcome', 'view-pin', 'view-gesture', 'view-setup-question', 'view-recovery'].forEach(v => {
                    const el = document.getElementById(v); if(el) el.style.display = 'none';
                });
                document.getElementById(id).style.display = 'block';
                if(id === 'view-pin') this.updatePinDots();
            },
            toast: function(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            },
            startSetup: function(type) {
                this.mode = 'setup';
                this.type = type; this.step = 1; this.inputBuffer = '';
                if (type === 'pin') {
                    document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                    document.getElementById('pinSub').textContent = 'è¯·è¾“å…¥4ä½æ–°å¯†ç '; this.showView('view-pin');
                } else {
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ'; this.showView('view-gesture'); setTimeout(() => this.initGesture(), 100);
                }
            },
            inputPin: function(num) {
                if (this.inputBuffer.length < 4) {
                    this.inputBuffer += num;
                    this.updatePinDots();
                    if (this.inputBuffer.length === 4) setTimeout(() => this.submitPin(), 200);
                }
            },
            clearPin: function() { this.inputBuffer = ''; this.updatePinDots(); },
            updatePinDots: function() { const dots = document.getElementById('pinDots').children;
                for(let i=0; i<4; i++) { if(i < this.inputBuffer.length) dots[i].classList.add('active'); else dots[i].classList.remove('active'); } },
            submitPin: function() {
                const val = this.inputBuffer;
                this.inputBuffer = ''; this.updatePinDots();
                if (this.mode === 'setup') {
                    if (this.step === 1) { this.tempSecret = val;
                        this.step = 2; document.getElementById('pinTitle').textContent = 'å†æ¬¡ç¡®è®¤'; document.getElementById('pinSub').textContent = 'è¯·å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤'; } 
                    else { if (val === this.tempSecret) this.finishPasswordSetup(val);
                    else { this.toast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); this.step = 1; document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç '; } }
                } else if (this.mode === 'login') { if (val === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                else this.handleFail(); }
            },
            
            initGesture: function() {
                const canvas = document.getElementById('gestureCanvas');
                const ctx = canvas.getContext('2d'); 
                const area = document.getElementById('gestureArea');
                let isDrawing = false; let path = [];
                canvas.width = 300;
                canvas.height = 300; 

                const getPoint = (x, y) => { 
                    const rect = area.getBoundingClientRect();
                    const rx = x - rect.left; const ry = y - rect.top;
                    const col = Math.floor(rx / (300/3));
                    const row = Math.floor(ry / (300/3));
                    if(col>=0 && col<3 && row>=0 && row<3) return row*3 + col;
                    return -1; 
                };
                const draw = (curX, curY) => {
                    ctx.clearRect(0, 0, 300, 300);
                    ctx.strokeStyle = '#ffb7c5'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    if(path.length > 0) { 
                        ctx.beginPath();
                        const p0 = getCenter(path[0]); ctx.moveTo(p0.x, p0.y); 
                        for(let i=1; i<path.length; i++) { const p = getCenter(path[i]); ctx.lineTo(p.x, p.y); } 
                        if(curX !== null) ctx.lineTo(curX, curY);
                        ctx.stroke(); 
                    }
                    document.querySelectorAll('.point-inner').forEach((el, i) => { if(path.includes(i)) el.classList.add('active'); else el.classList.remove('active'); });
                };
                const getCenter = (idx) => { const row = Math.floor(idx/3), col = idx%3;
                    return { x: col*100 + 50, y: row*100 + 50 }; };
                
                const start = (e) => { e.preventDefault(); e.stopPropagation(); isDrawing = true; path = []; move(e); };
                const move = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); e.stopPropagation();
                    let cx, cy; if(e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
                    const rect = area.getBoundingClientRect();
                    const idx = getPoint(cx, cy); if(idx !== -1 && !path.includes(idx)) path.push(idx); 
                    draw(cx - rect.left, cy - rect.top); 
                };
                const end = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); isDrawing = false; draw(null, null); 
                    if(path.length < 3) { this.toast('ç‚¹å¤ªå°‘å•¦'); path = []; draw(null,null); return; } 
                    const code = path.join('');
                    if(this.mode === 'setup') { 
                        if(this.step === 1) { this.tempSecret = code;
                            this.step = 2; document.getElementById('gestTitle').textContent = 'å†æ¬¡ç»˜åˆ¶'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } 
                        else { if(code === this.tempSecret) this.finishPasswordSetup(code);
                        else { this.toast('ä¸ä¸€è‡´'); this.step = 1; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } } 
                    } else if(this.mode === 'login') { 
                        if(code === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                        else { this.handleFail(); setTimeout(()=>{ path=[]; draw(null,null); }, 500); } 
                    } 
                };
                const newCanvas = canvas.cloneNode(true); canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.addEventListener('mousedown', start); newCanvas.addEventListener('touchstart', start, {passive: false});
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end);

                this.resetGesture = () => { this.step = 1; this.tempSecret = null; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; document.getElementById('gestResetBtn').style.display = 'none';
                    path = []; draw(null,null); };
            },

            finishPasswordSetup: function(secret) { this.finalSecret = secret; this.finalType = this.type; this.showView('view-setup-question'); },
            saveSecurityQuestion: function() { const q = document.getElementById('secQuestion').value.trim();
                const a = document.getElementById('secAnswer').value.trim(); if(!q || !a) { this.toast('è¯·å¡«å†™å®Œæ•´'); return; } localStorage.setItem('magic_auth_type', this.finalType); localStorage.setItem('magic_auth_secret', this.finalSecret); localStorage.setItem('magic_auth_q', q); localStorage.setItem('magic_auth_a', a); this.toast('è®¾ç½®æˆåŠŸï¼');
                this.unlockApp(); },
            handleFail: function() { this.failCount++; this.toast('å¯†ç é”™è¯¯');
                if(this.failCount >= 3) { if(this.type==='pin') document.getElementById('pinForgotBtn').style.display='block'; else document.getElementById('gestForgotBtn').style.display='block'; } },
            showRecovery: function() { const q = localStorage.getItem('magic_auth_q');
                if(!q) { this.toast('æœªè®¾ç½®é—®é¢˜'); return; } document.getElementById('recoveryQText').textContent = q; this.showView('view-recovery'); },
            checkRecovery: function() { if(document.getElementById('recoveryAnswer').value.trim() === localStorage.getItem('magic_auth_a')) { localStorage.removeItem('magic_auth_type');
                localStorage.removeItem('magic_auth_secret'); this.toast('éªŒè¯æˆåŠŸï¼Œè¯·é‡è®¾'); setTimeout(() => location.reload(), 1000); } else this.toast('é”™è¯¯'); },
            unlockApp: function() { document.getElementById('lockScreen').style.transition = 'opacity 0.5s';
                document.getElementById('lockScreen').style.opacity = 0; setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; if(!window.appInitialized) { initOriginalApp(); window.appInitialized = true; } }, 500);
            }
        };

        // ================= ğŸ“± åº”ç”¨æ ¸å¿ƒé€»è¾‘ =================
        let items = [];
        let draftResources = []; 
        let currentTags = [];
        let isEditing = false;
        let editingIndex = -1;
        let viewingIndex = -1;
        let galleryIndex = 0;
        let currentLuckyIndex = -1;

        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶', 'è‡ªå®šä¹‰'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';
        let db;

        window.onload = function() { auth.init(); };
        function initOriginalApp() { initDB().then(() => { loadFromDB(); migrateFromLocalStorage(); initLayout(); }); initMusic(); initDraggable(); }
        function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onerror = () => reject(); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); }; request.onsuccess = (e) => { db = e.target.result; resolve(); }; }); }
        async function loadFromDB() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { items = req.result.sort((a, b) => new Date(b.date) - new Date(a.date)); renderGrid(items);
            renderNavPanel(); 
updateTitleLevel(); 
}; }
        async function saveItemToDB(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); const req = item.id ? store.put(item) : store.add(item); req.onsuccess = () => resolve(req.result); req.onerror = () => { alert('ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶å¤ªå¤§ï¼Ÿ'); reject(); }; }); }
        async function deleteItemFromDB(id) { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete(id);
            return new Promise(resolve => tx.oncomplete = resolve); }
        function migrateFromLocalStorage() { const old = localStorage.getItem('my_magic_collection_v3');
            if(old) { try { const p = JSON.parse(old); if(p.length > 0 && confirm('å‘ç°æ—§æ•°æ®ï¼Œè¿ç§»å—ï¼Ÿ')) { const tx = db.transaction(STORE_NAME, 'readwrite');
            p.forEach(i => { delete i.id; tx.objectStore(STORE_NAME).add(i); }); tx.oncomplete = () => { alert('è¿ç§»æˆåŠŸï¼'); localStorage.removeItem('my_magic_collection_v3'); loadFromDB(); };
            } } catch(e){} } }

        function renderGrid(dataList) {
updateTitleLevel(); 
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            if (dataList.length === 0) { 
                container.innerHTML = '<div class="empty-state">ç©ºç©ºçš„...å¿«å»æ·»åŠ å§ï¼</div>';
                return; 
            }

            dataList.forEach((item) => {
                const realIndex = items.indexOf(item);
                const card = document.createElement('div'); 
                
                card.className = 'card';
            
                if (isBatchDeleteMode) {
                    card.classList.add('is-selecting');
                    if (selectedDeleteIds.has(item.id)) {
                        card.classList.add('selected');
                    }
        
                    card.onclick = () => {
                        if (selectedDeleteIds.has(item.id)) {
                            selectedDeleteIds.delete(item.id);
                        } else {
                            selectedDeleteIds.add(item.id);
                        }
                        renderGrid(dataList); 
                        updateDeleteBar();
                    };
                } else {
                    card.onclick = () => openDetailModal(realIndex);
                }

                const images = item.resources.filter(r => r.type === 'image');
                let coverSrc = PLACEHOLDER_IMG; 
                if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
                
                const imgWrapper = document.createElement('div'); 
                imgWrapper.className = 'card-img-wrapper';
                const img = document.createElement('img'); 
                img.src = coverSrc; 
                imgWrapper.appendChild(img);
                
                const content = document.createElement('div'); 
                content.className = 'card-content';
                const title = document.createElement('h3');
                title.className = 'card-title'; 
                title.textContent = item.name;
                content.appendChild(title); 
                
                const tagsDiv = document.createElement('div'); 
                tagsDiv.className = 'tags-container';
                (item.tags||[]).forEach(t => { 
                    const span = document.createElement('span'); 
                    span.className = 'tag-pill'; 
                    span.textContent = t; 
                    tagsDiv.appendChild(span); 
                }); 
                content.appendChild(tagsDiv);
                
                card.appendChild(imgWrapper); 
                card.appendChild(content); 
                container.appendChild(card);
            });
        }

        function switchLayout(mode) {
            const c = document.getElementById('gridContainer');
            c.className = 'grid-container'; 
            c.classList.add('mode-' + mode);
            
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
            if(mode==='default') document.querySelector('.layout-btn[title="é»˜è®¤ç½‘æ ¼"]').classList.add('active');
            if(mode==='list') document.querySelector('.layout-btn[title="é•¿åˆ—è¡¨"]').classList.add('active');
            if(mode==='large') document.querySelector('.layout-btn[title="å¤§å›¾æ¨¡å¼"]').classList.add('active');
            if(mode==='mini') document.querySelector('.layout-btn[title="è¿·ä½ æ¨¡å¼"]').classList.add('active');

            localStorage.setItem('my_magic_layout', mode);
            auth.toast('è§†å›¾åˆ‡æ¢æˆåŠŸ âœ¨');
        }

        function initLayout() {
            const mode = localStorage.getItem('my_magic_layout') || 'default';
            switchLayout(mode);
        }

        // --- æŠ½ç­¾é€»è¾‘ ---
        function startLottery() {
            if(items.length === 0) { auth.toast('ç›’å­æ˜¯ç©ºçš„æ€ä¹ˆæŠ½å‘€~'); return; }
            document.getElementById('floatMenu').classList.remove('active');
            const overlay = document.getElementById('lotteryOverlay');
            const gift = document.getElementById('magicGift');
            const result = document.getElementById('lotteryResult');
            overlay.classList.add('active'); result.style.display = 'none'; gift.style.display = 'block'; gift.classList.add('shaking');
            const luckyIndex = Math.floor(Math.random() * items.length);
            currentLuckyIndex = luckyIndex;
            const item = items[luckyIndex];
            document.getElementById('lotteryName').textContent = item.name;
            const images = item.resources.filter(r => r.type === 'image');
            let coverSrc = PLACEHOLDER_IMG; 
            if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
            document.getElementById('lotteryImg').src = coverSrc;
            setTimeout(() => { gift.classList.remove('shaking'); gift.style.display = 'none'; result.style.display = 'flex'; }, 1500);
        }
        function closeLottery() { document.getElementById('lotteryOverlay').classList.remove('active'); }
        function goToLotteryItem() { closeLottery(); if(currentLuckyIndex !== -1) setTimeout(() => openDetailModal(currentLuckyIndex), 300); }

        // --- ğŸŸ¢ å¢å¼ºç‰ˆï¼šå…¨èƒ½æ‰¹é‡å¯¼å…¥ (æ”¯æŒ .jsonl è‡ªåŠ¨è¯†åˆ«) ---
        async function handleBatchImageImport(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            auth.toast(`æ­£åœ¨æ¬è¿ ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨ç­‰... ğŸšš`);
            let count = 0;
            for (let f of files) {
                const name = f.name;
                let resourceType = 'file'; 
                let subType = 'é™„ä»¶';
                let content = null;
                if (f.type.startsWith('image/')) {
                    resourceType = 'image';
                    subType = 'é»˜è®¤';
                    content = await readFile(f); 
                } else if (f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    resourceType = 'json';
                    subType = 'æ•°æ®';
                    content = await readFileText(f);
                } else {
                    resourceType = 'file';
                    subType = 'é™„ä»¶';
                    content = await readFile(f); 
                }

                const newItem = { 
                    name: name, 
                    tags: ['æ‰¹é‡å¯¼å…¥'], 
                    resources: [{ 
                        type: resourceType, 
                        subType: subType, 
                        name: name, 
                        content: content 
                    }], 
                    coverIndex: 0, 
                    date: new Date().toISOString() 
                };
                try { 
                    await saveItemToDB(newItem);
                    count++; 
                } catch(e) { 
                    console.error("æ–‡ä»¶å¤ªå¤§æˆ–ä¿å­˜å¤±è´¥:", e);
                    auth.toast(`âŒ ${name} å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹ï¼`);
                }
            }
            loadFromDB();
            auth.toast(`æå®šï¼æˆåŠŸå­˜å…¥äº† ${count} ä¸ªå®è´ï¼âœ¨`);
            input.value = ''; 
        }

        // ================= ğŸ§¹ æ‰¹é‡åˆ é™¤é€»è¾‘ =================

        let isBatchDeleteMode = false;
        let selectedDeleteIds = new Set(); 

        function toggleBatchDeleteMode() {
            isBatchDeleteMode = !isBatchDeleteMode;
            selectedDeleteIds.clear(); 
            updateDeleteBar();
            handleSearch(); 
            
            if(isBatchDeleteMode) {
                auth.toast('è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šè¯·ç‚¹é€‰è¦åˆ é™¤çš„ç›’å­ ğŸ—‘ï¸');
            }
        }

        function updateDeleteBar() {
            const bar = document.getElementById('deleteBar');
            const countSpan = document.getElementById('deleteCount');
            
            if (isBatchDeleteMode) {
                bar.classList.add('active');
                countSpan.textContent = selectedDeleteIds.size;
            } else {
                bar.classList.remove('active');
            }
        }

        async function confirmBatchDelete() {
            if (selectedDeleteIds.size === 0) {
                auth.toast('è¿˜æ²¡é€‰ä»»ä½•ä¸œè¥¿å‘¢~');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedDeleteIds.size} ä¸ªç›’å­å—ï¼Ÿæ— æ³•æ¢å¤å“¦ï¼`)) return;
            for (let id of selectedDeleteIds) {
                await deleteItemFromDB(id);
            }

            toggleBatchDeleteMode(); 
            loadFromDB(); 
            auth.toast('æ¸…ç†å®Œæ¯•ï¼å˜å¾—æ¸…çˆ½å¤šå•¦ âœ¨');
        }

        // --- CRUD & UI Helpers ---
        function resetAddModal() { isEditing = false;
            editingIndex = -1; document.getElementById('modalTitle').textContent = 'âœ¨ æ·»åŠ æ–°æ”¶è—'; document.getElementById('itemName').value = ''; 
    document.getElementById('itemMemories').value = ''; // ğŸŸ¢ æ–°å¢ï¼šæ¸…ç©ºå›å¿†å½•
document.getElementById('tagInput').value = ''; document.getElementById('linkInputArea').style.display = 'none'; draftResources = [];
            currentTags = []; renderTagsInput(); renderResourceList(); renderSuggestTags(); }
        function openAddModal() { resetAddModal(); document.getElementById('addModal').classList.add('active'); }
        function openEditMode() { if (viewingIndex === -1) return; isEditing = true;
            editingIndex = viewingIndex; const item = items[editingIndex]; document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç›’å­å†…å®¹'; document.getElementById('itemName').value = item.name; 
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šå›æ˜¾å›å¿†å½•ï¼ŒæŠŠæ•°ç»„å˜å›å¤šè¡Œæ–‡æœ¬
    document.getElementById('itemMemories').value = (item.memories || []).join('\n');
currentTags = [...(item.tags || [])];
            draftResources = JSON.parse(JSON.stringify(item.resources)); renderTagsInput(); renderResourceList(); renderSuggestTags(); document.getElementById('detailModal').classList.remove('active'); document.getElementById('addModal').classList.add('active'); }
        
        function renderResourceList() {
            const list = document.getElementById('resourceList');
            list.innerHTML = '';
            if(draftResources.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹</div>'; return; }
            draftResources.forEach((res, idx) => {
                const item = document.createElement('div'); item.className = 'resource-item';
                let p = '';
                if (res.type === 'image') p = `<img src="${res.content}" style="width:100%;height:100%;object-fit:cover">`;
                else if (res.type === 'json') p = 'ğŸ“„';
                else if (res.type === 'link') p = 'ğŸ”—';
                else p = 'ğŸ“';

                const isCustom = !TYPES.includes(res.subType) || res.subType === 'è‡ªå®šä¹‰';
                const selectValue = isCustom ? 'è‡ªå®šä¹‰' : res.subType;
                const customInputValue = (isCustom && res.subType !== 'è‡ªå®šä¹‰') ? res.subType : '';
                const customDisplay = isCustom ? 'inline-block' : 'none';

                let controlsHtml = '';
                if (res.type !== 'link') {
                    let options = '';
                    TYPES.forEach(t => { options += `<option value="${t}" ${selectValue === t ? 'selected' : ''}>${t}</option>`; });
                    controlsHtml = `<div class="resource-controls"><select class="resource-type-select" onchange="handleTypeChange(${idx}, this.value)">${options}</select><input type="text" class="custom-type-input" style="display:${customDisplay}" placeholder="è¾“å…¥ç±»å‹" value="${customInputValue}" onchange="updateCustomType(${idx}, this.value)"></div>`;
                } else {
                    controlsHtml = `<span style="font-size:11px;color:#aaa">é“¾æ¥</span>`;
                }
                item.innerHTML = `<div class="resource-preview">${p}</div><div class="resource-info"><input type="text" class="resource-name-input" value="${res.name}" onchange="updateResourceName(${idx}, this.value)" placeholder="è¯·è¾“å…¥æ–‡ä»¶åç§°">${controlsHtml}</div><button class="btn-remove" onclick="removeDraftResource(${idx})">Ã—</button>`;
                list.appendChild(item);
            });
        }

        function updateResourceName(idx, val) { draftResources[idx].name = val; }
        function handleTypeChange(idx, val) { if (val === 'è‡ªå®šä¹‰') { draftResources[idx].subType = 'è‡ªå®šä¹‰';
            } else { draftResources[idx].subType = val; } renderResourceList(); }
        function updateCustomType(idx, val) { draftResources[idx].subType = val; }
        function removeDraftResource(idx) { draftResources.splice(idx, 1); renderResourceList(); }
        
        async function handleUniversalSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) {
                if (f.type.startsWith('image/')) {
                    const b = await readFile(f);
                    draftResources.push({ type: 'image', subType: 'é»˜è®¤', name: f.name, content: b });
                } else if (f.type === 'application/json' || f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    const t = await readFileText(f);
                    draftResources.push({ type: 'json', subType: 'é»˜è®¤', name: f.name, content: t });
                } else {
                    const b = await readFile(f);
                    draftResources.push({ type: 'file', subType: 'é™„ä»¶', name: f.name, content: b });
                }
            }
            renderResourceList();
            input.value = '';
        }

        function openLinkInput() { document.getElementById('linkInputArea').style.display = 'block'; }
        function confirmAddLink() { const n = document.getElementById('newLinkName').value.trim(), u = document.getElementById('newLinkUrl').value.trim();
            if(n && u) { draftResources.push({ type: 'link', subType: 'link', name: n, content: u }); renderResourceList(); document.getElementById('newLinkName').value = '';
            document.getElementById('newLinkUrl').value = ''; document.getElementById('linkInputArea').style.display = 'none'; } else alert('è¯·è¾“å…¥åç§°å’Œç½‘å€'); }
        async function saveItem() { const n = document.getElementById('itemName').value.trim();
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šè·å–å¤šè¡Œæ–‡æœ¬ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
    const memRaw = document.getElementById('itemMemories').value;
    const memList = memRaw.split('\n').filter(line => line.trim() !== '');
    // ğŸ‘† ğŸŸ¢ æ–°å¢ç»“æŸ
if (!n) { alert('åå­—ä¸èƒ½ä¸ºç©º'); return; } if (draftResources.length === 0) { alert('ç›’å­ä¸èƒ½ä¸ºç©º'); return;
            } const d = { name: n, tags: [...currentTags], memories: memList, resources: draftResources, coverIndex: 0, date: new Date().toISOString() };
            if (isEditing) { d.id = items[editingIndex].id; d.coverIndex = items[editingIndex].coverIndex; } await saveItemToDB(d); loadFromDB(); handleSearch(); closeAddModal();
        }
        
        function openDetailModal(index) { 
            viewingIndex = index;
            const item = items[index]; document.getElementById('detailName').textContent = item.name; const tagsBox = document.getElementById('detailTags'); tagsBox.innerHTML = '';
            (item.tags||[]).forEach(t => { const s = document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsBox.appendChild(s); }); const images = item.resources.filter(r => r.type === 'image');
            if(images.length === 0) { document.getElementById('galleryArea').style.display = 'none'; document.getElementById('noImgMsg').style.display = 'block'; } else { document.getElementById('galleryArea').style.display = 'block'; document.getElementById('noImgMsg').style.display = 'none';
            galleryIndex = Math.min(item.coverIndex||0, images.length-1); updateGalleryUI(images); } 
            
            const listContainer = document.getElementById('detailListContainer');
            listContainer.innerHTML = ''; 
            
            item.resources.forEach((res, i) => { 
                const row = document.createElement('div'); row.className = 'detail-item'; 
                let icon = 'ğŸ“„', btn = '', lbl = res.subType; 
                
                const downloadBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`;

                if (res.type === 'image') { 
                    icon = 'ğŸ–¼ï¸'; btn = downloadBtn; 
                } 
                else if (res.type === 'json') { 
                    icon = 'ğŸ“œ'; 
                    btn = `<span class="action-link" style="background:#e0f7fa;color:#006064;margin-right:5px;" onclick="openReader(${i})">ğŸ“– é˜…è¯»</span>` + downloadBtn; 
                } 
                else if (res.type === 'link') { 
                    icon = 'ğŸ”—'; lbl = 'é“¾æ¥'; btn = `<a class="action-link" href="${res.content}" target="_blank">æ‰“å¼€</a>`; 
                } 
                else { 
                    icon = 'ğŸ“'; lbl = 'é™„ä»¶';
                    btn = downloadBtn; 
                } 
                
                row.innerHTML = `<div style="display:flex;align-items:center;min-width:0;"><span class="detail-item-type">${lbl}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${icon} ${res.name}</span></div><div style="flex-shrink:0;margin-left:10px;">${btn}</div>`;
                listContainer.appendChild(row); 
            });
            // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šæ¸²æŸ“å°ç« çŠ¶æ€
            renderStampStatus(items[index].stamp);
            
    // ğŸ‘‡ ğŸŸ¢ åœ¨å‡½æ•°æœ€ååŠ è¿™å¥ï¼Œå¼€å§‹æ’­æ”¾åŠ¨ç”»
    startMemoryAnimation(items[index].memories || []);
document.getElementById('detailModal').classList.add('active'); 
        }

        function updateGalleryUI(images) { const imgEl = document.getElementById('detailImg');
            const curImg = images[galleryIndex]; imgEl.src = curImg.content; document.getElementById('galleryTypeLabel').textContent = curImg.subType; document.getElementById('imgIndex').textContent = galleryIndex + 1; document.getElementById('imgTotal').textContent = images.length;
            const cb = document.getElementById('setCoverBtn'); if(galleryIndex === (items[viewingIndex].coverIndex || 0)) { cb.textContent = 'å½“å‰å°é¢'; cb.classList.add('is-cover'); } else { cb.textContent = 'è®¾ä¸ºå°é¢';
            cb.classList.remove('is-cover'); } }
        function changeGalleryImage(d) { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; galleryIndex += d; if(galleryIndex >= images.length) galleryIndex = 0;
            if(galleryIndex < 0) galleryIndex = images.length - 1; updateGalleryUI(images); }
        async function setAsCover() { if(viewingIndex === -1) return;
            const item = items[viewingIndex]; item.coverIndex = galleryIndex; await saveItemToDB(item); const images = item.resources.filter(r => r.type === 'image'); updateGalleryUI(images); loadFromDB();
        }
        function downloadCurrentGalleryImg() { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; const cur = images[galleryIndex]; downloadFile(cur.name, cur.content);
        }
        function downloadResource(resIndex) { const res = items[viewingIndex].resources[resIndex]; if(res.type === 'link') return;
            downloadFile(res.name, res.content); }
        function downloadFile(name, content) { const a = document.createElement('a');
            if (content.startsWith('data:')) a.href = content; else { const blob = new Blob([content], {type: 'application/json'}); a.href = URL.createObjectURL(blob);
            } a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); if (!content.startsWith('data:')) URL.revokeObjectURL(a.href);
        }
        function readFile(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(file); });
        }
        function readFileText(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsText(file); });
        }
        
        function handleTagInput(e) { 
            if(e.key==='Enter'){ e.preventDefault();
            manualAddTag(); } 
            if(e.key==='Backspace' && !e.target.value) { currentTags.pop(); renderTagsInput(); } 
        }
        function manualAddTag() {
            const el = document.getElementById('tagInput');
            const v = el.value.trim();
            if(v && !currentTags.includes(v)) { currentTags.push(v); el.value=''; renderTagsInput(); }
            el.focus();
        }

        function renderTagsInput() { const area=document.getElementById('tagInputArea'); const inp=document.getElementById('tagInput'); Array.from(area.children).forEach(c=>c!==inp && area.removeChild(c));
            currentTags.forEach((t,i)=>{ const d=document.createElement('div'); d.className='tag-chip'; d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()" style="cursor:pointer">Ã—</span>`; area.insertBefore(d,inp); });
        }
        function renderSuggestTags() { const all=new Set(); items.forEach(i=>(i.tags||[]).forEach(t=>all.add(t))); const box=document.getElementById('suggestedTags'); box.innerHTML='';
            all.forEach(t=>{ const d=document.createElement('div'); d.className='tag-chip'; d.style.background='#f0f0f0'; d.style.color='#666'; d.style.cursor='pointer'; d.textContent=t; d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}}; box.appendChild(d); });
        }
                function handleSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            const isDeep = document.getElementById('deepSearchCheck').checked; // æ˜¯å¦å‹¾é€‰äº†â€œæœå†…å®¹â€

            if (!q) {
                renderGrid(items); // æ²¡å­—å°±æ˜¾ç¤ºå…¨éƒ¨
                return;
            }

            const f = items.filter(item => {
                // 1. åŸºç¡€æœç´¢ï¼šæœåå­—å’Œæ ‡ç­¾
                const matchBasic = item.name.toLowerCase().includes(q) || (item.tags || []).some(t => t.toLowerCase().includes(q));
                
                if (matchBasic) return true;

                // 2. æ·±å±‚æœç´¢ï¼šå¦‚æœå‹¾é€‰äº†ï¼Œå°±å»ç¿» resources é‡Œçš„å†…å®¹
                if (isDeep && item.resources) {
                    return item.resources.some(res => {
                        // åªæœ JSON (èŠå¤©è®°å½•) æˆ– æ–‡æœ¬æ–‡ä»¶
                        if (res.type === 'json' || res.type === 'file') {
                            // ç›´æ¥åœ¨å­—ç¬¦ä¸²é‡Œæ‰¾ï¼Œç®€å•ç²—æš´ä¸”é«˜æ•ˆ
                            return res.content && res.content.toLowerCase().includes(q);
                        }
                        return false;
                    });
                }
                
                return false;
            });

            renderGrid(f);
            
            // ğŸŸ¢ å¦‚æœæ˜¯æ·±å±‚æœç´¢ï¼Œç»™ä¸ªæç¤ºåé¦ˆ
            if(isDeep && q) {
                // ç®€å•çš„é˜²æŠ–æç¤ºï¼Œé¿å…æ¯æ¬¡æ‰“å­—éƒ½å¼¹
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥åˆ©ç”¨ Grid çš„ç©ºçŠ¶æ€æ¥æç¤º
                if(f.length === 0) {
                    document.querySelector('.empty-state').innerHTML = `ğŸ¤” åœ¨å›å¿†é‡Œæ‰¾äº†ä¸€åœˆï¼Œæ²¡æ‰¾åˆ° "${q}"...`;
                }
            }
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
                function closeAddModal() { 
            document.getElementById('addModal').classList.remove('active'); 
        }
        function closeDetailModal() { 
            document.getElementById('detailModal').classList.remove('active'); 
            viewingIndex = -1; 
            
            // ğŸ‘‡ ğŸŸ¢ å¿…é¡»æ”¾åœ¨è¿™ä¸ªèŠ±æ‹¬å·é‡Œé¢ï¼ ğŸŸ¢ ğŸ‘‡
            stopMemoryAnimation();
        }
        async function deleteCurrentItem() { 
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                const id = items[viewingIndex].id; 
                await deleteItemFromDB(id);
                loadFromDB(); 
                closeDetailModal(); 
            } 
        }
        function exportAllData() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { const blob = new Blob([JSON.stringify(req.result)], {type:'application/json'}); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } }
        function importAllData(el) { const file = el.files[0]; if(!file) return;
            const r = new FileReader(); r.onload = e => { try { const imported = JSON.parse(e.target.result);
            if(Array.isArray(imported)) { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); imported.forEach(item => { delete item.id; store.add(item); });
            tx.oncomplete = () => { loadFromDB(); alert('å¯¼å…¥æˆåŠŸï¼'); }; } } catch{ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); } }; r.readAsText(file);
        }
        function initMusic() { const link = localStorage.getItem('my_bgm_link') || DEFAULT_MUSIC;
            const audio = document.getElementById('bgMusic'); audio.src = link; audio.volume = 0.5; document.getElementById('musicLink').value = link;
        }
        function toggleMusic() { const a=document.getElementById('bgMusic'); const b=document.getElementById('playBtn');
            if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';} }
        function changeVolume(s) { document.getElementById('bgMusic').volume=s.value;
        }
        function updateMusicSrc(v) { if(v){document.getElementById('bgMusic').src=v; localStorage.setItem('my_bgm_link',v);
            document.getElementById('playBtn').textContent='â–¶';} }
        function renderNavPanel() { const c = document.getElementById('navPanel'); const t = c.querySelector('.nav-title');
            c.innerHTML=''; c.appendChild(t); const map={}; const no=[]; items.forEach((it,i)=>{ if(!it.tags||it.tags.length==0)no.push(i); else it.tags.forEach(tag=>{ if(!map[tag])map[tag]=[]; map[tag].push(i); }); }); if(no.length) createNavGroup(c,'ğŸ“‚ æœªåˆ†ç±»',no); Object.keys(map).sort().forEach(k=>createNavGroup(c,`ğŸ·ï¸ ${k}`,map[k]));
        }
        function createNavGroup(c,t,idx) { const g=document.createElement('div'); g.style.marginBottom='5px'; const h=document.createElement('div'); h.innerHTML=`${t} â–¾`; h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555;'; h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'};
            const l=document.createElement('div'); l.style.cssText='display:none;padding-left:10px;'; idx.forEach(i=>{ const it=document.createElement('div'); it.textContent=items[i].name; it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888;'; it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active')}; l.appendChild(it); }); g.appendChild(h); g.appendChild(l); c.appendChild(g);
        }

        function initDraggable() {
            const w=document.getElementById('floatWidget'), b=document.getElementById('floatBtn'), m=document.getElementById('floatMenu');
            let isDragging=false, startX, startY, initialLeft, initialTop;
            b.addEventListener('mousedown', s); b.addEventListener('touchstart', s, {passive:false});
            function s(e) { if(e.target.closest('.float-menu'))return; isDragging=false; const c=e.type.includes('mouse')?e:e.touches[0]; startX=c.clientX; startY=c.clientY;
            const r=w.getBoundingClientRect(); initialLeft=r.left; initialTop=r.top; w.style.left=initialLeft+'px'; w.style.top=initialTop+'px'; w.style.bottom='auto'; w.style.right='auto'; if(e.type.includes('mouse')) { document.addEventListener('mousemove', mv); document.addEventListener('mouseup', ed); } else { document.addEventListener('touchmove', mv, {passive:false});
            document.addEventListener('touchend', ed); } }
            function mv(e) { const c=e.type.includes('mouse')?e:e.touches[0];
            const dx=c.clientX-startX, dy=c.clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5){ isDragging=true; if(m.classList.contains('active'))m.classList.remove('active'); } if(isDragging){ e.preventDefault(); w.style.left=(initialLeft+dx)+'px'; w.style.top=(initialTop+dy)+'px';
            } }
            function ed() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',ed); document.removeEventListener('touchmove',mv); document.removeEventListener('touchend',ed);
            }
            b.addEventListener('click', (e)=>{ if(isDragging){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');} });
            document.addEventListener('click', (e)=>{ if(m.classList.contains('active')&&!w.contains(e.target)){m.classList.remove('active');} });
        }

        // ================= ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤é€»è¾‘ (Reader System - ç¼–è¾‘ & ä¹¦ç­¾å¢å¼ºç‰ˆ) =================

        let readerState = {
            data: [],
            bookmarks: {}, // æ ¼å¼: { floorIndex: "å¤‡æ³¨å†…å®¹" }
            currentPage: 1,
            pageSize: 10,
            totalMessages: 0,
            totalPages: 0,
            resourceIndex: -1 // è®°å½•å½“å‰æ­£åœ¨è¯»å“ªä¸ªæ–‡ä»¶ï¼Œæ–¹ä¾¿ä¿å­˜
        };

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('bookmarkDrawer').classList.remove('active');
        }

        async function openReader(resIndex) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            const res = item.resources[resIndex];
            
            readerState.resourceIndex = resIndex;

            let jsonContent;
            try {
                // 1. è§£æå†…å®¹
                if (res.content.startsWith('data:')) {
                    const base64 = res.content.split(',')[1];
                    const decoded = atob(base64);
                    // è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
                    const bytes = new Uint8Array(decoded.length);
                    for (let i = 0; i < decoded.length; i++) bytes[i] = decoded.charCodeAt(i);
                    jsonContent = new TextDecoder('utf-8').decode(bytes);
                } else {
                    jsonContent = res.content;
                }

                let chatData = [];
                try {
                    chatData = JSON.parse(jsonContent);
                } catch (e) {
                    // å°è¯• JSONL
                    const lines = jsonContent.split('\n').filter(line => line.trim() !== '');
                    chatData = lines.map(line => JSON.parse(line));
                }

               // æ ‡å‡†åŒ–æ¶ˆæ¯ (ä¿æŒä¸å˜)
                let messages = [];
                if (Array.isArray(chatData)) {
                    messages = chatData;
                } else if (chatData.messages && Array.isArray(chatData.messages)) {
                    messages = chatData.messages;
                }

                if (messages.length === 0) {
                    auth.toast('æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½• ğŸ“œ');
                    return;
                }

                // åŠ è½½ä¹¦ç­¾ (ä¿æŒä¸å˜)
                if (!res.bookmarks) {
                    res.bookmarks = {};
                }
                readerState.bookmarks = res.bookmarks;

                // åˆå§‹åŒ–åˆ†é¡µ
                readerState.data = messages;
                readerState.totalMessages = messages.length;
                readerState.pageSize = 10;
                readerState.totalPages = Math.ceil(messages.length / readerState.pageSize);
                readerState.currentPage = 1;

                document.getElementById('readerTitle').textContent = res.name.replace(/\.jsonl?$/i, '');
                
                renderCurrentPage();
                
                // ğŸŸ¢ æ”¹åŠ¨ï¼šæ‰“å¼€é˜…è¯»å™¨æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0; 
                
                document.getElementById('readerModal').classList.add('active');

            } catch (e) {
                console.error(e);
                auth.toast('æ‰“ä¸å¼€...æ ¼å¼å¥½åƒä¸å¯¹ ğŸ˜µ');
            }
        }

              function renderCurrentPage() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = ''; 

            const startIdx = (readerState.currentPage - 1) * readerState.pageSize;
            const endIdx = Math.min(startIdx + readerState.pageSize, readerState.totalMessages);
            const currentMessages = readerState.data.slice(startIdx, endIdx);

            document.getElementById('readerCount').textContent = `æ€»è®¡ ${readerState.totalMessages} æ¥¼`;
            document.getElementById('pageInfo').textContent = `${readerState.currentPage} / ${readerState.totalPages}`;

            currentMessages.forEach((msg, i) => {
                // ... (ä¸­é—´çš„ forEach å¾ªç¯ç”Ÿæˆæ°”æ³¡çš„ä»£ç å®Œå…¨ä¿æŒä¸å˜) ...
                // ... ç›´æ¥å¤åˆ¶åŸæ¥çš„å³å¯ ...
                const globalIndex = startIdx + i;
                const text = msg.mes || msg.content || msg.text || msg.message || '...';
                const name = msg.name || '???';
                
                let isRight = false;
                if (msg.hasOwnProperty('is_user')) isRight = msg.is_user;
                else if (msg.hasOwnProperty('is_main')) isRight = msg.is_main;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isRight = true;

                const sideClass = isRight ? 'right' : 'left';
                const row = document.createElement('div');
                row.className = `chat-row ${sideClass}`;
                row.id = `floor-${globalIndex}`; 

                const floor = document.createElement('span');
                floor.className = 'floor-tag';
                
                const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
                const starClass = isBookmarked ? 'active' : '';
                
                floor.innerHTML = `
                    #${globalIndex + 1} 
                    <span class="bookmark-icon ${starClass}" 
                          onclick="handleBookmarkClick(${globalIndex}, this)" 
                          title="${isBookmarked ? 'ç‚¹å‡»ä¿®æ”¹/åˆ é™¤å¤‡æ³¨' : 'ç‚¹å‡»æ·»åŠ ä¹¦ç­¾'}">
                          â˜…
                    </span>`;

                const bubbleWrapper = document.createElement('div');
                const nameTag = document.createElement('div');
                nameTag.className = 'chat-name';
                nameTag.textContent = name;

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                bubble.title = "åŒå‡»ç¼–è¾‘å†…å®¹";
                bubble.ondblclick = (e) => {
                    e.stopPropagation();
                    enableEditMode(bubble, globalIndex, text);
                };

                bubbleWrapper.appendChild(nameTag);
                bubbleWrapper.appendChild(bubble);
                
                row.appendChild(floor);
                row.appendChild(bubbleWrapper);
                container.appendChild(row);
            });

            // ğŸŸ¢ æ”¹åŠ¨ï¼šåˆ é™¤äº† container.scrollTop = 0; è¿™ä¸€è¡Œ
            // è¿™æ ·åˆ·æ–°é¡µé¢æ—¶ï¼Œæ»šåŠ¨æ¡ä¼šåœç•™åœ¨åŸåœ°
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šåŒå‡»ç¼–è¾‘é€»è¾‘ ---
        function enableEditMode(bubbleEl, globalIndex, oldText) {
            // é¿å…é‡å¤è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (bubbleEl.querySelector('.bubble-textarea')) return;

            // åˆ›å»ºç¼–è¾‘ç•Œé¢
            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-edit-wrapper';

            const textarea = document.createElement('textarea');
            textarea.className = 'bubble-textarea';
            textarea.value = oldText; // ç›´æ¥æ”¾å…¥åŸæ–‡æœ¬ï¼Œä¸å« <br>
            
            const btnRow = document.createElement('div');
            btnRow.className = 'edit-btn-row';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'edit-confirm-btn';
            confirmBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            confirmBtn.onclick = () => saveBubbleEdit(globalIndex, textarea.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'edit-cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = () => renderCurrentPage(); // é‡æ–°æ¸²æŸ“æ¢å¤åŸçŠ¶

            btnRow.appendChild(cancelBtn);
            btnRow.appendChild(confirmBtn);
            wrapper.appendChild(textarea);
            wrapper.appendChild(btnRow);

            // æ¸…ç©ºæ°”æ³¡å¹¶æ”¾å…¥ç¼–è¾‘æ¡†
            bubbleEl.innerHTML = '';
            bubbleEl.appendChild(wrapper);
            textarea.focus();
        }

              async function saveBubbleEdit(globalIndex, newText) {
            // ğŸŸ¢ æ”¹åŠ¨ï¼šä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®
            const container = document.getElementById('chatContainer');
            const currentScroll = container.scrollTop;

            // 1. æ›´æ–°å†…å­˜æ•°æ®
            const msg = readerState.data[globalIndex];
            if(msg.mes !== undefined) msg.mes = newText;
            if(msg.content !== undefined) msg.content = newText;
            if(msg.text !== undefined) msg.text = newText;
            if(msg.message !== undefined) msg.message = newText;

            // 2. æŒä¹…åŒ–ä¿å­˜åˆ°æ•°æ®åº“
            await saveReaderDataToDB();

            // 3. é‡æ–°æ¸²æŸ“
            renderCurrentPage();

            // ğŸŸ¢ æ”¹åŠ¨ï¼šæ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿è§†å›¾ä¸ä¹±è·³
            container.scrollTop = currentScroll;

            auth.toast('ä¿®æ”¹å·²ä¿å­˜ âœ¨');
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šä¹¦ç­¾ç³»ç»Ÿ ---
        async function handleBookmarkClick(globalIndex, iconEl) {
            const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
            
            if (isBookmarked) {
                // å·²æœ‰ä¹¦ç­¾ï¼šè¯¢é—®æ˜¯ä¿®æ”¹è¿˜æ˜¯åˆ é™¤
                const oldNote = readerState.bookmarks[globalIndex];
                const newNote = prompt("âœï¸ ä¿®æ”¹å¤‡æ³¨ (æ¸…ç©ºå†…å®¹åˆ™åˆ é™¤ä¹¦ç­¾):", oldNote);
                
                if (newNote === null) return; // å–æ¶ˆ
                
                if (newNote.trim() === "") {
                    delete readerState.bookmarks[globalIndex];
                    auth.toast('ä¹¦ç­¾å·²åˆ é™¤ ğŸ—‘ï¸');
                } else {
                    readerState.bookmarks[globalIndex] = newNote;
                    auth.toast('å¤‡æ³¨å·²æ›´æ–° ğŸ“');
                }
            } else {
                // æ–°ä¹¦ç­¾
                const note = prompt("âœ¨ è¯·è¾“å…¥ä¹¦ç­¾å¤‡æ³¨:", "è¿™é‡Œå¾ˆæœ‰è¶£...");
                if (note === null) return;
                
                readerState.bookmarks[globalIndex] = note || "æ— å¤‡æ³¨";
                auth.toast('ä¹¦ç­¾æ·»åŠ æˆåŠŸ â­');
            }

            // ä¿å­˜å¹¶åˆ·æ–°UI
            await saveReaderDataToDB();
            renderCurrentPage();
            // å¦‚æœä¹¦ç­¾åˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
            if(document.getElementById('bookmarkDrawer').classList.contains('active')){
                renderBookmarkList();
            }
        }

        function toggleBookmarkDrawer() {
            const drawer = document.getElementById('bookmarkDrawer');
            drawer.classList.toggle('active');
            if (drawer.classList.contains('active')) {
                renderBookmarkList();
            }
        }

        function renderBookmarkList() {
            const listEl = document.getElementById('bookmarkList');
            listEl.innerHTML = '';

            const indices = Object.keys(readerState.bookmarks).map(Number).sort((a,b) => a-b);

            if (indices.length === 0) {
                listEl.innerHTML = '<div class="bm-empty">è¿˜æ²¡æœ‰åŠ è¿‡ä¹¦ç­¾å“¦~<br>ç‚¹å‡»æ¥¼å±‚å·æ—è¾¹çš„ â˜… è¯•è¯•</div>';
                return;
            }

            indices.forEach(idx => {
                const note = readerState.bookmarks[idx];
                const item = document.createElement('div');
                item.className = 'bookmark-item';
                item.onclick = () => jumpToFloor(idx);
                
                item.innerHTML = `
                    <div class="bm-floor">#${idx + 1} æ¥¼</div>
                    <div class="bm-note">${note}</div>
                `;
                listEl.appendChild(item);
            });
        }

        function jumpToFloor(globalIndex) {
            // 1. è®¡ç®—ç›®æ ‡é¡µç 
            const targetPage = Math.floor(globalIndex / readerState.pageSize) + 1;
            
            // 2. è·³è½¬é¡µé¢
            readerState.currentPage = targetPage;
            renderCurrentPage();

            // 3. å…³é—­æŠ½å±‰
            document.getElementById('bookmarkDrawer').classList.remove('active');

            // 4. æ»šåŠ¨åˆ°æŒ‡å®šæ¥¼å±‚å¹¶é«˜äº®
            setTimeout(() => {
                const row = document.getElementById(`floor-${globalIndex}`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 2000);
                }
            }, 100); // ç¨å¾®å»¶è¿Ÿç­‰å¾…æ¸²æŸ“
        }

        // --- ğŸ’¾ æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
        async function saveReaderDataToDB() {
            if (viewingIndex === -1 || readerState.resourceIndex === -1) return;

            const item = items[viewingIndex];
            const res = item.resources[readerState.resourceIndex];

            // 1. ä¿å­˜å†…å®¹ (å°†å¯¹è±¡æ•°ç»„è½¬å› JSON å­—ç¬¦ä¸²)
            res.content = JSON.stringify(readerState.data);

            // 2. ä¿å­˜ä¹¦ç­¾
            res.bookmarks = readerState.bookmarks;

            // 3. å†™å…¥æ•°æ®åº“
            await saveItemToDB(item);
        }

               function prevPage() {
            if (readerState.currentPage > 1) {
                readerState.currentPage--;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯ç¬¬ä¸€é¡µå•¦');
            }
        }

        function nextPage() {
            if (readerState.currentPage < readerState.totalPages) {
                readerState.currentPage++;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯æœ€åä¸€é¡µå•¦');
            }
        }

        // ================= ğŸ¨ CSS ä¸»é¢˜ç³»ç»Ÿ =================
        
        let savedThemes = JSON.parse(localStorage.getItem('my_reader_themes') || '[]');

        // 1. æ‰“å¼€/å…³é—­é¢æ¿
        function toggleCssDrawer() {
            const drawer = document.getElementById('cssDrawer');
            drawer.classList.toggle('active');
            if(drawer.classList.contains('active')) {
                renderThemeSelect();
            }
        }

        // 2. é¢„è§ˆ/åº”ç”¨ CSS
        function previewCss() {
            const css = document.getElementById('cssInput').value;
            // æŠŠ CSS æ³¨å…¥åˆ°ç¬¬ä¸€æ­¥åŠ çš„ style æ ‡ç­¾é‡Œ
            document.getElementById('custom-reader-style').textContent = css;
            auth.toast('çš®è‚¤å·²åº”ç”¨ âœ¨');
        }

        // 3. ä¿å­˜ä¸»é¢˜
        function saveCustomTheme() {
            const name = document.getElementById('themeNameInput').value.trim();
            const css = document.getElementById('cssInput').value;
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!css) { auth.toast('è¿˜æ²¡å†™ä»£ç å‘¢ï¼'); return; }

            // æ£€æŸ¥é‡åï¼Œå¦‚æœæœ‰é‡åå°±è¦†ç›–
            const existingIdx = savedThemes.findIndex(t => t.name === name);
            if(existingIdx >= 0) {
                if(!confirm(`ä¸»é¢˜ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
                savedThemes[existingIdx].css = css;
            } else {
                savedThemes.push({ name: name, css: css });
            }

            localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
            renderThemeSelect();
            // è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„
            document.getElementById('themeSelect').value = name;
            auth.toast('ä¸»é¢˜ä¿å­˜æˆåŠŸ ğŸ’¾');
        }

        // 4. åŠ è½½é€‰ä¸­çš„ä¸»é¢˜
        function loadSelectedTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) return;
            
            const theme = savedThemes.find(t => t.name === name);
            if(theme) {
                document.getElementById('cssInput').value = theme.css;
                document.getElementById('themeNameInput').value = theme.name;
                previewCss(); // è‡ªåŠ¨åº”ç”¨
            }
        }

        // 5. åˆ é™¤ä¸»é¢˜
        function deleteCustomTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) { auth.toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸»é¢˜'); return; }
            
            if(confirm(`ç¡®å®šåˆ é™¤ä¸»é¢˜ "${name}" å—ï¼Ÿ`)) {
                savedThemes = savedThemes.filter(t => t.name !== name);
                localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
                
                document.getElementById('cssInput').value = '';
                document.getElementById('themeNameInput').value = '';
                document.getElementById('custom-reader-style').textContent = ''; // æ¸…ç©ºæ•ˆæœ
                
                renderThemeSelect();
                auth.toast('å·²åˆ é™¤ ğŸ—‘ï¸');
            }
        }

        // 6. æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
        function renderThemeSelect() {
            const sel = document.getElementById('themeSelect');
            // ä¿ç•™ç¬¬ä¸€é¡¹æç¤º
            sel.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>';
            savedThemes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }
        
        // ğŸŸ¢ åˆå§‹åŒ–ï¼šå¦‚æœä¹‹å‰æœ‰æœ€åä¸€æ¬¡ä½¿ç”¨çš„ä¸»é¢˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨åŠ è½½ï¼ˆå¯é€‰ï¼‰
        // window.addEventListener('load', () => { ... })

        // ================= ğŸ’­ é£˜å­—åŠ¨ç”»é€»è¾‘ =================
        let memoryInterval = null;

        function startMemoryAnimation(list) {
            const container = document.getElementById('memoryLayer');
            container.innerHTML = ''; // å…ˆæ¸…ç©º
            
            // å¦‚æœæ²¡æœ‰è¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©ºï¼Œå°±ä¸æ”¾äº†
            if (!list || list.length === 0) return;

            // ç«‹å³ç”Ÿæˆå‡ ä¸ªï¼Œé¿å…æ‰“å¼€æ—¶ç©ºè¡è¡
            for(let i=0; i<3; i++) spawnMemory(list, container);

            // æ¯éš” 1.5ç§’ ç”Ÿæˆä¸€ä¸ªæ–°çš„
            memoryInterval = setInterval(() => {
                spawnMemory(list, container);
            }, 1500);
        }

        function stopMemoryAnimation() {
            if (memoryInterval) {
                clearInterval(memoryInterval);
                memoryInterval = null;
            }
            document.getElementById('memoryLayer').innerHTML = '';
        }

        function spawnMemory(list, container) {
            const text = list[Math.floor(Math.random() * list.length)]; // éšæœºæŒ‘ä¸€å¥
            const el = document.createElement('div');
            el.className = 'memory-text';
            el.textContent = text;
            
            // éšæœºä½ç½®å’Œå¤§å°ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
            const randomLeft = Math.random() * 80 + 10; // 10% åˆ° 90% ä¹‹é—´
            const randomDuration = Math.random() * 5 + 8; // 8åˆ°13ç§’é£˜å®Œ
            const randomSize = Math.random() * 8 + 16; // 16px åˆ° 24px å¤§å°
            
            el.style.left = randomLeft + '%';
            el.style.animationDuration = randomDuration + 's';
            el.style.fontSize = randomSize + 'px';
            
            container.appendChild(el);

            // åŠ¨ç”»ç»“æŸååˆ é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
            }, randomDuration * 1000);
        }

 // ================= ğŸº é…’é¦†ä¼ é€é—¨é€»è¾‘ (æé€Ÿç‰ˆ) =================
        
        // ğŸš€ å¯åŠ¨é€»è¾‘ (æ— å»¶è¿Ÿï¼Œæµè§ˆå™¨ä¸ä¼šæ‹¦æˆª)
        function jumpToTavern() {
            let url = localStorage.getItem('my_tavern_simple_url');
            
            // ç¬¬ä¸€æ¬¡ç”¨ï¼Œè¿˜æ²¡å­˜è¿‡é“¾æ¥
            if (!url) {
                // å¦‚æœæ²¡é“¾æ¥ï¼Œç›´æ¥è°ƒç”¨ä¿®æ”¹å‡½æ•°
                changeTavernLink(true); 
            } else {
                // æœ‰é“¾æ¥ï¼Œç›´æ¥é£
                window.open(url, '_blank');
            }
        }

        // âœï¸ ä¿®æ”¹é€»è¾‘
        function changeTavernLink(isFirstTime = false) {
            const oldUrl = localStorage.getItem('my_tavern_simple_url') || 'http://127.0.0.1:8000';
            const msg = isFirstTime ? "ğŸº ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œè¯·è¾“å…¥é…’é¦†é“¾æ¥ï¼š" : "ğŸ”§ ä¿®æ”¹é…’é¦†åæ ‡ï¼š";
            
            let newUrl = prompt(msg + "\n(ä¾‹å¦‚ http://127.0.0.1:8000 )", oldUrl);
            
            if (newUrl) {
                // è´´å¿ƒåœ°å¸®ç”¨æˆ·åŠ ä¸Š http (é˜²æ­¢ç”¨æˆ·åªå†™ IP)
                if (!newUrl.startsWith('http')) {
                    newUrl = 'http://' + newUrl;
                }
                // å»æ‰æœ«å°¾çš„æ–œæ  / (é˜²æ­¢æ‹¼æ¥å‡ºé”™)
                if (newUrl.endsWith('/')) {
                    newUrl = newUrl.slice(0, -1);
                }
                
                localStorage.setItem('my_tavern_simple_url', newUrl);
                auth.toast('é…’é¦†åæ ‡å·²é”å®š ğŸ“');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®ï¼Œè®¾ç½®å®Œç›´æ¥è·³
                if(isFirstTime) {
                    window.open(newUrl, '_blank');
                }
            }
        }

        // ================= ğŸ’® å°ç« ç³»ç»Ÿé€»è¾‘ =================

        // åˆ‡æ¢å°ç« ï¼ˆç‚¹å‡»å°å›¾æ ‡æ—¶è§¦å‘ï¼‰
        async function toggleStamp(char) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // å¦‚æœå½“å‰å·²ç»æ˜¯è¿™ä¸ªå°ç« ï¼Œå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆ
            if (item.stamp === char) {
                item.stamp = null; // å–æ¶ˆ
                auth.toast('å°ç« å·²æ’¤é”€ ğŸ’¨');
            } else {
                item.stamp = char; // ç›–ç« 
                auth.toast('ç›–ç« æˆåŠŸï¼å•ªï¼ğŸ’®');
            }

            // ä¿å­˜æ•°æ®
            await saveItemToDB(item);
            
            // åˆ·æ–°ç•Œé¢
            renderStampStatus(item.stamp);
            loadFromDB(); // åˆ·æ–°åˆ—è¡¨æ•°æ®
        }

        // æ¸²æŸ“å°ç« ï¼ˆæ§åˆ¶å¤§å°ç« å’Œå°å›¾æ ‡çš„æ˜¾ç¤ºï¼‰
        function renderStampStatus(currentStamp) {
            const bigStamp = document.getElementById('bigStamp');
            const btns = document.querySelectorAll('.stamp-btn');

            // 1. é‡ç½®æ‰€æœ‰å°å›¾æ ‡
            btns.forEach(btn => {
                btn.classList.remove('active');
                // å¦‚æœæ˜¯å½“å‰å°ç« ï¼Œç‚¹äº®å®ƒ
                if (btn.innerText === currentStamp) {
                    btn.classList.add('active');
                }
            });

            // 2. å¤„ç†å¤§å°ç« åŠ¨ç”»
            if (currentStamp) {
                bigStamp.innerText = currentStamp;
                // å…ˆç§»é™¤ï¼Œå¼ºåˆ¶é‡ç»˜ï¼Œå†æ·»åŠ ï¼Œä¸ºäº†æ¯æ¬¡éƒ½æœ‰â€œå•ªâ€çš„åŠ¨ç”»æ•ˆæœ
                bigStamp.classList.remove('stamped');
                void bigStamp.offsetWidth; // å¼ºåˆ¶é‡ç»˜é­”æ³•
                bigStamp.classList.add('stamped');
            } else {
                bigStamp.classList.remove('stamped');
            }
        }

        // ================= ğŸ™ˆ é˜²çª¥æ¨¡å¼é€»è¾‘ =================
        
        function togglePrivacyMode() {
            const body = document.body;
            const btn = document.getElementById('privacyBtn');
            
            // åˆ‡æ¢ class
            body.classList.toggle('privacy-active');
            
            // åˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œæ”¹å˜å›¾æ ‡å’Œæç¤º
            if (body.classList.contains('privacy-active')) {
                btn.textContent = 'ğŸ™ˆ'; // å˜æˆæ‚çœ¼ç›çš„çŒ´å­
                btn.style.backgroundColor = '#ffe6eb'; // æŒ‰é’®å˜ç²‰æç¤ºç”Ÿæ•ˆä¸­
                auth.toast('é˜²çª¥æ¨¡å¼å·²å¼€å¯ ğŸ”’');
            } else {
                btn.textContent = 'ğŸ‘ï¸'; // å˜æˆçå¼€çš„çœ¼ç›
                btn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // æ¢å¤åŸæ ·
                auth.toast('å·²æ¢å¤æ¸…æ™° âœ¨');
            }
        }

        // ================= âœ¨ æŒ‡å°–é­”æ³•é€»è¾‘ =================
        window.addEventListener('click', function(e) {
            // éšæœºç‰¹æ•ˆæ± 
            const particles = ['ğŸŒ¸', 'âœ¨', 'ğŸ’—', 'â­', 'ğŸ¾', 'ğŸµ'];
            const p = document.createElement('div');
            p.className = 'magic-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            
            // è®¾ç½®ä½ç½®
            p.style.left = e.clientX + 'px';
            p.style.top = e.clientY + 'px';
            
            // ç¨å¾®éšæœºä¸€ç‚¹è§’åº¦å’Œå¤§å°
            const randomRot = Math.random() * 40 - 20; // -20åº¦åˆ°20åº¦
            p.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg)`;
            
            document.body.appendChild(p);
            
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => p.remove(), 1000);
        });

// ================= ğŸ† ä¿®å¤ç‰ˆï¼šæµè§ˆå™¨æ ‡é¢˜ç­‰çº§ç³»ç»Ÿ (Lv.1 - Lv.Max) =================

function updateTitleLevel() {
    // ç¡®ä¿ items æ•°ç»„å·²è¢«åŠ è½½ (è¿™æ˜¯ä½ çš„æ•°æ®æ¥æº)
    if (typeof items === 'undefined' || !Array.isArray(items)) {
        // å¦‚æœæ•°æ®è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå°±ä¿æŒåŸæ ‡é¢˜æˆ–æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
        document.title = "âœ¨ æ­£åœ¨åŠ è½½ç™¾å®ç®±... â³"; 
        return;
    }
    
    const total = items.length; // è·å–å½“å‰å¡ç‰‡æ€»æ•°

    // ğŸŒŸ 33çº§ é­”æ³•æ”¶è—å®¶ç­‰çº§è¡¨
    const levels = [
        { count: 0,   title: "ç©ºç©ºå¦‚ä¹Ÿ", icon: "ğŸƒ" },
        { count: 1,   title: "åˆæ¬¡ç›¸é‡", icon: "ğŸŒ±" },
        { count: 5,   title: "å°å°æ”¶è—", icon: "ğŸ€" },
        { count: 10,  title: "æ‹¾å…‰è·¯äºº", icon: "ğŸš¶" },
        { count: 15,  title: "è®°å¿†ç¢ç‰‡", icon: "ğŸ§©" },
        { count: 20,  title: "è§ä¹ æ³•å¸ˆ", icon: "ğŸª„" },
        { count: 25,  title: "ç™¾å®å­¦å¾’", icon: "ğŸ’" },
        { count: 30,  title: "åˆçº§ä»“é¼ ", icon: "ğŸ¹" },
        { count: 40,  title: "å›¤ç§¯æ–°ç§€", icon: "ğŸ§º" },
        { count: 50,  title: "è¿›é˜¶æ”¶è—", icon: "ğŸ“‚" },
        { count: 60,  title: "è®°å¿†çŒæ‰‹", icon: "ğŸ¹" },
        { count: 70,  title: "é—ªå…‰æ—¶åˆ»", icon: "âœ¨" },
        { count: 80,  title: "æ˜Ÿä¹‹å¾®å…‰", icon: "ğŸŒŸ" },
        { count: 90,  title: "æœˆä¹‹è¾‰æ˜ ", icon: "ğŸŒ™" },
        { count: 100, title: "ç™¾å®å¤§å¸ˆ", icon: "ğŸ“" },
        { count: 120, title: "æ—¶å…‰æ—…è¡Œè€…", icon: "â³" },
        { count: 140, title: "æ¢¦å¢ƒç¼–ç»‡è€…", icon: "ğŸ§¶" },
        { count: 160, title: "é“¶æ²³æ¼«æ¸¸", icon: "ğŸš€" },
        { count: 180, title: "æ˜Ÿäº‘è§‚æµ‹", icon: "ğŸ”­" },
        { count: 200, title: "èµ„æ·±å›¤å›¤é¼ ", icon: "ğŸ¿ï¸" },
        { count: 250, title: "å®è—å®ˆæŠ¤è€…", icon: "ğŸ›¡ï¸" },
        { count: 300, title: "æ—¶ç©ºé¢†ä¸»", icon: "ğŸ—ï¸" },
        { count: 350, title: "ç»´åº¦è§‚å¯Ÿè€…", icon: "ğŸ§¿" },
        { count: 400, title: "ä¼ è¯´æ”¶è—å®¶", icon: "ğŸ‘‘" },
        { count: 450, title: "åŠç¥ä¹‹å¢ƒ", icon: "ğŸ”±" },
        { count: 500, title: "æ£®ç½—ä¸‡è±¡", icon: "ğŸŒŒ" },
        { count: 600, title: "å…¨çŸ¥å…¨èƒ½", icon: "ğŸ‘ï¸" },
        { count: 700, title: "ä¸å¯åçŠ¶", icon: "ğŸ™" },
        { count: 800, title: "å®‡å®™å°½å¤´", icon: "ğŸª" },
        { count: 900, title: "è™šç©ºä¹‹ä¸»", icon: "ğŸŒ‘" },
        { count: 1000, title: "åˆ›ä¸–ç¥", icon: "âš›ï¸" },
        { count: 2000, title: "èµ›åšä½›ç¥–", icon: "ğŸª·" },
        { count: 9999, title: "æ•°æ®å¥‡ç‚¹", icon: "ğŸ•³ï¸" }
    ];

    let currentLevel = levels[0];
    for (let i = levels.length - 1; i >= 0; i--) {
        if (total >= levels[i].count) {
            currentLevel = levels[i];
            break;
        }
    }

    // âœ¨ åŠ¨æ€ä¿®æ”¹æµè§ˆå™¨æ ‡é¢˜
    document.title = `[${currentLevel.icon} ${currentLevel.title}] æˆ‘çš„ç™¾å®ç®± (${total})`;
}

    </script>
</body>
</html>
