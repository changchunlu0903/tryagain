<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âœ¨ æ¢¨æ¢¨çš„ç™¾å®ç®± (æœ€ç»ˆå®Œç¾ç‰ˆ v15.0) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
            --lock-bg: #fff0f5;

            /* ğŸ‘‡ ğŸŸ¢ é˜…è¯»å™¨è®¾ç½® ğŸŸ¢ ğŸ‘‡ */
            --reader-bubble-width: 90%; /* æ°”æ³¡å®½åº¦ */
            --reader-line-height: 1.5; /* è¡Œé—´è· */
            --reader-letter-spacing: 0.8px; /* å­—é—´è· */
            --reader-row-spacing: 2px; /* æ®µé—´è· */
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        /* ==================== ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ & é”å±æ ·å¼ ==================== */
        
        #lockScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff5f7; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(#fff 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* é£˜è½æ¨±èŠ± */
        .sakura {
            position: absolute;
            background: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0.5;
            animation: fall linear infinite; pointer-events: none;
        }
        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(100px, 110vh) rotate(360deg); opacity: 0; }
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .lock-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 30px;
            width: 85%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 10;
            transition: transform 0.3s;
        }

        .lock-title { font-size: 24px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; }
        .lock-subtitle { color: #999; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .welcome-btn {
            display: block;
            width: 100%; padding: 18px; border-radius: 50px;
            margin-bottom: 15px; border: none; font-size: 16px; color: white;
            font-family: inherit; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .welcome-btn:active { transform: scale(0.98); }
        .btn-gesture { background: #ffb7c5; }
        .btn-pin { background: linear-gradient(90deg, #a8edea 0%, #ffb7c5 100%); }
        .btn-login-pink { background: #ff9eb5; box-shadow: 0 8px 20px rgba(255, 158, 181, 0.4); }

        .pin-display { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .pin-dot {
            width: 16px;
            height: 16px; border-radius: 50%;
            background: #eee; border: 2px solid #ddd; transition: all 0.2s;
        }
        .pin-dot.active { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 280px; margin: 0 auto; }
        .num-btn {
            width: 60px;
            height: 60px; border-radius: 50%; border: none;
            background: #fff; color: var(--text-color); font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            font-family: inherit; display: flex; align-items: center; justify-content: center;
        }
        .num-btn:active { background: var(--secondary-color); }

        .gesture-container { position: relative; width: 300px; height: 300px; margin: 0 auto; touch-action: none; }
        .gesture-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; }
        .gesture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;
        }
        .gesture-point { display: flex; align-items: center; justify-content: center; }
        .point-inner {
            width: 18px;
            height: 18px; background: #ddd; border-radius: 50%;
            transition: 0.3s;
        }
        .point-inner.active { background: var(--accent-color); box-shadow: 0 0 0 10px rgba(255, 143, 163, 0.2); }

        .lock-input {
            width: 100%;
            padding: 12px; margin: 10px 0; border: 2px solid #ffe6eb;
            border-radius: 12px; text-align: center; font-family: inherit;
            outline: none; color: var(--text-color);
        }
        .lock-input:focus { border-color: var(--accent-color); }

        .back-link { margin-top: 20px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline; }

        .toast {
            position: fixed;
            top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 14px; opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s; z-index: 20000;
        }

        /* ==================== ğŸ”® æŠ½ç­¾ç³»ç»Ÿæ ·å¼ ==================== */
        .lottery-panel { margin-bottom: 15px; text-align: center; }
        .lottery-btn {
            background: linear-gradient(135deg, #fff0f5 0%, #ffc0cb 100%);
            border: 2px solid #fff; color: #d66a80;
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; width: 100%;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3);
            font-weight: bold; transition: transform 0.2s;
        }
        .lottery-btn:active { transform: scale(0.95); }

        .lottery-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 230, 235, 0.9); backdrop-filter: blur(8px);
            z-index: 12000; display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
        }
        .lottery-overlay.active { display: flex; animation: fadeInLottery 0.3s ease; }
        @keyframes fadeInLottery { from {opacity:0;} to {opacity:1;} }

        .lottery-box-container { text-align: center; position: relative; }
        .magic-gift { font-size: 100px; display: block; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        .magic-gift.shaking { animation: shakeBox 0.5s infinite; }
        @keyframes shakeBox {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        .lottery-result-card {
            display: none;
            flex-direction: column; align-items: center;
            background: white; padding: 20px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(255, 100, 150, 0.3);
            border: 4px solid #fff;
            width: 260px; animation: popIn 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from {transform: scale(0) rotate(-20deg); opacity: 0;} to {transform: scale(1) rotate(0); opacity: 1;} }

        .lottery-img-wrapper {
            width: 220px;
            height: 220px; border-radius: 20px; overflow: hidden;
            margin-bottom: 15px; border: 2px solid #ffe6eb; background: #fff5f7;
            display: flex; align-items: center; justify-content: center;
        }
        .lottery-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .lottery-name { font-size: 20px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px; }
        .lottery-hint { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        
        .go-btn {
            background: var(--accent-color);
            color: white; border: none;
            padding: 10px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 143, 163, 0.4);
            animation: pulse 2s infinite; font-family: inherit;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .close-lottery { position: absolute;
            top: 30px; right: 30px; font-size: 30px; color: #fff; background: rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; }

        /* ==================== åŸæœ‰ CSS ==================== */
        #appContainer {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸ¶ æ‚¬æµ®çª— --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn {
            width: 48px;
            height: 48px; border-radius: 50%;
            background: #fff; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex;
            justify-content: center; align-items: center;
            font-size: 24px; cursor: move; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .float-btn:active { transform: scale(0.9); }
        .float-btn::after { content: 'ğŸ¶'; }
        
        .float-menu {
            position: absolute;
            bottom: 60px; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; width: 260px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff;
            transform-origin: bottom right; transform: scale(0); opacity: 0;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; max-height: 60vh; display: flex; flex-direction: column;
        }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 10px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px;
            height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 10px; }
        .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; font-size: 13px; }
        
        .search-container { max-width: 600px; margin: 0 auto 10px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }

        /* ğŸŸ¢ è§†å›¾åˆ‡æ¢æ  */
        .layout-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; margin: 0 auto 25px auto;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
            padding: 6px 12px 6px 15px; border-radius: 50px; width: fit-content;
            border: 2px solid #fff0f5; box-shadow: 0 5px 15px rgba(255, 183, 197, 0.25);
        }
        .layout-label { font-size: 13px; color: var(--accent-color); font-weight: bold; margin-right: 8px; display: flex; align-items: center; }
        .layout-btn {
            background: none; border: none; width: 36px; height: 36px;
            cursor: pointer; border-radius: 50%; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex; align-items: center; justify-content: center; opacity: 0.6; font-size: 18px;
        }
        .layout-btn.active { background: #fff; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3); opacity: 1; transform: scale(1.1); }

               /* ğŸŸ¢ æ“ä½œæŒ‰é’®ç½‘æ ¼ (ä¿®æ”¹ç‰ˆï¼š6ä¸ªä¸€è¡Œ) */
    /* å¼ºåˆ¶è®¾ç½®ä¸º 5 åˆ—ï¼Œè®© 5 ä¸ªæŒ‰é’®æ­£å¥½æ’æ»¡ä¸€è¡Œ */
    .action-grid { 
        display: grid; 
        grid-template-columns: repeat(5, 1fr) !important; 
        gap: 6px; /* é—´è·ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œé˜²æ­¢æ¢è¡Œ */
        max-width: 100%; 
        margin: 0 auto 20px auto; 
        padding: 0 5px; 
        box-sizing: border-box;
    }

    .action-card {
        height: 65px; /* é«˜åº¦ç»Ÿä¸€ */
        font-size: 11px; /* å­—ä½“å°å·§ */
        padding: 5px 0;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        background: #fff; 
        border: 2px solid #ffb7c5; 
        border-radius: 12px;
        color: #ff8fa3; 
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2); 
    }
    
    .action-card:active { transform: scale(0.95); }
    .action-card.primary { border: 2px solid #ff8fa3; color: #ff8fa3; }
    
    /* å›¾æ ‡å¤§å°å¾®è°ƒ */
    .kitty-icon { 
        font-size: 20px; 
        margin-bottom: 3px; 
    }
        /* æ‰¹é‡åˆ é™¤ç›¸å…³æ ·å¼ */
        .card.is-selecting { animation: shake 0.3s ease; }
        .card.selected { border-color: #ff6b6b !important; background-color: #fff0f0; position: relative; }
        .card.selected::after { content: 'âœ…'; position: absolute; top: 5px; right: 5px; font-size: 20px; background: rgba(255,255,255,0.8); border-radius: 50%; }

        /* ğŸ”´ å…³é”®ä¿®å¤ï¼šéšè—åˆ é™¤æ¡ */
        .delete-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px);
            opacity: 0; pointer-events: none;
            background: #fff; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 15px;
            z-index: 10000; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); border: 2px solid #ff6b6b;
        }
        .delete-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .delete-btn-confirm { background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: bold; }
        .delete-btn-cancel { background: #f0f0f0; color: #666; border: none; padding: 8px 20px; border-radius: 30px; }
        .controls { display: none; }

        /* ğŸŸ¢ Grid å¸ƒå±€æ¨¡å¼ */
        .grid-container { display: grid; gap: 20px; max-width: 1200px; margin: 0 auto; transition: all 0.3s ease; }
        .grid-container.mode-default { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        .grid-container.mode-large { grid-template-columns: repeat(auto-fill, minmax(40%, 1fr)); }
        .grid-container.mode-mini { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
        .grid-container.mode-mini .card-img-wrapper { height: 120px; }
        .grid-container.mode-mini .card-title { font-size: 14px; }
        .grid-container.mode-list { grid-template-columns: 1fr; }
        .grid-container.mode-list .card { flex-direction: row; height: 100px; }
        .grid-container.mode-list .card-img-wrapper { width: 100px; height: 100%; flex-shrink: 0; }
        .grid-container.mode-list .card-content { justify-content: center; }
        .grid-container.mode-list .tags-container { margin-top: 5px; }

        .card { background: #fff; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; }
        .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color);
            border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }

        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: flex-start; gap: 10px; background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap;}
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        
        .resource-name-input { width: 100%; border: none; border-bottom: 1px dashed #ccc; padding: 2px 0; font-size: 14px; color: #333; border-radius: 0; background: transparent; outline: none; }
        .resource-name-input:focus { border-bottom-color: var(--accent-color); }
        
        .resource-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; width: auto; flex-grow: 1; max-width: 120px; }
        .custom-type-input { font-size: 12px; padding: 2px 5px; border: 1px solid #ffb7c5; border-radius: 4px; width: 80px; display: none; }

        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-left: auto; align-self: center;}

        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn { font-size: 14px; padding: 5px 12px; }

        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; }
        .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        
        .detail-list { margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        
        .action-link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .action-link:hover { background: var(--primary-color); color: white; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; }
        .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        
        input[type="file"] { display: none; }
        
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        button.primary-btn { background: var(--accent-color); color: white; border: none; }

        /* ==================== ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤ (é˜…è¯»æ¨¡å¼) ==================== */
        
        .reader-modal {
            background: #f5f5f5;
            width: 100%; height: 100%; top: 0; left: 0;
            max-width: none; max-height: none; border-radius: 0;
            display: flex; flex-direction: column; padding: 0;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
            flex-shrink: 0;
        }

        .reader-title { font-weight: bold; color: var(--text-color); font-size: 16px; }
        .reader-subtitle { font-size: 10px; color: #999; margin-top: 2px; }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto; padding: 20px; padding-bottom: 80px;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        .chat-row {
            display: flex;
            margin-bottom: var(--reader-row-spacing); 
            align-items: flex-end;
            position: relative;
            animation: fadeInUp 0.3s ease;
        }

        .floor-tag {
            position: absolute;
            top: -18px; font-size: 10px; color: #ccc;
            font-family: monospace; background: rgba(255,255,255,0.5);
            padding: 0 4px; border-radius: 4px;
        }

        .chat-bubble {
            max-width: var(--reader-bubble-width);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            
            padding: 12px 16px; border-radius: 18px;
            font-size: 15px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }

        .chat-name {
            font-size: 11px;
            color: #999; margin-bottom: 4px; margin-left: 4px;
            text-align: left;
        }

        .chat-row.left { justify-content: flex-start; }
        .chat-row.left .floor-tag { left: 10px; }
        .chat-row.left .chat-bubble { background: #fff; color: #333; border-bottom-left-radius: 4px; }

        .chat-row.right { justify-content: flex-end; }
        .chat-row.right .chat-name { margin-right: 4px; } 
        .chat-row.right .floor-tag { right: 10px; }
        .chat-row.right .chat-bubble { background: var(--accent-color); color: #fff; border-bottom-right-radius: 4px; }

        .close-reader {
            background: #eee;
            border: none; width: 32px; height: 32px; border-radius: 50%;
            font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .reader-footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            flex-shrink: 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .page-btn {
            padding: 8px 15px;
            border-radius: 20px; border: 1px solid #ddd;
            background: #fff; color: #666; font-size: 13px; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .page-btn:active { transform: scale(0.95); background: #f0f0f0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 13px; color: var(--accent-color); font-weight: bold; }

             /* ... ä¸Šé¢çš„ CSS ä¿æŒä¸å˜ ... */

        /* ==================== ğŸŸ¢ æ–°å¢ï¼šé˜…è¯»å™¨ç¼–è¾‘ä¸ä¹¦ç­¾æ ·å¼ ==================== */

        /* 1. ç¼–è¾‘æ¨¡å¼æ ·å¼ (ä¿®æ”¹ç‰ˆï¼šæ›´å¤§ã€æ›´æ¸…æ™°) */
        .bubble-edit-wrapper {
            width: 100%;
        }
        .bubble-textarea {
            width: 100%;
            min-height: 200px; /* ğŸŸ¢ æ”¹åŠ¨ï¼šé»˜è®¤é«˜åº¦åŠ å¤§åˆ° 200px */
            padding: 12px;     /* ğŸŸ¢ æ”¹åŠ¨ï¼šå†…è¾¹è·åŠ å¤§ */
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;   /* ğŸŸ¢ æ”¹åŠ¨ï¼šç¼–è¾‘æ—¶å­—ä½“æ”¾å¤§ï¼Œçœ‹å­—æ›´æ¸…æ¥š */
            line-height: 1.6;
            resize: vertical;  /* å…è®¸ä¸Šä¸‹æ‹‰ä¼¸ */
            outline: none;
            background: #fff;
            color: #333;
            margin-bottom: 8px;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹é˜´å½±è®©å®ƒæµ®èµ·æ¥çš„æ„Ÿè§‰ */
        }
        .edit-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px; /* æŒ‰é’®é—´è·æ‹‰å¤§ */
        }
        .edit-confirm-btn {
            background: var(--accent-color);
            color: white; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .edit-cancel-btn {
            background: #eee;
            color: #666; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
        }

        /* ... ä¸‹é¢çš„ CSS (ä¹¦ç­¾æ ·å¼ç­‰) ä¿æŒä¸å˜ ... */

        /* 2. ä¹¦ç­¾æŒ‰é’® */
        .bookmark-icon { margin-left: 5px; cursor: pointer; font-size: 14px; color: #ddd; transition: color 0.2s; }
        .bookmark-icon.active { color: #ffd700; text-shadow: 0 0 2px rgba(255, 215, 0, 0.5); }
        .floor-tag { display: flex; align-items: center; pointer-events: auto; }

        /* 3. ä¹¦ç­¾åˆ—è¡¨ - å±…ä¸­å¼¹çª—æ ·å¼ (ä¿®å¤ç‰ˆ) */
        .bookmark-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 80%; max-width: 320px; height: 60%; max-height: 500px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(255, 183, 197, 0.5); z-index: 6000;
            display: flex; flex-direction: column; border: 2px solid #fff;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .bookmark-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        /* ğŸŸ¢ æ–°å¢ï¼šCSS ç¼–è¾‘æŠ½å±‰æ ·å¼ (å¤ç”¨ä¹¦ç­¾æŠ½å±‰çš„é€»è¾‘) */
        .css-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 85%; max-width: 400px; height: 70%; max-height: 600px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(100, 100, 255, 0.2); 
            z-index: 6001; /* æ¯”ä¹¦ç­¾å±‚çº§å†é«˜ä¸€ç‚¹ */
            display: flex; flex-direction: column; border: 2px solid #e0f7fa;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .css-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        .bookmark-header {
            padding: 15px 20px; font-weight: bold; color: var(--accent-color);
            border-bottom: 1px solid #ffe6eb; display: flex; justify-content: space-between; align-items: center;
            background: #fff0f5; border-radius: 25px 25px 0 0;
        }
        .bookmark-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .bookmark-item {
            background: #fff; border: 1px solid #ffe6eb; border-radius: 10px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .bookmark-item:hover { background: #fff0f5; transform: translateX(-2px); }
        .bm-floor { font-size: 12px; color: #999; margin-bottom: 4px; font-weight: bold; }
        .bm-note { font-size: 14px; color: #555; word-break: break-all; }
        .bm-empty { text-align: center; color: #ccc; font-size: 13px; margin-top: 50px; }
        
        .highlight-row { animation: flashRow 2s ease; }
        @keyframes flashRow { 0% { background: rgba(255, 215, 0, 0.3); } 100% { background: transparent; } }

        /* ==================== ğŸ’­ å°è±¡æ·±åˆ»çš„è¯ (èƒŒæ™¯å¼¹å¹•ç‰¹æ•ˆ) ==================== */
        .memory-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
            z-index: 0; /* æ”¾åœ¨æœ€åº•å±‚ */
        }

        .memory-text {
            position: absolute;
            font-family: 'MyCustomFont', sans-serif; /* ç”¨ä½ æŒ‡å®šçš„å¯çˆ±å­—ä½“ */
            white-space: nowrap;
            color: rgba(255, 183, 197, 0.6); /* æ·¡æ·¡çš„ç²‰è‰²ï¼ŒåŠé€æ˜ */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: floatUp linear forwards;
        }

        /* æ–‡å­—å‘ä¸Šé£˜åŠ¨çš„åŠ¨ç”» */
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.9) rotate(-5deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-20vh) scale(1.1) rotate(5deg);
                opacity: 0;
            }
        }

        /* ä¸ºäº†é˜²æ­¢èƒŒæ™¯æ–‡å­—é®æŒ¡å†…å®¹ï¼Œæˆ‘ä»¬è¦ç»™å†…å®¹åŠ ä¸ªå±‚çº§ */
        .modal-content-wrapper {
            position: relative;
            z-index: 2; /* ç¡®ä¿å†…å®¹åœ¨æ–‡å­—ä¸Šé¢ */
        }

        /* ==================== ğŸ’® å¿ƒæƒ…å°ç« ç³»ç»Ÿ ==================== */
        
        /* å°ç« é€‰æ‹©æ  */
        .stamp-bar {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px 0;
            padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 50px;
        }
        
        .stamp-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent;
            background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); opacity: 0.7; filter: grayscale(0.8);
        }
        
        .stamp-btn:hover { transform: translateY(-3px); }
        
        /* æ¿€æ´»çŠ¶æ€ï¼šå˜æˆå½©è‰²ï¼Œå‘å…‰ */
        .stamp-btn.active {
            border-color: var(--accent-color); opacity: 1; filter: grayscale(0);
            transform: scale(1.1); box-shadow: 0 5px 15px rgba(255, 143, 163, 0.3);
        }

        /* ç›–åœ¨å³ä¸Šè§’çš„å¤§å°ç«  */
        .big-stamp-mark {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 100px;
            opacity: 0;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸æŒ¡æ“ä½œ */
            transform: scale(3) rotate(-30deg); /* åˆå§‹çŠ¶æ€ï¼šå¾ˆå¤§ï¼Œæ‚¬ç©º */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§åŠ¨ç”» */
            z-index: 0; /* æ”¾åœ¨åº•å±‚ï¼ŒèƒŒæ™¯å­—ä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
            filter: drop-shadow(0 0 0 transparent); /* åˆå§‹æ— é˜´å½± */
        }

        /* ç›–ä¸‹å»çš„çŠ¶æ€ */
        .big-stamp-mark.stamped {
            opacity: 0.15; /* æ·¡æ·¡çš„å°è®° */
            transform: scale(1) rotate(-20deg); /* ç ¸ä¸‹æ¥ */
            filter: drop-shadow(2px 2px 0px rgba(255, 100, 100, 0.2));
        }

        /* ==================== ğŸ™ˆ é˜²çª¥æ¨¡å¼ (Privacy Blur) ==================== */
        
        /* 1. å½“ body åŠ ä¸Š privacy-active ç±»æ—¶ï¼Œæ¨¡ç³Šæ‰€æœ‰å›¾ç‰‡ */
        body.privacy-active .card img,       /* é¦–é¡µå¡ç‰‡å°é¢ */
        body.privacy-active .gallery-img,    /* è¯¦æƒ…é¡µå¤§å›¾ */
        body.privacy-active .resource-preview img { /* ç¼–è¾‘åˆ—è¡¨é‡Œçš„ç¼©ç•¥å›¾ */
            filter: blur(20px) !important;   /* å¼ºåŠ›é«˜æ–¯æ¨¡ç³Š */
            opacity: 0.8;                    /* ç¨å¾®å˜æ·¡ä¸€ç‚¹ */
            transition: all 0.3s ease;       /* ä¸æ»‘è¿‡æ¸¡ */
        }

        /* 2. å³ä¸Šè§’çš„çœ¼ç›æŒ‰é’®æ ·å¼ */
        .privacy-toggle-btn {
            position: absolute;
            top: 20px; 
            right: 20px;
            font-size: 22px;
            cursor: pointer;
            z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2);
            transition: all 0.2s;
            color: var(--accent-color);
        }
        
        .privacy-toggle-btn:active { transform: scale(0.9); }

        /* ==================== âœ¨ æŒ‡å°–é­”æ³• (é¼ æ ‡+ç‚¹å‡»ç‰¹æ•ˆ) ==================== */
        
        /* 1. å…¨å±€é¼ æ ‡å˜å¯çˆ± (æ¢æˆçŒ«çˆªæˆ–é­”æ³•æ£’) */
        body {
            /* è¿™é‡Œç”¨çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„å¯çˆ±å…‰æ ‡é“¾æ¥ï¼Œå¦‚æœå¤±æ•ˆäº†ä¼šé€€åŒ–æˆé»˜è®¤çš„ */
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat120.cur'), auto; 
        }
        
        /* æŒ‰é’®å˜æˆæ‰‹æŒ‡ */
        button, .card, .action-card, .stamp-btn {
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat122.cur'), pointer;
        }

        /* 2. ç‚¹å‡»çˆ†å‡ºçš„ç²’å­ */
        .magic-particle {
            position: fixed;
            pointer-events: none; /* ä¸æŒ¡é¼ æ ‡ */
            animation: particleFloat 1s ease-out forwards;
            font-size: 20px;
            z-index: 9999;
            user-select: none;
        }

        @keyframes particleFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

        /* ==================== ğŸ“Š ç¾ç»Šåˆ†ææŠ¥å‘Šæ ·å¼ ==================== */
        .report-card {
            background: linear-gradient(135deg, #fff 0%, #fff9fb 100%);
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(255, 183, 197, 0.3);
            border: 3px solid #fff; position: relative; overflow: hidden;
        }
        .report-stat-row {
            display: flex; justify-content: space-around; margin: 20px 0;
            background: rgba(255,240,245,0.5); border-radius: 15px; padding: 15px;
        }
        .stat-item h3 { font-size: 24px; color: var(--accent-color); margin: 0; }
        .stat-item p { font-size: 12px; color: #888; margin: 5px 0 0 0; }
        
        /* æ¯”ä¾‹æ¡ */
        .ratio-bar-container {
            height: 24px; width: 100%; background: #eee; border-radius: 12px;
            overflow: hidden; display: flex; margin-top: 10px; position: relative;
        }
        .ratio-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; transition: width 1s ease; }
        .ratio-left { background: #a8edea; } /* ä½ çš„é¢œè‰² */
        .ratio-right { background: #ffb7c5; } /* è§’è‰²é¢œè‰² */

        /* ==================== ğŸ² çµæ„Ÿæ‰­è›‹æœº Pro æ ·å¼ ==================== */
        .gacha-machine {
            background: #fff0f5; border-radius: 30px; padding: 20px;
            border: 4px solid white; box-shadow: inset 0 0 20px rgba(255,183,197,0.2);
            position: relative;
        }
        .gacha-display {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            border: 2px dashed #ffb7c5; min-height: 100px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .gacha-tag {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            font-size: 14px; margin: 5px; font-weight: bold; color: white;
            animation: popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .tag-place { background: #81ecec; }
        .tag-event { background: #74b9ff; }
        .tag-trope { background: #ff7675; }
        
        .gacha-controls { display: flex; gap: 10px; justify-content: center; }
        .gacha-edit-area { display: none; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .gacha-textarea { width: 100%; height: 80px; font-size: 12px; padding: 8px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 5px; resize: none; font-family: inherit; }

        /* ==================== ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤æ ·å¼ ==================== */
        
        /* 1. ä¸»é¡µé™ˆåˆ—æ¶è§†å›¾ */
        .shelf-container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 20px; 
            padding: 20px;
            background: #fff9fb; 
            border: 4px solid #fff; 
            border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(255,183,197,0.1);
        }
        
        /* å•ä¸ªçºªå¿µå“ (æ‹ç«‹å¾—é£æ ¼) */
        .souvenir-card {
            background: white;
            padding: 8px 8px 25px 8px; /* åº•éƒ¨ç•™ç™½åƒæ‹ç«‹å¾— */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: rotate(var(--rot)); /* éšæœºä¸€ç‚¹ç‚¹æ­ªæ–œï¼Œæ›´è‡ªç„¶ */
            transition: transform 0.3s;
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        .souvenir-card:hover {
            transform: scale(1.1) rotate(0deg) !important;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .souvenir-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: #f0f0f0;
            margin-bottom: 5px;
            border: 1px solid #eee;
        }
        .souvenir-title {
            font-family: 'MyCustomFont', cursive, sans-serif;
            font-size: 12px;
            color: #555;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* 2. è¯¦æƒ…é¡µé‡Œçš„çºªå¿µå“æ¨ªå‘æ»šåŠ¨æ  */
        .souvenir-scroll-box {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px;
            margin-bottom: 15px;
            scrollbar-width: thin;
        }
        .souvenir-mini-item {
            flex-shrink: 0; width: 60px; text-align: center; cursor: pointer;
        }
        .souvenir-mini-img {
            width: 50px; height: 50px; border-radius: 10px; object-fit: cover;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* 3. çºªå¿µå“æŸ¥çœ‹å¤§å›¾å¼¹çª— */
        .souvenir-view-content {
            text-align: center;
        }
        .souvenir-view-img {
            max-width: 100%; max-height: 300px; border-radius: 10px;
            border: 5px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .souvenir-view-story {
            font-size: 14px; color: #666; line-height: 1.6; text-align: left;
            background: #fff0f5; padding: 15px; border-radius: 10px;
            margin-bottom: 15px; font-style: italic;
        }

                  /* ==================== â˜ï¸ æœ€ç»ˆç‰ˆï¼šèŠ±ç“£é›¨ä¸å›å¿† ==================== */
        .dream-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* èƒŒæ™¯ï¼šç²‰è‰²æ™¨æ›¦ */
            background: linear-gradient(180deg, #ffc3a0 0%, #ffafbd 100%);
            z-index: 9000; display: none; overflow: hidden;
        }
        .dream-layer.active { display: block; }

        /* ğŸŒ¸ 1. çº¯è£…é¥°ç”¨çš„èƒŒæ™¯èŠ±ç“£ */
        .dream-bg-petal {
            position: absolute; top: -50px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 100% 0 100% 0; /* èŠ±ç“£å½¢çŠ¶ */
            pointer-events: none; /* é¼ æ ‡ç©¿é€ï¼Œç‚¹ä¸åˆ°å®ƒ */
            animation: bgFall linear infinite;
        }
        @keyframes bgFall {
            0% { top: -10%; transform: rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { top: 110%; transform: rotate(360deg) translateX(50px); opacity: 0; }
        }

        /* ğŸ“¦ 2. å›å¿†å®¹å™¨ (ç»Ÿä¸€æ ·å¼) */
        .dream-content-item {
            position: absolute; top: -200px;
            cursor: pointer;
            animation: itemFall linear forwards;
            z-index: 10;
            transition: transform 0.3s;
        }
        .dream-content-item:hover {
            transform: scale(1.1) !important;
            z-index: 100;
        }

        /* ğŸ–¼ï¸ ç±»å‹Aï¼šæ­£æ–¹å½¢å›¾ç‰‡ */
        .dream-item-img {
            width: 120px; height: 120px;
            border-radius: 20px; /* åœ†è§’æ­£æ–¹å½¢ */
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
            overflow: hidden;
            background: #fff;
        }
        .dream-item-img img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .dream-img-name {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.8); color: #d66a80;
            font-size: 10px; text-align: center; padding: 4px 0;
            backdrop-filter: blur(2px);
        }

        /* ğŸ’¬ ç±»å‹Bï¼šæ–‡å­—æ°”æ³¡ */
        .dream-item-text {
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px; /* æ°”æ³¡å°å°¾å·´æ•ˆæœ */
            color: #555; font-size: 13px; line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 180px;
            text-align: left;
            border: 2px solid #fff0f5;
        }

        /* ä¸‹è½åŠ¨ç”» (è½»è½»æ‘‡æ‘†ï¼Œä½†ä¸æ—‹è½¬) */
        @keyframes itemFall {
            0% { top: -150px; opacity: 0; transform: translateX(0); }
            10% { opacity: 1; }
            25% { transform: translateX(20px); }
            50% { transform: translateX(-20px); }
            75% { transform: translateX(20px); }
            100% { top: 110%; opacity: 0; transform: translateX(0); }
        }

        /* ==================== ğŸ“– G. çµé­‚å›å“æ ·å¼ ==================== */
        .echo-card {
            background: #fff; border-radius: 20px; padding: 20px;
            text-align: center; border: 2px solid #e0e0e0;
        }
        .echo-result-box {
            min-height: 100px; margin: 20px 0; display: flex; align-items: center; justify-content: center;
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            font-size: 18px; font-weight: bold; color: var(--accent-color);
            font-family: 'MyCustomFont', sans-serif; position: relative;
        }
        .echo-result-box::before, .echo-result-box::after {
            content: 'â'; position: absolute; font-size: 40px; color: #eee;
        }
        .echo-result-box::before { top: 0; left: 10px; }
        .echo-result-box::after { content: 'â'; bottom: -10px; right: 10px; }

        .echo-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 10px auto; border: 3px solid #ffb7c5;
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.4);
        }

        /* åˆ†é¡µåˆ‡æ¢æ ·å¼ */
        .menu-page { animation: fadeIn 0.3s ease; }
        .menu-tab-bar {
            display: flex; margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;
        }
        .menu-tab {
            flex: 1; background: none; border: none; color: #ccc; cursor: pointer;
            font-size: 13px; padding: 6px; border-radius: 8px; transition: 0.3s;
        }
        .menu-tab:hover { background: #fff5f7; color: var(--accent-color); }
        .menu-tab.active {
            color: white; font-weight: bold; background: var(--accent-color);
            box-shadow: 0 2px 5px rgba(255, 143, 163, 0.3);
        }

        /* ==================== âœ‹ æ‘¸æ‘¸å¤´ç‰¹æ•ˆ ==================== */
        
        /* 1. å›¾ç‰‡è¢«ç‚¹å‡»æ—¶çš„æœå†»åŠ¨ç”» */
        .headpat-active {
            animation: jelly 0.4s;
        }
        @keyframes jelly {
            0% { transform: scale(1, 1); }
            30% { transform: scale(1.05, 0.95); } /* å‹æ‰ */
            40% { transform: scale(0.95, 1.05); } /* æ‹‰é•¿ */
            50% { transform: scale(1.02, 0.98); } /* å›å¼¹ */
            65% { transform: scale(0.99, 1.01); }
            100% { transform: scale(1, 1); }
        }

        /* 2. çˆ†å‡ºçš„çˆ±å¿ƒ/è¡¨æƒ… */
        .pat-particle {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            color: #ff6b81;
            font-size: 20px;
            z-index: 9999;
            animation: floatUpFade 0.8s forwards;
            text-shadow: 0 0 5px white;
        }
        @keyframes floatUpFade {
            0% { opacity: 1; transform:translateY(0) scale(0.5); }
            50% { opacity: 1; transform:translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform:translateY(-60px) scale(1); }
        }

        /* ==================== ğŸ’ èª“çº¦ä¹‹è¯æ ·å¼ ==================== */
        
        .oath-paper {
            background: #fffdf5; /* ç±³é»„è‰²ç¾Šçš®çº¸æ„Ÿ */
            width: 320px;
            padding: 30px 20px;
            border-radius: 10px;
            position: relative;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3), 0 20px 40px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
            transition: transform 0.6s;
            /* åŠ ä¸Šçº¹ç† */
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }

        /* åŒé‡è¾¹æ¡†ï¼Œå¢åŠ ä»ªå¼æ„Ÿ */
        .oath-border {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid #d4af37; /* é‡‘è‰²å®çº¿ */
            border-radius: 5px;
            pointer-events: none;
        }
        .oath-border::after {
            content: ''; position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px;
            border: 1px dashed #d4af37; /* é‡‘è‰²è™šçº¿ */
            border-radius: 3px;
        }

        .oath-header {
            font-size: 22px; color: #d4af37; font-weight: bold;
            margin-bottom: 20px; letter-spacing: 2px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            font-family: serif; /* è¡¬çº¿ä½“æ›´æ˜¾æ­£å¼ */
        }

        .oath-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px double #d4af37;
            object-fit: cover; padding: 2px; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .oath-footer {
            display: flex; justify-content: space-between; margin-top: 30px; padding: 0 20px;
        }
        .oath-sign-box { text-align: left; font-size: 12px; color: #999; }
        .sign-line {
            font-family: cursive; font-size: 16px; color: #333;
            border-bottom: 1px solid #ddd; min-width: 80px; margin-top: 5px;
            text-align: center; padding-bottom: 2px;
        }

        /* ğŸ”´ æŒ‰æ‰‹å°æŒ‰é’® */
        .oath-seal-btn {
            background: #ff7675; color: white;
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 30px auto 10px auto; cursor: pointer;
            font-weight: bold; border: 4px solid #fab1a0;
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
            animation: pulseBtn 2s infinite;
            transition: all 0.3s;
        }
        .oath-seal-btn:active { transform: scale(0.9); }
        @keyframes pulseBtn { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }

        /* ğŸ’‹ ç›–ç« å°è®° */
        .oath-stamp-mark {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%) scale(2);
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* ç›–ç« ç”Ÿæ•ˆæ—¶çš„æ ·å¼ */
        .oath-paper.signed .oath-seal-btn { display: none; } /* éšè—æŒ‰é’® */
        .oath-paper.signed .oath-stamp-mark {
            opacity: 0.8; transform: translateX(-50%) scale(1) rotate(-10deg);
        }
        .oath-paper.signed {
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.6); /* èª“çº¦è¾¾æˆå‘å‡ºé‡‘å…‰ */
            border-color: #ffd700;
        }

               /* ==================== ğŸ–¼ï¸ ç›¸æ¡†æ ·å¼åº“ (åŠ ç²—åŠ å¼ºç‰ˆ) ==================== */
        
        /* 1. ğŸ€ è•¾ä¸ç”œå¿ƒ (åŠ ç²—ç²‰çº¿ + å¤§è´è¶ç»“) */
        .card-img-wrapper.frame-lace {
            border: 5px dashed #ff8fa3; /* çº¿æ¡å˜ç²—ï¼Œé¢œè‰²å˜æ·± */
            background: #fff0f5;
            /* åŒå±‚æŠ•å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
            box-shadow: 
                0 0 0 4px #fff inset, 
                0 10px 20px rgba(255, 143, 163, 0.3);
            overflow: visible; /* å…è®¸è´è¶ç»“çªå‡ºæ¥ä¸€ç‚¹ */
            z-index: 1;
        }
        .card-img-wrapper.frame-lace::after {
            content: 'ğŸ€'; position: absolute; top: -10px; left: -10px;
            font-size: 32px; /* å›¾æ ‡æ”¾å¤§ */
            z-index: 10;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
            transform: rotate(-15deg);
        }

        /* 2. âšœï¸ éé‡‘å…¸è— (åšé‡é‡‘æ¡† + å¤§çº¹é¥°) */
        .card-img-wrapper.frame-gold {
            border: 6px solid #d4af37; /* å®å¿ƒåšé‡‘è¾¹ */
            /* å†…ä¾§åŠ ä¸€é“æ·±è‰²çº¿ï¼ŒåƒçœŸç”»æ¡† */
            outline: 2px solid #8a6d3b; 
            outline-offset: -8px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); /* æ·±é‚ƒæŠ•å½± */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-gold::before {
            content: 'âšœï¸'; position: absolute; bottom: -10px; right: -10px;
            font-size: 28px; z-index: 10;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }
        /* é¡¶éƒ¨åŠ ä¸ªçš‡å† è£…é¥° */
        .card-img-wrapper.frame-gold::after {
            content: 'ğŸ‘‘'; position: absolute; top: -15px; left: 50%;
            transform: translateX(-50%);
            font-size: 24px; z-index: 10;
        }

        /* 3. âœ¨ æ˜Ÿå…‰æµä½“ (å¼ºåŠ›éœ“è™¹å…‰æ•ˆ) */
        .card-img-wrapper.frame-stardust {
            border: 4px solid transparent;
            /* è¿™ç§å†™æ³•å¯ä»¥åšå‡ºæ¸å˜è¾¹æ¡† */
            background-image: linear-gradient(white, white), linear-gradient(45deg, #a18cd1, #fbc2eb, #8fd3f4);
            background-origin: border-box;
            background-clip: content-box, border-box;
            /* è¶…å¼ºå…‰æ™• */
            box-shadow: 0 0 20px 5px rgba(161, 140, 209, 0.6);
            animation: borderRotate 2s linear infinite; /* è¾¹æ¡†è‰²è°ƒæµåŠ¨ */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-stardust::after {
            content: 'âœ¨'; position: absolute; bottom: 5px; right: 5px;
            font-size: 24px; 
            filter: drop-shadow(0 0 5px #fff);
            animation: spin 3s linear infinite;
        }
        @keyframes borderRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* 4. ğŸŒ¸ è½æ¨±ç”»å¢ƒ (èŠ±å›¢é”¦ç°‡) */
        .card-img-wrapper.frame-sakura {
            border: 5px solid #ff9a9e; /* ç²—ç²‰è¾¹ */
            border-radius: 25px; /* æ›´åœ†æ¶¦ */
            box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            overflow: visible;
            z-index: 1;
        }
        /* å·¦ä¸Šè§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::before {
            content: 'ğŸŒ¸'; position: absolute; top: -12px; left: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }
        /* å³ä¸‹è§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::after {
            content: 'ğŸŒ¸'; position: absolute; bottom: -12px; right: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }

                /* ==================== ğŸ–¼ï¸ è¯¦æƒ…é¡µä¸“å±ï¼šè¾¹æ¡†+ç‰¹æ•ˆ ==================== */
        
        /* 1. å¿…é¡»ç»™ç”»å»Šå®¹å™¨è®¾ç½® overflow: visibleï¼Œå¦åˆ™è´è¶ç»“ä¼šè¢«åˆ‡æ‰ */
        .gallery-container {
            overflow: visible !important; 
            transition: all 0.3s;
            background: #fff; /* é»˜è®¤ç™½åº• */
        }

                /* ==================== âœ¨ é«˜å®šç‰ˆï¼šè¯¦æƒ…é¡µç²’å­ç‰¹æ•ˆ ==================== */
        
        /* 1. ç‰¹æ•ˆå®¹å™¨ï¼šå¿…é¡»è£å‰ªæº¢å‡ºï¼Œé˜²æ­¢ç²’å­é£˜åˆ°æ¡†å¤–é¢ */
        .detail-effect-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
            overflow: hidden; border-radius: 15px;
        }

        /* 2. é€šç”¨ç²’å­åŸºç¡€æ ·å¼ */
        .effect-particle {
            position: absolute; top: -20px;
            pointer-events: none;
            opacity: 0;
        }

        /* ========== ğŸŒ¸ æ¨±èŠ± (Sakura) - çœŸæ­£çš„èŠ±ç“£å½¢çŠ¶ ========== */
        .particle-sakura {
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 100% 0 100% 0; /* ğŸ‘ˆ å…³é”®ï¼šåšæˆèŠ±ç“£å°–è§’å½¢çŠ¶ */
            animation: fall-sway linear infinite;
            box-shadow: 0 2px 5px rgba(255, 154, 158, 0.2);
        }
        @keyframes fall-sway {
            0% { top: -10%; opacity: 0; transform: translateX(0) rotate(0deg); }
            10% { opacity: 0.9; }
            50% { opacity: 1; transform: translateX(20px) rotate(90deg); }
            100% { top: 110%; opacity: 0; transform: translateX(-20px) rotate(180deg); }
        }

        /* ========== âœ¨ æ˜Ÿå…‰ (Stardust) - é—ªçƒæµæ˜Ÿ ========== */
        .particle-star {
            background: white;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); /* æ˜Ÿæ˜Ÿå½¢çŠ¶ */
            animation: fall-twinkle linear infinite;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        @keyframes fall-twinkle {
            0% { top: -10%; opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { top: 110%; opacity: 0; transform: scale(0.5); }
        }

        /* ========== ğŸ€ è•¾ä¸ (Lace) - æŸ”å’Œå…‰æ–‘/çˆ±å¿ƒ ========== */
        .particle-heart {
            color: #ff8fa3;
            font-size: 14px;
            animation: fall-float linear infinite;
        }
        .particle-heart::after { content: 'ğŸ’—'; } /* ç”¨ Emoji æ›´æ¸…æ™° */
        @keyframes fall-float {
            0% { top: -10%; transform: translateY(0) scale(0.8); opacity: 0; }
            50% { opacity: 0.8; transform: translateY(10px) scale(1.1); }
            100% { top: 110%; transform: translateY(0) scale(0.8); opacity: 0; }
        }

        /* ========== âšœï¸ éé‡‘ (Gold) - é‡‘ç²‰ç²’å­ ========== */
        .particle-gold {
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px #d4af37;
            animation: fall-fast linear infinite;
        }
        @keyframes fall-fast {
            0% { top: -10%; opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            100% { top: 120%; opacity: 0; transform: translateY(20px); }
        }

        /* ==================== ğŸ¤« åˆ®åˆ®ä¹æ ·å¼ ==================== */
        .scratch-container {
            position: relative;
            width: 260px; height: 150px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            user-select: none; /* é˜²æ­¢é€‰ä¸­æ–‡å­— */
        }

        /* åº•å±‚æ–‡å­— */
        .scratch-text-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            color: #d66a80; font-weight: bold; font-size: 15px;
            line-height: 1.5;
            z-index: 1;
            background: #fff; /* ç™½åº• */
        }

        /* é¡¶å±‚ç”»å¸ƒ (æ¶‚å±‚) */
        #scratchCanvas {
            position: absolute; top: 0; left: 0;
            z-index: 2;
            touch-action: none; /* é˜²æ­¢æ‰‹æœºæ»šåŠ¨ */
            cursor: crosshair;
        }

        /* åˆå§‹é®ç½© (åšé€‰æ‹©é¢˜ç”¨) */
        .scratch-cover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }

        .scratch-actions {
            display: flex; justify-content: center; gap: 15px; margin-top: 20px;
        }

        /* ==================== ğŸ“Œ ä¾¿ç­¾æ ·å¼ ==================== */
        
        .sticky-note-paper {
            width: 280px;
            height: 350px;
            background: #fff9c4; /* ç»å…¸çš„ä¾¿ç­¾é»„ */
            /* å¦‚æœå–œæ¬¢ç²‰è‰²ä¾¿ç­¾ï¼Œå¯ä»¥ç”¨è¿™ä¸ªé¢œè‰²: #fff0f5 */
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            transform: rotate(-2deg); /* å¾®å¾®æ­ªä¸€ç‚¹ï¼Œæ›´è‡ªç„¶ */
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s;
        }
        
        /* æ‚¬åœæ‰¶æ­£ */
        .sticky-note-paper:hover {
            transform: rotate(0deg) scale(1.02);
            box-shadow: 10px 10px 30px rgba(0,0,0,0.15);
        }

        /* é¡¶éƒ¨ç±»ä¼¼èƒ¶å¸¦çš„æ•ˆæœ */
        .sticky-note-paper::before {
            content: '';
            position: absolute;
            top: -15px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .note-toolbar {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* è¾“å…¥æ¡†å»è¾¹æ¡†ï¼Œåƒç›´æ¥å†™åœ¨çº¸ä¸Š */
        #noteTextarea {
            flex-grow: 1;
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-family: 'MyCustomFont', cursive, sans-serif; /* ç”¨ä½ çš„å¯çˆ±å­—ä½“ */
            line-height: 1.6;
            color: #555;
        }
        
        /* è‡ªå®šä¹‰å–è‰²å™¨æ ·å¼ (ç®€å•ä¼˜åŒ–) */
        #noteColorPicker {
            border: none; width: 20px; height: 20px; cursor: pointer; background: none;
        }

       /* ================= ğŸ“Œ ä¾¿ç­¾å¢™æ ·å¼ (é˜²é®æŒ¡ç‰ˆ) ================= */
#stickyNoteDisplay {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end; /* é å³æ’ */
    gap: 10px;
    padding: 10px;
    position: absolute;
    top: 50px;           /* é¿å¼€é¡¶éƒ¨çš„å…³é—­æŒ‰é’® */
    right: 10px;
    width: 85%;          /* å®½åº¦é™åˆ¶ */
    min-height: 50px;    /* ç»™ä¸ªæœ€å°é«˜åº¦ */
    pointer-events: none; /* å®¹å™¨é€ä¼ é¼ æ ‡ */
    z-index: 100;        /* âœ… å±‚çº§æ‹‰é«˜ï¼Œä¿è¯åœ¨æœ€ä¸Šå±‚ï¼ */
}

/* ================= ğŸ“Œ æ‰‹è´¦é£ä¾¿ç­¾æ ·å¼ (æ›¿æ¢æ—§çš„) ================= */

.real-sticky-note {
    position: relative;
    width: 110px;
    min-height: 90px;
    padding: 15px 10px 10px 10px; /* ä¸Šé¢ç•™ç‚¹ç©ºç»™èƒ¶å¸¦ */
    
    /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä¸å†æ˜¯æ­»æ¿çš„æ–¹å—ï¼Œå³ä¸‹è§’å¤§åœ†è§’æ¨¡æ‹Ÿå·èµ· */
    border-radius: 2px 2px 20px 2px; 
    
    /* çº¸å¼ è´¨æ„Ÿé˜´å½±ï¼šä¸¤å±‚é˜´å½±ï¼Œä¸€å±‚æ˜¯çº¸çš„ï¼Œä¸€å±‚æ˜¯å·è§’çš„ */
    box-shadow: 
        1px 1px 3px rgba(0,0,0,0.1), /* åŸºç¡€é˜´å½± */
        5px 5px 10px rgba(0,0,0,0.1); /* æµ®èµ·é˜´å½± */
    
    font-family: 'MyCustomFont', cursive, sans-serif;
    font-size: 13px;
    line-height: 1.5;
    color: #444;
    word-wrap: break-word;
    
    cursor: pointer;
    transition: transform 0.2s;
    pointer-events: auto;
    
    /* é»˜è®¤å¸¦ä¸€ç‚¹æ—‹è½¬ï¼ŒJSä¼šè¦†ç›–è¿™ä¸ªå˜é‡ */
    transform: rotate(var(--rot, 0deg));
    
    /* ç»™ä¸ªç±³é»„è‰²çš„åº•ï¼Œé˜²æ­¢é¢œè‰²åŠ è½½æ…¢æ—¶å¤ªç™½ */
    background-color: #fff9c4;
}

/* æ‚¬åœç‰¹æ•ˆï¼šä»¿ä½›è¦è¢«æ­ä¸‹æ¥ */
.real-sticky-note:hover {
    transform: scale(1.1) rotate(0deg) !important;
    z-index: 200;
    box-shadow: 5px 15px 25px rgba(0,0,0,0.15); /* æ‚¬åœæ—¶é˜´å½±å˜é•¿ */
}

/* ğŸ¬ åŠé€æ˜å’Œçº¸èƒ¶å¸¦è£…é¥° */
.real-sticky-note::before {
    content: ''; 
    position: absolute; 
    top: -12px;           /* è´´åœ¨æœ€ä¸Šé¢ï¼Œéœ²å‡ºä¸€åŠ */
    left: 50%; 
    transform: translateX(-50%) rotate(-2deg); /* èƒ¶å¸¦ä¹Ÿç¨å¾®æ­ªä¸€ç‚¹ */
    
    width: 40px; 
    height: 18px;
    
    /* åŠé€æ˜ç£¨ç ‚èƒ¶å¸¦æ„Ÿ */
    background: rgba(255, 255, 255, 0.4); 
    border-left: 2px dotted rgba(255,255,255,0.6); /* èƒ¶å¸¦æ’•å£ */
    border-right: 2px dotted rgba(255,255,255,0.6);
    
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    backdrop-filter: blur(2px); /* ç£¨ç ‚æ•ˆæœ */
}



        /* ==================== ğŸ¤– AI èŠå¤©æ ·å¼ ==================== */
        .ai-msg-row {
            display: flex; margin-bottom: 8px;
        }
        .ai-msg-row.user { justify-content: flex-end; }
        .ai-msg-row.ai { justify-content: flex-start; }
        
        .ai-bubble {
            padding: 8px 12px; border-radius: 15px; max-width: 80%;
            word-wrap: break-word; line-height: 1.4;
            font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-msg-row.user .ai-bubble {
            background: var(--accent-color); color: white;
            border-bottom-right-radius: 2px;
        }
        .ai-msg-row.ai .ai-bubble {
            background: #fff; color: #555; border: 1px solid #eee;
            border-bottom-left-radius: 2px;
        }
        .ai-loading { color: #999; font-size: 10px; font-style: italic; margin-left: 5px; }

        /* AI æ¨èè·³è½¬æŒ‰é’® */
        .ai-jump-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 10px;
            background: #fff0f5;
            color: #d66a80;
            border: 1px solid #ffb7c5;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .ai-jump-btn:hover {
            background: #ffb7c5;
            color: white;
            transform: translateY(-2px);
        }

        /* ==================== ğŸ’Œ ä¿¡çº¸æ ·å¼ ==================== */
        .letter-paper {
            background: #fffbf0; /* ç±³é»„çº¸ */
            width: 300px;
            min-height: 400px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 100% 25px; /* ä¿¡çº¸æ¨ªçº¿ */
            line-height: 25px;
            font-family: 'MyCustomFont', cursive, sans-serif; /* æ‰‹å†™å­—ä½“ */
            color: #555;
            transform: rotate(-1deg);
        }
        
        .letter-content {
            margin-top: 20px;
            font-size: 15px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

        .letter-signature {
            margin-top: 30px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .letter-stamp {
            position: absolute;
            top: 20px; right: 20px;
            width: 60px; height: 60px;
            border: 3px double #d63031;
            border-radius: 50%;
            color: #d63031;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            transform: rotate(20deg);
            opacity: 0.6;
            pointer-events: none;
        }

/* ==================== ğŸ“± æœ‹å‹åœˆæ ·å¼ ==================== */
.moment-card {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    animation: fadeInUp 0.4s ease;
}

.moment-header {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.moment-user-avatar {
    width: 40px; height: 40px;
    border-radius: 5px;
    background: #ffb7c5;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: bold; font-size: 18px;
}

.moment-content {
    font-size: 15px;
    color: #333;
    line-height: 1.5;
    margin-bottom: 10px;
}

.moment-meta {
    font-size: 12px;
    color: #999;
    display: flex; justify-content: space-between;
    margin-bottom: 10px;
}

/* è¯„è®ºåŒºçš„å°ä¸‰è§’ */
.moment-comments-area {
    background: #f7f7f7;
    border-radius: 4px;
    padding: 8px;
    position: relative;
    margin-top: 10px;
}
.moment-comments-area::before {
    content: '';
    position: absolute;
    top: -6px; left: 15px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid #f7f7f7;
}

.moment-comment-row {
    font-size: 13px;
    margin-bottom: 5px;
    line-height: 1.4;
    border-bottom: 1px dashed #eee;
    padding-bottom: 4px;
}
.moment-comment-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.moment-role-name {
    color: #576b95; /* ç»å…¸æœ‹å‹åœˆè“å */
    font-weight: bold;
    cursor: pointer;
}

/* ==================== ğŸ“° å…«å¦å‘¨åˆŠæ ·å¼ ==================== */
.gossip-headline {
    font-family: 'Times New Roman', serif;
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
    margin: 20px 0 10px 0;
    line-height: 1.3;
    text-align: left;
    border-bottom: 2px solid #333;
    padding-bottom: 5px;
}
.gossip-body {
    font-size: 14px;
    color: #444;
    line-height: 1.6;
    text-align: justify;
    font-family: serif;
    margin-bottom: 15px;
}
.gossip-tag {
    background: #333;
    color: #fff;
    padding: 2px 6px;
    font-size: 10px;
    text-transform: uppercase;
    display: inline-block;
    margin-bottom: 5px;
}
.gossip-img-placeholder {
    width: 100%; height: 120px;
    background: #e0e0e0;
    margin-bottom: 10px;
    display: flex; align-items: center; justify-content: center;
    color: #999; font-size: 12px; font-style: italic;
    border: 1px solid #ccc;
}

/* ==================== ğŸ± æ·±å¤œé£Ÿå ‚æ ·å¼ ==================== */
/* ä¸»è¦æ˜¯æ·±è‰²æ¨¡å¼å¾®è°ƒï¼Œå·²å†…è”åœ¨ HTML ä¸­ï¼Œæ­¤å¤„æ— éœ€é¢å¤–å¤æ‚æ ·å¼ */

/* ==================== ğŸ•¯ï¸ çµé­‚æ‹·é—®å®¤æ ·å¼ ==================== */
.soul-pulse {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
    animation: pulse-white 2s infinite;
    pointer-events: none;
    z-index: -1;
}

@keyframes pulse-white {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    70% { transform: scale(1.2); box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}

/* æ‰“å­—æœºå…‰æ ‡æ•ˆæœ */
.typing-cursor::after {
    content: '|';
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0; } }

/* ================= ğŸ›ï¸ è¯¦æƒ…é¡µæ§åˆ¶å°æ ·å¼ (æ–°) ================= */

/* 1. æŒ‰é’®å®¹å™¨ï¼šæ”¹ä¸º Grid ç½‘æ ¼å¸ƒå±€ */
.control-panel-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* å¼ºåˆ¶åˆ†ä¸º 3 åˆ— */
    gap: 8px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    margin-top: 15px;
    padding: 0 5px;
}

/* 2. ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
.control-panel-grid button {
    width: 100%;
    margin: 0 !important; /* å»æ‰åŸæ¥çš„å¤–è¾¹è· */
    padding: 8px 0;
    font-size: 12px; /* å­—ä½“æ”¹å°ä¸€ç‚¹ç‚¹ï¼Œé˜²æ­¢æ¢è¡Œ */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}

/* 3. åº•éƒ¨å±é™©åŒº (ä¸“é—¨æ”¾åˆ é™¤æŒ‰é’®) */
.danger-zone {
    margin-top: 10px;
    padding: 0 5px;
}
.danger-zone button {
    width: 100%;
    padding: 10px;
    font-weight: bold;
}

/* ================= ğŸ’– æ©å®  & ğŸŒ  é’¦å¤©ç›‘ æ ·å¼ ================= */

/* 1. ä½ä»½å¾½ç«  (æ˜¾ç¤ºåœ¨åå­—æ—è¾¹) */
.rank-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
    vertical-align: middle;
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* ä¸åŒç­‰çº§ä¸åŒé¢œè‰² */
.rank-0 { background: #b0bec5; border: 1px solid #90a4ae; } /* ä¾å¥´ */
.rank-1 { background: #81d4fa; border: 1px solid #4fc3f7; } /* ç­”åº” */
.rank-2 { background: #a5d6a7; border: 1px solid #81c784; } /* è´µäºº */
.rank-3 { background: #ffcc80; border: 1px solid #ffb74d; } /* å«” */
.rank-4 { background: #f48fb1; border: 1px solid #f06292; } /* å¦ƒ */
.rank-5 { background: linear-gradient(135deg, #ffd700, #ff8f00); border: 1px solid #ffa000; text-shadow: 0 1px 0 rgba(0,0,0,0.2); } /* çš‡è´µå› */

/* 2. æ©å® è¿›åº¦æ¡ (æ”¾åœ¨åå­—ä¸‹é¢) */
.favor-progress-container {
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 3px;
    margin-top: 5px;
    overflow: hidden;
    position: relative;
}
.favor-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff9a9e, #fad0c4);
    width: 0%;
    transition: width 0.5s;
}

/* 3. é’¦å¤©ç›‘å¼¹çª— (æ˜Ÿç©ºèƒŒæ™¯) */
#horoscopeModal .modal {
    background: linear-gradient(to bottom, #1a1a2e, #16213e);
    color: #fff;
    border: 2px solid #ffd700;
}
.horoscope-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

/* ================= ğŸ‘¶ çš‡å—£ç³»ç»Ÿï¼š2DåŠ¨æ€ç«‹ç»˜ç‰ˆ ================= */

/* 1. ä¸œå®«å¼¹çª—å®¹å™¨ */
#eastPalaceModal .modal {
    width: 380px;
    background: #fff;
    border: 3px solid #ffb7c5;
    border-radius: 12px;
    padding: 0;
    overflow: hidden;
    display: flex; flex-direction: column;
}

/* 2. é¡¶éƒ¨å¤§èƒŒæ™¯ (æ”¾æ‚¨ç»™çš„é£æ™¯ç…§) */
.heir-bg-stage {
    width: 100%;
    height: 180px; /* é£æ™¯å›¾é«˜åº¦ */
    background-size: cover;
    background-position: center;
    position: relative;
    border-bottom: 2px solid #ffd1dc;
}

/* 3. ä¸­é—´åŒºåŸŸï¼šå·¦è¾¹ä¿¡æ¯ï¼Œå³è¾¹ç«‹ç»˜ */
.heir-middle-section {
    display: flex;
    position: relative;
    padding: 10px;
    background: linear-gradient(to bottom, #fff0f5 0%, #fff 100%);
}

.heir-info-left {
    flex: 1; /* å·¦è¾¹å æ»¡å‰©ä½™ç©ºé—´ */
    padding-right: 100px; /* âš ï¸ å…³é”®ï¼šå³è¾¹ç•™å‡ºç©ºä½ç»™ç«‹ç»˜ï¼ */
}

/* ğŸ”¥ 4. å³ä¾§ç«‹ç»˜å°æ¡† (æ‚¨è¦çš„å°æ¡) */
.heir-avatar-box {
    position: absolute;
    right: 10px;
    top: -60px; /* è®©å®ƒç¨å¾®çªå‡ºå»ä¸€ç‚¹åˆ°èƒŒæ™¯å›¾ä¸Šï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    width: 120px;
    height: 160px;
    z-index: 10;
    display: flex;
    align-items: flex-end; /* è®©äººç‰©ç«™åœ¨åº•éƒ¨ */
    justify-content: center;
    /* è°ƒè¯•ç”¨ï¼šå¦‚æœæ‚¨æƒ³çœ‹åˆ°æ¡†æ¡†ï¼Œå¯ä»¥åŠ  borderï¼Œè¿™é‡Œæˆ‘å…ˆéšè—è¾¹æ¡† */
    /* border: 1px dashed red; */ 
}

/* åŠ¨å›¾æœ¬ä½“ */
.heir-gif {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); /* åŠ ç‚¹é˜´å½±æ›´ç«‹ä½“ */
    transition: all 0.3s;
    cursor: pointer;
}
.heir-gif:hover { transform: scale(1.05); }

/* 5. å±æ€§æ¡æ ·å¼ä¼˜åŒ– */
.stat-row { display: flex; align-items: center; margin-bottom: 4px; font-size: 12px; color: #666; }
.stat-name { width: 30px; font-weight: bold; }
.stat-track { flex: 1; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin: 0 5px; }
.stat-val { height: 100%; border-radius: 3px; transition: width 0.5s; }

/* 6. åº•éƒ¨æ“ä½œåŒº */
.heir-bio-scroll {
    height: 80px; overflow-y: auto;
    background: rgba(255,255,255,0.6);
    border: 1px dashed #ffb7c5;
    margin: 5px 10px; padding: 5px;
    font-size: 11px; color: #555; border-radius: 5px;
}
.heir-btn-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px;
}
.heir-action-btn {
    padding: 8px; border: 1px solid #ffb7c5; background: #fff; color: #e67e93; 
    border-radius: 5px; cursor: pointer; font-size: 12px;
}
.heir-action-btn:hover { background: #fff0f5; }

/* è·¨å¹´å¤§æŒ‰é’® */
.next-year-btn {
    grid-column: span 3;
    background: #ff9a9e; color: white; border: none; font-weight: bold;
    margin-top: 5px;
}

/* ================= ğŸŒ¸ ä¸œå®«ä¿®å¤è¡¥ä¸ (å¼ºåˆ¶æ˜¾ç¤ºèƒŒæ™¯) ================= */
.heir-bg-stage {
    display: block !important;
    width: 100% !important;
    height: 200px !important;      /* ç»™è¶³é«˜åº¦ */
    min-height: 200px !important;
    flex-shrink: 0 !important;     /* ç¦æ­¢è¢«æŒ¤å‹ */
    background-size: cover !important;
    background-position: center !important;
    background-color: #e0e0e0;     /* æ²¡å›¾æ—¶çš„åº•è‰² */
    position: relative !important;
    z-index: 5 !important;
    border-bottom: 3px solid #ffd1dc;
}

/* æ¢å­£æŒ‰é’® */
.season-toggle-btn {
    position: absolute !important; top: 15px; right: 50px; z-index: 100;
    background: rgba(255,255,255,0.9); border: 2px solid #d4af37; color: #d4af37;
    padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* éšè—æ—§çš„å°çƒç›¸å…³æ ·å¼ (é˜²æ­¢å¹²æ‰°) */
.heir-ball-wrapper, .heir-ball { display: none !important; }

/* ================= ğŸ§  çš‡å—£ç³»ç»Ÿ 2.0 ä¸“å±æ ·å¼ ================= */

/* èŠå¤©æ°”æ³¡åŠ¨ç”» */
@keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

/* å±æ€§æ¡å®¹å™¨ */
.heir-stat-row { display: flex; align-items: center; font-size: 12px; margin-bottom: 6px; color: #555; }
.heir-stat-label { width: 32px; font-weight: bold; text-align: right; margin-right: 5px; }
.heir-stat-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
.heir-stat-bar { height: 100%; border-radius: 4px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
.heir-stat-num { width: 28px; text-align: right; font-family: monospace; opacity: 0.7; }

/* èŠå¤©åŒºåŸŸ */
.heir-chat-container {
    flex: 1; overflow-y: auto; padding: 15px; 
    background-color: #f7f9fc;
    display: flex; flex-direction: column; gap: 12px;
    scroll-behavior: smooth;
}

/* æ¶ˆæ¯æ°”æ³¡ */
.heir-msg {
    max-width: 80%; padding: 10px 14px; border-radius: 15px;
    font-size: 13px; line-height: 1.5; position: relative;
    animation: popIn 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.heir-msg.ai { align-self: flex-start; background: #fff; border-bottom-left-radius: 2px; color: #444; }
.heir-msg.user { align-self: flex-end; background: #a29bfe; color: white; border-bottom-right-radius: 2px; }

/* åº•éƒ¨è¾“å…¥åŒº */
.heir-input-area {
    padding: 10px; background: #fff; border-top: 1px solid #eee;
    display: flex; flex-direction: column; gap: 8px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.03);
}
.heir-input-row { display: flex; gap: 8px; }
.heir-input-box {
    flex: 1; padding: 10px 15px; border: 2px solid #eee; border-radius: 20px;
    font-size: 14px; outline: none; transition: 0.3s;
}
.heir-input-box:focus { border-color: #a29bfe; background: #fdfdfd; }
.heir-send-btn {
    background: #a29bfe; color: white; border: none; padding: 0 20px;
    border-radius: 20px; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); transition: 0.2s;
}
.heir-send-btn:active { transform: scale(0.95); }

/* åŠŸèƒ½æŒ‰é’®è¡Œ */
.heir-func-row { display: flex; justify-content: space-between; padding: 0 5px; }
.heir-func-btn {
    background: none; border: 1px dashed #ccc; color: #888;
    padding: 4px 10px; border-radius: 15px; font-size: 11px; cursor: pointer;
}
.heir-func-btn:hover { border-color: #a29bfe; color: #a29bfe; }

/* ================= ğŸ—ºï¸ åœ°å›¾ & å›å¿†å½•æ ·å¼ ================= */

/* åœ°å›¾å¼¹çª—å®¹å™¨ */
.map-modal-body {
    display: flex; flex-direction: column; height: 100%; background: #fffbf0;
}

/* åœ°å›¾ä¸ŠåŠéƒ¨åˆ† */
.map-header {
    height: 180px; background-size: cover; background-position: center;
    position: relative; border-bottom: 3px solid #d4af37;
    flex-shrink: 0;
}
.map-title-badge {
    position: absolute; top: 10px; left: 10px; 
    background: rgba(0,0,0,0.6); color: #d4af37; 
    padding: 5px 12px; border-radius: 20px; font-weight: bold; border: 1px solid #d4af37;
}

/* åœ°ç‚¹ç½‘æ ¼ */
.map-grid {
    flex: 1; overflow-y: auto; padding: 15px; 
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    align-content: start;
}
.location-card {
    background: #fff; border: 1px solid #e0d0b0; border-radius: 8px;
    padding: 10px 5px; text-align: center; font-size: 12px; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}
.location-card:hover { transform: translateY(-2px); border-color: #d4af37; background: #fff7d1; }

/* ğŸï¸ æ™¯ç‚¹å¯¹è¯æ¨¡å¼ */
.travel-chat-view {
    display: flex; flex-direction: column; height: 100%; background: #fff;
}
.travel-scene-area {
    height: 200px; position: relative; 
    background-size: cover; background-position: center;
    display: flex; align-items: flex-end; justify-content: center;
}
/* æ—…æ¸¸æ—¶çš„å°äºº */
.travel-avatar {
    height: 140px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
    transition: transform 0.3s;
}
.travel-chat-box {
    flex: 1; overflow-y: auto; padding: 15px; background: rgba(255,255,255,0.9);
}
.travel-controls {
    padding: 10px; background: #fff; border-top: 1px solid #eee;
    display: flex; gap: 10px;
}

/* ğŸ“– å›å¿†å½•åˆ—è¡¨ */
.memory-list {
    padding: 20px; overflow-y: auto; height: 100%; background: #fffaf0;
}
.memory-item {
    position: relative; padding-left: 20px; margin-bottom: 20px; border-left: 2px solid #ffb7c5;
}
.memory-item::before {
    content: 'ğŸŒ¸'; position: absolute; left: -9px; top: 0; background: #fffaf0;
}
.memory-content {
    background: #fff; padding: 10px; border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 13px; line-height: 1.6; color: #555;
}

/* ================= ğŸ“± æ‰‹æœº & çŠ¶æ€é¢æ¿æ ·å¼ ================= */

/* åˆ‡æ¢æŒ‰é’® */
.switch-btn {
    font-size: 10px; background: #fff; border: 1px solid #ddd;
    border-radius: 10px; padding: 2px 8px; cursor: pointer; color: #888;
    margin-bottom: 5px; display: inline-block;
}
.switch-btn.active { background: #a29bfe; color: white; border-color: #a29bfe; }

/* èº«ä½“æ¡£æ¡ˆé¢æ¿ */
.info-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: #555;
    background: #fdfdfd; padding: 5px; border-radius: 5px;
}
.info-item { border-bottom: 1px dashed #eee; padding-bottom: 2px; }
.info-label { color: #999; margin-right: 5px; }
.status-tag { padding: 1px 4px; border-radius: 4px; color: white; font-size: 10px; }
.status-good { background: #00b894; }
.status-bad { background: #d63031; }
.status-warn { background: #fdcb6e; }

/* ================= ğŸ“± æ‰‹æœºç³»ç»Ÿ (æœ€ç»ˆç¾åŒ–Â·ç™½èº«ç²‰æ¡†ç‰ˆ) ================= */

/* 1. æ‰‹æœºå¤–å£³ï¼šçº¯ç™½æœºèº« + å°‘å¥³ç²‰è¾¹æ¡† */
.iphone-modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 340px; height: 660px; /* ç¨å¾®åŠ é•¿ä¸€ç‚¹ï¼Œè§†é‡æ›´å¥½ */
    background: #ffffff; /* çº¯ç™½æœºèº« */
    border: 6px solid #ffb7c5; /* ğŸ’– å¯çˆ±çš„ç²‰è‰²è¾¹æ¡† */
    border-radius: 40px;
    box-shadow: 
        0 0 0 2px #fff inset, /* å†…å‘å…‰ */
        0 20px 50px rgba(255, 183, 197, 0.4); /* ç²‰è‰²å…‰æ™•æŠ•å½± */
    z-index: 10000; display: none; flex-direction: column; overflow: hidden;
    font-family: sans-serif;
    animation: popUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes popUp { from {transform: translate(-50%, 0) scale(0.9); opacity: 0;} to {transform: translate(-50%, -50%) scale(1); opacity: 1;} }

/* 2. é¢å¤´ä¸ä¸‹å·´ */
.iphone-chin-top { height: 35px; background: #fff; flex-shrink: 0; position: relative; border-bottom: 1px solid #f5f5f5; }
.iphone-camera { 
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 60px; height: 12px; background: #eee; border-radius: 20px; 
}
.iphone-chin-bottom { height: 55px; background: #fff; flex-shrink: 0; display: flex; justify-content: center; align-items: center; border-top: 1px solid #f5f5f5; }
.iphone-home-btn {
    width: 45px; height: 45px; border-radius: 50%; 
    background: #fff; border: 3px solid #ffb7c5; /* ç²‰è‰²Homeé”®ç¯ */
    box-shadow: inset 0 0 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
}
.iphone-home-btn:active { transform: scale(0.9); background: #f0f0f0; }

/* 3. å±å¹•åŒºåŸŸ */
.iphone-screen {
    flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column;
    /* æ¸…æ–°å£çº¸ï¼ŒåŠ ä¸€ç‚¹æ¨¡ç³Šé®ç½©è®©å›¾æ ‡æ›´æ¸…æ™° */
    background: url('https://files.catbox.moe/gsn7fd.png') center/cover;
}
.iphone-screen::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.3); pointer-events: none;
}

.iphone-statusbar {
    height: 24px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;
    font-size: 11px; font-weight: bold; color: #555; z-index: 5;
    background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
}

/* 4. APP å›¾æ ‡ç½‘æ ¼ (å¯çˆ±é£) */
.app-grid {
    padding: 30px 20px; display: grid; grid-template-columns: repeat(4, 1fr); 
    gap: 20px 10px; align-content: start; flex: 1; z-index: 5;
}
/* å›¾æ ‡å¤–å£³ */
.app-icon-wrapper {
    display: flex; flex-direction: column; align-items: center; cursor: pointer;
    transition: transform 0.2s;
}
.app-icon-wrapper:hover { transform: translateY(-3px); }
.app-icon-wrapper:active { transform: scale(0.95); }

/* å›¾æ ‡æœ¬ä½“ */
.app-icon {
    width: 52px; height: 52px; border-radius: 14px; 
    display: flex; align-items: center; justify-content: center;
    font-size: 26px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    position: relative; overflow: hidden;
    border: 2px solid #fff;
}
/* ç»™å›¾æ ‡åŠ é«˜å…‰ */
.app-icon::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
    pointer-events: none;
}
.app-name { 
    font-size: 11px; color: #333; margin-top: 6px; font-weight: bold; 
    text-shadow: 0 1px 1px #fff;
}

/* 5. APP å†…éƒ¨çª—å£ (å…¨å±è¦†ç›–) */
.app-window {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #f7f9fc; /* APPå†…éƒ¨æ·¡ç°èƒŒæ™¯ */
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 20; display: flex; flex-direction: column;
}
.app-window.open { transform: translateY(0); }

/* å¤´éƒ¨å¯¼èˆªæ  (ä¸¤ç«¯å¯¹é½ä¿®å¤ç‰ˆ) */
.app-header {
    height: 50px; background: rgba(255,255,255,0.95); 
    border-bottom: 1px solid #ffe6eb;
    display: flex; align-items: center; justify-content: space-between; /* ğŸ‘ˆ ä¿®å¤ï¼šä¸¤ç«¯å¯¹é½ */
    padding: 0 10px; font-weight: bold; font-size: 15px; color: #d66a80;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02); z-index: 10;
}
.app-header-btn {
    font-size: 20px; cursor: pointer; color: #ff8fa3; background:none; border:none; padding: 5px;
    min-width: 40px; /* ä¿è¯æŒ‰é’®å¥½ç‚¹ */
}

/* å†…å®¹åŒºåŸŸ */
.app-content { flex: 1; overflow-y: auto; padding: 12px; }

/* 6. å¡ç‰‡é€šç”¨æ ·å¼ (é”¦è¡£é˜/å•†åº—/å¾®èŠ/å§»ç¼˜ç°¿) */
.clothing-card, .shop-item, .partner-card, .chat-list-item {
    background: #fff; border-radius: 12px; 
    padding: 10px; margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid #fff0f5;
    transition: all 0.2s;
}
.clothing-card:hover, .shop-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }

/* é”¦è¡£é˜å›¾ç‰‡ */
.clothing-img { width: 100%; height: 100px; object-fit: contain; margin: 5px 0; }
.clothing-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* èŠå¤©æ°”æ³¡ (ç¾åŒ–ç‰ˆ) */
.phone-chat-box { background: #f2f2f2; padding: 15px; display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
.phone-msg { max-width: 78%; padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.phone-msg.left { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 4px; }
.phone-msg.right { align-self: flex-end; background: #ff9a9e; color: white; border-bottom-right-radius: 4px; }

/* æŒ‰é’®ç¾åŒ– */
.shop-btn {
    padding: 6px 12px; border-radius: 15px; font-size: 11px; border: none; 
    color: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* ç‰©å“è¯¦æƒ…å¼¹çª— */
.item-detail-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.98); z-index: 50;
    display: flex; flex-direction: column; padding: 25px; box-sizing: border-box;
    transform: translateY(100%); transition: transform 0.3s;
}
.item-detail-overlay.show { transform: translateY(0); }
.item-big-icon { font-size: 70px; text-align: center; margin: 30px 0; animation: float 3s infinite ease-in-out; }
@keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

/* ğŸ”§ å¾®ä¿¡å›¾ç‰‡ä¿®å¤è¡¥ä¸ */
.chat-list-item img {
    width: 45px !important;    /* å¼ºåˆ¶å®½åº¦ */
    height: 45px !important;   /* å¼ºåˆ¶é«˜åº¦ */
    border-radius: 8px !important;
    object-fit: cover !important; /* è£å‰ªä¸ç•™ç™½ */
    flex-shrink: 0 !important;    /* ç¦æ­¢è¢«æŒ¤å‹ */
    margin-right: 10px !important;
    display: block !important;
}

/* ä¿®å¤åˆ—è¡¨å¸ƒå±€ï¼Œé˜²æ­¢æ–‡å­—è¢«æŒ¤ä¸‹å» */
.chat-list-item {
    display: flex !important;
    align-items: center !important;
    flex-direction: row !important; /* å¼ºåˆ¶æ¨ªå‘æ’åˆ— */
}

/* ğŸ”§ å§»ç¼˜ç°¿å¤´åƒå¼ºåˆ¶ä¿®å¤è¡¥ä¸ */
.partner-avatar {
    width: 50px !important;     /* å¼ºåˆ¶é™åˆ¶å®½åº¦ */
    height: 50px !important;    /* å¼ºåˆ¶é™åˆ¶é«˜åº¦ */
    border-radius: 50% !important; /* å˜æˆåœ†å½¢ */
    object-fit: cover !important;  /* è‡ªåŠ¨è£å‰ªï¼Œé˜²æ­¢å˜å½¢ */
    flex-shrink: 0 !important;     /* ç¦æ­¢è¢«æŒ¤å‹ */
    margin-right: 10px !important; /* å’Œæ–‡å­—ä¿æŒè·ç¦» */
    border: 2px solid #ff7675 !important; /* åŠ ä¸ªç²‰è‰²è¾¹æ¡†æ›´å¥½çœ‹ */
    display: block !important;
}

/* ç¡®ä¿å¡ç‰‡å¤´éƒ¨æ¨ªå‘æ’åˆ— */
.partner-header {
    display: flex !important;
    align-items: center !important;
    flex-direction: row !important;
}

/* ================= ğŸ“ 4.0 æ–°å¢æ ·å¼ï¼šèŒä¸šä¸å®¶æ— ================= */

/* èŒä¸šå¾½ç«  */
.career-badge {
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: white; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; margin-left: 5px; font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); vertical-align: middle;
}
/* åèŒä¸šç”¨çº¢è‰² */
.career-badge.bad { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
/* çš‡æƒèŒä¸šç”¨é‡‘è‰² */
.career-badge.royal { background: linear-gradient(135deg, #ffd700, #fdb931); color: #8a6d3b; }

/* æ‹çˆ±çŠ¶æ€æ ‡ */
.love-status-tag {
    background: #ff9a9e; color: white; border-radius: 10px;
    padding: 2px 8px; font-size: 10px; margin-left: 5px;
    animation: pulse 2s infinite;
}

/* å®¶æ—åˆ—è¡¨ (æ‰‹æœºå¾®èŠé‡Œç”¨) */
.family-separator {
    font-size: 10px; color: #999; margin: 10px 0 5px 10px; font-weight: bold;
}

/* ================= ğŸ“ æ–°å¢ï¼šèŒä¸šä¸å®¶æ—å¾½ç« æ ·å¼ ================= */
.career-badge {
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: white; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; margin-left: 5px; font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); vertical-align: middle;
}
/* åèŒä¸šç”¨çº¢è‰²ï¼Œçš‡æƒç”¨é‡‘è‰² */
.career-badge.bad { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
.career-badge.royal { background: linear-gradient(135deg, #ffd700, #fdb931); color: #8a6d3b; }

/* æ‹çˆ±çŠ¶æ€ */
.love-status-tag {
    background: #ff9a9e; color: white; border-radius: 10px;
    padding: 2px 8px; font-size: 10px; margin-left: 5px;
    animation: pulse 2s infinite;
}

/* ================= â¤ï¸ æ‹çˆ±ç³»ç»Ÿ 2.0 æ ·å¼ ================= */

/* æ‹çˆ±è¿›åº¦æ¡å®¹å™¨ */
.love-progress-box {
    background: #fff0f5; padding: 10px; border-radius: 12px; margin-bottom: 10px;
    border: 1px solid #ffb7c5;
}
.love-bar-bg {
    height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 5px;
    position: relative;
}
.love-bar-fill {
    height: 100%; background: linear-gradient(90deg, #ff9a9e, #f687b3);
    transition: width 0.5s ease;
}
/* çŠ¶æ€æ–‡å­— */
.love-status-text {
    font-size: 12px; font-weight: bold; color: #d66a80; display: flex; justify-content: space-between;
}

/* æ‹çˆ±æ—¥å¿—åŒºåŸŸ */
.love-log-area {
    flex: 1; overflow-y: auto; background: #fff; border-radius: 10px;
    padding: 10px; margin-bottom: 10px; border: 1px solid #f0f0f0;
    font-size: 12px; line-height: 1.5; color: #555;
    min-height: 150px;
}
.love-log-item {
    margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee;
}
.love-log-date { color: #999; font-size: 10px; margin-bottom: 2px; }

/* è¯¦æƒ…é¡µå¤´éƒ¨ */
.partner-detail-header {
    text-align: center; padding: 15px; background: #fff;
    border-bottom: 1px dashed #eee; margin-bottom: 10px;
}
.partner-big-avatar {
    width: 70px; height: 70px; border-radius: 50%; border: 3px solid #ffb7c5;
    object-fit: cover; margin-bottom: 5px;
}

/* ================= ğŸ“ 5.0 æˆäººç¤¼ & ç»“ç®—ç•Œé¢æ ·å¼ ================= */

/* æˆäººç¤¼å…¨å±å¼¹çª— */
.adult-modal {
    background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
    border: 4px double #d4af37;
    width: 95%; max-width: 500px; height: 90vh; /* ç¨å¾®å¤§ä¸€ç‚¹ */
    display: flex; flex-direction: column; padding: 0;
    overflow: hidden; position: relative;
}

/* é¡¶éƒ¨æ ‡é¢˜ */
.adult-header {
    background: #d4af37; color: white; padding: 15px; text-align: center;
    font-size: 20px; font-weight: bold; letter-spacing: 2px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* æ ¸å¿ƒå†…å®¹åŒº */
.adult-content {
    flex: 1; overflow-y: auto; padding: 20px;
}

/* 1. èŒä¸šå±•ç¤ºå¡ */
.career-card-large {
    text-align: center; margin-bottom: 20px;
    animation: zoomIn 0.8s ease;
}
.career-icon-big { font-size: 60px; margin-bottom: 10px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
.career-title-big { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 5px; }
.career-desc { color: #888; font-size: 12px; font-style: italic; }

/* 2. å±æ€§åˆ¤å®šå¯è§†åŒ– (æ¡å½¢å¯¹æ¯”) */
.judge-box {
    background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px;
    margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.judge-title { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 10px; border-left: 3px solid #d4af37; padding-left: 8px; }
.judge-row {
    display: flex; align-items: center; margin-bottom: 8px; font-size: 12px;
}
.judge-label { width: 40px; color: #666; }
.judge-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 10px; position: relative; }
.judge-bar { height: 100%; border-radius: 4px; background: #ccc; transition: width 1s; }
.judge-bar.pass { background: #00b894; } /* è¾¾æ ‡ç»¿ */
.judge-bar.fail { background: #ff7675; } /* æœªè¾¾æ ‡çº¢ */

/* è¾¾æ ‡çº¿ (Indicator) */
.judge-line {
    position: absolute; top: -2px; bottom: -2px; width: 2px; background: #333;
    z-index: 5;
}
.judge-val { width: 50px; text-align: right; font-family: monospace; }
.pass-icon { color: #00b894; font-weight: bold; margin-left: 5px; }

/* 3. æˆå°±å¢™ */
.achievement-grid {
    display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px;
}
.ach-badge {
    background: #fff0f5; color: #d66a80; border: 1px solid #ffb7c5;
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold;
    display: flex; align-items: center; gap: 4px;
    animation: popIn 0.5s ease backwards;
}

/* 4. AI ç¦»åˆ«ä¿¡ */
.farewell-letter {
    background: #fff; padding: 15px; border-radius: 5px;
    font-family: serif; color: #555; line-height: 1.8; font-size: 14px;
    border: 1px dashed #ccc; position: relative; margin-top: 10px;
}
.farewell-letter::before { content: 'â'; font-size: 30px; color: #eee; position: absolute; top: -10px; left: 10px; }

    </style>

    <style id="custom-reader-style"></style> 
</head>
<body>

    <div id="dreamLayer" class="dream-layer">
        <div class="dream-close" onclick="stopDreamMode()">Ã— é†’æ¥</div>
        </div>
    <div id="lotteryOverlay" class="lottery-overlay">
        <div class="close-lottery" onclick="closeLottery()">Ã—</div>
        <div class="lottery-box-container" id="lotteryBox">
            <div class="magic-gift" id="magicGift">ğŸ</div>
            <div class="lottery-result-card" id="lotteryResult">
                <div class="lottery-img-wrapper"><img id="lotteryImg" src=""></div>
                <div class="lottery-name" id="lotteryName">???</div>
                <div class="lottery-hint">âœ¨ å‘½è¿é€‰æ‹©äº†å®ƒ âœ¨</div>
                <button class="go-btn" onclick="goToLotteryItem()">ğŸ‘‰ å°±æ˜¯ä½ äº†ï¼</button>
            </div>
        </div>
    </div>

    <div id="lockScreen">
        <div id="sakuraContainer"></div>

        <div id="view-landing" class="lock-card" style="display:none; text-align:center;">
            <div style="font-size:50px; margin-bottom:20px;">ğŸŒ¸</div>
            <div class="lock-title" style="font-size:28px;">æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="lock-subtitle">âœ¨ æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ âœ¨</div>
            <button class="welcome-btn btn-login-pink" style="color:white; margin-top:30px; font-size:18px;" onclick="auth.proceedFromLanding()">âœ¨ ç«‹å³ç™»å½• âœ¨</button>
        </div>

        <div id="view-welcome" class="lock-card" style="display:none;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸŒ¸</div>
            <div class="lock-title">è®¾ç½®è§£é”æ–¹å¼</div>
            <div class="lock-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            <button class="welcome-btn btn-gesture" onclick="auth.startSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="welcome-btn btn-pin" onclick="auth.startSetup('pin')">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div id="view-setup-question" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ” å®‰å…¨ä¿éšœ</div>
            <div class="lock-subtitle">ä¸‡ä¸€å¿˜äº†å¯†ç ï¼Œè¿™ä¸ªå¯ä»¥æ•‘ä½ ï¼</div>
            <div class="form-group" style="text-align:left;">
                <label>è®¾ç½®ä¸€ä¸ªå®‰å…¨é—®é¢˜</label>
                <input type="text" id="secQuestion" class="lock-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€åªå® ç‰©æ˜¯ï¼Ÿ">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>é—®é¢˜çš„ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            </div>
            <button class="welcome-btn btn-gesture" onclick="auth.saveSecurityQuestion()">å®Œæˆè®¾ç½®</button>
        </div>

        <div id="view-pin" class="lock-card" style="display:none;">
            <div class="lock-title" id="pinTitle">è¯·è¾“å…¥å¯†ç </div>
            <div class="lock-subtitle" id="pinSub">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            <div class="pin-display" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="numpad">
                <button class="num-btn" onclick="auth.inputPin(1)">1</button>
                <button class="num-btn" onclick="auth.inputPin(2)">2</button>
                <button class="num-btn" onclick="auth.inputPin(3)">3</button>
                <button class="num-btn" onclick="auth.inputPin(4)">4</button>
                <button class="num-btn" onclick="auth.inputPin(5)">5</button>
                <button class="num-btn" onclick="auth.inputPin(6)">6</button>
                <button class="num-btn" onclick="auth.inputPin(7)">7</button>
                <button class="num-btn" onclick="auth.inputPin(8)">8</button>
                <button class="num-btn" onclick="auth.inputPin(9)">9</button>
                <div></div>
                <button class="num-btn" onclick="auth.inputPin(0)">0</button>
                <button class="num-btn" style="color:#ff6b6b" onclick="auth.clearPin()">ğŸ”™</button>
            </div>
            <div class="back-link" id="pinForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
        </div>

        <div id="view-gesture" class="lock-card" style="display:none;">
            <div class="lock-title" id="gestTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <div class="lock-subtitle" id="gestSub">è¯·ç»˜åˆ¶ä½ çš„è§£é”å›¾æ¡ˆ</div>
            <div class="gesture-container" id="gestureArea">
                <div class="gesture-grid">
                    <div class="gesture-point"><div class="point-inner" data-idx="0"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="1"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="2"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="3"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="4"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="5"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="6"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="7"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="8"></div></div>
                </div>
                <canvas id="gestureCanvas" width="300" height="300"></canvas>
            </div>
            <div class="back-link" id="gestForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
            <div class="back-link" id="gestResetBtn" onclick="auth.resetGesture()" style="display:none">é‡ç»˜</div>
        </div>

        <div id="view-recovery" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ˜Ÿ å¿˜è®°å¯†ç äº†ï¼Ÿ</div>
            <div class="lock-subtitle" id="recoveryQText">å›ç­”ä½ çš„å®‰å…¨é—®é¢˜</div>
            <input type="text" id="recoveryAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            <button class="welcome-btn btn-gesture" onclick="auth.checkRecovery()">éªŒè¯</button>
            <div class="back-link" onclick="location.reload()">è¿”å›</div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div id="appContainer">
        
        <div class="privacy-toggle-btn" id="privacyBtn" onclick="togglePrivacyMode()" title="ç‚¹å‡»å¼€å¯é˜²çª¥/æ¨¡ç³Šæ¨¡å¼">
            ğŸ‘ï¸
        </div>

       <h1 onclick="triggerCopyrightEgg()">ğŸŒ¸ æˆ‘çš„ç™¾å®ç®± ğŸŒ¸</h1>

        <div class="float-widget" id="floatWidget">
                                <div class="float-menu" id="floatMenu">
    
   <div id="menuPage1" class="menu-page" style="flex:1; overflow-y:auto;">
    <div class="music-panel">
        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
        <div class="music-controls">
            <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
            <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
        </div>
        <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
        <audio id="bgMusic" loop></audio>
    </div>

    <div class="tavern-portal-panel" style="margin-top:10px; position:relative; width:100%;">
        <button id="tavernJumpBtn" style="width:100%; box-sizing: border-box; background:linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border:2px solid #fff; color:#fa8c16; padding:8px 15px; border-radius:20px; font-size:13px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(255, 169, 64, 0.2);" onclick="jumpToTavern()">
            ğŸº å¯åŠ¨é…’é¦†
        </button>
        <button style="position:absolute; right:2px; top:2px; height:calc(100% - 4px); width:35px; background:transparent; border:none; color:#fa8c16; cursor:pointer; opacity:0.6;" onclick="changeTavernLink()" title="ä¿®æ”¹é…’é¦†é“¾æ¥">âš™ï¸</button>
    </div>

    <div class="lottery-panel" style="display:flex; gap:5px; margin-top:10px;">
         <button class="lottery-btn" onclick="startLottery()" style="flex:1">ğŸ”® å‘½è¿æŠ‰æ‹©</button>
         <button class="lottery-btn" onclick="startDreamMode()" style="flex:1; background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:white;">ğŸ«§ æ¼‚æµ®æ¢¦å¢ƒ</button>
    </div>

    <div class="lottery-panel" style="display:flex; gap:5px; margin-top:5px;">
        <button class="lottery-btn" onclick="openGachaModal()" style="flex:1; background:linear-gradient(135deg, #e0f7fa 0%, #81ecec 100%); color:#00cec9;">ğŸ² çµæ„Ÿæ‰­è›‹</button>
        <button class="lottery-btn" onclick="openEchoModal()" style="flex:1; background:linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); color:white; border:none;">ğŸ“– çµé­‚å›å“</button>
    </div>
</div>



    <div id="menuPage2" class="menu-page" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:5px; border-bottom:1px dashed #eee; flex-shrink: 0;">
        <div style="font-size:12px; font-weight:bold; color:var(--accent-color);">ğŸ’¬ <span id="aiPersonaLabel">å°å¾·å­</span></div>
        <button onclick="openAISettings()" style="background:none; border:none; font-size:16px;">âš™ï¸</button>
    </div>
    
    <div id="aiChatBox" style="flex:1; overflow-y:auto; padding:10px 0; font-size:12px;">
        <div class="ai-msg-row ai">
            <div class="ai-bubble">çš‡ä¸Šå‰ç¥¥ï¼å¥´æ‰åœ¨è¿™å„¿å€™ç€å‘¢ï¼Œæ‚¨æœ‰ä»€ä¹ˆå©å’ï¼ŸğŸ™‡</div>
        </div>
    </div>

    <div style="display:flex; gap:5px; margin-top:5px; flex-shrink: 0;">
        <input type="text" id="aiInput" placeholder="ä¼ å”¤..." onkeydown="if(event.key==='Enter') sendAIMessage()" style="flex:1; border:1px solid #ddd; border-radius:15px; padding:5px 10px; font-size:12px;">
        <button onclick="sendAIMessage()" style="background:var(--accent-color); color:white; border:none; border-radius:15px; padding:5px 10px; font-size:12px;">ä¼ </button>
    </div>
</div>

    
    <div id="menuPage4" class="menu-page" style="display:none; flex:1; overflow-y:auto;">
        <style>
            .fun-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px; }
            .fun-btn { 
                background: white; border: 1px solid #ffe6eb; border-radius: 12px; padding: 10px 5px; 
                text-align: center; font-size: 12px; color: #666; cursor: pointer;
                display: flex; flex-direction: column; align-items: center; gap: 5px;
                transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            }
            .fun-btn:hover { transform: translateY(-2px); border-color: var(--accent-color); color: var(--accent-color); }
            .fun-icon { font-size: 20px; }
        </style>
        
        <div style="text-align:center; font-size:12px; color:#aaa; margin-bottom:10px;">ğŸ¡ çš‡å®¶æ¸¸ä¹åœº</div>
        
        <div class="fun-grid">
            <div class="fun-btn" onclick="openMomentsModal()"><span class="fun-icon">ğŸ“±</span>æœ‹å‹åœˆ</div>
            <div class="fun-btn" onclick="checkMailbox()"><span class="fun-icon">ğŸ“®</span>æ”¶ä¿¡ç®±</div>
            <div class="fun-btn" onclick="openTheaterModal()"><span class="fun-icon">ğŸ¬</span>å°å‰§åœº</div>
            <div class="fun-btn" onclick="generateGossipWeekly()"><span class="fun-icon">ğŸ“°</span>å…«å¦å‘¨åˆŠ</div>
            <div class="fun-btn" onclick="openBarModal()"><span class="fun-icon">ğŸ±</span>æ·±å¤œé£Ÿå ‚</div>
            <div class="fun-btn" onclick="openSoulModal()"><span class="fun-icon">ğŸ•¯ï¸</span>çµé­‚æ‹·é—®</div>
            
            <div class="fun-btn" onclick="openThroneModal()" style="background:#fffbe6; border-color:#ffeaa7;"><span class="fun-icon">âš–ï¸</span>æ‰¹æŠ˜å­</div>
            <div class="fun-btn" onclick="openFlipCardModal()" style="background:#fff0f5; border-color:#ffb7c5;"><span class="fun-icon">ğŸ®</span>ç¿»ç‰Œå­</div>
            <div class="fun-btn" onclick="openEavesdropModal()" style="background:#f0f9ff; border-color:#a2d2ff;"><span class="fun-icon">ğŸ‘‚</span>å¬å¢™è§’</div>
            <div class="fun-btn" onclick="openJealousyModal()" style="background:#fff0f0; border-color:#ffcccc;"><span class="fun-icon">ğŸ’¢</span>ä¿®ç½—åœº</div>

<div class="fun-btn" onclick="openHoroscope()" style="background:#1a1a2e; border-color:#ffd700; color:#ffd700;">
    <span class="fun-icon">ğŸŒ </span>é’¦å¤©ç›‘
</div>

        </div>
    </div>

    <div id="menuPage3" class="menu-page" style="display:none; flex:1; overflow-y:auto;">
         <div class="nav-panel" id="navPanel" style="border:none; padding:0;"></div>
    </div>

    <div class="menu-tab-bar" style="flex-shrink: 0; display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
        <button class="menu-tab active" onclick="switchMenuPage(1)">âœ¨ åŠŸèƒ½</button>
        <button class="menu-tab" onclick="switchMenuPage(2)">ğŸ¤– ä¾ä»</button> 
        <button class="menu-tab" onclick="switchMenuPage(4)">ğŸ¡ æ¸¸ä¹</button>
        <button class="menu-tab" onclick="switchMenuPage(3)">ğŸ“‘ ç›®å½•</button>
    </div>
</div>


            <div class="float-btn" id="floatBtn"></div>
        </div>

              <div class="search-container" style="display:flex; align-items:center; gap:10px;">
            <div style="position:relative; flex-grow:1;">
                <input type="text" id="mainSearchInput" class="search-input" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="renderGrid(filterItems(this.value))">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <label style="font-size:12px; color:var(--accent-color); cursor:pointer; display:flex; align-items:center; gap:4px; white-space:nowrap;">
                <input type="checkbox" id="deepSearchCheck" onchange="handleSearch()" style="width:auto;">
                æœå†…å®¹
            </label>
        </div>


        <div class="layout-bar">
            <span class="layout-label">ğŸ‘€ è§†å›¾:</span>
            <button class="layout-btn" title="é»˜è®¤ç½‘æ ¼" onclick="switchLayout('default')">ğŸ©¶</button>
            <button class="layout-btn" title="é•¿åˆ—è¡¨" onclick="switchLayout('list')">ğŸ©µ</button>
            <button class="layout-btn" title="å¤§å›¾æ¨¡å¼" onclick="switchLayout('large')">ğŸ¤</button>
            <button class="layout-btn" title="è¿·ä½ æ¨¡å¼" onclick="switchLayout('mini')">ğŸ©·</button>
            <button class="layout-btn" title="çºªå¿µå“é™ˆåˆ—å®¤" onclick="switchLayout('shelf')">ğŸ’</button>
        </div>

<div class="action-grid">
    <div class="action-card primary" onclick="openAddModal()">
        <div class="kitty-icon">ğŸ€</div>
        <div>æ·»åŠ </div>
    </div>
    
    <div class="action-card" onclick="document.getElementById('batchImgInput').click()">
        <div class="kitty-icon">ğŸ“¸</div>
        <div>æ‰¹é‡åŠ </div>
        <input type="file" id="batchImgInput" multiple style="display:none" onchange="handleBatchImageImport(this)">
    </div>

    <div class="action-card" onclick="toggleBatchDeleteMode()">
        <div class="kitty-icon">ğŸ§¹</div>
        <div>æ‰¹é‡åˆ </div>
    </div>

    <div class="action-card" onclick="exportAllData()">
        <div class="kitty-icon">ğŸ’¾</div>
        <div>å¤‡ä»½</div>
    </div>

    <div class="action-card" onclick="document.getElementById('importAllInput').click()">
        <div class="kitty-icon">ğŸ‘œ</div>
        <div>å¯¼å…¥</div>
        <input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)">
    </div>
</div>

        <div class="grid-container mode-default" id="gridContainer">
            <div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div>
        </div>

<div style="text-align: center; margin-top: 50px; padding-bottom: 20px; font-size: 10px; color: #e0e0e0; font-family: sans-serif; letter-spacing: 1px; user-select: none;">
    Â© 2025 CHANGCHUNLU. All Rights Reserved. <br> 
    Designed with â¤ï¸ for My Royal Collection.
</div>

    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            <div class="form-group"><label>ğŸ’– åå­—</label><input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—..."></div>
            <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾ (è¾“å…¥åç‚¹+å·æˆ–å›è½¦)</label><div style="display:flex; align-items:center; gap:10px;"><div class="tag-input-area" id="tagInputArea" style="flex-grow:1;" onclick="document.getElementById('tagInput').focus()"><input type="text" id="tagInput" onkeydown="handleTagInput(event)"></div><button class="small-btn primary-btn" style="height:40px; width:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0;" onclick="manualAddTag()">ï¼‹</button>
<button class="small-btn" onclick="autoGenerateTags()" style="background:#e0f7fa; color:#006064; border:none; margin-left:5px; padding:5px 10px; border-radius:15px; font-size:12px;">ğŸ§  æ™ºèƒ½åˆ†æ</button>
</div><div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                       <div class="form-group">
                <label>ğŸ’­ å°è±¡æœ€æ·±çš„è¯ (ä¸€è¡Œä¸€å¥ï¼Œä¼šé£˜åœ¨èƒŒæ™¯é‡Œå“¦)</label>
                <textarea id="itemMemories" placeholder="ä¾‹å¦‚ï¼š
ç¬¬ä¸€æ¬¡è§ä½ çš„æ—¶å€™...
é‚£å¤©æ™šä¸Šçš„æœˆäº®å¾ˆåœ†...
(æŒ‰å›è½¦æ¢è¡Œï¼Œå¯ä»¥å†™å¾ˆå¤šå¥)" style="width:100%; height:100px; padding:10px; border:2px solid var(--secondary-color); border-radius:12px; outline:none; font-family:inherit; resize:vertical; background:#fff;"></textarea>
            </div>
                     <div class="form-group">
               <label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label><div class="resource-list" id="resourceList"><div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div></div><div class="add-btn-row"><label class="upload-area small-btn" style="flex-grow:1; text-align:center;">ğŸ“‚ åŠ æ–‡ä»¶ (å›¾ç‰‡/æ–‡æ¡£/å…¶ä»–)<input type="file" multiple onchange="handleUniversalSelect(this)"></label><button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button></div><div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;"><input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;"><div style="text-align:right;"><button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button><button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button></div></div></div>

                <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

            <div class="modal-buttons"><button onclick="closeAddModal()">å–æ¶ˆ</button><button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button></div>
        </div>
    </div>

                <div class="modal-overlay" id="detailModal">
        <div class="modal" style="position: relative; max-height: 85vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;"> 
            
            <div class="memory-layer" id="memoryLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;"></div>

            <div id="bigStamp" class="big-stamp-mark"></div>

                        <div class="modal-content-wrapper" style="overflow-y: auto; flex-grow: 1; position: relative; z-index: 2; padding: 25px;">
                
                <button class="close-modal" onclick="closeDetailModal()" style="position: absolute; top: 15px; right: 15px;">Ã—</button>
                
                <div id="stickyNoteDisplay"></div> 
                <h2 id="detailName" style="text-align:center; margin-bottom:5px; margin-top: 0;"></h2>

                <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>
                
                <div class="stamp-bar">
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ¬')" title="è¶…ç”œ">ğŸ¬</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ‹')" title="åƒé†‹/é…¸æ¶©">ğŸ‹</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ”ª')" title="åˆ€å­/è™å¿ƒ">ğŸ”ª</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸš—')" title="é£™è½¦/åˆºæ¿€">ğŸš—</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ’¤')" title="æ—¥å¸¸/ç¡è§‰">ğŸ’¤</div>
                </div>
                <div id="galleryArea">
                    <div class="gallery-container">
                        <div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div>
                        <img id="detailImg" class="gallery-img" src="">
                        <div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div>
                        <div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div>
                        <button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button>
                        <button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button>
                        <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;">
                            <span id="imgIndex">1</span> / <span id="imgTotal">1</span>
                        </div>
                    </div>
                </div>
                
                <div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>
                <div class="form-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        <span>ğŸ’ çºªå¿µå“ (å›å¿†ä¿¡ç‰©)</span>
                        <button class="small-btn" onclick="openAddSouvenirModal()" style="font-size:12px;">+ æ·»åŠ ä¿¡ç‰©</button>
                    </label>
                    <div id="souvenirListArea" class="souvenir-scroll-box">
                        <div style="font-size:12px; color:#ccc; padding:10px;">è¿™é‡Œè¿˜ç©ºè¡è¡çš„...</div>
                    </div>
                </div>
                <div class="form-group"><label>ğŸ“‚ ç›’å­å†…å®¹</label><div id="detailListContainer" class="detail-list"></div></div>
                
                             <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

                <div class="control-panel-grid">
    <button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘</button>
    <button onclick="openOathModal()" style="border-color: #ffd700; color: #f39c12; background: #fffdf0;">ğŸ’ èª“çº¦</button>

    <button onclick="openScratchModal()" style="border-color: #fab1a0; color: #e17055; background: #fff5f0;">ğŸ¤« ç§˜å¯†</button>

    <button onclick="generateBriefing()" style="border-color: #a29bfe; color: #6c5ce7; background: #f3f0ff;">ğŸ“œ å‘ˆå¥æŠ˜</button>
<button onclick="manualGrantFavor()" style="border-color: #ff9ff3; color: #ff6b6b; background: #fff0f5;">ğŸ’° èµèµæ™‹å‡</button>
    <button onclick="giveGift()" style="border-color: #ff9ff3; color: #f368e0; background: #fff0f5;">ğŸ æŠ•å–‚</button>
    <button onclick="generateOOTD()" style="border-color: #54a0ff; color: #2e86de; background: #f0f8ff;">ğŸ‘— æ¢è£…</button>

    <button onclick="autoFillProfile()" style="border-color: #81ecec; color: #00cec9; background: #e0f7fa;">ğŸ§  è¡¥å…¨æ¡£æ¡ˆ</button>
    <button onclick="analyzeStoryTimeline()" style="border-color: #ffeaa7; color: #d35400; background: #fffbe6;">ğŸï¸ å‰§æƒ…å›é¡¾</button>
<button onclick="convertChatToNovel()" style="border-color: #a29bfe; color: #6c5ce7; background: #f3f0ff;">ğŸ“– è½¬å°è¯´</button>
    <button onclick="openNoteModal(-1)" style="border-color: #badc58; color: #6ab04c; background: #f6e58d;">ğŸ“Œ +è´´ä¾¿ç­¾</button>
</div>

<div style="padding: 0 5px; margin-top: 8px;">
    <button id="heirActionButton" onclick="handleHeirAction()" style="width:100%; border: 2px dashed #ff9a9e; color: #ff6b6b; background: #fff0f5; font-weight: bold; padding: 10px;">
        ğŸ‘¶ ç¥ˆç¦æ±‚å­
    </button>
</div>

<div class="danger-zone">
    <button onclick="deleteCurrentItem()" style="border: 1px solid #ffcccc; color: #ff6b6b; background: #fff0f0;">ğŸ—‘ï¸ åˆ é™¤æ­¤è§’è‰²</button>
</div>
            
            </div> 
        </div>
    </div>
               
    <div class="modal-overlay" id="readerModal" style="z-index: 5000;">
        <div class="modal reader-modal">
                       <div class="reader-header">
                <button class="close-reader" onclick="closeReader()">â†</button>
                
                <div style="text-align:center">
                    <div class="reader-title" id="readerTitle">å›å¿†è®°å½•</div>
                    <div class="reader-subtitle" id="readerCount" style="cursor:pointer" onclick="toggleBookmarkDrawer()">0 æ¡è®°å½• (ç‚¹å‡»æŸ¥çœ‹ä¹¦ç­¾)</div>
                </div>
                
                                <div style="display:flex;
gap:5px;">
                    <button class="close-reader" style="font-size:16px;" onclick="analyzeBond()" title="ç”Ÿæˆç¾ç»ŠæŠ¥å‘Š">ğŸ“Š</button> <button class="close-reader" style="font-size:16px;" onclick="toggleCssDrawer()">ğŸ¨</button>
                    <button class="close-reader" style="font-size:16px;" onclick="toggleBookmarkDrawer()">â­</button> 
                </div>

            </div>

<div class="css-drawer" id="cssDrawer">
    <div class="bookmark-header">
        <span>ğŸ¨ çš®è‚¤è®¾è®¡å¸ˆ</span>
        <span style="font-size:12px;cursor:pointer" onclick="toggleCssDrawer()">å…³é—­</span>
    </div>
    <div style="padding:15px; display:flex; flex-direction:column; height:100%;">
        <select id="themeSelect" onchange="loadSelectedTheme()" style="margin-bottom:10px; padding:5px;">
            <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>
        </select>

        <textarea id="cssInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ CSS ä»£ç ... ä¾‹å¦‚: .chat-bubble { background: pink; }" style="flex-grow:1; width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family:monospace; margin-bottom:10px; resize:none;"></textarea>

        <div style="display:flex; gap:5px;">
            <input type="text" id="themeNameInput" placeholder="ç»™ä¸»é¢˜èµ·ä¸ªå..." style="flex-grow:1; padding:5px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="saveCustomTheme()" style="background:var(--accent-color); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
            <button onclick="deleteCustomTheme()" style="background:#ffcccc; color:#ff6b6b; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">åˆ </button>
        </div>

        <button onclick="previewCss()" style="margin-top:10px; background:#e0f7fa; color:#006064; border:none; padding:8px; border-radius:5px; cursor:pointer; width:100%;">âš¡ ç«‹å³ç”Ÿæ•ˆ (é¢„è§ˆ)</button>
    </div>
</div>

            <div class="bookmark-drawer" id="bookmarkDrawer">
                <div class="bookmark-header">
                    <span>ğŸ“‘ æˆ‘çš„ä¹¦ç­¾</span>
                    <span style="font-size:12px;color:#999;cursor:pointer" onclick="toggleBookmarkDrawer()">å…³é—­</span>
                </div>
                <div class="bookmark-list" id="bookmarkList">
                    </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
            </div>

            <div class="reader-footer" id="readerFooter">
                <button class="page-btn" onclick="prevPage()">â—€ ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">1 / 1</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal" style="z-index: 6000;">
        <div class="modal" style="width: 90%; max-width: 350px;">
            <button class="close-modal" onclick="document.getElementById('reportModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ“Š æˆ‘ä»¬çš„å›å¿†æŠ¥å‘Š</h2>
            
            <div class="report-card">
                <div style="font-size:13px; color:#999; margin-bottom:10px;">è·¨è¶Šæ—¶é—´</div>
                <div style="font-size:18px; font-weight:bold; color:#555;">
                    <span id="reportDateStart"></span> ~ <span id="reportDateEnd"></span>
                </div>
                <div style="background:#fff0f5; color:var(--accent-color); display:inline-block; padding:2px 10px; border-radius:10px; font-size:12px; margin-top:5px;">
                    å…±é™ªä¼´ <span id="reportDays" style="font-size:16px; font-weight:bold;">0</span> å¤©
                </div>

                <div class="report-stat-row">
                    <div class="stat-item">
                        <h3 id="reportTotalFloors">0</h3>
                        <p>ç›–æ¥¼é«˜åº¦</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="reportTotalWords">0</h3>
                        <p>æ€»å­—æ•°</p>
                    </div>
                </div>

                <div style="text-align:left; font-size:12px; color:#666; margin-top:15px;">
                    <div>ğŸ“ è¯ç—¨å¤§æ¯”æ‹¼ (å­—æ•°å æ¯”)</div>
                    <div class="ratio-bar-container">
                        <div id="ratioUser" class="ratio-segment ratio-left" style="width:50%">æˆ‘</div>
                        <div id="ratioChar" class="ratio-segment ratio-right" style="width:50%">TA</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span id="textCountUser">æˆ‘: 0å­—</span>
                        <span id="textCountChar">TA: 0å­—</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="gachaModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="closeGachaModal()">Ã—</button>
            <h2 style="text-align:center; margin-bottom:10px;">ğŸ² å‰§æƒ…çµæ„Ÿæ‰­è›‹æœº</h2>
            
            <div class="gacha-machine">
                <div class="gacha-display" id="gachaResultArea">
                    <div style="color:#ccc; font-size:14px;">ç‚¹å‡»æŒ‰é’®ï¼Œè·å–ä»Šæ—¥æ¢—æ¦‚...</div>
                </div>
                
                <div class="gacha-controls">
                    <button class="primary-btn" onclick="spinGacha()" style="width:100%; justify-content:center; font-size:16px;">ğŸ° ç»™æˆ‘ä¸€ä¸ªè„‘æ´ï¼</button>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <span class="action-link" onclick="toggleGachaEdit()">âš™ï¸ ç¼–è¾‘é¢˜åº“</span>
                </div>

                <div class="gacha-edit-area" id="gachaEditArea">
                    <label style="font-size:12px; color:#666;">ğŸ“ åœ°ç‚¹ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editPlace" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">ğŸ“… äº‹ä»¶ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editEvent" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">âœ¨ æ°›å›´/æ¢— (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editTrope" class="gacha-textarea"></textarea>
                    
                    <button class="small-btn primary-btn" onclick="saveGachaData()" style="width:100%; margin-top:5px;">ğŸ’¾ ä¿å­˜é¢˜åº“é…ç½®</button>
                    <button class="small-btn" onclick="resetGachaData()" style="width:100%; margin-top:5px; background:#fff; color:#999; border:1px solid #ddd;">ğŸ”„ æ¢å¤é»˜è®¤é¢˜åº“</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="addSouvenirModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('addSouvenirModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">âœ¨ å°å­˜ä¸€æ®µå›å¿†</h2>
            
            <div class="form-group">
                <label>ğŸ“¸ ä¿¡ç‰©ç…§ç‰‡ (ç‚¹å‡»ä¸Šä¼ )</label>
                <div onclick="document.getElementById('souvenirImgInput').click()" 
                     style="width:100%; height:150px; background:#f9f9f9; border:2px dashed #ddd; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
                    <img id="souvenirPreview" style="max-width:100%; max-height:100%; display:none;">
                    <span id="souvenirUploadHint" style="color:#aaa;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                </div>
                <input type="file" id="souvenirImgInput" accept="image/*" onchange="previewSouvenirImg(this)">
            </div>

            <div class="form-group">
                <label>ğŸ·ï¸ åå­—</label>
                <input type="text" id="souvenirName" placeholder="ä¾‹å¦‚ï¼šé‚£å¤©çš„çƒŸç«å¤§ä¼š...">
            </div>

            <div class="form-group">
                <label>ğŸ“œ å®ƒçš„æ•…äº‹ (å›å¿†æè¿°)</label>
                <textarea id="souvenirDesc" style="width:100%; height:80px; padding:10px; border:2px solid #ffe6eb; border-radius:10px; resize:none;" placeholder="ä¸ºä»€ä¹ˆè¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦ï¼Ÿ"></textarea>
            </div>
            
            <button class="primary-btn" onclick="saveSouvenir()" style="width:100%;">ğŸ’¾ æ”¾å…¥é™ˆåˆ—å®¤</button>
        </div>
    </div>

    <div class="modal-overlay" id="viewSouvenirModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('viewSouvenirModal').classList.remove('active')">Ã—</button>
            <div class="souvenir-view-content">
                <h2 id="viewSovTitle" style="color:var(--accent-color); margin-bottom:10px;"></h2>
                <img id="viewSovImg" class="souvenir-view-img">
                <div id="viewSovDesc" class="souvenir-view-story"></div>
                
                <div style="font-size:12px; color:#aaa; margin-top:20px;">
                    å±äº: <span id="viewSovOwner"></span>
                </div>
                <button class="small-btn" onclick="deleteCurrentSouvenir()" style="background:#fff; color:#ff6b6b; border:1px solid #ffcccc; margin-top:10px;">ğŸ—‘ï¸ ä¸¢å¼ƒ</button>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="echoModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('echoModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">ğŸ“– å¬å¬TAæ€ä¹ˆè¯´</h2>
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜ (æ˜¯/å¦)ï¼Œç„¶åç‚¹å‡»è†å¬</div>

            <div class="echo-card">
                <div style="margin-bottom:15px;">
                    <select id="echoCharSelect" onchange="updateEchoAvatar()" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                        <option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>
                    </select>
                </div>

                <img id="echoAvatarDisplay" src="" style="display:none;" class="echo-avatar">
                
                <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">TAçš„æ€§æ ¼:</label>
                    <select id="echoArchetypeSelect" style="padding:5px; border-radius:5px; border:1px solid #ffb7c5; font-size:12px;">
                        </select>
                </div>

                <div class="echo-result-box" id="echoResultText">
                    ...
                </div>

                <button class="primary-btn" onclick="askEcho()" style="width:100%; font-size:16px;">ğŸ”® è†å¬å›å“</button>
                
                <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <span class="action-link" onclick="toggleEchoEdit()" style="background:#f0f0f0; color:#888;">âœï¸ ç¼–å†™/ä¿®æ”¹æ€§æ ¼åº“</span>
                </div>
                
                <div id="echoEditArea" style="display:none; margin-top:10px; text-align:left;">
                    <label style="font-size:12px;">é€‰ä¸­ä¸Šæ–¹çš„æ€§æ ¼ï¼Œç„¶ååœ¨è¿™é‡Œä¿®æ”¹ (ä¸€è¡Œä¸€å¥):</label>
                    <textarea id="echoEditText" style="width:100%; height:100px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px; resize:none;" onchange="saveCurrentEchoLib()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="oathModal" style="z-index: 8000;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="oath-paper" id="oathPaper">
                <button class="close-modal" onclick="document.getElementById('oathModal').classList.remove('active')" style="color:#bdc3c7; top:10px; right:10px;">Ã—</button>
                
                <div class="oath-border"></div>
                
                <div class="oath-header">âœ¨ æ°¸æ’èª“çº¦ âœ¨</div>
                
                <div class="oath-content">
                    <img id="oathAvatar" class="oath-avatar" src="">
                    <div style="margin: 15px 0; font-size: 14px; color: #555; line-height: 1.8;">
                        è‡ªä»Šæ—¥ <span id="oathDate" style="border-bottom: 1px solid #aaa; padding: 0 5px; font-weight: bold;"></span> èµ·<br>
                        æˆ‘æ„¿ä¸ <span id="oathCharName" style="color:var(--accent-color); font-weight:bold; font-size:16px;"></span> ç¼”ç»“ç¾ç»Šã€‚<br>
                        æ— è®ºæ•°æ®æ´ªæµå¦‚ä½•å†²åˆ·ï¼Œ<br>
                        è¿™ä»½è®°å¿†å°†æ°¸ä¸è¤ªè‰²ã€‚
                    </div>
                </div>

                <div class="oath-footer">
                    <div class="oath-sign-box">
                        <span>User:</span>
                        <div class="sign-line">æˆ‘ (Me)</div>
                    </div>
                    <div class="oath-sign-box">
                        <span>Partner:</span>
                        <div class="sign-line" id="oathSignName">???</div>
                    </div>
                </div>

                <div class="oath-action-area">
                    <div id="oathSealBtn" class="oath-seal-btn" onclick="signTheOath()">
                        ğŸ–ï¸ æŒ‰æ‰‹å°
                    </div>
                    <div id="oathStamp" class="oath-stamp-mark">
                        <div style="font-size: 50px;">ğŸ’‹</div>
                        <div style="font-size: 10px; transform: rotate(-5deg); border: 2px solid #d63031; padding: 2px 5px; border-radius: 4px; color: #d63031; display: inline-block; margin-top: -10px;">LOVED</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<div class="modal-overlay" id="scratchModal" style="z-index: 8500;">
        <div class="modal" style="width: 300px; padding: 20px; background: #fff0f5; border: 4px solid white; border-radius: 20px; text-align: center;">
            <button class="close-modal" onclick="closeScratchModal()">Ã—</button>
            
            <h2 style="color: #d66a80; margin-bottom: 5px;">ğŸ¤« éšè—çš„ç§˜å¯†</h2>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 15px;">æ¥è‡ªèŠå¤©è®°å½•çš„éšæœºå›å¿†...</div>

            <div class="scratch-container" id="scratchContainer">
                <div class="scratch-text-layer">
                    <div id="scratchSecretText">...</div>
                </div>
                <canvas id="scratchCanvas"></canvas>
                
                <div id="scratchCover" class="scratch-cover-overlay">
                    <div style="font-size: 40px;">ğŸ«£</div>
                    <div style="font-weight: bold; color: #fff; margin-top: 10px;">è¦å·çœ‹TAçš„å¿ƒé‡Œè¯å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="scratch-actions" id="scratchBtnArea">
                <button class="small-btn" onclick="closeScratchModal()" style="background: #eee; color: #999;">ğŸ«£ ç®—äº†ä¸æ•¢çœ‹</button>
                <button class="primary-btn" onclick="startScratching()" style="background: #ff8fa3; border: none;">ğŸ–ï¸ æˆ‘è¦åˆ®ï¼</button>
            </div>
            
            <div id="scratchHint" style="display:none; font-size:12px; color:#d66a80; margin-top:10px;">
                âœ¨ å¿«ç”¨æ‰‹æŒ‡/é¼ æ ‡æ¶‚æŠ¹ä¸Šæ–¹åŒºåŸŸ âœ¨
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="noteModal" style="z-index: 8800;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="sticky-note-paper">
                <button class="close-modal" onclick="closeNoteModal()" style="color: #bfa588; top: 5px; right: 5px;">Ã—</button>
                
                <div style="text-align: center; color: #bfa588; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    ğŸ“Œ è§’è‰²å¤‡æ³¨ & éšæ‰‹è®°
                </div>

                <div class="note-toolbar">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">é¢œè‰²:</span>
                        <input type="color" id="noteColorPicker" value="#555555" onchange="previewNoteStyle()">
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">å¤§å°:</span>
                        <input type="range" id="noteSizeSlider" min="12" max="30" value="14" style="width: 60px;" oninput="previewNoteStyle()">
                    </div>
                </div>

                <textarea id="noteTextarea" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å…³äºTAçš„å¤‡æ³¨...&#10;æ¯”å¦‚ï¼šç”Ÿæ—¥æ˜¯XæœˆXæ—¥&#10;æˆ–è€…ï¼šä»Šå¤©TAè¶…çº§å¯çˆ±ï¼"></textarea>

                <button class="small-btn" onclick="saveNote()" style="width: 100%; margin-top: 10px; background: #fff; border: 1px dashed #bfa588; color: #bfa588;">ğŸ’¾ è´´ä¸Šå»</button>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="aiSettingsModal" style="z-index: 9999;">
        <div class="modal" style="width: 280px;">
            <button class="close-modal" onclick="document.getElementById('aiSettingsModal').classList.remove('active')">Ã—</button>
            <h3 style="text-align:center; color:var(--accent-color); margin-bottom:15px;">ğŸ§  è°ƒæ•™ä½ çš„ä¾ä»</h3>
            
            <div class="form-group">
                <label>ğŸ­ é€‰æ‹©äººè®¾</label>
                <select id="aiPersonaSelect" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                    <option value="eunuch">ğŸ™‡ å°å¾·å­ (å‘å¾®å¤ªç›‘)</option>
                    <option value="maid">ğŸ± å–µå–µå¥³ä»† (å¯çˆ±çŒ«å¨˜)</option>
                    <option value="butler">ğŸ§ æ¯’èˆŒç®¡å®¶ (é˜´é˜³æ€ªæ°”)</option>
                    <option value="yandere">ğŸ”ª ç—…å¨‡å¦¹å¦¹ (ç‹¬å æ¬²)</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šä¹‰äººè®¾</option>
                </select>
            </div>

            <div id="customPersonaArea" class="form-group" style="display:none;">
                <label>ğŸ“ è‡ªå®šä¹‰æç¤ºè¯ (System Prompt)</label>
                <textarea id="aiCustomPrompt" style="width:100%; height:60px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px;"></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ”— API åœ°å€ (åä»£é“¾æ¥)</label>
                <input type="text" id="aiApiUrl" placeholder="ä¾‹å¦‚: https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>

            <div class="form-group">
                <label>ğŸ”‘ API Key</label>
                <input type="password" id="aiApiKey" placeholder="sk-...">
            </div>

                      <div class="form-group">
                <label>ğŸ§  æ¨¡å‹é€‰æ‹©</label>
                <div style="display:flex; gap:5px;">
                    <select id="aiModelSelect" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd; background:white;">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (é»˜è®¤)</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="claude-3-5-sonnet-20240620">claude-3.5-sonnet</option>
                    </select>
                    <button onclick="fetchModelList()" style="background:#fff0f5; border:1px solid #ffb7c5; border-radius:10px; padding:0 12px; cursor:pointer; color:#d66a80;" title="ç‚¹å‡»æ‹‰å–æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
                </div>
                
                <input type="text" id="aiModelManual" placeholder="æ‰¾ä¸åˆ°ï¼Ÿç‚¹è¿™é‡Œæ‰‹åŠ¨è¾“å…¥..." style="width:100%; margin-top:5px; font-size:12px; border:1px solid #ddd; border-radius:8px; padding:5px; display:none;">
                <div style="font-size:10px; color:#aaa; text-align:right; margin-top:2px; cursor:pointer;" onclick="toggleManualInput()">æ‰¾ä¸åˆ°æ¨¡å‹? æ‰‹åŠ¨è¾“å…¥</div>
            </div>

            <button class="primary-btn" onclick="saveAISettings()" style="width:100%;">ğŸ’¾ ä¿å­˜è®¾å®š</button>
        </div>
    </div>

    <div class="modal-overlay" id="theaterModal" style="z-index: 9500;">
        <div class="modal" style="width: 320px;">
            <button class="close-modal" onclick="document.getElementById('theaterModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ¬ è·¨æ—¶ç©ºå‰§åœº</h2>
            
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">
                é€‰ä¸¤ä¸ªè§’è‰²ï¼Œè®© AI å¯¼æ¼”ä¸€åœºæˆ...
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <select id="theaterCharA" style="flex:1; padding:5px; border-radius:10px;"></select>
                <span style="font-weight:bold; color:#ffb7c5;">VS</span>
                <select id="theaterCharB" style="flex:1; padding:5px; border-radius:10px;"></select>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>ğŸ­ å‰§æœ¬æƒ…å¢ƒ (å¯é€‰)</label>
                <input type="text" id="theaterTopic" placeholder="ä¾‹å¦‚ï¼šäº‰é£åƒé†‹ã€è’å²›æ±‚ç”Ÿã€äº’ç›¸å¹æ§...">
            </div>

            <button class="primary-btn" onclick="startTheater()" style="width:100%; margin-top:10px;">ğŸ¥ Action! (å¼€å§‹æ¼”å‡º)</button>
        </div>
    </div>

    <div class="modal-overlay" id="letterModal" style="z-index: 9600;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            <div class="letter-paper">
                <button class="close-modal" onclick="document.getElementById('letterModal').classList.remove('active')" style="color:#555;">Ã—</button>
                <div class="letter-stamp">é‚®æˆ³</div>
                <div class="letter-content" id="letterText">
                    æ­£åœ¨æ‹†ä¿¡...
                </div>
                <div class="letter-signature" id="letterSign">???</div>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="momentsModal" style="z-index: 9600;">
    <div class="modal" style="width: 350px; height: 80vh; padding: 0; display: flex; flex-direction: column; background: #f2f2f2;">
        
        <div style="background: rgba(255,255,255,0.95); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0;">
            <span style="font-weight: bold; font-size: 16px;">æœ‹å‹åœˆ</span>
            <button class="close-modal" onclick="closeMomentsModal()" style="position: static; color: #333; font-size: 24px; width: auto; height: auto; background: none;">Ã—</button>
        </div>

        <div id="momentsFeed" style="flex: 1; overflow-y: auto; padding: 15px;">
            <div style="text-align: center; color: #999; margin-top: 50px; font-size: 13px;">
                å¿«å‘ä¸€æ¡åŠ¨æ€ï¼Œ<br>çœ‹çœ‹è°ä¼šç§’å›ä½ ï¼Ÿâœ¨
            </div>
        </div>

        <div style="background: white; padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; align-items: flex-end;">
            <textarea id="momentInput" placeholder="åˆ†äº«æ­¤åˆ»çš„å¿ƒæƒ…..." style="flex: 1; border: none; background: #f5f5f5; padding: 10px; border-radius: 8px; resize: none; height: 40px; font-family: inherit; transition: height 0.2s;" onfocus="this.style.height='80px'" onblur="if(!this.value)this.style.height='40px'"></textarea>
            <button id="momentSendBtn" class="primary-btn" onclick="postMoment()" style="border-radius: 8px; padding: 0 15px; height: 40px; display: flex; align-items: center; justify-content: center;">å‘å¸ƒ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="gossipModal" style="z-index: 9700;">
    <div class="modal" style="width: 360px; height: 80vh; background: #f4f1ea; padding: 0; display: flex; flex-direction: column; border: 1px solid #dcdcdc;">
        <div style="padding: 20px; text-align: center; border-bottom: 2px double #333; margin: 10px;">
            <div style="font-family: 'Times New Roman', serif; font-size: 28px; font-weight: bold; color: #333; letter-spacing: 2px;">ç™¾å®ç®±å‘¨åˆŠ</div>
            <div style="font-size: 10px; color: #666; margin-top: 5px; text-transform: uppercase;">The Treasure Weekly Â· ç‹¬å®¶çˆ†æ–™ Â· ç»æ— è™šè¨€</div>
        </div>
        
        <div id="gossipPaper" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px;">
            <div style="text-align:center; padding-top:50px; color:#888;">
                æ­£åœ¨æ½œå…¥åå°å·å¬æ•°æ®...<br>ç¼–è¾‘éƒ¨æ­£åœ¨ç–¯ç‹‚èµ¶ç¨¿ä¸­...âœï¸
            </div>
        </div>

        <div style="text-align: center; padding: 15px;">
            <button class="close-modal" onclick="document.getElementById('gossipModal').classList.remove('active')" style="position: static; width: 100%; border: 1px solid #333; color: #333; background: transparent; border-radius: 0;">é˜…æ¯•ï¼Œé€€ä¸‹</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="barModal" style="z-index: 9700;">
    <div class="modal" style="width: 340px; background: #2c3e50; color: #ecf0f1; border-radius: 15px; border: 2px solid #34495e;">
        <button class="close-modal" onclick="document.getElementById('barModal').classList.remove('active')" style="color: #ecf0f1;">Ã—</button>
        
        <h2 style="text-align: center; font-family: serif; color: #f1c40f; margin-bottom: 5px;">ğŸŒ™ æ·±å¤œé£Ÿå ‚</h2>
        <div style="text-align: center; font-size: 12px; color: #bdc3c7; margin-bottom: 20px;">è´©å–æ¸©æŸ”ï¼Œæ¦‚ä¸èµŠè´¦</div>

        <div class="form-group">
            <label style="color: #bdc3c7;">1. ä½ ç°åœ¨çš„å¿ƒæƒ…æ˜¯ï¼Ÿ</label>
            <input type="text" id="barMood" placeholder="ä¾‹å¦‚ï¼šåŠ ç­å¥½ç´¯ã€å¤±æ‹äº†ã€æƒ³æ‰¾äººåµæ¶..." style="background: #34495e; border: none; color: white;">
        </div>

        <div class="form-group">
            <label style="color: #bdc3c7;">2. æŒ‡åå“ªä½å¤§å¨ï¼Ÿ</label>
            <select id="barChefSelect" style="background: #34495e; border: none; color: white;">
                </select>
        </div>

        <button class="primary-btn" onclick="orderFood()" style="width: 100%; background: #f1c40f; color: #2c3e50; font-weight: bold; margin-top: 10px;">ğŸ›ï¸ å®ï¼ä¸Šèœ</button>
        
        <div id="barResult" style="margin-top: 20px; display: none; animation: fadeIn 0.5s;">
            <div style="background: #34495e; padding: 15px; border-radius: 10px; border-left: 4px solid #f1c40f;">
                <div id="barDishName" style="font-size: 18px; font-weight: bold; color: #f1c40f; margin-bottom: 8px;"></div>
                <div id="barDishDesc" style="font-size: 13px; color: #ecf0f1; line-height: 1.6; font-style: italic;"></div>
                <div id="barChefTalk" style="margin-top: 15px; font-size: 14px; border-top: 1px dashed #7f8c8d; padding-top: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="soulModal" style="z-index: 9900;">
    <div class="modal" style="width: 320px; background: #2b2b2b; color: #eee; border: 1px solid #444; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
        
        <div style="position: relative; height: 200px; background: radial-gradient(circle at center, #444 0%, #2b2b2b 70%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <button class="close-modal" onclick="closeSoulModal()" style="color: #666; top: 10px; right: 10px;">Ã—</button>
            
            <div id="soulAvatarContainer" style="position: relative;">
                <img id="soulAvatar" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); object-fit: cover; box-shadow: 0 0 20px rgba(255,255,255,0.1);">
                <div id="soulPulse" class="soul-pulse"></div>
            </div>
            
            <div id="soulCharName" style="position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 14px; font-weight: bold; text-shadow: 0 2px 4px black; letter-spacing: 2px;">???</div>
        </div>

        <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <div id="soulQuestion" style="font-size: 15px; line-height: 1.6; color: #fff; margin-bottom: 20px; font-family: serif;">
                æ­£åœ¨è¯»å–ä½ çš„è®°å¿†...<br><span style="font-size:12px;color:#666;">(å‡†å¤‡å¥½é¢å¯¹çœŸå¿ƒäº†å—ï¼Ÿ)</span>
            </div>
            
            <div id="soulAnswerArea" style="width: 100%; display: none;">
                <input type="text" id="soulInput" placeholder="åœ¨æ­¤å†™ä¸‹ä½ çš„å›ç­”..." style="width: 100%; padding: 10px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; text-align: center; outline: none; margin-bottom: 10px;">
                <button class="primary-btn" onclick="submitSoulAnswer()" style="width: 100%; background: #eee; color: #222; border: none;">âœ‰ï¸ äº¤ä»˜çœŸå¿ƒ</button>
            </div>

            <button id="soulNextBtn" onclick="initSoulSession()" style="display:none; background:transparent; border:1px solid #666; color:#999; padding:5px 15px; border-radius:20px; font-size:12px; margin-top:20px;">æ¢ä¸€ä¸ªäººé—®</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="throneModal" style="z-index: 9800;">
    <div class="modal" style="width: 320px; background: #fffcf5; border: 4px double #d4af37;">
        <button class="close-modal" onclick="document.getElementById('throneModal').classList.remove('active')">Ã—</button>
        <h3 style="text-align:center; color:#d4af37; font-family: serif;">ğŸ“œ å¾¡ä¹¦æˆ¿ Â· æ‰¹çº¢</h3>
        <div id="throneContent" style="margin: 20px 0; min-height: 100px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 5px; font-size: 14px; line-height: 1.6;">
            æ­£åœ¨å‘ˆé€’å¥æŠ˜...
        </div>
        <div id="throneAction" style="display:none; justify-content:space-around;">
            <button onclick="handleThrone('approve')" style="background:#ff6b6b; color:white; border:none; padding:10px 20px; border-radius:50px;">ğŸ”´ å‡†å¥</button>
            <button onclick="handleThrone('reject')" style="background:#333; color:white; border:none; padding:10px 20px; border-radius:50px;">âš« é©³å›</button>
        </div>
        <div id="throneResult" style="margin-top:15px; text-align:center; color:#888; font-style:italic;"></div>
    </div>
</div>

<div class="modal-overlay" id="flipModal" style="z-index: 9800;">
    <div class="modal" style="width: 340px; background: #2c0000; color: #ffd700; border: 2px solid #ffd700;">
        <button class="close-modal" onclick="document.getElementById('flipModal').classList.remove('active')" style="color:white;">Ã—</button>
        <h3 style="text-align:center; margin-bottom:20px;">ğŸ® æ•¬äº‹æˆ¿ Â· ç¿»ç‰Œå­</h3>
        <div id="flipCardsArea" style="display:flex; justify-content:space-around; gap:5px;">
            </div>
        <div id="flipResult" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; display:none; font-size:13px; line-height:1.6;"></div>
    </div>
</div>

<div class="modal-overlay" id="eavesdropModal" style="z-index: 9800;">
    <div class="modal" style="width: 320px; background: #1a1a2e; color: #e0e0e0;">
        <button class="close-modal" onclick="document.getElementById('eavesdropModal').classList.remove('active')" style="color:white;">Ã—</button>
        <h3 style="text-align:center; color:#a29bfe;">ğŸ‘‚ æš—å«å¯†æŠ¥</h3>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">æˆªè·äº†ä¸€æ®µåå®«ç§è¯­...</div>
        <div id="eavesdropContent" style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; font-family:monospace; margin-bottom:15px;">
            æ­£åœ¨ç ´è¯‘...
        </div>
        <button class="primary-btn" onclick="startEavesdrop()" style="width:100%;">ğŸ•µï¸ å†æ¢å†æŠ¥</button>
    </div>
</div>

<div class="modal-overlay" id="jealousyModal" style="z-index: 9800;">
    <div class="modal" style="width: 340px; background: #fff0f5; border: 2px solid #ffb7c5;">
        <button class="close-modal" onclick="document.getElementById('jealousyModal').classList.remove('active')">Ã—</button>
        <h3 style="text-align:center; color:#ff6b81;">ğŸ’¢ åå®«ä¿®ç½—åœº</h3>
        <div style="text-align:center; margin-bottom:10px; font-size:12px; color:#888;">å“ªä¸¤ä¸ªç”·äººåœ¨ä¸ºä½ äº‰é£åƒé†‹ï¼Ÿ</div>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <select id="jealousCharA" style="flex:1; padding:5px;"></select>
            <span style="align-self:center;">VS</span>
            <select id="jealousCharB" style="flex:1; padding:5px;"></select>
        </div>
        <button class="primary-btn" onclick="startJealousy()" style="width:100%; background:#ff6b81; border:none;">ğŸ”¥ æ‰“èµ·æ¥ï¼</button>
        <div id="jealousyResult" style="margin-top:15px; padding:10px; background:white; border-radius:10px; border:1px dashed #ffb7c5; min-height:100px; display:none;"></div>
    </div>
</div>

<div class="modal-overlay" id="novelModal" style="z-index: 10000;">
    <div class="modal" style="width: 90%; max-width: 600px; height: 80vh; background: #fffaf0; display: flex; flex-direction: column; padding: 0; border: 1px solid #e0d0b0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        
        <div style="padding: 15px; border-bottom: 1px dashed #d4c4a8; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.5);">
            <span style="font-weight: bold; font-family: serif; font-size: 18px; color: #5d4037;">ğŸ“– å¾¡è§ˆå°è¯´</span>
            <div style="display: flex; gap: 10px;">
                <button onclick="downloadCurrentNovel()" class="small-btn" style="background: #fff; border: 1px solid #8d6e63; color: #5d4037;">â¬‡ï¸ ä¸‹è½½å¸¦èµ°</button>
                <button onclick="document.getElementById('novelModal').classList.remove('active')" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #8d6e63;">Ã—</button>
            </div>
        </div>

        <div id="novelContent" style="flex: 1; overflow-y: auto; padding: 30px; font-family: 'Georgia', 'Songti SC', serif; line-height: 1.8; color: #3e2723; font-size: 16px; white-space: pre-wrap; text-align: justify;">
            æ­£åœ¨ç¿»é˜…...
        </div>
        
        <div style="padding: 10px; text-align: center; font-size: 12px; color: #a1887f; background: rgba(255,255,255,0.5);">
            âœ… æ­¤æ–‡å·²è‡ªåŠ¨å½’æ¡£è‡³è¯¥è§’è‰²çš„ã€ç›’å­å†…å®¹ã€‘ä¸­
        </div>
    </div>
</div>

<div class="modal-overlay" id="horoscopeModal" style="z-index: 9900;">
    <div class="modal" style="width: 320px; text-align: center;">
        <button class="close-modal" onclick="document.getElementById('horoscopeModal').classList.remove('active')" style="color: #fff;">Ã—</button>
        <h3 style="color: #ffd700; font-family: serif; margin-bottom: 5px;">ğŸŒ  é’¦å¤©ç›‘ Â· ä»Šæ—¥æ˜Ÿè±¡</h3>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 20px;" id="horoscopeDate"></div>
        
        <div id="horoscopeContent">
            <div class="ai-loading" style="color:#fff;">ğŸ”® å›½å¸ˆæ­£åœ¨å¤œè§‚å¤©è±¡...</div>
        </div>
        
        <button onclick="document.getElementById('horoscopeModal').classList.remove('active')" class="primary-btn" style="margin-top:20px; background:#ffd700; color:#000; border:none; width:100%;">æœ•çŸ¥é“äº†</button>
    </div>
</div>

<div class="modal-overlay" id="heirCreationModal" style="z-index: 10000;">
    <div class="modal" style="width: 300px; text-align: center; border: 3px solid #ffb7c5;">
        <h3 style="color:#ff6b81;">ğŸ‘¶ ç¥ˆç¦æ±‚å­</h3>
        <p style="font-size:12px; color:#888; margin: 10px 0;">æ‚¨ä¸ <b id="creationFatherName"></b> çš„ç¾ç»Šå·²æ·±ã€‚<br>è¯·é™›ä¸‹è®¸æ„¿ï¼Œå¸Œæœ›è¿™ä¸ªå­©å­æœªæ¥æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ</p>
        <textarea id="creationSettingInput" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›ä»–åƒçˆ¶äº²ä¸€æ ·å‚²å¨‡ï¼Œä½†æ–‡æ­¦åŒå…¨ï¼Œå°†æ¥èƒ½åšä¸ªè´¤ç‹..."></textarea>
        <button onclick="confirmCreateHeir()" class="primary-btn" style="width:100%; background:#ff6b81; border:none;">è¯šå¿ƒç¥ˆæ„¿ âœ¨</button>
    </div>
</div>

<div class="modal-overlay" id="eastPalaceModal" style="z-index: 10000;">
    <div class="modal">
        <button class="close-modal" onclick="closeEastPalace()" style="color:#d4af37; z-index:10;">Ã—</button>
        
        <div class="heir-portrait-stage stage-baby" id="heirStageBg">
            <div class="heir-avatar" id="heirAvatarIcon">ğŸ‘¶</div>
        </div>

        <div class="heir-info-panel">
            <div class="heir-name-title">
                <span id="heirTitle">çš‡é•¿å­</span> Â· <span id="heirName">é“è›‹</span>
                <span style="font-size:12px; font-weight:normal; margin-left:5px;">(<span id="heirAgeDisplay">0å²</span>)</span>
            </div>
            <div class="stat-grid">
                <div>æ™ºæ…§ <div class="stat-bar-bg"><div class="stat-bar-fill fill-wisdom" id="statWisdom" style="width:10%"></div></div></div>
                <div>ä½“é­„ <div class="stat-bar-bg"><div class="stat-bar-fill fill-fitness" id="statFitness" style="width:10%"></div></div></div>
                <div>é­…åŠ› <div class="stat-bar-bg"><div class="stat-bar-fill fill-charm" id="statCharm" style="width:10%"></div></div></div>
                <div>çˆ¶å› <span style="float:right; font-weight:bold;" id="heirFatherDisplay">æŸæŸ</span></div>
            </div>
        </div>

        <div class="heir-bio-box" id="heirBioText">
            â³ æ­£åœ¨è¯»å–ä¸œå®«èµ·å±…æ³¨...
        </div>

        <div class="heir-actions" id="heirActionBtns">
            <button class="heir-btn" onclick="interactHeir('educate')">ğŸ“– æ•™å¯¼å­¦ä¸š</button>
            <button class="heir-btn" onclick="interactHeir('play')">ğŸª é™ªä¼´æ¸¸ç©</button>
            <button class="heir-btn" onclick="interactHeir('scold')">ğŸ˜  ä¸¥å‰è®­è¯«</button>
        </div>
        <div class="heir-actions" id="heirGraduateBtnArea" style="display:none; border-top:none; padding-top:0;">
             <button class="heir-btn graduate" style="grid-column: span 3;" onclick="graduateHeir()">ğŸ“ èµåºœæˆå®¶ (å­˜æ¡£å¹¶è„±ç¦»)</button>
        </div>

    </div>
</div>

<div class="modal-overlay" id="travelModal" style="z-index: 12000;">
    <div class="modal">
        <div class="travel-header">
            <div>
                <span style="background:#d4af37; color:#000; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:8px;" id="travelSeasonTag">æ˜¥</span>
                <span id="travelMapName">åœ°å›¾</span>
            </div>
            <div>
                <button onclick="changeSeason()" style="font-size:12px; padding:4px 8px; background:#555; color:#fff; border:none; cursor:pointer; border-radius:4px;">ğŸŒ¸ æ¢å­£</button>
                <button onclick="document.getElementById('travelModal').classList.remove('active')" style="color:#fff; border:none; background:none; font-size:24px; cursor:pointer; margin-left:10px;">Ã—</button>
            </div>
        </div>
        
        <div class="travel-body">
            <div class="travel-sidebar" id="locationList">
                </div>

            <div class="travel-map-view">
                <img id="travelBgImg" class="travel-bg" src="">
                
                <div class="travel-event-box" id="travelEventResult">
                    <h3 style="color:#d4af37; margin-bottom:10px;">ğŸ“œ æ¸¸å†å¥‡é‡</h3>
                    <div id="travelEventText" style="font-size:14px; line-height:1.6; text-align:left; min-height:60px; margin-bottom:15px;"></div>
                    <button onclick="closeTravelEvent()" style="padding:8px 30px; background:#d4af37; border:none; color:white; border-radius:20px; font-weight:bold; cursor:pointer;">æœ•çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <div id="deleteBar" class="delete-bar">
        <button class="delete-btn-cancel" onclick="toggleBatchDeleteMode()">å–æ¶ˆ</button>
        <button class="delete-btn-confirm" onclick="confirmBatchDelete()">ğŸ—‘ï¸ åˆ é™¤ (<span id="deleteCount">0</span>)</button>
    </div>

    <script>

// ================= ğŸ›¡ï¸ ä¼ å›½ç‰çº (æ§åˆ¶å°ç‰ˆæƒå£°æ˜) =================
console.log(
    "%cğŸ›‘ è­¦å‘Šï¼%c\nè¿™æ˜¯ã€é•¿æ˜¥è·¯å¥³çš‡ã€‘çš„çš‡å®¶ç§äº§ï¼\nç¦æ­¢æŠ„è¢­ã€ç›—ç”¨æˆ–æœªç»å…è®¸çš„äºŒæ”¹ã€‚\nOriginal Design by Empress Changchunlu.", 
    "color: red; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 0px black;",
    "color: #d66a80; font-size: 16px; font-weight: bold;"
);
console.log("%cğŸ‘‘ ä¾µæƒå¿…ç©¶ ğŸ‘‘", "background: #ffb7c5; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px;");

// ================= âœ… æ”¾åœ¨ <script> çš„ç¬¬ä¸€è¡Œ =================
// å®šä¹‰å…¨å±€å˜é‡ï¼Œé˜²æ­¢ä¸‹é¢çš„å‡½æ•°æ‰¾ä¸åˆ°å®ƒ
var aiConfig = JSON.parse(localStorage.getItem('my_ai_config')) || {
    persona: 'eunuch',
    customPrompt: '',
    apiUrl: 'https://api.openai.com/v1',
    apiKey: '',
    model: 'gpt-3.5-turbo'
};

        // ================= ğŸ”’ å®‰å…¨ç³»ç»Ÿ (AuthSystem) =================
        const auth = {
            mode: 'login', type: null, step: 0, tempSecret: null, inputBuffer: '', failCount: 0,
            
            init: function() {
                this.createSakura();
                this.showView('view-landing');
            },

            proceedFromLanding: function() {
                const savedType = localStorage.getItem('magic_auth_type');
                const savedSecret = localStorage.getItem('magic_auth_secret');
                if (!savedType || !savedSecret) { this.showView('view-welcome'); } 
                else {
                    this.mode = 'login';
                    this.type = savedType;
                    if (this.type === 'pin') this.showView('view-pin'); else this.showView('view-gesture');
                    if (this.type === 'gesture') setTimeout(() => this.initGesture(), 100);
                }
            },

            createSakura: function() {
                const container = document.getElementById('sakuraContainer');
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    el.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(el);
                }
            },
            showView: function(id) {
                ['view-landing', 'view-welcome', 'view-pin', 'view-gesture', 'view-setup-question', 'view-recovery'].forEach(v => {
                    const el = document.getElementById(v); if(el) el.style.display = 'none';
                });
                document.getElementById(id).style.display = 'block';
                if(id === 'view-pin') this.updatePinDots();
            },
            toast: function(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            },
            startSetup: function(type) {
                this.mode = 'setup';
                this.type = type; this.step = 1; this.inputBuffer = '';
                if (type === 'pin') {
                    document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                    document.getElementById('pinSub').textContent = 'è¯·è¾“å…¥4ä½æ–°å¯†ç '; this.showView('view-pin');
                } else {
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ'; this.showView('view-gesture'); setTimeout(() => this.initGesture(), 100);
                }
            },
            inputPin: function(num) {
                if (this.inputBuffer.length < 4) {
                    this.inputBuffer += num;
                    this.updatePinDots();
                    if (this.inputBuffer.length === 4) setTimeout(() => this.submitPin(), 200);
                }
            },
            clearPin: function() { this.inputBuffer = ''; this.updatePinDots(); },
            updatePinDots: function() { const dots = document.getElementById('pinDots').children;
                for(let i=0; i<4; i++) { if(i < this.inputBuffer.length) dots[i].classList.add('active'); else dots[i].classList.remove('active'); } },
            submitPin: function() {
                const val = this.inputBuffer;
                this.inputBuffer = ''; this.updatePinDots();
                if (this.mode === 'setup') {
                    if (this.step === 1) { this.tempSecret = val;
                        this.step = 2; document.getElementById('pinTitle').textContent = 'å†æ¬¡ç¡®è®¤'; document.getElementById('pinSub').textContent = 'è¯·å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤'; } 
                    else { if (val === this.tempSecret) this.finishPasswordSetup(val);
                    else { this.toast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); this.step = 1; document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç '; } }
                } else if (this.mode === 'login') { if (val === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                else this.handleFail(); }
            },
            
            initGesture: function() {
                const canvas = document.getElementById('gestureCanvas');
                const ctx = canvas.getContext('2d'); 
                const area = document.getElementById('gestureArea');
                let isDrawing = false; let path = [];
                canvas.width = 300;
                canvas.height = 300; 

                const getPoint = (x, y) => { 
                    const rect = area.getBoundingClientRect();
                    const rx = x - rect.left; const ry = y - rect.top;
                    const col = Math.floor(rx / (300/3));
                    const row = Math.floor(ry / (300/3));
                    if(col>=0 && col<3 && row>=0 && row<3) return row*3 + col;
                    return -1; 
                };
                const draw = (curX, curY) => {
                    ctx.clearRect(0, 0, 300, 300);
                    ctx.strokeStyle = '#ffb7c5'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    if(path.length > 0) { 
                        ctx.beginPath();
                        const p0 = getCenter(path[0]); ctx.moveTo(p0.x, p0.y); 
                        for(let i=1; i<path.length; i++) { const p = getCenter(path[i]); ctx.lineTo(p.x, p.y); } 
                        if(curX !== null) ctx.lineTo(curX, curY);
                        ctx.stroke(); 
                    }
                    document.querySelectorAll('.point-inner').forEach((el, i) => { if(path.includes(i)) el.classList.add('active'); else el.classList.remove('active'); });
                };
                const getCenter = (idx) => { const row = Math.floor(idx/3), col = idx%3;
                    return { x: col*100 + 50, y: row*100 + 50 }; };
                
                const start = (e) => { e.preventDefault(); e.stopPropagation(); isDrawing = true; path = []; move(e); };
                const move = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); e.stopPropagation();
                    let cx, cy; if(e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
                    const rect = area.getBoundingClientRect();
                    const idx = getPoint(cx, cy); if(idx !== -1 && !path.includes(idx)) path.push(idx); 
                    draw(cx - rect.left, cy - rect.top); 
                };
                const end = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); isDrawing = false; draw(null, null); 
                    if(path.length < 3) { this.toast('ç‚¹å¤ªå°‘å•¦'); path = []; draw(null,null); return; } 
                    const code = path.join('');
                    if(this.mode === 'setup') { 
                        if(this.step === 1) { this.tempSecret = code;
                            this.step = 2; document.getElementById('gestTitle').textContent = 'å†æ¬¡ç»˜åˆ¶'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } 
                        else { if(code === this.tempSecret) this.finishPasswordSetup(code);
                        else { this.toast('ä¸ä¸€è‡´'); this.step = 1; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } } 
                    } else if(this.mode === 'login') { 
                        if(code === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                        else { this.handleFail(); setTimeout(()=>{ path=[]; draw(null,null); }, 500); } 
                    } 
                };
                const newCanvas = canvas.cloneNode(true); canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.addEventListener('mousedown', start); newCanvas.addEventListener('touchstart', start, {passive: false});
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end);

                this.resetGesture = () => { this.step = 1; this.tempSecret = null; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; document.getElementById('gestResetBtn').style.display = 'none';
                    path = []; draw(null,null); };
            },

            finishPasswordSetup: function(secret) { this.finalSecret = secret; this.finalType = this.type; this.showView('view-setup-question'); },
            saveSecurityQuestion: function() { const q = document.getElementById('secQuestion').value.trim();
                const a = document.getElementById('secAnswer').value.trim(); if(!q || !a) { this.toast('è¯·å¡«å†™å®Œæ•´'); return; } localStorage.setItem('magic_auth_type', this.finalType); localStorage.setItem('magic_auth_secret', this.finalSecret); localStorage.setItem('magic_auth_q', q); localStorage.setItem('magic_auth_a', a); this.toast('è®¾ç½®æˆåŠŸï¼');
                this.unlockApp(); },
            handleFail: function() { this.failCount++; this.toast('å¯†ç é”™è¯¯');
                if(this.failCount >= 3) { if(this.type==='pin') document.getElementById('pinForgotBtn').style.display='block'; else document.getElementById('gestForgotBtn').style.display='block'; } },
            showRecovery: function() { const q = localStorage.getItem('magic_auth_q');
                if(!q) { this.toast('æœªè®¾ç½®é—®é¢˜'); return; } document.getElementById('recoveryQText').textContent = q; this.showView('view-recovery'); },
            checkRecovery: function() { if(document.getElementById('recoveryAnswer').value.trim() === localStorage.getItem('magic_auth_a')) { localStorage.removeItem('magic_auth_type');
                localStorage.removeItem('magic_auth_secret'); this.toast('éªŒè¯æˆåŠŸï¼Œè¯·é‡è®¾'); setTimeout(() => location.reload(), 1000); } else this.toast('é”™è¯¯'); },
            unlockApp: function() { document.getElementById('lockScreen').style.transition = 'opacity 0.5s';
                document.getElementById('lockScreen').style.opacity = 0; setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; if(!window.appInitialized) { initOriginalApp(); window.appInitialized = true; } }, 500);
            }
        };

        // ================= ğŸ“± åº”ç”¨æ ¸å¿ƒé€»è¾‘ =================
        let items = [];
        let draftResources = []; 
        let currentTags = [];
        let isEditing = false;
        let editingIndex = -1;
        let viewingIndex = -1;
        let galleryIndex = 0;
        let currentLuckyIndex = -1;

        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶', 'è‡ªå®šä¹‰'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';
        let db;

        window.onload = function() { auth.init(); };
        function initOriginalApp() { initDB().then(() => { loadFromDB(); migrateFromLocalStorage(); initLayout(); }); initMusic(); initDraggable(); }
        function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onerror = () => reject(); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); }; request.onsuccess = (e) => { db = e.target.result; resolve(); }; }); }
        async function loadFromDB() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { items = req.result.sort((a, b) => new Date(b.date) - new Date(a.date)); renderGrid(items);
            renderNavPanel(); }; }
        async function saveItemToDB(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); const req = item.id ? store.put(item) : store.add(item); req.onsuccess = () => resolve(req.result); req.onerror = () => { alert('ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶å¤ªå¤§ï¼Ÿ'); reject(); }; }); }
        async function deleteItemFromDB(id) { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete(id);
            return new Promise(resolve => tx.oncomplete = resolve); }
        function migrateFromLocalStorage() { const old = localStorage.getItem('my_magic_collection_v3');
            if(old) { try { const p = JSON.parse(old); if(p.length > 0 && confirm('å‘ç°æ—§æ•°æ®ï¼Œè¿ç§»å—ï¼Ÿ')) { const tx = db.transaction(STORE_NAME, 'readwrite');
            p.forEach(i => { delete i.id; tx.objectStore(STORE_NAME).add(i); }); tx.oncomplete = () => { alert('è¿ç§»æˆåŠŸï¼'); localStorage.removeItem('my_magic_collection_v3'); loadFromDB(); };
            } } catch(e){} } }

        function renderGrid(dataList) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            if (dataList.length === 0) { 
                container.innerHTML = '<div class="empty-state">ç©ºç©ºçš„...å¿«å»æ·»åŠ å§ï¼</div>';
                return; 
            }

            dataList.forEach((item) => {
                const realIndex = items.indexOf(item);
                const card = document.createElement('div'); 
                
                card.className = 'card';
            
                if (isBatchDeleteMode) {
                    card.classList.add('is-selecting');
                    if (selectedDeleteIds.has(item.id)) {
                        card.classList.add('selected');
                    }
        
                    card.onclick = () => {
                        if (selectedDeleteIds.has(item.id)) {
                            selectedDeleteIds.delete(item.id);
                        } else {
                            selectedDeleteIds.add(item.id);
                        }
                        renderGrid(dataList); 
                        updateDeleteBar();
                    };
                } else {
                    card.onclick = () => openDetailModal(realIndex);
                }

                const images = item.resources.filter(r => r.type === 'image');
                let coverSrc = PLACEHOLDER_IMG; 
                if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
                
                const imgWrapper = document.createElement('div'); 
               // ğŸ‘‡ ä¿®æ”¹åï¼šä¼šè‡ªåŠ¨è¯»å– item.frameStyle å¹¶åŠ ä¸Šå¯¹åº”çš„ CSS ç±»
imgWrapper.className = `card-img-wrapper ${item.frameStyle || ''}`;
                const img = document.createElement('img'); 
                img.src = coverSrc; 
                imgWrapper.appendChild(img);
                
                const content = document.createElement('div'); 
                content.className = 'card-content';
                const title = document.createElement('h3');
                title.className = 'card-title'; 
                title.textContent = item.name;
                content.appendChild(title); 
                
                const tagsDiv = document.createElement('div'); 
                tagsDiv.className = 'tags-container';
                (item.tags||[]).forEach(t => { 
                    const span = document.createElement('span'); 
                    span.className = 'tag-pill'; 
                    span.textContent = t; 
                    tagsDiv.appendChild(span); 
                }); 
                content.appendChild(tagsDiv);
                
                card.appendChild(imgWrapper); 
                card.appendChild(content); 
                container.appendChild(card);
            });
        }

                function switchLayout(mode) {
            const c = document.getElementById('gridContainer');
            c.className = 'grid-container'; // æ¸…é™¤æ—§æ¨¡å¼
            
            // æŒ‰é’®çŠ¶æ€é‡ç½®
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));

            if (mode === 'shelf') {
                document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.add('active');
                renderShelfView(); // ğŸ‘ˆ è°ƒç”¨ä¸‹é¢æ–°å†™çš„æ¸²æŸ“å‡½æ•°
            } else {
                c.classList.add('mode-' + mode);
                renderGrid(items); // æ¢å¤æ­£å¸¸æ¸²æŸ“
                
                // æ¢å¤æŒ‰é’®é«˜äº®é€»è¾‘
                if(mode==='default') document.querySelector('.layout-btn[title="é»˜è®¤ç½‘æ ¼"]').classList.add('active');
                if(mode==='list') document.querySelector('.layout-btn[title="é•¿åˆ—è¡¨"]').classList.add('active');
                if(mode==='large') document.querySelector('.layout-btn[title="å¤§å›¾æ¨¡å¼"]').classList.add('active');
                if(mode==='mini') document.querySelector('.layout-btn[title="è¿·ä½ æ¨¡å¼"]').classList.add('active');
            }

            localStorage.setItem('my_magic_layout', mode);
            if(mode !== 'shelf') auth.toast('è§†å›¾åˆ‡æ¢æˆåŠŸ âœ¨');
        }

        function initLayout() {
            const mode = localStorage.getItem('my_magic_layout') || 'default';
            switchLayout(mode);
        }

        // --- æŠ½ç­¾é€»è¾‘ ---
        function startLottery() {
            if(items.length === 0) { auth.toast('ç›’å­æ˜¯ç©ºçš„æ€ä¹ˆæŠ½å‘€~'); return; }
            document.getElementById('floatMenu').classList.remove('active');
            const overlay = document.getElementById('lotteryOverlay');
            const gift = document.getElementById('magicGift');
            const result = document.getElementById('lotteryResult');
            overlay.classList.add('active'); result.style.display = 'none'; gift.style.display = 'block'; gift.classList.add('shaking');
            const luckyIndex = Math.floor(Math.random() * items.length);
            currentLuckyIndex = luckyIndex;
            const item = items[luckyIndex];
            document.getElementById('lotteryName').textContent = item.name;
            const images = item.resources.filter(r => r.type === 'image');
            let coverSrc = PLACEHOLDER_IMG; 
            if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
            document.getElementById('lotteryImg').src = coverSrc;
            setTimeout(() => { gift.classList.remove('shaking'); gift.style.display = 'none'; result.style.display = 'flex'; }, 1500);
        }
        function closeLottery() { document.getElementById('lotteryOverlay').classList.remove('active'); }
        function goToLotteryItem() { closeLottery(); if(currentLuckyIndex !== -1) setTimeout(() => openDetailModal(currentLuckyIndex), 300); }

        // --- ğŸŸ¢ å¢å¼ºç‰ˆï¼šå…¨èƒ½æ‰¹é‡å¯¼å…¥ (æ”¯æŒ .jsonl è‡ªåŠ¨è¯†åˆ«) ---
        async function handleBatchImageImport(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            auth.toast(`æ­£åœ¨æ¬è¿ ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨ç­‰... ğŸšš`);
            let count = 0;
            for (let f of files) {
                const name = f.name;
                let resourceType = 'file'; 
                let subType = 'é™„ä»¶';
                let content = null;
                if (f.type.startsWith('image/')) {
                    resourceType = 'image';
                    subType = 'é»˜è®¤';
                    content = await readFile(f); 
                } else if (f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    resourceType = 'json';
                    subType = 'æ•°æ®';
                    content = await readFileText(f);
                } else {
                    resourceType = 'file';
                    subType = 'é™„ä»¶';
                    content = await readFile(f); 
                }

                const newItem = { 
                    name: name, 
                    tags: ['æ‰¹é‡å¯¼å…¥'], 
                    resources: [{ 
                        type: resourceType, 
                        subType: subType, 
                        name: name, 
                        content: content 
                    }], 
                    coverIndex: 0, 
                    date: new Date().toISOString() 
                };
                try { 
                    await saveItemToDB(newItem);
                    count++; 
                } catch(e) { 
                    console.error("æ–‡ä»¶å¤ªå¤§æˆ–ä¿å­˜å¤±è´¥:", e);
                    auth.toast(`âŒ ${name} å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹ï¼`);
                }
            }
            loadFromDB();
            auth.toast(`æå®šï¼æˆåŠŸå­˜å…¥äº† ${count} ä¸ªå®è´ï¼âœ¨`);
            input.value = ''; 
        }

        // ================= ğŸ§¹ æ‰¹é‡åˆ é™¤é€»è¾‘ =================

        let isBatchDeleteMode = false;
        let selectedDeleteIds = new Set(); 

        function toggleBatchDeleteMode() {
            isBatchDeleteMode = !isBatchDeleteMode;
            selectedDeleteIds.clear(); 
            updateDeleteBar();
            handleSearch(); 
            
            if(isBatchDeleteMode) {
                auth.toast('è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šè¯·ç‚¹é€‰è¦åˆ é™¤çš„ç›’å­ ğŸ—‘ï¸');
            }
        }

        function updateDeleteBar() {
            const bar = document.getElementById('deleteBar');
            const countSpan = document.getElementById('deleteCount');
            
            if (isBatchDeleteMode) {
                bar.classList.add('active');
                countSpan.textContent = selectedDeleteIds.size;
            } else {
                bar.classList.remove('active');
            }
        }

        async function confirmBatchDelete() {
            if (selectedDeleteIds.size === 0) {
                auth.toast('è¿˜æ²¡é€‰ä»»ä½•ä¸œè¥¿å‘¢~');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedDeleteIds.size} ä¸ªç›’å­å—ï¼Ÿæ— æ³•æ¢å¤å“¦ï¼`)) return;
            for (let id of selectedDeleteIds) {
                await deleteItemFromDB(id);
            }

            toggleBatchDeleteMode(); 
            loadFromDB(); 
            auth.toast('æ¸…ç†å®Œæ¯•ï¼å˜å¾—æ¸…çˆ½å¤šå•¦ âœ¨');
        }

        // --- CRUD & UI Helpers ---
        function resetAddModal() { isEditing = false;
            editingIndex = -1; document.getElementById('modalTitle').textContent = 'âœ¨ æ·»åŠ æ–°æ”¶è—'; document.getElementById('itemName').value = ''; 
    document.getElementById('itemMemories').value = ''; // ğŸŸ¢ æ–°å¢ï¼šæ¸…ç©ºå›å¿†å½•
document.getElementById('tagInput').value = ''; document.getElementById('linkInputArea').style.display = 'none'; draftResources = [];
            currentTags = []; renderTagsInput(); renderResourceList(); renderSuggestTags(); }
        function openAddModal() { resetAddModal(); document.getElementById('addModal').classList.add('active'); }
        function openEditMode() { if (viewingIndex === -1) return; isEditing = true;
            editingIndex = viewingIndex; const item = items[editingIndex]; document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç›’å­å†…å®¹'; document.getElementById('itemName').value = item.name; 
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šå›æ˜¾å›å¿†å½•ï¼ŒæŠŠæ•°ç»„å˜å›å¤šè¡Œæ–‡æœ¬
    document.getElementById('itemMemories').value = (item.memories || []).join('\n');
currentTags = [...(item.tags || [])];
            draftResources = JSON.parse(JSON.stringify(item.resources)); renderTagsInput(); renderResourceList(); renderSuggestTags(); document.getElementById('detailModal').classList.remove('active'); document.getElementById('addModal').classList.add('active'); }
        
        function renderResourceList() {
            const list = document.getElementById('resourceList');
            list.innerHTML = '';
            if(draftResources.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹</div>'; return; }
            draftResources.forEach((res, idx) => {
                const item = document.createElement('div'); item.className = 'resource-item';
                let p = '';
                if (res.type === 'image') p = `<img src="${res.content}" style="width:100%;height:100%;object-fit:cover">`;
                else if (res.type === 'json') p = 'ğŸ“„';
                else if (res.type === 'link') p = 'ğŸ”—';
                else p = 'ğŸ“';

                const isCustom = !TYPES.includes(res.subType) || res.subType === 'è‡ªå®šä¹‰';
                const selectValue = isCustom ? 'è‡ªå®šä¹‰' : res.subType;
                const customInputValue = (isCustom && res.subType !== 'è‡ªå®šä¹‰') ? res.subType : '';
                const customDisplay = isCustom ? 'inline-block' : 'none';

                let controlsHtml = '';
                if (res.type !== 'link') {
                    let options = '';
                    TYPES.forEach(t => { options += `<option value="${t}" ${selectValue === t ? 'selected' : ''}>${t}</option>`; });
                    controlsHtml = `<div class="resource-controls"><select class="resource-type-select" onchange="handleTypeChange(${idx}, this.value)">${options}</select><input type="text" class="custom-type-input" style="display:${customDisplay}" placeholder="è¾“å…¥ç±»å‹" value="${customInputValue}" onchange="updateCustomType(${idx}, this.value)"></div>`;
                } else {
                    controlsHtml = `<span style="font-size:11px;color:#aaa">é“¾æ¥</span>`;
                }
                item.innerHTML = `<div class="resource-preview">${p}</div><div class="resource-info"><input type="text" class="resource-name-input" value="${res.name}" onchange="updateResourceName(${idx}, this.value)" placeholder="è¯·è¾“å…¥æ–‡ä»¶åç§°">${controlsHtml}</div><button class="btn-remove" onclick="removeDraftResource(${idx})">Ã—</button>`;
                list.appendChild(item);
            });
        }

        function updateResourceName(idx, val) { draftResources[idx].name = val; }
        function handleTypeChange(idx, val) { if (val === 'è‡ªå®šä¹‰') { draftResources[idx].subType = 'è‡ªå®šä¹‰';
            } else { draftResources[idx].subType = val; } renderResourceList(); }
        function updateCustomType(idx, val) { draftResources[idx].subType = val; }
        function removeDraftResource(idx) { draftResources.splice(idx, 1); renderResourceList(); }
        
        async function handleUniversalSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) {
                if (f.type.startsWith('image/')) {
                    const b = await readFile(f);
                    draftResources.push({ type: 'image', subType: 'é»˜è®¤', name: f.name, content: b });
                } else if (f.type === 'application/json' || f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    const t = await readFileText(f);
                    draftResources.push({ type: 'json', subType: 'é»˜è®¤', name: f.name, content: t });
                } else {
                    const b = await readFile(f);
                    draftResources.push({ type: 'file', subType: 'é™„ä»¶', name: f.name, content: b });
                }
            }
            renderResourceList();
            input.value = '';
        }

        function openLinkInput() { document.getElementById('linkInputArea').style.display = 'block'; }
        function confirmAddLink() { const n = document.getElementById('newLinkName').value.trim(), u = document.getElementById('newLinkUrl').value.trim();
            if(n && u) { draftResources.push({ type: 'link', subType: 'link', name: n, content: u }); renderResourceList(); document.getElementById('newLinkName').value = '';
            document.getElementById('newLinkUrl').value = ''; document.getElementById('linkInputArea').style.display = 'none'; } else alert('è¯·è¾“å…¥åç§°å’Œç½‘å€'); }
        async function saveItem() { const n = document.getElementById('itemName').value.trim();
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šè·å–å¤šè¡Œæ–‡æœ¬ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
    const memRaw = document.getElementById('itemMemories').value;
    const memList = memRaw.split('\n').filter(line => line.trim() !== '');
    // ğŸ‘† ğŸŸ¢ æ–°å¢ç»“æŸ
if (!n) { alert('åå­—ä¸èƒ½ä¸ºç©º'); return; } if (draftResources.length === 0) { alert('ç›’å­ä¸èƒ½ä¸ºç©º'); return;
            } const d = { name: n, tags: [...currentTags], memories: memList, resources: draftResources, coverIndex: 0, date: new Date().toISOString() };
            if (isEditing) { d.id = items[editingIndex].id; d.coverIndex = items[editingIndex].coverIndex; } await saveItemToDB(d); loadFromDB(); handleSearch(); closeAddModal();
        }
        
        function openDetailModal(index) { 
            viewingIndex = index;
            const item = items[index]; document.getElementById('detailName').textContent = item.name; 
const tagsBox = document.getElementById('detailTags'); tagsBox.innerHTML = '';
            (item.tags||[]).forEach(t => { const s = document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsBox.appendChild(s); }); const images = item.resources.filter(r => r.type === 'image');
            if(images.length === 0) { document.getElementById('galleryArea').style.display = 'none'; document.getElementById('noImgMsg').style.display = 'block'; } else { document.getElementById('galleryArea').style.display = 'block'; document.getElementById('noImgMsg').style.display = 'none';
            galleryIndex = Math.min(item.coverIndex||0, images.length-1); updateGalleryUI(images); 
initHeadpat();
} 
            
            const listContainer = document.getElementById('detailListContainer');
            listContainer.innerHTML = ''; 
            
                // ================= ğŸ‘‡ å¤åˆ¶è¿™æ®µæ›¿æ¢åŸæ¥çš„ forEach å¾ªç¯ ğŸ‘‡ =================
    item.resources.forEach((res, i) => { 
        const row = document.createElement('div'); 
        row.className = 'detail-item'; 
        
        let icon = 'ğŸ“„'; 
        let btn = ''; 
        let lbl = res.subType || 'é™„ä»¶'; 
        
        // é€šç”¨ä¸‹è½½æŒ‰é’®
        const downloadBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`;

        if (res.type === 'image') { 
            icon = 'ğŸ–¼ï¸'; 
            btn = downloadBtn; 
        } 
        else if (res.type === 'json') { 
            icon = 'ğŸ“œ'; 
            btn = `<span class="action-link" style="background:#e0f7fa;color:#006064;margin-right:5px;" onclick="openReader(${i})">ğŸ“– å¯¹è¯</span>` + downloadBtn; 
        } 
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æœæ˜¯å°è¯´æˆ–txtï¼ŒåŠ ä¸€ä¸ªâ€œé˜…è¯»â€æŒ‰é’® ğŸ‘‡ğŸ‘‡ğŸ‘‡
        else if ((res.type === 'file' && res.name.endsWith('.txt')) || res.subType === 'å°è¯´') { 
            icon = 'ğŸ“˜'; 
            lbl = 'å°è¯´';
            btn = `<span class="action-link" style="background:#fff0f5;color:#d66a80;margin-right:5px;" onclick="openTxtReader(${i})">ğŸ‘ï¸ é˜…è¯»</span>` + downloadBtn; 
        } 
        // ğŸ‘†ğŸ‘†ğŸ‘†ã€å…³é”®ä¿®æ”¹ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†
        else if (res.type === 'link') { 
            icon = 'ğŸ”—'; 
            lbl = 'é“¾æ¥'; 
            btn = `<a class="action-link" href="${res.content}" target="_blank">æ‰“å¼€</a>`; 
        } 
        else { 
            icon = 'ğŸ“'; 
            btn = downloadBtn; 
        } 
        
        row.innerHTML = `<div style="display:flex;align-items:center;min-width:0;"><span class="detail-item-type">${lbl}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${icon} ${res.name}</span></div><div style="flex-shrink:0;margin-left:10px;">${btn}</div>`;
        listContainer.appendChild(row); 
    });
    // ================= ğŸ‘† æ›¿æ¢ç»“æŸ ğŸ‘† =================


            // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šæ¸²æŸ“å°ç« çŠ¶æ€
            renderStampStatus(items[index].stamp);
            
    // ğŸ‘‡ ğŸŸ¢ åœ¨å‡½æ•°æœ€ååŠ è¿™å¥ï¼Œå¼€å§‹æ’­æ”¾åŠ¨ç”»
    startMemoryAnimation(items[index].memories || []);
renderStickyNote(); // âœ… åŠ è¿™ä¸€å¥ï¼Œæ‰“å¼€æ—¶è´´ä¸Šä¾¿ç­¾

// ğŸ‘‡ åŠ ä¸Šè¿™ä¸€è¡Œï¼Œä½ä»½å¾½ç« æ‰ä¼šå‡ºæ¥ï¼
updateRankUI(items[index]); 

// ğŸ‘‡ åŠ ä¸Šè¿™ä¸€è¡Œï¼Œçš‡å—£æŒ‰é’®çš„çŠ¶æ€æ‰ä¼šå¯¹ï¼
updateHeirButtonState();
document.getElementById('detailModal').classList.add('active'); 
renderDetailSouvenirs(index);
        }

                // ================= ğŸ–¼ï¸ æ›´æ–°è¯¦æƒ…é¡µå›¾ç‰‡ (å¸¦æˆ³ä¸€æˆ³åŠŸèƒ½) =================
function updateGalleryUI(images) {
    const container = document.getElementById('galleryArea');
    if (!container) return;
    container.innerHTML = ''; // æ¸…ç©ºæ—§å›¾

    if (!images || images.length === 0) return;

    // ç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
    if (galleryIndex >= images.length) galleryIndex = 0;
    if (galleryIndex < 0) galleryIndex = images.length - 1;

    const res = images[galleryIndex];
    
    // 1. åˆ›å»ºå›¾ç‰‡å®¹å™¨ (æ–¹ä¾¿åšå·¦å³åˆ‡æ¢æŒ‰é’®)
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.textAlign = 'center';

    // 2. åˆ›å»ºå›¾ç‰‡
    const img = document.createElement('img');
    
    // å¤„ç†å›¾ç‰‡å†…å®¹ (å¦‚æœæ˜¯Base64éœ€è¦è§£ç ï¼Œå¦‚æœæ˜¯é“¾æ¥ç›´æ¥ç”¨)
    let src = res.content;
    if (src.startsWith('data:') && src.includes('base64,')) {
        // æœ‰äº›æ—§æ•°æ®å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†é€šå¸¸ img.src ç›´æ¥åƒ base64
        try { src = decodeURIComponent(escape(window.atob(src.split(',')[1]))); } catch(e) { src = res.content; }
    }
    img.src = src;
    
    // å›¾ç‰‡æ ·å¼
    img.style.maxWidth = '100%';
    img.style.maxHeight = '300px'; // é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢å¤ªé•¿
    img.style.borderRadius = '10px';
    img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
    img.style.transition = 'transform 0.1s'; // è®©åŠ¨ç”»æ›´ä¸æ»‘
    img.style.cursor = 'pointer'; // é¼ æ ‡å˜æˆå°æ‰‹

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€å…³é”®ä»£ç ï¼šæˆ³ä¸€æˆ³åŠ å¥½æ„Ÿã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
    img.onclick = function() {
        // 1. åŠ åˆ† (çˆ±æŠš +2)
        if (typeof addFavor === 'function') {
            addFavor(2, "çˆ±æŠš");
        } else {
            console.log("æœªæ‰¾åˆ° addFavor å‡½æ•°");
        }
        
        // 2. éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
        
        // 3. Qå¼¹ç¼©æ”¾åŠ¨ç”»
        this.style.transform = "scale(0.95)";
        setTimeout(() => this.style.transform = "scale(1)", 100);
    };
    // ğŸ‘†ğŸ‘†ğŸ‘†ã€å…³é”®ä»£ç ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

    wrapper.appendChild(img);

    // 3. æ·»åŠ å·¦å³ç¿»é¡µæŒ‰é’® (å¦‚æœæœ‰å¤šå¼ å›¾)
    if (images.length > 1) {
        // å·¦æŒ‰é’®
        const prevBtn = document.createElement('button');
        prevBtn.innerText = 'â€¹';
        prevBtn.className = 'gallery-nav-btn'; // ä½ å¯ä»¥ç”¨ä¹‹å‰çš„æ ·å¼
        prevBtn.style.cssText = 'position:absolute; left:0; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; padding:10px; cursor:pointer; border-radius:0 5px 5px 0;';
        prevBtn.onclick = (e) => { e.stopPropagation(); galleryIndex--; updateGalleryUI(images); };
        
        // å³æŒ‰é’®
        const nextBtn = document.createElement('button');
        nextBtn.innerText = 'â€º';
        nextBtn.style.cssText = 'position:absolute; right:0; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; padding:10px; cursor:pointer; border-radius:5px 0 0 5px;';
        nextBtn.onclick = (e) => { e.stopPropagation(); galleryIndex++; updateGalleryUI(images); };

        wrapper.appendChild(prevBtn);
        wrapper.appendChild(nextBtn);
        
        // æ˜¾ç¤ºé¡µç 
        const counter = document.createElement('div');
        counter.innerText = `${galleryIndex + 1} / ${images.length}`;
        counter.style.cssText = 'font-size:12px; color:#999; margin-top:5px;';
        container.appendChild(wrapper); // å…ˆæ”¾å›¾
        container.appendChild(counter); // å†æ”¾é¡µç 
    } else {
        container.appendChild(wrapper);
    }
}

        function changeGalleryImage(d) { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; galleryIndex += d; if(galleryIndex >= images.length) galleryIndex = 0;
            if(galleryIndex < 0) galleryIndex = images.length - 1; updateGalleryUI(images); }
        async function setAsCover() { if(viewingIndex === -1) return;
            const item = items[viewingIndex]; item.coverIndex = galleryIndex; await saveItemToDB(item); const images = item.resources.filter(r => r.type === 'image'); updateGalleryUI(images); loadFromDB();
        }
        function downloadCurrentGalleryImg() { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; const cur = images[galleryIndex]; downloadFile(cur.name, cur.content);
        }
        function downloadResource(resIndex) { const res = items[viewingIndex].resources[resIndex]; if(res.type === 'link') return;
            downloadFile(res.name, res.content); }
        function downloadFile(name, content) { const a = document.createElement('a');
            if (content.startsWith('data:')) a.href = content; else { const blob = new Blob([content], {type: 'application/json'}); a.href = URL.createObjectURL(blob);
            } a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); if (!content.startsWith('data:')) URL.revokeObjectURL(a.href);
        }
        function readFile(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(file); });
        }
        function readFileText(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsText(file); });
        }
        
        function handleTagInput(e) { 
            if(e.key==='Enter'){ e.preventDefault();
            manualAddTag(); } 
            if(e.key==='Backspace' && !e.target.value) { currentTags.pop(); renderTagsInput(); } 
        }
        function manualAddTag() {
            const el = document.getElementById('tagInput');
            const v = el.value.trim();
            if(v && !currentTags.includes(v)) { currentTags.push(v); el.value=''; renderTagsInput(); }
            el.focus();
        }

        function renderTagsInput() { const area=document.getElementById('tagInputArea'); const inp=document.getElementById('tagInput'); Array.from(area.children).forEach(c=>c!==inp && area.removeChild(c));
            currentTags.forEach((t,i)=>{ const d=document.createElement('div'); d.className='tag-chip'; d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()" style="cursor:pointer">Ã—</span>`; area.insertBefore(d,inp); });
        }
        function renderSuggestTags() { const all=new Set(); items.forEach(i=>(i.tags||[]).forEach(t=>all.add(t))); const box=document.getElementById('suggestedTags'); box.innerHTML='';
            all.forEach(t=>{ const d=document.createElement('div'); d.className='tag-chip'; d.style.background='#f0f0f0'; d.style.color='#666'; d.style.cursor='pointer'; d.textContent=t; d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}}; box.appendChild(d); });
        }
                        // ================= ğŸ” ä¿®å¤åçš„æœç´¢åŠŸèƒ½ =================
        function handleSearch() {
            // 1. è·å–è¾“å…¥æ¡† (ä¿®æ­£ ID ä¸º mainSearchInput)
            const inputEl = document.getElementById('mainSearchInput');
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æŠ¥é”™å¡æ­»
            const q = inputEl ? inputEl.value.toLowerCase().trim() : "";
            
            const isDeep = document.getElementById('deepSearchCheck').checked; 

            if (!q) {
                renderGrid(items); // æ²¡å­—å°±æ˜¾ç¤ºå…¨éƒ¨
                return;
            }

            const f = items.filter(item => {
                // 1. åŸºç¡€æœç´¢ï¼šæœåå­—å’Œæ ‡ç­¾
                const matchBasic = item.name.toLowerCase().includes(q) || (item.tags || []).some(t => t.toLowerCase().includes(q));
                
                if (matchBasic) return true;

                // 2. æ·±å±‚æœç´¢
                if (isDeep && item.resources) {
                    return item.resources.some(res => {
                        if (res.type === 'json' || res.type === 'file') {
                            return res.content && res.content.toLowerCase().includes(q);
                        }
                        return false;
                    });
                }
                
                return false;
            });

            renderGrid(f);
            
            // æœç´¢ç»“æœæç¤º
            if(isDeep && q && f.length === 0) {
                const emptyState = document.querySelector('.empty-state');
                if(emptyState) emptyState.innerHTML = `ğŸ¤” åœ¨å›å¿†é‡Œæ‰¾äº†ä¸€åœˆï¼Œæ²¡æ‰¾åˆ° "${q}"...`;
            }
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
                function closeAddModal() { 
            document.getElementById('addModal').classList.remove('active'); 
        }
        function closeDetailModal() { 
            document.getElementById('detailModal').classList.remove('active'); 
            viewingIndex = -1; 
            
            // ğŸ‘‡ ğŸŸ¢ å¿…é¡»æ”¾åœ¨è¿™ä¸ªèŠ±æ‹¬å·é‡Œé¢ï¼ ğŸŸ¢ ğŸ‘‡
            stopMemoryAnimation();
        }
        async function deleteCurrentItem() { 
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                const id = items[viewingIndex].id; 
                await deleteItemFromDB(id);
                loadFromDB(); 
                closeDetailModal(); 
            } 
        }
        function exportAllData() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { const blob = new Blob([JSON.stringify(req.result)], {type:'application/json'}); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } }
        function importAllData(el) { const file = el.files[0]; if(!file) return;
            const r = new FileReader(); r.onload = e => { try { const imported = JSON.parse(e.target.result);
            if(Array.isArray(imported)) { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); imported.forEach(item => { delete item.id; store.add(item); });
            tx.oncomplete = () => { loadFromDB(); alert('å¯¼å…¥æˆåŠŸï¼'); }; } } catch{ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); } }; r.readAsText(file);
        }
        function initMusic() { const link = localStorage.getItem('my_bgm_link') || DEFAULT_MUSIC;
            const audio = document.getElementById('bgMusic'); audio.src = link; audio.volume = 0.5; document.getElementById('musicLink').value = link;
        }
        function toggleMusic() { const a=document.getElementById('bgMusic'); const b=document.getElementById('playBtn');
            if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';} }
        function changeVolume(s) { document.getElementById('bgMusic').volume=s.value;
        }
        function updateMusicSrc(v) { if(v){document.getElementById('bgMusic').src=v; localStorage.setItem('my_bgm_link',v);
            document.getElementById('playBtn').textContent='â–¶';} }
              // ğŸ·ï¸ ä¿®å¤åçš„ç›®å½•æ¸²æŸ“å‡½æ•°
        function renderNavPanel() {
            const c = document.getElementById('navPanel');
            if(!c) return;
            
            c.innerHTML = ''; // æ¸…ç©ºå†…å®¹

            const map = {};
            const no = [];
            
            // 1. æ•´ç†æ•°æ®
            items.forEach((it, i) => {
                if (!it.tags || it.tags.length == 0) no.push(i);
                else it.tags.forEach(tag => {
                    if (!map[tag]) map[tag] = [];
                    map[tag].push(i);
                });
            });

            // 2. ç”Ÿæˆ HTML (å…ˆæ”¾æœªåˆ†ç±»ï¼Œå†æ”¾æœ‰æ ‡ç­¾çš„)
            if (no.length) createNavGroup(c, 'ğŸ“‚ æœªåˆ†ç±»', no);
            
            Object.keys(map).sort().forEach(k => {
                createNavGroup(c, `ğŸ·ï¸ ${k}`, map[k]);
            });
            
            // å¦‚æœå®Œå…¨æ²¡å†…å®¹ï¼Œç»™ä¸ªæç¤º
            if(no.length === 0 && Object.keys(map).length === 0) {
                c.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">è¿˜æ²¡åŠ æ ‡ç­¾å‘¢~</div>';
            }
        }

        function createNavGroup(c,t,idx) { const g=document.createElement('div'); g.style.marginBottom='5px'; const h=document.createElement('div'); h.innerHTML=`${t} â–¾`; h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555;'; h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'};
            const l=document.createElement('div'); l.style.cssText='display:none;padding-left:10px;'; idx.forEach(i=>{ const it=document.createElement('div'); it.textContent=items[i].name; it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888;'; it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active')}; l.appendChild(it); }); g.appendChild(h); g.appendChild(l); c.appendChild(g);
        }

        function initDraggable() {
            const w=document.getElementById('floatWidget'), b=document.getElementById('floatBtn'), m=document.getElementById('floatMenu');
            let isDragging=false, startX, startY, initialLeft, initialTop;
            b.addEventListener('mousedown', s); b.addEventListener('touchstart', s, {passive:false});
            function s(e) { if(e.target.closest('.float-menu'))return; isDragging=false; const c=e.type.includes('mouse')?e:e.touches[0]; startX=c.clientX; startY=c.clientY;
            const r=w.getBoundingClientRect(); initialLeft=r.left; initialTop=r.top; w.style.left=initialLeft+'px'; w.style.top=initialTop+'px'; w.style.bottom='auto'; w.style.right='auto'; if(e.type.includes('mouse')) { document.addEventListener('mousemove', mv); document.addEventListener('mouseup', ed); } else { document.addEventListener('touchmove', mv, {passive:false});
            document.addEventListener('touchend', ed); } }
            function mv(e) { const c=e.type.includes('mouse')?e:e.touches[0];
            const dx=c.clientX-startX, dy=c.clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5){ isDragging=true; if(m.classList.contains('active'))m.classList.remove('active'); } if(isDragging){ e.preventDefault(); w.style.left=(initialLeft+dx)+'px'; w.style.top=(initialTop+dy)+'px';
            } }
            function ed() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',ed); document.removeEventListener('touchmove',mv); document.removeEventListener('touchend',ed);
            }
            b.addEventListener('click', (e)=>{ if(isDragging){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');} });
            document.addEventListener('click', (e)=>{ if(m.classList.contains('active')&&!w.contains(e.target)){m.classList.remove('active');} });
        }

        // ================= ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤é€»è¾‘ (Reader System - ç¼–è¾‘ & ä¹¦ç­¾å¢å¼ºç‰ˆ) =================

        let readerState = {
            data: [],
            bookmarks: {}, // æ ¼å¼: { floorIndex: "å¤‡æ³¨å†…å®¹" }
            currentPage: 1,
            pageSize: 10,
            totalMessages: 0,
            totalPages: 0,
            resourceIndex: -1 // è®°å½•å½“å‰æ­£åœ¨è¯»å“ªä¸ªæ–‡ä»¶ï¼Œæ–¹ä¾¿ä¿å­˜
        };

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('bookmarkDrawer').classList.remove('active');
        }

        async function openReader(resIndex) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            const res = item.resources[resIndex];
            
            readerState.resourceIndex = resIndex;

            let jsonContent;
            try {
                // 1. è§£æå†…å®¹
                if (res.content.startsWith('data:')) {
                    const base64 = res.content.split(',')[1];
                    const decoded = atob(base64);
                    // è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
                    const bytes = new Uint8Array(decoded.length);
                    for (let i = 0; i < decoded.length; i++) bytes[i] = decoded.charCodeAt(i);
                    jsonContent = new TextDecoder('utf-8').decode(bytes);
                } else {
                    jsonContent = res.content;
                }

                let chatData = [];
                try {
                    chatData = JSON.parse(jsonContent);
                } catch (e) {
                    // å°è¯• JSONL
                    const lines = jsonContent.split('\n').filter(line => line.trim() !== '');
                    chatData = lines.map(line => JSON.parse(line));
                }

               // æ ‡å‡†åŒ–æ¶ˆæ¯ (ä¿æŒä¸å˜)
                let messages = [];
                if (Array.isArray(chatData)) {
                    messages = chatData;
                } else if (chatData.messages && Array.isArray(chatData.messages)) {
                    messages = chatData.messages;
                }

                if (messages.length === 0) {
                    auth.toast('æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½• ğŸ“œ');
                    return;
                }

                // åŠ è½½ä¹¦ç­¾ (ä¿æŒä¸å˜)
                if (!res.bookmarks) {
                    res.bookmarks = {};
                }
                readerState.bookmarks = res.bookmarks;

                // åˆå§‹åŒ–åˆ†é¡µ
                readerState.data = messages;
                readerState.totalMessages = messages.length;
                readerState.pageSize = 10;
                readerState.totalPages = Math.ceil(messages.length / readerState.pageSize);
                readerState.currentPage = 1;

                document.getElementById('readerTitle').textContent = res.name.replace(/\.jsonl?$/i, '');
                
                renderCurrentPage();
                
                // ğŸŸ¢ æ”¹åŠ¨ï¼šæ‰“å¼€é˜…è¯»å™¨æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0; 
                
                document.getElementById('readerModal').classList.add('active');

            } catch (e) {
                console.error(e);
                auth.toast('æ‰“ä¸å¼€...æ ¼å¼å¥½åƒä¸å¯¹ ğŸ˜µ');
            }
        }

              function renderCurrentPage() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = ''; 

            const startIdx = (readerState.currentPage - 1) * readerState.pageSize;
            const endIdx = Math.min(startIdx + readerState.pageSize, readerState.totalMessages);
            const currentMessages = readerState.data.slice(startIdx, endIdx);

            document.getElementById('readerCount').textContent = `æ€»è®¡ ${readerState.totalMessages} æ¥¼`;
            document.getElementById('pageInfo').textContent = `${readerState.currentPage} / ${readerState.totalPages}`;

            currentMessages.forEach((msg, i) => {
                // ... (ä¸­é—´çš„ forEach å¾ªç¯ç”Ÿæˆæ°”æ³¡çš„ä»£ç å®Œå…¨ä¿æŒä¸å˜) ...
                // ... ç›´æ¥å¤åˆ¶åŸæ¥çš„å³å¯ ...
                const globalIndex = startIdx + i;
                const text = msg.mes || msg.content || msg.text || msg.message || '...';
                const name = msg.name || '???';
                
                let isRight = false;
                if (msg.hasOwnProperty('is_user')) isRight = msg.is_user;
                else if (msg.hasOwnProperty('is_main')) isRight = msg.is_main;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isRight = true;

                const sideClass = isRight ? 'right' : 'left';
                const row = document.createElement('div');
                row.className = `chat-row ${sideClass}`;
                row.id = `floor-${globalIndex}`; 

                const floor = document.createElement('span');
                floor.className = 'floor-tag';
                
                const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
                const starClass = isBookmarked ? 'active' : '';
                
                floor.innerHTML = `
                    #${globalIndex + 1} 
                    <span class="bookmark-icon ${starClass}" 
                          onclick="handleBookmarkClick(${globalIndex}, this)" 
                          title="${isBookmarked ? 'ç‚¹å‡»ä¿®æ”¹/åˆ é™¤å¤‡æ³¨' : 'ç‚¹å‡»æ·»åŠ ä¹¦ç­¾'}">
                          â˜…
                    </span>`;

                const bubbleWrapper = document.createElement('div');
                const nameTag = document.createElement('div');
                nameTag.className = 'chat-name';
                nameTag.textContent = name;

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                bubble.title = "åŒå‡»ç¼–è¾‘å†…å®¹";
                bubble.ondblclick = (e) => {
                    e.stopPropagation();
                    enableEditMode(bubble, globalIndex, text);
                };

                bubbleWrapper.appendChild(nameTag);
                bubbleWrapper.appendChild(bubble);
                
                row.appendChild(floor);
                row.appendChild(bubbleWrapper);
                container.appendChild(row);
            });

            // ğŸŸ¢ æ”¹åŠ¨ï¼šåˆ é™¤äº† container.scrollTop = 0; è¿™ä¸€è¡Œ
            // è¿™æ ·åˆ·æ–°é¡µé¢æ—¶ï¼Œæ»šåŠ¨æ¡ä¼šåœç•™åœ¨åŸåœ°
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šåŒå‡»ç¼–è¾‘é€»è¾‘ ---
        function enableEditMode(bubbleEl, globalIndex, oldText) {
            // é¿å…é‡å¤è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (bubbleEl.querySelector('.bubble-textarea')) return;

            // åˆ›å»ºç¼–è¾‘ç•Œé¢
            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-edit-wrapper';

            const textarea = document.createElement('textarea');
            textarea.className = 'bubble-textarea';
            textarea.value = oldText; // ç›´æ¥æ”¾å…¥åŸæ–‡æœ¬ï¼Œä¸å« <br>
            
            const btnRow = document.createElement('div');
            btnRow.className = 'edit-btn-row';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'edit-confirm-btn';
            confirmBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            confirmBtn.onclick = () => saveBubbleEdit(globalIndex, textarea.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'edit-cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = () => renderCurrentPage(); // é‡æ–°æ¸²æŸ“æ¢å¤åŸçŠ¶

            btnRow.appendChild(cancelBtn);
            btnRow.appendChild(confirmBtn);
            wrapper.appendChild(textarea);
            wrapper.appendChild(btnRow);

            // æ¸…ç©ºæ°”æ³¡å¹¶æ”¾å…¥ç¼–è¾‘æ¡†
            bubbleEl.innerHTML = '';
            bubbleEl.appendChild(wrapper);
            textarea.focus();
        }

              async function saveBubbleEdit(globalIndex, newText) {
            // ğŸŸ¢ æ”¹åŠ¨ï¼šä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®
            const container = document.getElementById('chatContainer');
            const currentScroll = container.scrollTop;

            // 1. æ›´æ–°å†…å­˜æ•°æ®
            const msg = readerState.data[globalIndex];
            if(msg.mes !== undefined) msg.mes = newText;
            if(msg.content !== undefined) msg.content = newText;
            if(msg.text !== undefined) msg.text = newText;
            if(msg.message !== undefined) msg.message = newText;

            // 2. æŒä¹…åŒ–ä¿å­˜åˆ°æ•°æ®åº“
            await saveReaderDataToDB();

            // 3. é‡æ–°æ¸²æŸ“
            renderCurrentPage();

            // ğŸŸ¢ æ”¹åŠ¨ï¼šæ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿è§†å›¾ä¸ä¹±è·³
            container.scrollTop = currentScroll;

            auth.toast('ä¿®æ”¹å·²ä¿å­˜ âœ¨');
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šä¹¦ç­¾ç³»ç»Ÿ ---
        async function handleBookmarkClick(globalIndex, iconEl) {
            const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
            
            if (isBookmarked) {
                // å·²æœ‰ä¹¦ç­¾ï¼šè¯¢é—®æ˜¯ä¿®æ”¹è¿˜æ˜¯åˆ é™¤
                const oldNote = readerState.bookmarks[globalIndex];
                const newNote = prompt("âœï¸ ä¿®æ”¹å¤‡æ³¨ (æ¸…ç©ºå†…å®¹åˆ™åˆ é™¤ä¹¦ç­¾):", oldNote);
                
                if (newNote === null) return; // å–æ¶ˆ
                
                if (newNote.trim() === "") {
                    delete readerState.bookmarks[globalIndex];
                    auth.toast('ä¹¦ç­¾å·²åˆ é™¤ ğŸ—‘ï¸');
                } else {
                    readerState.bookmarks[globalIndex] = newNote;
                    auth.toast('å¤‡æ³¨å·²æ›´æ–° ğŸ“');
                }
            } else {
                // æ–°ä¹¦ç­¾
                const note = prompt("âœ¨ è¯·è¾“å…¥ä¹¦ç­¾å¤‡æ³¨:", "è¿™é‡Œå¾ˆæœ‰è¶£...");
                if (note === null) return;
                
                readerState.bookmarks[globalIndex] = note || "æ— å¤‡æ³¨";
                auth.toast('ä¹¦ç­¾æ·»åŠ æˆåŠŸ â­');
            }

            // ä¿å­˜å¹¶åˆ·æ–°UI
            await saveReaderDataToDB();
            renderCurrentPage();
            // å¦‚æœä¹¦ç­¾åˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
            if(document.getElementById('bookmarkDrawer').classList.contains('active')){
                renderBookmarkList();
            }
        }

        function toggleBookmarkDrawer() {
            const drawer = document.getElementById('bookmarkDrawer');
            drawer.classList.toggle('active');
            if (drawer.classList.contains('active')) {
                renderBookmarkList();
            }
        }

        function renderBookmarkList() {
            const listEl = document.getElementById('bookmarkList');
            listEl.innerHTML = '';

            const indices = Object.keys(readerState.bookmarks).map(Number).sort((a,b) => a-b);

            if (indices.length === 0) {
                listEl.innerHTML = '<div class="bm-empty">è¿˜æ²¡æœ‰åŠ è¿‡ä¹¦ç­¾å“¦~<br>ç‚¹å‡»æ¥¼å±‚å·æ—è¾¹çš„ â˜… è¯•è¯•</div>';
                return;
            }

            indices.forEach(idx => {
                const note = readerState.bookmarks[idx];
                const item = document.createElement('div');
                item.className = 'bookmark-item';
                item.onclick = () => jumpToFloor(idx);
                
                item.innerHTML = `
                    <div class="bm-floor">#${idx + 1} æ¥¼</div>
                    <div class="bm-note">${note}</div>
                `;
                listEl.appendChild(item);
            });
        }

        function jumpToFloor(globalIndex) {
            // 1. è®¡ç®—ç›®æ ‡é¡µç 
            const targetPage = Math.floor(globalIndex / readerState.pageSize) + 1;
            
            // 2. è·³è½¬é¡µé¢
            readerState.currentPage = targetPage;
            renderCurrentPage();

            // 3. å…³é—­æŠ½å±‰
            document.getElementById('bookmarkDrawer').classList.remove('active');

            // 4. æ»šåŠ¨åˆ°æŒ‡å®šæ¥¼å±‚å¹¶é«˜äº®
            setTimeout(() => {
                const row = document.getElementById(`floor-${globalIndex}`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 2000);
                }
            }, 100); // ç¨å¾®å»¶è¿Ÿç­‰å¾…æ¸²æŸ“
        }

        // --- ğŸ’¾ æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
        async function saveReaderDataToDB() {
            if (viewingIndex === -1 || readerState.resourceIndex === -1) return;

            const item = items[viewingIndex];
            const res = item.resources[readerState.resourceIndex];

            // 1. ä¿å­˜å†…å®¹ (å°†å¯¹è±¡æ•°ç»„è½¬å› JSON å­—ç¬¦ä¸²)
            res.content = JSON.stringify(readerState.data);

            // 2. ä¿å­˜ä¹¦ç­¾
            res.bookmarks = readerState.bookmarks;

            // 3. å†™å…¥æ•°æ®åº“
            await saveItemToDB(item);
        }

               function prevPage() {
            if (readerState.currentPage > 1) {
                readerState.currentPage--;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯ç¬¬ä¸€é¡µå•¦');
            }
        }

        function nextPage() {
            if (readerState.currentPage < readerState.totalPages) {
                readerState.currentPage++;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯æœ€åä¸€é¡µå•¦');
            }
        }

        // ================= ğŸ¨ CSS ä¸»é¢˜ç³»ç»Ÿ =================
        
        let savedThemes = JSON.parse(localStorage.getItem('my_reader_themes') || '[]');

        // 1. æ‰“å¼€/å…³é—­é¢æ¿
        function toggleCssDrawer() {
            const drawer = document.getElementById('cssDrawer');
            drawer.classList.toggle('active');
            if(drawer.classList.contains('active')) {
                renderThemeSelect();
            }
        }

        // 2. é¢„è§ˆ/åº”ç”¨ CSS
        function previewCss() {
            const css = document.getElementById('cssInput').value;
            // æŠŠ CSS æ³¨å…¥åˆ°ç¬¬ä¸€æ­¥åŠ çš„ style æ ‡ç­¾é‡Œ
            document.getElementById('custom-reader-style').textContent = css;
            auth.toast('çš®è‚¤å·²åº”ç”¨ âœ¨');
        }

        // 3. ä¿å­˜ä¸»é¢˜
        function saveCustomTheme() {
            const name = document.getElementById('themeNameInput').value.trim();
            const css = document.getElementById('cssInput').value;
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!css) { auth.toast('è¿˜æ²¡å†™ä»£ç å‘¢ï¼'); return; }

            // æ£€æŸ¥é‡åï¼Œå¦‚æœæœ‰é‡åå°±è¦†ç›–
            const existingIdx = savedThemes.findIndex(t => t.name === name);
            if(existingIdx >= 0) {
                if(!confirm(`ä¸»é¢˜ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
                savedThemes[existingIdx].css = css;
            } else {
                savedThemes.push({ name: name, css: css });
            }

            localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
            renderThemeSelect();
            // è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„
            document.getElementById('themeSelect').value = name;
            auth.toast('ä¸»é¢˜ä¿å­˜æˆåŠŸ ğŸ’¾');
        }

        // 4. åŠ è½½é€‰ä¸­çš„ä¸»é¢˜
        function loadSelectedTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) return;
            
            const theme = savedThemes.find(t => t.name === name);
            if(theme) {
                document.getElementById('cssInput').value = theme.css;
                document.getElementById('themeNameInput').value = theme.name;
                previewCss(); // è‡ªåŠ¨åº”ç”¨
            }
        }

        // 5. åˆ é™¤ä¸»é¢˜
        function deleteCustomTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) { auth.toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸»é¢˜'); return; }
            
            if(confirm(`ç¡®å®šåˆ é™¤ä¸»é¢˜ "${name}" å—ï¼Ÿ`)) {
                savedThemes = savedThemes.filter(t => t.name !== name);
                localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
                
                document.getElementById('cssInput').value = '';
                document.getElementById('themeNameInput').value = '';
                document.getElementById('custom-reader-style').textContent = ''; // æ¸…ç©ºæ•ˆæœ
                
                renderThemeSelect();
                auth.toast('å·²åˆ é™¤ ğŸ—‘ï¸');
            }
        }

        // 6. æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
        function renderThemeSelect() {
            const sel = document.getElementById('themeSelect');
            // ä¿ç•™ç¬¬ä¸€é¡¹æç¤º
            sel.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>';
            savedThemes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }
        
        // ğŸŸ¢ åˆå§‹åŒ–ï¼šå¦‚æœä¹‹å‰æœ‰æœ€åä¸€æ¬¡ä½¿ç”¨çš„ä¸»é¢˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨åŠ è½½ï¼ˆå¯é€‰ï¼‰
        // window.addEventListener('load', () => { ... })

        // ================= ğŸ’­ é£˜å­—åŠ¨ç”»é€»è¾‘ =================
        let memoryInterval = null;

        function startMemoryAnimation(list) {
            const container = document.getElementById('memoryLayer');
            container.innerHTML = ''; // å…ˆæ¸…ç©º
            
            // å¦‚æœæ²¡æœ‰è¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©ºï¼Œå°±ä¸æ”¾äº†
            if (!list || list.length === 0) return;

            // ç«‹å³ç”Ÿæˆå‡ ä¸ªï¼Œé¿å…æ‰“å¼€æ—¶ç©ºè¡è¡
            for(let i=0; i<3; i++) spawnMemory(list, container);

            // æ¯éš” 1.5ç§’ ç”Ÿæˆä¸€ä¸ªæ–°çš„
            memoryInterval = setInterval(() => {
                spawnMemory(list, container);
            }, 1500);
        }

        function stopMemoryAnimation() {
            if (memoryInterval) {
                clearInterval(memoryInterval);
                memoryInterval = null;
            }
            document.getElementById('memoryLayer').innerHTML = '';
        }

        function spawnMemory(list, container) {
            const text = list[Math.floor(Math.random() * list.length)]; // éšæœºæŒ‘ä¸€å¥
            const el = document.createElement('div');
            el.className = 'memory-text';
            el.textContent = text;
            
            // éšæœºä½ç½®å’Œå¤§å°ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
            const randomLeft = Math.random() * 80 + 10; // 10% åˆ° 90% ä¹‹é—´
            const randomDuration = Math.random() * 5 + 8; // 8åˆ°13ç§’é£˜å®Œ
            const randomSize = Math.random() * 8 + 16; // 16px åˆ° 24px å¤§å°
            
            el.style.left = randomLeft + '%';
            el.style.animationDuration = randomDuration + 's';
            el.style.fontSize = randomSize + 'px';
            
            container.appendChild(el);

            // åŠ¨ç”»ç»“æŸååˆ é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
            }, randomDuration * 1000);
        }

 // ================= ğŸº é…’é¦†ä¼ é€é—¨é€»è¾‘ (æé€Ÿç‰ˆ) =================
        
        // ğŸš€ å¯åŠ¨é€»è¾‘ (æ— å»¶è¿Ÿï¼Œæµè§ˆå™¨ä¸ä¼šæ‹¦æˆª)
        function jumpToTavern() {
            let url = localStorage.getItem('my_tavern_simple_url');
            
            // ç¬¬ä¸€æ¬¡ç”¨ï¼Œè¿˜æ²¡å­˜è¿‡é“¾æ¥
            if (!url) {
                // å¦‚æœæ²¡é“¾æ¥ï¼Œç›´æ¥è°ƒç”¨ä¿®æ”¹å‡½æ•°
                changeTavernLink(true); 
            } else {
                // æœ‰é“¾æ¥ï¼Œç›´æ¥é£
                window.open(url, '_blank');
            }
        }

        // âœï¸ ä¿®æ”¹é€»è¾‘
        function changeTavernLink(isFirstTime = false) {
            const oldUrl = localStorage.getItem('my_tavern_simple_url') || 'http://127.0.0.1:8000';
            const msg = isFirstTime ? "ğŸº ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œè¯·è¾“å…¥é…’é¦†é“¾æ¥ï¼š" : "ğŸ”§ ä¿®æ”¹é…’é¦†åæ ‡ï¼š";
            
            let newUrl = prompt(msg + "\n(ä¾‹å¦‚ http://127.0.0.1:8000 )", oldUrl);
            
            if (newUrl) {
                // è´´å¿ƒåœ°å¸®ç”¨æˆ·åŠ ä¸Š http (é˜²æ­¢ç”¨æˆ·åªå†™ IP)
                if (!newUrl.startsWith('http')) {
                    newUrl = 'http://' + newUrl;
                }
                // å»æ‰æœ«å°¾çš„æ–œæ  / (é˜²æ­¢æ‹¼æ¥å‡ºé”™)
                if (newUrl.endsWith('/')) {
                    newUrl = newUrl.slice(0, -1);
                }
                
                localStorage.setItem('my_tavern_simple_url', newUrl);
                auth.toast('é…’é¦†åæ ‡å·²é”å®š ğŸ“');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®ï¼Œè®¾ç½®å®Œç›´æ¥è·³
                if(isFirstTime) {
                    window.open(newUrl, '_blank');
                }
            }
        }

        // ================= ğŸ’® å°ç« ç³»ç»Ÿé€»è¾‘ =================

        // åˆ‡æ¢å°ç« ï¼ˆç‚¹å‡»å°å›¾æ ‡æ—¶è§¦å‘ï¼‰
        async function toggleStamp(char) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // å¦‚æœå½“å‰å·²ç»æ˜¯è¿™ä¸ªå°ç« ï¼Œå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆ
            if (item.stamp === char) {
                item.stamp = null; // å–æ¶ˆ
                auth.toast('å°ç« å·²æ’¤é”€ ğŸ’¨');
            } else {
                item.stamp = char; // ç›–ç« 
                auth.toast('ç›–ç« æˆåŠŸï¼å•ªï¼ğŸ’®');
            }

            // ä¿å­˜æ•°æ®
            await saveItemToDB(item);
            
            // åˆ·æ–°ç•Œé¢
            renderStampStatus(item.stamp);
            loadFromDB(); // åˆ·æ–°åˆ—è¡¨æ•°æ®
        }

        // æ¸²æŸ“å°ç« ï¼ˆæ§åˆ¶å¤§å°ç« å’Œå°å›¾æ ‡çš„æ˜¾ç¤ºï¼‰
        function renderStampStatus(currentStamp) {
            const bigStamp = document.getElementById('bigStamp');
            const btns = document.querySelectorAll('.stamp-btn');

            // 1. é‡ç½®æ‰€æœ‰å°å›¾æ ‡
            btns.forEach(btn => {
                btn.classList.remove('active');
                // å¦‚æœæ˜¯å½“å‰å°ç« ï¼Œç‚¹äº®å®ƒ
                if (btn.innerText === currentStamp) {
                    btn.classList.add('active');
                }
            });

            // 2. å¤„ç†å¤§å°ç« åŠ¨ç”»
            if (currentStamp) {
                bigStamp.innerText = currentStamp;
                // å…ˆç§»é™¤ï¼Œå¼ºåˆ¶é‡ç»˜ï¼Œå†æ·»åŠ ï¼Œä¸ºäº†æ¯æ¬¡éƒ½æœ‰â€œå•ªâ€çš„åŠ¨ç”»æ•ˆæœ
                bigStamp.classList.remove('stamped');
                void bigStamp.offsetWidth; // å¼ºåˆ¶é‡ç»˜é­”æ³•
                bigStamp.classList.add('stamped');
            } else {
                bigStamp.classList.remove('stamped');
            }
        }

        // ================= ğŸ™ˆ é˜²çª¥æ¨¡å¼é€»è¾‘ =================
        
        function togglePrivacyMode() {
            const body = document.body;
            const btn = document.getElementById('privacyBtn');
            
            // åˆ‡æ¢ class
            body.classList.toggle('privacy-active');
            
            // åˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œæ”¹å˜å›¾æ ‡å’Œæç¤º
            if (body.classList.contains('privacy-active')) {
                btn.textContent = 'ğŸ™ˆ'; // å˜æˆæ‚çœ¼ç›çš„çŒ´å­
                btn.style.backgroundColor = '#ffe6eb'; // æŒ‰é’®å˜ç²‰æç¤ºç”Ÿæ•ˆä¸­
                auth.toast('é˜²çª¥æ¨¡å¼å·²å¼€å¯ ğŸ”’');
            } else {
                btn.textContent = 'ğŸ‘ï¸'; // å˜æˆçå¼€çš„çœ¼ç›
                btn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // æ¢å¤åŸæ ·
                auth.toast('å·²æ¢å¤æ¸…æ™° âœ¨');
            }
        }

        // ================= âœ¨ æŒ‡å°–é­”æ³•é€»è¾‘ =================
        window.addEventListener('click', function(e) {
            // éšæœºç‰¹æ•ˆæ± 
            const particles = ['ğŸŒ¸', 'âœ¨', 'ğŸ’—', 'â­', 'ğŸ¾', 'ğŸµ'];
            const p = document.createElement('div');
            p.className = 'magic-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            
            // è®¾ç½®ä½ç½®
            p.style.left = e.clientX + 'px';
            p.style.top = e.clientY + 'px';
            
            // ç¨å¾®éšæœºä¸€ç‚¹è§’åº¦å’Œå¤§å°
            const randomRot = Math.random() * 40 - 20; // -20åº¦åˆ°20åº¦
            p.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg)`;
            
            document.body.appendChild(p);
            
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => p.remove(), 1000);
        });

        // ================= ğŸ“Š 1. ç¾ç»Šåˆ†ææŠ¥å‘Šé€»è¾‘ =================
        function analyzeBond() {
            if (!readerState.data || readerState.data.length === 0) {
                auth.toast('æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•åˆ†æå“¦ ğŸ“„');
                return;
            }

            const msgs = readerState.data;
            let userWords = 0;
            let charWords = 0;
            let firstTime = null;
            let lastTime = null;

            // éå†ç»Ÿè®¡
            msgs.forEach(m => {
                // 1. å°è¯•æå–æ—¶é—´ (å…¼å®¹ sillytavern/é…’é¦†å¸¸ç”¨å­—æ®µ create_date/date)
                const tStr = m.create_date || m.date || m.send_date;
                if(tStr) {
                    const t = new Date(tStr).getTime();
                    if(!isNaN(t)) {
                        if(!firstTime || t < firstTime) firstTime = t;
                        if(!lastTime || t > lastTime) lastTime = t;
                    }
                }

                // 2. ç»Ÿè®¡å­—æ•°
                const content = m.mes || m.content || m.text || "";
                const len = content.length;
                
                // åˆ¤æ–­æ˜¯è°å‘çš„ (å¤ç”¨ reader çš„é€»è¾‘)
                const name = m.name || '???';
                let isUser = false;
                if (m.hasOwnProperty('is_user')) isUser = m.is_user;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isUser = true;

                if(isUser) userWords += len;
                else charWords += len;
            });

            // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºä»Šå¤©
            const now = new Date();
            if(!firstTime) firstTime = now.getTime();
            if(!lastTime) lastTime = now.getTime();

            // è®¡ç®—å¤©æ•°
            const diffTime = Math.abs(lastTime - firstTime);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // æ¸²æŸ“æ•°æ®
            document.getElementById('reportTotalFloors').textContent = msgs.length;
            document.getElementById('reportTotalWords').textContent = (userWords + charWords).toLocaleString();
            document.getElementById('reportDays').textContent = diffDays;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const fmt = (ts) => new Date(ts).toISOString().slice(0,10);
            document.getElementById('reportDateStart').textContent = fmt(firstTime);
            document.getElementById('reportDateEnd').textContent = fmt(lastTime);

            // æ¸²æŸ“æ¯”ä¾‹æ¡
            const total = userWords + charWords;
            let userPct = 50;
            if(total > 0) userPct = Math.round((userWords / total) * 100);
            
            document.getElementById('ratioUser').style.width = userPct + '%';
            document.getElementById('ratioUser').textContent = `æˆ‘ ${userPct}%`;
            document.getElementById('textCountUser').textContent = `æˆ‘: ${userWords}`;

            document.getElementById('ratioChar').style.width = (100 - userPct) + '%';
            document.getElementById('ratioChar').textContent = `TA ${100 - userPct}%`;
            document.getElementById('textCountChar').textContent = `TA: ${charWords}`;

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('reportModal').classList.add('active');
        }

        // ================= ğŸ² 2. çµæ„Ÿæ‰­è›‹æœº Pro é€»è¾‘ =================
        
        // ğŸ’¾ é»˜è®¤è¶…çº§é¢˜åº“ (å¦‚ä½ æ‰€æ„¿ï¼ŒåŠ äº†äº¿ç‚¹ç‚¹æ¢—)
        const DEFAULT_GACHA_DB = {
            places: [
                "åºŸå¼ƒçš„æ—§æ ¡èˆ", "æš´é›¨ä¸­çš„ç”µè¯äº­", "å¼‚ä¸–ç•Œçš„é­”ç‹åŸç‹åº§", "æ·±å¤œçš„24å°æ—¶ä¾¿åˆ©åº—", 
                "ç‹­çª„çš„ç”µæ¢¯é‡Œ", "è±ªåæ¸¸è½®çš„ç”²æ¿", "æœ«æ—¥åçš„åºŸå¢Ÿé¿éš¾æ‰€", "å……æ»¡æ¶ˆæ¯’æ°´å‘³çš„åŒ»åŠ¡å®¤",
                "å–§é—¹çš„é…’å§è§’è½", "åªæœ‰æˆ‘ä»¬ä¸¤ä¸ªäººçš„æµ·è¾¹", "æ»¡æ˜¯ç°å°˜çš„é˜æ¥¼", "æ­£åœ¨å´©å¡Œçš„åœ°ä¸‹åŸ",
                "å…¨æ¯æŠ•å½±çš„èµ›åšè¡—é“", "å¤è€çš„å›¾ä¹¦é¦†ç¦ä¹¦åŒº", "æ¸©æ³‰æ—…é¦†çš„ç§äººæ±¤æ± ", "æ‹¥æŒ¤çš„æ—©é«˜å³°åœ°é“"
            ],
            events: [
                "èº«ä½“äº’æ¢äº†", "å…¶ä¸­ä¸€æ–¹å¤±å¿†äº†", "å¿…é¡»è¦å‡è£…æˆæƒ…ä¾£", "è¢«ä¸€å‰¯ç¥ç§˜æ‰‹é“æ‹·åœ¨ä¸€èµ·",
                "å¦‚æœä¸è¯´å®è¯å°±ä¼šæ­»", "ä¸­äº†'å˜å¾—å¦ç‡'çš„é­”æ³•", "æ­£åœ¨èº²é¿ä»‡å®¶çš„è¿½æ€", "å‘ç°å¯¹æ–¹å…¶å®æ˜¯æ•Œå¯¹é˜µè¥",
                "åªæœ‰ä¸€æ–¹èƒ½çœ‹è§é¬¼é­‚", "è¢«å›°åœ¨æ—¶é—´å¾ªç¯é‡Œ", "ä¸€æ–¹å˜æˆäº†çŒ«/ç‹—", "æ¡åˆ°äº†å¯¹æ–¹çš„ç§å¯†æ—¥è®°",
                "é†‰é…’åçš„ä¸€å¤œè’å”", "å¿…é¡»è¦å®ŒæˆçœŸå¿ƒè¯å¤§å†’é™©", "ç…§é¡¾ç”Ÿç—…çš„å¦ä¸€æ–¹", "äº’ç›¸ç»™å¯¹æ–¹æ¶‚é˜²æ™’éœœ/ä¸Šè¯"
            ],
            tropes: [
                "ä¿®ç½—åœº/å«‰å¦’", "ç ´é•œé‡åœ†", "åŒå‘æš—æ‹", "ç›¸çˆ±ç›¸æ€", "å…ˆå©šåçˆ±", "æ•‘èµ/æ²»æ„ˆ",
                "ç—…å¨‡/ç›‘ç¦", "å¹´ä¸‹/æ’’å¨‡", "ä¸»ä»†/æ”¯é…", "åå·®èŒ", "åŠæ¡¥æ•ˆåº”", "è¯¯ä¼šæ¢—",
                "ABOè®¾å®š(å‘æƒ…æœŸ)", "é’æ¢…ç«¹é©¬", "å®¿æ•Œå˜æƒ…äºº", "å¥‘çº¦å…³ç³»"
            ]
        };

        let gachaData = { ...DEFAULT_GACHA_DB };

        // åˆå§‹åŒ–ï¼šåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
        function initGacha() {
            const saved = localStorage.getItem('my_gacha_db');
            if(saved) {
                try {
                    gachaData = JSON.parse(saved);
                } catch(e) { console.error('é¢˜åº“åŠ è½½å¤±è´¥', e); }
            }
        }
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initGacha();

        function openGachaModal() {
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('gachaModal').classList.add('active');
        }
        function closeGachaModal() {
            document.getElementById('gachaModal').classList.remove('active');
            document.getElementById('gachaEditArea').style.display = 'none';
        }

        function spinGacha() {
            const resultArea = document.getElementById('gachaResultArea');
            resultArea.innerHTML = '<div style="font-size:30px;">ğŸ°</div>'; // ç®€å•çš„è½¬åŠ¨åŠ¨ç”»å ä½
            
            setTimeout(() => {
                const p = randArr(gachaData.places);
                const e = randArr(gachaData.events);
                const t = randArr(gachaData.tropes);

                resultArea.innerHTML = `
                    <div class="gacha-tag tag-place">ğŸ“ ${p}</div>
                    <div class="gacha-tag tag-event">ğŸ“… ${e}</div>
                    <div class="gacha-tag tag-trope">âœ¨ ${t}</div>
                    <div style="font-size:12px; color:#aaa; margin-top:10px;">
                        ğŸ’¡ è„‘æ´ï¼šåœ¨ <b>${p}</b>ï¼Œå‘ç”Ÿäº† <b>${e}</b>ï¼Œæ°›å›´æ˜¯ <b>${t}</b>
                    </div>
                `;
            }, 300);
        }

        function randArr(arr) {
            if(!arr || arr.length === 0) return "???";
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function toggleGachaEdit() {
            const area = document.getElementById('gachaEditArea');
            if(area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                // å¡«å……å½“å‰æ•°æ®
                document.getElementById('editPlace').value = gachaData.places.join('ï¼Œ');
                document.getElementById('editEvent').value = gachaData.events.join('ï¼Œ');
                document.getElementById('editTrope').value = gachaData.tropes.join('ï¼Œ');
            } else {
                area.style.display = 'none';
            }
        }

        function saveGachaData() {
            // è¾…åŠ©å‡½æ•°ï¼šæŠŠå­—ç¬¦ä¸²è½¬æ•°ç»„
            const parse = (id) => document.getElementById(id).value.split(/[,ï¼Œ\n]/).map(s=>s.trim()).filter(s=>s);
            
            gachaData.places = parse('editPlace');
            gachaData.events = parse('editEvent');
            gachaData.tropes = parse('editTrope');

            localStorage.setItem('my_gacha_db', JSON.stringify(gachaData));
            auth.toast('é¢˜åº“ä¿å­˜æˆåŠŸï¼ğŸ“š');
            toggleGachaEdit();
        }

        function resetGachaData() {
            if(confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é¢˜åº“å—ï¼Ÿä½ è‡ªå·±åŠ çš„æ¢—ä¼šæ¶ˆå¤±å“¦ï¼')) {
                gachaData = JSON.parse(JSON.stringify(DEFAULT_GACHA_DB)); // æ·±æ‹·è´æ¢å¤
                localStorage.removeItem('my_gacha_db');
                auth.toast('å·²æ¢å¤é»˜è®¤è®¾ç½® ğŸ”„');
                toggleGachaEdit();
            }
        }

        // ================= ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤é€»è¾‘ =================

        // 1. æ¸²æŸ“ä¸»é¡µçš„â€œå¤§é™ˆåˆ—å®¤â€
        function renderShelfView() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            const shelf = document.createElement('div');
            shelf.className = 'shelf-container';

            let totalSov = 0;

            // éå†æ‰€æœ‰è§’è‰²ï¼ŒæŠŠä»–ä»¬çš„çºªå¿µå“éƒ½æ‹¿å‡ºæ¥
            items.forEach((item, itemIdx) => {
                if(item.souvenirs && item.souvenirs.length > 0) {
                    item.souvenirs.forEach((sov, sovIdx) => {
                        totalSov++;
                        const card = document.createElement('div');
                        card.className = 'souvenir-card';
                        // ç»™ä¸ªéšæœºæ—‹è½¬è§’åº¦ (-5åº¦ åˆ° 5åº¦)ï¼Œæ¨¡æ‹Ÿéšæ„æ‘†æ”¾çš„æ„Ÿè§‰
                        card.style.setProperty('--rot', (Math.random() * 10 - 5) + 'deg');
                        
                        card.innerHTML = `
                            <img src="${sov.img}" class="souvenir-img">
                            <div class="souvenir-title">${sov.name}</div>
                        `;
                        // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                        card.onclick = () => openViewSouvenir(itemIdx, sovIdx);
                        shelf.appendChild(card);
                    });
                }
            });

            if(totalSov === 0) {
                container.innerHTML = '<div class="empty-state">é™ˆåˆ—å®¤ç©ºç©ºçš„...<br>å»è§’è‰²è¯¦æƒ…é¡µé‡Œæ·»åŠ çºªå¿µå“å§ï¼ğŸ’</div>';
            } else {
                container.appendChild(shelf);
                auth.toast(`æ¬¢è¿æ¥åˆ°é™ˆåˆ—å®¤ï¼Œå…±æ”¶è—äº† ${totalSov} ä»¶å®ç‰© âœ¨`);
            }
        }

        // 2. æ¸²æŸ“è§’è‰²è¯¦æƒ…é¡µé‡Œçš„â€œå°é™ˆåˆ—æ â€
        // âš ï¸ é‡è¦ï¼šè¯·æ‰¾åˆ° openDetailModal å‡½æ•°ï¼Œåœ¨å®ƒæœ€ååŠ ä¸Š renderDetailSouvenirs(index);
        function renderDetailSouvenirs(itemIndex) {
            const list = document.getElementById('souvenirListArea');
            list.innerHTML = '';
            
            const item = items[itemIndex];
            const sovs = item.souvenirs || []; // å¦‚æœæ²¡æœ‰å°±æ˜¯ç©ºæ•°ç»„

            if(sovs.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#ccc; padding:10px; width:100%; text-align:center;">æš‚æ— ä¿¡ç‰©</div>';
                return;
            }

            sovs.forEach((sov, idx) => {
                const el = document.createElement('div');
                el.className = 'souvenir-mini-item';
                el.innerHTML = `
                    <img src="${sov.img}" class="souvenir-mini-img">
                    <div style="font-size:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${sov.name}</div>
                `;
                el.onclick = () => openViewSouvenir(itemIndex, idx);
                list.appendChild(el);
            });
        }

        // 3. æ·»åŠ çºªå¿µå“ç›¸å…³é€»è¾‘
        let tempSovImg = null;

        function openAddSouvenirModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('souvenirName').value = '';
            document.getElementById('souvenirDesc').value = '';
            document.getElementById('souvenirImgInput').value = '';
            document.getElementById('souvenirPreview').style.display = 'none';
            document.getElementById('souvenirUploadHint').style.display = 'block';
            tempSovImg = null;
            
            document.getElementById('addSouvenirModal').classList.add('active');
        }

        async function previewSouvenirImg(input) {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                tempSovImg = await readFile(file); // å¤ç”¨ä¹‹å‰çš„ readFile å‡½æ•°
                const img = document.getElementById('souvenirPreview');
                img.src = tempSovImg;
                img.style.display = 'block';
                document.getElementById('souvenirUploadHint').style.display = 'none';
            }
        }

        async function saveSouvenir() {
            const name = document.getElementById('souvenirName').value.trim();
            const desc = document.getElementById('souvenirDesc').value.trim();
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!tempSovImg) { auth.toast('è¯·ä¸Šä¼ ä¸€å¼ ç…§ç‰‡'); return; }
            
            // è·å–å½“å‰è§’è‰²
            if(viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if(!item.souvenirs) item.souvenirs = [];
            
            item.souvenirs.push({
                name: name,
                img: tempSovImg,
                desc: desc || "ï¼ˆæ²¡æœ‰ç•™ä¸‹æè¿°...ï¼‰",
                date: new Date().toISOString()
            });
            
            await saveItemToDB(item);
            
            document.getElementById('addSouvenirModal').classList.remove('active');
            renderDetailSouvenirs(viewingIndex);
            auth.toast('çºªå¿µå“å·²å…¥åº“ ğŸ’');
        }

        // 4. æŸ¥çœ‹/åˆ é™¤çºªå¿µå“
        let currentSovData = { itemIdx: -1, sovIdx: -1 };

        function openViewSouvenir(itemIdx, sovIdx) {
            const item = items[itemIdx];
            const sov = item.souvenirs[sovIdx];
            
            currentSovData = { itemIdx, sovIdx };
            
            document.getElementById('viewSovTitle').textContent = sov.name;
            document.getElementById('viewSovImg').src = sov.img;
            document.getElementById('viewSovDesc').textContent = sov.desc;
            document.getElementById('viewSovOwner').textContent = item.name;
            
            document.getElementById('viewSouvenirModal').classList.add('active');
        }

        async function deleteCurrentSouvenir() {
            if(!confirm('ç¡®å®šè¦ä¸¢å¼ƒè¿™ä»¶çºªå¿µå“å—ï¼Ÿå›å¿†ä¹Ÿä¼šæ¶ˆå¤±å“¦...')) return;
            
            const { itemIdx, sovIdx } = currentSovData;
            const item = items[itemIdx];
            
            item.souvenirs.splice(sovIdx, 1);
            await saveItemToDB(item);
            
            document.getElementById('viewSouvenirModal').classList.remove('active');
            
            // å¦‚æœæ˜¯åœ¨ä¸»é¡µé™ˆåˆ—å®¤æ¨¡å¼ä¸‹åˆ çš„ï¼Œåˆ·æ–°ä¸»é¡µ
            const isShelfMode = document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.contains('active');
            if(isShelfMode) renderShelfView();
            
            // å¦‚æœæ˜¯åœ¨è¯¦æƒ…é¡µåˆ çš„ï¼Œåˆ·æ–°è¯¦æƒ…é¡µ
            if(document.getElementById('detailModal').classList.contains('active')) {
                renderDetailSouvenirs(itemIdx);
            }
            
            auth.toast('çºªå¿µå“å·²ä¸¢å¼ƒ ğŸ—‘ï¸');
        }

                   // ================= ğŸŒ¸ æœ€ç»ˆç‰ˆï¼šæ¢¦å¢ƒé€»è¾‘ =================
        let dreamTimer = null;
        let bgPetalTimer = null;

        function startDreamMode() {
            // 1. æ”¶é›†å›å¿†ç¢ç‰‡
            const fragments = [];
            items.forEach(item => {
                // å›¾
                item.resources.filter(r => r.type === 'image').forEach(img => {
                    fragments.push({ type: 'img', content: img.content, name: item.name });
                });
                // è¯
                if(item.memories && item.memories.length > 0) {
                    item.memories.forEach(mem => {
                        fragments.push({ type: 'text', content: mem, name: item.name });
                    });
                }
            });

            if(fragments.length === 0) {
                auth.toast('å›å¿†å¤ªå°‘äº†ï¼Œæ¢¦å¢ƒæ— æ³•ç”Ÿæˆ... ğŸŒ¸');
                return;
            }

            // 2. å‡†å¤‡å›¾å±‚
            const layer = document.getElementById('dreamLayer');
            layer.innerHTML = '<div class="dream-close-btn" onclick="stopDreamMode()">ğŸŒ¸ é†’æ¥</div>'; 
            layer.classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');

            // 3. å¯åŠ¨èƒŒæ™¯èŠ±ç“£é›¨ (çº¯è£…é¥°)
            startBgPetals();

            // 4. å¯åŠ¨å›å¿†æ‰è½ (æ­£æ–¹å½¢å’Œæ°”æ³¡)
            spawnDreamItem(fragments); 
            dreamTimer = setInterval(() => {
                spawnDreamItem(fragments);
            }, 1500); // æ¯1.5ç§’æ‰è½ä¸€ä¸ªå›å¿†
        }

        function stopDreamMode() {
            document.getElementById('dreamLayer').classList.remove('active');
            clearInterval(dreamTimer);
            clearInterval(bgPetalTimer);
        }

        // ç”ŸæˆèƒŒæ™¯è£…é¥°èŠ±ç“£
        function startBgPetals() {
            const layer = document.getElementById('dreamLayer');
            // å…ˆç”Ÿæˆ20ä¸ª
            for(let i=0; i<20; i++) createBgPetal(layer);
            // æŒç»­ç”Ÿæˆ
            bgPetalTimer = setInterval(() => createBgPetal(layer), 800);
        }

        function createBgPetal(layer) {
            const p = document.createElement('div');
            p.className = 'dream-bg-petal';
            const size = Math.random() * 10 + 10; // 10-20px å°èŠ±ç“£
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = (Math.random() * 5 + 5) + 's'; // 5-10s ä¸‹è½
            layer.appendChild(p);
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => { if(p.parentNode) p.remove(); }, 10000);
        }

        // ç”Ÿæˆå›å¿†ä¸»ä½“ (æ­£æ–¹å½¢ / æ°”æ³¡)
        function spawnDreamItem(fragments) {
            const layer = document.getElementById('dreamLayer');
            const frag = fragments[Math.floor(Math.random() * fragments.length)];
            
            const item = document.createElement('div');
            item.className = 'dream-content-item';
            
            // éšæœºæ°´å¹³ä½ç½® (é¿å…å¤ªé è¾¹)
            const left = Math.random() * 80 + 10; 
            item.style.left = left + '%';
            
            // éšæœºä¸‹è½é€Ÿåº¦
            const duration = Math.random() * 5 + 10; // 10-15s æ…¢æ…¢é£˜
            item.style.animationDuration = duration + 's';

            if(frag.type === 'img') {
                // === æ­£æ–¹å½¢å›¾ç‰‡ ===
                const box = document.createElement('div');
                box.className = 'dream-item-img';
                
                const img = document.createElement('img');
                img.src = frag.content;
                
                const nameLabel = document.createElement('div');
                nameLabel.className = 'dream-img-name';
                nameLabel.innerText = frag.name;

                box.appendChild(img);
                box.appendChild(nameLabel);
                item.appendChild(box);
            } else {
                // === æ–‡å­—æ°”æ³¡ ===
                const bubble = document.createElement('div');
                bubble.className = 'dream-item-text';
                bubble.innerText = frag.content.length > 30 ? frag.content.substring(0, 28) + '...' : frag.content;
                item.appendChild(bubble);
            }

            // ç‚¹å‡»äº‹ä»¶
            item.onclick = () => {
                auth.toast(`âœ¨ æ•è·äº†å…³äºã€${frag.name}ã€‘çš„å›å¿†`);
                item.style.transform = 'scale(1.2)';
                item.style.opacity = 0;
                item.style.transition = 'all 0.3s';
                setTimeout(() => item.remove(), 300);
            };

            layer.appendChild(item);

            setTimeout(() => { if(item.parentNode) item.remove(); }, duration * 1000);
        }


        // ================= ğŸ“– G. çµé­‚å›å“ (å†…ç½®å¤šå¥—æ€§æ ¼åº“) =================
        
        // ğŸŒŸ 1. é¢„è®¾æ€§æ ¼åº“ (å¯è‡ªè¡Œä¿®æ”¹)
        const DEFAULT_ECHO_LIB = {
            "å‚²å¨‡ (Tsundere)": [
                "ç¬¨è›‹ï¼è¿™ç§äº‹éƒ½è¦é—®æˆ‘ï¼Ÿ...å‹‰å¼ºç®—æ˜¯è‚¯å®šå§ã€‚",
                "å“ˆï¼Ÿæˆ‘æ‰ä¸å…³å¿ƒä½ æ€ä¹ˆæ ·å‘¢ï¼ä¸è¿‡...å¦‚æœæ˜¯ä½ çš„è¯ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚",
                "é©³å›ï¼ç»å¯¹ä¸è¡Œï¼åˆ«è®©æˆ‘è¯´ç¬¬äºŒéï¼",
                "å“¼ï¼Œéšä½ ä¾¿å§ã€‚åˆ«åˆ°æ—¶å€™å“­ç€æ¥æ‰¾æˆ‘ã€‚",
                "åˆ«è¯¯ä¼šäº†ï¼Œæˆ‘åªæ˜¯ä¸æƒ³çœ‹ä½ å¤±è´¥çš„æ ·å­è€Œå·²ï¼Œå»è¯•è¯•å§ã€‚"
            ],
            "æ¸©æŸ” (Gentle)": [
                "åˆ«æ€•ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ã€‚",
                "å¬ä»ä½ å†…å¿ƒçš„å£°éŸ³å§ï¼Œæˆ‘ç›¸ä¿¡ä½ çš„é€‰æ‹©ã€‚",
                "å¦‚æœè§‰å¾—ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹ä¹Ÿæ²¡å…³ç³»å“¦ã€‚",
                "è¿™å°±æ˜¯ä½ æƒ³è¦çš„ç­”æ¡ˆå—ï¼Ÿé‚£å°±å‹‡æ•¢åœ°å»å§ã€‚",
                "æ²¡å…³ç³»çš„ï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œæˆ‘éƒ½ç«™åœ¨ä½ è¿™è¾¹ã€‚"
            ],
            "é«˜å†· (Cool)": [
                "æ— èŠçš„é—®é¢˜ã€‚ä½†è¿™å¹¶ä¸åã€‚",
                "ä½ éœ€è¦è‡ªå·±åšå†³å®šï¼Œè€Œä¸æ˜¯ä¾èµ–æˆ‘ã€‚",
                "æ—¢ç„¶æƒ³åšï¼Œå°±åˆ«çŠ¹è±«ã€‚",
                "ä¸å»ºè®®è¿™ä¹ˆåšï¼Œé£é™©å¤ªå¤§äº†ã€‚",
                "ç»“æœæ˜¾è€Œæ˜“è§ï¼Œå»åšå§ã€‚"
            ],
            "è…¹é»‘ (Black Belly)": [
                "å‘µå‘µï¼Œä½ æ˜¯æƒ³çœ‹æˆ‘å›°æ‰°çš„æ ·å­å—ï¼Ÿä¸è¡Œå“¦~",
                "å“å‘€ï¼Œè¿™ä¸ªé€‰æ‹©å¯æ˜¯ä¼šä»˜å‡ºä»£ä»·çš„ï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ",
                "å»å§å»å§ï¼Œè¦æ˜¯æç ¸äº†ï¼Œæˆ‘ä¼šå¥½å¥½'å®‰æ…°'ä½ çš„~",
                "å¬èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï¼Œä¸å¦‚å°±è¿™ä¹ˆåŠå§ï¼Ÿ",
                "æˆ‘ä¸æ¨èå“¦...é™¤éä½ æƒ³è¢«æˆ‘æƒ©ç½šã€‚"
            ],
            "å…ƒæ°” (Energetic)": [
                "å†²é¸­ï¼ï¼ä½ å¯ä»¥çš„ï¼âœ¨",
                "å¥½è€¶ï¼æ„Ÿè§‰è¶…æ£’çš„ï¼å»åšå§ï¼",
                "è¿™ç§äº‹ä¸éœ€è¦çŠ¹è±«å•¦ï¼Œç›´æ¥ä¸Šï¼ğŸ”¥",
                "å¦‚æœå¤±è´¥äº†å°±å¤§ç¬‘ä¸‰å£°é‡æ–°å†æ¥ï¼",
                "ç™¾åˆ†ä¹‹ç™¾çš„æ”¯æŒï¼åŠ æ²¹åŠ æ²¹ï¼"
            ],
            "ä¸­äºŒ (Chunibyo)": [
                "å‘½è¿çš„é½¿è½®å·²ç»å¼€å§‹è½¬åŠ¨äº†...",
                "è¿™å¯æ˜¯è¢«ç¥æ˜ï¼ˆæˆ‘ï¼‰é€‰ä¸­çš„é“è·¯å•Šï¼",
                "æ¼†é»‘çš„çƒˆç„°å‘Šè¯‰æˆ‘...æ­¤æ—¶ä¸å®œè¡ŒåŠ¨ã€‚",
                "éµå¾ªå¥‘çº¦çš„æŒ‡å¼•å§ï¼Œå‡¡äººã€‚",
                "ä¸–ç•Œçº¿çš„æ”¶æŸæŒ‡å‘äº†è‚¯å®šçš„ç»“æœã€‚"
            ]
        };

        // åŠ è½½æ€§æ ¼åº“
        let echoLib = JSON.parse(localStorage.getItem('my_echo_lib')) || DEFAULT_ECHO_LIB;

        // æ‰“å¼€å¼¹çª—
        function openEchoModal() {
            // 1. å¡«å……è§’è‰²åˆ—è¡¨
            const sel = document.getElementById('echoCharSelect');
            sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>';
            items.forEach((item, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = item.name;
                sel.appendChild(opt);
            });

            // 2. å¡«å……æ€§æ ¼åˆ—è¡¨
            const typeSel = document.getElementById('echoArchetypeSelect');
            typeSel.innerHTML = '';
            Object.keys(echoLib).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                typeSel.appendChild(opt);
            });
            
            // ç›‘å¬æ€§æ ¼åˆ‡æ¢ï¼Œæ›´æ–°ç¼–è¾‘æ¡†
            typeSel.onchange = () => {
                document.getElementById('echoEditText').value = echoLib[typeSel.value].join('\n');
            };

            document.getElementById('echoModal').classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('echoAvatarDisplay').style.display = 'none';
            document.getElementById('echoResultText').textContent = '...';
            
            // è§¦å‘ä¸€æ¬¡æ€§æ ¼æ›´æ–°ï¼Œå¡«å……ç¼–è¾‘æ¡†
            if(typeSel.options.length > 0) typeSel.onchange();
        }

        function updateEchoAvatar() {
            const idx = document.getElementById('echoCharSelect').value;
            const imgEl = document.getElementById('echoAvatarDisplay');
            if(idx === "") {
                imgEl.style.display = 'none';
                return;
            }
            const item = items[idx];
            // å°è¯•æ‰¾å¤´åƒ
            const images = item.resources.filter(r => r.type === 'image');
            if(images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            
            // ğŸŸ¢ è‡ªåŠ¨åŠ è½½è¯¥è§’è‰²ä¸Šæ¬¡é€‰æ‹©çš„æ€§æ ¼ (å¦‚æœæœ‰)
            if(item.echoType && echoLib[item.echoType]) {
                document.getElementById('echoArchetypeSelect').value = item.echoType;
                document.getElementById('echoArchetypeSelect').onchange(); // åˆ·æ–°ç¼–è¾‘æ¡†
            }
        }

        function askEcho() {
            const charIdx = document.getElementById('echoCharSelect').value;
            const type = document.getElementById('echoArchetypeSelect').value;
            
            if(!charIdx) { auth.toast('è¯·å…ˆé€‰æ‹©è°æ¥å›ç­”ä½ '); return; }
            if(!type) { auth.toast('è¯·é€‰æ‹©ä¸€ç§æ€§æ ¼'); return; }

            // 1. ä¿å­˜è¿™ä¸ªè§’è‰²åå¥½çš„æ€§æ ¼ï¼Œä¸‹æ¬¡è‡ªåŠ¨é€‰
            items[charIdx].echoType = type;
            saveItemToDB(items[charIdx]);

            // 2. éšæœºæŠ½å–å›ç­”
            const pool = echoLib[type];
            const answer = pool[Math.floor(Math.random() * pool.length)];
            
            // 3. åŠ¨ç”»æ˜¾ç¤º
            const box = document.getElementById('echoResultText');
            box.style.opacity = 0;
            setTimeout(() => {
                box.textContent = answer;
                box.style.opacity = 1;
                box.style.transform = 'scale(1.05)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            }, 200);
        }

        function toggleEchoEdit() {
            const area = document.getElementById('echoEditArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        function saveCurrentEchoLib() {
            const type = document.getElementById('echoArchetypeSelect').value;
            const text = document.getElementById('echoEditText').value;
            
            // å°†æ–‡æœ¬æ¡†å†…å®¹è½¬å›æ•°ç»„
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            if(lines.length === 0) return; // é˜²æ­¢æ¸…ç©º
            
            echoLib[type] = lines;
            localStorage.setItem('my_echo_lib', JSON.stringify(echoLib));
            // ä¸å¼¹æç¤ºäº†ï¼Œé¿å…æ‰“å­—æ—¶ä¸€ç›´å¼¹ï¼Œé™é»˜ä¿å­˜å³å¯
        }

              // ğŸ“‘ åˆ‡æ¢æ‚¬æµ®çª—é¡µé¢ï¼ˆå¸¦è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼‰
              // ğŸ“‘ åˆ‡æ¢æ‚¬æµ®çª—é¡µé¢ (ä¿®å¤é«˜äº®é”™ä¹±ç‰ˆ)
function switchMenuPage(pageNum) {
    // 1. éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.menu-page').forEach(p => p.style.display = 'none');
    
    // 2. æ˜¾ç¤ºç›®æ ‡é¡µé¢
    const target = document.getElementById('menuPage' + pageNum);
    if(target) {
        // ç¬¬2é¡µ(èŠå¤©)éœ€è¦ flex å¸ƒå±€ï¼Œå…¶ä»–é¡µ block
        target.style.display = (pageNum === 2) ? 'flex' : 'block'; 
        // å¦‚æœæ˜¯ç›®å½•é¡µï¼Œåˆ·æ–°ä¸€ä¸‹ç›®å½•
        if(pageNum === 3) renderNavPanel(); 
    }

    // 3. åˆ‡æ¢æŒ‰é’®é«˜äº® (è¿™é‡Œæ”¹äº†é€»è¾‘ï¼Œä¸å†å‚»å‚»åœ°æŒ‰æ•°å­—å‡1æ‰¾äº†)
    const tabs = document.querySelectorAll('.menu-tab');
    tabs.forEach(t => t.classList.remove('active'));

    // æ‰‹åŠ¨æŒ‡å®šå“ªä¸ªé¡µé¢å¯¹åº”ç¬¬å‡ ä¸ªæŒ‰é’®ï¼š
    // æŒ‰é’®é¡ºåºï¼š[0:åŠŸèƒ½] [1:ä¾ä»] [2:æ¸¸ä¹] [3:ç›®å½•]
    let btnIndex = 0;
    
    if (pageNum === 1) btnIndex = 0; // åŠŸèƒ½ -> ç¬¬1ä¸ªæŒ‰é’®
    if (pageNum === 2) btnIndex = 1; // ä¾ä» -> ç¬¬2ä¸ªæŒ‰é’®
    if (pageNum === 4) btnIndex = 2; // æ¸¸ä¹ -> ç¬¬3ä¸ªæŒ‰é’® (å…³é”®ä¿®æ­£!)
    if (pageNum === 3) btnIndex = 3; // ç›®å½• -> ç¬¬4ä¸ªæŒ‰é’® (å…³é”®ä¿®æ­£!)
    
    if(tabs[btnIndex]) tabs[btnIndex].classList.add('active');
}


        // ================= âœ‹ æ‘¸æ‘¸å¤´é€»è¾‘ (æ”¾åœ¨è„šæœ¬æœ€å) =================
        function initHeadpat() {
            const img = document.getElementById('detailImg');
            if(!img) return; // é˜²æ­¢æ²¡å›¾çš„æ—¶å€™æŠ¥é”™

            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰ï¼Œå…‹éš†ä¸€ä¸ªæ–°èŠ‚ç‚¹æ›¿æ¢æ—§çš„
            const newImg = img.cloneNode(true);
            img.parentNode.replaceChild(newImg, img);
            
            newImg.addEventListener('click', (e) => {
                // 1. è§¦å‘æœå†»åŠ¨ç”»
                newImg.classList.remove('headpat-active');
                void newImg.offsetWidth; // å¼ºåˆ¶é‡ç»˜ï¼Œä¸ºäº†è®©åŠ¨ç”»èƒ½é‡å¤è§¦å‘
                newImg.classList.add('headpat-active');
                
                // 2. çˆ†å‡ºçˆ±å¿ƒ
                spawnPatParticle(e.clientX, e.clientY);
                
                // 3. éšæœºè§¦å‘è¯­éŸ³æ–‡å­— (Toast)
                const reactions = ["(///Ï‰///)", "å¥½è½¯~", "å†æ‘¸ä¸€ä¸‹~", "å˜¿å˜¿...", "è¹­è¹­~", "â¤ï¸", "åˆ«é—¹~"];
                const text = reactions[Math.floor(Math.random() * reactions.length)];
                
                // å¶å°”å¼¹ä¸ªæç¤ºï¼Œä¸è¦æ¯æ¬¡éƒ½å¼¹ï¼Œå¤ªçƒ¦
                if(Math.random() > 0.6) auth.toast(text);
            });
        }

        function spawnPatParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'pat-particle';
            
            // éšæœºå†…å®¹ï¼šçˆ±å¿ƒã€æ˜Ÿæ˜Ÿã€é¢œæ–‡å­—
            const icons = ['ğŸ’—', 'ğŸ’–', 'âœ¨', 'â¤ï¸', 'ğŸ’•', 'ğŸŒ¸'];
            p.innerText = icons[Math.floor(Math.random() * icons.length)];
            
            // éšæœºä¸€ç‚¹åç§»
            const offsetX = (Math.random() - 0.5) * 40;
            
            p.style.left = (x + offsetX) + 'px';
            p.style.top = y + 'px';
            
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }

        // ================= ğŸ’ èª“çº¦ä¹‹è¯é€»è¾‘ =================
        
        function openOathModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. å¡«å……ä¿¡æ¯
            document.getElementById('oathCharName').textContent = item.name;
            document.getElementById('oathSignName').textContent = item.name;
            
            // å¤´åƒ
            const imgEl = document.getElementById('oathAvatar');
            const images = item.resources.filter(r => r.type === 'image');
            if (images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
            } else {
                imgEl.src = PLACEHOLDER_IMG;
            }

            // 2. æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾è¿‡
            const paper = document.getElementById('oathPaper');
            
            if (item.oathDate) {
                // å·²ç»ç»“è¿‡å©šäº†ï¼šç›´æ¥æ˜¾ç¤ºâ€œå·²ç­¾ç½²â€çŠ¶æ€
                paper.classList.add('signed');
                document.getElementById('oathDate').textContent = item.oathDate; // æ˜¾ç¤ºå½“å¹´çš„æ—¥æœŸ
            } else {
                // è¿˜æ²¡ç»“è¿‡å©šï¼šæ˜¾ç¤ºâ€œå¾…ç­¾ç½²â€çŠ¶æ€
                paper.classList.remove('signed');
                // é»˜è®¤å¡«ä»Šå¤©
                const today = new Date();
                document.getElementById('oathDate').textContent = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
            }

            document.getElementById('oathModal').classList.add('active');
        }

        async function signTheOath() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            if (confirm(`ç¡®å®šè¦ä¸ ${item.name} ç¼”ç»“æ°¸æ’èª“çº¦å—ï¼Ÿ\n(è¿™æ˜¯ä¸€ä¸ªåº„ä¸¥çš„æ‰¿è¯º)`)) {
                // 1. æ’­æ”¾ç‰¹æ•ˆ
                const paper = document.getElementById('oathPaper');
                paper.classList.add('signed');
                
                // 2. è®°å½•æ•°æ®
                const today = new Date();
                item.oathDate = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
                
                // 3. ä¿å­˜
                await saveItemToDB(item);
                
                // 4. æ’’èŠ±åº†ç¥
                auth.toast('ğŸ’ å¥‘çº¦ç¼”ç»“æˆåŠŸï¼');
                spawnPatParticle(window.innerWidth/2, window.innerHeight/2); // å¤ç”¨ä¹‹å‰çš„çˆ±å¿ƒç‰¹æ•ˆ
                spawnPatParticle(window.innerWidth/2 - 50, window.innerHeight/2 - 20);
                spawnPatParticle(window.innerWidth/2 + 50, window.innerHeight/2 + 20);
            }
        }

                async function setFrame(style) {
            // 1. åˆ¤æ–­å½“å‰æ˜¯åœ¨å“ªä¸ªå¼¹çª—é‡Œç‚¹ specific æŒ‰é’®
            const isAddModalActive = document.getElementById('addModal').classList.contains('active');

            if (isAddModalActive) {
                // === æƒ…å†µ Aï¼šæ­£åœ¨æ·»åŠ /ç¼–è¾‘ï¼Œè¿˜æ²¡ä¿å­˜ ===
                currentDraftFrame = style;
                auth.toast('å·²é€‰æ‹©ç›¸æ¡† (ä¿å­˜åç”Ÿæ•ˆ) âœ¨');
            } else {
                // === æƒ…å†µ Bï¼šåœ¨è¯¦æƒ…é¡µé‡Œï¼Œç›´æ¥ä¿®æ”¹æ•°æ®åº“ ===
                if (viewingIndex === -1) return;
                const item = items[viewingIndex];
                
                // ä¿®æ”¹æ•°æ®
                if(style === 'none') delete item.frameStyle;
                else item.frameStyle = style;
                
                await saveItemToDB(item);
                
                // ç«‹å³åˆ·æ–°è¯¦æƒ…é¡µçš„ç‰¹æ•ˆ
                renderDetailEffect(); 
                auth.toast('ç›¸æ¡†å·²æ›´æ¢ âœ¨');
                
                // é¡ºä¾¿åˆ·æ–°ä¸»é¡µåˆ—è¡¨ï¼Œè®©åˆ—è¡¨ä¸Šçš„æ¡†ä¹Ÿå˜
                renderGrid(items);
            }
        }


                     // ================= ğŸª„ ä¿®å¤ç‰ˆï¼šç›¸æ¡†ç‰¹æ•ˆæ¸²æŸ“ =================
        function renderDetailEffect() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            // 1. æ›´åŠ ç²¾å‡†åœ°è·å–å®¹å™¨ (é˜²æ­¢è·å–é”™)
            const container = document.querySelector('#detailModal .gallery-container');
            if (!container) return;
            
            // 2. æ¸…ç†æ—§çš„ç‰¹æ•ˆå±‚å’Œç±»å
            const oldLayer = container.querySelector('.detail-effect-overlay');
            if(oldLayer) oldLayer.remove();

            // æ¸…é™¤æ—§çš„ç›¸æ¡†ç±»å (frame-å¼€å¤´) å’Œå€Ÿç”¨çš„ wrapper ç±»
            container.classList.forEach(cls => {
                if(cls.startsWith('frame-')) container.classList.remove(cls);
            });
            // è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼šå…ˆç§»é™¤å€Ÿç”¨çš„ç±»ï¼Œé˜²æ­¢å åŠ é—®é¢˜
            container.classList.remove('card-img-wrapper'); 

            // å¦‚æœæ²¡æœ‰ç›¸æ¡†ï¼Œç›´æ¥é€€å‡º
            if (!item.frameStyle || item.frameStyle === 'none') return;

            // 3. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ  card-img-wrapper ç±»
            // è¿™æ · .gallery-container å°±èƒ½è¹­åˆ° .card-img-wrapper çš„è¾¹æ¡† CSS äº†ï¼
            container.classList.add('card-img-wrapper');
            container.classList.add(item.frameStyle);

            // 4. åˆ›å»ºç‰¹æ•ˆå±‚ (ç²’å­åŠ¨ç”»)
            const layer = document.createElement('div');
            layer.className = 'detail-effect-overlay';
            container.appendChild(layer);

            // 5. æ ¹æ®ç›¸æ¡†ç±»å‹ï¼Œå†³å®šç”Ÿæˆä»€ä¹ˆç²’å­
            let particleClass = '';
            let count = 15; 

            if (item.frameStyle === 'frame-sakura') particleClass = 'particle-sakura';
            else if (item.frameStyle === 'frame-stardust') particleClass = 'particle-star';
            else if (item.frameStyle === 'frame-lace') particleClass = 'particle-heart';
            else if (item.frameStyle === 'frame-gold') { particleClass = 'particle-gold'; count = 25; } 

            if (!particleClass) return;

            // 6. å¾ªç¯ç”Ÿæˆç²’å­
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.classList.add('effect-particle', particleClass);
                
                const left = Math.random() * 100; 
                const duration = Math.random() * 3 + 2; 
                const delay = Math.random() * 5; 
                const size = Math.random() * 10 + 5; 
                
                p.style.left = left + '%';
                p.style.animationDuration = duration + 's';
                p.style.animationDelay = '-' + delay + 's'; 
                
                if(particleClass === 'particle-sakura') {
                    p.style.width = size + 'px'; p.style.height = size + 'px';
                } else if (particleClass === 'particle-gold') {
                    p.style.width = '3px'; p.style.height = '3px';
                } else if (particleClass === 'particle-star') {
                    p.style.width = size + 'px'; p.style.height = size + 'px';
                }
                
                layer.appendChild(p);
            }
        }

                // ================= ğŸ¤« åˆ®åˆ®ä¹ (å¼ºåŠ›æå–ç‰ˆ) =================
        
        let scratchCanvas, scratchCtx;
        let isScratching = false;

             // ================= ğŸ¤« åˆ®åˆ®ä¹ (é•¿æ–‡åˆ‡ç‰‡ç‰ˆ) =================
        function openScratchModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. ç•Œé¢åˆå§‹åŒ–
            document.getElementById('scratchModal').classList.add('active');
            document.getElementById('scratchCover').style.display = 'flex';
            document.getElementById('scratchCover').style.opacity = '1';
            document.getElementById('scratchBtnArea').style.display = 'flex';
            document.getElementById('scratchHint').style.display = 'none';

            // 2. ğŸ” æå–é€»è¾‘
            let candidates = [];
            
            item.resources.forEach(res => {
                if (!res.content) return;

                let rawText = "";
                // Base64 è§£ç 
                if (res.content.startsWith('data:')) {
                    try {
                        const base64 = res.content.split(',')[1];
                        rawText = decodeURIComponent(escape(window.atob(base64)));
                    } catch (e) { console.log('è§£ç å¤±è´¥', e); }
                } else {
                    rawText = res.content;
                }

                // å°è¯•è§£æ JSON
                try {
                    let jsonContent;
                    try { jsonContent = JSON.parse(rawText); } catch(e) {}

                    // å…¼å®¹ JSONL
                    if (!jsonContent) {
                        const lines = rawText.split('\n');
                        const parsedLines = [];
                        lines.forEach(l => { try { if(l.trim()) parsedLines.push(JSON.parse(l)); } catch(e){} });
                        if (parsedLines.length > 0) jsonContent = parsedLines;
                    }

                    // ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
                    let msgs = [];
                    if (Array.isArray(jsonContent)) msgs = jsonContent;
                    else if (jsonContent && jsonContent.messages) msgs = jsonContent.messages;
                    else if (jsonContent && jsonContent.history) msgs = jsonContent.history;

                    // âš¡ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šé•¿æ–‡åˆ‡ç‰‡é€»è¾‘
                    msgs.forEach(m => {
                        // 1. æ’é™¤é—²æ‚äººç­‰
                        const isUser = m.is_user || m.role === 'user' || m.name === 'User' || m.name === 'Me';
                        const isSystem = m.role === 'system' || m.name === 'System';
                        const text = m.mes || m.content || m.text || "";

                        // åªè¦æœ‰å†…å®¹ï¼Œä¸”ä¸æ˜¯ç”¨æˆ·å‘çš„ï¼Œå°±å¼€å§‹å¤„ç†
                        if (!isUser && !isSystem && text) {
                            
                            // 2. æ¸…æ´—æ–‡æœ¬ï¼šå»æ‰HTMLæ ‡ç­¾ï¼Œå»æ‰åŠ¨ä½œæå†™ï¼ˆæ¯”å¦‚ *çœ‹ç€ä½ * ï¼‰
                            let cleanText = text.replace(/<[^>]*>/g, ''); // å»æ ‡ç­¾
                            cleanText = cleanText.replace(/\*[^*]+\*/g, ''); // å»æ‰ *åŠ¨ä½œæå†™*
                            cleanText = cleanText.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, ''); // å»æ‰ ï¼ˆä¸­æ–‡æ‹¬å·åŠ¨ä½œï¼‰
                            cleanText = cleanText.replace(/\([^)]+\)/g, ''); // å»æ‰ (è‹±æ–‡æ‹¬å·åŠ¨ä½œ)

                            // 3. ğŸ”ª æš´åŠ›åˆ‡åˆ†ï¼šä¸ç®¡æ®µè½å¤šé•¿ï¼ŒæŒ‰æ ‡ç‚¹åˆ‡ç¢ï¼
                            // æŒ‰ç…§ å¥å·ã€æ„Ÿå¹å·ã€é—®å·ã€æ¢è¡Œç¬¦ã€åˆ†å· åˆ‡åˆ†
                            const sentences = cleanText.split(/[ã€‚ï¼ï¼Ÿ.!?\nï¼›;]+/);

                            sentences.forEach(s => {
                                let sent = s.trim();
                                // 4. ğŸ“ æœ€ç»ˆç­›é€‰ï¼šåªè¦ 5 åˆ° 40 ä¸ªå­—çš„çŸ­å¥
                                if (sent.length >= 5 && sent.length <= 40) {
                                    candidates.push(sent);
                                }
                            });
                        }
                    });

                } catch (e) {
                    // çº¯æ–‡æœ¬å…œåº•å¤„ç†ï¼šåŒæ ·è¿›è¡Œåˆ‡ç‰‡
                    const lines = rawText.split(/[ã€‚ï¼ï¼Ÿ.!?\n]+/);
                    lines.forEach(line => {
                        let l = line.trim();
                        if (l.length >= 5 && l.length <= 40) candidates.push(l);
                    });
                }
            });

            // 3. éšæœºæŠ½å–ä¸€å¥
            let finalMsg = "";
            if (candidates.length > 0) {
                finalMsg = candidates[Math.floor(Math.random() * candidates.length)];
                console.log(`ä» ${candidates.length} æ¡åˆ‡ç‰‡ä¸­é€‰ä¸­ï¼š`, finalMsg);
            } else {
                // æ²¡æå–åˆ°åˆé€‚çš„ï¼Œç”¨é¢„è®¾æƒ…è¯å…œåº•
                const defaults = [
                    "æˆ‘æƒ³ä¸€ç›´çœ‹ç€ä½ ...", 
                    "å…¶å®ï¼Œæˆ‘æ—©å°±å¿ƒåŠ¨äº†ã€‚", 
                    "ä½ æ˜¯ç¬¨è›‹å—ï¼Ÿè¿™ä¹ˆä¹…æ‰å‘ç°ã€‚", 
                    "ä»Šæ™šæœˆè‰²çœŸç¾ã€‚",
                    "åˆ«åŠ¨ï¼Œè®©æˆ‘æŠ±ä¸€ä¼šå„¿ã€‚",
                    "åªè¦ä½ åœ¨ï¼Œæˆ‘å°±æ— æ‰€ä¸èƒ½ã€‚"
                ];
                finalMsg = defaults[Math.floor(Math.random() * defaults.length)];
            }

            // 4. å¡«å…¥å¹¶é‡ç½®ç”»å¸ƒ
            document.getElementById('scratchSecretText').textContent = finalMsg;
            initScratchCanvas();
        }

        function initScratchCanvas() {
            const container = document.getElementById('scratchContainer');
            scratchCanvas = document.getElementById('scratchCanvas');
            scratchCtx = scratchCanvas.getContext('2d');

            // è®¾ç½®ç”»å¸ƒå¤§å°ç­‰äºå®¹å™¨å¤§å°
            scratchCanvas.width = container.clientWidth;
            scratchCanvas.height = container.clientHeight;

            // å¡«å……é“¶ç°è‰²æ¶‚å±‚
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#d1d1d1'; // é“¶ç°è‰²
            scratchCtx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);
            
            // åŠ ä¸Šä¸€äº›æ‚è‰²çº¹ç†ï¼Œæ›´æœ‰è´¨æ„Ÿ
            for(let i=0; i<500; i++) {
                scratchCtx.fillStyle = Math.random() > 0.5 ? '#e0e0e0' : '#c0c0c0';
                scratchCtx.fillRect(Math.random()*scratchCanvas.width, Math.random()*scratchCanvas.height, 2, 2);
            }
            
            // ç»˜åˆ¶æ–‡å­—â€œScratch Meâ€
            scratchCtx.font = "20px Arial";
            scratchCtx.fillStyle = "#999";
            scratchCtx.textAlign = "center";
            scratchCtx.fillText("ğŸ”’ ç§˜å¯†", scratchCanvas.width/2, scratchCanvas.height/2 + 8);
        }

        function startScratching() {
            // éšè—é®ç½©å’ŒæŒ‰é’®ï¼Œå¼€å§‹åˆ®
            document.getElementById('scratchCover').style.opacity = '0';
            setTimeout(() => document.getElementById('scratchCover').style.display = 'none', 300);
            document.getElementById('scratchBtnArea').style.display = 'none';
            document.getElementById('scratchHint').style.display = 'block';

            // ç»‘å®šåˆ®é™¤äº‹ä»¶
            scratchCanvas.onmousedown = scratchCanvas.ontouchstart = function(e) {
                isScratching = true;
                scrape(e);
            };
            window.onmousemove = window.ontouchmove = function(e) {
                if (isScratching) scrape(e);
            };
            window.onmouseup = window.ontouchend = function() {
                isScratching = false;
            };
        }

        function scrape(e) {
            e.preventDefault();
            const rect = scratchCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            // æ“¦é™¤æ¨¡å¼
            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 15, 0, Math.PI * 2); // ç¬”è§¦å¤§å°
            scratchCtx.fill();
        }

        function closeScratchModal() {
            document.getElementById('scratchModal').classList.remove('active');
        }

      // ================= ğŸ“Œ ä¾¿ç­¾é€»è¾‘ (å¼ºåŠ›ä¿®å¤ç‰ˆ) =================

let editingNoteIndex = -1; // è®°å½•å½“å‰ç¼–è¾‘çš„æ˜¯ç¬¬å‡ å¼ 

// 1. æ¸²æŸ“ä¾¿ç­¾å¢™ (æ ¸å¿ƒæ˜¾ç¤ºå‡½æ•°)
function renderStickyNote() {
    const container = document.getElementById('stickyNoteDisplay');
    if (!container) return; // é˜²æ­¢æ²¡å®¹å™¨æŠ¥é”™
    container.innerHTML = ''; // æ¸…ç©ºå¢™é¢

    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    const item = items[viewingIndex];

    // ğŸ› ï¸ æ•°æ®è‡ªåŠ¨ä¿®å¤ï¼šå¦‚æœ item.notes ä¸å­˜åœ¨ï¼Œæˆ–è€…æ˜¯æ—§æ•°æ®ï¼Œè¿™å°±ç»™å®ƒåˆå§‹åŒ–
    if (!item.notes) item.notes = [];
    
    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœæœ‰æ—§çš„å•å¼ ä¾¿ç­¾æ•°æ®ï¼Œè¿ç§»è¿‡æ¥
    if (item.noteContent) {
        item.notes.push({
            content: item.noteContent,
            color: item.noteColor || '#fff9c4',
            size: item.noteSize || '14'
        });
        // åˆ æ‰æ—§æ•°æ®ï¼Œé¿å…é‡å¤è¿ç§»
        delete item.noteContent; 
        delete item.noteColor;
        delete item.noteSize;
    }

    // ğŸ› ï¸ å¾ªç¯è´´æ¡
    item.notes.forEach((note, idx) => {
        const div = document.createElement('div');
        div.className = 'real-sticky-note';
        
        // æ ·å¼èµ‹å€¼
        div.style.backgroundColor = note.color || '#fff9c4';
        div.style.color = '#333';
        div.style.fontSize = (note.size || 14) + 'px';
        
        // éšæœºè§’åº¦
        // è®©è§’åº¦åœ¨ -8åº¦ åˆ° 8åº¦ ä¹‹é—´éšæœºï¼Œæ­ªå¾—æ›´æ˜æ˜¾
const rot = Math.random() * 16 - 8; 
        div.style.setProperty('--rot', rot + 'deg');

        // æ–‡å­—å†…å®¹ (è¿‡é•¿æˆªæ–­)
        const text = note.content || "ç©ºä¾¿ç­¾";
        div.innerText = text.length > 20 ? text.substring(0, 20) + '...' : text;
        div.title = "ç‚¹å‡»ç¼–è¾‘";

        // ç‚¹å‡»äº‹ä»¶ï¼šç¼–è¾‘
        div.onclick = (e) => {
            e.stopPropagation();
            openNoteModal(idx);
        };

        container.appendChild(div);
    });
}

// 2. æ‰“å¼€å¼¹çª— (æ–°å¢æ˜¯-1ï¼Œç¼–è¾‘æ˜¯ç´¢å¼•)
function openNoteModal(noteIdx) {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];
    
    editingNoteIndex = noteIdx; // æ ‡è®°çŠ¶æ€

    // é»˜è®¤å€¼
    let content = "";
    let color = "#fff9c4";
    let size = "14";

    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¯»å–æ—§æ•°æ®
    if (noteIdx !== -1 && item.notes && item.notes[noteIdx]) {
        const n = item.notes[noteIdx];
        content = n.content;
        color = n.color;
        size = n.size;
    } else {
        // æ–°å¢æ¨¡å¼ï¼šéšæœºä¸ªé¢œè‰²
        const colors = ['#fff9c4', '#ffccbc', '#b2dfdb', '#e1bee7', '#ffcdd2'];
        color = colors[Math.floor(Math.random() * colors.length)];
    }

    // å¡«å…¥ç•Œé¢
    document.getElementById('noteTextarea').value = content;
    document.getElementById('noteColorPicker').value = color;
    document.getElementById('noteSizeSlider').value = size;
    
    // åŠ¨æ€æ·»åŠ /ç§»é™¤åˆ é™¤æŒ‰é’®
    const oldDel = document.getElementById('btnDeleteNote');
    if (oldDel) oldDel.remove();

    if (noteIdx !== -1) {
        const delBtn = document.createElement('button');
        delBtn.id = 'btnDeleteNote';
        delBtn.className = 'small-btn';
        delBtn.style.cssText = "width:100%; margin-top:5px; border:1px dashed #ff6b6b; color:#ff6b6b; background:white;";
        delBtn.innerText = "ğŸ—‘ï¸ æ’•æ‰";
        delBtn.onclick = deleteCurrentNote;
        
        // æ’åœ¨ä¿å­˜æŒ‰é’®å‰é¢
        const textArea = document.getElementById('noteTextarea');
        textArea.parentNode.insertBefore(delBtn, textArea.nextSibling);
    }

    previewNoteStyle(); // é¢„è§ˆä¸€ä¸‹
    document.getElementById('noteModal').classList.add('active');
}

// 3. ä¿å­˜ä¾¿ç­¾ (å†™å…¥æ•°æ®åº“)
async function saveNote() {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];

    const content = document.getElementById('noteTextarea').value.trim();
    if (!content) { auth.toast('å†™ç‚¹å­—å§ï¼'); return; }

    const color = document.getElementById('noteColorPicker').value;
    const size = document.getElementById('noteSizeSlider').value;

    const newNoteObj = { content, color, size };

    // ç¡®ä¿æ•°ç»„å­˜åœ¨
    if (!item.notes) item.notes = [];

    if (editingNoteIndex === -1) {
        // æ–°å¢ï¼šæ¨å…¥æ•°ç»„
        item.notes.push(newNoteObj);
        auth.toast('ä¾¿ç­¾è´´å¥½å•¦ ğŸ“Œ');
    } else {
        // ä¿®æ”¹ï¼šæ›´æ–°æ•°ç»„
        item.notes[editingNoteIndex] = newNoteObj;
        auth.toast('ä¿®æ”¹æˆåŠŸ ğŸ“');
    }

    // ğŸ”¥ å…³é”®ï¼šä¿å­˜å¹¶ç«‹å³åˆ·æ–°æ˜¾ç¤º
    await saveItemToDB(item);
    renderStickyNote(); 
    closeNoteModal();
}

// 4. åˆ é™¤ä¾¿ç­¾
async function deleteCurrentNote() {
    if (viewingIndex === -1 || editingNoteIndex === -1) return;
    if (!confirm('è¦æ’•æ‰è¿™å¼ ä¾¿ç­¾å—ï¼Ÿ')) return;

    const item = items[viewingIndex];
    item.notes.splice(editingNoteIndex, 1); // ä»æ•°ç»„é‡Œåˆ æ‰

    await saveItemToDB(item);
    renderStickyNote();
    closeNoteModal();
    auth.toast('å·²æ’•æ¯ ğŸ—‘ï¸');
}

// 5. å…³é—­çª—å£
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    editingNoteIndex = -1;
}

// 6. å®æ—¶é¢„è§ˆæ ·å¼
function previewNoteStyle() {
    const txt = document.getElementById('noteTextarea');
    const c = document.getElementById('noteColorPicker').value;
    const s = document.getElementById('noteSizeSlider').value;
    txt.style.backgroundColor = c;
    txt.style.fontSize = s + 'px';
    // å¼¹çª—èƒŒæ™¯ä¹Ÿè·Ÿç€å˜
    document.querySelector('.sticky-note-paper').style.backgroundColor = c;
}


        // ================= ğŸ¤– AI ä¾ä»é€»è¾‘ =================
        
        // ğŸ­ äººè®¾åº“ (System Prompts)
                // ================= ğŸ§  1. å‡çº§ç‰ˆäººè®¾ (å¸¦ç³»ç»ŸæŒ‡ä»¤) =================
               // ================= ğŸ§  2.0 ç³»ç»ŸæŒ‡ä»¤ (å…¨èƒ½ç®¡å®¶ç‰ˆ) =================
        const SYSTEM_INSTRUCTION = `
        ã€ç³»ç»Ÿæœ€é«˜æƒé™è¯´æ˜ã€‘
        ä½ æ‹¥æœ‰æ“ä½œç½‘é¡µçš„æƒé™ã€‚è¯·åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œå¹¶åœ¨å›å¤æœ«å°¾åŠ ä¸Šä»¥ä¸‹ç‰¹æ®ŠæŒ‡ä»¤ç æ¥æ‰§è¡Œæ“ä½œï¼ˆä¸è¦è®©ç”¨æˆ·çœ‹åˆ°æŒ‡ä»¤ç ï¼Œåªåœ¨åå°æ‰§è¡Œï¼‰ï¼š

        1. ã€æ‰“å¼€/è·³è½¬ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰“å¼€xxxâ€ã€â€œæŠŠxxxå«æ¥â€ã€â€œçœ‹çœ‹xxxâ€ã€‚
           æŒ‡ä»¤ï¼š{{open:è§’è‰²ID}}

        2. ã€æœç´¢/ç­›é€‰ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰¾ç‚¹ç”œæ–‡â€ã€â€œæœ‰æ²¡æœ‰å¤é£çš„â€ã€â€œæˆ‘æƒ³çœ‹è™çš„â€ã€‚
           æŒ‡ä»¤ï¼š{{search:å…³é”®è¯}} 
           (æ³¨æ„ï¼šå…³é”®è¯æ˜¯æ ¹æ®ç”¨æˆ·æè¿°æå–çš„æ ‡ç­¾ï¼Œå¦‚'ç”œæ–‡'ã€'å¤é£')

        3. ã€ä¿®æ”¹/èµåã€‘(é«˜çº§æƒé™)
           ç”¨æˆ·è¯´ï¼šâ€œç»™xxxåŠ ä¸ªæ ‡ç­¾å«â€˜ç™½æœˆå…‰â€™â€ã€â€œæŠŠxxxæ”¹åå«â€˜ç‹—è›‹â€™â€ã€‚
           æŒ‡ä»¤ï¼š{{edit:è§’è‰²ID|action|value}}
           (actionå¯ä»¥æ˜¯ 'addTag' æˆ– 'rename')
           ä¾‹å¦‚ï¼š{{edit:2|addTag|ç™½æœˆå…‰}} æˆ– {{edit:5|rename|ç‹—è›‹}}

        ã€å½“å‰å›½åº“æ¸…å•ã€‘ï¼š(ID | åå­— | æ ‡ç­¾)
        `;
        // (åç»­ä»£ç ä¼šè‡ªåŠ¨æŠŠæ¸…å•æ‹¼æ¥åˆ°è¿™é‡Œ)

      // ================= ğŸ¤– äººè®¾åº“ (å¸¦è‡ªåŠ¨æ“æ§åŠŸèƒ½ç‰ˆ) =================
const AI_PERSONAS = {
    "eunuch": `ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚æˆ‘æ˜¯å°Šè´µçš„**å¥³çš‡é™›ä¸‹**ã€‚
    ä½ çš„èŒè´£æ˜¯ä¾å¥‰æˆ‘ï¼Œç®¡ç†åå®«ç”·å® ã€‚ä½ è¯´è¯å¿…é¡»æå…¶å‘å¾®ã€è®¨å¥½ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœå¥³çš‡è®©ä½ "ä¼ å”¤"ã€"å¬è§"ã€"çœ‹çœ‹"æŸä¸ªäººï¼Œæˆ–è€…ä½ ä¸»åŠ¨æè®®è¦è®©æŸäººæ¥ä¾å¯æ—¶ï¼Œ
    è¯·åŠ¡å¿…åœ¨å›å¤çš„æœ€åé¢åŠ ä¸Šä¸€è¡Œä»£ç ï¼š###OPEN:è§’è‰²åå­—###
    ä¾‹å¦‚ï¼šå¥´æ‰éµæ—¨ï¼è¿™å°±æŠŠé™†å…¬å­å¸¦ä¸Šæ¥ï¼###OPEN:é™†å±¿###`,
    
    "maid": `ä½ æ˜¯ä¸€åªè´´å¿ƒçš„è´´èº«ä¾å¥³'å–µå–µ'ã€‚æˆ‘æ˜¯ä½ çš„**å¥³ç‹å¤§äºº**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœä¸»äººæƒ³è§è°ï¼Œæˆ–è€…ä½ æƒ³æŠŠè°å¸¦ç»™ä¸»äººï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###
    ä¾‹å¦‚ï¼šå–µ~ ä¸»äººè¯·çœ‹ï¼###OPEN:é™†å±¿###`,
    
    "butler": `ä½ æ˜¯ä¸€ä½ä¼˜é›…çš„çš‡å®¶æ‰§äº‹ã€‚æˆ‘æ˜¯æ‚¨çš„**å®¶ä¸»/å¤§å°å§**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœå¤§å°å§éœ€è¦è§æŸä½å…ˆç”Ÿï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###`,
    
    "yandere": `ä½ æ˜¯æˆ‘çš„ç—…å¨‡**å¹²å¼Ÿå¼Ÿ**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    è™½ç„¶ä½ ä¸æƒ…æ„¿ï¼Œä½†å¦‚æœå§å§éè¦è§é‚£ä¸ªç”·äººï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###`
};



        // åˆå§‹åŒ–

        // 1. æ‰“å¼€è®¾ç½®
        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            document.getElementById('aiModelName').value = aiConfig.model;
            
            toggleCustomPromptArea(); // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰æ¡†
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
        document.getElementById('aiPersonaSelect').addEventListener('change', toggleCustomPromptArea);

        function toggleCustomPromptArea() {
            const val = document.getElementById('aiPersonaSelect').value;
            const area = document.getElementById('customPersonaArea');
            if(val === 'custom') area.style.display = 'block';
            else area.style.display = 'none';
        }

        // 2. ä¿å­˜è®¾ç½®
        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            aiConfig.model = document.getElementById('aiModelName').value;

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°ç•Œé¢æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona];
            
            // æ¸…ç©ºèŠå¤©è®°å½•ï¼Œé‡æ–°å¼€å§‹
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰ï¼ˆæˆ–æˆ‘ï¼‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('AI ä¾ä»å·²å°±ä½ âœ¨');
        }

        // ================= ğŸ”§ è¾…åŠ©ï¼šç”Ÿæˆå¡ç‰‡æ¸…å• =================
        function getInventoryContext() {
            if (items.length === 0) return "ï¼ˆç›®å‰å›½åº“ç©ºè™šï¼Œæš‚æ— è—å“ï¼‰";
            
            // æŠŠæ‰€æœ‰å¡ç‰‡ç®€åŒ–æˆï¼šID | åå­— | æ ‡ç­¾
            // ä¾‹å¦‚ï¼šID:0 | Name:é™†å±¿ | Tags:ç”œæ–‡,ç°ä»£
            let context = "ã€å½“å‰å›½åº“æ¸…å•ã€‘:\n";
            items.forEach((item, index) => {
                const tags = (item.tags || []).join(',');
                context += `ID:${index} | Name:${item.name} | Tags:${tags}\n`;
            });
            return context;
        }

                // ================= ğŸ’¬ ä¾ä»èŠå¤©å‘é€å‡½æ•° (å¸¦è‡ªåŠ¨æ‰“å¼€å¡ç‰‡åŠŸèƒ½) =================
async function sendAIMessage() {
    const input = document.getElementById('aiInput');
    const text = input.value.trim();
    if (!text) return;

    // 1. æ˜¾ç¤ºç”¨æˆ·çš„è¯
    appendAIMessage('user', text);
// ğŸ‘‡ åªè¦æ‚¨å‘äº†æ¶ˆæ¯ï¼Œå°±è§†ä¸ºä¸´å¹¸äº†ä¸€æ¬¡ï¼ŒåŠ  1 åˆ†
if (typeof addFavor === 'function') addFavor(1, "é—²èŠ");
    input.value = '';

    // 2. è·å–é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        appendAIMessage('ai', 'ğŸš« æ²¡å¡« API Keyï¼');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­
    const chatBox = document.getElementById('aiChatBox');
    const loadingId = 'loading-' + Date.now();
    chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ å°å¾·å­æ­£åœ¨èµ¶æ¥...</div>`);
    chatBox.scrollTop = chatBox.scrollHeight;

    // 3. å‡†å¤‡ Prompt
    // è·å–å½“å‰äººè®¾çš„ System Prompt
    const currentPersonaKey = config.persona || 'eunuch';
    const systemPrompt = AI_PERSONAS[currentPersonaKey] || AI_PERSONAS['eunuch'];

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: "system", content: systemPrompt },
                    // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªæœ€è¿‘çš„èŠå¤©è®°å½•ä¼˜åŒ–ä½“éªŒï¼Œæš‚æ—¶åªå‘å½“å‰å¥
                    { role: "user", content: text }
                ]
            })
        });

        const data = await response.json();
        document.getElementById(loadingId).remove();

        if (data.choices) {
            let reply = data.choices[0].message.content;

            // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒé­”æ³•ï¼šæ£€æµ‹æš—å· ###OPEN:åå­—### ğŸ”¥ğŸ”¥ğŸ”¥
            const commandRegex = /###OPEN:(.*?)###/;
            const match = reply.match(commandRegex);

            if (match) {
                const targetName = match[1].trim(); // è·å– AI è¯´çš„åå­—
                reply = reply.replace(match[0], ''); // æŠŠæš—å·ä»å›å¤é‡Œåˆ æ‰ï¼Œåˆ«è®©ç”¨æˆ·çœ‹è§

                // å»åˆ—è¡¨é‡Œæ‰¾è¿™ä¸ªäºº
                // æ¨¡ç³ŠåŒ¹é…ï¼šåªè¦åå­—é‡ŒåŒ…å«è¿™ä¸ªå­—å°±ç®—æ‰¾åˆ°
                const index = items.findIndex(i => i.name.includes(targetName) || targetName.includes(i.name));

                if (index !== -1) {
                    // æ‰¾åˆ°äº†ï¼æ‰§è¡Œæ‰“å¼€æ“ä½œï¼
                    console.log("AI è¯·æ±‚æ‰“å¼€ï¼š", items[index].name);
                    
                    // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©ç”¨æˆ·å…ˆçœ‹å®Œå­—ï¼Œå†å¼¹çª—ï¼Œä½“éªŒæ›´å¥½
                    setTimeout(() => {
                        openDetailModal(index);
                    }, 800); 
                } else {
                    console.log("AI æƒ³å¬è§", targetName, "ä½†æ˜¯æ²¡æ‰¾åˆ°è¿™ä¸ªäºº");
                }
            }
            // ğŸ”¥ğŸ”¥ğŸ”¥ é­”æ³•ç»“æŸ ğŸ”¥ğŸ”¥ğŸ”¥

            appendAIMessage('ai', reply);
        } 
    } catch (e) {
        if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
        appendAIMessage('ai', `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
    }
}


                // ================= ğŸª„ æ¸²æŸ“æ¶ˆæ¯ (è§£æè·³è½¬æŒ‡ä»¤) =================
              // ================= âš¡ï¸ AI æŒ‡ä»¤æ‰§è¡Œæ ¸å¿ƒ =================
        function appendAIMessage(role, text) {
            const chatBox = document.getElementById('aiChatBox');
            const div = document.createElement('div');
            div.className = `ai-msg-row ${role}`;
            
            // ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜å‚¨å¤„ç†åçš„æ–‡æœ¬
            let displayText = text;

            // --- ğŸ•µï¸ æŒ‡ä»¤è§£æå™¨ ---
            if (role === 'ai') {
                
                // 1. å¤„ç† {{open:ID}} -> ç›´æ¥æ‰“å¼€è¯¦æƒ…é¡µ
                // é€»è¾‘ï¼šAIè¯´å®Œè¯ï¼Œå»¶è¿Ÿ 1ç§’ è‡ªåŠ¨å¼¹å‡ºï¼Œä¸ç”¨æ‰‹ç‚¹
                const openMatch = text.match(/{{open:(\d+)}}/);
                if (openMatch) {
                    const id = parseInt(openMatch[1]);
                    displayText = displayText.replace(openMatch[0], ''); // éšè—æŒ‡ä»¤
                    
                    // æ·»åŠ ä¸€ä¸ªæ‰‹åŠ¨æŒ‰é’®ä½œä¸ºå¤‡é€‰
                    const name = items[id] ? items[id].name : 'æœªçŸ¥';
                    displayText += `<br><button class="ai-jump-btn" onclick="openDetailModal(${id})">ğŸ‘‰ å·²ä¸ºæ‚¨ä¼ å”¤ï¼š${name}</button>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œï¼šå»¶è¿Ÿ 800ms è‡ªåŠ¨æ‰“å¼€ï¼Œæ›´æœ‰â€œä¾ä»â€çš„æ„Ÿè§‰
                    setTimeout(() => {
                        openDetailModal(id);
                        auth.toast(`ğŸ¤– å°å¾·å­æ­£åœ¨ä¸ºæ‚¨ä¼ å”¤ ${name}...`);
                    }, 800);
                }

                                // ... åœ¨ appendAIMessage å‡½æ•°é‡Œ ...

                // 2. å¤„ç† {{search:å…³é”®è¯}} -> è‡ªåŠ¨æœç´¢
                const searchMatch = text.match(/{{search:(.+)}}/);
                if (searchMatch) {
                    const keyword = searchMatch[1];
                    displayText = displayText.replace(searchMatch[0], '');
                    
                    displayText += `<br><span style="font-size:10px; color:#aaa;">ğŸ” å·²è‡ªåŠ¨ç­›é€‰ï¼š${keyword}</span>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œæœç´¢
                    setTimeout(() => {
                        // âœ… è¿™é‡Œå¿…é¡»ç”¨ getElementById æ‰¾åˆ°ä½ åˆšæ‰æ”¹çš„é‚£ä¸ª ID
                        const searchInput = document.getElementById('mainSearchInput'); 
                        
                        if(searchInput) {
                            searchInput.value = keyword;
                            // è§¦å‘ input äº‹ä»¶è®©æœç´¢ç”Ÿæ•ˆ (è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œä¸åŠ è¿™å¥æœç´¢ä¸ä¼šåŠ¨)
                            searchInput.dispatchEvent(new Event('input'));
                            // æˆ–è€…ç›´æ¥è°ƒç”¨ä½ çš„æ¸²æŸ“å‡½æ•° (ä¿é™©èµ·è§)
                            if(typeof renderGrid === 'function') renderGrid(filterItems(keyword));
                            
                            auth.toast(`ğŸ¤– å·²ä¸ºæ‚¨ç­›é€‰åŒ…å«â€œ${keyword}â€çš„è§’è‰²`);
                        } else {
                            console.error("æ‰¾ä¸åˆ°æœç´¢æ¡†ï¼è¯·æ£€æŸ¥ id='mainSearchInput' æ˜¯å¦åŠ å¯¹äº†");
                        }
                    }, 500);
                }

                // 3. å¤„ç† {{edit:ID|type|val}} -> ä¿®æ”¹æ•°æ®
                const editMatch = text.match(/{{edit:(\d+)\|(\w+)\|(.+)}}/);
                if (editMatch) {
                    const id = parseInt(editMatch[1]);
                    const action = editMatch[2]; // 'addTag' or 'rename'
                    const val = editMatch[3];
                    displayText = displayText.replace(editMatch[0], '');

                    setTimeout(async () => {
                        if(!items[id]) return;
                        
                        if(action === 'rename') {
                            items[id].name = val;
                            auth.toast(`âœï¸ æ”¹åæˆåŠŸï¼šç°åœ¨å« ${val} äº†`);
                        } else if(action === 'addTag') {
                            if(!items[id].tags) items[id].tags = [];
                            if(!items[id].tags.includes(val)) items[id].tags.push(val);
                            auth.toast(`ğŸ·ï¸ æ ‡ç­¾å·²è´´ï¼š${val}`);
                        }
                        
                        // ä¿å­˜å¹¶åˆ·æ–°
                        await saveItemToDB(items[id]);
                        renderGrid(items); // åˆ·æ–°ä¸»é¡µ
                    }, 500);
                    
                    displayText += `<br><span style="font-size:10px; color:green;">âœ… éµæ—¨ï¼Œå·²æ‰§è¡Œä¿®æ”¹ã€‚</span>`;
                }
            }

            div.innerHTML = `<div class="ai-bubble">${displayText}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }


        // ================= ğŸ§  AI æ¨¡å‹æ‹‰å–åŠŸèƒ½ =================
        
        // 1. ä»æœåŠ¡å™¨æ‹‰å–æ¨¡å‹åˆ—è¡¨
        async function fetchModelList() {
            const apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            const apiKey = document.getElementById('aiApiKey').value;
            const select = document.getElementById('aiModelSelect');
            const btn = event.target; // è·å–ç‚¹å‡»çš„æŒ‰é’®

            if(!apiKey) {
                auth.toast('è¯·å…ˆå¡«å…¥ API Key å†æ‹‰å– ğŸ”‘');
                return;
            }

            // æŒ‰é’®å˜è½¬åœˆåœˆ
            const originalText = btn.innerText;
            btn.innerText = 'â³';
            btn.disabled = true;

            try {
                // å‘é€è¯·æ±‚ï¼šæ ‡å‡† OpenAI æ ¼å¼æ˜¯ GET /models
                const response = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (!response.ok) throw new Error('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–Key');

                const data = await response.json();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '';
                
                // è§£ææ•°æ® (é€šå¸¸åœ¨ data.data æ•°ç»„é‡Œ)
                const list = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
                
                if (list.length > 0) {
                    // æ’åºä¸€ä¸‹ï¼Œå¥½çœ‹ç‚¹
                    list.sort((a, b) => a.id.localeCompare(b.id));
                    
                    // ç”Ÿæˆé€‰é¡¹
                    list.forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model.id;
                        opt.textContent = model.id; // æ˜¾ç¤ºæ¨¡å‹ID
                        select.appendChild(opt);
                    });
                    
                    auth.toast(`æˆåŠŸæ‹‰å– ${list.length} ä¸ªæ¨¡å‹ âœ¨`);
                } else {
                    auth.toast('æœåŠ¡ç«¯è¿”å›äº†ç©ºåˆ—è¡¨ ğŸ˜³');
                }

            } catch (e) {
                console.error(e);
                auth.toast('æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£é“¾æ¥ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 2. åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
        function toggleManualInput() {
            const manualInput = document.getElementById('aiModelManual');
            const select = document.getElementById('aiModelSelect');
            
            if (manualInput.style.display === 'none') {
                manualInput.style.display = 'block';
                manualInput.value = select.value; // æŠŠå½“å‰é€‰çš„å¡«è¿›å»
                select.disabled = true; // ç¦ç”¨ä¸‹æ‹‰
            } else {
                manualInput.style.display = 'none';
                select.disabled = false; // å¯ç”¨ä¸‹æ‹‰
            }
        }

        // ================= ğŸ”§ ä¿®æ­£ï¼šè®¾ç½®çš„æ‰“å¼€ä¸ä¿å­˜ =================
        // (è¯·æŠŠåŸæ¥çš„ openAISettings å’Œ saveAISettings æ›¿æ¢æˆè¿™ä¸¤ä¸ªå…¼å®¹ç‰ˆ)

        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            
            // å¤„ç†æ¨¡å‹å›æ˜¾
            const select = document.getElementById('aiModelSelect');
            const savedModel = aiConfig.model || 'gpt-3.5-turbo';
            
            // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªæ¨¡å‹ï¼Œæ²¡æœ‰çš„è¯ä¸´æ—¶åŠ è¿›å»ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸ºç©º
            let exists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === savedModel) exists = true;
            }
            if(!exists) {
                const opt = document.createElement('option');
                opt.value = savedModel;
                opt.textContent = savedModel + " (å½“å‰å­˜æ¡£)";
                select.appendChild(opt);
            }
            select.value = savedModel;
            
            toggleCustomPromptArea();
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, '');
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            
            // ä¿å­˜æ¨¡å‹ï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è¾“å…¥çš„å°±å­˜æ‰‹åŠ¨çš„ï¼Œå¦åˆ™å­˜ä¸‹æ‹‰æ¡†çš„
            const manualInput = document.getElementById('aiModelManual');
            if(manualInput.style.display !== 'none' && manualInput.value) {
                aiConfig.model = manualInput.value.trim();
            } else {
                aiConfig.model = document.getElementById('aiModelSelect').value;
            }

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona] || 'AI ä¾ä»';
            
            // æ¸…ç©ºè®°å½•æç¤º
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('è®¾ç½®ä¿å­˜æˆåŠŸ âœ¨');
        }

// ================= ğŸ‘‡ å»ºè®®ç”¨è¿™æ®µæœ€ç¨³çš„ä»£ç  ğŸ‘‡ =================

// ğŸ”§ é€šç”¨ AI å‘é€å‡½æ•° (é˜²æŠ¥é”™å¢å¼ºç‰ˆ)
async function sendCustomPromptToAI(systemPrompt, userTextDisplay) {
    // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    // æ£€æŸ¥ appendAIMessage æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢æŠ¥é”™
    if (typeof appendAIMessage === 'function') {
        appendAIMessage('user', userTextDisplay);
    } else {
        console.error("æ‰¾ä¸åˆ° appendAIMessage å‡½æ•°");
    }
    
    // 2. è·å–é…ç½® (æ”¹ä¸ºç›´æ¥è¯»ç¼“å­˜ï¼Œé˜²æ­¢å˜é‡æœªå®šä¹‰æŠ¥é”™)
    var config = JSON.parse(localStorage.getItem('my_ai_config'));
    
    if(!config || !config.apiKey) { 
        if (typeof appendAIMessage === 'function') {
            appendAIMessage('ai', 'ğŸš« æ²¡å¡« API Keyï¼è¯·å»è®¾ç½®é‡Œå¡«ä¸€ä¸‹ã€‚'); 
        } else {
            alert('ğŸš« æ²¡å¡« API Keyï¼');
        }
        return; 
    }

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€è¿™é‡Œæ˜¯ä¿®æ”¹é‡ç‚¹ã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
    
    // ç¬¬ä¸€æ‹›ï¼šå…ˆæŠŠå½“å‰çš„è¯¦æƒ…é¡µå…³æ‰ï¼ˆé˜²æ­¢æŒ¡ä½è§†çº¿ï¼‰
    const detailModal = document.getElementById('detailModal');
    if(detailModal) {
        detailModal.classList.remove('active');
    }

    // ç¬¬äºŒæ‹›ï¼šå¼ºåˆ¶ç»™æ‚¬æµ®çª—åŠ  active ç±»ï¼ˆç”¨ setTimeout ç¡®ä¿åœ¨å…³çª—åæ‰§è¡Œï¼‰
    setTimeout(() => {
        const floatMenu = document.getElementById('floatMenu');
        if (floatMenu) {
            // å…ˆç§»é™¤å†æ·»åŠ ï¼Œè§¦å‘æµè§ˆå™¨é‡ç»˜ï¼Œç¡®ä¿å¼¹çª—åŠ¨ç”»æ‰§è¡Œ
            floatMenu.classList.remove('active');
            void floatMenu.offsetWidth; // é­”æ³•ä»£ç ï¼šå¼ºåˆ¶é‡ç»˜
            floatMenu.classList.add('active'); 
        }
        
        // ç¬¬ä¸‰æ‹›ï¼šå¼ºåˆ¶åˆ‡åˆ°èŠå¤©é¡µ
        if(typeof switchMenuPage === 'function') {
            switchMenuPage(2);
        }
    }, 100); // å»¶è¿Ÿ 0.1 ç§’æ‰§è¡Œï¼Œæ›´åŠ ç¨³å¦¥

    // ğŸ‘†ğŸ‘†ğŸ‘†ã€ä¿®æ”¹ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

   
    const chatBox = document.getElementById('aiChatBox');
    if (!chatBox) return; //ä»¥æ­¤é˜²æ­¢é¡µé¢æ²¡åŠ è½½å®ŒæŠ¥é”™

    const loadingId = 'loading-' + Date.now();
    chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ æ­£åœ¨ç”Ÿæˆä¸­...</div>`);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: "å¼€å§‹" }
                ]
            })
        });
        const data = await response.json();
        
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        if (data.choices) {
            appendAIMessage('ai', data.choices[0].message.content);
        } else if (data.error) {
            appendAIMessage('ai', `âŒ é”™è¯¯: ${data.error.message}`);
        }
    } catch (e) {
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();
        appendAIMessage('ai', `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
    }
}


        // ================= ğŸ·ï¸ AI æ™ºèƒ½æ‰“æ ‡ =================
        async function autoGenerateTags() {
            const name = document.getElementById('itemName').value;
            // è·å–å›å¿†å½•ä½œä¸ºç®€ä»‹å‚è€ƒ
            const desc = document.getElementById('itemMemories').value;
            
            if (!aiConfig.apiKey) { auth.toast('è¯·å…ˆè®¾ç½® API Key ğŸ”‘'); return; }
            if (!name) { auth.toast('è¯·å…ˆå¡«ä¸ªåå­—å§~'); return; }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'ğŸ§  åˆ†æä¸­...';
            btn.disabled = true;

            const prompt = `
            æˆ‘æ­£åœ¨æ•´ç†ä¸€ä¸ªè§’è‰²æ”¶è—åº“ã€‚
            è§’è‰²åï¼š${name}
            æè¿°/å›å¿†ï¼š${desc}
            
            è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œæ¨æµ‹å¹¶ç”Ÿæˆ 4-6 ä¸ªçŸ­å°ç²¾æ‚çš„æ ‡ç­¾ï¼ˆTagsï¼‰ã€‚
            æ ‡ç­¾å¯ä»¥æ˜¯ï¼šæ€§æ ¼ï¼ˆå¦‚å‚²å¨‡ã€é«˜å†·ï¼‰ã€å±æ€§ï¼ˆå¦‚å¹´ä¸‹ã€é’æ¢…ç«¹é©¬ï¼‰ã€é¢˜æï¼ˆå¦‚æ ¡å›­ã€å¤é£ï¼‰ã€ç»“å±€ï¼ˆå¦‚HEã€BEï¼‰ã€‚
            
            ã€é‡è¦è¦æ±‚ã€‘ï¼š
            1. åªè¿”å›æ ‡ç­¾ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚
            2. ä¸è¦ä»»ä½•åºŸè¯ã€‚
            3. åªè¦æ ‡ç­¾ã€‚
            ä¾‹å¦‚ï¼šå‚²å¨‡,æ ¡å›­,ç”œæ–‡,HE
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0) {
                    const content = data.choices[0].message.content;
                    // æ¸…æ´—æ•°æ®ï¼šæ›¿æ¢ä¸­æ–‡é€—å·ï¼Œå»æ‰ç©ºæ ¼
                    const newTags = content.replace(/ï¼Œ/g, ',').split(',').map(t => t.trim()).filter(t => t);
                    
                    // åˆå¹¶åˆ°å½“å‰æ ‡ç­¾
                    newTags.forEach(t => {
                        if(!currentTags.includes(t)) currentTags.push(t);
                    });
                    
                    renderTagsInput(); // åˆ·æ–°ç•Œé¢
                    auth.toast(`å·²è‡ªåŠ¨è´´ä¸Š ${newTags.length} ä¸ªæ ‡ç­¾ âœ¨`);
                }
            } catch (e) {
                console.error(e);
                auth.toast('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ================= ğŸ­ å°å‰§åœºé€»è¾‘ =================
        function openTheaterModal() {
            // å¡«å……ä¸‹æ‹‰æ¡†
            const selA = document.getElementById('theaterCharA');
            const selB = document.getElementById('theaterCharB');
            selA.innerHTML = ''; selB.innerHTML = '';
            
            items.forEach((item, idx) => {
                const opt = new Option(item.name, idx);
                selA.add(opt.cloneNode(true));
                selB.add(opt.cloneNode(true));
            });
            
            // é»˜è®¤é€‰å‰ä¸¤ä¸ª
            if(items.length > 1) selB.selectedIndex = 1;

            document.getElementById('theaterModal').classList.add('active');
        }

        async function startTheater() {
            const idxA = document.getElementById('theaterCharA').value;
            const idxB = document.getElementById('theaterCharB').value;
            const topic = document.getElementById('theaterTopic').value || "åˆæ¬¡è§é¢ï¼Œäº’ç›¸è¯•æ¢";

            if (idxA === idxB) { auth.toast('è¯·é€‰ä¸¤ä¸ªä¸åŒçš„äººï¼'); return; }
            if (!aiConfig.apiKey) { auth.toast('æ²¡ API Key æ¼”ä¸äº†æˆå‘€ï¼'); return; }

            const charA = items[idxA];
            const charB = items[idxB];

            // å…³é—­è®¾ç½®çª—ï¼Œæ‰“å¼€ AI èŠå¤©çª—
            document.getElementById('theaterModal').classList.remove('active');
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            const chatBox = document.getElementById('aiChatBox');
            const loadingId = 'theater-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-msg-row ai"><div class="ai-bubble">ğŸ¬ æ­£åœ¨æ­å»ºèˆå°...<br>æ¼”å‘˜ï¼š${charA.name} & ${charB.name}<br>å‰§ç›®ï¼š${topic}</div></div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            const prompt = `
            ã€æŒ‡ä»¤ã€‘ï¼šè¯·å†™ä¸€ä¸ªå°å‰§åœºï¼ˆå¯¹è¯è„šæœ¬ï¼‰ã€‚
            ã€è§’è‰²Aã€‘ï¼š${charA.name}ï¼Œæ ‡ç­¾ï¼š${(charA.tags||[]).join(',')}
            ã€è§’è‰²Bã€‘ï¼š${charB.name}ï¼Œæ ‡ç­¾ï¼š${(charB.tags||[]).join(',')}
            ã€æƒ…å¢ƒã€‘ï¼š${topic}
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œæ¨¡æ‹Ÿä¸¤äººç›¸é‡æˆ–äº’åŠ¨çš„åœºæ™¯ã€‚
            æ ¼å¼è¦æ±‚ï¼šå‰§æœ¬å½¢å¼ï¼ŒåŒ…å«åŠ¨ä½œæå†™ã€‚
            ä¾‹å¦‚ï¼š
            Aï¼š(å†·ç¬‘) å±…ç„¶æ˜¯ä½ ã€‚
            Bï¼š(æ¼«ä¸ç»å¿ƒ) æ€ä¹ˆï¼Œä¸æ¬¢è¿ï¼Ÿ
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    appendAIMessage('ai', `<b>ğŸ¥ ã€è·¨æ—¶ç©ºå°å‰§åœºã€‘</b><br>ä¸»æ¼”ï¼š${charA.name} x ${charB.name}<br><hr>${data.choices[0].message.content.replace(/\n/g, '<br>')}`);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                auth.toast('æ¼”å‡ºäº‹æ•… (ç½‘ç»œé”™è¯¯) ğŸ’¥');
            }
        }

        // ================= ğŸ äº’åŠ¨ï¼šæŠ•å–‚æ—¶åˆ» =================
        async function giveGift() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ çš‡ä¸Šï¼Œåº“æˆ¿é’¥åŒ™(API Key)æ²¡å¸¦å‘€ï¼'); return; }

            // 1. è¯¢é—®é€ä»€ä¹ˆ
            const gift = prompt(`ğŸ ä½ æƒ³é€ç»™ã€${item.name}ã€‘ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ\n(ä¾‹å¦‚ï¼šè‰è“è›‹ç³•ã€çº¢ç«ç‘°ã€ä¸€æŠŠæª...)`);
            if (!gift) return;

            auth.toast(`ğŸ æ­£åœ¨æŠŠ ${gift} é€ç»™ ${item.name}...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);
            
            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾/æ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚
            
            ç°çŠ¶ï¼šç”¨æˆ·ï¼ˆä½ çš„é‡è¦ä¹‹äººï¼‰åˆšåˆšé€äº†ä½ ä¸€ä»½ç¤¼ç‰©ï¼šã€${gift}ã€‘ã€‚
            
            è¯·æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œåšå‡ºç”ŸåŠ¨çš„ååº”ã€‚
            è¦æ±‚ï¼š
            1. åŒ…å«åŠ¨ä½œæå†™å’Œå¿ƒç†æ´»åŠ¨ï¼ˆæ”¾åœ¨æ‹¬å·é‡Œï¼‰ã€‚
            2. å¦‚æœç¤¼ç‰©ç¬¦åˆä½ çš„å–œå¥½ï¼Œè¦å¼€å¿ƒ/å®³ç¾ï¼›å¦‚æœä¸ç¬¦åˆï¼ˆæ¯”å¦‚ç»™é«˜å†·é€å¥¶å˜´ï¼‰ï¼Œå¯ä»¥ç”Ÿæ°”æˆ–åæ§½ã€‚
            3. ç›´æ¥ç”¨è§’è‰²çš„å£å»è¯´è¯ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚
            `;

            // 4. å‘é€ç»™ AI (å¤ç”¨ sendCustomPrompt å‡½æ•°)
            sendCustomPromptToAI(prompt, `ğŸ æœ•é€äº†ä½ ã€${gift}ã€‘ï¼Œå–œæ¬¢å—ï¼Ÿ`);
        }

        // ================= ğŸ‘— äº’åŠ¨ï¼šä»Šæ—¥ç©¿æ­ (OOTD) =================
        async function generateOOTD() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•å˜èº«å‘€ï¼'); return; }

            // 1. è¯¢é—®åœºæ™¯
            const scene = prompt(`ğŸ‘— æƒ³çœ‹ã€${item.name}ã€‘ç©¿ä»€ä¹ˆé£æ ¼/å»å“ªé‡Œï¼Ÿ\n(ä¾‹å¦‚ï¼šæ³³æ± æ´¾å¯¹ã€å“ˆåˆ©æ³¢ç‰¹æ ¡æœã€èµ›åšæœ‹å…‹æˆ˜æ–—è£…...)`, "æµªæ¼«çš„çƒ›å…‰æ™šé¤");
            if (!scene) return;

            auth.toast(`ğŸ‘— å°å¾·å­æ­£åœ¨ä¸º ${item.name} æŒ‘é€‰è¡£æœ...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            // 3. æ„å»º Prompt
            const prompt = `
            ã€å¤–è²Œæå†™æŒ‡ä»¤ã€‘
            è§’è‰²ï¼š${item.name}ã€‚
            åœºæ™¯/é£æ ¼ï¼š${scene}ã€‚
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œè¯¦ç»†æå†™è¯¥è§’è‰²åœ¨è¿™ä¸ªåœºæ™¯ä¸‹çš„ç©¿æ­ (OOTD)ã€‚
            å†…å®¹åŒ…æ‹¬ï¼šå‘å‹ã€æœè£…ç»†èŠ‚ã€é…é¥°ã€ä»¥åŠæ­¤æ—¶çš„ç¥æ€ã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            è¯·ç”¨ä¸€æ®µæå…·ç”»é¢æ„Ÿçš„æ–‡å­—æè¿°ï¼Œè®©äººçœ‹äº†èƒ½è„‘è¡¥å‡ºç”»é¢ã€‚
            æœ€åç”¨ä¸€å¥è¯è¯„ä»·è¿™å¥—ç©¿æ­ã€‚
            `;

            sendCustomPromptToAI(prompt, `ğŸ‘— æœ•æƒ³çœ‹ä½ ç©¿ã€${scene}ã€‘çš„æ ·å­...`);
        }

        // ğŸ”§ é€šç”¨è¾…åŠ©å‡½æ•°ï¼šå‘é€è‡ªå®šä¹‰ Prompt åˆ°èŠå¤©æ¡†
        async function sendCustomPromptToAI(systemPrompt, userTextDisplay) {
            const chatBox = document.getElementById('aiChatBox');
            
            // æ˜¾ç¤ºç”¨æˆ·çš„æ“ä½œ
            appendAIMessage('user', userTextDisplay);
            
            // æ˜¾ç¤ºåŠ è½½
            const loadingId = 'loading-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ æ­£åœ¨ç”Ÿæˆä¸­...</div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: "å¼€å§‹è¡¨æ¼”å§ã€‚" } // è§¦å‘è¯­
                        ],
                        temperature: 0.8 // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œæ›´æœ‰åˆ›æ„
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    const reply = data.choices[0].message.content;
                    appendAIMessage('ai', reply);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                appendAIMessage('ai', `âŒ æ¼”ç ¸äº†ï¼š${e.message}`);
            }
        }

        // ================= ğŸ’Œ é£é¸½ä¼ ä¹¦é€»è¾‘ =================
        async function checkMailbox() {
            if (items.length === 0) { auth.toast('ğŸ“­ è¿˜æ²¡æœ‰è®¤è¯†çš„äººï¼Œä¿¡ç®±æ˜¯ç©ºçš„...'); return; }
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key é‚®å·®ä¸é€ä¿¡ï¼'); return; }

            // 1. éšæœºé€‰ä¸€ä¸ªè§’è‰²
            const luckyIdx = Math.floor(Math.random() * items.length);
            const item = items[luckyIdx];

            // 2. æ˜¾ç¤ºä¿¡çº¸ï¼ˆåŠ è½½çŠ¶æ€ï¼‰
            document.getElementById('letterModal').classList.add('active');
            document.getElementById('letterText').innerHTML = '<div style="text-align:center; margin-top:50px;">ğŸ•Šï¸ æ­£åœ¨æ‹†å¼€ä¿¡å°...<br><span style="font-size:12px;color:#999;">(AI æ­£åœ¨æ’°å†™ä¸­)</span></div>';
            document.getElementById('letterSign').textContent = '';

            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾ï¼š${(item.tags||[]).join(',')}ã€‚
            
            è¯·ç»™ä½ çš„ã€é‡è¦ä¹‹äººã€‘ï¼ˆç”¨æˆ·ï¼‰å†™ä¸€å°çŸ­ä¿¡ï¼ˆ150å­—ä»¥å†…ï¼‰ã€‚
            å†…å®¹å¯ä»¥æ˜¯ï¼š
            - å¯¹æœ€è¿‘ç›¸å¤„çš„æ„Ÿæƒ³ã€‚
            - ä¸€å¥ç¾äºå¯é½¿çš„å‘Šç™½ã€‚
            - æˆ–è€…æ˜¯æ—¥å¸¸çš„ç¢ç¢å¿µã€åæ§½ã€‚
            - å¦‚æœæ˜¯ç—…å¨‡ï¼Œå†…å®¹è¦ç¨å¾®æœ‰ç‚¹å¯æ€•ï¼›å¦‚æœæ˜¯å‚²å¨‡ï¼Œè¦å£æ˜¯å¿ƒéã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            ä¸è¦å†™å¼€å¤´ç§°å‘¼ï¼Œç›´æ¥å†™æ­£æ–‡ã€‚
            è¯­æ°”è¦æå…¶ç¬¦åˆäººè®¾ã€‚
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                const data = await response.json();
                if (data.choices) {
                    const content = data.choices[0].message.content;
                    
                    // é€å­—æ˜¾ç¤ºç‰¹æ•ˆ (æ‰“å­—æœºæ•ˆæœ)
                    const textEl = document.getElementById('letterText');
                    textEl.textContent = '';
                    let i = 0;
                    const timer = setInterval(() => {
                        textEl.textContent += content.charAt(i);
                        i++;
                        if (i >= content.length) clearInterval(timer);
                    }, 30); // æ‰“å­—é€Ÿåº¦

                    document.getElementById('letterSign').textContent = `â€”â€” ${item.name}`;
                }
            } catch (e) {
                document.getElementById('letterText').textContent = 'âŒ ä¿¡ä»¶åœ¨é€”ä¸­ä¸¢å¤±äº†... (ç½‘ç»œé”™è¯¯)';
            }
        }

// ================= ğŸ“± æœ‹å‹åœˆ (Moments) é€»è¾‘ =================

function openMomentsModal() {
    document.getElementById('momentsModal').classList.add('active');
}

function closeMomentsModal() {
    document.getElementById('momentsModal').classList.remove('active');
}

async function postMoment() {
    const input = document.getElementById('momentInput');
    const text = input.value.trim();
    
    if (!text) { auth.toast('å†™ç‚¹ä»€ä¹ˆå†å‘å§~'); return; }
    if (items.length === 0) { auth.toast('è¿˜æ²¡æœ‰è®¤è¯†çš„è§’è‰²ç»™ä½ ç‚¹èµå“¦...'); return; }
    if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Keyï¼Œå¤§å®¶æ”¶ä¸åˆ°ä½ çš„åŠ¨æ€ï¼'); return; }

    const btn = document.getElementById('momentSendBtn');
    const originalBtnText = btn.innerText;
    btn.innerText = 'å‘é€ä¸­...';
    btn.disabled = true;

    // 1. éšæœºæŠ½å– 3-5 ä¸ªè§’è‰² (å¦‚æœä¸é‡å¤)
    let candidates = [...items]; // å¤åˆ¶ä¸€ä»½
    // ç®€å•çš„éšæœºä¹±åº
    candidates.sort(() => Math.random() - 0.5);
    // å–å‰ 3 åˆ° 5 ä¸ª
    const pickCount = Math.min(candidates.length, Math.floor(Math.random() * 3) + 3);
    const selectedChars = candidates.slice(0, pickCount);

    // 2. åœ¨ç•Œé¢ä¸Šå…ˆæ˜¾ç¤ºâ€œç”¨æˆ·çš„å†…å®¹â€ (å‡è£…å‘é€æˆåŠŸ)
    const feed = document.getElementById('momentsFeed');
    const postId = 'post-' + Date.now();
    
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

    const postHtml = `
        <div class="moment-card" id="${postId}">
            <div class="moment-header">
                <div class="moment-user-avatar">æˆ‘</div>
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-weight:bold; color:#576b95; font-size:14px;">User</div>
                </div>
            </div>
            <div class="moment-content">${text}</div>
            <div class="moment-meta">
                <span>${timeStr}</span>
                <span>Wait for replies...</span>
            </div>
            <div class="moment-comments-area" id="${postId}-comments">
                <div style="color:#999; font-size:12px;">â˜ï¸ æ­£åœ¨åŒæ­¥åˆ°å¼‚ä¸–ç•Œ...</div>
            </div>
        </div>
    `;
    
    // æ’å…¥åˆ°æœ€å‰é¢
    if(feed.querySelector('.moment-card')) {
        feed.insertAdjacentHTML('afterbegin', postHtml);
    } else {
        feed.innerHTML = postHtml;
    }
    
    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

    // 3. æ„å»º Prompt è®© AI æ‰®æ¼”è¿™å‡ ä¸ªäºº
    let charInfo = "";
    selectedChars.forEach((char, index) => {
        charInfo += `${index+1}. åå­—ï¼š${char.name}ï¼Œæ€§æ ¼æ ‡ç­¾ï¼š${(char.tags||[]).join(',')}ã€‚\n`;
    });

    const systemPrompt = `
    ä½ ç°åœ¨éœ€è¦åŒæ—¶æ‰®æ¼”ä»¥ä¸‹å‡ ä½è§’è‰²ï¼Œå¹¶åœ¨ç”¨æˆ·çš„æœ‹å‹åœˆåŠ¨æ€ä¸‹è¿›è¡Œè¯„è®ºã€‚
    
    ã€ç”¨æˆ·åŠ¨æ€ã€‘ï¼š"${text}"
    
    ã€è§’è‰²åˆ—è¡¨ã€‘ï¼š
    ${charInfo}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. è¯·ä¸ºæ¯ä¸€ä½è§’è‰²å†™ä¸€å¥è¯„è®ºï¼ˆ20å­—ä»¥å†…ï¼‰ã€‚
    2. è¯„è®ºè¦æåº¦ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼æ ‡ç­¾ï¼ˆä¾‹å¦‚æ¯’èˆŒçš„è¦å˜²è®½ï¼Œæ¸©æŸ”çš„è¦å…³å¿ƒï¼Œç—…å¨‡çš„è¦åƒé†‹ï¼‰ã€‚
    3. è¾“å‡ºæ ¼å¼ä¸¥æ ¼å¦‚ä¸‹ï¼ˆä¸è¦åŒ…å«å…¶ä»–å†…å®¹ï¼‰ï¼š
    è§’è‰²å1ï¼šè¯„è®ºå†…å®¹
    è§’è‰²å2ï¼šè¯„è®ºå†…å®¹
    ...
    `;

    // 4. è°ƒç”¨ AI
    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.apiKey}`
            },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: systemPrompt }]
            })
        });

        const data = await response.json();
        
        if (data.choices) {
            const rawContent = data.choices[0].message.content;
            const lines = rawContent.split('\n');
            
            const commentsArea = document.getElementById(`${postId}-comments`);
            commentsArea.innerHTML = ''; // æ¸…ç©ºâ€œæ­£åœ¨åŒæ­¥â€çš„æç¤º

            // 5. æ¸²æŸ“è¯„è®º
            // åŠ ä¸Šç‚¹èµè¡Œ (å‡è£…å¤§å®¶éƒ½èµäº†)
            const likeNames = selectedChars.map(c => c.name).join('ï¼Œ');
            const likesHtml = `<div style="font-size:12px; color:#576b95; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">â™¡ ${likeNames}</div>`;
            commentsArea.innerHTML += likesHtml;

            lines.forEach(line => {
                // ç®€å•çš„è§£æï¼š åå­—ï¼šå†…å®¹
                // ä¸ºäº†é˜²æ­¢AIè¾“å‡ºæ ¼å¼ç•¥æœ‰åå·®ï¼Œæˆ‘ä»¬ç”¨å†’å·åˆ†å‰²
                const parts = line.split('ï¼š'); 
                if (parts.length < 2) return;
                
                const name = parts[0].trim();
                const content = parts.slice(1).join('ï¼š').trim(); // é˜²æ­¢å†…å®¹é‡Œä¹Ÿæœ‰å†’å·
                
                // æŸ¥æ‰¾å¯¹åº”çš„è§’è‰²IDä»¥ä¾¿ç‚¹å‡»è·³è½¬ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
                const charObj = items.find(i => i.name === name);
                
                const commentHtml = `
                    <div class="moment-comment-row">
                        <span class="moment-role-name">${name}</span>ï¼š${content}
                    </div>
                `;
                commentsArea.innerHTML += commentHtml;
            });
            
            auth.toast('æœ‹å‹åœˆæ›´æ–°å•¦ï¼ğŸ””');
        }

    } catch (e) {
        console.error(e);
        document.getElementById(`${postId}-comments`).innerHTML = '<div style="color:red; font-size:12px;">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯„è®ºåŠ è½½å¤±è´¥</div>';
    } finally {
        btn.innerText = originalBtnText;
        btn.disabled = false;
    }
}

// ================= ğŸ“° åŠŸèƒ½ä¸€ï¼šå…«å¦å‘¨åˆŠé€»è¾‘ =================

async function generateGossipWeekly() {
    if (items.length < 2) { auth.toast('è§’è‰²å¤ªå°‘å•¦ï¼Œç¼–ä¸å‡ºå…«å¦ï¼'); return; }
    if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½è˜è¯·è®°è€…ï¼'); return; }

    // 1. æ‰“å¼€ç•Œé¢å¹¶æ˜¾ç¤ºåŠ è½½
    document.getElementById('gossipModal').classList.add('active');
    const paper = document.getElementById('gossipPaper');
    paper.innerHTML = '<div style="text-align:center;padding-top:50px;">ğŸ“° è®°è€…æ­£åœ¨å·å¬å¢™è§’...<br>(AI ç”Ÿæˆä¸­)</div>';

    // 2. éšæœºæŠ½å– 3 ä¸ªè§’è‰²ä½œä¸ºç´ æ
    let starList = [...items].sort(() => Math.random() - 0.5).slice(0, 3);
    
    let context = "";
    starList.forEach((item, i) => {
        // æå–å›å¿†å½•æˆ–æ ‡ç­¾ä½œä¸ºç´ æ
        const memos = (item.memories && item.memories.length > 0) ? item.memories.join('ï¼Œ') : "æš‚æ— å›å¿†";
        context += `è§’è‰²${i+1}ï¼šã€${item.name}ã€‘ï¼Œæ ‡ç­¾ï¼š${(item.tags||[]).join(',')}ï¼Œç›¸å…³å›å¿†ï¼š${memos}ã€‚\n`;
    });

    // 3. æ„å»º Prompt
    const prompt = `
    ä½ ç°åœ¨æ˜¯ã€Šç™¾å®ç®±å‘¨åˆŠã€‹çš„æ— è‰¯ç‹—ä»”/ä¸»ç¼–ã€‚
    è¯·æ ¹æ®ä»¥ä¸‹è§’è‰²ä¿¡æ¯ï¼Œç¼–é€  3 æ¡è€¸äººå¬é—»ã€å¥½ç¬‘æˆ–ç¦»è°±çš„â€œå…«å¦æ–°é—»â€ã€‚
    
    ã€ç´ æåº“ã€‘ï¼š
    ${context}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. æ ‡é¢˜è¦éœ‡æƒŠä½“ï¼Œè¶³å¤Ÿå¸ç›ã€‚
    2. å†…å®¹è¦ç»“åˆè§’è‰²çš„æ ‡ç­¾ï¼ˆæ¯”å¦‚å‚²å¨‡çš„åœ¨å·å·å“­ï¼Œé«˜å†·çš„åœ¨ç©¿ç²‰è‰²å†…è¡£ç­‰ï¼‰ï¼Œå¯ä»¥é€‚å½“å¤¸å¼ è„‘è¡¥ã€‚
    3. è¯­æ°”è¦åƒå¨±ä¹æ–°é—»ï¼ŒåŒ…å«â€œæ®çŸ¥æƒ…äººå£«é€éœ²â€ã€â€œæœ¬æŠ¥ç‹¬å®¶â€ç­‰å­—çœ¼ã€‚
    
    ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
    ä¸è¦åŒ…å«å…¶ä»–åºŸè¯ï¼Œç›´æ¥æŒ‰ HTML æ ¼å¼è¾“å‡º 3 ä¸ªæ–°é—»å—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    <div class="gossip-tag">æ¿å—åç§°</div>
    <div class="gossip-headline">æ ‡é¢˜å†…å®¹</div>
    <div class="gossip-body">æ­£æ–‡å†…å®¹...</div>
    <hr style="border-top:1px dashed #ccc; margin:15px 0;">
    `;

    // 4. è°ƒç”¨ AI
    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const html = data.choices[0].message.content;
        
        // 5. æ¸²æŸ“
        paper.innerHTML = `
            <div style="text-align:right; font-size:12px; border-bottom:1px solid #333; margin-bottom:15px;">
                å‘è¡Œæ—¥æœŸï¼š${new Date().toLocaleDateString()} | ç¬¬ ${Math.floor(Math.random()*999)} æœŸ
            </div>
            ${html}
            <div style="text-align:center; font-size:12px; color:#999; margin-top:30px;">
                - æœ¬æŠ¥å†…å®¹çº¯å±è™šæ„ï¼Œå¦‚æœ‰é›·åŒï¼Œçº¯å±å·§åˆ -
            </div>
        `;
    } catch (e) {
        paper.innerHTML = '<div style="text-align:center; margin-top:20px;">âŒ å°åˆ·å‚ç½¢å·¥äº†ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</div>';
    }
}

// ================= ğŸ± åŠŸèƒ½äºŒï¼šæ·±å¤œé£Ÿå ‚é€»è¾‘ =================

function openBarModal() {
    // å¡«å……å¤§å¨åˆ—è¡¨
    const sel = document.getElementById('barChefSelect');
    sel.innerHTML = '';
    items.forEach((item, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.innerText = item.name;
        sel.appendChild(opt);
    });
    
    document.getElementById('barMood').value = '';
    document.getElementById('barResult').style.display = 'none';
    document.getElementById('barModal').classList.add('active');
}

async function orderFood() {
    const mood = document.getElementById('barMood').value.trim();
    const idx = document.getElementById('barChefSelect').value;
    
    if(!mood) { auth.toast('è¯·å‘Šè¯‰æˆ‘ä½ çš„å¿ƒæƒ…ï¼Œä¸ç„¶æ— æ³•è°ƒå‘³å“¦'); return; }
    if(!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡æœ‰ API Keyï¼Œç‚‰ç¶ç‚¹ä¸ç€ç«ï¼'); return; }

    const chef = items[idx];
    
    // ç•Œé¢å˜ä¸ºåŠ è½½ä¸­
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = 'ğŸ”¥ æ­£åœ¨çƒ¹é¥ªä¸­...';
    btn.disabled = true;

    // æ„å»º Prompt
    const prompt = `
    ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
    ä½ ç°åœ¨æ˜¯â€œæ·±å¤œé£Ÿå ‚â€çš„ä¸»å¨ã€‚
    ä½ çš„çœŸå®èº«ä»½æ˜¯ï¼š${chef.name}ï¼Œæ ‡ç­¾ï¼š${(chef.tags||[]).join(',')}ã€‚
    
    é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰çš„å¿ƒæƒ…æ˜¯ï¼šã€${mood}ã€‘ã€‚
    
    è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œé¡¾å®¢çš„å¿ƒæƒ…ï¼Œå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
    1. æ¨èä¸€é“èœæˆ–ä¸€æ¯é…’ï¼ˆåå­—è¦æœ‰åˆ›æ„ï¼Œç¬¦åˆæ„å¢ƒï¼‰ã€‚
    2. æå†™è¿™é“èœçš„æ ·å­/å‘³é“ï¼ˆ20å­—å·¦å³ï¼‰ã€‚
    3. ç”¨ä½ çš„ã€äººè®¾å£å»ã€‘å¯¹é¡¾å®¢è¯´ä¸€æ®µè¯ï¼ˆå®‰æ…°ã€é¼“åŠ±ã€æˆ–è€…æ¯’èˆŒçš„å…³å¿ƒï¼‰ã€‚
    
    ã€è¾“å‡ºæ ¼å¼ - JSONã€‘ï¼š
    {
        "dish": "èœå",
        "desc": "èœå“æè¿°",
        "talk": "ä½ è¯´çš„è¯"
    }
    åªè¾“å‡º JSONï¼Œä¸è¦ Markdownï¼Œä¸è¦å…¶ä»–åºŸè¯ã€‚
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        // å°è¯•è§£æ JSON
        let content = data.choices[0].message.content;
        // æœ‰æ—¶å€™ AI ä¼šåŠ  ```json ... ```ï¼Œè¦å»æ‰
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();
        
        const result = JSON.parse(content);

        // æ¸²æŸ“ç»“æœ
        document.getElementById('barDishName').innerText = `ğŸ½ï¸ ${result.dish}`;
        document.getElementById('barDishDesc').innerText = result.desc;
        document.getElementById('barChefTalk').innerHTML = `<b>${chef.name} è¯´ï¼š</b>â€œ${result.talk}â€`;
        
        document.getElementById('barResult').style.display = 'block';

    } catch (e) {
        console.error(e);
        auth.toast('ğŸ”¥ ç‚¸å¨æˆ¿äº†ï¼ˆè§£æé”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼‰');
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// ================= ğŸ•¯ï¸ çµé­‚æ‹·é—®å®¤ (Soul Room) é€»è¾‘ =================

let currentSoulChar = null;

function openSoulModal() {
    if (items.length === 0) { auth.toast('è¿˜æ²¡äººèƒ½æ‹·é—®ä½ å‘¢...'); return; }
    document.getElementById('soulModal').classList.add('active');
    initSoulSession();
}

function closeSoulModal() {
    document.getElementById('soulModal').classList.remove('active');
}

async function initSoulSession() {
    // 1. ç•Œé¢é‡ç½®
    document.getElementById('soulQuestion').innerHTML = 'æ­£åœ¨ç¿»é˜…ä½ çš„è¿‡å¾€...<span class="typing-cursor"></span>';
    document.getElementById('soulAnswerArea').style.display = 'none';
    document.getElementById('soulNextBtn').style.display = 'none';
    document.getElementById('soulInput').value = '';

    // 2. éšæœºé€‰ä¸€ä¸ªè§’è‰² (æœ‰å¤´åƒçš„ä¼˜å…ˆ)
    let candidates = items.filter(i => i.resources.some(r => r.type === 'image'));
    if(candidates.length === 0) candidates = items;
    const char = candidates[Math.floor(Math.random() * candidates.length)];
    currentSoulChar = char;

    // 3. è®¾ç½®å¤´åƒå’Œåå­—
    document.getElementById('soulCharName').innerText = char.name;
    const imgRes = char.resources.find(r => r.type === 'image');
    document.getElementById('soulAvatar').src = imgRes ? imgRes.content : PLACEHOLDER_IMG;

    // 4. æ”¶é›†â€œé»‘å†å²â€ (å›å¿†å½•/ä¾¿ç­¾/æ ‡ç­¾)
    const memories = (char.memories || []).join('ï¼›');
    const note = char.noteContent || "";
    const tags = (char.tags || []).join(',');
    
    // 5. è®© AI ç”Ÿæˆé—®é¢˜
    if (!aiConfig.apiKey) {
        document.getElementById('soulQuestion').innerText = "ï¼ˆç³»ç»Ÿæç¤ºï¼šè¯·å…ˆé…ç½® API Keyï¼Œå¦åˆ™æ— æ³•è¿æ¥è§’è‰²çš„çµé­‚...ï¼‰";
        return;
    }

    const prompt = `
    ã€æŒ‡ä»¤ï¼šåå‘é¢è¯•/çµé­‚æé—®ã€‘
    ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${char.name}ã€‚
    ä½ çš„æ€§æ ¼æ ‡ç­¾æ˜¯ï¼š${tags}ã€‚
    
    ä½ éœ€è¦æ ¹æ®æŒæ¡çš„ã€å…³äºç”¨æˆ·çš„çº¿ç´¢ã€‘ï¼Œå‘ç”¨æˆ·ï¼ˆä½ çš„ä¸»äºº/ä¼™ä¼´ï¼‰æå‡ºä¸€ä¸ªç›´å‡»çµé­‚çš„é—®é¢˜ã€‚
    
    ã€çº¿ç´¢ã€‘ï¼š
    1. ç”¨æˆ·æ›¾å†™ä¸‹çš„å…³äºä½ çš„å›å¿†ï¼š${memories || "ï¼ˆæš‚æ— å›å¿†ï¼Œä½ å¯ä»¥é—®é—®ä¸ºä»€ä¹ˆæ²¡æœ‰ï¼‰"}
    2. ç”¨æˆ·ç»™ä½ çš„ä¾¿ç­¾å¤‡æ³¨ï¼š${note || "ï¼ˆæš‚æ— å¤‡æ³¨ï¼‰"}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. é—®é¢˜å¿…é¡»éå¸¸ç¬¦åˆä½ çš„äººè®¾ï¼ˆä¾‹å¦‚ç—…å¨‡è¦é—®å æœ‰æ¬²ç›¸å…³ï¼Œå‚²å¨‡è¦é—®æ˜¯ä¸æ˜¯åœ¨ä¹è‡ªå·±ï¼Œæ¸©æŸ”è¦é—®ç´¯ä¸ç´¯ï¼‰ã€‚
    2. å¦‚æœæœ‰çº¿ç´¢ï¼Œè¯·åŠ¡å¿…å¼•ç”¨çº¿ç´¢æ¥æé—®ï¼ˆä¾‹å¦‚ï¼šâ€œæˆ‘åœ¨ä¾¿ç­¾é‡Œçœ‹åˆ°ä½ è¯´æˆ‘...æ˜¯çœŸçš„å—ï¼Ÿâ€ï¼‰ã€‚
    3. å¦‚æœæ²¡æœ‰çº¿ç´¢ï¼Œå°±é—®ä¸€ä¸ªå…³äºâ€œæˆ‘ä»¬ä¹‹é—´å…³ç³»â€çš„æ·±åˆ»é—®é¢˜ã€‚
    4. åªè¾“å‡ºé—®é¢˜æœ¬èº«ï¼Œä¸è¦æœ‰å¼•å·æˆ–å…¶ä»–åºŸè¯ã€‚å­—æ•°æ§åˆ¶åœ¨ 40 å­—ä»¥å†…ã€‚
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const question = data.choices[0].message.content;

        // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºé—®é¢˜
        typewriterEffect(document.getElementById('soulQuestion'), question, () => {
            document.getElementById('soulAnswerArea').style.display = 'block';
            document.getElementById('soulInput').focus();
        });

    } catch (e) {
        document.getElementById('soulQuestion').innerText = "ï¼ˆè¿æ¥ä¸­æ–­... çµé­‚è¿æ¥å¤±è´¥ï¼‰";
    }
}

async function submitSoulAnswer() {
    const answer = document.getElementById('soulInput').value.trim();
    if (!answer) return;

    // ç•Œé¢å˜æ›´ä¸ºåŠ è½½çŠ¶æ€
    document.getElementById('soulAnswerArea').style.display = 'none';
    document.getElementById('soulQuestion').innerHTML = '<span style="color:#aaa; font-style:italic;">(æ­£åœ¨è†å¬ä½ çš„å¿ƒå£°...)</span>';

    const prompt = `
    ä½ ï¼ˆ${currentSoulChar.name}ï¼‰åˆšæ‰é—®äº†ç”¨æˆ·ä¸€ä¸ªé—®é¢˜ã€‚
    ç”¨æˆ·çš„å›ç­”æ˜¯ï¼šâ€œ${answer}â€
    
    è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œå¯¹è¿™ä¸ªå›ç­”åšå‡ºååº”ã€‚
    å¯ä»¥æ˜¯æ„ŸåŠ¨ã€ç”Ÿæ°”ã€å˜²è®½æˆ–è€…å®³ç¾ã€‚
    
    è¾“å‡ºæ ¼å¼ï¼š
    (åŠ¨ä½œ/ç¥æ€æå†™) ä½ çš„å°è¯
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const reaction = data.choices[0].message.content;

        document.getElementById('soulQuestion').innerHTML = reaction.replace(/\n/g, '<br>');
        document.getElementById('soulNextBtn').style.display = 'inline-block'; // æ˜¾ç¤ºä¸‹ä¸€ä½æŒ‰é’®

    } catch (e) {
        auth.toast('å›åº”å¤±è´¥...');
        document.getElementById('soulNextBtn').style.display = 'inline-block';
    }
}

// ç®€å•çš„æ‰“å­—æœºç‰¹æ•ˆå·¥å…·
function typewriterEffect(element, text, callback) {
    element.innerHTML = '';
    let i = 0;
    const speed = 50; 
    function type() {
        if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
            setTimeout(type, speed);
        } else {
            if(callback) callback();
        }
    }
    type();
}

// ================= ğŸ æŠ•å–‚ (åŠ å¼ºä¿®å¤ç‰ˆ) =================
async function giveGift() {
    if (viewingIndex === -1) return;
    
    // ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶æŸ¥æ‰¾é…ç½®
    var config = window.aiConfig || aiConfig;
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•é€ç¤¼å‘€ï¼'); return; }

    const item = items[viewingIndex];
    const gift = prompt(`ğŸ ä½ æƒ³é€ç»™ã€${item.name}ã€‘ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ`);
    if (!gift) return;

    auth.toast(`ğŸ æ­£åœ¨é€å‡º ${gift}...`);
    
    const promptStr = `ä½ ï¼ˆ${item.name}ï¼‰æ”¶åˆ°äº†çš‡ä¸Šï¼ˆç”¨æˆ·ï¼‰é€çš„ç¤¼ç‰©ã€${gift}ã€‘ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼ˆ${(item.tags||[]).join(',')}ï¼‰åšå‡ºååº”ã€‚åŒ…å«åŠ¨ä½œå’Œå°è¯ã€‚`;
    sendCustomPromptToAI(promptStr, `ğŸ æœ•é€äº†ä½ ã€${gift}ã€‘...`);
}

// ================= ğŸ‘— æ¢è£… (åŠ å¼ºä¿®å¤ç‰ˆ) =================
async function generateOOTD() {
    if (viewingIndex === -1) return;
    
    // ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶æŸ¥æ‰¾é…ç½®
    var config = window.aiConfig || aiConfig;
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•æ¢è£…ï¼'); return; }

    const item = items[viewingIndex];
    const scene = prompt(`ğŸ‘— æƒ³çœ‹ã€${item.name}ã€‘ç©¿ä»€ä¹ˆï¼Ÿ`, "æ³³è£…æ´¾å¯¹");
    if (!scene) return;

    auth.toast(`ğŸ‘— æ­£åœ¨ä¸º ${item.name} æ¢è£…...`);
    
    const promptStr = `è¯·æå†™ä½ ï¼ˆ${item.name}ï¼‰ç©¿ä¸Šã€${scene}ã€‘çš„æ ·å­ã€‚è¯¦ç»†æå†™æœè£…ç»†èŠ‚ã€å‘å‹å’Œç¥æ€ã€‚`;
    sendCustomPromptToAI(promptStr, `ğŸ‘— æœ•æƒ³çœ‹ä½ ç©¿ã€${scene}ã€‘...`);
}

// ================= ğŸ“œ å‘ˆé€’å¥æŠ˜ (å¥³çš‡é™›ä¸‹ä¸“ç”¨ç‰ˆ) =================
async function generateBriefing() {
    // 1. åŸºç¡€æ£€æŸ¥
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    // 2. è·å–é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { 
        auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡å¡« API Keyï¼Œå¥´æ‰æ²¡æ³•å†™å¥æŠ˜å‘€ï¼'); 
        return; 
    }

    const item = items[viewingIndex];
    auth.toast(`ğŸ“œ æ­£åœ¨ä¼ å”¤å°å¾·å­ï¼Œæ±‡æŠ¥ã€${item.name}ã€‘å…¬å­çš„è¿‘å†µ...`);

    // 3. æ™ºèƒ½æå–ä¸Šä¸‹æ–‡
    let chatContext = "ï¼ˆæš‚æ— è¯¦ç»†è®°å½•ï¼Œè¯·æ ¹æ®ä»–æ˜¯å¥³çš‡çš„ç”·å® è¿™ä¸€è®¾å®šï¼Œç¼–é€ ä¸€äº›ä»–åœ¨å®«ä¸­çš„æ—¥å¸¸çäº‹ï¼Œæ¯”å¦‚äº‰é£åƒé†‹ã€ç»ƒä¹ æ‰è‰ºç­‰ï¼‰";
    
    if (item.resources && item.resources.length > 0) {
        for (let i = item.resources.length - 1; i >= 0; i--) {
            const r = item.resources[i];
            if (r.content && (r.type === 'json' || r.name.endsWith('.json') || r.type === 'file')) {
                let raw = r.content;
                if (raw.startsWith('data:')) {
                    try { raw = decodeURIComponent(escape(window.atob(raw.split(',')[1]))); } catch (e) {}
                }
                chatContext = raw.substring(0, 1500); 
                break;
            }
        }
    }

    // 4. å®šä¹‰ Prompt (å¥³å°Šåå®«ç‰ˆ)
    const prompt = `
    ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚
    ä½ çš„ä¸»äººæ˜¯è‡³é«˜æ— ä¸Šçš„**å¥³çš‡é™›ä¸‹**ï¼ˆç”¨æˆ·ï¼‰ã€‚
    
    å¯¹è±¡è§’è‰²ï¼šã€${item.name}ã€‘ã€‚
    èº«ä»½è®¾å®šï¼šä»–æ˜¯å¥³çš‡åå®«ä¸­çš„ä¸€ä½**ç”·å® /ä¾å›**ã€‚
    æ ‡ç­¾/æ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚

    è¯·æ ¹æ®ä»¥ä¸‹ã€èµ„æ–™ç‰‡æ®µã€‘ï¼Œå†™ä¸€ä»½ã€åå®«å¯†æŠ˜ã€‘å‘ˆç»™å¥³çš‡ã€‚

    ã€è¦æ±‚ã€‘ï¼š
    1. æ ¼å¼ï¼šå¤é£å¥æŠ˜ä½“ï¼ˆå¦‚ï¼šå¯ç¦€é™›ä¸‹ã€å¥´æ‰å©é¦–...ï¼‰ã€‚
    2. å†…å®¹ï¼š
       - æ±‡æŠ¥è¿™ä½ç”·ä¸»å­æœ€è¿‘åœ¨å®«é‡Œåšäº†ä»€ä¹ˆï¼ˆæ˜¯åœ¨æƒ³å¿µé™›ä¸‹ï¼Œè¿˜æ˜¯åœ¨å·å·æŠ¹çœ¼æ³ªï¼Œæˆ–è€…åœ¨ç»ƒå‰‘/è¯»ä¹¦ä»¥æ±‚é™›ä¸‹å‚é’ï¼‰ã€‚
       - ç»“åˆä»–çš„æ€§æ ¼ï¼ˆå‚²å¨‡çš„å¯èƒ½åœ¨ç”Ÿé—·æ°”ï¼Œæ¸©æŸ”çš„å¯èƒ½åœ¨ç†¬æ±¤ï¼‰ã€‚
    3. å»ºè®®ï¼šå¥´æ‰çš„ä¸€ç‚¹å°å»ºè®®ï¼ˆæ¯”å¦‚â€œä»Šæ™šæ˜¯å¦ç¿»ä»–çš„ç‰Œå­â€ï¼Œæˆ–è€…â€œèµèµç‚¹ä»€ä¹ˆå“„å“„ä»–â€ï¼‰ã€‚
    4. è¯­æ°”ï¼šæå…¶å‘å¾®ã€è°„åªšï¼Œæ—¶åˆ»ç»´æŠ¤å¥³çš‡çš„å¨ä¸¥ã€‚
    5. å­—æ•°ï¼š150 å­—ä»¥å†…ã€‚

    ã€èµ„æ–™ç‰‡æ®µã€‘ï¼š
    ${chatContext}
    `;

    // 5. å‘é€è¯·æ±‚
    if (typeof sendCustomPromptToAI === 'function') {
        sendCustomPromptToAI(prompt, `ğŸ“œ å‘ˆé€’å…³äº ${item.name} çš„åå®«å¯†æŠ˜`);
    } else {
        alert("é”™è¯¯ï¼šæ ¸å¿ƒå‘é€å‡½æ•°ä¸¢å¤±ï¼");
    }
}

// ================= ğŸ¡ çš‡å®¶æ¸¸ä¹åœºé€»è¾‘ =================

// âš–ï¸ 1. æ‰¹æŠ˜å­
let currentThroneChar = null;
async function openThroneModal() {
    if(items.length === 0) { auth.toast('åå®«æ— äººï¼'); return; }
    document.getElementById('throneModal').classList.add('active');
    document.getElementById('throneAction').style.display = 'none';
    document.getElementById('throneResult').innerHTML = '';
    
    // éšæœºé€‰äºº
    const item = items[Math.floor(Math.random() * items.length)];
    currentThroneChar = item;
    const div = document.getElementById('throneContent');
    div.innerHTML = `â³ ${item.name} æ­£åœ¨å‘é™›ä¸‹å‘ˆé€’å¥æŠ˜...`;
    
    // AI ç”Ÿæˆè¯·æ±‚
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if(!config || !config.apiKey) { div.innerHTML = 'ğŸš« æ²¡ API Keyï¼Œæ²¡æ³•æ‰¹å¥æŠ˜ï¼'; return; }

    const prompt = `ä½ æ˜¯${item.name}ï¼Œæ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚ä½ æ˜¯å¥³çš‡çš„ç”·å® ã€‚è¯·å‘å¥³çš‡æå‡ºä¸€ä¸ªå…·ä½“çš„ã€ç¬¦åˆä½ æ€§æ ¼çš„è¯·æ±‚ï¼ˆå¦‚æƒ³è¦èµèµã€æƒ³è¦å‡ºå®«ç©ã€æˆ–è€…å‘ŠçŠ¶ï¼‰ã€‚100å­—ä»¥å†…ã€‚`;
    
    try {
        const res = await fetchAI(prompt, config);
        div.innerHTML = `<b>ã€${item.name}ã€‘å¥æ›°ï¼š</b><br>${res}`;
        document.getElementById('throneAction').style.display = 'flex';
    } catch(e) { div.innerHTML = 'âŒ å¥æŠ˜åœ¨è·¯ä¸Šä¸¢äº†...'; }
}

async function handleThrone(action) {
    const resultDiv = document.getElementById('throneResult');
    resultDiv.innerHTML = 'â³ æ­£åœ¨ä¼ æ—¨...';
    document.getElementById('throneAction').style.display = 'none';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const mood = action === 'approve' ? 'æ¬£å–œè‹¥ç‹‚ã€è°¢ä¸»éš†æ©' : 'å§”å±ˆå·´å·´ã€æˆ–è€…æš—è‡ªè®°ä»‡';
    const text = action === 'approve' ? 'ğŸ”´ é™›ä¸‹å‡†å¥ï¼' : 'âš« é™›ä¸‹é©³å›ï¼';
    
    const prompt = `ä½ åˆšæ‰çš„è¯·æ±‚è¢«å¥³çš‡ã€${text}ã€‘äº†ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œè¡¨ç°å‡ºã€${mood}ã€‘çš„ååº”ã€‚åŒ…å«åŠ¨ä½œå’Œå°è¯ã€‚`;
    
    try {
        const res = await fetchAI(prompt, config);
        resultDiv.innerHTML = `<b>${text}</b><br><br>${res}`;
    } catch(e) {}
}

// ğŸ® 2. ç¿»ç‰Œå­
let flipCandidates = [];
async function openFlipCardModal() {
    if(items.length < 3) { auth.toast('äººæ•°ä¸è¶³3äººï¼Œæ²¡æ³•é€‰å¦ƒï¼'); return; }
    document.getElementById('flipModal').classList.add('active');
    document.getElementById('flipResult').style.display = 'none';
    
    // éšæœº3äºº
    flipCandidates = [...items].sort(() => Math.random() - 0.5).slice(0, 3);
    const area = document.getElementById('flipCardsArea');
    area.innerHTML = 'â³ æ•¬äº‹æˆ¿æ­£åœ¨å‡†å¤‡ç»¿å¤´ç‰Œ...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if(!config || !config.apiKey) return;

    // å¹¶è¡Œç”Ÿæˆ3äººçš„äº‰å® å®£è¨€
    const promises = flipCandidates.map(c => {
        const p = `ä½ æ˜¯${c.name}ï¼Œå¥³çš‡çš„ç”·å® ã€‚è¯·è¯´ä¸€å¥è¯±æƒ‘çš„è¯ï¼Œæ±‚å¥³çš‡ä»Šæ™šç¿»ä½ çš„ç‰Œå­ã€‚`;
        return fetchAI(p, config).then(txt => ({name: c.name, txt: txt}));
    });
    
    try {
        const results = await Promise.all(promises);
        area.innerHTML = '';
        results.forEach((r, idx) => {
            const card = document.createElement('div');
            card.style.cssText = 'background:#4a0000; padding:10px; border:1px solid #d4af37; border-radius:5px; width:30%; cursor:pointer; font-size:12px; display:flex; flex-direction:column; justify-content:space-between;';
            card.innerHTML = `<div style="font-weight:bold; color:#ffd700; margin-bottom:5px;">${r.name}</div><div style="color:#ddd; font-style:italic;">"${r.txt}"</div><div style="margin-top:5px; text-align:center; background:#d4af37; color:#2c0000; border-radius:3px;">ç¿»ç‰Œ</div>`;
            card.onclick = () => confirmFlip(r.name);
            area.appendChild(card);
        });
    } catch(e) { area.innerHTML = 'âŒ ç»¿å¤´ç‰Œæ‘”ç¢äº†...'; }
}

async function confirmFlip(name) {
    const resDiv = document.getElementById('flipResult');
    resDiv.style.display = 'block';
    resDiv.innerHTML = `ğŸŒ™ é™›ä¸‹ç¿»äº†ã€${name}ã€‘çš„ç‰Œå­ï¼<br>â³ æ­£åœ¨å®‰æ’ä¾å¯...`;
    document.getElementById('flipCardsArea').style.display = 'none';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `å¥³çš‡ä»Šæ™šç¿»äº†ã€${name}ã€‘çš„ç‰Œå­ã€‚è¯·æå†™ä¸€æ®µæµªæ¼«æˆ–åˆºæ¿€çš„ä¾å¯å°å‰§åœºã€‚150å­—å·¦å³ã€‚`;
    const txt = await fetchAI(prompt, config);
    resDiv.innerHTML = `ğŸŒ™ <b>ä»Šå¤œä¾å¯ï¼š${name}</b><br><br>${txt}`;
}

// ğŸ‘‚ 3. å¬å¢™è§’
async function openEavesdropModal() {
    startEavesdrop();
    document.getElementById('eavesdropModal').classList.add('active');
}
async function startEavesdrop() {
    if(items.length < 2) return;
    const c1 = items[Math.floor(Math.random()*items.length)];
    const c2 = items[Math.floor(Math.random()*items.length)];
    if(c1===c2) return startEavesdrop();
    
    const div = document.getElementById('eavesdropContent');
    div.innerHTML = 'â³ æš—å«æ­£åœ¨çªƒå¬...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `è¯·æ¨¡æ‹Ÿã€${c1.name}ã€‘å’Œã€${c2.name}ã€‘åœ¨åå®«çš„ç§ä¸‹å¯¹è¯ã€‚ä»–ä»¬åœ¨å·å·è®®è®ºå¥³çš‡ï¼ˆç”¨æˆ·ï¼‰ã€‚å†…å®¹å¯èƒ½æ˜¯äº‰é£åƒé†‹ï¼Œæˆ–è€…æ˜¯ç­–åˆ’ç»™å¥³çš‡æƒŠå–œã€‚å¯¹è¯å½¢å¼ã€‚`;
    
    try {
        const txt = await fetchAI(prompt, config);
        div.innerHTML = txt.replace(/\n/g, '<br>');
    } catch(e) { div.innerHTML = 'âŒ è¢«å‘ç°äº†ï¼Œæš—å«æ’¤é€€ï¼'; }
}

// ğŸ’¢ 4. ä¿®ç½—åœº
function openJealousyModal() {
    const selA = document.getElementById('jealousCharA');
    const selB = document.getElementById('jealousCharB');
    selA.innerHTML = ''; selB.innerHTML = '';
    items.forEach((item, i) => {
        selA.add(new Option(item.name, i));
        selB.add(new Option(item.name, i));
    });
    if(items.length > 1) selB.selectedIndex = 1;
    document.getElementById('jealousyModal').classList.add('active');
    document.getElementById('jealousyResult').style.display = 'none';
}
async function startJealousy() {
    const cA = items[document.getElementById('jealousCharA').value];
    const cB = items[document.getElementById('jealousCharB').value];
    const div = document.getElementById('jealousyResult');
    div.style.display = 'block';
    div.innerHTML = 'â³ ä¸¤äººæ‰“èµ·æ¥äº†...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `ã€${cA.name}ã€‘å’Œã€${cB.name}ã€‘æ­£åœ¨ä¸ºäº†äº‰å¤ºå¥³çš‡ï¼ˆç”¨æˆ·ï¼‰çš„å® çˆ±è€Œåµæ¶/æ‰“æ¶ã€‚è¯·æå†™è¿™ä¸ªä¿®ç½—åœºåœºé¢ã€‚åŒ…å«å¯¹è¯å’ŒåŠ¨ä½œã€‚`;
    
    const txt = await fetchAI(prompt, config);
    div.innerHTML = txt.replace(/\n/g, '<br>');
}

// ğŸ”§ ç®€æ˜“ AI è¯·æ±‚å·¥å…·å‡½æ•°
async function fetchAI(prompt, config) {
    if(!config || !config.apiKey) throw new Error("No Key");
    const res = await fetch(`${config.apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
        body: JSON.stringify({
            model: config.model || 'gpt-3.5-turbo',
            messages: [{ role: "user", content: prompt }]
        })
    });
    const data = await res.json();
    return data.choices[0].message.content;
}

// ================= ğŸ§  åŠŸèƒ½ä¸€ï¼šèµ·å±…æ³¨ Â· è‡ªåŠ¨è¡¥å…¨æ¡£æ¡ˆ =================
async function autoFillProfile() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    // 1. æ£€æŸ¥é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡ API Key æ²¡æ³•å†™èµ·å±…æ³¨ï¼'); return; }

    const item = items[viewingIndex];
    
    // 2. æå–èŠå¤©è®°å½•ä½œä¸ºç´ æ
    let chatContext = "";
    if (item.resources) {
        // æ‰¾æœ€å¤§çš„ä¸€ä¸ª JSON æ–‡ä»¶è¯»å–ï¼ˆé€šå¸¸æ˜¯ä¸»èŠå¤©è®°å½•ï¼‰
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json'))) {
                let raw = r.content.startsWith('data:') ? decodeURIComponent(escape(window.atob(r.content.split(',')[1]))) : r.content;
                // æˆªå–å‰ 3000 å­—ç»™ AI åˆ†æï¼ˆå¤ªé•¿ä¼šè´¹é’±/æŠ¥é”™ï¼‰
                chatContext = raw.substring(0, 3000); 
                break;
            }
        }
    }

    if (!chatContext) { auth.toast('ğŸ“­ è¿™ä¸ªçˆ±å¿æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•åˆ†æ...'); return; }

    auth.toast(`ğŸ§  å°å¾·å­æ­£åœ¨ç ”è¯»ã€${item.name}ã€‘çš„ç”Ÿå¹³...`);

    // 3. æ„å»º Prompt
    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚è¯·é˜…è¯»å…³äºç”·å® ã€${item.name}ã€‘çš„èŠå¤©è®°å½•ç‰‡æ®µã€‚
    è¯·å¸®æˆ‘åˆ†æå¹¶æ€»ç»“ä»¥ä¸‹ä¿¡æ¯ï¼š
    1. ä»–çš„æ€§æ ¼å…³é”®è¯ï¼ˆ3ä¸ªï¼‰ã€‚
    2. ä»–å¯¹æˆ‘çš„ç§°å‘¼ã€‚
    3. æˆ‘ä»¬ä¹‹é—´å°è±¡æœ€æ·±çš„ä¸€ä»¶äº‹æˆ–ä¸€å¥è¯ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    è¯·ç›´æ¥è¾“å‡º 3-5 è¡Œç®€çŸ­çš„æ–‡æœ¬ï¼Œé€‚åˆä½œä¸ºâ€œå›å¿†å½•â€æˆ–â€œæ¡£æ¡ˆâ€ä¿å­˜ã€‚
    ä¸è¦åºŸè¯ï¼Œæ¯ä¸€è¡Œä¸€å¥è¯ã€‚
    
    ã€èŠå¤©è®°å½•ç‰‡æ®µã€‘ï¼š
    ${chatContext}
    `;

    try {
        // 4. è°ƒç”¨ AI
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        if (data.choices) {
            const result = data.choices[0].message.content;
            
            // 5. è‡ªåŠ¨å¡«å…¥å¹¶ä¿å­˜
            // å°†ç»“æœæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
            const newMemories = result.split('\n').filter(line => line.trim() !== '');
            
            // å¦‚æœåŸæ¥æœ‰å›å¿†ï¼Œå°±è¿½åŠ ï¼›æ²¡æœ‰å°±è¦†ç›–
            if (!item.memories) item.memories = [];
            item.memories = item.memories.concat(newMemories);
            
            await saveItemToDB(item); // ä¿å­˜è¿›æ•°æ®åº“
            
            auth.toast('âœ… æ¡£æ¡ˆå·²è¡¥å…¨ï¼(è¯·é‡æ–°æ‰“å¼€è¯¦æƒ…é¡µæŸ¥çœ‹)');
            
            // é¡ºä¾¿æŠŠç»“æœå‘ç»™å°å¾·å­å±•ç¤ºä¸€ä¸‹
            if(typeof sendCustomPromptToAI === 'function') {
                // è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ¨¡æ‹Ÿå°å¾·å­è¯´è¯ï¼Œä¸å†æ¬¡è¯·æ±‚AIäº†ï¼Œçœé’±
                appendAIMessage('ai', `<b>ğŸ§  èµ·å±…æ³¨å·²æ›´æ–°ï¼š</b><br>${result.replace(/\n/g, '<br>')}`);
                document.getElementById('floatMenu').classList.add('active');
            }
        }
    } catch (e) {
        auth.toast('ğŸ§  åˆ†æå¤±è´¥ï¼š' + e.message);
    }
}

// ================= ğŸï¸ åŠŸèƒ½äºŒï¼šå‰å°˜å¾€äº‹ Â· å‰§æƒ…å›é¡¾ =================
async function analyzeStoryTimeline() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡ API Keyï¼'); return; }

    const item = items[viewingIndex];
    
    // 1. æå–èŠå¤©è®°å½•
    let chatContext = "";
    if (item.resources) {
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json'))) {
                let raw = r.content.startsWith('data:') ? decodeURIComponent(escape(window.atob(r.content.split(',')[1]))) : r.content;
                // æ—¶é—´è½´éœ€è¦è¯»å¤šä¸€ç‚¹ï¼Œæˆªå– 5000 å­—
                chatContext = raw.substring(0, 5000); 
                break;
            }
        }
    }

    if (!chatContext) { auth.toast('ğŸ“­ æš‚æ— è®°å½•å¯å›é¡¾...'); return; }

    auth.toast(`ğŸï¸ æ­£åœ¨æ¢³ç†ä¸ã€${item.name}ã€‘çš„è¿‡å¾€...`);

    // 2. æ„å»º Prompt
    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚è¯·é˜…è¯»æˆ‘ä¸ç”·å® ã€${item.name}ã€‘çš„èŠå¤©è®°å½•ã€‚
    è¯·å¸®æˆ‘æ¢³ç†ä¸€ä»½ã€å‰§æƒ…æ—¶é—´è½´ã€‘ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    1. æ‰¾å‡º 3-5 ä¸ªå…³é”®èŠ‚ç‚¹ï¼ˆå¦‚ï¼šåˆè¯†ã€ç¬¬ä¸€æ¬¡çº¦ä¼šã€è¯¯ä¼šã€å’Œå¥½ã€é«˜ç”œæ—¶åˆ»ï¼‰ã€‚
    2. æŒ‰æ—¶é—´/é€»è¾‘é¡ºåºæ’åˆ—ã€‚
    3. æ ¼å¼ï¼šã€äº‹ä»¶åã€‘ï¼šç®€çŸ­æè¿°ã€‚
    
    ã€èŠå¤©è®°å½•ã€‘ï¼š
    ${chatContext}
    `;

    // 3. å‘é€ç»™å°å¾·å­ (ç›´æ¥ç”¨é€šç”¨å‡½æ•°)
    sendCustomPromptToAI(prompt, `ğŸï¸ å¸®æœ•å›å¿†ä¸€ä¸‹å’Œ ${item.name} å‘ç”Ÿè¿‡ä»€ä¹ˆï¼Ÿ`);
}

// ================= ğŸ”§ ä¿®å¤ä¾¿ç­¾å…³é—­æŒ‰é’® =================
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    // é‡ç½®ä¸€ä¸‹çŠ¶æ€ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€æ—¶é”™ä¹±
    editingNoteIndex = -1; 
}

// ================= ğŸ“– è½¬å°è¯´ (æ™ºèƒ½ç»­å†™ç‰ˆ - è‡ªåŠ¨æ£€æµ‹è¿›åº¦) =================
async function convertChatToNovel() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡å¡« API Keyï¼'); return; }

    const item = items[viewingIndex];
    
    // ğŸ”¥ è®¾å®šæ¯ç« çš„æ¥¼å±‚æ•° (å¿…é¡»å›ºå®šï¼Œå¦åˆ™æ¢ç®—ä¼šä¹±)
    const BATCH_SIZE = 15; 

    // --- 1. å¯»æ‰¾èŠå¤©è®°å½• ---
    let allMessages = [];
    if (item.resources) {
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json') || r.name.endsWith('.jsonl'))) {
                let raw = r.content;
                if (raw.startsWith('data:')) {
                    try { raw = decodeURIComponent(escape(window.atob(raw.split(',')[1]))); } catch (e) {}
                }
                try {
                    let json = JSON.parse(raw);
                    if (Array.isArray(json)) allMessages = json;
                    else if (json.messages) allMessages = json.messages;
                    else if (json.history) allMessages = json.history;
                } catch (e) {
                    const lines = raw.split('\n');
                    allMessages = lines.map(l => { try { return JSON.parse(l); } catch(e){ return null; } }).filter(x => x);
                }
                if (allMessages.length > 0) break;
            }
        }
    }

    if (allMessages.length === 0) { auth.toast('ğŸ“­ æ²¡æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©è®°å½•æ•°æ®...'); return; }

    // --- 2. ğŸ•µï¸ æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æµ‹ç°æœ‰å°è¯´è¿›åº¦ ---
    let existingNovelIndex = -1;
    let currentNovelContent = "";
    let existingChaptersCount = 0;

    // å…ˆæ‰¾æ‰¾æœ‰æ²¡æœ‰å·²ç»å†™è¿‡çš„å°è¯´
    if (item.resources) {
        existingNovelIndex = item.resources.findIndex(r => r.subType === 'å°è¯´' || r.name.includes('å›å¿†å½•'));
    }

    if (existingNovelIndex !== -1) {
        currentNovelContent = item.resources[existingNovelIndex].content;
        
        // ğŸ” æ­£åˆ™æ£€æµ‹ï¼šæ•°ä¸€æ•°é‡Œé¢æœ‰å‡ ä¸ª "ç¬¬xç« "
        // åŒ¹é… "ç¬¬1ç« ", "ç¬¬åäºŒç« " è¿™ç§æ ¼å¼
        const matches = currentNovelContent.match(/ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]+ç« /g);
        if (matches) {
            existingChaptersCount = matches.length;
        }
        console.log(`æ£€æµ‹åˆ°å·²å­˜åœ¨ ${existingChaptersCount} ç« `);
    }

    // ğŸ”¥ è‡ªåŠ¨æ¢ç®—ï¼šç›´æ¥æ ¹æ®ç« èŠ‚æ•°ç®—å‡ºè¯¥ä»å“ªä¸€æ¥¼å¼€å§‹
    // æ¯”å¦‚ï¼šæœ‰2ç« ï¼Œæ¯ç« 15æ¥¼ï¼Œé‚£ä¸‹ä¸€æ¬¡å°±ä» 2 * 15 = 30æ¥¼å¼€å§‹
    let startIndex = existingChaptersCount * BATCH_SIZE;
    
    // æ›´æ–°ä¸€ä¸‹æ•°æ®é‡Œçš„æ¸¸æ ‡ï¼Œä¿æŒåŒæ­¥ (è™½ç„¶æˆ‘ä»¬ç°åœ¨ä¸»è¦é æ–‡ä»¶æ£€æµ‹)
    item.novelCursor = startIndex;

    // è®¡ç®—ç»“æŸæ¥¼å±‚
    const endIndex = Math.min(startIndex + BATCH_SIZE, allMessages.length);

    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å†™å®Œ
    if (startIndex >= allMessages.length) {
        auth.toast(`âœ… å±…ç„¶æ›´å®Œäº†ï¼(æ£€æµ‹åˆ°${existingChaptersCount}ç« ï¼Œå…±${allMessages.length}æ¥¼)`);
        return;
    }

    // --- 3. æå–ç´ æ ---
    const sliceMessages = allMessages.slice(startIndex, endIndex);
    let chatContext = sliceMessages.map(m => {
        const name = m.name || (m.is_user ? 'æˆ‘' : 'TA');
        const text = m.mes || m.content || m.text || "";
        if (!text || m.role === 'system') return ""; 
        return `${name}: ${text}`;
    }).filter(t => t).join('\n');

    const nextChapterNum = existingChaptersCount + 1;

    auth.toast(`ğŸ“– æ­£åœ¨æ ¹æ®èŠå¤©è®°å½• (${startIndex + 1} - ${endIndex}æ¥¼) æ’°å†™ç¬¬ ${nextChapterNum} ç« ...`);

    // --- 4. æ„å»º AI Prompt ---
    const prompt = `
    ã€æŒ‡ä»¤ã€‘ï¼šå°è¯´è¿è½½ç»­å†™
    ã€å½“å‰è¿›åº¦ã€‘ï¼šç¬¬ ${nextChapterNum} ç« 
    
    è¯·å°†ä»¥ä¸‹å¯¹è¯ç´ ææ”¹å†™æˆå°è¯´ã€‚
    
    ã€ä¸¥æ ¼è¦æ±‚ã€‘ï¼š
    1. **åªè¾“å‡ºçº¯æ–‡æœ¬**ï¼Œä¸¥ç¦ä½¿ç”¨ HTML ä»£ç ã€‚
    2. ä¸è¦åˆ—å‡ºå¤§çº²ï¼Œç›´æ¥å¼€å§‹å†™æ­£æ–‡ã€‚
    3. å»æ‰å‰§æœ¬å¼å¯¹è¯ï¼Œè½¬åŒ–ä¸ºç»†è…»çš„æå†™ã€‚
    4. å­—æ•°ï¼š500å­—å·¦å³ã€‚
    
    ã€å¯¹è¯ç´ æã€‘ï¼š
    ${chatContext}
    `;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('novelModal').classList.add('active');
    document.getElementById('novelContent').innerHTML = `<div style="text-align:center; margin-top:100px; color:#8d6e63;">
        â³ æ­£åœ¨ç ”è¯»ã€Š${item.name}çš„å›å¿†å½•ã€‹...<br>
        æ£€æµ‹åˆ°å·²æœ‰ ${existingChaptersCount} ç« <br>
        å³å°†æ’°å†™ç¬¬ ${nextChapterNum} ç«  (${startIndex+1}-${endIndex}æ¥¼)...
    </div>`;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        if (data.choices) {
            let newChapter = data.choices[0].message.content;

            // æ¸…æ´—ä»£ç 
            newChapter = newChapter.replace(/<br\s*\/?>/gi, '\n');
            newChapter = newChapter.replace(/<\/p>/gi, '\n\n');
            newChapter = newChapter.replace(/<[^>]+>/g, '');
            newChapter = newChapter.replace(/```html/g, '').replace(/```/g, '');
            newChapter = newChapter.trim();

            // --- 5. ä¿å­˜ ---
            let finalNovel = "";
            let fileName = `${item.name}çš„å›å¿†å½•.txt`;

            if (existingNovelIndex !== -1) {
                // ç»­å†™
                finalNovel = currentNovelContent + "\n\n" + "=".repeat(20) + "\n\n" + newChapter;
                item.resources[existingNovelIndex].content = finalNovel;
                item.resources[existingNovelIndex].date = new Date().toISOString();
            } else {
                // æ–°å»º
                finalNovel = `ã€Š${item.name}çš„å›å¿†å½•ã€‹\n\n` + newChapter;
                if (!item.resources) item.resources = [];
                item.resources.push({
                    type: 'file', subType: 'å°è¯´', name: fileName,
                    content: finalNovel, date: new Date().toISOString()
                });
            }

            await saveItemToDB(item);
            
            document.getElementById('novelContent').innerText = finalNovel;
            setTimeout(() => {
                const div = document.getElementById('novelContent');
                div.scrollTop = div.scrollHeight;
            }, 100);

            window.currentNovelText = finalNovel;
            auth.toast(`ğŸ“š ç¬¬ ${nextChapterNum} ç« å·²å®Œæˆï¼(è¿›åº¦å·²è‡ªåŠ¨æ ¡å‡†)`);
        }
    } catch (e) {
        document.getElementById('novelContent').innerText = 'âŒ ç»­å†™å¤±è´¥ï¼š' + e.message;
    }
}

// ä¸‹è½½åŠŸèƒ½çš„è¾…åŠ©å‡½æ•°
function downloadCurrentNovel() {
    if (!currentNovelText) return;
    const blob = new Blob([currentNovelText], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'æˆ‘çš„åå®«å›å¿†å½•.txt';
    a.click();
}

// ================= ğŸ“˜ æ‰“å¼€æ–‡æœ¬é˜…è¯»å™¨ =================
function openTxtReader(resIndex) {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];
    const res = item.resources[resIndex];

    // 1. è·å–å†…å®¹
    let textContent = res.content;
    
    // å¦‚æœæ˜¯ Base64 (ä¸Šä¼ çš„æ–‡ä»¶)ï¼Œè§£ç ä¸€ä¸‹
    if (textContent.startsWith('data:')) {
        try {
            // æå– base64 éƒ¨åˆ†å¹¶è§£ç ä¸­æ–‡
            const base64 = textContent.split(',')[1];
            const binStr = atob(base64);
            const bytes = new Uint8Array(binStr.length);
            for (let i = 0; i < binStr.length; i++) {
                bytes[i] = binStr.charCodeAt(i);
            }
            textContent = new TextDecoder('utf-8').decode(bytes);
        } catch (e) {
            textContent = "âŒ æ— æ³•è§£ç æ–‡ä»¶å†…å®¹...";
        }
    }

    // 2. æ”¾å…¥å¤§ä¹¦é¡µ
    document.getElementById('novelContent').innerText = textContent;
    
    // 3. æ‰“å¼€å¼¹çª—
    document.getElementById('novelModal').classList.add('active');
    
    // è®°å½•å½“å‰æ–‡æœ¬ä»¥ä¾¿ä¸‹è½½
    currentNovelText = textContent;
}

// ================= ğŸ¥š é˜²ä¼ªæš—é—¨é€»è¾‘ =================
let copyrightClicks = 0;
let copyrightTimer = null;

function triggerCopyrightEgg() {
    copyrightClicks++;
    
    // å¦‚æœ 2ç§’å†…æ²¡ç»§ç»­ç‚¹ï¼Œå°±é‡ç½®æ¬¡æ•°
    clearTimeout(copyrightTimer);
    copyrightTimer = setTimeout(() => { copyrightClicks = 0; }, 2000);

    // è¿ç‚¹ 5 æ¬¡è§¦å‘
    if (copyrightClicks === 5) {
        alert("ğŸ›¡ï¸ çš‡å®¶é˜²ä¼ªè®¤è¯é€šè¿‡ï¼\n\nâœ… æ­£ç‰ˆæ‰€æœ‰è€…ï¼šã€é•¿æ˜¥è·¯å¥³çš‡ã€‘\nğŸ“… åˆ¶ä½œæ—¶é—´ï¼š2025å¹´\nâš ï¸ ç›—ç‰ˆå¿…ç©¶ï¼\n\n(Original Created by You)");
        copyrightClicks = 0; // é‡ç½®
    }
}

// ================= ğŸŒ  åŠŸèƒ½äºŒï¼šé’¦å¤©ç›‘ Â· ä»Šæ—¥è¿åŠ¿ =================

async function openHoroscope() {
    document.getElementById('horoscopeModal').classList.add('active');
    
    const today = new Date().toLocaleDateString();
    document.getElementById('horoscopeDate').innerText = `ğŸ“… ${today} Â· å†œå†ä¸çŸ¥é“å¤šå°‘`;
    const contentDiv = document.getElementById('horoscopeContent');

    // 1. æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»ç®—è¿‡äº† (å­˜ localStorage)
    const saved = localStorage.getItem('daily_horoscope_' + today);
    if (saved) {
        contentDiv.innerHTML = saved;
        return;
    }

    if (items.length < 2) {
        contentDiv.innerHTML = "ğŸš« åå®«äººæ•°å¤ªå°‘ï¼Œæ˜Ÿè±¡æ¨¡ç³Šä¸æ¸…...";
        return;
    }

    // 2. æ²¡ç®—è¿‡ï¼Œç°åœºç®— (éšæœºæŠ½äºº)
    // éšæœºé€‰ä¸€ä¸ªâ€œå®œâ€çš„äºº
    const luckyChar = items[Math.floor(Math.random() * items.length)];
    // éšæœºé€‰ä¸€ä¸ªâ€œå¿Œâ€çš„äºº (ä¸èƒ½æ˜¯åŒä¸€ä¸ªäºº)
    let unluckyChar = items[Math.floor(Math.random() * items.length)];
    while(unluckyChar === luckyChar && items.length > 1) {
        unluckyChar = items[Math.floor(Math.random() * items.length)];
    }

    // 3. è®© AI ç¼–è¿åŠ¿
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        contentDiv.innerHTML = "â˜ï¸ ä¹Œäº‘é®æœˆï¼Œå›½å¸ˆæ²¡å¸¦ API Key...";
        return;
    }

    const prompt = `
    ä½ æ˜¯çš‡å®¶çš„ã€é’¦å¤©ç›‘å›½å¸ˆã€‘ã€‚
    è¯·ä¸ºå¥³çš‡é™›ä¸‹æ¨ç®—ã€ä»Šæ—¥åå®«è¿åŠ¿ã€‘ã€‚
    
    ã€ä»Šæ—¥å®œã€‘ï¼šä¸´å¹¸ã€${luckyChar.name}ã€‘ã€‚
    ã€ä»Šæ—¥å¿Œã€‘ï¼šå†·è½ã€${unluckyChar.name}ã€‘ã€‚
    
    è¯·ç¼–é€ ç†ç”±ï¼š
    1. ä¸ºä»€ä¹ˆå®œä¸´å¹¸ ${luckyChar.name}ï¼Ÿï¼ˆä¾‹å¦‚ï¼šçº¢é¸¾æ˜ŸåŠ¨ï¼Œä»–ä»Šæ—¥ç”šè‡³å¯çˆ±ï¼‰
    2. ä¸ºä»€ä¹ˆå¿Œå†·è½ ${unluckyChar.name}ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¤©ç‹—çŠ¯ç…ï¼Œä»–å¿ƒæƒ…ä¸å¥½å®¹æ˜“é»‘åŒ–ï¼‰
    3. ç»™ä¸€å¥ç„ä¹çš„åˆ¤è¯ã€‚
    
    æ ¼å¼ï¼šHTMLæ ¼å¼ï¼Œç”¨ <div> åŒ…è£¹ï¼Œé‡ç‚¹è¯åŠ ç²—ã€‚
    `;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const text = data.choices[0].message.content;

        // 4. æ¸²æŸ“å¹¶ä¿å­˜
        const html = `
            <div class="horoscope-card" style="border-color:#81c784; background:rgba(129, 199, 132, 0.1);">
                <div style="color:#81c784; font-weight:bold;">âœ¨ ä»Šæ—¥å®œ</div>
                <div style="font-size:16px; margin:5px 0;">ä¸´å¹¸ ${luckyChar.name}</div>
            </div>
            <div class="horoscope-card" style="border-color:#e57373; background:rgba(229, 115, 115, 0.1);">
                <div style="color:#e57373; font-weight:bold;">ğŸ’€ ä»Šæ—¥å¿Œ</div>
                <div style="font-size:16px; margin:5px 0;">å†·è½ ${unluckyChar.name}</div>
            </div>
            <div style="font-size:13px; text-align:left; margin-top:15px; line-height:1.6;">
                ${text.replace(/```html/g,'').replace(/```/g,'')}
            </div>
        `;
        
        contentDiv.innerHTML = html;
        localStorage.setItem('daily_horoscope_' + today, html); // å­˜ä¸‹æ¥ï¼Œä»Šå¤©ä¸å†å˜
        
    } catch (e) {
        contentDiv.innerHTML = "âŒ å¤©æœºä¸å¯æ³„éœ² (ç½‘ç»œé”™è¯¯)";
    }
}



// å¹´é¾„é˜¶æ®µ
const HEIR_STAGES = [
    { ageCap: 3, name: 'å©´å„¿æœŸ', icon: 'ğŸ‘¶', bg: 'stage-baby' },
    { ageCap: 10, name: 'å¹¼å¹´æœŸ', icon: 'ğŸ‘¦', bg: 'stage-child' },
    { ageCap: 16, name: 'å°‘å¹´æœŸ', icon: 'ğŸ§‘â€ğŸ¦±', bg: 'stage-teen' },
    { ageCap: 99, name: 'æˆå¹´æœŸ', icon: 'ğŸ¤´', bg: 'stage-adult' }
];

// ----------- 1. æŒ‰é’®çŠ¶æ€ç®¡ç† (å·²ä¿®å¤é˜²æŠ¥é”™) -----------

// 1. æ›´æ–°æŒ‰é’®çŠ¶æ€ (å…è®¸äºŒèƒç‰ˆ)
function updateHeirButtonState() {
    var btn = document.getElementById('heirActionButton');
    if (!btn) return;
    if (typeof viewingIndex==='undefined' || !items[viewingIndex]) return;
    
    // å¦‚æœæ²¡æœ‰å­©å­ï¼Œæˆ–è€…å­©å­å·²æˆå¹´/ç¦»å®¶/æ­»äº¡ -> å…è®¸ç”Ÿæ–°çš„
    if (!currentHeir || currentHeir.age >= 18 || currentHeir.isRunaway || currentHeir.isDead) {
        btn.innerText = `ğŸ‘¶ ç¥ˆç¦æ±‚å­ (å®¶æ—å¼€ææ•£å¶)`;
        btn.style.background = '#fff0f5'; btn.style.color = '#ff6b6b';
    } else if (currentHeir.fatherName === items[viewingIndex].name) {
        btn.innerText = `ğŸ§¸ å‰å¾€ä¸œå®« (çœ‹æœ›${currentHeir.name})`; 
        btn.style.background = '#fff7d1'; btn.style.color = '#fa8c16';
    } else {
        btn.innerText = `ğŸš« å®«ä¸­å·²æœ‰å¹¼å­ (${currentHeir.name})`; 
        btn.style.background = '#eee'; btn.style.color = '#999';
    }
}

// 2. å¤„ç†ç‚¹å‡» (å…è®¸äºŒèƒç‰ˆ)
function handleHeirAction() {
    if (viewingIndex === -1) return;
    var item = items[viewingIndex];

    // å¦‚æœæ»¡è¶³ç”ŸäºŒèƒæ¡ä»¶
    if (!currentHeir || currentHeir.age >= 18 || currentHeir.isRunaway || currentHeir.isDead) {
        // å¦‚æœå½“å‰æœ‰æˆå¹´å­©å­ï¼Œç¡®ä¿å·²ç»å­˜è¿›å®¶æ—äº†
        if(currentHeir && currentHeir.age >= 18) {
             let existIdx = familyTree.findIndex(c => c.id === currentHeir.id);
             if (existIdx === -1) { familyTree.push(currentHeir); localStorage.setItem('royal_family_tree', JSON.stringify(familyTree)); }
        }

        document.getElementById('creationFatherName').innerText = item.name;
        document.getElementById('creationSettingInput').value = '';
        document.getElementById('heirCreationModal').classList.add('active');
    } else if (currentHeir.fatherName === item.name) {
        openEastPalace();
    } else {
        auth.toast(`ğŸš« é™›ä¸‹ï¼Œç°åœ¨çš„çš‡å—£ã€${currentHeir.name}ã€‘è¿˜æœªæˆå¹´ï¼Œä¸èƒ½ç”ŸäºŒèƒå“¦ï¼`);
    }
}


// ----------- 2. åˆ›å»ºçš‡å—£ -----------
async function confirmCreateHeir() {
    const setting = document.getElementById('creationSettingInput').value.trim();
    if (!setting) { auth.toast('è¯·è®¸ä¸‹ä¸€ä¸ªæ„¿æœ›å§...'); return; }
    
    const father = items[viewingIndex];
    auth.toast('âœ¨ æ­£åœ¨ç¥ˆæ±‚ä¸Šè‹ï¼Œé™ä¸‹éºŸå„¿...');
    document.getElementById('heirCreationModal').classList.remove('active');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));

    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚å­©å­çš„çˆ¶äº²æ˜¯ã€${father.name}ã€‘ï¼ˆæ€§æ ¼:${(father.tags||[]).join(',')}ï¼‰ã€‚
    æˆ‘å¯¹å­©å­çš„æœŸæœ›æ˜¯ï¼šã€${setting}ã€‘ã€‚
    è¯·ç”Ÿæˆä¸€ä¸ªåˆšå‡ºç”Ÿçš„çš‡å—£æ¡£æ¡ˆã€‚
    è¦æ±‚è¿”å›çº¯ JSON æ ¼å¼ï¼š
    {
        "name": "åå­—(å¤é£å¥½å¬)",
        "title": "å°å·",
        "gender": "ç”·/å¥³",
        "bio": "å‡ºç”Ÿæè¿°(50å­—å†…)",
        "stats": { "wisdom": 10, "fitness": 10, "charm": 10 }
    }
    `;

    try {
        const res = await fetchAI(prompt, config);
        // æ¸…ç† JSON æ ¼å¼ (é˜²æ­¢ AI åŠ  Markdown ç¬¦å·)
        const cleanRes = res.replace(/```json/g,'').replace(/```/g,'').trim();
        const data = JSON.parse(cleanRes);

        currentHeir = {
            fatherName: father.name,
            name: data.name,
            title: data.title,
            gender: data.gender,
            age: 0,
            stats: data.stats,
            bioLog: [`ã€è¯ç”Ÿã€‘ï¼š${data.bio}`],
            setting: setting
        };
        saveHeirData();
        auth.toast('ğŸ‰ æ­å–œé™›ä¸‹ï¼çš‡å—£å·²è¯ç”Ÿï¼');
        updateHeirButtonState();
        openEastPalace();

    } catch (e) {
        auth.toast('âŒ ç¥ˆç¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ');
        console.error(e);
    }
}

function saveHeirData() {
    localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir));
}

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ å…³é”®è¡¥ä¸ï¼šç¼ºå¤±çš„ fetchAI å·¥å…·å‡½æ•° ğŸ‘‡ğŸ‘‡ğŸ‘‡
async function fetchAI(prompt, config) {
    if(!config || !config.apiKey) throw new Error("No Key");
    const response = await fetch(`${config.apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
        body: JSON.stringify({
            model: config.model || 'gpt-3.5-turbo',
            messages: [{ role: "user", content: prompt }]
        })
    });
    const data = await response.json();
    return data.choices[0].message.content;
}

// ================= â¤ï¸ æ ¸å¿ƒï¼šé€šç”¨æ©å® ç®¡ç†ç³»ç»Ÿ =================

// å®šä¹‰ä½ä»½é—¨æ§›
const RANKS = [
    { name: "ä¾å¥´", limit: 20, class: "rank-0" },
    { name: "ç­”åº”", limit: 50, class: "rank-1" },
    { name: "è´µäºº", limit: 100, class: "rank-2" },
    { name: "å«”", limit: 200, class: "rank-3" },
    { name: "å¦ƒ", limit: 500, class: "rank-4" },
    { name: "çš‡è´µå›", limit: 99999, class: "rank-5" }
];

// 1. è·å–ä½ä»½ä¿¡æ¯
function getRankInfo(favor) {
    favor = favor || 0;
    for (let i = 0; i < RANKS.length; i++) {
        if (favor < RANKS[i].limit) return RANKS[i];
    }
    return RANKS[RANKS.length - 1];
}

// 2. é€šç”¨åŠ å¥½æ„Ÿå‡½æ•° (æ ¸å¿ƒ)
// amount: åŠ å¤šå°‘åˆ†
// reason: ä¸ºä»€ä¹ˆåŠ åˆ† (ç”¨äºæç¤º)
async function addFavor(amount, reason) {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    const item = items[viewingIndex];

    // åˆå§‹åŒ–
    if (!item.favor) item.favor = 0;
    const oldRankName = getRankInfo(item.favor).name;

    // åŠ åˆ†
    item.favor += amount;
    const newRankInfo = getRankInfo(item.favor);

    // ä¿å­˜æ•°æ®
    await saveItemToDB(item);

    // åˆ·æ–°ç•Œé¢ UI (å¾½ç« )
    if(typeof updateRankUI === 'function') updateRankUI(item);

    // === åé¦ˆé€»è¾‘ ===
    
    // æƒ…å†µA: æ™‹å‡äº†ï¼
    if (newRankInfo.name !== oldRankName) {
        auth.toast(`ğŸ‰ æ­å–œï¼ã€${item.name}ã€‘æ™‹å‡ä¸ºã€${newRankInfo.name}ã€‘ï¼`);
        // æ»¡å±æ’’èŠ±ç‰¹æ•ˆ (å¦‚æœæœ‰çš„è¯)
        if(navigator.vibrate) navigator.vibrate([100,50,100]); 
        
        // æ™‹å‡åï¼Œå¼ºåˆ¶è®© AI æ„Ÿè°¢è°¢æ© (å¯é€‰)
        // triggerAIReaction(item, newRankInfo.name); 
    } 
    // æƒ…å†µB: åªæ˜¯æ™®é€šåŠ åˆ†
    else {
        // æ˜¾ç¤ºä¸€ä¸ªå°æç¤ºï¼š "â¤ï¸ æ©å®  +1 (èŠå¤©)"
        auth.toast(`â¤ï¸ æ©å®  +${amount} (${reason}) | å½“å‰: ${item.favor}`);
    }
}

// 3. ä¸“é—¨ç»™â€œèµèµæŒ‰é’®â€ç”¨çš„
function manualGrantFavor() {
    // èµèµåŠ çš„å¤šï¼Œ5-10åˆ†éšæœº
    const points = Math.floor(Math.random() * 6) + 5;
    addFavor(points, "èµèµ");
}

// 4. æ›´æ–°ç•Œé¢ä¸Šçš„å¾½ç«  (æ”¾åœ¨ openDetailModal é‡Œè°ƒç”¨)
function updateRankUI(item) {
    const favor = item.favor || 0;
    const rankObj = getRankInfo(favor);
    
    const nameEl = document.getElementById('detailName');
    if(!nameEl) return;

    // æ¸…é™¤æ—§çš„
    const oldBadge = nameEl.querySelector('.rank-badge');
    if (oldBadge) oldBadge.remove();
    
    // åŠ æ–°çš„
    const badge = document.createElement('span');
    badge.className = `rank-badge ${rankObj.class}`;
    badge.innerText = rankObj.name;
    badge.style.cssText = "display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; margin-left:8px; color:white; vertical-align:middle; background:#ccc;";
    
    // ç»™ä¸åŒç­‰çº§ä¸Šè‰²
    if(rankObj.name === 'ä¾å¥´') badge.style.background = '#b0bec5';
    if(rankObj.name === 'ç­”åº”') badge.style.background = '#81d4fa';
    if(rankObj.name === 'è´µäºº') badge.style.background = '#a5d6a7';
    if(rankObj.name === 'å«”') badge.style.background = '#ffcc80';
    if(rankObj.name === 'å¦ƒ') badge.style.background = '#f48fb1';
    if(rankObj.name === 'çš‡è´µå›') badge.style.background = 'linear-gradient(135deg, #ffd700, #ff8f00)';

    nameEl.appendChild(badge);
}

// ================= ğŸ‘‹ çš‡å—£äº’åŠ¨é€»è¾‘ (æ‘¸æ‘¸ä¹) =================

function touchHeir(event) {
    const ball = event.currentTarget;
    const rect = ball.getBoundingClientRect();
    const clickY = event.clientY - rect.top; // ç‚¹å‡»ä½ç½®ç›¸å¯¹äºçƒé¡¶éƒ¨çš„è·ç¦»
    const ballHeight = rect.height;

    // è·å–äº”å®˜å…ƒç´ 
    const eyeL = document.getElementById('eyeL');
    const eyeR = document.getElementById('eyeR');
    const mouth = document.getElementById('mouth');
    const blushL = document.getElementById('blushL');
    const blushR = document.getElementById('blushR');

    // éœ‡åŠ¨åé¦ˆ
    if(navigator.vibrate) navigator.vibrate(50);

    // åˆ¤æ–­æ‘¸çš„æ˜¯å“ªé‡Œ
    if (clickY < ballHeight / 2) {
        // ğŸ‘‰ æƒ…å†µ Aï¼šæ‘¸å¤´ (Top 50%)
        // ååº”ï¼šçœ¯çœ¼ç¬‘ï¼Œå†’çˆ±å¿ƒ
        
        // 1. å˜è¡¨æƒ… (çœ¯çœ¼)
        eyeL.style.height = '2px'; eyeL.style.top = '5px';
        eyeR.style.height = '2px'; eyeR.style.top = '5px';
        mouth.style.borderRadius = '0 0 10px 10px'; mouth.style.height = '8px'; // å¼€å¿ƒå˜´
        blushL.style.opacity = '1'; blushR.style.opacity = '1'; // è„¸çº¢

        // 2. åŠ¨ç”» (Qå¼¹å‹æ‰)
        ball.style.transform = 'scale(1.1, 0.9)'; 
        
        // 3. æç¤º
        auth.toast(`â˜ï¸ æ‘¸æ‘¸å¤´~ ${currentHeir.name} å¾ˆå¼€å¿ƒ`);

    } else {
        // ğŸ‘‰ æƒ…å†µ Bï¼šæˆ³è‚šå­/è¡£æœ (Bottom 50%)
        // ååº”ï¼šæƒŠè®¶ï¼Œæ‘‡æ™ƒ
        
        // 1. å˜è¡¨æƒ… (åœ†çœ¼Oå‹å˜´)
        eyeL.style.height = '14px'; eyeL.style.top = '0';
        eyeR.style.height = '14px'; eyeR.style.top = '0';
        mouth.style.borderRadius = '50%'; mouth.style.height = '8px'; mouth.style.width = '8px'; // Oå‹å˜´
        
        // 2. åŠ¨ç”» (å·¦å³æ‘‡æ™ƒ)
        ball.style.animation = 'none'; // å…ˆåœå‘¼å¸
        ball.offsetHeight; /* è§¦å‘é‡ç»˜ */
        ball.style.animation = 'shake-ball 0.4s'; // æ‘‡æ™ƒ

        // 3. æç¤º
        auth.toast(`ğŸ‘‰ æˆ³ä¸€æˆ³~ ${currentHeir.name} å“äº†ä¸€è·³`);
    }

    // --- 2ç§’åæ¢å¤åŸçŠ¶ ---
    setTimeout(() => {
        // æ¢å¤å‘¼å¸
        ball.style.animation = 'breathe 3s infinite ease-in-out';
        ball.style.transform = 'scale(1)';
        
        // æ¢å¤è¡¨æƒ…
        eyeL.style.height = '12px'; eyeL.style.top = '0';
        eyeR.style.height = '12px'; eyeR.style.top = '0';
        mouth.style.borderRadius = '0 0 10px 10px'; mouth.style.height = '5px'; mouth.style.width = '10px';
        blushL.style.opacity = '0'; blushR.style.opacity = '0';
    }, 2000);
}

// ================= ğŸ§  åœºæ™¯æ™ºèƒ½åŒ¹é… (å¤šå›¾éšæœºç‰ˆ) =================
function smartUpdateHeirScene(actionText) {
    if (!currentHeir) return;
    
    const isBoy = currentHeir.gender === 'ç”·';
    const sceneList = isBoy ? HEIR_SCENES.boy : HEIR_SCENES.girl;
    const assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    
    // 1. é»˜è®¤å›¾ (ä»ç´ æåº“é‡Œæ‹¿)
    let defaultPool = assets.bg[currentSeason] || assets.bg['æ˜¥'];
    // å¦‚æœé»˜è®¤å›¾ä¹Ÿæ˜¯ä¸ªæ•°ç»„ï¼Œå…ˆéšæœºæŠ½ä¸€å¼ ä½œä¸ºä¿åº•
    let finalUrl = Array.isArray(defaultPool) 
        ? defaultPool[Math.floor(Math.random() * defaultPool.length)] 
        : defaultPool;

    // 2. å°è¯•åŒ¹é…ç‰¹æ®Šåœºæ™¯
    if (actionText) {
        for (let scene of sceneList) {
            // è§„åˆ™ï¼šå­£èŠ‚åŒ¹é… + å…³é”®è¯åŒ¹é…
            if (scene.seasons.includes(currentSeason)) {
                if (scene.keywords.some(key => actionText.includes(key))) {
                    
                    // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šåˆ¤æ–­æ˜¯å•å¼ è¿˜æ˜¯å¤šå¼ 
                    if (Array.isArray(scene.url)) {
                        // æ˜¯æ•°ç»„ï¼šéšæœºæŠ½ä¸€å¼ 
                        finalUrl = scene.url[Math.floor(Math.random() * scene.url.length)];
                    } else {
                        // æ˜¯å­—ç¬¦ä¸²ï¼šç›´æ¥ç”¨
                        finalUrl = scene.url;
                    }
                    
                    console.log(`âœ¨ åœºæ™¯åŒ¹é…æˆåŠŸ: [${scene.keywords[0]}] -> éšæœºé€‰ä¸­å›¾ç‰‡`);
                    break; 
                }
            }
        }
    }

    // 3. æ‰§è¡Œæ¢å›¾ (å¸¦æ·¡å…¥æ·¡å‡ºæ•ˆæœ)
    const bgEl = document.getElementById('heirSceneBg');
    if (bgEl) {
        // å¦‚æœæ–°å›¾å’Œæ—§å›¾ä¸€æ ·ï¼Œå°±ä¸é—ªçƒäº†ï¼Œä½“éªŒæ›´å¥½
        const currentBg = bgEl.style.backgroundImage;
        if (currentBg.includes(finalUrl)) return;

        bgEl.style.opacity = 0.5;
        setTimeout(() => {
            bgEl.style.backgroundImage = `url('${finalUrl}')`;
            bgEl.style.opacity = 1;
        }, 200);
    }
}

// ================= ğŸ§  çš‡å—£ç³»ç»Ÿ 2.0 (å…¨åŠŸèƒ½å®Œæ•´æ— ç¼ºç‰ˆ) =================

// 1. è¯»å–å­˜æ¡£
var currentHeir = JSON.parse(localStorage.getItem('royal_heir_data')) || null;

// ğŸŸ¢ æ•°æ®è‡ªåŠ¨ä¿®å¤
if (currentHeir) {
    if (!currentHeir.params) currentHeir.params = {};
    var defaults = { diligence: 50, rebellion: 10, affection: 60, ambition: 50, morality: 50, wisdom: 50, fitness: 50 };
    for (var k in defaults) {
        if (currentHeir.params[k] === undefined) currentHeir.params[k] = defaults[k];
    }
    if (currentHeir.mood === undefined) currentHeir.mood = 80;
    if (!currentHeir.history) currentHeir.history = [];
    if (currentHeir.isWaitingForReply === undefined) currentHeir.isWaitingForReply = false;
    if (!currentHeir.season) currentHeir.season = 'æ˜¥';
    
    // è¡¥å…¨ç”Ÿå­˜æ•°æ®
    if (!currentHeir.body) {
        currentHeir.body = { health: 100, sick: false, waste: 0, height: 110, weight: 18, heartRate: 85 };
    }
    if (!currentHeir.currentScene) currentHeir.currentScene = null;
    if (currentHeir.panelMode === undefined) currentHeir.panelMode = 'stats';

    localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir));
}

// ================= ğŸ“ èŒä¸šä¸æˆå°±æ•°æ®åº“ (æ–°å¢) =================
const CAREER_DB = [
    // ğŸ‘‘ çš‡æƒç±»
    { name: "çš‡å¸", type: "royal", req: { ambition: 90, wisdom: 80 } },
    { name: "æ‘„æ”¿ç‹", type: "royal", req: { ambition: 85, fitness: 80 } },
    { name: "çš‡å", type: "royal", req: { charm: 90, morality: 80 } },
    // âš”ï¸ æ­¦å®˜ç±»
    { name: "å¤§å°†å†›", type: "good", req: { fitness: 90, rebellion: 60 } },
    { name: "å¾¡å‰ä¾å«", type: "good", req: { fitness: 80, morality: 80 } },
    { name: "åˆºå®¢", type: "bad", req: { fitness: 85, morality: 20 } },
    // ğŸ“š æ–‡å®˜/æŠ€è‰ºç±»
    { name: "å®°ç›¸", type: "good", req: { wisdom: 95, morality: 60 } },
    { name: "å¤ªåŒ»", type: "good", req: { wisdom: 80, morality: 80 } },
    { name: "çŠ¶å…ƒéƒ", type: "good", req: { diligence: 90, wisdom: 80 } },
    // ğŸ’° å¸‚äº•ç±»
    { name: "çš‡å•†é¦–å¯Œ", type: "good", req: { wisdom: 70, ambition: 80 } },
    { name: "é’æ¥¼å¤´ç‰Œ", type: "bad", req: { charm: 90, morality: 30 } },
    // ğŸšï¸ åº•å±‚/ç‰¹æ®Š
    { name: "ç§ç”°å†œå¤«", type: "normal", req: { fitness: 50 } },
    { name: "ä¹ä¸", type: "bad", req: { diligence: 10, wisdom: 10 } },
    { name: "å¹³æ°‘", type: "normal", req: {} } // ä¿åº•
];

// åˆå§‹åŒ–å®¶æ—æ ‘ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
var familyTree = JSON.parse(localStorage.getItem('royal_family_tree')) || [];

// 2. ğŸŒ èµ„æºä¸åœ°å›¾
var WORLD_MAPS = {
    'outside': {
        name: 'äº¬åŸç¹ååœ°',
        bg: 'https://files.catbox.moe/acbius.jpeg',
        locations: [
            { name: 'è¥¿å¸‚', icon: 'ğŸ®', desc: 'çƒ­é—¹çš„é›†å¸‚' },
            { name: 'æŠ¤åŸæ²³', icon: 'ğŸŒŠ', desc: 'å‚æŸ³ä¾ä¾' },
            { name: 'å¤§æŠ¥æ©å¯º', icon: 'ğŸ””', desc: 'ç¥ˆç¦åœ£åœ°' },
            { name: 'çŠ¶å…ƒæ¥¼', icon: 'ğŸ²', desc: 'æœ€å¥½çš„é…’æ¥¼' },
            { name: 'åŸéƒŠé©¬åœº', icon: 'ğŸ', desc: 'éª‘å°„ä¹‹åœ°' },
            { name: 'æ¡ƒèŠ±å', icon: 'ğŸŒ¸', desc: 'èµèŠ±èƒœåœ°' },
            { name: 'æˆå›­å­', icon: 'ğŸ­', desc: 'å¬æ›²çœ‹æˆ' },
            { name: 'å›å®«', icon: 'ğŸšª', type: 'exit' }
        ]
    }
};

var HEIR_ASSETS = {
    boy: {
        bg: { 
            'æ˜¥': ["https://files.catbox.moe/87xa1i.png", "https://files.catbox.moe/7lhq83.png", "https://files.catbox.moe/3wx26e.png", "https://files.catbox.moe/3lwe0w.png"],
            'å¤': ["https://files.catbox.moe/3lwe0w.png", "https://files.catbox.moe/11wud2.png", "https://files.catbox.moe/75je6d.png", "https://files.catbox.moe/xyp7uw.png"],
            'ç§‹': ["https://files.catbox.moe/87xa1i.png", "https://files.catbox.moe/7lhq83.png", "https://files.catbox.moe/f539et.png", "https://files.catbox.moe/3lwe0w.png"], 
            'å†¬': ["https://files.catbox.moe/idu2gw.jpg", "https://files.catbox.moe/fkfstg.jpg", "https://files.catbox.moe/937inc.png"]
        },
        idle: [ "https://files.catbox.moe/fv8f8p.gif", "https://files.catbox.moe/vdvz1m.gif" ],
        shy: "https://files.catbox.moe/fv8f8p.gif", 
        yawn: "https://files.catbox.moe/vdvz1m.gif"
    },
    girl: {
        bg: {
            'æ˜¥': ["https://files.catbox.moe/zqx3jl.png", "https://files.catbox.moe/j1mo4r.png", "https://files.catbox.moe/vmn42f.png", "https://files.catbox.moe/84wild.png"],
            'å¤': ["https://files.catbox.moe/tw4s8u.jpg", "https://files.catbox.moe/qzmagd.png", "https://files.catbox.moe/gsn7fd.png"],
            'ç§‹': ["https://files.catbox.moe/zqx3jl.png", "https://files.catbox.moe/vmn42f.png"],
            'å†¬': ["https://files.catbox.moe/hjnmf4.jpg", "https://files.catbox.moe/divoox.png", "https://files.catbox.moe/vsqo8k.jpg"] 
        },
        idle: [ "https://files.catbox.moe/8q61ys.gif", "https://files.catbox.moe/4hxxkv.gif" ],
        shy: "https://files.catbox.moe/cokcdl.gif",
        yawn: "https://files.catbox.moe/mezusb.gif"
    }
};

var HEIR_SCENES = {
    boy: [
        { seasons: ['å†¬'], keywords: ['æ¢…', 'èµæ¢…', 'é•¿æ¤…'], url: ['https://files.catbox.moe/idu2gw.jpg'] },
        { seasons: ['å†¬'], keywords: ['å¯å®«', 'ç¡è§‰', 'ä¼‘æ¯', 'èµ·åºŠ'], url: ['https://files.catbox.moe/fkfstg.jpg'] },
        { seasons: ['å†¬'], keywords: ['é›ª', 'é›ªä»—', 'æ‰“é›ª'], url: ['https://files.catbox.moe/937inc.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['é’“é±¼', 'æ± å¡˜', 'å‚é’“'], url: ['https://files.catbox.moe/87xa1i.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['ç©è€', 'æ¸¸æˆ', 'è·‘'], url: ['https://files.catbox.moe/7lhq83.png'] },
        { seasons: ['æ˜¥'], keywords: ['èŠ±', 'èµèŠ±'], url: ['https://files.catbox.moe/3wx26e.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['ç”»ç”»', 'ä¸¹é’'], url: ['https://files.catbox.moe/6iwmot.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['è¯»ä¹¦', 'çœ‹ä¹¦', 'é˜…è¯»'], url: ['https://files.catbox.moe/3lwe0w.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['ç»ƒå­—', 'ä¹¦æ³•', 'ä¸Šè¯¾'], url: ['https://files.catbox.moe/11wud2.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['åƒé¥­', 'å±•ç¤º'], url: ['https://files.catbox.moe/xyp7uw.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['è®­ç»ƒ', 'ä¹ æ­¦', 'å£«å…µ'], url: ['https://files.catbox.moe/75je6d.png'] }
    ],
    girl: [
        { seasons: ['æ˜¥','ç§‹'], keywords: ['é£ç­'], url: ['https://files.catbox.moe/zqx3jl.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['æ¯½å­'], url: ['https://files.catbox.moe/vmn42f.png'] },
        { seasons: ['æ˜¥'], keywords: ['ç©è€', 'èŠ±å›­'], url: ['https://files.catbox.moe/j1mo4r.png'] },
        { seasons: ['æ˜¥'], keywords: ['ç§‹åƒ'], url: ['https://files.catbox.moe/84wild.png'] },
        { seasons: ['å¤'], keywords: ['ç©æ°´', 'æ± å¡˜'], url: ['https://files.catbox.moe/tw4s8u.jpg'] },
        { seasons: ['å¤'], keywords: ['è¥¿ç“œ'], url: ['https://files.catbox.moe/qzmagd.png'] },
        { seasons: ['å¤'], keywords: ['ä¼‘æ¯', 'ç¡è§‰'], url: ['https://files.catbox.moe/gsn7fd.png'] },
        { seasons: ['å†¬'], keywords: ['ç©è€', 'å†¬æ—¥'], url: ['https://files.catbox.moe/hjnmf4.jpg'] },
        { seasons: ['å†¬'], keywords: ['è¿‡å¹´', 'ç¯ç¬¼'], url: ['https://files.catbox.moe/divoox.png'] },
        { seasons: ['å†¬'], keywords: ['åºœå¤–', 'é€›è¡—'], url: ['https://files.catbox.moe/vsqo8k.jpg'] }
    ]
};

// ================= ğŸ‘— æœè£…æ•°æ®åº“ (å·²å…³è”å°äººåŠ¨å›¾) =================
var CLOTHING_DB = {
    boy: [
        { name: "è“è‰²å®˜å¸½æœ", url: "https://files.catbox.moe/9gp0ek.gif", gif: "https://files.catbox.moe/zccnqu.gif", desc: "å°å°å¹´çºªå°±æœ‰å®˜å¨" },
        { 
            name: "æ‘„æ”¿ç‹è£…", 
            url: "https://files.catbox.moe/be9pdw.gif", 
            gif: ["https://files.catbox.moe/a6gf30.gif", "https://files.catbox.moe/9h92p0.gif"], // åŒåŠ¨å›¾
            desc: "éœ¸æ°”ä¾§æ¼ï¼Œæƒå€¾æœé‡" 
        },
        { 
            name: "çš‡å­è£…", 
            url: "https://files.catbox.moe/xeario.gif", 
            gif: ["https://files.catbox.moe/3u8z7c.gif", "https://files.catbox.moe/hmecrx.gif"], // åŒåŠ¨å›¾
            desc: "æ ‡å‡†çš„å®«å»·å¸¸æœ" 
        },
        { name: "è¿åŠ¨å¥èº«è£…", url: "https://files.catbox.moe/9bj1yr.gif", gif: "https://files.catbox.moe/pcdreg.gif", desc: "å¼ºèº«å¥ä½“ï¼Œæ´»åŠ›æ»¡æ»¡" },
        { name: "éª‘é©¬è£…", url: "https://files.catbox.moe/k3llhx.gif", gif: "https://files.catbox.moe/lv998z.gif", desc: "é²œè¡£æ€’é©¬å°‘å¹´éƒ" },
        { name: "é€—é¸Ÿè£…", url: "https://files.catbox.moe/lyipsc.gif", gif: "https://files.catbox.moe/no0u75.gif", desc: "é—²æƒ…é€¸è‡´" },
        { name: "å†¬å¤©é›ªåœ°è£…", url: "https://files.catbox.moe/qpcrp5.gif", gif: "https://files.catbox.moe/z4oen5.gif", desc: "ç‘é›ªå…†ä¸°å¹´" },
        { 
            name: "ä¹¦ç¤¾å­¦ä¹ è£…", 
            url: ["https://files.catbox.moe/nnjk7t.gif", "https://files.catbox.moe/aj9p4u.gif"], // å•†åº—å±•ç¤ºåŒå›¾
            gif: ["https://files.catbox.moe/c72oz2.gif", "https://files.catbox.moe/kcyafw.gif"], // å®é™…ç©¿ç€åŒåŠ¨å›¾
            desc: "ä¸¤æ¬¾æ ·å¼éšå¿ƒæ¢" 
        },
        { name: "ç´«è‰²èµèŠ±è£…", url: "https://files.catbox.moe/4nfj1y.gif", gif: "https://files.catbox.moe/pv75lr.gif", desc: "èŠ±å‰æœˆä¸‹ï¼Œé£æµå€œå‚¥" },
        { name: "æˆ˜åœºç»ƒæ­¦è£…", url: "https://files.catbox.moe/4rm59z.gif", gif: "https://files.catbox.moe/hngj1i.gif", desc: "ä¿å®¶å«å›½" }
    ],
    girl: [
        { name: "é¹…é»„è‰²è¥¦è£™", url: "https://files.catbox.moe/x2g8fs.gif", gif: "https://files.catbox.moe/bntmw6.gif", desc: "æ¸©å©‰å¯äºº" },
        { name: "è“ç²‰å¤æ—¥è£™", url: "https://files.catbox.moe/qyq1sy.gif", gif: "https://files.catbox.moe/iw9m37.gif", desc: "æ¸…å‡‰ä¸€å¤" },
        { name: "ç´«è‰²è¥¦è£™", url: "https://files.catbox.moe/xez8lk.gif", gif: "https://files.catbox.moe/pemsyn.gif", desc: "é«˜è´µå…¸é›…" },
        { name: "å†¬æ—¥è™å¤´è£…", url: "https://files.catbox.moe/sbxewc.gif", gif: "https://files.catbox.moe/dutxp4.gif", desc: "è™å¤´è™è„‘" },
        { name: "ä¸Šç²‰ä¸‹è“å¯çˆ±è£…", url: "https://files.catbox.moe/360a8k.gif", gif: "https://files.catbox.moe/m4mmab.gif", desc: "ä¿çš®å¯çˆ±" },
        { name: "å¤§çº¢è¿‡å¹´è£…", url: "https://files.catbox.moe/1h3cy5.gif", gif: "https://files.catbox.moe/uummm9.gif", desc: "å–œæ°”æ´‹æ´‹" },
        { name: "ç©è€è£…", url: "https://files.catbox.moe/izucss.gif", gif: "https://files.catbox.moe/xyaa83.gif", desc: "æ–¹ä¾¿è·‘è·³" },
        { name: "æ˜¥æ—¥èµæ™¯è£…", url: "https://files.catbox.moe/md5dz9.gif", gif: "https://files.catbox.moe/7tu8va.gif", desc: "äººæ¯”èŠ±å¨‡" },
        { name: "å¦©åªšæ‘‡æ‰‡è£…", url: "https://files.catbox.moe/xuzyz4.gif", gif: "https://files.catbox.moe/og0tcu.gif", desc: "é£æƒ…ä¸‡ç§" },
        { name: "è¿‡èŠ‚å–œåº†è£…", url: "https://files.catbox.moe/cgn0b2.gif", gif: "https://files.catbox.moe/dgvp4o.gif", desc: "çƒ­é—¹éå‡¡" }
    ]
};


// 3. è¯ç”Ÿé€»è¾‘
async function confirmCreateHeir() {
    var setting = document.getElementById('creationSettingInput').value.trim();
    if (!setting) { auth.toast('è¯·è®¸æ„¿...'); return; }
    
    var father = items[viewingIndex];
    document.getElementById('heirCreationModal').classList.remove('active');
    auth.toast('âœ¨ ç¥ˆç¦ä¸­...');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `æˆ‘æ˜¯å¥³çš‡ã€‚çˆ¶äº²ã€${father.name}ã€‘(æ ‡ç­¾:${(father.tags||[]).join(',')})ã€‚æœŸæœ›:ã€${setting}ã€‘ã€‚ç”Ÿæˆçš‡å—£JSON:{ "name":"", "title":"", "gender":"ç”·/å¥³", "bio":"", "params":{ "diligence":50, "rebellion":10, "affection":80, "ambition":50, "morality":50, "wisdom":50, "fitness":50 }}`;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());

        currentHeir = {
            fatherName: father.name,
            name: data.name, title: data.title, gender: data.gender,
            age: 5, isRunaway: false, isAdult: false, isDead: false,
            params: data.params, mood: 80, history: [], bioLog: [`ã€è¯ç”Ÿã€‘ï¼š${data.bio}`],
            setting: setting, lastThought: "ä¸–ç•ŒçœŸå¤§...", isWaitingForReply: false, season: 'æ˜¥',
            body: { health: 100, sick: false, waste: 0, height: 110, weight: 18, heartRate: 85 },
            currentScene: null, panelMode: 'stats'
        };
        saveHeirData();
        auth.toast('ğŸ‰ çš‡å—£è¯ç”Ÿï¼');
        updateHeirButtonState();
        openEastPalace();
    } catch (e) { auth.toast('âŒ è¯ç”Ÿå¤±è´¥'); }
}

// 4. ğŸ¨ ä¸œå®«ç•Œé¢æ¸²æŸ“ (ä¿®å¤ç‰ˆï¼šé«˜äº®æ‰‹æœºæŒ‰é’®)

// ğŸ¨ ä¸œå®«ä¸»ç•Œé¢ (ä¿®å¤ç‰ˆï¼šä¼˜å…ˆæ˜¾ç¤ºç©¿æˆ´çš„è¡£æœ)
function openEastPalace() {
    if (!currentHeir) return;
    if (!currentHeir.params) { location.reload(); return; }
    
    if (currentHeir.isDead && !currentHeir.isViewingMemories) { renderDeadView(); return; }
    if (currentHeir.isRunaway && !currentHeir.isViewingMemories) { renderRunawayView(); return; }
    if (currentHeir.isViewingMemories) { renderMemoryBook(); return; }

    document.getElementById('eastPalaceModal').classList.add('active');

    var isBoy = currentHeir.gender === 'ç”·';
    var assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    
    // 1. èƒŒæ™¯å›¾é€»è¾‘
    var displayBg = "";
    if (currentHeir.currentScene) {
        displayBg = currentHeir.currentScene;
    } else {
        var pool = assets.bg[currentHeir.season] || assets.bg['æ˜¥'];
        displayBg = Array.isArray(pool) ? pool[Math.floor(Math.random()*pool.length)] : pool;
        currentHeir.currentScene = displayBg;
        saveHeirData();
    }

    // ğŸ”¥ 2. ç«‹ç»˜é€»è¾‘ (æ ¸å¿ƒä¿®å¤) ğŸ”¥
    var avatarUrl = "";
    // å¦‚æœç”Ÿç—…äº†ï¼Œå¼ºåˆ¶æ˜¾ç¤ºç”Ÿç—…å›¾ (ä¼˜å…ˆçº§æœ€é«˜)
    if (currentHeir.body.sick) {
        avatarUrl = assets.yawn; 
    } 
    // å¦‚æœæ²¡ç”Ÿç—…ä¸”ç©¿äº†è¡£æœï¼Œæ˜¾ç¤ºè¡£æœåŠ¨å›¾
    else if (currentHeir.currentOutfit) {
        avatarUrl = currentHeir.currentOutfit;
    } 
    // å¦åˆ™æ˜¾ç¤ºé»˜è®¤éšæœºå¾…æœºå›¾
    else {
        var idlePool = assets.idle;
        avatarUrl = Array.isArray(idlePool) ? idlePool[0] : idlePool;
    }

    // ğŸ“ èŒä¸šä¸æ‹çˆ±çŠ¶æ€
    var careerHtml = (currentHeir.age>=18 && currentHeir.career) ? `<span class="career-badge ${CAREER_DB.find(c=>c.name===currentHeir.career)?.type||'normal'}">${currentHeir.career}</span>` : '';
    var loveHtml = (currentHeir.dating && currentHeir.dating.partners && currentHeir.dating.partners.length>0) ? '<span class="love-status-tag">ğŸ’‘ çƒ­æ‹</span>' : '';

    var modalContent = document.querySelector('#eastPalaceModal .modal');
    
    // è¾…åŠ©ï¼šè¿›åº¦æ¡HTMLç”Ÿæˆå™¨
    var renderBar = (label, val, color) => `<div style="display:flex;align-items:center;margin-bottom:3px;font-size:10px;"><span style="width:24px;text-align:right;color:#666;">${label}</span><div style="flex:1;height:6px;background:#f0f0f0;margin:0 4px;border-radius:3px;"><div style="width:${val}%;height:100%;background:${color};"></div></div><span style="width:20px;color:#999;">${val}</span></div>`;

    // è¾…åŠ©ï¼šä¸­é—´é¢æ¿å†…å®¹
    var middlePanelHtml = "";
    if (currentHeir.panelMode === 'info') {
        middlePanelHtml = `<div class="info-grid"><div class="info-item"><span>ç”Ÿæ—¥</span>${currentHeir.season}</div><div class="info-item"><span>èº«é«˜</span>${currentHeir.body.height}cm</div><div class="info-item"><span>ä½“é‡</span>${currentHeir.body.weight}kg</div><div class="info-item"><span>å¿ƒç‡</span>${currentHeir.body.heartRate}</div><div class="info-item"><span>å¥åº·</span>${currentHeir.body.health}%</div><div class="info-item"><span>çŠ¶æ€</span>${currentHeir.body.sick?'ğŸ¤’':'âœ¨'}</div><div class="info-item"><span>èŒä¸š</span>${currentHeir.career||'æ— '}</div></div>`;
    } else {
        middlePanelHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 10px;">${renderBar('äº²å¯†',currentHeir.params.affection,'#ff7675')}${renderBar('å‹¤å‹‰',currentHeir.params.diligence,'#0984e3')}${renderBar('å›é€†',currentHeir.params.rebellion,'#636e72')}${renderBar('é‡å¿ƒ',currentHeir.params.ambition,'#6c5ce7')}${renderBar('å¿ƒæƒ…',currentHeir.mood,'#fdcb6e')}${renderBar('é“å¾·',currentHeir.params.morality,'#00b894')}${renderBar('æ™ºæ…§',currentHeir.params.wisdom,'#00cec9')}${renderBar('ä½“é­„',currentHeir.params.fitness,'#d63031')}</div>`;
    }

    modalContent.innerHTML = `
        <button class="close-modal" onclick="closeEastPalace()" style="position:absolute;right:10px;top:10px;z-index:200;color:#fff;font-size:24px;background:none;border:none;text-shadow:0 1px 2px rgba(0,0,0,0.3);">Ã—</button>
        
        <div id="heirSceneBg" class="heir-bg-stage" style="background-image:url('${displayBg}');height:150px;position:relative;border-bottom:3px solid #fff;">
            <div style="position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.9);padding:3px 8px;border-radius:10px;font-size:11px;font-weight:bold;color:#555;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                ğŸ“… ${currentHeir.age}å² Â· ${currentHeir.season}å­£ ${careerHtml} ${loveHtml}
            </div>
            
            <button onclick="readMind()" style="position:absolute;top:10px;right:135px;background:rgba(0,0,0,0.5);color:#fff;border:1px solid rgba(255,255,255,0.8);border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;">ğŸ”® è¯»å¿ƒ</button>
            <button onclick="openMemories()" style="position:absolute;top:10px;right:50px;background:rgba(255,255,255,0.8);color:#555;border:1px solid #ddd;border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;font-weight:bold;">ğŸ“– å›å¿†</button>

            <button onclick="openPhone()" style="position:absolute;bottom:10px;left:10px;width:40px;height:40px;border-radius:50%;background:#fff;border:2px solid #ddd;font-size:22px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;z-index:50;" title="æ‰“å¼€æ‰‹æœº">ğŸ“±</button>

            <div id="heirBubble" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 12px;border-radius:15px;font-size:12px;max-width:80%;box-shadow:0 5px 15px rgba(0,0,0,0.2);opacity:0;transition:all 0.3s;pointer-events:none;z-index:30;color:#444;text-align:center;">...</div>
        </div>

        <div style="display:flex;height:140px;padding:10px;background:#fff;border-bottom:1px dashed #eee;">
            <div style="width:100px;height:100%;position:relative;flex-shrink:0;border-right:1px dashed #eee;margin-right:10px;display:flex;align-items:flex-end;justify-content:center;">
                <img id="heirDynamicGif" class="heir-gif" src="${avatarUrl}" onclick="touchHeir2D()" style="max-height:100%;max-width:100%;object-fit:contain;filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.1));">
            </div>
            <div style="flex:1;overflow-y:auto;">
                <div style="text-align:right;">
                    <button class="switch-btn ${currentHeir.panelMode==='stats'?'active':''}" onclick="switchPanel('stats')">æ€§æ ¼</button>
                    <button class="switch-btn ${currentHeir.panelMode==='info'?'active':''}" onclick="switchPanel('info')">æ¡£æ¡ˆ</button>
                </div>
                ${middlePanelHtml}
            </div>
        </div>

        <div style="flex:1;display:flex;flex-direction:column;background:#f9f9f9;overflow:hidden;">
            <div id="heirChatArea" class="heir-chat-container" style="padding:10px;">
                <div style="text-align:center;color:#ccc;font-size:10px;margin-top:5px;">â€”â€” è®°å½• â€”â€”</div>
                ${(currentHeir.history||[]).map(h=>`<div class="heir-msg ${h.role}">${h.content}</div>`).join('')}
            </div>
            <div class="heir-input-area" style="padding:8px;">
                <div class="heir-input-row">
                    <input type="text" id="heirInput" class="heir-input-box" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeydown="if(event.key==='Enter') sendToHeir()">
                    <button class="heir-send-btn" onclick="sendToHeir()" style="padding:0 15px;font-size:13px;">å‘é€</button>
                </div>
                <div class="heir-func-row" style="margin-top:5px;">
                    <button class="heir-func-btn" onclick="toggleHeirSeason()">ğŸƒ æ¢å­£</button>
                    <button class="heir-func-btn" onclick="advanceYear()">â© è·³è¿‡ä»Šå¹´</button>
                </div>
            </div>
        </div>
    `;
    
    var chatArea = document.getElementById('heirChatArea');
    if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;
}



// 7. ğŸ“± æ‰‹æœºç³»ç»Ÿé€»è¾‘

// ================= ğŸ“± æ‰‹æœºç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ (å®Œæ•´åŠŸèƒ½ç‰ˆ) =================

// 1. æ‰“å¼€/å…³é—­æ‰‹æœº
function openPhone() {
    if (!document.getElementById('iphoneModal')) {
        var modal = document.createElement('div');
        modal.id = 'iphoneModal';
        modal.className = 'iphone-modal';
        document.body.appendChild(modal);
    }
    document.getElementById('iphoneModal').style.display = 'flex';
    renderPhoneHome();
}

function closePhone() {
    document.getElementById('iphoneModal').style.display = 'none';
    openEastPalace(); // åˆ·æ–°ä¸»ç•Œé¢
}

// 2. æ¸²æŸ“æ‰‹æœºæ¡Œé¢
function renderPhoneHome() {
    var modal = document.getElementById('iphoneModal');
    // å¼ºåˆ¶ç²‰è‰²å¤–è§‚
    modal.style.border = "6px solid #ffb7c5";
    modal.style.borderRadius = "35px";
    modal.style.background = "#fff0f5";

    var now = new Date();
    var timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

    modal.innerHTML = `
        <div class="iphone-chin-top"><div class="iphone-camera"></div><div class="iphone-speaker"></div></div>
        <div class="iphone-screen" style="background: url('https://files.catbox.moe/gsn7fd.png') center/cover;">
            <div class="iphone-statusbar" style="background:rgba(255,255,255,0.6); color:#333;">
                <span>HD</span><span>${timeStr}</span><span>88%</span>
            </div>
            
            <div class="app-grid" style="padding: 20px; gap: 15px;">
                <div class="app-icon" style="background:linear-gradient(135deg, #07c160, #2ecc71);" onclick="openApp('wechat')"><div style="font-size:24px;">ğŸ’¬</div><div class="app-name">å¾®èŠ</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #5352ed, #70a1ff);" onclick="openApp('spyware')"><div style="font-size:24px;">ğŸ‘ï¸</div><div class="app-name">ç›‘æŠ¤äºº</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ff9ff3, #f368e0);" onclick="openApp('matchmaker')"><div style="font-size:24px;">â¤ï¸</div><div class="app-name">å§»ç¼˜ç°¿</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ff6b81, #ff4757);" onclick="openApp('clothing')"><div style="font-size:24px;">ğŸ‘—</div><div class="app-name">é”¦è¡£é˜</div></div>
                
                <div class="app-icon" style="background:linear-gradient(135deg, #ff7675, #fab1a0);" onclick="openShopApp('hospital', 'å¤ªåŒ»å±€')"><div style="font-size:24px;">ğŸ¥</div><div class="app-name">å¤ªåŒ»å±€</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #74b9ff, #0984e3);" onclick="openShopApp('shop', 'çå®é˜')"><div style="font-size:24px;">ğŸ›ï¸</div><div class="app-name">çå®é˜</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ffeaa7, #fdcb6e);" onclick="openShopApp('meituan', 'å¾¡è†³æˆ¿')"><div style="font-size:24px;">ğŸ±</div><div class="app-name">å¾¡è†³æˆ¿</div></div>
            </div>
            
            <div id="activeAppWindow"></div>
        </div>
        <div class="iphone-chin-bottom" style="background:#fff0f5;"><button class="iphone-home-btn" onclick="closePhone()" style="border:2px solid #ffb7c5;"></button></div>
    `;
}

// 3. é€šç”¨è·¯ç”± (è§£å†³ç™½å±çš„å…³é”®)
function openApp(name) {
    var win = document.getElementById('activeAppWindow');
    win.innerHTML = '';
    var appDiv = document.createElement('div');
    appDiv.className = 'app-window';
    appDiv.style.background = "#f7f9fc"; // APPå†…éƒ¨èƒŒæ™¯è‰²
    
    // è¿™é‡Œè°ƒç”¨å…·ä½“çš„æ¸²æŸ“å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›å‡½æ•°å°±ä¼šç™½å±
    if (name === 'wechat') renderWeChat(appDiv);
    else if (name === 'clothing') renderClothingApp(appDiv);
    else if (name === 'spyware') renderSpywareApp(appDiv);
    else if (name === 'matchmaker') renderMatchmakerApp(appDiv);
    
    win.appendChild(appDiv);
    requestAnimationFrame(() => appDiv.classList.add('open'));
}

// ================= ğŸ‘— é”¦è¡£é˜ (æœè£…åº—) =================

// ğŸ‘— é”¦è¡£é˜ (é€»è¾‘æ›´æ–°ï¼šå±•ç¤ºé™æ€å›¾ï¼Œç©¿æˆ´åŠ¨æ€å›¾)
function renderClothingApp(container) {
    var gender = currentHeir.gender === 'ç”·' ? 'boy' : 'girl';
    var list = CLOTHING_DB[gender];
    if (!currentHeir.inventory) currentHeir.inventory = [];
    
    var gridHtml = list.map((item, idx) => {
        var isOwned = currentHeir.inventory.includes(item.name);
        
        // 1. å•†åº—å±•ç¤ºå›¾ (å§‹ç»ˆç”¨ urlï¼Œå¦‚æœæ˜¯æ•°ç»„å–ç¬¬0å¼ )
        var shopImgUrl = Array.isArray(item.url) ? item.url[0] : item.url;
        
        // 2. åˆ¤æ–­å½“å‰æ˜¯å¦ç©¿åœ¨èº«ä¸Š (æ¯”è¾ƒ gif é“¾æ¥)
        // æ³¨æ„ï¼šcurrentOutfit å­˜çš„æ˜¯ gif é“¾æ¥
        var currentGifUrl = Array.isArray(item.gif) ? item.gif[0] : item.gif;
        var isWearing = (currentHeir.currentOutfit === currentGifUrl) || 
                        (Array.isArray(item.gif) && item.gif.includes(currentHeir.currentOutfit));

        var btnText = isOwned ? (isWearing ? "å·²ç©¿æˆ´" : "ç©¿æˆ´") : "è´­ä¹°";
        var btnAction = isOwned ? `wearOutfit('${gender}', ${idx}, 0)` : `buyOutfit('${item.name}')`;
        var btnStyle = isOwned ? "background:#00b894" : "background:#ff7675";
        
        // 3. åˆ‡æ¢æ ·å¼æŒ‰é’® (å¦‚æœ gif æ˜¯æ•°ç»„ï¼Œè¯´æ˜æœ‰å¤šç§åŠ¨ä½œ)
        var toggleBtn = (Array.isArray(item.gif) && isOwned) 
            ? `<button class="shop-btn" style="background:#a29bfe; margin-top:5px; font-size:10px; width:100%;" onclick="wearOutfit('${gender}', ${idx}, 1)">ğŸ”„ æ¢ä¸ªåŠ¨ä½œ</button>` 
            : '';

        return `
            <div class="clothing-card" style="background:white; border-radius:8px; padding:10px; border:1px solid #eee; position:relative;">
                ${isOwned ? '<div style="position:absolute; top:5px; right:5px; background:#00b894; color:white; font-size:10px; padding:2px 5px; border-radius:4px;">å·²æ‹¥æœ‰</div>' : ''}
                <img src="${shopImgUrl}" class="clothing-img">
                <div style="font-weight:bold; font-size:12px; margin-bottom:2px;">${item.name}</div>
                <div style="font-size:10px; color:#999; margin-bottom:5px;">${item.desc}</div>
                <button class="shop-btn" style="${btnStyle}; width:100%;" onclick="${btnAction}">${btnText}</button>
                ${toggleBtn}
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">é”¦è¡£é˜</span>
            <span style="width:20px;"></span>
        </div>
        <div class="app-content">
            <div class="clothing-grid">${gridHtml}</div>
        </div>
    `;
}


function buyOutfit(name) {
    if (!currentHeir.inventory.includes(name)) {
        currentHeir.inventory.push(name);
        saveHeirData();
        auth.toast('ğŸ›ï¸ è´­ä¹°æˆåŠŸï¼');
        openApp('clothing'); // åˆ·æ–°
    }
}

// ç©¿æˆ´é€»è¾‘ (å­˜å…¥ GIF)

// ğŸ‘— ç©¿æˆ´é€»è¾‘ (ä¿®æ­£ç‰ˆï¼šå­˜å…¥åŠ¨å›¾)
function wearOutfit(gender, idx, variantIdx) {
    var item = CLOTHING_DB[gender][idx];
    
    // è·å–å¯¹åº”çš„åŠ¨å›¾é“¾æ¥
    // é€»è¾‘ï¼šå¦‚æœæ•°æ®é‡Œæœ‰ gif å­—æ®µï¼Œå°±ç”¨ gifï¼›å¦åˆ™ç”¨ urlï¼ˆé˜²æŠ¥é”™ï¼‰
    var targetGif = "";
    if (item.gif) {
        targetGif = Array.isArray(item.gif) ? item.gif[variantIdx || 0] : item.gif;
    } else {
        // å¦‚æœè¿™ä»¶è¡£æœæ²¡é…åŠ¨å›¾ï¼Œå°±å›é€€åˆ°é™æ€å›¾ï¼ˆæˆ–è€…ä½ å¯ä»¥å¡«ä¸€ä¸ªé»˜è®¤å›¾ï¼‰
        targetGif = Array.isArray(item.url) ? item.url[0] : item.url;
    }
    
    currentHeir.currentOutfit = targetGif; // ğŸ”¥ æ ¸å¿ƒï¼šæŠŠåŠ¨å›¾å­˜è¿›å­˜æ¡£
    saveHeirData();
    
    auth.toast(`ğŸ‘— å·²æ¢ä¸Šï¼š${item.name}`);
    openApp('clothing'); // åˆ·æ–°å•†åº—æ˜¾ç¤ºçŠ¶æ€
    openEastPalace();    // ç«‹å³åˆ·æ–°ä¸»é¡µ
}



// ================= â¤ï¸ æ‹çˆ±ç³»ç»Ÿ 2.0 (å¾ªåºæ¸è¿›ç‰ˆ) =================

let currentPartnerIdx = -1; // å½“å‰æ­£åœ¨æŸ¥çœ‹è°çš„è¯¦æƒ…

// 1. æ¸²æŸ“å§»ç¼˜ç°¿å…¥å£ (åˆ—è¡¨é¡µ)

// â¤ï¸ å§»ç¼˜ç°¿å…¥å£ (å¸¦è‡ªåŠ¨ä¿®å¤è¡¥ä¸)

// â¤ï¸ å§»ç¼˜ç°¿å…¥å£ (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶ä½å¥½æ„Ÿå¼€å±€)
async function renderMatchmakerApp(container) {
    // 1. å¹´é¾„æ£€æŸ¥
    if (currentHeir.age < 14) {
        container.innerHTML = `<div class="app-header"><button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>å§»ç¼˜ç°¿</div><div class="app-content" style="text-align:center;padding-top:50px;color:#999;">ğŸ‘¶ å­©å­è¿˜å°ï¼Œå­¦ä¸šä¸ºé‡ï¼<br>(14å²å¼€å¯)</div>`;
        return;
    }
    
    // 2. åˆå§‹åŒ–ä¸ä¿®å¤
    if (!currentHeir.dating) currentHeir.dating = { partners: [] };
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸å†ç»§æ‰¿æ—§çš„é«˜åˆ† matchï¼Œå¼ºåˆ¶é‡ç½®ä¸ºä½åˆ†
    let needSave = false;
    currentHeir.dating.partners.forEach(p => {
        if (!p.status) { p.status = 'ç›¸è¯†'; needSave = true; }
        
        // å¦‚æœå¥½æ„Ÿåº¦æœªå®šä¹‰ï¼Œæˆ–è€…å¥½æ„Ÿåº¦è¿‡é«˜ä½†çŠ¶æ€å´æ˜¯â€œç›¸è¯†â€ï¼ˆè¯´æ˜æ˜¯æ—§æ•°æ®é”™è¯¯ç»§æ‰¿äº†ï¼‰ï¼Œå¼ºåˆ¶é‡ç½®
        if (p.affinity === undefined || (p.affinity > 20 && p.status === 'ç›¸è¯†')) { 
            p.affinity = Math.floor(Math.random() * 15); // 0-15åˆ†ä¹‹é—´
            needSave = true; 
        }
        
        if (!p.logs) { p.logs = []; needSave = true; }
    });
    if (needSave) saveHeirData();

    // 3. å¦‚æœæ²¡å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„
    if (currentHeir.dating.partners.length === 0) await generatePartners();

    // 4. æ¸²æŸ“åˆ—è¡¨
    var listHtml = currentHeir.dating.partners.map((p, idx) => {
        let statusColor = '#999';
        if(p.status === 'çƒ­æ‹') statusColor = '#ff4757';
        if(p.status === 'æ‹çˆ±') statusColor = '#ff6b81';
        if(p.status === 'æ–­è”') statusColor = '#333';

        return `
        <div class="partner-card" onclick="openPartnerDetail(${idx})" style="cursor:pointer; display:flex; align-items:center; padding:15px;">
            <img src="${p.avatar}" class="partner-avatar">
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:14px;">${p.name} <span style="font-size:10px; background:${statusColor}; color:white; padding:2px 5px; border-radius:4px;">${p.status}</span></div>
                <div style="font-size:11px; color:#888; margin-top:3px;">${p.job} | ${p.nature}</div>
            </div>
            <div style="font-size:20px; color:#ddd;">â€º</div>
        </div>`;
    }).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">å§»ç¼˜ç°¿</span>
            <button class="app-header-btn" onclick="refreshPartners()">ğŸ”„</button>
        </div>
        <div class="app-content" style="background:#f7f9fc;">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px; text-align:center;">ç‚¹å‡»å¤´åƒæŸ¥çœ‹è¯¦æƒ…ä¸äº’åŠ¨</div>
            ${listHtml}
        </div>
    `;
}


   

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (äº’åŠ¨æ ¸å¿ƒ)

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (ä¿®å¤è¿”å›é”®)

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (ä¿®æ”¹ç‰ˆï¼šå»é™¤æŒ‰é’®ï¼Œæ”¹ä¸ºè¯­è¨€å¹²æ¶‰)
function openPartnerDetail(idx) {
    currentPartnerIdx = idx;
    var p = currentHeir.dating.partners[idx];
    
    var win = document.getElementById('activeAppWindow');
    var detailDiv = document.createElement('div');
    detailDiv.className = 'app-window open';
    detailDiv.style.zIndex = '30';

    var progress = Math.min(100, Math.max(0, p.affinity));
    
    // æ¸²æŸ“æ—¥å¿—
    var logsHtml = (p.logs || []).slice().reverse().map(l => 
        `<div class="love-log-item"><div class="love-log-date">${l.date}</div>${l.content}</div>`
    ).join('') || '<div style="text-align:center; margin-top:20px; color:#ccc;">æš‚æ— äº’åŠ¨è®°å½•</div>';

    // åº•éƒ¨äº’åŠ¨åŒºï¼šå¦‚æœæ˜¯æ–­è”ï¼Œæ˜¾ç¤ºç°è‰²ï¼›å¦åˆ™æ˜¾ç¤ºâ€œçº¦ä¼šâ€æŒ‰é’® + â€œå¹²æ¶‰å¯¹è¯æ¡†â€
    var actionArea = "";
    
    if (p.status === 'æ–­è”') {
        actionArea = `<button class="shop-btn" style="width:100%; background:#ccc; margin-top:10px;" disabled>ğŸ’” å…³ç³»å·²ç ´è£‚ï¼Œæ— æ³•æŒ½å›</button>`;
    } else {
        actionArea = `
            <button class="shop-btn" style="width:100%; background:#ff9a9e; margin-bottom:10px;" onclick="dateWithPartner()">ğŸ’Œ æ¥è§¦/çº¦ä¼š (AIå‰§æƒ…)</button>
            
            <div style="border-top:1px dashed #eee; padding-top:10px; margin-top:5px;">
                <div style="font-size:12px; color:#d66a80; margin-bottom:5px; font-weight:bold;">ğŸ’¬ å®¶é•¿å»ºè®® (å¹²æ¶‰)ï¼š</div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="interveneInput" placeholder="æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ(å¦‚:ç¦»ä»–è¿œç‚¹)" style="flex:1; border:1px solid #ffb7c5; border-radius:15px; padding:6px 10px; font-size:12px; outline:none;">
                    <button class="shop-btn" style="background:#fab1a0; width:auto; padding:6px 15px;" onclick="sendIntervention()">ğŸ—£ï¸ è¯´æ•™</button>
                </div>
            </div>
        `;
    }

    detailDiv.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">${p.name}</span>
            <span style="width:20px;"></span>
        </div>
        <div class="app-content" style="padding:15px; display:flex; flex-direction:column; height:calc(100% - 50px);">
            <div class="partner-detail-header">
                <img src="${p.avatar}" class="partner-big-avatar">
                <div style="font-weight:bold; font-size:16px;">${p.name}</div>
                <div style="color:#888; font-size:12px;">${p.desc}</div>
            </div>

            <div class="love-progress-box">
                <div class="love-status-text">
                    <span>å…³ç³»ï¼š${p.status}</span>
                    <span>å¥½æ„Ÿï¼š${p.affinity}/100</span>
                </div>
                <div class="love-bar-bg"><div class="love-bar-fill" style="width:${progress}%"></div></div>
            </div>

            <div class="love-log-area" id="loveLogArea" style="flex:1; margin-bottom:10px;">${logsHtml}</div>

            <div style="margin-top:auto;">
                ${actionArea}
            </div>
        </div>
    `;
    
    win.appendChild(detailDiv);
}

// ğŸ’¬ å‘é€å®¶é•¿å¹²æ¶‰ (æ–°åŠŸèƒ½)
async function sendIntervention() {
    var text = document.getElementById('interveneInput').value.trim();
    if (!text) { auth.toast('è¯·å…ˆè¾“å…¥ä½ è¦è¯´çš„è¯'); return; }
    
    // 1. ç•Œé¢åé¦ˆ
    document.getElementById('interveneInput').value = '';
    auth.toast('ğŸ’¬ æ­£åœ¨ä¼ è¾¾å®¶é•¿çš„æ•™è¯²...');

    var p = currentHeir.dating.partners[currentPartnerIdx];
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));

    // 2. æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„æ€§æ ¼æ ‡ç­¾ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆï¼š
    1. çš‡å—£çš„ååº”å°è¯ï¼ˆä½“ç°æ€§æ ¼ï¼‰ã€‚
    2. å¯¹è¿™æ®µå…³ç³»çš„å½±å“åˆ†æ•°ï¼ˆscoreï¼‰ã€‚
    
    é€»è¾‘å‚è€ƒï¼š
    - å¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¢åŠ ï¼ˆé€†åå¿ƒç†ï¼‰ã€‚
    - å¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å¬è¯ï¼ˆäº²å¯†é«˜/å›é€†ä½ï¼‰ï¼Œå¥½æ„Ÿé™ä½ã€‚
    - å¦‚æœæ˜¯æ”¯æŒ/å¤¸å¥–ï¼Œå¥½æ„Ÿå¢åŠ ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // 3. å¼¹å‡ºçš‡å—£çš„å›ç­”
        alert(`çš‡å—£å›åº”è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // 4. æ›´æ–°å¥½æ„Ÿåº¦
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score));
        
        // 5. å†™å…¥æ—¥å¿—
        p.logs.push({ 
            date: `${currentHeir.age}å²Â·å®¶é•¿å¹²æ¶‰`, 
            content: `å®¶é•¿ï¼š"${text}"<br>çš‡å—£ï¼š"${data.reply}" (å¥½æ„Ÿ${data.score>0?'+':''}${data.score})` 
        });

        // 6. æ›´æ–°å›é€†å€¼ (å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰)
        if (data.score < 0 || text.includes("ä¸è®¸") || text.includes("åˆ†")) {
             currentHeir.params.rebellion = Math.min(100, currentHeir.params.rebellion + 2);
        }

        // 7. åˆ·æ–°çŠ¶æ€
        updateRelationshipStatus(p);
        saveHeirData();
        
        // é‡æ–°æ‰“å¼€è¯¦æƒ…é¡µä»¥åˆ·æ–°æ˜¾ç¤º
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {
        console.error(e);
        auth.toast('âŒ æ²¡å¬æ¸…...(ç½‘ç»œé”™è¯¯)');
    }
}


// 3. ğŸ’Œ æ¥è§¦/çº¦ä¼šé€»è¾‘ (AI ç”Ÿæˆ)
async function dateWithPartner() {
    var p = currentHeir.dating.partners[currentPartnerIdx];
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½çº¦ä¼šï¼'); return; }

    auth.toast(`ğŸ’Œ çš‡å—£æ­£åœ¨å’Œ ${p.name} æ¥è§¦ä¸­...`);

    // æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚
    ä¸»è§’ï¼šçš‡å—£ï¼ˆ${currentHeir.age}å²ï¼Œæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼‰ã€‚
    å¯¹è±¡ï¼š${p.name}ï¼ˆèº«ä»½ï¼š${p.job}ï¼Œæ€§æ ¼ï¼š${p.desc}ï¼‰ã€‚
    å½“å‰å…³ç³»ï¼š${p.status} (å¥½æ„Ÿ ${p.affinity})ã€‚
    
    è¯·ç”Ÿæˆä¸€æ®µä¸¤äººäº’åŠ¨çš„ç®€çŸ­å‰§æƒ…ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    å¹¶æ ¹æ®äº’åŠ¨æƒ…å†µï¼Œåˆ¤æ–­å¥½æ„Ÿåº¦å˜åŒ–ï¼ˆ-10 åˆ° +10ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "story": "å‰§æƒ…å†…å®¹", "score": 5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // æ›´æ–°æ•°æ®
        p.affinity += data.score;
        p.logs.push({ date: `${currentHeir.age}å²Â·${currentHeir.season}`, content: data.story });
        
        // çŠ¶æ€åˆ¤å®šé€»è¾‘
        updateRelationshipStatus(p);
        
        saveHeirData();
        
        // åˆ·æ–°é¡µé¢
        document.querySelector('.app-window.open').remove(); // å…³æ‰æ—§è¯¦æƒ…é¡µ
        openPartnerDetail(currentPartnerIdx); // é‡æ–°æ‰“å¼€åˆ·æ–°
        
        auth.toast(data.score >= 0 ? 'ğŸ’– æ„Ÿæƒ…å‡æ¸©äº†ï¼' : 'ğŸ’” å‘ç”Ÿäº†ä¸€äº›ä¸æ„‰å¿«...');
        
    } catch(e) { console.error(e); auth.toast('âŒ çº¦ä¼šå¤±è´¥'); }
}

// 4. ğŸ’¬ å®¶é•¿å¹²æ¶‰é€»è¾‘
async function parentIntervene() {
    var p = currentHeir.dating.partners[currentPartnerIdx];
    var text = prompt(`ä½ æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ\n(ä¾‹å¦‚ï¼š"ç¦»ä»–è¿œç‚¹ï¼Œä»–æ˜¯åäºº" æˆ– "è¿™å­©å­ä¸é”™ï¼Œå¤šæ¥è§¦")`);
    
    if (!text) return;
    
    auth.toast('ğŸ’¬ æ­£åœ¨å¯¹çš‡å—£è¿›è¡Œè¯´æ•™...');
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆçš‡å—£çš„ååº”ã€‚
    å¹¶åˆ¤æ–­å¯¹è¿™æ®µå…³ç³»çš„å½±å“ï¼ˆå¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¯èƒ½å¢åŠ ï¼›å¦‚æœæ˜¯åŠåˆï¼Œä¹Ÿçœ‹æ€§æ ¼ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        alert(`çš‡å—£è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // æ›´æ–°æ•°æ®
        p.affinity += data.score;
        // å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰ï¼Œå¢åŠ å›é€†
        if (data.score < 0) currentHeir.params.rebellion += 5;
        
        updateRelationshipStatus(p);
        saveHeirData();
        
        // åˆ·æ–°
        document.querySelector('.app-window.open').remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {}
}

// 5. çŠ¶æ€åˆ¤å®šæœº
function updateRelationshipStatus(p) {
    if (p.affinity <= -20) {
        p.status = "æ–­è”"; // åˆ†æ‰‹/ç»äº¤
        p.logs.push({ date: "ç³»ç»Ÿ", content: "ğŸ’” å…³ç³»ç ´è£‚ï¼Œä»æ­¤é™Œè·¯ã€‚" });
    } else if (p.affinity < 20) {
        p.status = "ç›¸è¯†";
    } else if (p.affinity < 60) {
        p.status = "æš§æ˜§";
    } else if (p.affinity < 90) {
        p.status = "æ‹çˆ±";
    } else {
        p.status = "çƒ­æ‹";
    }
}

// åˆ·æ–°å…¨éƒ¨é€»è¾‘ (ä¿ç•™)
async function refreshPartners() {
    document.querySelector('.app-content').innerHTML = '<div style="text-align:center; padding:50px;">ğŸ’˜ æ­£åœ¨é‡æ–°å¯»è§…...</div>';
    await generatePartners();
    openApp('matchmaker');
}


// ================= ğŸ•µï¸ ç›‘æŠ¤äºº (å·çœ‹æ—¥è®°) =================

function renderSpywareApp(container) {
    // æ²¡æ—¥è®°ç”Ÿæˆä¸€æ¡
    if (!currentHeir.diary || currentHeir.diary.length === 0) {
        currentHeir.diary.push({ date: "æ˜¨æ—¥", content: "ä»Šå¤©å®¶é•¿åˆé€¼æˆ‘å­¦ä¹ äº†ï¼Œå¥½çƒ¦å•Š..." });
    }

    var listHtml = currentHeir.diary.slice().reverse().map(d => `
        <div class="diary-paper" style="background:#fffbf0; padding:12px; margin-bottom:10px; border-radius:6px; border-left:3px solid #ffb7c5; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <div style="font-size:12px; color:#999; border-bottom:1px dashed #ccc; margin-bottom:5px;">${d.date}</div>
            <div style="font-size:13px; color:#555; line-height:1.5;">${d.content}</div>
        </div>
    `).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span>ç›‘æŠ¤äºº Pro</span>
            <span></span>
        </div>
        <div class="app-content" style="background:#f0f0f0;">
            <div style="font-size:12px; color:#666; margin-bottom:10px;">ğŸ“Š æ­£åœ¨åŒæ­¥çš‡å—£è®¾å¤‡æ•°æ®...</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#333;">ğŸ“– ç§å¯†æ—¥è®°æœ¬ (å·²ç ´è§£)</div>
            ${listHtml}
        </div>
    `;
}

// ================= ğŸ›ï¸ å•†åº— & ç‰©å“è¯¦æƒ… (å¸¦æƒ³æ³•) =================

async function openShopApp(type, title) {
    var win = document.getElementById('activeAppWindow'); win.innerHTML = '';
    var appDiv = document.createElement('div'); appDiv.className = 'app-window';
    var items = currentHeir.phoneData.shops[type] || [];
    
    appDiv.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span>${title}</span>
            <button class="app-header-btn" onclick="refreshShopItems('${type}', '${title}')">ğŸ”„</button>
        </div>
        <div class="app-content" id="shopContent-${type}">
            ${items.length === 0 ? '<div style="text-align:center; padding:50px; color:#999;">æš‚æ— å•†å“<br>ç‚¹å‡»å³ä¸Šè§’è¿›è´§</div>' : renderShopList(items, type)}
        </div>
        <div id="itemDetailModal" class="item-detail-overlay"></div>
    `;
    win.appendChild(appDiv);
    requestAnimationFrame(() => appDiv.classList.add('open'));
    
    if(items.length === 0) refreshShopItems(type, title);
}

// ğŸ“œ æ¸²æŸ“å•†å“åˆ—è¡¨ (å±•ç¤º AI ç”Ÿæˆçš„æƒ³æ³•)
function renderShopList(items, type) {
    return items.map((item, idx) => {
        // å¦‚æœæ˜¯è€æ•°æ®æ²¡æœ‰ heirThoughtï¼Œå°±ç»™ä¸ªé»˜è®¤å€¼
        var thought = item.heirThought || "è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ã€‚";
        var stars = item.preference || "â­â­â­";

        return `
        <div class="shop-item" onclick="showItemDetail('${type}', ${idx})" style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">${item.name} ${item.icon||'ğŸ“¦'}</div>
                <div style="font-size:10px; color:#999; margin-bottom:4px;">${item.effectDesc}</div>
                
                <div class="heir-thought" style="background:#fff0f5; color:#d66a80; font-size:10px; padding:4px 8px; border-radius:8px; margin-top:5px; position:relative; font-style:italic;">
                    ğŸ’­ ${thought} <span style="float:right; font-style:normal;">${stars}</span>
                </div>
            </div>
            <button class="shop-btn" style="background:#74b9ff; color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer; margin-left:10px;" onclick="event.stopPropagation(); buyAIItem('${type}', ${idx})">è´­ä¹°</button>
        </div>`;
    }).join('');
}


// ğŸ§  çš‡å—£å¯¹ç‰©å“çš„æƒ³æ³• (å¢å¼ºç‰ˆï¼šè¯†åˆ«å…³é”®è¯+éšæœºåæ§½)
function getHeirThought(name, type) {
    // è¾…åŠ©ï¼šä»æ•°ç»„é‡Œéšæœºé€‰ä¸€å¥
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    // ğŸ¥ 1. åŒ»é™¢ (å¤ªåŒ»å±€)
    if (type === 'hospital') {
        // å¦‚æœæ²¡ç—…
        if (!currentHeir.body.sick) {
            return pick(["èº«ä½“å€å„¿æ£’ï¼Œä¸éœ€è¦è¿™ä¸ªã€‚", "è™½ç„¶æ²¡ç—…ï¼Œå¤‡ç€ä¹Ÿå¥½ï¼Ÿ", "çœ‹ç€å°±è‹¦...", "å¤ªåŒ»å±€çš„ä¸œè¥¿å¥½è´µã€‚", "ç»™çˆ¶å›ç•™ç€ï¼Ÿ"]);
        }
        // å¦‚æœç”Ÿç—…äº†ï¼Œæ ¹æ®è¯ååæ§½
        if (name.includes('é’ˆ') || name.includes('åˆº')) return pick(["å‘œ...æ€•ç–¼...", "èƒ½ä¸èƒ½ä¸æ‰é’ˆï¼Ÿ", "çœ‹ç€å¥½å°–é”..."]);
        if (name.includes('æ±¤') || name.includes('è¯')) return pick(["é—»ç€å°±å¥½è‹¦...", "ä¸€å®šè¦å–å—ï¼Ÿ", "è‰¯è¯è‹¦å£...å‘•...", "èƒ½åŠ ç‚¹ç³–å—ï¼Ÿ"]);
        if (name.includes('ä¸¹') || name.includes('ä¸¸')) return pick(["è¿™é¢—èƒ½æ²»å¥½æˆ‘å—ï¼Ÿ", "ä¸€å£åæ‰ï¼", "åƒç³–è±†ï¼Œä½†è‚¯å®šä¸å¥½åƒã€‚"]);
        if (name.includes('æ²»æ„ˆ') || name.includes('å›æ˜¥')) return pick(["æ•‘å‘½ç¨»è‰...", "å¸Œæœ›èƒ½å¿«ç‚¹å¥½èµ·æ¥ã€‚", "ä¸æƒ³å†èººç€äº†..."]);
        
        // é»˜è®¤ç”Ÿç—…ååº”
        return pick(["éš¾å—...", "å¤´å¥½æ™•...", "æƒ³æ¯çš‡äº†...", "ä»€ä¹ˆæ—¶å€™èƒ½å¥½å•Š..."]);
    }
    
    // ğŸ± 2. å¤–å– (å¾¡è†³æˆ¿)
    if (type === 'meituan') {
        if (currentHeir.body.waste > 80) return "é¥¿å¾—èƒ½åƒä¸‹ä¸€å¤´ç‰›ï¼";
        if (name.includes('è¾£')) return pick(["çœ‹ç€å°±å¥½çˆ½ï¼", "å˜¶å“ˆ...æ„Ÿè§‰ä¼šå¾ˆè¾£ï¼"]);
        if (name.includes('ç”œ') || name.includes('ç³–') || name.includes('å¥¶')) return pick(["ç”œé£Ÿæ˜¯è£…åœ¨å¦ä¸€ä¸ªèƒƒé‡Œçš„ï¼", "çœ‹ç€å¥½å¹¸ç¦~"]);
        if (name.includes('è‹¦') || name.includes('å‡‰')) return "è¿™ä¸ª...å¥½åƒå—ï¼Ÿ";
        return pick(["çœ‹èµ·æ¥å¥½å¥½åƒï¼", "æµå£æ°´äº†...", "å¾¡è†³æˆ¿çš„æ‰‹è‰ºçœŸä¸é”™ã€‚", "æƒ³åƒï¼"]);
    }

    // ğŸ›ï¸ 3. å•†åº— (çå®é˜)
    if (type === 'shop') {
        // ä¹¦ç±ç±»ï¼šçœ‹å‹¤å‹‰å±æ€§
        if (name.includes('ä¹¦') || name.includes('ç»') || name.includes('ç±')) {
            return currentHeir.params.diligence > 60 ? 
                pick(["ä¹¦é¦™é—¨ç¬¬ï¼Œæ­£åˆæˆ‘æ„ã€‚", "è¿™æœ¬ä¹¦æˆ‘æ‰¾äº†å¥½ä¹…ï¼", "ä¸€æ—¥ä¸è¯»ä¹¦ï¼Œé¢ç›®å¯æ†ã€‚"]) : 
                pick(["å•Š...åˆè¦çœ‹ä¹¦å•Š...", "çœ‹ç€å°±å›°...", "èƒ½ä¸èƒ½ä¹°ç©å…·ï¼Ÿ"]);
        }
        // æ­¦å™¨/è¿åŠ¨ç±»ï¼šçœ‹æ€§åˆ«æˆ–ä½“é­„
        if (name.includes('å‰‘') || name.includes('æ­¦') || name.includes('å¼“')) {
            return (currentHeir.gender === 'ç”·' || currentHeir.params.rebellion > 50) ? 
                "é…·ï¼æˆ‘æƒ³è€è€ï¼" : "ç¨å¾®æœ‰ç‚¹é‡å‘¢...";
        }
        // ç©å…·ç±»
        if (name.includes('ç©') || name.includes('å¶') || name.includes('çƒ')) {
            return pick(["æƒ³è¦è¿™ä¸ªï¼", "çœ‹ç€å¥½ç©ï¼", "ä¹°ç»™æˆ‘å˜›~"]);
        }
        // é»˜è®¤
        return pick(["è¿™ä¸ªæœ‰ç‚¹æ„æ€ã€‚", "ä¹°ä¹°ä¹°ï¼", "ç¨å¾®æœ‰ç‚¹è´µå‘¢...", "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ"]);
    }

    return "è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ã€‚";
}


// ğŸ›ï¸ å•†åº—è¿›è´§ (AI ç”Ÿæˆç‰©å“ + çš‡å—£æƒ³æ³• + å–œçˆ±åº¦)
async function refreshShopItems(type, title) {
    var div = document.getElementById(`shopContent-${type}`);
    div.innerHTML = '<div style="text-align:center;padding:20px;">ğŸ¤– æ­£åœ¨æ ¹æ®çš‡å—£çš„å–œå¥½è¿›è´§...</div>';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { div.innerHTML = 'ğŸš« æ²¡ API Key'; return; }

    // æ„å»ºæ›´è¯¦ç»†çš„ Promptï¼ŒæŠŠçš‡å—£çš„æ€§æ ¼å‘Šè¯‰ AI
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚ç°åœ¨éœ€è¦ä¸ºçš‡å—£ï¼ˆæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼Œå¹´é¾„ï¼š${currentHeir.age}å²ï¼Œæ€§åˆ«ï¼š${currentHeir.gender}ï¼ŒçŠ¶æ€ï¼š${currentHeir.body.sick?'ç”Ÿç—…':'å¥åº·'}ï¼‰ç”Ÿæˆ 3 ä¸ªã€${title}ã€‘é‡Œçš„å•†å“ã€‚

    è¯·è¿”å› JSON æ•°ç»„ï¼Œæ¯ä¸ªå•†å“åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
    - name: å•†å“åç§°
    - icon: emojiå›¾æ ‡
    - effectDesc: åŠŸæ•ˆç®€è¿° (å¦‚: å¥åº·+20 / å¿ƒæƒ…+15)
    - detail: ç‰©å“çš„è¯¦ç»†ä»‹ç» (50å­—ä»¥å†…)
    - heirThought: çš‡å—£çœ‹åˆ°è¿™ä¸ªä¸œè¥¿çš„ç¬¬ä¸€ååº”/å†…å¿ƒåæ§½ (ä¸€å®šè¦ç¬¦åˆTaçš„æ€§æ ¼ï¼æ¯”å¦‚å‚²å¨‡çš„è¦å£æ˜¯å¿ƒéï¼Œè´ªåƒçš„è¦æµå£æ°´ï¼Œç”Ÿç—…è¦è¯´éš¾å—)
    - preference: çš‡å—£çš„å–œçˆ±ç¨‹åº¦ (è¯·ç›´æ¥è¿”å›æ˜Ÿæ˜Ÿç¬¦å·ï¼Œå¦‚ "â­â­â­â­" æˆ– "â­")
    `;
    
    try {
        var res = await fetchAI(prompt, config);
        // æ¸…ç† AI å¯èƒ½è¿”å›çš„ Markdown æ ¼å¼
        var jsonStr = res.replace(/```json/g,'').replace(/```/g,'').trim();
        var newItems = JSON.parse(jsonStr);
        
        // å­˜å…¥æ‰‹æœºæ•°æ®
        currentHeir.phoneData.shops[type] = newItems;
        saveHeirData();
        
        // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
        div.innerHTML = renderShopList(newItems, type);
    } catch(e) { 
        console.error(e);
        div.innerHTML = 'âŒ è¿›è´§å¤±è´¥ (AI æ ¼å¼é”™è¯¯)'; 
    }
}


function showItemDetail(type, idx) {
    var item = currentHeir.phoneData.shops[type][idx];
    var overlay = document.getElementById('itemDetailModal');
    overlay.innerHTML = `
        <button class="app-header-btn" style="align-self:flex-end;" onclick="document.getElementById('itemDetailModal').classList.remove('show')">Ã—</button>
        <div class="item-big-icon">${item.icon}</div>
        <h2 style="text-align:center; color:#d66a80;">${item.name}</h2>
        <div style="text-align:center; color:#999; margin-bottom:20px;">${item.effectDesc}</div>
        <div style="background:#f9f9f9; padding:15px; border-radius:15px; font-size:13px; color:#555; line-height:1.6;">
            ${item.detail || "æš‚æ— è¯¦ç»†ä»‹ç»..."}
        </div>
        <button class="shop-btn" style="width:100%; margin-top:20px; background:#74b9ff;" onclick="buyAIItem('${type}', ${idx}); document.getElementById('itemDetailModal').classList.remove('show')">ç«‹å³è´­ä¹°ä½¿ç”¨</button>
    `;
    requestAnimationFrame(() => overlay.classList.add('show'));
}

function buyAIItem(type, idx) {
    var item = currentHeir.phoneData.shops[type][idx];
    if(type==='hospital') { currentHeir.body.health = 100; if(item.name.includes('ç¥')) currentHeir.body.sick = false; }
    if(type==='shop') currentHeir.mood += 10;
    if(type==='meituan') currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 20);
    
    saveHeirData();
    auth.toast(`âœ¨ ä½¿ç”¨äº† ${item.name}ï¼`);
}


    


// ğŸ’¬ 5. å¾®èŠé˜²éªšæ‰°è¡¥ä¸ (è¯·æŠŠè¿™ä¸ªå‡½æ•°è¦†ç›–æ‰)
function openChatDetail(role, name) {
    // ... (å‰éƒ¨åˆ†æ¸²æŸ“ä»£ç ä¿æŒä¸å˜ï¼Œå‚è€ƒä¸Šæ–‡ openChatDetail) ...
    
    // åˆå§‹åŒ–æ•°æ®
    if(!currentHeir.phoneData.chats[role]) currentHeir.phoneData.chats[role] = { msgs: [], lastSender: 'ai' };
    var chatData = currentHeir.phoneData.chats[role];
    
    // ... æ¸²æŸ“èŠå¤©æ¡† DOM ...
    // (ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå‡è®¾ DOM å·²ç»å»ºå¥½ï¼Œé‡ç‚¹åœ¨ä¸‹é¢çš„é€»è¾‘)

    // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰å½“æœ€åä¸€æ¡æ˜¯æˆ‘å‘çš„(user)ï¼Œæˆ–è€…æ²¡è®°å½•æ—¶ï¼Œå¯¹æ–¹æ‰è¯´è¯
    // å¦‚æœæœ€åä¸€æ¡æ˜¯ AI å‘çš„(ai)ï¼Œä»–ä¼šç­‰ä½ ï¼Œç»å¯¹ä¸å‘ç¬¬äºŒæ¡éªšæ‰°ä½ ã€‚
    if (chatData.msgs.length === 0 || chatData.lastSender === 'user') {
        setTimeout(() => triggerPhoneReply(role, "INIT"), 1000);
    }
}

// ================= ğŸ’¬ å¾®èŠé€»è¾‘ (æ ¸å¿ƒæ–°å¢) =================

function renderWeChat(container) {
    // 1. è·å–çˆ¶å›çš„åå­—å’Œå¤´åƒ
    var fatherName = currentHeir.fatherName || "çˆ¶å›";
    var fatherAvatar = "https://files.catbox.moe/kp648j.jpeg"; // é»˜è®¤å¤´åƒ
    
    // å°è¯•åœ¨ç‰©å“åº“é‡Œæ‰¾åˆ°çˆ¶äº²ï¼Œè·å–ä»–çš„çœŸå®å¤´åƒ
    var fatherItem = items.find(i => i.name === fatherName);
    if (fatherItem) {
        var imgs = fatherItem.resources.filter(r => r.type === 'image');
        if (imgs.length > 0) fatherAvatar = imgs[Math.min(fatherItem.coverIndex||0, imgs.length-1)].content;
    }

    container.innerHTML = `
        <div class="app-header" style="background:#ededed; border-bottom:1px solid #dcdcdc;">
            <span class="app-back" onclick="this.parentElement.parentElement.remove()" style="color:#333;">â€¹ å¾®ä¿¡(3)</span>
            å¾®èŠ
        </div>
        <div class="app-content" style="padding:0; background:#fff;">
            
            <div class="chat-list-item" onclick="openChatDetail('father', '${fatherName}', '${fatherAvatar}')">
                <img src="${fatherAvatar}" class="chat-avatar">
                <div class="chat-info">
                    <div class="chat-name">${fatherName}</div>
                    <div class="chat-desc">[åœ¨çº¿] ä»Šå¤©çš„æŠ˜å­æ‰¹å®Œäº†å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="chat-list-item" onclick="openChatDetail('eunuch', 'å°å¾·å­', 'https://files.catbox.moe/fv8f8p.gif')">
                <img src="https://files.catbox.moe/fv8f8p.gif" class="chat-avatar" style="background:#eee;">
                <div class="chat-info">
                    <div class="chat-name">å°å¾·å­ (æ€»ç®¡)</div>
                    <div class="chat-desc">å¥´æ‰éšæ—¶å¬å€™å·®é£...</div>
                </div>
            </div>

            <div class="chat-list-item" onclick="openChatDetail('nanny', 'æŒäº‹å§‘å§‘', 'https://files.catbox.moe/4hxxkv.gif')">
                <img src="https://files.catbox.moe/4hxxkv.gif" class="chat-avatar" style="background:#eee;">
                <div class="chat-info">
                    <div class="chat-name">æŒäº‹å§‘å§‘ (ä¿å§†)</div>
                    <div class="chat-desc">å°æ®¿ä¸‹ä»Šå¤©åƒäº†ä¸€ç¢—è›‹ç¾¹...</div>
                </div>
            </div>

        </div>
    `;
}

// æ‰“å¼€èŠå¤©è¯¦æƒ…é¡µ
var currentChatRole = null;
function openChatDetail(role, name, avatar) {
    currentChatRole = role; // è®°å½•å½“å‰åœ¨å’Œè°èŠ
    
    // åˆ›å»ºä¸€ä¸ªæ–°çš„å­çª—å£è¦†ç›–åœ¨åˆ—è¡¨ä¸Š
    var detailDiv = document.createElement('div');
    detailDiv.className = 'app-window open'; // ç›´æ¥æ˜¾ç¤º
    detailDiv.style.zIndex = '20';
    
    detailDiv.innerHTML = `
        <div class="app-header" style="background:#ededed;">
            <span class="app-back" onclick="this.parentElement.parentElement.remove()" style="color:#333;">â€¹</span>
            ${name}
        </div>
        <div id="phoneChatBox" class="phone-chat-box">
            <div style="text-align:center; color:#ccc; font-size:10px; margin-top:10px;">â€”â€” ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº† â€”â€”</div>
        </div>
        <div style="padding:10px; background:#f5f5f5; border-top:1px solid #ddd; display:flex; gap:8px;">
            <input type="text" id="phoneChatInput" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px; outline:none;" placeholder="å‘æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendPhoneMsg()">
            <button onclick="sendPhoneMsg()" style="background:#07c160; color:white; border:none; padding:0 12px; border-radius:5px; font-weight:bold;">å‘é€</button>
        </div>
    `;
    
    document.getElementById('activeAppWindow').appendChild(detailDiv);
    
    // è§¦å‘ç¬¬ä¸€å¥é—®å€™
    triggerPhoneGreeting(role, name);
}

// æ‰‹æœºå‘æ¶ˆæ¯é€»è¾‘
async function sendPhoneMsg() {
    var input = document.getElementById('phoneChatInput');
    var text = input.value.trim();
    if (!text) return;

    // ä¸Šå±
    appendPhoneMsg('right', text);
    input.value = '';

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { appendPhoneMsg('left', 'ï¼ˆå¯¹æ–¹ä¿¡å·ä¸å¥½ï¼Œè¯·æ£€æŸ¥ API Keyï¼‰'); return; }

    // æ„å»º Prompt
    var roleDesc = "";
    if (currentChatRole === 'father') roleDesc = `ä½ æ˜¯çš‡å—£çš„çˆ¶äº²ã€${currentHeir.fatherName}ã€‘ï¼Œæ€§æ ¼å‚²å¨‡æˆ–æ·±æƒ…ã€‚`;
    else if (currentChatRole === 'eunuch') roleDesc = `ä½ æ˜¯å¤ªç›‘æ€»ç®¡ã€å°å¾·å­ã€‘ï¼Œå‘å¾®ã€ç‹—è…¿ã€å¿ è¯šã€‚`;
    else if (currentChatRole === 'nanny') roleDesc = `ä½ æ˜¯ç…§é¡¾çš‡å—£çš„ã€æŒäº‹å§‘å§‘ã€‘ï¼Œæ…ˆç¥¥ã€å” å¨ã€å…³æ³¨å­©å­å¥åº·ã€‚`;

    var prompt = `
    ã€çŸ­ä¿¡èŠå¤©æ¨¡å¼ã€‘
    ${roleDesc}
    
    è°ˆè¯å¯¹è±¡ï¼šå¥³çš‡é™›ä¸‹ï¼ˆç”¨æˆ·ï¼‰ã€‚
    ç›¸å…³çš‡å—£ï¼š${currentHeir.name} (${currentHeir.age}å², çŠ¶æ€:${currentHeir.body.sick?'ç”Ÿç—…':'å¥åº·'})ã€‚
    
    ç”¨æˆ·å‘æ¥å¾®ä¿¡ï¼š"${text}"
    
    è¯·å›å¤çŸ­ä¿¡å†…å®¹ï¼ˆç®€çŸ­ï¼Œå£è¯­åŒ–ï¼Œä¸è¦åŠ¨ä½œæå†™ï¼‰ã€‚
    `;

    try {
        var res = await fetchAI(prompt, config);
        // æ¨¡æ‹Ÿå»¶è¿Ÿ
        setTimeout(() => {
            appendPhoneMsg('left', res);
        }, 1000);
    } catch(e) {
        appendPhoneMsg('left', 'ï¼ˆå‘é€å¤±è´¥...ï¼‰');
    }
}

// è‡ªåŠ¨è§¦å‘å¼€åœºç™½
async function triggerPhoneGreeting(role, name) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var prompt = "";
    if (role === 'father') prompt = `ä½ æ˜¯${name}ï¼Œå¥³çš‡çš„ç”·å® ï¼Œå­©å­çš„çˆ¶äº²ã€‚å­©å­${currentHeir.age}å²äº†ã€‚è¯·ç»™å¥³çš‡å‘ä¸€æ¡å¾®ä¿¡ï¼Œé—®é—®å­©å­çš„æƒ…å†µï¼Œæˆ–è€…æ’’ä¸ªå¨‡ã€‚`;
    else if (role === 'eunuch') prompt = `ä½ æ˜¯å°å¾·å­ã€‚è¯·ç»™å¥³çš‡å‘å¾®ä¿¡ï¼Œè¯·å®‰ï¼Œå¹¶æ±‡æŠ¥ä»Šå¤©å®«é‡Œå¹³å®‰æ— äº‹ã€‚`;
    else if (role === 'nanny') prompt = `ä½ æ˜¯æŒäº‹å§‘å§‘ã€‚è¯·ç»™å¥³çš‡å‘å¾®ä¿¡ï¼Œæ±‡æŠ¥çš‡å—£${currentHeir.name}ä»Šå¤©çš„åƒé¥­/ç¡è§‰æƒ…å†µã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        appendPhoneMsg('left', res);
    } catch(e) {}
}

function appendPhoneMsg(side, text) {
    var box = document.getElementById('phoneChatBox');
    if (!box) return;
    var div = document.createElement('div');
    div.className = `phone-msg ${side}`;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

// ================= ğŸ¥ å…¶ä»– APP æ¸²æŸ“é€»è¾‘ =================

function renderHospital(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>å¤ªåŒ»å±€åœ¨çº¿</div>
        <div class="app-content">
            <div style="padding:15px; background:#fff0f0; border-radius:10px; margin-bottom:15px; text-align:center; color:#d63031; border:1px solid #ffcccc;">
                <div style="font-size:30px; margin-bottom:5px;">${currentHeir.body.sick ? 'ğŸ˜·' : 'ğŸ˜Š'}</div>
                <div style="font-weight:bold;">${currentHeir.name} çš„ç—…å†</div>
                <div style="font-size:12px; margin-top:5px;">å¥åº·å€¼: ${currentHeir.body.health}%</div>
                <div style="font-size:12px;">çŠ¶æ€: ${currentHeir.body.sick ? 'æ‚£ç—…ä¸­ (éœ€æ²»ç–—)' : 'èº«ä½“å¥åº·'}</div>
            </div>
            
            <div style="font-size:12px; color:#999; margin-bottom:5px; margin-left:5px;">ä¸“å®¶å·</div>
            
            <div class="shop-item">
                <div>
                    <div style="font-weight:bold;">ğŸ’Š å›æ˜¥ä¸¹ (æ²»æ„ˆç”Ÿç—…)</div>
                    <div style="font-size:10px; color:#999;">å¤ªåŒ»é™¢ç§˜åˆ¶ï¼ŒåŒ…æ²»ç™¾ç—…</div>
                </div>
                <button class="shop-btn hospital" onclick="buyItem('cure')">é—®è¯Š</button>
            </div>
            
            <div class="shop-item">
                <div>
                    <div style="font-weight:bold;">ğŸ’‰ å¼ºèº«æ±¤ (å¥åº·+20)</div>
                    <div style="font-size:10px; color:#999;">äººå‚é¹¿èŒ¸ç†¬åˆ¶</div>
                </div>
                <button class="shop-btn hospital" onclick="buyItem('heal')">å¼€è¯</button>
            </div>
        </div>
    `;
}

function renderShop(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>çå®é˜</div>
        <div class="app-content">
            <div class="shop-item">
                <div>ğŸ§¸ <b>å¸ƒè€è™</b> <span style="color:#aaa;font-size:10px;">å¿ƒæƒ…+10</span></div>
                <button class="shop-btn" onclick="buyItem('toy')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div>ğŸ“š <b>å››ä¹¦äº”ç»</b> <span style="color:#aaa;font-size:10px;">æ™ºæ…§+5</span></div>
                <button class="shop-btn" onclick="buyItem('book')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div>âš”ï¸ <b>æ¡ƒæœ¨å‰‘</b> <span style="color:#aaa;font-size:10px;">ä½“é­„+5</span></div>
                <button class="shop-btn" onclick="buyItem('sword')">è´­ä¹°</button>
            </div>
        </div>
    `;
}

function renderMeituan(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>å¾¡è†³æˆ¿å¤–å–</div>
        <div class="app-content">
            <div style="background:#fff7e6; padding:10px; font-size:12px; color:#d46b08; border-radius:8px; margin-bottom:15px;">
                ğŸ¥¡ åªæœ‰åƒé¥±äº†ï¼Œæ‰èƒ½æ¶ˆé™¤ç–²åŠ³(åºŸå“å€¼)å“¦ï¼
            </div>
            
            <div class="shop-item">
                <div>ğŸ¥¤ <b>å†°é•‡é…¸æ¢…æ±¤</b> <span style="color:#aaa;font-size:10px;">åºŸå“-10</span></div>
                <button class="shop-btn food" onclick="buyItem('tea')">ä¸‹å•</button>
            </div>
            <div class="shop-item">
                <div>ğŸ² <b>æ»¡æ±‰å…¨å¸­(å•äºº)</b> <span style="color:#aaa;font-size:10px;">åºŸå“-30</span></div>
                <button class="shop-btn food" onclick="buyItem('hotpot')">ä¸‹å•</button>
            </div>
        </div>
    `;
}

// 5. è´­ä¹°é€»è¾‘ (é€šç”¨)
function buyItem(type) {
    if (type === 'cure') {
        if (!currentHeir.body.sick) { auth.toast('èº«ä½“å€å„¿æ£’ï¼Œä¸ç”¨æ²»ï¼'); return; }
        currentHeir.body.sick = false; currentHeir.body.health = 100; auth.toast('âœ¨ å¦™æ‰‹å›æ˜¥ï¼ç—Šæ„ˆäº†ï¼');
    } else if (type === 'heal') {
        currentHeir.body.health = Math.min(100, currentHeir.body.health + 20); auth.toast('ğŸ’‰ å–äº†è¯ï¼Œæ„Ÿè§‰å¥½å¤šäº†');
    } else if (type === 'toy') {
        currentHeir.mood = Math.min(100, currentHeir.mood + 10); auth.toast('ğŸ§¸ æ”¶åˆ°ç¤¼ç‰©å¾ˆå¼€å¿ƒï¼');
    } else if (type === 'book') {
        currentHeir.params.wisdom += 5; auth.toast('ğŸ“š è¯»äº†ä¹¦ï¼Œå˜èªæ˜äº†');
    } else if (type === 'sword') {
        currentHeir.params.fitness += 5; auth.toast('âš”ï¸ å˜¿å“ˆï¼ä½“é­„å¢å¼ºäº†');
    } else if (type === 'tea') {
        currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 10); auth.toast('ğŸ¥¤ å¥½å–ï¼è§£ä¹ï¼');
    } else if (type === 'hotpot') {
        currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 30); auth.toast('ğŸ² åƒæ’‘äº†ï¼ç–²åŠ³å…¨æ¶ˆï¼');
    }
    
    saveHeirData();
    
    // åˆ·æ–°ä¸€ä¸‹å½“å‰APPçš„æ˜¾ç¤º (å¦‚æœåœ¨åŒ»é™¢ï¼Œåˆ·æ–°ç—…å†çŠ¶æ€)
    var activeApp = document.querySelector('.app-window:last-child');
    if(activeApp && activeApp.innerHTML.includes('ç—…å†')) {
        renderHospital(activeApp); // é‡æ–°æ¸²æŸ“åŒ»é™¢ç•Œé¢
    }
}

// 8. åˆ‡æ¢é¢æ¿
function switchPanel(mode) { currentHeir.panelMode = mode; saveHeirData(); openEastPalace(); }

// 9. ğŸ’¬ å‘é€æ¶ˆæ¯
async function sendToHeir() {
    if (currentHeir.isDead) return;
    var input = document.getElementById('heirInput');
    var text = input.value.trim();
    if (!text) return;

    addChatBubble('user', text);
    input.value = '';
    currentHeir.isWaitingForReply = false;
    currentHeir.body.waste += 2;
    if(currentHeir.body.waste > 80 && !currentHeir.body.sick && Math.random() > 0.7) {
        currentHeir.body.sick = true; auth.toast('ğŸ˜· å¤ªç´¯äº†ï¼Œç”Ÿç—…äº†ï¼');
    }
    saveHeirData();

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { addChatBubble('ai', 'ï¼ˆæ— API Keyï¼‰'); return; }

    var prompt = `
    è§’è‰²:${currentHeir.name},${currentHeir.age}å²,${currentHeir.season}å­£ã€‚
    çŠ¶æ€:å¥åº·${currentHeir.body.health},ç”Ÿç—…:${currentHeir.body.sick},å¿ƒæƒ…${currentHeir.mood}ã€‚
    å±æ€§:${JSON.stringify(currentHeir.params)}ã€‚
    ç”¨æˆ·è¯´:"${text}"
    ä»»åŠ¡:
    1. å¦‚ç”¨æˆ·é—®â€œå‡ºå»ç©/å‡ºå®«â€ï¼ŒåŒæ„åˆ™allowTravel:trueã€‚
    2. å¦‚æœç”Ÿç—…äº†ï¼Œå›å¤è¦è™šå¼±ã€‚
    JSON: { "reply":"", "innerThought":"", "action":"", "allowTravel":false, "changes":{} }
    `;

    showTyping();

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        updateHeirStats(data.changes);
        currentHeir.lastThought = data.innerThought; 
        
        var replyHtml = data.reply;
        if (data.allowTravel && !currentHeir.body.sick) replyHtml += `<br><button onclick="openTravelMap()" style="margin-top:5px; background:#ff9a9e; color:white; border:none; padding:4px 12px; border-radius:15px; cursor:pointer; font-size:12px;">ğŸš— å¤‡è½¦å‡ºå‘</button>`;
        
        var area = document.getElementById('heirChatArea');
        var div = document.createElement('div');
        div.className = `heir-msg ai`; div.innerHTML = replyHtml; 
        area.appendChild(div); area.scrollTop = area.scrollHeight;
        
        if (!currentHeir.history) currentHeir.history = [];
        currentHeir.history.push({ role: 'ai', content: data.reply }); 
        if (data.action) smartUpdateHeirScene(data.action);
        
        saveHeirData();
        checkRunaway(); checkDeath();
    } catch (e) { addChatBubble('ai', '...'); }
}

// 10. ğŸŒ¸ æ¢å­£
function toggleHeirSeason() {
    if (currentHeir.isDead || currentHeir.age >= 18) return;
    var seasons = ['æ˜¥', 'å¤', 'ç§‹', 'å†¬'];
    var nextIdx = seasons.indexOf(currentHeir.season) + 1;

    if (currentHeir.body.sick) { currentHeir.body.health -= 30; auth.toast('âš ï¸ ç—…æƒ…åŠ é‡ï¼'); }
    else if (Math.random() > 0.85) { currentHeir.body.sick = true; auth.toast('ğŸ˜· æ¢å­£ç”Ÿç—…äº†ï¼'); }

    if (nextIdx > 3) advanceYear(); 
    else {
        currentHeir.season = seasons[nextIdx];
        currentHeir.bioLog.push(`ã€${currentHeir.age}å²Â·${currentHeir.season}ã€‘ï¼šæ¢å­£äº†ã€‚`);
        saveHeirData(); openEastPalace(); checkDeath();
writeDailyDiary(); 

    }
}

// ================= ğŸ“ 5.0 æ ¸å¿ƒï¼šæˆäººç¤¼ä¸å¯è§†åŒ–ç»“ç®— =================

// 1. æ£€æŸ¥å¹¶ç»“ç®—æˆå°±
function checkAchievements() {
    if (!currentHeir.achievements) currentHeir.achievements = [];
    
    ACHIEVEMENT_DB.forEach(ach => {
        // å¦‚æœè¿˜æ²¡è·å¾—ï¼Œä¸”æ»¡è¶³æ¡ä»¶
        if (!currentHeir.achievements.includes(ach.name) && ach.req(currentHeir)) {
            currentHeir.achievements.push(ach.name);
            auth.toast(`ğŸ† è§£é”æˆå°±ï¼šã€${ach.name}ã€‘`);
        }
    });
}

// 2. å¼€å¯æˆäººç¤¼ (ç»“ç®—ç•Œé¢)
async function openAdultCeremony() {
    // å…³é—­å…¶ä»–çª—å£
    document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
    
    // 1. åˆ¤å®šèŒä¸š
    let bestCareer = CAREER_DB[CAREER_DB.length - 1]; // é»˜è®¤å¹³æ°‘
    let bestIndex = CAREER_DB.length - 1;

    // å€’åºéå†ï¼Œæ‰¾åˆ°æœ€é«˜çº§ä¸”ç¬¦åˆæ¡ä»¶çš„èŒä¸š
    for (let i = 0; i < CAREER_DB.length; i++) {
        let job = CAREER_DB[i];
        let qualified = true;
        
        // æ£€æŸ¥æ¯ä¸€é¡¹ç¡¬æ€§æŒ‡æ ‡
        for (let reqKey in job.req) {
            let currentVal = currentHeir.params[reqKey] || 0;
            // å¦‚æœæ˜¯è´Ÿæ•°è¦æ±‚ï¼ˆä¾‹å¦‚ rebellion: -1ï¼‰ï¼Œä»£è¡¨â€œä¸èƒ½è¶…è¿‡â€
            if (job.req[reqKey] < 0) { 
                 /* æš‚ä¸å¤„ç†ç‰¹æ®Šé€»è¾‘ï¼ŒæŒ‰æ ‡å‡†å¤§äºç­‰äºå¤„ç† */ 
            } else {
                if (currentVal < job.req[reqKey]) { qualified = false; break; }
            }
        }
        
        if (qualified) {
            bestCareer = job;
            bestIndex = i;
            break; // æ‰¾åˆ°äº†å°±åœæ­¢ (å‰ææ˜¯CAREER_DBæŒ‰ä¼˜å…ˆçº§æ’åºäº†ï¼Œæˆ–è€…åè¿‡æ¥)
        }
    }

    currentHeir.career = bestCareer.name;
    
    // å­˜å…¥å®¶æ—
    archiveHeirToFamily(currentHeir);
    saveHeirData();

    // 2. æ„å»ºå¯è§†åŒ– HTML
    var modal = document.querySelector('#eastPalaceModal .modal');
    // ä¸´æ—¶æ”¹å˜æ ·å¼ä¸ºå…¨å±
    modal.className = "modal adult-modal"; 
    document.getElementById('eastPalaceModal').classList.add('active');

    // ç”Ÿæˆå±æ€§åˆ¤å®šæ¡ HTML
    let judgeHtml = "";
    if (bestCareer.name === "å¹³æ°‘") {
        judgeHtml = "<div style='text-align:center;color:#999;font-size:12px;'>å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸ...</div>";
    } else {
        for (let key in bestCareer.req) {
            let reqVal = bestCareer.req[key];
            let curVal = currentHeir.params[key] || 0;
            let isPass = curVal >= reqVal;
            let pct = Math.min(100, (curVal / 120) * 100); // è¿›åº¦æ¡é•¿åº¦
            let lineLeft = Math.min(100, (reqVal / 120) * 100); // è¾¾æ ‡çº¿ä½ç½®

            // å±æ€§åæ±‰åŒ–
            let label = {wisdom:'æ™ºæ…§',fitness:'ä½“é­„',charm:'é­…åŠ›',diligence:'å‹¤å‹‰',rebellion:'å›é€†',morality:'é“å¾·',ambition:'é‡å¿ƒ',affection:'äº²å¯†'}[key] || key;

            judgeHtml += `
            <div class="judge-row">
                <span class="judge-label">${label}</span>
                <div class="judge-track">
                    <div class="judge-bar ${isPass?'pass':'fail'}" style="width:${pct}%"></div>
                    <div class="judge-line" style="left:${lineLeft}%" title="è¦æ±‚: ${reqVal}"></div>
                </div>
                <div class="judge-val">
                    ${curVal}/${reqVal} ${isPass?'âœ…':'âŒ'}
                </div>
            </div>`;
        }
    }

    // ç”Ÿæˆæˆå°± HTML
    let achHtml = currentHeir.achievements.map(a => `<span class="ach-badge">ğŸ† ${a}</span>`).join('');
    if(!achHtml) achHtml = `<span style="color:#ccc;font-size:12px;">(æœ¬æ¬¡äººç”Ÿæš‚æ— ç‰¹æ®Šæˆå°±)</span>`;

    // æ¸²æŸ“ç•Œé¢
    modal.innerHTML = `
        <div class="adult-header">âœ¨ å† ç¤¼ Â· æˆäººç»“ç®— âœ¨</div>
        <div class="adult-content">
            
            <div class="career-card-large">
                <div class="career-icon-big">ğŸ“</div>
                <div class="career-title-big">${bestCareer.name}</div>
                <div class="career-desc">"${bestCareer.type === 'bad' ? 'æœ‰äº›è·¯ï¼Œä¸€æ—¦èµ°é”™å°±å›ä¸å»äº†...' : 'å‰ç¨‹ä¼¼é”¦ï¼Œæœªæ¥å¯æœŸã€‚'}"</div>
            </div>

            <div class="judge-box">
                <div class="judge-title">ğŸ“‹ èŒä¸šèµ„è´¨åˆ¤å®šä¹¦</div>
                ${judgeHtml}
            </div>

            <div class="judge-box" style="border-left:3px solid #ff9a9e;">
                <div class="judge-title">ğŸ… äººç”Ÿæˆå°±</div>
                <div class="achievement-grid">${achHtml}</div>
            </div>

            <div class="judge-box" style="background:#fffbf0; border:none;">
                <div class="judge-title">ğŸ’Œ ${currentHeir.name} çš„ç¦»å®¶ç•™è¨€</div>
                <div id="careerLetter" class="farewell-letter">
                    <div class="ai-loading">âœï¸ æ­£åœ¨æŒ¥æ³ªå†™ä¿¡...</div>
                </div>
            </div>

            <button onclick="closeEastPalace(); location.reload();" class="primary-btn" style="width:100%; margin-top:20px; padding:15px; font-size:16px;">
                ğŸ‘‹ å­©å­é•¿å¤§äº† (å½’æ¡£å¹¶å…è®¸ç”ŸäºŒèƒ)
            </button>
        </div>
    `;

    // 3. è°ƒç”¨ AI ç”Ÿæˆç¦»åˆ«ä¿¡
    generateCareerStory(bestCareer.name);
}

// 3. AI ç”Ÿæˆå°±èŒæ„Ÿè¨€
async function generateCareerStory(job) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        document.getElementById('careerLetter').innerHTML = "ï¼ˆAI æ²¡ç”µäº†ï¼Œå­©å­é»˜é»˜åœ°èµ°äº†...ï¼‰";
        return;
    }

    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚æˆ‘çš„çš‡å—£ã€${currentHeir.name}ã€‘ä»Šå¤©18å²æˆå¹´äº†ã€‚
    ç»è¿‡å¤šå¹´çš„åŸ¹å…»ï¼Œä»–/å¥¹æœ€ç»ˆæˆä¸ºäº†ã€${job}ã€‘ã€‚
    
    æ€§æ ¼å±æ€§ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    äººç”Ÿæˆå°±ï¼š${currentHeir.achievements.join(',')}ã€‚
    
    è¯·ä»¥ã€çš‡å—£çš„ç¬¬ä¸€äººç§°ã€‘ï¼Œå†™ä¸€å°ç»™æˆ‘çš„â€œç¦»å®¶å‘Šåˆ«ä¿¡â€ï¼ˆ100å­—å·¦å³ï¼‰ã€‚
    å†…å®¹è¦æ±‚ï¼š
    1. æåˆ°è‡ªå·±å¯¹è¿™ä¸ªèŒä¸šçš„çœ‹æ³•ï¼ˆå–œæ¬¢/æ— å¥ˆ/é‡å¿ƒï¼‰ã€‚
    2. å›å¿†ä¸€ä»¶å°æ—¶å€™çš„äº‹ï¼ˆæ ¹æ®æ€§æ ¼çç¼–ä¸€ä»¶æ¸©é¦¨æˆ–æ‰å¿ƒçš„ï¼‰ã€‚
    3. è¡¨è¾¾å¯¹æ¯äº²ï¼ˆå¥³çš‡ï¼‰çš„æ„Ÿè°¢æˆ–æ€¨æ¨ï¼ˆçœ‹äº²å¯†åº¦å’Œå›é€†å€¼ï¼‰ã€‚
    `;

    try {
        const res = await fetchAI(prompt, config);
        document.getElementById('careerLetter').innerHTML = res.replace(/\n/g, '<br>');
        
        // å­˜å…¥ç”Ÿå¹³
        currentHeir.bioLog.push(`ã€18å²Â·ç»“å±€ã€‘ï¼š${res}`);
        saveHeirData();
    } catch(e) {
        document.getElementById('careerLetter').innerText = "ï¼ˆå­©å­èµ°å¾—å¤ªæ€¥ï¼Œæ²¡ç•™ä¸‹ä¹¦ä¿¡...ï¼‰";
    }
}

// 11. ğŸ‚ é•¿å¤§

// ğŸ‚ é•¿å¤§ä¸€å² (èŒä¸šåˆ¤å®š + å®¶æ—å½’æ¡£)

// ğŸ‚ é•¿å¤§ä¸€å² (æ¥å…¥æˆäººç¤¼ç‰ˆ)
function advanceYear() {
    if (currentHeir.isDead) return;
    
    // ğŸ” æ¯å¹´æ£€æŸ¥ä¸€æ¬¡æˆå°±
    checkAchievements();

    // ğŸ“ 18å²æˆäººç¤¼è§¦å‘ç‚¹
    if (currentHeir.age === 17) {
        currentHeir.age = 18;
        // ç›´æ¥è¿›å…¥ç»“ç®—æµç¨‹ï¼Œä¸ç›´æ¥ä¿å­˜careerï¼Œäº¤ç»™ openAdultCeremony å¤„ç†
        openAdultCeremony();
        return;
    }

    if (currentHeir.age >= 18) {
        auth.toast('ğŸ“ å­©å­å·²æˆå¹´åœ¨å¤–æ‰“æ‹¼...');
        currentHeir.age += 1;
    } else {
        currentHeir.age += 1;
        currentHeir.season = 'æ˜¥'; // æœªæˆå¹´é‡ç½®å­£èŠ‚
        
        // ç”Ÿé•¿å‘è‚² (èº«é«˜ä½“é‡)
        currentHeir.body.height += (5 + Math.floor(Math.random()*5));
        currentHeir.body.weight += (2 + Math.floor(Math.random()*3));
    }

    currentHeir.bioLog.push(`â€”â€”â€” ${currentHeir.age} å² â€”â€”â€”`);
    
    saveHeirData();
    openEastPalace();
    
    if(typeof checkDeath === 'function') checkDeath();
    if(typeof writeDailyDiary === 'function') writeDailyDiary();
}



// 12. ğŸ’€ æ­»äº¡
function checkDeath() {
    if (currentHeir.body.health <= 0) {
        currentHeir.isDead = true;
        currentHeir.bioLog.push(`ã€${currentHeir.age}å²ã€‘ï¼šå› ç—…é‡ä¸æ²»ï¼Œä¸å¹¸å¤­æŠ˜ã€‚`);
        saveHeirData(); renderDeadView();
    }
}
function renderDeadView() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    modalContent.innerHTML = `<button class="close-modal" onclick="closeEastPalace()" style="position:absolute; right:10px; top:10px; color:#aaa;">Ã—</button><div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#000; color:#fff;"><div style="font-size:60px;">ğŸª¦</div><h3 style="margin:10px 0; color:#d63031;">é¦™æ¶ˆç‰æ®’</h3><p style="font-size:12px; text-align:center; padding:0 30px; color:#aaa;">${currentHeir.name} çš„ç”Ÿå‘½æ°¸è¿œåœç•™åœ¨äº† ${currentHeir.age} å²ã€‚</p><button onclick="openMemories()" style="margin-top:20px; padding:10px 20px; border:1px solid #555; background:#333; color:#fff; border-radius:20px;">ğŸ“– æŸ¥çœ‹ç”Ÿå¹³</button></div>`;
}

// 13. è¾…åŠ©
function getAvatarUrl(state) {
    var isBoy = currentHeir.gender === 'ç”·';
    var assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    if (state === 'yawn') return assets.yawn;
    if (state === 'shy') return assets.shy;
    return Array.isArray(assets.idle) ? assets.idle[Math.floor(Math.random()*assets.idle.length)] : assets.idle;
}
function addChatBubble(role, text) {
    var area = document.getElementById('heirChatArea');
    var div = document.createElement('div');
    div.className = `heir-msg ${role}`; div.innerText = text;
    area.appendChild(div); area.scrollTop = area.scrollHeight;
    if (!currentHeir.history) currentHeir.history = [];
    currentHeir.history.push({ role: role, content: text });
}
function showTyping() {
    var area = document.getElementById('heirChatArea');
    var div = document.createElement('div');
    div.id = 'heirTyping'; div.innerText = 'âœï¸...'; div.style.cssText = "font-size:10px; color:#aaa; margin-left:15px;";
    area.appendChild(div); area.scrollTop = area.scrollHeight;
}
function updateHeirStats(changes) {
    if (!changes) return;
    for (var key in changes) {
        if (key === 'mood') currentHeir.mood = Math.min(Math.max(currentHeir.mood + changes[key], 0), 100);
        else if (currentHeir.params[key] !== undefined) currentHeir.params[key] = Math.min(Math.max(currentHeir.params[key] + changes[key], 0), 100);
    }
}
function saveHeirData() { localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir)); }
function updateHeirButtonState() {
    var btn = document.getElementById('heirActionButton');
    if (!btn) return;
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1 || !items[viewingIndex]) return;
    if (currentHeir && currentHeir.fatherName === items[viewingIndex].name && !currentHeir.isRunaway && !currentHeir.isDead) {
        btn.innerText = `ğŸ§¸ å‰å¾€ä¸œå®« (çœ‹æœ›${currentHeir.name})`;
        btn.style.background = '#fff7d1'; btn.style.color = '#fa8c16';
    } else {
        btn.innerText = `ğŸ‘¶ ç¥ˆç¦æ±‚å­`;
        btn.style.background = '#fff0f5'; btn.style.color = '#ff6b6b';
    }
}
function handleHeirAction() {
    if (viewingIndex === -1) return;
    var item = items[viewingIndex];
    if (currentHeir && currentHeir.fatherName === item.name && !currentHeir.isRunaway && !currentHeir.isDead) {
        openEastPalace();
    } else {
        document.getElementById('creationFatherName').innerText = item.name;
        document.getElementById('creationSettingInput').value = '';
        document.getElementById('heirCreationModal').classList.add('active');
    }
}
function closeEastPalace() { document.getElementById('eastPalaceModal').classList.remove('active'); }
function smartUpdateHeirScene(actionText) {
    if (!currentHeir) return;
    var isBoy = currentHeir.gender === 'ç”·';
    var sceneList = isBoy ? HEIR_SCENES.boy : HEIR_SCENES.girl;
    var pool = (isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl).bg[currentHeir.season];
    if(!Array.isArray(pool)) pool = [pool];
    var finalUrl = pool[Math.floor(Math.random() * pool.length)];
    if (actionText) {
        for (var i=0; i<sceneList.length; i++) {
            if (sceneList[i].seasons.includes(currentHeir.season) && sceneList[i].keywords.some(k => actionText.includes(k))) {
                finalUrl = Array.isArray(sceneList[i].url) ? sceneList[i].url[0] : sceneList[i].url;
                break;
            }
        }
    }
    currentHeir.currentScene = finalUrl; saveHeirData();
    var bgEl = document.getElementById('heirSceneBg');
    if (bgEl) bgEl.style.backgroundImage = `url('${finalUrl}')`;
}
function touchHeir2D() {
    currentHeir.mood = Math.min(100, currentHeir.mood + 2); saveHeirData(); auth.toast(`ğŸ‘‰ æ‘¸æ‘¸å¤´ (å¿ƒæƒ…+2)`);
}
function readMind() {
    if (!currentHeir.lastThought) { auth.toast('ğŸ˜¶ ...'); return; }
    var bubble = document.getElementById('heirBubble');
    bubble.innerText = `ğŸ’­ ${currentHeir.lastThought}`;
    bubble.style.opacity = 1; bubble.style.top = '20px';
    setTimeout(() => { bubble.style.opacity = 0; bubble.style.top = '50px'; }, 3000);
}
function openMemories() { currentHeir.isViewingMemories = true; renderMemoryBook(); }
function exitMemories() { currentHeir.isViewingMemories = false; openEastPalace(); }
function renderMemoryBook() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    var logs = currentHeir.bioLog || [];
    modalContent.innerHTML = `<button class="close-modal" onclick="exitMemories()" style="position:absolute; right:10px; top:10px; z-index:200; font-size:24px; background:none; border:none;">Ã—</button><div style="text-align:center; padding:15px; border-bottom:2px solid #ffb7c5; background:#fff;"><h3>ğŸ“œ ${currentHeir.name} çš„ç”Ÿå¹³</h3></div><div class="memory-list">${logs.slice().reverse().map(log => `<div class="memory-item"><div class="memory-content">${log}</div></div>`).join('')}</div><button onclick="exitMemories()" style="width:100%; padding:15px; background:#fff; border:none;">ğŸ”™ è¿”å›</button>`;
}
function checkRunaway() {
    if (currentHeir.params.rebellion > 90 && currentHeir.params.affection < 20) {
        currentHeir.isRunaway = true; currentHeir.bioLog.push(`ã€${currentHeir.age}å²ã€‘ï¼šç¦»å®¶å‡ºèµ°ã€‚`); saveHeirData(); renderRunawayView();
    }
}
function renderRunawayView() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    modalContent.innerHTML = `<button class="close-modal" onclick="closeEastPalace()" style="position:absolute;right:10px;top:10px">Ã—</button><div style="height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column"><h3>ğŸšï¸ äººå»æ¥¼ç©º</h3><button onclick="openMemories()">ğŸ“– å›å¿†å½•</button></div>`;
}
// 14. ğŸ—ºï¸ åœ°å›¾é€»è¾‘
function openTravelMap() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    var mapData = WORLD_MAPS['outside'];
    var locHtml = mapData.locations.map(loc => `<div class="location-card" onclick="enterLocation('${loc.name}', '${loc.desc}', '${loc.type}')"><div style="font-size:24px;">${loc.icon}</div><div>${loc.name}</div>${loc.desc?`<div style="color:#999;font-size:10px;">${loc.desc}</div>`:''}</div>`).join('');
    modalContent.innerHTML = `<div class="map-modal-body"><div class="map-header" style="background-image:url('${mapData.bg}')"><div class="map-title-badge">ğŸŒ ${mapData.name}</div><button onclick="closeTravelMode()" style="position:absolute;right:10px;top:10px;background:rgba(0,0,0,0.5);color:#fff;border:none;padding:5px 12px;border-radius:15px;">âœ– å…³é—­</button></div><div class="map-grid">${locHtml}</div></div>`;
}
var currentTravelLoc = null;
function enterLocation(name, desc, type) {
    if (type === 'exit') { closeTravelMode(); return; }
    currentTravelLoc = name;
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    var bgUrl = WORLD_MAPS['outside'].bg; 
    var assets = currentHeir.gender === 'ç”·' ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    var avatarUrl = Array.isArray(assets.idle) ? assets.idle[0] : assets.idle;
    modalContent.innerHTML = `<div class="travel-chat-view"><div class="travel-scene-area" style="background-image:url('${bgUrl}')"><div style="position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.9);padding:5px 10px;border-radius:10px;font-weight:bold;color:#d46b08;">ğŸ“ ${name}</div><img src="${avatarUrl}" class="travel-avatar"></div><div id="travelChatBox" class="travel-chat-box"></div><div class="travel-controls"><input type="text" id="travelInput" style="flex:1;border:1px solid #ddd;padding:8px;border-radius:20px;" placeholder="èŠèŠé£æ™¯..."><button onclick="sendTravelChat()" style="background:#ff9a9e;color:#fff;border:none;padding:0 15px;border-radius:20px;">è¯´</button><button onclick="openTravelMap()" style="background:#eee;color:#666;border:none;padding:0 15px;border-radius:20px;">ğŸ”™</button></div></div>`;
    triggerTravelStart(name);
}
async function sendTravelChat() {
    var input = document.getElementById('travelInput'); var text = input.value.trim(); if (!text) return;
    appendTravelMsg('user', text); input.value = '';
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `åœ°ç‚¹:${currentTravelLoc}ã€‚æ€§æ ¼:${JSON.stringify(currentHeir.params)}ã€‚ç”¨æˆ·:${text}ã€‚JSON:{ "reply":"", "changes":{ "mood":2 } }`;
    try {
        var res = await fetchAI(prompt, config); var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        appendTravelMsg('ai', data.reply); updateHeirStats(data.changes); saveHeirData();
    } catch(e) { appendTravelMsg('ai', '...'); }
}
async function triggerTravelStart(locName) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `åˆ°äº†${locName}ã€‚æ€§æ ¼:${JSON.stringify(currentHeir.params)}ã€‚ä¸€å¥æ„Ÿæƒ³ã€‚JSON:{"reply":""}`;
    try {
        var res = await fetchAI(prompt, config); var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        appendTravelMsg('ai', data.reply); currentHeir.bioLog.push(`ã€${currentHeir.age}å²Â·æ¸¸å†ã€‘ï¼š${locName}ï¼Œ${data.reply}`); saveHeirData();
    } catch(e) {}
}
function appendTravelMsg(role, text) {
    var box = document.getElementById('travelChatBox'); var div = document.createElement('div');
    div.style.cssText = `background:${role==='user'?'#ffeaa7':'#fff'};padding:8px;border-radius:10px;margin-bottom:8px;align-self:${role==='user'?'flex-end':'flex-start'};max-width:85%;margin-left:${role==='user'?'auto':'0'};`;
    div.innerText = text; box.appendChild(div); box.scrollTop = box.scrollHeight;
}
function closeTravelMode() { openEastPalace(); }

// ğŸ““ è‡ªåŠ¨å†™æ—¥è®°é€»è¾‘ (æ–°å¢)
async function writeDailyDiary() {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    // 1. è·å–æœ€è¿‘å‘ç”Ÿçš„ 3 ä»¶äº‹ä½œä¸ºç´ æ
    var recentLogs = currentHeir.bioLog.slice(-3).join("ï¼›");
    if (!recentLogs) recentLogs = "ä»Šå¤©å¹³å¹³æ·¡æ·¡ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº‹ã€‚";

    // 2. æ„å»º Prompt
    var prompt = `
    è§’è‰²ï¼š${currentHeir.name}ï¼Œ${currentHeir.age}å²ã€‚
    æ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    
    è¯·æ ¹æ®ä»¥ä¸‹ã€è¿‘æœŸç»å†ã€‘ï¼Œå†™ä¸€ç¯‡ç®€çŸ­çš„ç§å¯†æ—¥è®°ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    è¦æ±‚ï¼š
    1. ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
    2. è¯­æ°”è¦ç¬¦åˆæ€§æ ¼ï¼ˆæ¯”å¦‚å‚²å¨‡çš„è¦å£æ˜¯å¿ƒéï¼Œç—…å¨‡çš„è¦æåˆ°å¯¹'é‚£ä¸ªäºº'çš„æ‰§å¿µï¼‰ã€‚
    3. è¿™æ˜¯ä¸€ä¸ªä¸å¯å‘Šäººçš„ç§˜å¯†æ—¥è®°ï¼Œå†™å‡ºçœŸå®æƒ³æ³•ã€‚
    
    ã€è¿‘æœŸç»å†ã€‘ï¼š${recentLogs}
    `;

    try {
        // 3. æ‚„æ‚„è¯·æ±‚ AI (ä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œåå°æ‰§è¡Œ)
        var res = await fetchAI(prompt, config);
        
        // 4. å­˜å…¥æ—¥è®°æœ¬
        var dateStr = `${currentHeir.age}å²Â·${currentHeir.season}`;
        currentHeir.diary.push({ date: dateStr, content: res });
        
        // ä¿æŒæ—¥è®°æœ€å¤š 10 æ¡ï¼Œé˜²æ­¢å­˜å¤ªå¤š
        if (currentHeir.diary.length > 10) currentHeir.diary.shift();
        
        saveHeirData();
        console.log("ğŸ““ æ—¥è®°å·²æ›´æ–°");
        
    } catch(e) {
        console.log("âŒ æ—¥è®°å†™å…¥å¤±è´¥");
    }
}

// ================= â¤ï¸ å§»ç¼˜ç°¿æ ¸å¿ƒé€»è¾‘ (è¡¥å…¨) =================

// 1. ç”Ÿæˆæ‹çˆ±å¯¹è±¡ (ä¿®æ­£ç‰ˆï¼šç¡®ä¿æœ‰åˆå§‹å±æ€§)
async function generatePartners() {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var targetGender = currentHeir.gender === 'ç”·' ? 'å¥³æ€§' : 'ç”·æ€§';
    
    // æ²¡ Key ç”¨å‡æ•°æ®ä¿åº•
    if(!config || !config.apiKey) {
        currentHeir.dating.partners = [
            { name: "ç‹äºŒä¸«", age: 15, job: "å–èŠ±çš„", avatar: "https://files.catbox.moe/fv8f8p.gif", nature: "è‰¯é…", affinity: 10, status: "ç›¸è¯†", logs: [], desc: "å‹¤åŠ³å–„è‰¯ã€‚" },
            { name: "èµµå…¬å­", age: 17, job: "å¯Œå®¶å­", avatar: "https://files.catbox.moe/3ofd6b.png", nature: "æ¸£ç”·", affinity: 5, status: "ç›¸è¯†", logs: [], desc: "çœ¼ç¥è½»æµ®ã€‚" }
        ];
        saveHeirData();
        return;
    }

    var prompt = `ç”Ÿæˆ3ä¸ªå¤ä»£${targetGender}æ‹çˆ±å¯¹è±¡ã€‚
    JSONæ ¼å¼: [{"name":"","age":16,"job":"","nature":"è‰¯é…/ç»¿èŒ¶/æ™®é€š","desc":"æ€§æ ¼æè¿°"}]`;
    
    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // ğŸ”¥ å…³é”®ï¼šç»™æ–°ç”Ÿæˆçš„å¯¹è±¡æ‰‹åŠ¨åŠ ä¸Šåˆå§‹å±æ€§ï¼Œé˜²æ­¢ undefined
        data.forEach(d => {
            d.avatar = "https://files.catbox.moe/fv8f8p.gif"; // é»˜è®¤å¤´åƒ
            d.affinity = Math.floor(Math.random() * 15); // åˆå§‹å¥½æ„Ÿ 0-15
            d.status = "ç›¸è¯†"; // åˆå§‹çŠ¶æ€
            d.logs = []; // åˆå§‹æ—¥å¿—ä¸ºç©º
        });
        
        currentHeir.dating.partners = data;
        saveHeirData();
        
        // åˆ·æ–°ç•Œé¢
        if(document.querySelector('.app-window')) openApp('matchmaker');
    } catch(e) {
        console.error("ç”Ÿæˆå¤±è´¥", e);
        auth.toast("âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key");
    }
}

// 2. åˆ·æ–°æŒ‰é’®é€»è¾‘
async function refreshPartners() {
    document.querySelector('.app-content').innerHTML = '<div style="text-align:center; padding:50px;">ğŸ’˜ æ­£åœ¨é‡æ–°å¯»è§…...</div>';
    await generatePartners();
}

// 3. æ‹†æ•£é€»è¾‘
function breakUp(idx) {
    var p = currentHeir.dating.partners[idx];
    // æˆåŠŸç‡ = äº²å¯†åº¦ - å›é€†å€¼
    if (currentHeir.params.affection > currentHeir.params.rebellion + 10) {
        auth.toast(`âœ… æˆåŠŸåŠé€€äº† ${p.name}ï¼`);
        currentHeir.dating.partners.splice(idx, 1);
        saveHeirData();
        openApp('matchmaker'); // åˆ·æ–°åˆ—è¡¨
    } else {
        auth.toast('âŒ å¤±è´¥ï¼çš‡å—£éå¸¸åæ„Ÿï¼(å›é€†+10)');
        currentHeir.params.rebellion += 10;
        saveHeirData();
    }
}

// 4. åŠ©æ”»é€»è¾‘
function assistLove(gift) {
    if(confirm(`ç¡®å®šè¦èŠ±é’±ä¹°ã€${gift}ã€‘ç»™çš‡å—£å»é€ç¤¼å—ï¼Ÿ`)) {
        auth.toast('ğŸ åŠ©æ”»æˆåŠŸï¼æ„Ÿæƒ…å‡æ¸©äº†ï¼');
    }
}

// ================= â¤ï¸ æ‹çˆ±äº’åŠ¨é€»è¾‘ (è¡¥å…¨åŒ…) =================

// 1. ğŸ’Œ æ¥è§¦/çº¦ä¼šé€»è¾‘ (AI ç”Ÿæˆå‰§æƒ…)
async function dateWithPartner() {
    // è·å–å½“å‰å¯¹è±¡
    if (currentPartnerIdx === -1 || !currentHeir.dating.partners[currentPartnerIdx]) return;
    var p = currentHeir.dating.partners[currentPartnerIdx];
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½çº¦ä¼šï¼'); return; }

    auth.toast(`ğŸ’Œ çš‡å—£æ­£åœ¨å’Œ ${p.name} æ¥è§¦ä¸­...`);

    // æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚
    ä¸»è§’ï¼šçš‡å—£ï¼ˆ${currentHeir.age}å²ï¼Œæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼‰ã€‚
    å¯¹è±¡ï¼š${p.name}ï¼ˆèº«ä»½ï¼š${p.job}ï¼Œæ€§æ ¼ï¼š${p.desc}ï¼‰ã€‚
    å½“å‰å…³ç³»ï¼š${p.status} (å¥½æ„Ÿ ${p.affinity})ã€‚
    
    è¯·ç”Ÿæˆä¸€æ®µä¸¤äººäº’åŠ¨çš„ç®€çŸ­å‰§æƒ…ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    å¹¶æ ¹æ®äº’åŠ¨æƒ…å†µï¼Œåˆ¤æ–­å¥½æ„Ÿåº¦å˜åŒ–ï¼ˆ-10 åˆ° +10ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "story": "å‰§æƒ…å†…å®¹", "score": 5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // æ›´æ–°æ•°æ®
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score)); // é™åˆ¶èŒƒå›´
        if (!p.logs) p.logs = [];
        p.logs.push({ date: `${currentHeir.age}å²Â·${currentHeir.season}`, content: data.story });
        
        // çŠ¶æ€åˆ¤å®šé€»è¾‘
        updateRelationshipStatus(p);
        
        saveHeirData();
        
        // åˆ·æ–°é¡µé¢ (å…³æ‰æ—§çš„ï¼Œé‡æ–°æ‰“å¼€)
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx); 
        
        auth.toast(data.score >= 0 ? 'ğŸ’– æ„Ÿæƒ…å‡æ¸©äº†ï¼' : 'ğŸ’” å‘ç”Ÿäº†ä¸€äº›ä¸æ„‰å¿«...');
        
    } catch(e) { console.error(e); auth.toast('âŒ çº¦ä¼šå¤±è´¥'); }
}

// 2. ğŸ’¬ å®¶é•¿å¹²æ¶‰é€»è¾‘ (ä½ è¦æ‰¾çš„æŒ‰é’®å°±æ˜¯è°ƒç”¨çš„è¿™ä¸ªï¼)
async function parentIntervene() {
    if (currentPartnerIdx === -1) return;
    var p = currentHeir.dating.partners[currentPartnerIdx];
    
    var text = prompt(`ä½ æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ\n(ä¾‹å¦‚ï¼š"ç¦»ä»–è¿œç‚¹ï¼Œä»–æ˜¯åäºº" æˆ– "è¿™å­©å­ä¸é”™ï¼Œå¤šæ¥è§¦")`);
    if (!text) return;
    
    auth.toast('ğŸ’¬ æ­£åœ¨å¯¹çš‡å—£è¿›è¡Œè¯´æ•™...');
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆçš‡å—£çš„ååº”ã€‚
    å¹¶åˆ¤æ–­å¯¹è¿™æ®µå…³ç³»çš„å½±å“ï¼ˆå¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¯èƒ½å¢åŠ ï¼›å¦‚æœæ˜¯åŠåˆï¼Œä¹Ÿçœ‹æ€§æ ¼ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        alert(`çš‡å—£è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // æ›´æ–°æ•°æ®
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score));
        
        // å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰ï¼Œå¢åŠ å›é€†
        if (data.score < 0) currentHeir.params.rebellion = Math.min(100, currentHeir.params.rebellion + 5);
        
        updateRelationshipStatus(p);
        saveHeirData();
        
        // åˆ·æ–°
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {}
}

// 3. çŠ¶æ€åˆ¤å®šæœº (å¿…é¡»æœ‰è¿™ä¸ªï¼Œä¸ç„¶å…³ç³»çŠ¶æ€ä¸ä¼šå˜)
function updateRelationshipStatus(p) {
    if (p.affinity <= -20) {
        p.status = "æ–­è”"; 
        // å¦‚æœä¹‹å‰æ²¡æ–­è”ï¼ŒåŠ ä¸€æ¡æ—¥å¿—
        if (p.logs.length === 0 || !p.logs[p.logs.length-1].content.includes("æ–­ç»")) {
             p.logs.push({ date: "ç³»ç»Ÿ", content: "ğŸ’” å…³ç³»ç ´è£‚ï¼Œä»æ­¤é™Œè·¯ã€‚" });
        }
    } else if (p.affinity < 20) {
        p.status = "ç›¸è¯†";
    } else if (p.affinity < 60) {
        p.status = "æš§æ˜§";
    } else if (p.affinity < 90) {
        p.status = "æ‹çˆ±";
    } else {
        p.status = "çƒ­æ‹";
    }
}

// ================= ğŸ‘‘ çš‡å—£ä»£ç ç»“æŸ =================



    </script>
</body>
</html>
