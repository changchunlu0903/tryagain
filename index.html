<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âœ¨ æ¢¨æ¢¨çš„ç™¾å®ç®± (æœ€ç»ˆå®Œç¾ç‰ˆ v15.0) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
            --lock-bg: #fff0f5;

            /* ğŸ‘‡ ğŸŸ¢ é˜…è¯»å™¨è®¾ç½® ğŸŸ¢ ğŸ‘‡ */
            --reader-bubble-width: 90%; /* æ°”æ³¡å®½åº¦ */
            --reader-line-height: 1.5; /* è¡Œé—´è· */
            --reader-letter-spacing: 0.8px; /* å­—é—´è· */
            --reader-row-spacing: 2px; /* æ®µé—´è· */
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        /* ==================== ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ & é”å±æ ·å¼ ==================== */
        
        #lockScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff5f7; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(#fff 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* é£˜è½æ¨±èŠ± */
        .sakura {
            position: absolute;
            background: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0.5;
            animation: fall linear infinite; pointer-events: none;
        }
        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(100px, 110vh) rotate(360deg); opacity: 0; }
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .lock-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 30px;
            width: 85%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 10;
            transition: transform 0.3s;
        }

        .lock-title { font-size: 24px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; }
        .lock-subtitle { color: #999; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .welcome-btn {
            display: block;
            width: 100%; padding: 18px; border-radius: 50px;
            margin-bottom: 15px; border: none; font-size: 16px; color: white;
            font-family: inherit; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .welcome-btn:active { transform: scale(0.98); }
        .btn-gesture { background: #ffb7c5; }
        .btn-pin { background: linear-gradient(90deg, #a8edea 0%, #ffb7c5 100%); }
        .btn-login-pink { background: #ff9eb5; box-shadow: 0 8px 20px rgba(255, 158, 181, 0.4); }

        .pin-display { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .pin-dot {
            width: 16px;
            height: 16px; border-radius: 50%;
            background: #eee; border: 2px solid #ddd; transition: all 0.2s;
        }
        .pin-dot.active { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 280px; margin: 0 auto; }
        .num-btn {
            width: 60px;
            height: 60px; border-radius: 50%; border: none;
            background: #fff; color: var(--text-color); font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            font-family: inherit; display: flex; align-items: center; justify-content: center;
        }
        .num-btn:active { background: var(--secondary-color); }

        .gesture-container { position: relative; width: 300px; height: 300px; margin: 0 auto; touch-action: none; }
        .gesture-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; }
        .gesture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;
        }
        .gesture-point { display: flex; align-items: center; justify-content: center; }
        .point-inner {
            width: 18px;
            height: 18px; background: #ddd; border-radius: 50%;
            transition: 0.3s;
        }
        .point-inner.active { background: var(--accent-color); box-shadow: 0 0 0 10px rgba(255, 143, 163, 0.2); }

        .lock-input {
            width: 100%;
            padding: 12px; margin: 10px 0; border: 2px solid #ffe6eb;
            border-radius: 12px; text-align: center; font-family: inherit;
            outline: none; color: var(--text-color);
        }
        .lock-input:focus { border-color: var(--accent-color); }

        .back-link { margin-top: 20px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline; }

        .toast {
            position: fixed;
            top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 14px; opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s; z-index: 20000;
        }

        /* ==================== ğŸ”® æŠ½ç­¾ç³»ç»Ÿæ ·å¼ ==================== */
        .lottery-panel { margin-bottom: 15px; text-align: center; }
        .lottery-btn {
            background: linear-gradient(135deg, #fff0f5 0%, #ffc0cb 100%);
            border: 2px solid #fff; color: #d66a80;
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; width: 100%;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3);
            font-weight: bold; transition: transform 0.2s;
        }
        .lottery-btn:active { transform: scale(0.95); }

        .lottery-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 230, 235, 0.9); backdrop-filter: blur(8px);
            z-index: 12000; display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
        }
        .lottery-overlay.active { display: flex; animation: fadeInLottery 0.3s ease; }
        @keyframes fadeInLottery { from {opacity:0;} to {opacity:1;} }

        .lottery-box-container { text-align: center; position: relative; }
        .magic-gift { font-size: 100px; display: block; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        .magic-gift.shaking { animation: shakeBox 0.5s infinite; }
        @keyframes shakeBox {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        .lottery-result-card {
            display: none;
            flex-direction: column; align-items: center;
            background: white; padding: 20px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(255, 100, 150, 0.3);
            border: 4px solid #fff;
            width: 260px; animation: popIn 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from {transform: scale(0) rotate(-20deg); opacity: 0;} to {transform: scale(1) rotate(0); opacity: 1;} }

        .lottery-img-wrapper {
            width: 220px;
            height: 220px; border-radius: 20px; overflow: hidden;
            margin-bottom: 15px; border: 2px solid #ffe6eb; background: #fff5f7;
            display: flex; align-items: center; justify-content: center;
        }
        .lottery-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .lottery-name { font-size: 20px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px; }
        .lottery-hint { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        
        .go-btn {
            background: var(--accent-color);
            color: white; border: none;
            padding: 10px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 143, 163, 0.4);
            animation: pulse 2s infinite; font-family: inherit;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .close-lottery { position: absolute;
            top: 30px; right: 30px; font-size: 30px; color: #fff; background: rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; }

        /* ==================== åŸæœ‰ CSS ==================== */
        #appContainer {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸ¶ æ‚¬æµ®çª— --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn {
            width: 48px;
            height: 48px; border-radius: 50%;
            background: #fff; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex;
            justify-content: center; align-items: center;
            font-size: 24px; cursor: move; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .float-btn:active { transform: scale(0.9); }
        .float-btn::after { content: 'ğŸ¶'; }
        
        .float-menu {
            position: absolute;
            bottom: 60px; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; width: 260px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff;
            transform-origin: bottom right; transform: scale(0); opacity: 0;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; max-height: 60vh; display: flex; flex-direction: column;
        }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 10px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px;
            height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 10px; }
        .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; font-size: 13px; }
        
        .search-container { max-width: 600px; margin: 0 auto 10px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }

        /* ğŸŸ¢ è§†å›¾åˆ‡æ¢æ  */
        .layout-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; margin: 0 auto 25px auto;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
            padding: 6px 12px 6px 15px; border-radius: 50px; width: fit-content;
            border: 2px solid #fff0f5; box-shadow: 0 5px 15px rgba(255, 183, 197, 0.25);
        }
        .layout-label { font-size: 13px; color: var(--accent-color); font-weight: bold; margin-right: 8px; display: flex; align-items: center; }
        .layout-btn {
            background: none; border: none; width: 36px; height: 36px;
            cursor: pointer; border-radius: 50%; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex; align-items: center; justify-content: center; opacity: 0.6; font-size: 18px;
        }
        .layout-btn.active { background: #fff; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3); opacity: 1; transform: scale(1.1); }

               /* ğŸŸ¢ æ“ä½œæŒ‰é’®ç½‘æ ¼ (ä¿®æ”¹ç‰ˆï¼š6ä¸ªä¸€è¡Œ) */
        .action-grid { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); /* ğŸ‘ˆ å…³é”®ï¼šæ”¹æˆ 6 åˆ— */
            gap: 4px; /* ğŸ‘ˆ é—´è·æ”¹å°ä¸€ç‚¹ï¼Œé˜²æ­¢æŒ¤ */
            max-width: 100%; 
            margin: 0 auto 20px auto; 
            padding: 0 5px; /* ä¸¤è¾¹ç•™ä¸€ç‚¹ç‚¹ç¼éš™ */
            box-sizing: border-box;
        }

        .action-card {
            background: #fff; 
            border: 2px solid #ffb7c5; 
            border-radius: 15px; /* åœ†è§’ç¨å¾®æ”¹å°ä¸€ç‚¹ç‚¹é€‚åº”çª„å¡ç‰‡ */
            padding: 5px 0; /* å‡å°‘å†…è¾¹è· */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            transition: all 0.2s; 
            color: #ff8fa3; 
            font-weight: bold; 
            font-size: 11px; /* ğŸ‘ˆ å­—ä½“ç¨å¾®æ”¹å°ï¼Œé˜²æ­¢æ¢è¡Œ */
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2); 
            height: 65px; /* é«˜åº¦ç¨å¾®è°ƒçŸ®ä¸€ç‚¹ï¼Œæ˜¾å¾—ç²¾è‡´ */
        }
        
        .action-card:active { transform: scale(0.95); }
        .action-card.primary { background: #fff; border: 2px solid #ff8fa3; color: #ff8fa3; box-shadow: 0 4px 12px rgba(255, 143, 163, 0.3); }
        
        /* å›¾æ ‡ä¹Ÿç¨å¾®è°ƒå°ä¸€ç‚¹ */
        .kitty-icon { 
            font-size: 20px; 
            margin-bottom: 2px; 
            filter: drop-shadow(0 2px 2px rgba(255,183,197,0.3)); 
        }

        /* æ‰¹é‡åˆ é™¤ç›¸å…³æ ·å¼ */
        .card.is-selecting { animation: shake 0.3s ease; }
        .card.selected { border-color: #ff6b6b !important; background-color: #fff0f0; position: relative; }
        .card.selected::after { content: 'âœ…'; position: absolute; top: 5px; right: 5px; font-size: 20px; background: rgba(255,255,255,0.8); border-radius: 50%; }

        /* ğŸ”´ å…³é”®ä¿®å¤ï¼šéšè—åˆ é™¤æ¡ */
        .delete-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px);
            opacity: 0; pointer-events: none;
            background: #fff; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 15px;
            z-index: 10000; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); border: 2px solid #ff6b6b;
        }
        .delete-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .delete-btn-confirm { background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: bold; }
        .delete-btn-cancel { background: #f0f0f0; color: #666; border: none; padding: 8px 20px; border-radius: 30px; }
        .controls { display: none; }

        /* ğŸŸ¢ Grid å¸ƒå±€æ¨¡å¼ */
        .grid-container { display: grid; gap: 20px; max-width: 1200px; margin: 0 auto; transition: all 0.3s ease; }
        .grid-container.mode-default { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        .grid-container.mode-large { grid-template-columns: repeat(auto-fill, minmax(40%, 1fr)); }
        .grid-container.mode-mini { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
        .grid-container.mode-mini .card-img-wrapper { height: 120px; }
        .grid-container.mode-mini .card-title { font-size: 14px; }
        .grid-container.mode-list { grid-template-columns: 1fr; }
        .grid-container.mode-list .card { flex-direction: row; height: 100px; }
        .grid-container.mode-list .card-img-wrapper { width: 100px; height: 100%; flex-shrink: 0; }
        .grid-container.mode-list .card-content { justify-content: center; }
        .grid-container.mode-list .tags-container { margin-top: 5px; }

        .card { background: #fff; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; }
        .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color);
            border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }

        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: flex-start; gap: 10px; background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap;}
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        
        .resource-name-input { width: 100%; border: none; border-bottom: 1px dashed #ccc; padding: 2px 0; font-size: 14px; color: #333; border-radius: 0; background: transparent; outline: none; }
        .resource-name-input:focus { border-bottom-color: var(--accent-color); }
        
        .resource-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; width: auto; flex-grow: 1; max-width: 120px; }
        .custom-type-input { font-size: 12px; padding: 2px 5px; border: 1px solid #ffb7c5; border-radius: 4px; width: 80px; display: none; }

        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-left: auto; align-self: center;}

        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn { font-size: 14px; padding: 5px 12px; }

        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; }
        .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        
        .detail-list { margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        
        .action-link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .action-link:hover { background: var(--primary-color); color: white; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; }
        .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        
        input[type="file"] { display: none; }
        
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        button.primary-btn { background: var(--accent-color); color: white; border: none; }

        /* ==================== ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤ (é˜…è¯»æ¨¡å¼) ==================== */
        
        .reader-modal {
            background: #f5f5f5;
            width: 100%; height: 100%; top: 0; left: 0;
            max-width: none; max-height: none; border-radius: 0;
            display: flex; flex-direction: column; padding: 0;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
            flex-shrink: 0;
        }

        .reader-title { font-weight: bold; color: var(--text-color); font-size: 16px; }
        .reader-subtitle { font-size: 10px; color: #999; margin-top: 2px; }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto; padding: 20px; padding-bottom: 80px;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        .chat-row {
            display: flex;
            margin-bottom: var(--reader-row-spacing); 
            align-items: flex-end;
            position: relative;
            animation: fadeInUp 0.3s ease;
        }

        .floor-tag {
            position: absolute;
            top: -18px; font-size: 10px; color: #ccc;
            font-family: monospace; background: rgba(255,255,255,0.5);
            padding: 0 4px; border-radius: 4px;
        }

        .chat-bubble {
            max-width: var(--reader-bubble-width);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            
            padding: 12px 16px; border-radius: 18px;
            font-size: 15px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }

        .chat-name {
            font-size: 11px;
            color: #999; margin-bottom: 4px; margin-left: 4px;
            text-align: left;
        }

        .chat-row.left { justify-content: flex-start; }
        .chat-row.left .floor-tag { left: 10px; }
        .chat-row.left .chat-bubble { background: #fff; color: #333; border-bottom-left-radius: 4px; }

        .chat-row.right { justify-content: flex-end; }
        .chat-row.right .chat-name { margin-right: 4px; } 
        .chat-row.right .floor-tag { right: 10px; }
        .chat-row.right .chat-bubble { background: var(--accent-color); color: #fff; border-bottom-right-radius: 4px; }

        .close-reader {
            background: #eee;
            border: none; width: 32px; height: 32px; border-radius: 50%;
            font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .reader-footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            flex-shrink: 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .page-btn {
            padding: 8px 15px;
            border-radius: 20px; border: 1px solid #ddd;
            background: #fff; color: #666; font-size: 13px; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .page-btn:active { transform: scale(0.95); background: #f0f0f0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 13px; color: var(--accent-color); font-weight: bold; }

             /* ... ä¸Šé¢çš„ CSS ä¿æŒä¸å˜ ... */

        /* ==================== ğŸŸ¢ æ–°å¢ï¼šé˜…è¯»å™¨ç¼–è¾‘ä¸ä¹¦ç­¾æ ·å¼ ==================== */

        /* 1. ç¼–è¾‘æ¨¡å¼æ ·å¼ (ä¿®æ”¹ç‰ˆï¼šæ›´å¤§ã€æ›´æ¸…æ™°) */
        .bubble-edit-wrapper {
            width: 100%;
        }
        .bubble-textarea {
            width: 100%;
            min-height: 200px; /* ğŸŸ¢ æ”¹åŠ¨ï¼šé»˜è®¤é«˜åº¦åŠ å¤§åˆ° 200px */
            padding: 12px;     /* ğŸŸ¢ æ”¹åŠ¨ï¼šå†…è¾¹è·åŠ å¤§ */
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;   /* ğŸŸ¢ æ”¹åŠ¨ï¼šç¼–è¾‘æ—¶å­—ä½“æ”¾å¤§ï¼Œçœ‹å­—æ›´æ¸…æ¥š */
            line-height: 1.6;
            resize: vertical;  /* å…è®¸ä¸Šä¸‹æ‹‰ä¼¸ */
            outline: none;
            background: #fff;
            color: #333;
            margin-bottom: 8px;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹é˜´å½±è®©å®ƒæµ®èµ·æ¥çš„æ„Ÿè§‰ */
        }
        .edit-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px; /* æŒ‰é’®é—´è·æ‹‰å¤§ */
        }
        .edit-confirm-btn {
            background: var(--accent-color);
            color: white; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .edit-cancel-btn {
            background: #eee;
            color: #666; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
        }

        /* ... ä¸‹é¢çš„ CSS (ä¹¦ç­¾æ ·å¼ç­‰) ä¿æŒä¸å˜ ... */

        /* 2. ä¹¦ç­¾æŒ‰é’® */
        .bookmark-icon { margin-left: 5px; cursor: pointer; font-size: 14px; color: #ddd; transition: color 0.2s; }
        .bookmark-icon.active { color: #ffd700; text-shadow: 0 0 2px rgba(255, 215, 0, 0.5); }
        .floor-tag { display: flex; align-items: center; pointer-events: auto; }

        /* 3. ä¹¦ç­¾åˆ—è¡¨ - å±…ä¸­å¼¹çª—æ ·å¼ (ä¿®å¤ç‰ˆ) */
        .bookmark-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 80%; max-width: 320px; height: 60%; max-height: 500px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(255, 183, 197, 0.5); z-index: 6000;
            display: flex; flex-direction: column; border: 2px solid #fff;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .bookmark-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        /* ğŸŸ¢ æ–°å¢ï¼šCSS ç¼–è¾‘æŠ½å±‰æ ·å¼ (å¤ç”¨ä¹¦ç­¾æŠ½å±‰çš„é€»è¾‘) */
        .css-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 85%; max-width: 400px; height: 70%; max-height: 600px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(100, 100, 255, 0.2); 
            z-index: 6001; /* æ¯”ä¹¦ç­¾å±‚çº§å†é«˜ä¸€ç‚¹ */
            display: flex; flex-direction: column; border: 2px solid #e0f7fa;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .css-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        .bookmark-header {
            padding: 15px 20px; font-weight: bold; color: var(--accent-color);
            border-bottom: 1px solid #ffe6eb; display: flex; justify-content: space-between; align-items: center;
            background: #fff0f5; border-radius: 25px 25px 0 0;
        }
        .bookmark-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .bookmark-item {
            background: #fff; border: 1px solid #ffe6eb; border-radius: 10px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .bookmark-item:hover { background: #fff0f5; transform: translateX(-2px); }
        .bm-floor { font-size: 12px; color: #999; margin-bottom: 4px; font-weight: bold; }
        .bm-note { font-size: 14px; color: #555; word-break: break-all; }
        .bm-empty { text-align: center; color: #ccc; font-size: 13px; margin-top: 50px; }
        
        .highlight-row { animation: flashRow 2s ease; }
        @keyframes flashRow { 0% { background: rgba(255, 215, 0, 0.3); } 100% { background: transparent; } }

        /* ==================== ğŸ’­ å°è±¡æ·±åˆ»çš„è¯ (èƒŒæ™¯å¼¹å¹•ç‰¹æ•ˆ) ==================== */
        .memory-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
            z-index: 0; /* æ”¾åœ¨æœ€åº•å±‚ */
        }

        .memory-text {
            position: absolute;
            font-family: 'MyCustomFont', sans-serif; /* ç”¨ä½ æŒ‡å®šçš„å¯çˆ±å­—ä½“ */
            white-space: nowrap;
            color: rgba(255, 183, 197, 0.6); /* æ·¡æ·¡çš„ç²‰è‰²ï¼ŒåŠé€æ˜ */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: floatUp linear forwards;
        }

        /* æ–‡å­—å‘ä¸Šé£˜åŠ¨çš„åŠ¨ç”» */
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.9) rotate(-5deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-20vh) scale(1.1) rotate(5deg);
                opacity: 0;
            }
        }

        /* ä¸ºäº†é˜²æ­¢èƒŒæ™¯æ–‡å­—é®æŒ¡å†…å®¹ï¼Œæˆ‘ä»¬è¦ç»™å†…å®¹åŠ ä¸ªå±‚çº§ */
        .modal-content-wrapper {
            position: relative;
            z-index: 2; /* ç¡®ä¿å†…å®¹åœ¨æ–‡å­—ä¸Šé¢ */
        }

        /* ==================== ğŸ’® å¿ƒæƒ…å°ç« ç³»ç»Ÿ ==================== */
        
        /* å°ç« é€‰æ‹©æ  */
        .stamp-bar {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px 0;
            padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 50px;
        }
        
        .stamp-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent;
            background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); opacity: 0.7; filter: grayscale(0.8);
        }
        
        .stamp-btn:hover { transform: translateY(-3px); }
        
        /* æ¿€æ´»çŠ¶æ€ï¼šå˜æˆå½©è‰²ï¼Œå‘å…‰ */
        .stamp-btn.active {
            border-color: var(--accent-color); opacity: 1; filter: grayscale(0);
            transform: scale(1.1); box-shadow: 0 5px 15px rgba(255, 143, 163, 0.3);
        }

        /* ç›–åœ¨å³ä¸Šè§’çš„å¤§å°ç«  */
        .big-stamp-mark {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 100px;
            opacity: 0;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸æŒ¡æ“ä½œ */
            transform: scale(3) rotate(-30deg); /* åˆå§‹çŠ¶æ€ï¼šå¾ˆå¤§ï¼Œæ‚¬ç©º */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§åŠ¨ç”» */
            z-index: 0; /* æ”¾åœ¨åº•å±‚ï¼ŒèƒŒæ™¯å­—ä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
            filter: drop-shadow(0 0 0 transparent); /* åˆå§‹æ— é˜´å½± */
        }

        /* ç›–ä¸‹å»çš„çŠ¶æ€ */
        .big-stamp-mark.stamped {
            opacity: 0.15; /* æ·¡æ·¡çš„å°è®° */
            transform: scale(1) rotate(-20deg); /* ç ¸ä¸‹æ¥ */
            filter: drop-shadow(2px 2px 0px rgba(255, 100, 100, 0.2));
        }

        /* ==================== ğŸ™ˆ é˜²çª¥æ¨¡å¼ (Privacy Blur) ==================== */
        
        /* 1. å½“ body åŠ ä¸Š privacy-active ç±»æ—¶ï¼Œæ¨¡ç³Šæ‰€æœ‰å›¾ç‰‡ */
        body.privacy-active .card img,       /* é¦–é¡µå¡ç‰‡å°é¢ */
        body.privacy-active .gallery-img,    /* è¯¦æƒ…é¡µå¤§å›¾ */
        body.privacy-active .resource-preview img { /* ç¼–è¾‘åˆ—è¡¨é‡Œçš„ç¼©ç•¥å›¾ */
            filter: blur(20px) !important;   /* å¼ºåŠ›é«˜æ–¯æ¨¡ç³Š */
            opacity: 0.8;                    /* ç¨å¾®å˜æ·¡ä¸€ç‚¹ */
            transition: all 0.3s ease;       /* ä¸æ»‘è¿‡æ¸¡ */
        }

        /* 2. å³ä¸Šè§’çš„çœ¼ç›æŒ‰é’®æ ·å¼ */
        .privacy-toggle-btn {
            position: absolute;
            top: 20px; 
            right: 20px;
            font-size: 22px;
            cursor: pointer;
            z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2);
            transition: all 0.2s;
            color: var(--accent-color);
        }
        
        .privacy-toggle-btn:active { transform: scale(0.9); }

        /* ==================== âœ¨ æŒ‡å°–é­”æ³• (é¼ æ ‡+ç‚¹å‡»ç‰¹æ•ˆ) ==================== */
        
        /* 1. å…¨å±€é¼ æ ‡å˜å¯çˆ± (æ¢æˆçŒ«çˆªæˆ–é­”æ³•æ£’) */
        body {
            /* è¿™é‡Œç”¨çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„å¯çˆ±å…‰æ ‡é“¾æ¥ï¼Œå¦‚æœå¤±æ•ˆäº†ä¼šé€€åŒ–æˆé»˜è®¤çš„ */
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat120.cur'), auto; 
        }
        
        /* æŒ‰é’®å˜æˆæ‰‹æŒ‡ */
        button, .card, .action-card, .stamp-btn {
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat122.cur'), pointer;
        }

        /* 2. ç‚¹å‡»çˆ†å‡ºçš„ç²’å­ */
        .magic-particle {
            position: fixed;
            pointer-events: none; /* ä¸æŒ¡é¼ æ ‡ */
            animation: particleFloat 1s ease-out forwards;
            font-size: 20px;
            z-index: 9999;
            user-select: none;
        }

        @keyframes particleFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

        /* ==================== ğŸ“Š ç¾ç»Šåˆ†ææŠ¥å‘Šæ ·å¼ ==================== */
        .report-card {
            background: linear-gradient(135deg, #fff 0%, #fff9fb 100%);
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(255, 183, 197, 0.3);
            border: 3px solid #fff; position: relative; overflow: hidden;
        }
        .report-stat-row {
            display: flex; justify-content: space-around; margin: 20px 0;
            background: rgba(255,240,245,0.5); border-radius: 15px; padding: 15px;
        }
        .stat-item h3 { font-size: 24px; color: var(--accent-color); margin: 0; }
        .stat-item p { font-size: 12px; color: #888; margin: 5px 0 0 0; }
        
        /* æ¯”ä¾‹æ¡ */
        .ratio-bar-container {
            height: 24px; width: 100%; background: #eee; border-radius: 12px;
            overflow: hidden; display: flex; margin-top: 10px; position: relative;
        }
        .ratio-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; transition: width 1s ease; }
        .ratio-left { background: #a8edea; } /* ä½ çš„é¢œè‰² */
        .ratio-right { background: #ffb7c5; } /* è§’è‰²é¢œè‰² */

        /* ==================== ğŸ² çµæ„Ÿæ‰­è›‹æœº Pro æ ·å¼ ==================== */
        .gacha-machine {
            background: #fff0f5; border-radius: 30px; padding: 20px;
            border: 4px solid white; box-shadow: inset 0 0 20px rgba(255,183,197,0.2);
            position: relative;
        }
        .gacha-display {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            border: 2px dashed #ffb7c5; min-height: 100px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .gacha-tag {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            font-size: 14px; margin: 5px; font-weight: bold; color: white;
            animation: popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .tag-place { background: #81ecec; }
        .tag-event { background: #74b9ff; }
        .tag-trope { background: #ff7675; }
        
        .gacha-controls { display: flex; gap: 10px; justify-content: center; }
        .gacha-edit-area { display: none; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .gacha-textarea { width: 100%; height: 80px; font-size: 12px; padding: 8px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 5px; resize: none; font-family: inherit; }

        /* ==================== ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤æ ·å¼ ==================== */
        
        /* 1. ä¸»é¡µé™ˆåˆ—æ¶è§†å›¾ */
        .shelf-container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 20px; 
            padding: 20px;
            background: #fff9fb; 
            border: 4px solid #fff; 
            border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(255,183,197,0.1);
        }
        
        /* å•ä¸ªçºªå¿µå“ (æ‹ç«‹å¾—é£æ ¼) */
        .souvenir-card {
            background: white;
            padding: 8px 8px 25px 8px; /* åº•éƒ¨ç•™ç™½åƒæ‹ç«‹å¾— */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: rotate(var(--rot)); /* éšæœºä¸€ç‚¹ç‚¹æ­ªæ–œï¼Œæ›´è‡ªç„¶ */
            transition: transform 0.3s;
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        .souvenir-card:hover {
            transform: scale(1.1) rotate(0deg) !important;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .souvenir-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: #f0f0f0;
            margin-bottom: 5px;
            border: 1px solid #eee;
        }
        .souvenir-title {
            font-family: 'MyCustomFont', cursive, sans-serif;
            font-size: 12px;
            color: #555;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* 2. è¯¦æƒ…é¡µé‡Œçš„çºªå¿µå“æ¨ªå‘æ»šåŠ¨æ  */
        .souvenir-scroll-box {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px;
            margin-bottom: 15px;
            scrollbar-width: thin;
        }
        .souvenir-mini-item {
            flex-shrink: 0; width: 60px; text-align: center; cursor: pointer;
        }
        .souvenir-mini-img {
            width: 50px; height: 50px; border-radius: 10px; object-fit: cover;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* 3. çºªå¿µå“æŸ¥çœ‹å¤§å›¾å¼¹çª— */
        .souvenir-view-content {
            text-align: center;
        }
        .souvenir-view-img {
            max-width: 100%; max-height: 300px; border-radius: 10px;
            border: 5px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .souvenir-view-story {
            font-size: 14px; color: #666; line-height: 1.6; text-align: left;
            background: #fff0f5; padding: 15px; border-radius: 10px;
            margin-bottom: 15px; font-style: italic;
        }

                  /* ==================== â˜ï¸ æœ€ç»ˆç‰ˆï¼šèŠ±ç“£é›¨ä¸å›å¿† ==================== */
        .dream-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* èƒŒæ™¯ï¼šç²‰è‰²æ™¨æ›¦ */
            background: linear-gradient(180deg, #ffc3a0 0%, #ffafbd 100%);
            z-index: 9000; display: none; overflow: hidden;
        }
        .dream-layer.active { display: block; }

        /* ğŸŒ¸ 1. çº¯è£…é¥°ç”¨çš„èƒŒæ™¯èŠ±ç“£ */
        .dream-bg-petal {
            position: absolute; top: -50px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 100% 0 100% 0; /* èŠ±ç“£å½¢çŠ¶ */
            pointer-events: none; /* é¼ æ ‡ç©¿é€ï¼Œç‚¹ä¸åˆ°å®ƒ */
            animation: bgFall linear infinite;
        }
        @keyframes bgFall {
            0% { top: -10%; transform: rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { top: 110%; transform: rotate(360deg) translateX(50px); opacity: 0; }
        }

        /* ğŸ“¦ 2. å›å¿†å®¹å™¨ (ç»Ÿä¸€æ ·å¼) */
        .dream-content-item {
            position: absolute; top: -200px;
            cursor: pointer;
            animation: itemFall linear forwards;
            z-index: 10;
            transition: transform 0.3s;
        }
        .dream-content-item:hover {
            transform: scale(1.1) !important;
            z-index: 100;
        }

        /* ğŸ–¼ï¸ ç±»å‹Aï¼šæ­£æ–¹å½¢å›¾ç‰‡ */
        .dream-item-img {
            width: 120px; height: 120px;
            border-radius: 20px; /* åœ†è§’æ­£æ–¹å½¢ */
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
            overflow: hidden;
            background: #fff;
        }
        .dream-item-img img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .dream-img-name {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.8); color: #d66a80;
            font-size: 10px; text-align: center; padding: 4px 0;
            backdrop-filter: blur(2px);
        }

        /* ğŸ’¬ ç±»å‹Bï¼šæ–‡å­—æ°”æ³¡ */
        .dream-item-text {
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px; /* æ°”æ³¡å°å°¾å·´æ•ˆæœ */
            color: #555; font-size: 13px; line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 180px;
            text-align: left;
            border: 2px solid #fff0f5;
        }

        /* ä¸‹è½åŠ¨ç”» (è½»è½»æ‘‡æ‘†ï¼Œä½†ä¸æ—‹è½¬) */
        @keyframes itemFall {
            0% { top: -150px; opacity: 0; transform: translateX(0); }
            10% { opacity: 1; }
            25% { transform: translateX(20px); }
            50% { transform: translateX(-20px); }
            75% { transform: translateX(20px); }
            100% { top: 110%; opacity: 0; transform: translateX(0); }
        }

        /* ==================== ğŸ“– G. çµé­‚å›å“æ ·å¼ ==================== */
        .echo-card {
            background: #fff; border-radius: 20px; padding: 20px;
            text-align: center; border: 2px solid #e0e0e0;
        }
        .echo-result-box {
            min-height: 100px; margin: 20px 0; display: flex; align-items: center; justify-content: center;
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            font-size: 18px; font-weight: bold; color: var(--accent-color);
            font-family: 'MyCustomFont', sans-serif; position: relative;
        }
        .echo-result-box::before, .echo-result-box::after {
            content: 'â'; position: absolute; font-size: 40px; color: #eee;
        }
        .echo-result-box::before { top: 0; left: 10px; }
        .echo-result-box::after { content: 'â'; bottom: -10px; right: 10px; }

        .echo-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 10px auto; border: 3px solid #ffb7c5;
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.4);
        }

        /* åˆ†é¡µåˆ‡æ¢æ ·å¼ */
        .menu-page { animation: fadeIn 0.3s ease; }
        .menu-tab-bar {
            display: flex; margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;
        }
        .menu-tab {
            flex: 1; background: none; border: none; color: #ccc; cursor: pointer;
            font-size: 13px; padding: 6px; border-radius: 8px; transition: 0.3s;
        }
        .menu-tab:hover { background: #fff5f7; color: var(--accent-color); }
        .menu-tab.active {
            color: white; font-weight: bold; background: var(--accent-color);
            box-shadow: 0 2px 5px rgba(255, 143, 163, 0.3);
        }

        /* ==================== âœ‹ æ‘¸æ‘¸å¤´ç‰¹æ•ˆ ==================== */
        
        /* 1. å›¾ç‰‡è¢«ç‚¹å‡»æ—¶çš„æœå†»åŠ¨ç”» */
        .headpat-active {
            animation: jelly 0.4s;
        }
        @keyframes jelly {
            0% { transform: scale(1, 1); }
            30% { transform: scale(1.05, 0.95); } /* å‹æ‰ */
            40% { transform: scale(0.95, 1.05); } /* æ‹‰é•¿ */
            50% { transform: scale(1.02, 0.98); } /* å›å¼¹ */
            65% { transform: scale(0.99, 1.01); }
            100% { transform: scale(1, 1); }
        }

        /* 2. çˆ†å‡ºçš„çˆ±å¿ƒ/è¡¨æƒ… */
        .pat-particle {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            color: #ff6b81;
            font-size: 20px;
            z-index: 9999;
            animation: floatUpFade 0.8s forwards;
            text-shadow: 0 0 5px white;
        }
        @keyframes floatUpFade {
            0% { opacity: 1; transform:translateY(0) scale(0.5); }
            50% { opacity: 1; transform:translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform:translateY(-60px) scale(1); }
        }

        /* ==================== ğŸ’ èª“çº¦ä¹‹è¯æ ·å¼ ==================== */
        
        .oath-paper {
            background: #fffdf5; /* ç±³é»„è‰²ç¾Šçš®çº¸æ„Ÿ */
            width: 320px;
            padding: 30px 20px;
            border-radius: 10px;
            position: relative;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3), 0 20px 40px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
            transition: transform 0.6s;
            /* åŠ ä¸Šçº¹ç† */
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }

        /* åŒé‡è¾¹æ¡†ï¼Œå¢åŠ ä»ªå¼æ„Ÿ */
        .oath-border {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid #d4af37; /* é‡‘è‰²å®çº¿ */
            border-radius: 5px;
            pointer-events: none;
        }
        .oath-border::after {
            content: ''; position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px;
            border: 1px dashed #d4af37; /* é‡‘è‰²è™šçº¿ */
            border-radius: 3px;
        }

        .oath-header {
            font-size: 22px; color: #d4af37; font-weight: bold;
            margin-bottom: 20px; letter-spacing: 2px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            font-family: serif; /* è¡¬çº¿ä½“æ›´æ˜¾æ­£å¼ */
        }

        .oath-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px double #d4af37;
            object-fit: cover; padding: 2px; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .oath-footer {
            display: flex; justify-content: space-between; margin-top: 30px; padding: 0 20px;
        }
        .oath-sign-box { text-align: left; font-size: 12px; color: #999; }
        .sign-line {
            font-family: cursive; font-size: 16px; color: #333;
            border-bottom: 1px solid #ddd; min-width: 80px; margin-top: 5px;
            text-align: center; padding-bottom: 2px;
        }

        /* ğŸ”´ æŒ‰æ‰‹å°æŒ‰é’® */
        .oath-seal-btn {
            background: #ff7675; color: white;
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 30px auto 10px auto; cursor: pointer;
            font-weight: bold; border: 4px solid #fab1a0;
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
            animation: pulseBtn 2s infinite;
            transition: all 0.3s;
        }
        .oath-seal-btn:active { transform: scale(0.9); }
        @keyframes pulseBtn { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }

        /* ğŸ’‹ ç›–ç« å°è®° */
        .oath-stamp-mark {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%) scale(2);
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* ç›–ç« ç”Ÿæ•ˆæ—¶çš„æ ·å¼ */
        .oath-paper.signed .oath-seal-btn { display: none; } /* éšè—æŒ‰é’® */
        .oath-paper.signed .oath-stamp-mark {
            opacity: 0.8; transform: translateX(-50%) scale(1) rotate(-10deg);
        }
        .oath-paper.signed {
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.6); /* èª“çº¦è¾¾æˆå‘å‡ºé‡‘å…‰ */
            border-color: #ffd700;
        }

               /* ==================== ğŸ–¼ï¸ ç›¸æ¡†æ ·å¼åº“ (åŠ ç²—åŠ å¼ºç‰ˆ) ==================== */
        
        /* 1. ğŸ€ è•¾ä¸ç”œå¿ƒ (åŠ ç²—ç²‰çº¿ + å¤§è´è¶ç»“) */
        .card-img-wrapper.frame-lace {
            border: 5px dashed #ff8fa3; /* çº¿æ¡å˜ç²—ï¼Œé¢œè‰²å˜æ·± */
            background: #fff0f5;
            /* åŒå±‚æŠ•å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
            box-shadow: 
                0 0 0 4px #fff inset, 
                0 10px 20px rgba(255, 143, 163, 0.3);
            overflow: visible; /* å…è®¸è´è¶ç»“çªå‡ºæ¥ä¸€ç‚¹ */
            z-index: 1;
        }
        .card-img-wrapper.frame-lace::after {
            content: 'ğŸ€'; position: absolute; top: -10px; left: -10px;
            font-size: 32px; /* å›¾æ ‡æ”¾å¤§ */
            z-index: 10;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
            transform: rotate(-15deg);
        }

        /* 2. âšœï¸ éé‡‘å…¸è— (åšé‡é‡‘æ¡† + å¤§çº¹é¥°) */
        .card-img-wrapper.frame-gold {
            border: 6px solid #d4af37; /* å®å¿ƒåšé‡‘è¾¹ */
            /* å†…ä¾§åŠ ä¸€é“æ·±è‰²çº¿ï¼ŒåƒçœŸç”»æ¡† */
            outline: 2px solid #8a6d3b; 
            outline-offset: -8px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); /* æ·±é‚ƒæŠ•å½± */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-gold::before {
            content: 'âšœï¸'; position: absolute; bottom: -10px; right: -10px;
            font-size: 28px; z-index: 10;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }
        /* é¡¶éƒ¨åŠ ä¸ªçš‡å† è£…é¥° */
        .card-img-wrapper.frame-gold::after {
            content: 'ğŸ‘‘'; position: absolute; top: -15px; left: 50%;
            transform: translateX(-50%);
            font-size: 24px; z-index: 10;
        }

        /* 3. âœ¨ æ˜Ÿå…‰æµä½“ (å¼ºåŠ›éœ“è™¹å…‰æ•ˆ) */
        .card-img-wrapper.frame-stardust {
            border: 4px solid transparent;
            /* è¿™ç§å†™æ³•å¯ä»¥åšå‡ºæ¸å˜è¾¹æ¡† */
            background-image: linear-gradient(white, white), linear-gradient(45deg, #a18cd1, #fbc2eb, #8fd3f4);
            background-origin: border-box;
            background-clip: content-box, border-box;
            /* è¶…å¼ºå…‰æ™• */
            box-shadow: 0 0 20px 5px rgba(161, 140, 209, 0.6);
            animation: borderRotate 2s linear infinite; /* è¾¹æ¡†è‰²è°ƒæµåŠ¨ */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-stardust::after {
            content: 'âœ¨'; position: absolute; bottom: 5px; right: 5px;
            font-size: 24px; 
            filter: drop-shadow(0 0 5px #fff);
            animation: spin 3s linear infinite;
        }
        @keyframes borderRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* 4. ğŸŒ¸ è½æ¨±ç”»å¢ƒ (èŠ±å›¢é”¦ç°‡) */
        .card-img-wrapper.frame-sakura {
            border: 5px solid #ff9a9e; /* ç²—ç²‰è¾¹ */
            border-radius: 25px; /* æ›´åœ†æ¶¦ */
            box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            overflow: visible;
            z-index: 1;
        }
        /* å·¦ä¸Šè§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::before {
            content: 'ğŸŒ¸'; position: absolute; top: -12px; left: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }
        /* å³ä¸‹è§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::after {
            content: 'ğŸŒ¸'; position: absolute; bottom: -12px; right: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }

                /* ==================== ğŸ–¼ï¸ è¯¦æƒ…é¡µä¸“å±ï¼šè¾¹æ¡†+ç‰¹æ•ˆ ==================== */
        
        /* 1. å¿…é¡»ç»™ç”»å»Šå®¹å™¨è®¾ç½® overflow: visibleï¼Œå¦åˆ™è´è¶ç»“ä¼šè¢«åˆ‡æ‰ */
        .gallery-container {
            overflow: visible !important; 
            transition: all 0.3s;
            background: #fff; /* é»˜è®¤ç™½åº• */
        }

                /* ==================== âœ¨ é«˜å®šç‰ˆï¼šè¯¦æƒ…é¡µç²’å­ç‰¹æ•ˆ ==================== */
        
        /* 1. ç‰¹æ•ˆå®¹å™¨ï¼šå¿…é¡»è£å‰ªæº¢å‡ºï¼Œé˜²æ­¢ç²’å­é£˜åˆ°æ¡†å¤–é¢ */
        .detail-effect-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
            overflow: hidden; border-radius: 15px;
        }

        /* 2. é€šç”¨ç²’å­åŸºç¡€æ ·å¼ */
        .effect-particle {
            position: absolute; top: -20px;
            pointer-events: none;
            opacity: 0;
        }

        /* ========== ğŸŒ¸ æ¨±èŠ± (Sakura) - çœŸæ­£çš„èŠ±ç“£å½¢çŠ¶ ========== */
        .particle-sakura {
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 100% 0 100% 0; /* ğŸ‘ˆ å…³é”®ï¼šåšæˆèŠ±ç“£å°–è§’å½¢çŠ¶ */
            animation: fall-sway linear infinite;
            box-shadow: 0 2px 5px rgba(255, 154, 158, 0.2);
        }
        @keyframes fall-sway {
            0% { top: -10%; opacity: 0; transform: translateX(0) rotate(0deg); }
            10% { opacity: 0.9; }
            50% { opacity: 1; transform: translateX(20px) rotate(90deg); }
            100% { top: 110%; opacity: 0; transform: translateX(-20px) rotate(180deg); }
        }

        /* ========== âœ¨ æ˜Ÿå…‰ (Stardust) - é—ªçƒæµæ˜Ÿ ========== */
        .particle-star {
            background: white;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); /* æ˜Ÿæ˜Ÿå½¢çŠ¶ */
            animation: fall-twinkle linear infinite;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        @keyframes fall-twinkle {
            0% { top: -10%; opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { top: 110%; opacity: 0; transform: scale(0.5); }
        }

        /* ========== ğŸ€ è•¾ä¸ (Lace) - æŸ”å’Œå…‰æ–‘/çˆ±å¿ƒ ========== */
        .particle-heart {
            color: #ff8fa3;
            font-size: 14px;
            animation: fall-float linear infinite;
        }
        .particle-heart::after { content: 'ğŸ’—'; } /* ç”¨ Emoji æ›´æ¸…æ™° */
        @keyframes fall-float {
            0% { top: -10%; transform: translateY(0) scale(0.8); opacity: 0; }
            50% { opacity: 0.8; transform: translateY(10px) scale(1.1); }
            100% { top: 110%; transform: translateY(0) scale(0.8); opacity: 0; }
        }

        /* ========== âšœï¸ éé‡‘ (Gold) - é‡‘ç²‰ç²’å­ ========== */
        .particle-gold {
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px #d4af37;
            animation: fall-fast linear infinite;
        }
        @keyframes fall-fast {
            0% { top: -10%; opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            100% { top: 120%; opacity: 0; transform: translateY(20px); }
        }

        /* ==================== ğŸ¤« åˆ®åˆ®ä¹æ ·å¼ ==================== */
        .scratch-container {
            position: relative;
            width: 260px; height: 150px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            user-select: none; /* é˜²æ­¢é€‰ä¸­æ–‡å­— */
        }

        /* åº•å±‚æ–‡å­— */
        .scratch-text-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            color: #d66a80; font-weight: bold; font-size: 15px;
            line-height: 1.5;
            z-index: 1;
            background: #fff; /* ç™½åº• */
        }

        /* é¡¶å±‚ç”»å¸ƒ (æ¶‚å±‚) */
        #scratchCanvas {
            position: absolute; top: 0; left: 0;
            z-index: 2;
            touch-action: none; /* é˜²æ­¢æ‰‹æœºæ»šåŠ¨ */
            cursor: crosshair;
        }

        /* åˆå§‹é®ç½© (åšé€‰æ‹©é¢˜ç”¨) */
        .scratch-cover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }

        .scratch-actions {
            display: flex; justify-content: center; gap: 15px; margin-top: 20px;
        }

        /* ==================== ğŸ“Œ ä¾¿ç­¾æ ·å¼ ==================== */
        
        .sticky-note-paper {
            width: 280px;
            height: 350px;
            background: #fff9c4; /* ç»å…¸çš„ä¾¿ç­¾é»„ */
            /* å¦‚æœå–œæ¬¢ç²‰è‰²ä¾¿ç­¾ï¼Œå¯ä»¥ç”¨è¿™ä¸ªé¢œè‰²: #fff0f5 */
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            transform: rotate(-2deg); /* å¾®å¾®æ­ªä¸€ç‚¹ï¼Œæ›´è‡ªç„¶ */
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s;
        }
        
        /* æ‚¬åœæ‰¶æ­£ */
        .sticky-note-paper:hover {
            transform: rotate(0deg) scale(1.02);
            box-shadow: 10px 10px 30px rgba(0,0,0,0.15);
        }

        /* é¡¶éƒ¨ç±»ä¼¼èƒ¶å¸¦çš„æ•ˆæœ */
        .sticky-note-paper::before {
            content: '';
            position: absolute;
            top: -15px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .note-toolbar {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* è¾“å…¥æ¡†å»è¾¹æ¡†ï¼Œåƒç›´æ¥å†™åœ¨çº¸ä¸Š */
        #noteTextarea {
            flex-grow: 1;
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-family: 'MyCustomFont', cursive, sans-serif; /* ç”¨ä½ çš„å¯çˆ±å­—ä½“ */
            line-height: 1.6;
            color: #555;
        }
        
        /* è‡ªå®šä¹‰å–è‰²å™¨æ ·å¼ (ç®€å•ä¼˜åŒ–) */
        #noteColorPicker {
            border: none; width: 20px; height: 20px; cursor: pointer; background: none;
        }

        /* ==================== ğŸ“Œ è¯¦æƒ…é¡µä¸Šçš„å®ä½“è´´çº¸ ==================== */
        
        .real-sticky-note {
            position: absolute;
            top: 80px;  /* è´´åœ¨å³ä¸Šè§’ï¼Œé¿å¼€å…³é—­æŒ‰é’® */
            right: 20px;
            width: 140px; /* å°å·§ä¸€ç‚¹ */
            min-height: 100px;
            padding: 15px;
            
            /* çº¸å¼ è´¨æ„Ÿ */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15);
            border-bottom-right-radius: 20px 5px; /* å¾®å¾®å·è§’æ•ˆæœ */
            
            font-family: 'MyCustomFont', cursive, sans-serif;
            line-height: 1.4;
            word-wrap: break-word; /* é˜²æ­¢é•¿å•è¯æ’‘ç ´ */
            overflow: hidden;
            
            cursor: pointer;
            z-index: 50; /* ä¿è¯æµ®åœ¨æœ€ä¸Šé¢ */
            transition: transform 0.2s;
            
            /* é»˜è®¤å¾®å¾®æ­ªä¸€ç‚¹ */
            transform: rotate(3deg);
        }

        /* æ‚¬åœæ—¶ï¼Œå¥½åƒè¦è¢«æ­ä¸‹æ¥ */
        .real-sticky-note:hover {
            transform: scale(1.05) rotate(0deg);
            box-shadow: 5px 10px 20px rgba(0,0,0,0.2);
        }

        /* ğŸ“Œ é’‰å­/èƒ¶å¸¦è£…é¥° */
        .real-sticky-note::before {
            content: '';
            position: absolute;
            top: -10px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 20px;
            background: rgba(255,255,255,0.3); /* åŠé€æ˜èƒ¶å¸¦ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transform: rotate(-2deg);
        }

        /* ==================== ğŸ¤– AI èŠå¤©æ ·å¼ ==================== */
        .ai-msg-row {
            display: flex; margin-bottom: 8px;
        }
        .ai-msg-row.user { justify-content: flex-end; }
        .ai-msg-row.ai { justify-content: flex-start; }
        
        .ai-bubble {
            padding: 8px 12px; border-radius: 15px; max-width: 80%;
            word-wrap: break-word; line-height: 1.4;
            font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-msg-row.user .ai-bubble {
            background: var(--accent-color); color: white;
            border-bottom-right-radius: 2px;
        }
        .ai-msg-row.ai .ai-bubble {
            background: #fff; color: #555; border: 1px solid #eee;
            border-bottom-left-radius: 2px;
        }
        .ai-loading { color: #999; font-size: 10px; font-style: italic; margin-left: 5px; }

        /* AI æ¨èè·³è½¬æŒ‰é’® */
        .ai-jump-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 10px;
            background: #fff0f5;
            color: #d66a80;
            border: 1px solid #ffb7c5;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .ai-jump-btn:hover {
            background: #ffb7c5;
            color: white;
            transform: translateY(-2px);
        }

        /* ==================== ğŸ’Œ ä¿¡çº¸æ ·å¼ ==================== */
        .letter-paper {
            background: #fffbf0; /* ç±³é»„çº¸ */
            width: 300px;
            min-height: 400px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 100% 25px; /* ä¿¡çº¸æ¨ªçº¿ */
            line-height: 25px;
            font-family: 'MyCustomFont', cursive, sans-serif; /* æ‰‹å†™å­—ä½“ */
            color: #555;
            transform: rotate(-1deg);
        }
        
        .letter-content {
            margin-top: 20px;
            font-size: 15px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

        .letter-signature {
            margin-top: 30px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .letter-stamp {
            position: absolute;
            top: 20px; right: 20px;
            width: 60px; height: 60px;
            border: 3px double #d63031;
            border-radius: 50%;
            color: #d63031;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            transform: rotate(20deg);
            opacity: 0.6;
            pointer-events: none;
        }

    </style>

    <style id="custom-reader-style"></style> 
</head>

</head>
<body>

    <div id="dreamLayer" class="dream-layer">
        <div class="dream-close" onclick="stopDreamMode()">Ã— é†’æ¥</div>
        </div>
    <div id="lotteryOverlay" class="lottery-overlay">
        <div class="close-lottery" onclick="closeLottery()">Ã—</div>
        <div class="lottery-box-container" id="lotteryBox">
            <div class="magic-gift" id="magicGift">ğŸ</div>
            <div class="lottery-result-card" id="lotteryResult">
                <div class="lottery-img-wrapper"><img id="lotteryImg" src=""></div>
                <div class="lottery-name" id="lotteryName">???</div>
                <div class="lottery-hint">âœ¨ å‘½è¿é€‰æ‹©äº†å®ƒ âœ¨</div>
                <button class="go-btn" onclick="goToLotteryItem()">ğŸ‘‰ å°±æ˜¯ä½ äº†ï¼</button>
            </div>
        </div>
    </div>

    <div id="lockScreen">
        <div id="sakuraContainer"></div>

        <div id="view-landing" class="lock-card" style="display:none; text-align:center;">
            <div style="font-size:50px; margin-bottom:20px;">ğŸŒ¸</div>
            <div class="lock-title" style="font-size:28px;">æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="lock-subtitle">âœ¨ æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ âœ¨</div>
            <button class="welcome-btn btn-login-pink" style="color:white; margin-top:30px; font-size:18px;" onclick="auth.proceedFromLanding()">âœ¨ ç«‹å³ç™»å½• âœ¨</button>
        </div>

        <div id="view-welcome" class="lock-card" style="display:none;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸŒ¸</div>
            <div class="lock-title">è®¾ç½®è§£é”æ–¹å¼</div>
            <div class="lock-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            <button class="welcome-btn btn-gesture" onclick="auth.startSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="welcome-btn btn-pin" onclick="auth.startSetup('pin')">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div id="view-setup-question" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ” å®‰å…¨ä¿éšœ</div>
            <div class="lock-subtitle">ä¸‡ä¸€å¿˜äº†å¯†ç ï¼Œè¿™ä¸ªå¯ä»¥æ•‘ä½ ï¼</div>
            <div class="form-group" style="text-align:left;">
                <label>è®¾ç½®ä¸€ä¸ªå®‰å…¨é—®é¢˜</label>
                <input type="text" id="secQuestion" class="lock-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€åªå® ç‰©æ˜¯ï¼Ÿ">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>é—®é¢˜çš„ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            </div>
            <button class="welcome-btn btn-gesture" onclick="auth.saveSecurityQuestion()">å®Œæˆè®¾ç½®</button>
        </div>

        <div id="view-pin" class="lock-card" style="display:none;">
            <div class="lock-title" id="pinTitle">è¯·è¾“å…¥å¯†ç </div>
            <div class="lock-subtitle" id="pinSub">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            <div class="pin-display" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="numpad">
                <button class="num-btn" onclick="auth.inputPin(1)">1</button>
                <button class="num-btn" onclick="auth.inputPin(2)">2</button>
                <button class="num-btn" onclick="auth.inputPin(3)">3</button>
                <button class="num-btn" onclick="auth.inputPin(4)">4</button>
                <button class="num-btn" onclick="auth.inputPin(5)">5</button>
                <button class="num-btn" onclick="auth.inputPin(6)">6</button>
                <button class="num-btn" onclick="auth.inputPin(7)">7</button>
                <button class="num-btn" onclick="auth.inputPin(8)">8</button>
                <button class="num-btn" onclick="auth.inputPin(9)">9</button>
                <div></div>
                <button class="num-btn" onclick="auth.inputPin(0)">0</button>
                <button class="num-btn" style="color:#ff6b6b" onclick="auth.clearPin()">ğŸ”™</button>
            </div>
            <div class="back-link" id="pinForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
        </div>

        <div id="view-gesture" class="lock-card" style="display:none;">
            <div class="lock-title" id="gestTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <div class="lock-subtitle" id="gestSub">è¯·ç»˜åˆ¶ä½ çš„è§£é”å›¾æ¡ˆ</div>
            <div class="gesture-container" id="gestureArea">
                <div class="gesture-grid">
                    <div class="gesture-point"><div class="point-inner" data-idx="0"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="1"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="2"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="3"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="4"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="5"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="6"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="7"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="8"></div></div>
                </div>
                <canvas id="gestureCanvas" width="300" height="300"></canvas>
            </div>
            <div class="back-link" id="gestForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
            <div class="back-link" id="gestResetBtn" onclick="auth.resetGesture()" style="display:none">é‡ç»˜</div>
        </div>

        <div id="view-recovery" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ˜Ÿ å¿˜è®°å¯†ç äº†ï¼Ÿ</div>
            <div class="lock-subtitle" id="recoveryQText">å›ç­”ä½ çš„å®‰å…¨é—®é¢˜</div>
            <input type="text" id="recoveryAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            <button class="welcome-btn btn-gesture" onclick="auth.checkRecovery()">éªŒè¯</button>
            <div class="back-link" onclick="location.reload()">è¿”å›</div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div id="appContainer">
        
        <div class="privacy-toggle-btn" id="privacyBtn" onclick="togglePrivacyMode()" title="ç‚¹å‡»å¼€å¯é˜²çª¥/æ¨¡ç³Šæ¨¡å¼">
            ğŸ‘ï¸
        </div>

        <h1>ğŸŒ¸ æˆ‘çš„ç™¾å®ç®±  ğŸŒ¸</h1>

        <div class="float-widget" id="floatWidget">
                                  <div class="float-menu" id="floatMenu">
                
                <div id="menuPage1" class="menu-page" style="flex:1; overflow-y:auto; min-height:0;">
                    <div class="music-panel">
                        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
                        <div class="music-controls">
                            <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
                            <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
                        </div>
                        <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
                        <audio id="bgMusic" loop></audio>
                    </div>

                    <div class="lottery-panel" style="display:flex; gap:5px;">
                        <button class="lottery-btn" onclick="startLottery()" style="flex:1">ğŸ”® é€‰ä¸ªè€å©†</button>
                        <button class="lottery-btn" onclick="openGachaModal()" style="flex:1; background:linear-gradient(135deg, #e0f7fa 0%, #81ecec 100%); color:#00cec9;">ğŸ² çµæ„Ÿæ‰­è›‹</button>
                    </div>
                    <div class="lottery-panel" style="display:flex; gap:5px; margin-top:5px;">
                        <button class="lottery-btn" onclick="startDreamMode()" style="flex:1; background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:white; border:none;">ğŸ«§ æ¼‚æµ®æ¢¦å¢ƒ</button>
                        <button class="lottery-btn" onclick="openEchoModal()" style="flex:1; background:linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); color:white; border:none;">ğŸ“– çµé­‚å›å“</button>
                    </div>

                    <div class="tavern-portal-panel" style="margin-top:15px; position:relative; width:100%;">
                        <button id="tavernJumpBtn" style="width:100%; box-sizing: border-box; background:linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border:2px solid #fff; color:#fa8c16; padding:8px 15px; border-radius:20px; font-size:13px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(255, 169, 64, 0.2);" onclick="jumpToTavern()">
                            ğŸº å¯åŠ¨é…’é¦†
                        </button>
                        <button style="position:absolute; right:2px; top:2px; height:calc(100% - 4px); width:35px; background:transparent; border:none; color:#fa8c16; cursor:pointer; opacity:0.6;" onclick="changeTavernLink()">âš™ï¸</button>
                    </div>
                </div>

                <div id="menuPage2" class="menu-page" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:5px; border-bottom:1px dashed #eee; flex-shrink: 0;">
                        <div style="font-size:12px; font-weight:bold; color:var(--accent-color);">ğŸ’¬ <span id="aiPersonaLabel">å°å¾·å­ (å¤ªç›‘)</span></div>
                        <button onclick="openAISettings()" style="background:none; border:none; font-size:16px; cursor:pointer;">âš™ï¸</button>
                    </div>
                    
                    <div id="aiChatBox" style="flex:1; overflow-y:auto; padding:10px 0; font-size:12px;">
                        <div class="ai-msg-row ai"><div class="ai-bubble">çš‡ä¸Šå‰ç¥¥ï¼å¥´æ‰åœ¨è¿™å„¿å€™ç€å‘¢ï¼Œæ‚¨æœ‰ä»€ä¹ˆå©å’ï¼ŸğŸ™‡</div></div>
                    </div>

                    <div style="display:flex; gap:5px; margin-top:5px; flex-shrink: 0;">
                        <input type="text" id="aiInput" placeholder="ä¼ å”¤..." onkeydown="if(event.key==='Enter') sendAIMessage()" style="flex:1; border:1px solid #ddd; border-radius:15px; padding:5px 10px; font-size:12px;">
                        <button onclick="sendAIMessage()" style="background:var(--accent-color); color:white; border:none; border-radius:15px; padding:5px 10px; font-size:12px;">ä¼ </button>
                    </div>
                </div>

                <div id="menuPage3" class="menu-page" style="display:none; flex:1; overflow-y:auto;">
                     <div style="text-align:center; color:#aaa; font-size:12px; margin-bottom:10px; position:sticky; top:0; background:rgba(255,255,255,0.9); padding:5px;">ğŸ·ï¸ å¿«é€Ÿè·³è½¬ç›®å½•</div>
                     <div class="nav-panel" id="navPanel" style="border:none; padding:0;"></div>
                </div>

                <div class="menu-tab-bar" style="flex-shrink: 0;">
                    <button class="menu-tab active" onclick="switchMenuPage(1)">âœ¨ åŠŸèƒ½</button>
                    <button class="menu-tab" onclick="switchMenuPage(2)">ğŸ¤– ä¾ä»</button> 
                    <button class="menu-tab" onclick="switchMenuPage(3)">ğŸ“‘ ç›®å½•</button>
                </div>
            </div>

            <div class="float-btn" id="floatBtn"></div>
        </div>

              <div class="search-container" style="display:flex; align-items:center; gap:10px;">
            <div style="position:relative; flex-grow:1;">
                <input type="text" id="mainSearchInput" class="search-input" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="renderGrid(filterItems(this.value))">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <label style="font-size:12px; color:var(--accent-color); cursor:pointer; display:flex; align-items:center; gap:4px; white-space:nowrap;">
                <input type="checkbox" id="deepSearchCheck" onchange="handleSearch()" style="width:auto;">
                æœå†…å®¹
            </label>
        </div>


        <div class="layout-bar">
            <span class="layout-label">ğŸ‘€ è§†å›¾:</span>
            <button class="layout-btn" title="é»˜è®¤ç½‘æ ¼" onclick="switchLayout('default')">ğŸ©¶</button>
            <button class="layout-btn" title="é•¿åˆ—è¡¨" onclick="switchLayout('list')">ğŸ©µ</button>
            <button class="layout-btn" title="å¤§å›¾æ¨¡å¼" onclick="switchLayout('large')">ğŸ¤</button>
            <button class="layout-btn" title="è¿·ä½ æ¨¡å¼" onclick="switchLayout('mini')">ğŸ©·</button>
            <button class="layout-btn" title="çºªå¿µå“é™ˆåˆ—å®¤" onclick="switchLayout('shelf')">ğŸ’</button>
        </div>

        <div class="action-grid">
            <div class="action-card primary" onclick="openAddModal()">
                <div class="kitty-icon">ğŸ€</div>
                <div>æ·»åŠ </div>
            </div>
                        <div class="action-card" onclick="checkMailbox()">
                <div class="kitty-icon">ğŸ“®</div>
                <div>ä¿¡ç®±</div>
            </div>

            <div class="action-card" onclick="document.getElementById('batchImgInput').click()">
                <div class="kitty-icon">ğŸ“¸</div>
                <div>æ‰¹é‡åŠ </div>
                <input type="file" id="batchImgInput" multiple style="display:none" onchange="handleBatchImageImport(this)">
            </div>

            <div class="action-card" onclick="toggleBatchDeleteMode()">
                <div class="kitty-icon">ğŸ§¹</div>
                <div>æ‰¹é‡åˆ </div>
            </div>

            <div class="action-card" onclick="openTheaterModal()">
                <div class="kitty-icon">ğŸ¬</div>
                <div>å°å‰§åœº</div>
            </div>

            <div class="action-card" onclick="exportAllData()">
                <div class="kitty-icon">ğŸ’¾</div>
                <div>å¤‡ä»½</div>
            </div>

            <div class="action-card" onclick="document.getElementById('importAllInput').click()">
                <div class="kitty-icon">ğŸ‘œ</div>
                <div>å¯¼å…¥</div>
                <input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)">
            </div>
        </div>

        <div class="grid-container mode-default" id="gridContainer">
            <div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            <div class="form-group"><label>ğŸ’– åå­—</label><input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—..."></div>
            <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾ (è¾“å…¥åç‚¹+å·æˆ–å›è½¦)</label><div style="display:flex; align-items:center; gap:10px;"><div class="tag-input-area" id="tagInputArea" style="flex-grow:1;" onclick="document.getElementById('tagInput').focus()"><input type="text" id="tagInput" onkeydown="handleTagInput(event)"></div><button class="small-btn primary-btn" style="height:40px; width:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0;" onclick="manualAddTag()">ï¼‹</button>
<button class="small-btn" onclick="autoGenerateTags()" style="background:#e0f7fa; color:#006064; border:none; margin-left:5px; padding:5px 10px; border-radius:15px; font-size:12px;">ğŸ§  æ™ºèƒ½åˆ†æ</button>
</div><div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                       <div class="form-group">
                <label>ğŸ’­ å°è±¡æœ€æ·±çš„è¯ (ä¸€è¡Œä¸€å¥ï¼Œä¼šé£˜åœ¨èƒŒæ™¯é‡Œå“¦)</label>
                <textarea id="itemMemories" placeholder="ä¾‹å¦‚ï¼š
ç¬¬ä¸€æ¬¡è§ä½ çš„æ—¶å€™...
é‚£å¤©æ™šä¸Šçš„æœˆäº®å¾ˆåœ†...
(æŒ‰å›è½¦æ¢è¡Œï¼Œå¯ä»¥å†™å¾ˆå¤šå¥)" style="width:100%; height:100px; padding:10px; border:2px solid var(--secondary-color); border-radius:12px; outline:none; font-family:inherit; resize:vertical; background:#fff;"></textarea>
            </div>
                     <div class="form-group">
               <label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label><div class="resource-list" id="resourceList"><div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div></div><div class="add-btn-row"><label class="upload-area small-btn" style="flex-grow:1; text-align:center;">ğŸ“‚ åŠ æ–‡ä»¶ (å›¾ç‰‡/æ–‡æ¡£/å…¶ä»–)<input type="file" multiple onchange="handleUniversalSelect(this)"></label><button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button></div><div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;"><input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;"><div style="text-align:right;"><button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button><button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button></div></div></div>

                <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

            <div class="modal-buttons"><button onclick="closeAddModal()">å–æ¶ˆ</button><button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button></div>
        </div>
    </div>

                <div class="modal-overlay" id="detailModal">
        <div class="modal" style="position: relative; max-height: 85vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;"> 
            
            <div class="memory-layer" id="memoryLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;"></div>

            <div id="bigStamp" class="big-stamp-mark"></div>

                        <div class="modal-content-wrapper" style="overflow-y: auto; flex-grow: 1; position: relative; z-index: 2; padding: 25px;">
                
                <button class="close-modal" onclick="closeDetailModal()" style="position: absolute; top: 15px; right: 15px;">Ã—</button>
                
                <div id="stickyNoteDisplay"></div> 
                <h2 id="detailName" style="text-align:center; margin-bottom:5px; margin-top: 0;"></h2>

                <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>
                
                <div class="stamp-bar">
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ¬')" title="è¶…ç”œ">ğŸ¬</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ‹')" title="åƒé†‹/é…¸æ¶©">ğŸ‹</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ”ª')" title="åˆ€å­/è™å¿ƒ">ğŸ”ª</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸš—')" title="é£™è½¦/åˆºæ¿€">ğŸš—</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ’¤')" title="æ—¥å¸¸/ç¡è§‰">ğŸ’¤</div>
                </div>
                <div id="galleryArea">
                    <div class="gallery-container">
                        <div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div>
                        <img id="detailImg" class="gallery-img" src="">
                        <div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div>
                        <div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div>
                        <button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button>
                        <button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button>
                        <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;">
                            <span id="imgIndex">1</span> / <span id="imgTotal">1</span>
                        </div>
                    </div>
                </div>
                
                <div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>
                <div class="form-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        <span>ğŸ’ çºªå¿µå“ (å›å¿†ä¿¡ç‰©)</span>
                        <button class="small-btn" onclick="openAddSouvenirModal()" style="font-size:12px;">+ æ·»åŠ ä¿¡ç‰©</button>
                    </label>
                    <div id="souvenirListArea" class="souvenir-scroll-box">
                        <div style="font-size:12px; color:#ccc; padding:10px;">è¿™é‡Œè¿˜ç©ºè¡è¡çš„...</div>
                    </div>
                </div>
                <div class="form-group"><label>ğŸ“‚ ç›’å­å†…å®¹</label><div id="detailListContainer" class="detail-list"></div></div>
                
                             <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

                <div class="modal-buttons" style="justify-content: center; flex-wrap:wrap; margin-top: 20px;">
                    <button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘</button>
                    <button onclick="deleteCurrentItem()" style="border-color: #ffcccc; color: #ff6b6b;">ğŸ—‘ï¸ åˆ é™¤</button>
                    <button onclick="openOathModal()" style="border-color: #ffd700; color: #f39c12; background: #fffdf0;">ğŸ’ èª“çº¦</button>
<button onclick="openScratchModal()" style="border-color: #fab1a0; color: #e17055; background: #fff5f0;">ğŸ¤« ç§˜å¯†</button>
<button onclick="generateBriefing()" style="border-color: #a29bfe; color: #6c5ce7; background: #f3f0ff;">ğŸ“œ å‘ˆå¥æŠ˜</button>
<button onclick="openNoteModal()" style="border-color: #ffeaa7; color: #d35400; background: #fffbe6;">ğŸ“Œ ä¾¿ç­¾</button>
<button onclick="giveGift()" style="border-color: #ff9ff3; color: #f368e0; background: #fff0f5;">ğŸ æŠ•å–‚</button>
<button onclick="generateOOTD()" style="border-color: #54a0ff; color: #2e86de; background: #f0f8ff;">ğŸ‘— æ¢è£…</button>

                </div>
            
            </div> 
        </div>
    </div>
               
    <div class="modal-overlay" id="readerModal" style="z-index: 5000;">
        <div class="modal reader-modal">
                       <div class="reader-header">
                <button class="close-reader" onclick="closeReader()">â†</button>
                
                <div style="text-align:center">
                    <div class="reader-title" id="readerTitle">å›å¿†è®°å½•</div>
                    <div class="reader-subtitle" id="readerCount" style="cursor:pointer" onclick="toggleBookmarkDrawer()">0 æ¡è®°å½• (ç‚¹å‡»æŸ¥çœ‹ä¹¦ç­¾)</div>
                </div>
                
                                <div style="display:flex;
gap:5px;">
                    <button class="close-reader" style="font-size:16px;" onclick="analyzeBond()" title="ç”Ÿæˆç¾ç»ŠæŠ¥å‘Š">ğŸ“Š</button> <button class="close-reader" style="font-size:16px;" onclick="toggleCssDrawer()">ğŸ¨</button>
                    <button class="close-reader" style="font-size:16px;" onclick="toggleBookmarkDrawer()">â­</button> 
                </div>

            </div>

<div class="css-drawer" id="cssDrawer">
    <div class="bookmark-header">
        <span>ğŸ¨ çš®è‚¤è®¾è®¡å¸ˆ</span>
        <span style="font-size:12px;cursor:pointer" onclick="toggleCssDrawer()">å…³é—­</span>
    </div>
    <div style="padding:15px; display:flex; flex-direction:column; height:100%;">
        <select id="themeSelect" onchange="loadSelectedTheme()" style="margin-bottom:10px; padding:5px;">
            <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>
        </select>

        <textarea id="cssInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ CSS ä»£ç ... ä¾‹å¦‚: .chat-bubble { background: pink; }" style="flex-grow:1; width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family:monospace; margin-bottom:10px; resize:none;"></textarea>

        <div style="display:flex; gap:5px;">
            <input type="text" id="themeNameInput" placeholder="ç»™ä¸»é¢˜èµ·ä¸ªå..." style="flex-grow:1; padding:5px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="saveCustomTheme()" style="background:var(--accent-color); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
            <button onclick="deleteCustomTheme()" style="background:#ffcccc; color:#ff6b6b; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">åˆ </button>
        </div>

        <button onclick="previewCss()" style="margin-top:10px; background:#e0f7fa; color:#006064; border:none; padding:8px; border-radius:5px; cursor:pointer; width:100%;">âš¡ ç«‹å³ç”Ÿæ•ˆ (é¢„è§ˆ)</button>
    </div>
</div>

            <div class="bookmark-drawer" id="bookmarkDrawer">
                <div class="bookmark-header">
                    <span>ğŸ“‘ æˆ‘çš„ä¹¦ç­¾</span>
                    <span style="font-size:12px;color:#999;cursor:pointer" onclick="toggleBookmarkDrawer()">å…³é—­</span>
                </div>
                <div class="bookmark-list" id="bookmarkList">
                    </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
            </div>

            <div class="reader-footer" id="readerFooter">
                <button class="page-btn" onclick="prevPage()">â—€ ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">1 / 1</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal" style="z-index: 6000;">
        <div class="modal" style="width: 90%; max-width: 350px;">
            <button class="close-modal" onclick="document.getElementById('reportModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ“Š æˆ‘ä»¬çš„å›å¿†æŠ¥å‘Š</h2>
            
            <div class="report-card">
                <div style="font-size:13px; color:#999; margin-bottom:10px;">è·¨è¶Šæ—¶é—´</div>
                <div style="font-size:18px; font-weight:bold; color:#555;">
                    <span id="reportDateStart"></span> ~ <span id="reportDateEnd"></span>
                </div>
                <div style="background:#fff0f5; color:var(--accent-color); display:inline-block; padding:2px 10px; border-radius:10px; font-size:12px; margin-top:5px;">
                    å…±é™ªä¼´ <span id="reportDays" style="font-size:16px; font-weight:bold;">0</span> å¤©
                </div>

                <div class="report-stat-row">
                    <div class="stat-item">
                        <h3 id="reportTotalFloors">0</h3>
                        <p>ç›–æ¥¼é«˜åº¦</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="reportTotalWords">0</h3>
                        <p>æ€»å­—æ•°</p>
                    </div>
                </div>

                <div style="text-align:left; font-size:12px; color:#666; margin-top:15px;">
                    <div>ğŸ“ è¯ç—¨å¤§æ¯”æ‹¼ (å­—æ•°å æ¯”)</div>
                    <div class="ratio-bar-container">
                        <div id="ratioUser" class="ratio-segment ratio-left" style="width:50%">æˆ‘</div>
                        <div id="ratioChar" class="ratio-segment ratio-right" style="width:50%">TA</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span id="textCountUser">æˆ‘: 0å­—</span>
                        <span id="textCountChar">TA: 0å­—</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="gachaModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="closeGachaModal()">Ã—</button>
            <h2 style="text-align:center; margin-bottom:10px;">ğŸ² å‰§æƒ…çµæ„Ÿæ‰­è›‹æœº</h2>
            
            <div class="gacha-machine">
                <div class="gacha-display" id="gachaResultArea">
                    <div style="color:#ccc; font-size:14px;">ç‚¹å‡»æŒ‰é’®ï¼Œè·å–ä»Šæ—¥æ¢—æ¦‚...</div>
                </div>
                
                <div class="gacha-controls">
                    <button class="primary-btn" onclick="spinGacha()" style="width:100%; justify-content:center; font-size:16px;">ğŸ° ç»™æˆ‘ä¸€ä¸ªè„‘æ´ï¼</button>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <span class="action-link" onclick="toggleGachaEdit()">âš™ï¸ ç¼–è¾‘é¢˜åº“</span>
                </div>

                <div class="gacha-edit-area" id="gachaEditArea">
                    <label style="font-size:12px; color:#666;">ğŸ“ åœ°ç‚¹ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editPlace" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">ğŸ“… äº‹ä»¶ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editEvent" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">âœ¨ æ°›å›´/æ¢— (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editTrope" class="gacha-textarea"></textarea>
                    
                    <button class="small-btn primary-btn" onclick="saveGachaData()" style="width:100%; margin-top:5px;">ğŸ’¾ ä¿å­˜é¢˜åº“é…ç½®</button>
                    <button class="small-btn" onclick="resetGachaData()" style="width:100%; margin-top:5px; background:#fff; color:#999; border:1px solid #ddd;">ğŸ”„ æ¢å¤é»˜è®¤é¢˜åº“</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="addSouvenirModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('addSouvenirModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">âœ¨ å°å­˜ä¸€æ®µå›å¿†</h2>
            
            <div class="form-group">
                <label>ğŸ“¸ ä¿¡ç‰©ç…§ç‰‡ (ç‚¹å‡»ä¸Šä¼ )</label>
                <div onclick="document.getElementById('souvenirImgInput').click()" 
                     style="width:100%; height:150px; background:#f9f9f9; border:2px dashed #ddd; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
                    <img id="souvenirPreview" style="max-width:100%; max-height:100%; display:none;">
                    <span id="souvenirUploadHint" style="color:#aaa;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                </div>
                <input type="file" id="souvenirImgInput" accept="image/*" onchange="previewSouvenirImg(this)">
            </div>

            <div class="form-group">
                <label>ğŸ·ï¸ åå­—</label>
                <input type="text" id="souvenirName" placeholder="ä¾‹å¦‚ï¼šé‚£å¤©çš„çƒŸç«å¤§ä¼š...">
            </div>

            <div class="form-group">
                <label>ğŸ“œ å®ƒçš„æ•…äº‹ (å›å¿†æè¿°)</label>
                <textarea id="souvenirDesc" style="width:100%; height:80px; padding:10px; border:2px solid #ffe6eb; border-radius:10px; resize:none;" placeholder="ä¸ºä»€ä¹ˆè¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦ï¼Ÿ"></textarea>
            </div>
            
            <button class="primary-btn" onclick="saveSouvenir()" style="width:100%;">ğŸ’¾ æ”¾å…¥é™ˆåˆ—å®¤</button>
        </div>
    </div>

    <div class="modal-overlay" id="viewSouvenirModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('viewSouvenirModal').classList.remove('active')">Ã—</button>
            <div class="souvenir-view-content">
                <h2 id="viewSovTitle" style="color:var(--accent-color); margin-bottom:10px;"></h2>
                <img id="viewSovImg" class="souvenir-view-img">
                <div id="viewSovDesc" class="souvenir-view-story"></div>
                
                <div style="font-size:12px; color:#aaa; margin-top:20px;">
                    å±äº: <span id="viewSovOwner"></span>
                </div>
                <button class="small-btn" onclick="deleteCurrentSouvenir()" style="background:#fff; color:#ff6b6b; border:1px solid #ffcccc; margin-top:10px;">ğŸ—‘ï¸ ä¸¢å¼ƒ</button>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="echoModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('echoModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">ğŸ“– å¬å¬TAæ€ä¹ˆè¯´</h2>
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜ (æ˜¯/å¦)ï¼Œç„¶åç‚¹å‡»è†å¬</div>

            <div class="echo-card">
                <div style="margin-bottom:15px;">
                    <select id="echoCharSelect" onchange="updateEchoAvatar()" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                        <option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>
                    </select>
                </div>

                <img id="echoAvatarDisplay" src="" style="display:none;" class="echo-avatar">
                
                <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">TAçš„æ€§æ ¼:</label>
                    <select id="echoArchetypeSelect" style="padding:5px; border-radius:5px; border:1px solid #ffb7c5; font-size:12px;">
                        </select>
                </div>

                <div class="echo-result-box" id="echoResultText">
                    ...
                </div>

                <button class="primary-btn" onclick="askEcho()" style="width:100%; font-size:16px;">ğŸ”® è†å¬å›å“</button>
                
                <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <span class="action-link" onclick="toggleEchoEdit()" style="background:#f0f0f0; color:#888;">âœï¸ ç¼–å†™/ä¿®æ”¹æ€§æ ¼åº“</span>
                </div>
                
                <div id="echoEditArea" style="display:none; margin-top:10px; text-align:left;">
                    <label style="font-size:12px;">é€‰ä¸­ä¸Šæ–¹çš„æ€§æ ¼ï¼Œç„¶ååœ¨è¿™é‡Œä¿®æ”¹ (ä¸€è¡Œä¸€å¥):</label>
                    <textarea id="echoEditText" style="width:100%; height:100px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px; resize:none;" onchange="saveCurrentEchoLib()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="oathModal" style="z-index: 8000;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="oath-paper" id="oathPaper">
                <button class="close-modal" onclick="document.getElementById('oathModal').classList.remove('active')" style="color:#bdc3c7; top:10px; right:10px;">Ã—</button>
                
                <div class="oath-border"></div>
                
                <div class="oath-header">âœ¨ æ°¸æ’èª“çº¦ âœ¨</div>
                
                <div class="oath-content">
                    <img id="oathAvatar" class="oath-avatar" src="">
                    <div style="margin: 15px 0; font-size: 14px; color: #555; line-height: 1.8;">
                        è‡ªä»Šæ—¥ <span id="oathDate" style="border-bottom: 1px solid #aaa; padding: 0 5px; font-weight: bold;"></span> èµ·<br>
                        æˆ‘æ„¿ä¸ <span id="oathCharName" style="color:var(--accent-color); font-weight:bold; font-size:16px;"></span> ç¼”ç»“ç¾ç»Šã€‚<br>
                        æ— è®ºæ•°æ®æ´ªæµå¦‚ä½•å†²åˆ·ï¼Œ<br>
                        è¿™ä»½è®°å¿†å°†æ°¸ä¸è¤ªè‰²ã€‚
                    </div>
                </div>

                <div class="oath-footer">
                    <div class="oath-sign-box">
                        <span>User:</span>
                        <div class="sign-line">æˆ‘ (Me)</div>
                    </div>
                    <div class="oath-sign-box">
                        <span>Partner:</span>
                        <div class="sign-line" id="oathSignName">???</div>
                    </div>
                </div>

                <div class="oath-action-area">
                    <div id="oathSealBtn" class="oath-seal-btn" onclick="signTheOath()">
                        ğŸ–ï¸ æŒ‰æ‰‹å°
                    </div>
                    <div id="oathStamp" class="oath-stamp-mark">
                        <div style="font-size: 50px;">ğŸ’‹</div>
                        <div style="font-size: 10px; transform: rotate(-5deg); border: 2px solid #d63031; padding: 2px 5px; border-radius: 4px; color: #d63031; display: inline-block; margin-top: -10px;">LOVED</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<div class="modal-overlay" id="scratchModal" style="z-index: 8500;">
        <div class="modal" style="width: 300px; padding: 20px; background: #fff0f5; border: 4px solid white; border-radius: 20px; text-align: center;">
            <button class="close-modal" onclick="closeScratchModal()">Ã—</button>
            
            <h2 style="color: #d66a80; margin-bottom: 5px;">ğŸ¤« éšè—çš„ç§˜å¯†</h2>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 15px;">æ¥è‡ªèŠå¤©è®°å½•çš„éšæœºå›å¿†...</div>

            <div class="scratch-container" id="scratchContainer">
                <div class="scratch-text-layer">
                    <div id="scratchSecretText">...</div>
                </div>
                <canvas id="scratchCanvas"></canvas>
                
                <div id="scratchCover" class="scratch-cover-overlay">
                    <div style="font-size: 40px;">ğŸ«£</div>
                    <div style="font-weight: bold; color: #fff; margin-top: 10px;">è¦å·çœ‹TAçš„å¿ƒé‡Œè¯å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="scratch-actions" id="scratchBtnArea">
                <button class="small-btn" onclick="closeScratchModal()" style="background: #eee; color: #999;">ğŸ«£ ç®—äº†ä¸æ•¢çœ‹</button>
                <button class="primary-btn" onclick="startScratching()" style="background: #ff8fa3; border: none;">ğŸ–ï¸ æˆ‘è¦åˆ®ï¼</button>
            </div>
            
            <div id="scratchHint" style="display:none; font-size:12px; color:#d66a80; margin-top:10px;">
                âœ¨ å¿«ç”¨æ‰‹æŒ‡/é¼ æ ‡æ¶‚æŠ¹ä¸Šæ–¹åŒºåŸŸ âœ¨
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="noteModal" style="z-index: 8800;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="sticky-note-paper">
                <button class="close-modal" onclick="closeNoteModal()" style="color: #bfa588; top: 5px; right: 5px;">Ã—</button>
                
                <div style="text-align: center; color: #bfa588; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    ğŸ“Œ è§’è‰²å¤‡æ³¨ & éšæ‰‹è®°
                </div>

                <div class="note-toolbar">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">é¢œè‰²:</span>
                        <input type="color" id="noteColorPicker" value="#555555" onchange="previewNoteStyle()">
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">å¤§å°:</span>
                        <input type="range" id="noteSizeSlider" min="12" max="30" value="14" style="width: 60px;" oninput="previewNoteStyle()">
                    </div>
                </div>

                <textarea id="noteTextarea" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å…³äºTAçš„å¤‡æ³¨...&#10;æ¯”å¦‚ï¼šç”Ÿæ—¥æ˜¯XæœˆXæ—¥&#10;æˆ–è€…ï¼šä»Šå¤©TAè¶…çº§å¯çˆ±ï¼"></textarea>

                <button class="small-btn" onclick="saveNote()" style="width: 100%; margin-top: 10px; background: #fff; border: 1px dashed #bfa588; color: #bfa588;">ğŸ’¾ è´´ä¸Šå»</button>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="aiSettingsModal" style="z-index: 9999;">
        <div class="modal" style="width: 280px;">
            <button class="close-modal" onclick="document.getElementById('aiSettingsModal').classList.remove('active')">Ã—</button>
            <h3 style="text-align:center; color:var(--accent-color); margin-bottom:15px;">ğŸ§  è°ƒæ•™ä½ çš„ä¾ä»</h3>
            
            <div class="form-group">
                <label>ğŸ­ é€‰æ‹©äººè®¾</label>
                <select id="aiPersonaSelect" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                    <option value="eunuch">ğŸ™‡ å°å¾·å­ (å‘å¾®å¤ªç›‘)</option>
                    <option value="maid">ğŸ± å–µå–µå¥³ä»† (å¯çˆ±çŒ«å¨˜)</option>
                    <option value="butler">ğŸ§ æ¯’èˆŒç®¡å®¶ (é˜´é˜³æ€ªæ°”)</option>
                    <option value="yandere">ğŸ”ª ç—…å¨‡å¦¹å¦¹ (ç‹¬å æ¬²)</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šä¹‰äººè®¾</option>
                </select>
            </div>

            <div id="customPersonaArea" class="form-group" style="display:none;">
                <label>ğŸ“ è‡ªå®šä¹‰æç¤ºè¯ (System Prompt)</label>
                <textarea id="aiCustomPrompt" style="width:100%; height:60px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px;"></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ”— API åœ°å€ (åä»£é“¾æ¥)</label>
                <input type="text" id="aiApiUrl" placeholder="ä¾‹å¦‚: https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>

            <div class="form-group">
                <label>ğŸ”‘ API Key</label>
                <input type="password" id="aiApiKey" placeholder="sk-...">
            </div>

                      <div class="form-group">
                <label>ğŸ§  æ¨¡å‹é€‰æ‹©</label>
                <div style="display:flex; gap:5px;">
                    <select id="aiModelSelect" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd; background:white;">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (é»˜è®¤)</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="claude-3-5-sonnet-20240620">claude-3.5-sonnet</option>
                    </select>
                    <button onclick="fetchModelList()" style="background:#fff0f5; border:1px solid #ffb7c5; border-radius:10px; padding:0 12px; cursor:pointer; color:#d66a80;" title="ç‚¹å‡»æ‹‰å–æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
                </div>
                
                <input type="text" id="aiModelManual" placeholder="æ‰¾ä¸åˆ°ï¼Ÿç‚¹è¿™é‡Œæ‰‹åŠ¨è¾“å…¥..." style="width:100%; margin-top:5px; font-size:12px; border:1px solid #ddd; border-radius:8px; padding:5px; display:none;">
                <div style="font-size:10px; color:#aaa; text-align:right; margin-top:2px; cursor:pointer;" onclick="toggleManualInput()">æ‰¾ä¸åˆ°æ¨¡å‹? æ‰‹åŠ¨è¾“å…¥</div>
            </div>

            <button class="primary-btn" onclick="saveAISettings()" style="width:100%;">ğŸ’¾ ä¿å­˜è®¾å®š</button>
        </div>
    </div>

    <div class="modal-overlay" id="theaterModal" style="z-index: 9500;">
        <div class="modal" style="width: 320px;">
            <button class="close-modal" onclick="document.getElementById('theaterModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ¬ è·¨æ—¶ç©ºå‰§åœº</h2>
            
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">
                é€‰ä¸¤ä¸ªè§’è‰²ï¼Œè®© AI å¯¼æ¼”ä¸€åœºæˆ...
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <select id="theaterCharA" style="flex:1; padding:5px; border-radius:10px;"></select>
                <span style="font-weight:bold; color:#ffb7c5;">VS</span>
                <select id="theaterCharB" style="flex:1; padding:5px; border-radius:10px;"></select>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>ğŸ­ å‰§æœ¬æƒ…å¢ƒ (å¯é€‰)</label>
                <input type="text" id="theaterTopic" placeholder="ä¾‹å¦‚ï¼šäº‰é£åƒé†‹ã€è’å²›æ±‚ç”Ÿã€äº’ç›¸å¹æ§...">
            </div>

            <button class="primary-btn" onclick="startTheater()" style="width:100%; margin-top:10px;">ğŸ¥ Action! (å¼€å§‹æ¼”å‡º)</button>
        </div>
    </div>

    <div class="modal-overlay" id="letterModal" style="z-index: 9600;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            <div class="letter-paper">
                <button class="close-modal" onclick="document.getElementById('letterModal').classList.remove('active')" style="color:#555;">Ã—</button>
                <div class="letter-stamp">é‚®æˆ³</div>
                <div class="letter-content" id="letterText">
                    æ­£åœ¨æ‹†ä¿¡...
                </div>
                <div class="letter-signature" id="letterSign">???</div>
            </div>
        </div>
    </div>

    <div id="deleteBar" class="delete-bar">
        <button class="delete-btn-cancel" onclick="toggleBatchDeleteMode()">å–æ¶ˆ</button>
        <button class="delete-btn-confirm" onclick="confirmBatchDelete()">ğŸ—‘ï¸ åˆ é™¤ (<span id="deleteCount">0</span>)</button>
    </div>

    <script>
        // ================= ğŸ”’ å®‰å…¨ç³»ç»Ÿ (AuthSystem) =================
        const auth = {
            mode: 'login', type: null, step: 0, tempSecret: null, inputBuffer: '', failCount: 0,
            
            init: function() {
                this.createSakura();
                this.showView('view-landing');
            },

            proceedFromLanding: function() {
                const savedType = localStorage.getItem('magic_auth_type');
                const savedSecret = localStorage.getItem('magic_auth_secret');
                if (!savedType || !savedSecret) { this.showView('view-welcome'); } 
                else {
                    this.mode = 'login';
                    this.type = savedType;
                    if (this.type === 'pin') this.showView('view-pin'); else this.showView('view-gesture');
                    if (this.type === 'gesture') setTimeout(() => this.initGesture(), 100);
                }
            },

            createSakura: function() {
                const container = document.getElementById('sakuraContainer');
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    el.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(el);
                }
            },
            showView: function(id) {
                ['view-landing', 'view-welcome', 'view-pin', 'view-gesture', 'view-setup-question', 'view-recovery'].forEach(v => {
                    const el = document.getElementById(v); if(el) el.style.display = 'none';
                });
                document.getElementById(id).style.display = 'block';
                if(id === 'view-pin') this.updatePinDots();
            },
            toast: function(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            },
            startSetup: function(type) {
                this.mode = 'setup';
                this.type = type; this.step = 1; this.inputBuffer = '';
                if (type === 'pin') {
                    document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                    document.getElementById('pinSub').textContent = 'è¯·è¾“å…¥4ä½æ–°å¯†ç '; this.showView('view-pin');
                } else {
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ'; this.showView('view-gesture'); setTimeout(() => this.initGesture(), 100);
                }
            },
            inputPin: function(num) {
                if (this.inputBuffer.length < 4) {
                    this.inputBuffer += num;
                    this.updatePinDots();
                    if (this.inputBuffer.length === 4) setTimeout(() => this.submitPin(), 200);
                }
            },
            clearPin: function() { this.inputBuffer = ''; this.updatePinDots(); },
            updatePinDots: function() { const dots = document.getElementById('pinDots').children;
                for(let i=0; i<4; i++) { if(i < this.inputBuffer.length) dots[i].classList.add('active'); else dots[i].classList.remove('active'); } },
            submitPin: function() {
                const val = this.inputBuffer;
                this.inputBuffer = ''; this.updatePinDots();
                if (this.mode === 'setup') {
                    if (this.step === 1) { this.tempSecret = val;
                        this.step = 2; document.getElementById('pinTitle').textContent = 'å†æ¬¡ç¡®è®¤'; document.getElementById('pinSub').textContent = 'è¯·å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤'; } 
                    else { if (val === this.tempSecret) this.finishPasswordSetup(val);
                    else { this.toast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); this.step = 1; document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç '; } }
                } else if (this.mode === 'login') { if (val === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                else this.handleFail(); }
            },
            
            initGesture: function() {
                const canvas = document.getElementById('gestureCanvas');
                const ctx = canvas.getContext('2d'); 
                const area = document.getElementById('gestureArea');
                let isDrawing = false; let path = [];
                canvas.width = 300;
                canvas.height = 300; 

                const getPoint = (x, y) => { 
                    const rect = area.getBoundingClientRect();
                    const rx = x - rect.left; const ry = y - rect.top;
                    const col = Math.floor(rx / (300/3));
                    const row = Math.floor(ry / (300/3));
                    if(col>=0 && col<3 && row>=0 && row<3) return row*3 + col;
                    return -1; 
                };
                const draw = (curX, curY) => {
                    ctx.clearRect(0, 0, 300, 300);
                    ctx.strokeStyle = '#ffb7c5'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    if(path.length > 0) { 
                        ctx.beginPath();
                        const p0 = getCenter(path[0]); ctx.moveTo(p0.x, p0.y); 
                        for(let i=1; i<path.length; i++) { const p = getCenter(path[i]); ctx.lineTo(p.x, p.y); } 
                        if(curX !== null) ctx.lineTo(curX, curY);
                        ctx.stroke(); 
                    }
                    document.querySelectorAll('.point-inner').forEach((el, i) => { if(path.includes(i)) el.classList.add('active'); else el.classList.remove('active'); });
                };
                const getCenter = (idx) => { const row = Math.floor(idx/3), col = idx%3;
                    return { x: col*100 + 50, y: row*100 + 50 }; };
                
                const start = (e) => { e.preventDefault(); e.stopPropagation(); isDrawing = true; path = []; move(e); };
                const move = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); e.stopPropagation();
                    let cx, cy; if(e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
                    const rect = area.getBoundingClientRect();
                    const idx = getPoint(cx, cy); if(idx !== -1 && !path.includes(idx)) path.push(idx); 
                    draw(cx - rect.left, cy - rect.top); 
                };
                const end = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); isDrawing = false; draw(null, null); 
                    if(path.length < 3) { this.toast('ç‚¹å¤ªå°‘å•¦'); path = []; draw(null,null); return; } 
                    const code = path.join('');
                    if(this.mode === 'setup') { 
                        if(this.step === 1) { this.tempSecret = code;
                            this.step = 2; document.getElementById('gestTitle').textContent = 'å†æ¬¡ç»˜åˆ¶'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } 
                        else { if(code === this.tempSecret) this.finishPasswordSetup(code);
                        else { this.toast('ä¸ä¸€è‡´'); this.step = 1; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } } 
                    } else if(this.mode === 'login') { 
                        if(code === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                        else { this.handleFail(); setTimeout(()=>{ path=[]; draw(null,null); }, 500); } 
                    } 
                };
                const newCanvas = canvas.cloneNode(true); canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.addEventListener('mousedown', start); newCanvas.addEventListener('touchstart', start, {passive: false});
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end);

                this.resetGesture = () => { this.step = 1; this.tempSecret = null; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; document.getElementById('gestResetBtn').style.display = 'none';
                    path = []; draw(null,null); };
            },

            finishPasswordSetup: function(secret) { this.finalSecret = secret; this.finalType = this.type; this.showView('view-setup-question'); },
            saveSecurityQuestion: function() { const q = document.getElementById('secQuestion').value.trim();
                const a = document.getElementById('secAnswer').value.trim(); if(!q || !a) { this.toast('è¯·å¡«å†™å®Œæ•´'); return; } localStorage.setItem('magic_auth_type', this.finalType); localStorage.setItem('magic_auth_secret', this.finalSecret); localStorage.setItem('magic_auth_q', q); localStorage.setItem('magic_auth_a', a); this.toast('è®¾ç½®æˆåŠŸï¼');
                this.unlockApp(); },
            handleFail: function() { this.failCount++; this.toast('å¯†ç é”™è¯¯');
                if(this.failCount >= 3) { if(this.type==='pin') document.getElementById('pinForgotBtn').style.display='block'; else document.getElementById('gestForgotBtn').style.display='block'; } },
            showRecovery: function() { const q = localStorage.getItem('magic_auth_q');
                if(!q) { this.toast('æœªè®¾ç½®é—®é¢˜'); return; } document.getElementById('recoveryQText').textContent = q; this.showView('view-recovery'); },
            checkRecovery: function() { if(document.getElementById('recoveryAnswer').value.trim() === localStorage.getItem('magic_auth_a')) { localStorage.removeItem('magic_auth_type');
                localStorage.removeItem('magic_auth_secret'); this.toast('éªŒè¯æˆåŠŸï¼Œè¯·é‡è®¾'); setTimeout(() => location.reload(), 1000); } else this.toast('é”™è¯¯'); },
            unlockApp: function() { document.getElementById('lockScreen').style.transition = 'opacity 0.5s';
                document.getElementById('lockScreen').style.opacity = 0; setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; if(!window.appInitialized) { initOriginalApp(); window.appInitialized = true; } }, 500);
            }
        };

        // ================= ğŸ“± åº”ç”¨æ ¸å¿ƒé€»è¾‘ =================
        let items = [];
        let draftResources = []; 
        let currentTags = [];
        let isEditing = false;
        let editingIndex = -1;
        let viewingIndex = -1;
        let galleryIndex = 0;
        let currentLuckyIndex = -1;

        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶', 'è‡ªå®šä¹‰'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';
        let db;

        window.onload = function() { auth.init(); };
        function initOriginalApp() { initDB().then(() => { loadFromDB(); migrateFromLocalStorage(); initLayout(); }); initMusic(); initDraggable(); }
        function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onerror = () => reject(); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); }; request.onsuccess = (e) => { db = e.target.result; resolve(); }; }); }
        async function loadFromDB() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { items = req.result.sort((a, b) => new Date(b.date) - new Date(a.date)); renderGrid(items);
            renderNavPanel(); }; }
        async function saveItemToDB(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); const req = item.id ? store.put(item) : store.add(item); req.onsuccess = () => resolve(req.result); req.onerror = () => { alert('ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶å¤ªå¤§ï¼Ÿ'); reject(); }; }); }
        async function deleteItemFromDB(id) { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete(id);
            return new Promise(resolve => tx.oncomplete = resolve); }
        function migrateFromLocalStorage() { const old = localStorage.getItem('my_magic_collection_v3');
            if(old) { try { const p = JSON.parse(old); if(p.length > 0 && confirm('å‘ç°æ—§æ•°æ®ï¼Œè¿ç§»å—ï¼Ÿ')) { const tx = db.transaction(STORE_NAME, 'readwrite');
            p.forEach(i => { delete i.id; tx.objectStore(STORE_NAME).add(i); }); tx.oncomplete = () => { alert('è¿ç§»æˆåŠŸï¼'); localStorage.removeItem('my_magic_collection_v3'); loadFromDB(); };
            } } catch(e){} } }

        function renderGrid(dataList) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            if (dataList.length === 0) { 
                container.innerHTML = '<div class="empty-state">ç©ºç©ºçš„...å¿«å»æ·»åŠ å§ï¼</div>';
                return; 
            }

            dataList.forEach((item) => {
                const realIndex = items.indexOf(item);
                const card = document.createElement('div'); 
                
                card.className = 'card';
            
                if (isBatchDeleteMode) {
                    card.classList.add('is-selecting');
                    if (selectedDeleteIds.has(item.id)) {
                        card.classList.add('selected');
                    }
        
                    card.onclick = () => {
                        if (selectedDeleteIds.has(item.id)) {
                            selectedDeleteIds.delete(item.id);
                        } else {
                            selectedDeleteIds.add(item.id);
                        }
                        renderGrid(dataList); 
                        updateDeleteBar();
                    };
                } else {
                    card.onclick = () => openDetailModal(realIndex);
                }

                const images = item.resources.filter(r => r.type === 'image');
                let coverSrc = PLACEHOLDER_IMG; 
                if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
                
                const imgWrapper = document.createElement('div'); 
               // ğŸ‘‡ ä¿®æ”¹åï¼šä¼šè‡ªåŠ¨è¯»å– item.frameStyle å¹¶åŠ ä¸Šå¯¹åº”çš„ CSS ç±»
imgWrapper.className = `card-img-wrapper ${item.frameStyle || ''}`;
                const img = document.createElement('img'); 
                img.src = coverSrc; 
                imgWrapper.appendChild(img);
                
                const content = document.createElement('div'); 
                content.className = 'card-content';
                const title = document.createElement('h3');
                title.className = 'card-title'; 
                title.textContent = item.name;
                content.appendChild(title); 
                
                const tagsDiv = document.createElement('div'); 
                tagsDiv.className = 'tags-container';
                (item.tags||[]).forEach(t => { 
                    const span = document.createElement('span'); 
                    span.className = 'tag-pill'; 
                    span.textContent = t; 
                    tagsDiv.appendChild(span); 
                }); 
                content.appendChild(tagsDiv);
                
                card.appendChild(imgWrapper); 
                card.appendChild(content); 
                container.appendChild(card);
            });
        }

                function switchLayout(mode) {
            const c = document.getElementById('gridContainer');
            c.className = 'grid-container'; // æ¸…é™¤æ—§æ¨¡å¼
            
            // æŒ‰é’®çŠ¶æ€é‡ç½®
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));

            if (mode === 'shelf') {
                document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.add('active');
                renderShelfView(); // ğŸ‘ˆ è°ƒç”¨ä¸‹é¢æ–°å†™çš„æ¸²æŸ“å‡½æ•°
            } else {
                c.classList.add('mode-' + mode);
                renderGrid(items); // æ¢å¤æ­£å¸¸æ¸²æŸ“
                
                // æ¢å¤æŒ‰é’®é«˜äº®é€»è¾‘
                if(mode==='default') document.querySelector('.layout-btn[title="é»˜è®¤ç½‘æ ¼"]').classList.add('active');
                if(mode==='list') document.querySelector('.layout-btn[title="é•¿åˆ—è¡¨"]').classList.add('active');
                if(mode==='large') document.querySelector('.layout-btn[title="å¤§å›¾æ¨¡å¼"]').classList.add('active');
                if(mode==='mini') document.querySelector('.layout-btn[title="è¿·ä½ æ¨¡å¼"]').classList.add('active');
            }

            localStorage.setItem('my_magic_layout', mode);
            if(mode !== 'shelf') auth.toast('è§†å›¾åˆ‡æ¢æˆåŠŸ âœ¨');
        }

        function initLayout() {
            const mode = localStorage.getItem('my_magic_layout') || 'default';
            switchLayout(mode);
        }

        // --- æŠ½ç­¾é€»è¾‘ ---
        function startLottery() {
            if(items.length === 0) { auth.toast('ç›’å­æ˜¯ç©ºçš„æ€ä¹ˆæŠ½å‘€~'); return; }
            document.getElementById('floatMenu').classList.remove('active');
            const overlay = document.getElementById('lotteryOverlay');
            const gift = document.getElementById('magicGift');
            const result = document.getElementById('lotteryResult');
            overlay.classList.add('active'); result.style.display = 'none'; gift.style.display = 'block'; gift.classList.add('shaking');
            const luckyIndex = Math.floor(Math.random() * items.length);
            currentLuckyIndex = luckyIndex;
            const item = items[luckyIndex];
            document.getElementById('lotteryName').textContent = item.name;
            const images = item.resources.filter(r => r.type === 'image');
            let coverSrc = PLACEHOLDER_IMG; 
            if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
            document.getElementById('lotteryImg').src = coverSrc;
            setTimeout(() => { gift.classList.remove('shaking'); gift.style.display = 'none'; result.style.display = 'flex'; }, 1500);
        }
        function closeLottery() { document.getElementById('lotteryOverlay').classList.remove('active'); }
        function goToLotteryItem() { closeLottery(); if(currentLuckyIndex !== -1) setTimeout(() => openDetailModal(currentLuckyIndex), 300); }

        // --- ğŸŸ¢ å¢å¼ºç‰ˆï¼šå…¨èƒ½æ‰¹é‡å¯¼å…¥ (æ”¯æŒ .jsonl è‡ªåŠ¨è¯†åˆ«) ---
        async function handleBatchImageImport(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            auth.toast(`æ­£åœ¨æ¬è¿ ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨ç­‰... ğŸšš`);
            let count = 0;
            for (let f of files) {
                const name = f.name;
                let resourceType = 'file'; 
                let subType = 'é™„ä»¶';
                let content = null;
                if (f.type.startsWith('image/')) {
                    resourceType = 'image';
                    subType = 'é»˜è®¤';
                    content = await readFile(f); 
                } else if (f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    resourceType = 'json';
                    subType = 'æ•°æ®';
                    content = await readFileText(f);
                } else {
                    resourceType = 'file';
                    subType = 'é™„ä»¶';
                    content = await readFile(f); 
                }

                const newItem = { 
                    name: name, 
                    tags: ['æ‰¹é‡å¯¼å…¥'], 
                    resources: [{ 
                        type: resourceType, 
                        subType: subType, 
                        name: name, 
                        content: content 
                    }], 
                    coverIndex: 0, 
                    date: new Date().toISOString() 
                };
                try { 
                    await saveItemToDB(newItem);
                    count++; 
                } catch(e) { 
                    console.error("æ–‡ä»¶å¤ªå¤§æˆ–ä¿å­˜å¤±è´¥:", e);
                    auth.toast(`âŒ ${name} å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹ï¼`);
                }
            }
            loadFromDB();
            auth.toast(`æå®šï¼æˆåŠŸå­˜å…¥äº† ${count} ä¸ªå®è´ï¼âœ¨`);
            input.value = ''; 
        }

        // ================= ğŸ§¹ æ‰¹é‡åˆ é™¤é€»è¾‘ =================

        let isBatchDeleteMode = false;
        let selectedDeleteIds = new Set(); 

        function toggleBatchDeleteMode() {
            isBatchDeleteMode = !isBatchDeleteMode;
            selectedDeleteIds.clear(); 
            updateDeleteBar();
            handleSearch(); 
            
            if(isBatchDeleteMode) {
                auth.toast('è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šè¯·ç‚¹é€‰è¦åˆ é™¤çš„ç›’å­ ğŸ—‘ï¸');
            }
        }

        function updateDeleteBar() {
            const bar = document.getElementById('deleteBar');
            const countSpan = document.getElementById('deleteCount');
            
            if (isBatchDeleteMode) {
                bar.classList.add('active');
                countSpan.textContent = selectedDeleteIds.size;
            } else {
                bar.classList.remove('active');
            }
        }

        async function confirmBatchDelete() {
            if (selectedDeleteIds.size === 0) {
                auth.toast('è¿˜æ²¡é€‰ä»»ä½•ä¸œè¥¿å‘¢~');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedDeleteIds.size} ä¸ªç›’å­å—ï¼Ÿæ— æ³•æ¢å¤å“¦ï¼`)) return;
            for (let id of selectedDeleteIds) {
                await deleteItemFromDB(id);
            }

            toggleBatchDeleteMode(); 
            loadFromDB(); 
            auth.toast('æ¸…ç†å®Œæ¯•ï¼å˜å¾—æ¸…çˆ½å¤šå•¦ âœ¨');
        }

        // --- CRUD & UI Helpers ---
        function resetAddModal() { isEditing = false;
            editingIndex = -1; document.getElementById('modalTitle').textContent = 'âœ¨ æ·»åŠ æ–°æ”¶è—'; document.getElementById('itemName').value = ''; 
    document.getElementById('itemMemories').value = ''; // ğŸŸ¢ æ–°å¢ï¼šæ¸…ç©ºå›å¿†å½•
document.getElementById('tagInput').value = ''; document.getElementById('linkInputArea').style.display = 'none'; draftResources = [];
            currentTags = []; renderTagsInput(); renderResourceList(); renderSuggestTags(); }
        function openAddModal() { resetAddModal(); document.getElementById('addModal').classList.add('active'); }
        function openEditMode() { if (viewingIndex === -1) return; isEditing = true;
            editingIndex = viewingIndex; const item = items[editingIndex]; document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç›’å­å†…å®¹'; document.getElementById('itemName').value = item.name; 
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šå›æ˜¾å›å¿†å½•ï¼ŒæŠŠæ•°ç»„å˜å›å¤šè¡Œæ–‡æœ¬
    document.getElementById('itemMemories').value = (item.memories || []).join('\n');
currentTags = [...(item.tags || [])];
            draftResources = JSON.parse(JSON.stringify(item.resources)); renderTagsInput(); renderResourceList(); renderSuggestTags(); document.getElementById('detailModal').classList.remove('active'); document.getElementById('addModal').classList.add('active'); }
        
        function renderResourceList() {
            const list = document.getElementById('resourceList');
            list.innerHTML = '';
            if(draftResources.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹</div>'; return; }
            draftResources.forEach((res, idx) => {
                const item = document.createElement('div'); item.className = 'resource-item';
                let p = '';
                if (res.type === 'image') p = `<img src="${res.content}" style="width:100%;height:100%;object-fit:cover">`;
                else if (res.type === 'json') p = 'ğŸ“„';
                else if (res.type === 'link') p = 'ğŸ”—';
                else p = 'ğŸ“';

                const isCustom = !TYPES.includes(res.subType) || res.subType === 'è‡ªå®šä¹‰';
                const selectValue = isCustom ? 'è‡ªå®šä¹‰' : res.subType;
                const customInputValue = (isCustom && res.subType !== 'è‡ªå®šä¹‰') ? res.subType : '';
                const customDisplay = isCustom ? 'inline-block' : 'none';

                let controlsHtml = '';
                if (res.type !== 'link') {
                    let options = '';
                    TYPES.forEach(t => { options += `<option value="${t}" ${selectValue === t ? 'selected' : ''}>${t}</option>`; });
                    controlsHtml = `<div class="resource-controls"><select class="resource-type-select" onchange="handleTypeChange(${idx}, this.value)">${options}</select><input type="text" class="custom-type-input" style="display:${customDisplay}" placeholder="è¾“å…¥ç±»å‹" value="${customInputValue}" onchange="updateCustomType(${idx}, this.value)"></div>`;
                } else {
                    controlsHtml = `<span style="font-size:11px;color:#aaa">é“¾æ¥</span>`;
                }
                item.innerHTML = `<div class="resource-preview">${p}</div><div class="resource-info"><input type="text" class="resource-name-input" value="${res.name}" onchange="updateResourceName(${idx}, this.value)" placeholder="è¯·è¾“å…¥æ–‡ä»¶åç§°">${controlsHtml}</div><button class="btn-remove" onclick="removeDraftResource(${idx})">Ã—</button>`;
                list.appendChild(item);
            });
        }

        function updateResourceName(idx, val) { draftResources[idx].name = val; }
        function handleTypeChange(idx, val) { if (val === 'è‡ªå®šä¹‰') { draftResources[idx].subType = 'è‡ªå®šä¹‰';
            } else { draftResources[idx].subType = val; } renderResourceList(); }
        function updateCustomType(idx, val) { draftResources[idx].subType = val; }
        function removeDraftResource(idx) { draftResources.splice(idx, 1); renderResourceList(); }
        
        async function handleUniversalSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) {
                if (f.type.startsWith('image/')) {
                    const b = await readFile(f);
                    draftResources.push({ type: 'image', subType: 'é»˜è®¤', name: f.name, content: b });
                } else if (f.type === 'application/json' || f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    const t = await readFileText(f);
                    draftResources.push({ type: 'json', subType: 'é»˜è®¤', name: f.name, content: t });
                } else {
                    const b = await readFile(f);
                    draftResources.push({ type: 'file', subType: 'é™„ä»¶', name: f.name, content: b });
                }
            }
            renderResourceList();
            input.value = '';
        }

        function openLinkInput() { document.getElementById('linkInputArea').style.display = 'block'; }
        function confirmAddLink() { const n = document.getElementById('newLinkName').value.trim(), u = document.getElementById('newLinkUrl').value.trim();
            if(n && u) { draftResources.push({ type: 'link', subType: 'link', name: n, content: u }); renderResourceList(); document.getElementById('newLinkName').value = '';
            document.getElementById('newLinkUrl').value = ''; document.getElementById('linkInputArea').style.display = 'none'; } else alert('è¯·è¾“å…¥åç§°å’Œç½‘å€'); }
        async function saveItem() { const n = document.getElementById('itemName').value.trim();
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šè·å–å¤šè¡Œæ–‡æœ¬ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
    const memRaw = document.getElementById('itemMemories').value;
    const memList = memRaw.split('\n').filter(line => line.trim() !== '');
    // ğŸ‘† ğŸŸ¢ æ–°å¢ç»“æŸ
if (!n) { alert('åå­—ä¸èƒ½ä¸ºç©º'); return; } if (draftResources.length === 0) { alert('ç›’å­ä¸èƒ½ä¸ºç©º'); return;
            } const d = { name: n, tags: [...currentTags], memories: memList, resources: draftResources, coverIndex: 0, date: new Date().toISOString() };
            if (isEditing) { d.id = items[editingIndex].id; d.coverIndex = items[editingIndex].coverIndex; } await saveItemToDB(d); loadFromDB(); handleSearch(); closeAddModal();
        }
        
        function openDetailModal(index) { 
            viewingIndex = index;
            const item = items[index]; document.getElementById('detailName').textContent = item.name; const tagsBox = document.getElementById('detailTags'); tagsBox.innerHTML = '';
            (item.tags||[]).forEach(t => { const s = document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsBox.appendChild(s); }); const images = item.resources.filter(r => r.type === 'image');
            if(images.length === 0) { document.getElementById('galleryArea').style.display = 'none'; document.getElementById('noImgMsg').style.display = 'block'; } else { document.getElementById('galleryArea').style.display = 'block'; document.getElementById('noImgMsg').style.display = 'none';
            galleryIndex = Math.min(item.coverIndex||0, images.length-1); updateGalleryUI(images); 
initHeadpat();
} 
            
            const listContainer = document.getElementById('detailListContainer');
            listContainer.innerHTML = ''; 
            
            item.resources.forEach((res, i) => { 
                const row = document.createElement('div'); row.className = 'detail-item'; 
                let icon = 'ğŸ“„', btn = '', lbl = res.subType; 
                
                const downloadBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`;

                if (res.type === 'image') { 
                    icon = 'ğŸ–¼ï¸'; btn = downloadBtn; 
                } 
                else if (res.type === 'json') { 
                    icon = 'ğŸ“œ'; 
                    btn = `<span class="action-link" style="background:#e0f7fa;color:#006064;margin-right:5px;" onclick="openReader(${i})">ğŸ“– é˜…è¯»</span>` + downloadBtn; 
                } 
                else if (res.type === 'link') { 
                    icon = 'ğŸ”—'; lbl = 'é“¾æ¥'; btn = `<a class="action-link" href="${res.content}" target="_blank">æ‰“å¼€</a>`; 
                } 
                else { 
                    icon = 'ğŸ“'; lbl = 'é™„ä»¶';
                    btn = downloadBtn; 
                } 
                
                row.innerHTML = `<div style="display:flex;align-items:center;min-width:0;"><span class="detail-item-type">${lbl}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${icon} ${res.name}</span></div><div style="flex-shrink:0;margin-left:10px;">${btn}</div>`;
                listContainer.appendChild(row); 
            });
            // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šæ¸²æŸ“å°ç« çŠ¶æ€
            renderStampStatus(items[index].stamp);
            
    // ğŸ‘‡ ğŸŸ¢ åœ¨å‡½æ•°æœ€ååŠ è¿™å¥ï¼Œå¼€å§‹æ’­æ”¾åŠ¨ç”»
    startMemoryAnimation(items[index].memories || []);
renderStickyNote(); // âœ… åŠ è¿™ä¸€å¥ï¼Œæ‰“å¼€æ—¶è´´ä¸Šä¾¿ç­¾
document.getElementById('detailModal').classList.add('active'); 
renderDetailSouvenirs(index);
        }

                function updateGalleryUI(images) {
            const imgEl = document.getElementById('detailImg');
            const curImg = images[galleryIndex];
            
            // åŸºç¡€å›¾ç‰‡è®¾ç½®
            imgEl.src = curImg.content;
            document.getElementById('galleryTypeLabel').textContent = curImg.subType;
            document.getElementById('imgIndex').textContent = galleryIndex + 1;
            document.getElementById('imgTotal').textContent = images.length;
            
            // å°é¢æŒ‰é’®çŠ¶æ€
            const cb = document.getElementById('setCoverBtn');
            if (galleryIndex === (items[viewingIndex].coverIndex || 0)) {
                cb.textContent = 'å½“å‰å°é¢'; 
                cb.classList.add('is-cover'); 
            } else { 
                cb.textContent = 'è®¾ä¸ºå°é¢';
                cb.classList.remove('is-cover');
            }

            // âœ… æ–°å¢ï¼šæ¸²æŸ“è¯¦æƒ…é¡µç‰¹æ•ˆ
            renderDetailEffect(); 
        }

        function changeGalleryImage(d) { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; galleryIndex += d; if(galleryIndex >= images.length) galleryIndex = 0;
            if(galleryIndex < 0) galleryIndex = images.length - 1; updateGalleryUI(images); }
        async function setAsCover() { if(viewingIndex === -1) return;
            const item = items[viewingIndex]; item.coverIndex = galleryIndex; await saveItemToDB(item); const images = item.resources.filter(r => r.type === 'image'); updateGalleryUI(images); loadFromDB();
        }
        function downloadCurrentGalleryImg() { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; const cur = images[galleryIndex]; downloadFile(cur.name, cur.content);
        }
        function downloadResource(resIndex) { const res = items[viewingIndex].resources[resIndex]; if(res.type === 'link') return;
            downloadFile(res.name, res.content); }
        function downloadFile(name, content) { const a = document.createElement('a');
            if (content.startsWith('data:')) a.href = content; else { const blob = new Blob([content], {type: 'application/json'}); a.href = URL.createObjectURL(blob);
            } a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); if (!content.startsWith('data:')) URL.revokeObjectURL(a.href);
        }
        function readFile(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(file); });
        }
        function readFileText(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsText(file); });
        }
        
        function handleTagInput(e) { 
            if(e.key==='Enter'){ e.preventDefault();
            manualAddTag(); } 
            if(e.key==='Backspace' && !e.target.value) { currentTags.pop(); renderTagsInput(); } 
        }
        function manualAddTag() {
            const el = document.getElementById('tagInput');
            const v = el.value.trim();
            if(v && !currentTags.includes(v)) { currentTags.push(v); el.value=''; renderTagsInput(); }
            el.focus();
        }

        function renderTagsInput() { const area=document.getElementById('tagInputArea'); const inp=document.getElementById('tagInput'); Array.from(area.children).forEach(c=>c!==inp && area.removeChild(c));
            currentTags.forEach((t,i)=>{ const d=document.createElement('div'); d.className='tag-chip'; d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()" style="cursor:pointer">Ã—</span>`; area.insertBefore(d,inp); });
        }
        function renderSuggestTags() { const all=new Set(); items.forEach(i=>(i.tags||[]).forEach(t=>all.add(t))); const box=document.getElementById('suggestedTags'); box.innerHTML='';
            all.forEach(t=>{ const d=document.createElement('div'); d.className='tag-chip'; d.style.background='#f0f0f0'; d.style.color='#666'; d.style.cursor='pointer'; d.textContent=t; d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}}; box.appendChild(d); });
        }
                function handleSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            const isDeep = document.getElementById('deepSearchCheck').checked; // æ˜¯å¦å‹¾é€‰äº†â€œæœå†…å®¹â€

            if (!q) {
                renderGrid(items); // æ²¡å­—å°±æ˜¾ç¤ºå…¨éƒ¨
                return;
            }

            const f = items.filter(item => {
                // 1. åŸºç¡€æœç´¢ï¼šæœåå­—å’Œæ ‡ç­¾
                const matchBasic = item.name.toLowerCase().includes(q) || (item.tags || []).some(t => t.toLowerCase().includes(q));
                
                if (matchBasic) return true;

                // 2. æ·±å±‚æœç´¢ï¼šå¦‚æœå‹¾é€‰äº†ï¼Œå°±å»ç¿» resources é‡Œçš„å†…å®¹
                if (isDeep && item.resources) {
                    return item.resources.some(res => {
                        // åªæœ JSON (èŠå¤©è®°å½•) æˆ– æ–‡æœ¬æ–‡ä»¶
                        if (res.type === 'json' || res.type === 'file') {
                            // ç›´æ¥åœ¨å­—ç¬¦ä¸²é‡Œæ‰¾ï¼Œç®€å•ç²—æš´ä¸”é«˜æ•ˆ
                            return res.content && res.content.toLowerCase().includes(q);
                        }
                        return false;
                    });
                }
                
                return false;
            });

            renderGrid(f);
            
            // ğŸŸ¢ å¦‚æœæ˜¯æ·±å±‚æœç´¢ï¼Œç»™ä¸ªæç¤ºåé¦ˆ
            if(isDeep && q) {
                // ç®€å•çš„é˜²æŠ–æç¤ºï¼Œé¿å…æ¯æ¬¡æ‰“å­—éƒ½å¼¹
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥åˆ©ç”¨ Grid çš„ç©ºçŠ¶æ€æ¥æç¤º
                if(f.length === 0) {
                    document.querySelector('.empty-state').innerHTML = `ğŸ¤” åœ¨å›å¿†é‡Œæ‰¾äº†ä¸€åœˆï¼Œæ²¡æ‰¾åˆ° "${q}"...`;
                }
            }
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
                function closeAddModal() { 
            document.getElementById('addModal').classList.remove('active'); 
        }
        function closeDetailModal() { 
            document.getElementById('detailModal').classList.remove('active'); 
            viewingIndex = -1; 
            
            // ğŸ‘‡ ğŸŸ¢ å¿…é¡»æ”¾åœ¨è¿™ä¸ªèŠ±æ‹¬å·é‡Œé¢ï¼ ğŸŸ¢ ğŸ‘‡
            stopMemoryAnimation();
        }
        async function deleteCurrentItem() { 
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                const id = items[viewingIndex].id; 
                await deleteItemFromDB(id);
                loadFromDB(); 
                closeDetailModal(); 
            } 
        }
        function exportAllData() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { const blob = new Blob([JSON.stringify(req.result)], {type:'application/json'}); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } }
        function importAllData(el) { const file = el.files[0]; if(!file) return;
            const r = new FileReader(); r.onload = e => { try { const imported = JSON.parse(e.target.result);
            if(Array.isArray(imported)) { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); imported.forEach(item => { delete item.id; store.add(item); });
            tx.oncomplete = () => { loadFromDB(); alert('å¯¼å…¥æˆåŠŸï¼'); }; } } catch{ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); } }; r.readAsText(file);
        }
        function initMusic() { const link = localStorage.getItem('my_bgm_link') || DEFAULT_MUSIC;
            const audio = document.getElementById('bgMusic'); audio.src = link; audio.volume = 0.5; document.getElementById('musicLink').value = link;
        }
        function toggleMusic() { const a=document.getElementById('bgMusic'); const b=document.getElementById('playBtn');
            if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';} }
        function changeVolume(s) { document.getElementById('bgMusic').volume=s.value;
        }
        function updateMusicSrc(v) { if(v){document.getElementById('bgMusic').src=v; localStorage.setItem('my_bgm_link',v);
            document.getElementById('playBtn').textContent='â–¶';} }
              // ğŸ·ï¸ ä¿®å¤åçš„ç›®å½•æ¸²æŸ“å‡½æ•°
        function renderNavPanel() {
            const c = document.getElementById('navPanel');
            if(!c) return;
            
            c.innerHTML = ''; // æ¸…ç©ºå†…å®¹

            const map = {};
            const no = [];
            
            // 1. æ•´ç†æ•°æ®
            items.forEach((it, i) => {
                if (!it.tags || it.tags.length == 0) no.push(i);
                else it.tags.forEach(tag => {
                    if (!map[tag]) map[tag] = [];
                    map[tag].push(i);
                });
            });

            // 2. ç”Ÿæˆ HTML (å…ˆæ”¾æœªåˆ†ç±»ï¼Œå†æ”¾æœ‰æ ‡ç­¾çš„)
            if (no.length) createNavGroup(c, 'ğŸ“‚ æœªåˆ†ç±»', no);
            
            Object.keys(map).sort().forEach(k => {
                createNavGroup(c, `ğŸ·ï¸ ${k}`, map[k]);
            });
            
            // å¦‚æœå®Œå…¨æ²¡å†…å®¹ï¼Œç»™ä¸ªæç¤º
            if(no.length === 0 && Object.keys(map).length === 0) {
                c.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">è¿˜æ²¡åŠ æ ‡ç­¾å‘¢~</div>';
            }
        }

        function createNavGroup(c,t,idx) { const g=document.createElement('div'); g.style.marginBottom='5px'; const h=document.createElement('div'); h.innerHTML=`${t} â–¾`; h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555;'; h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'};
            const l=document.createElement('div'); l.style.cssText='display:none;padding-left:10px;'; idx.forEach(i=>{ const it=document.createElement('div'); it.textContent=items[i].name; it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888;'; it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active')}; l.appendChild(it); }); g.appendChild(h); g.appendChild(l); c.appendChild(g);
        }

        function initDraggable() {
            const w=document.getElementById('floatWidget'), b=document.getElementById('floatBtn'), m=document.getElementById('floatMenu');
            let isDragging=false, startX, startY, initialLeft, initialTop;
            b.addEventListener('mousedown', s); b.addEventListener('touchstart', s, {passive:false});
            function s(e) { if(e.target.closest('.float-menu'))return; isDragging=false; const c=e.type.includes('mouse')?e:e.touches[0]; startX=c.clientX; startY=c.clientY;
            const r=w.getBoundingClientRect(); initialLeft=r.left; initialTop=r.top; w.style.left=initialLeft+'px'; w.style.top=initialTop+'px'; w.style.bottom='auto'; w.style.right='auto'; if(e.type.includes('mouse')) { document.addEventListener('mousemove', mv); document.addEventListener('mouseup', ed); } else { document.addEventListener('touchmove', mv, {passive:false});
            document.addEventListener('touchend', ed); } }
            function mv(e) { const c=e.type.includes('mouse')?e:e.touches[0];
            const dx=c.clientX-startX, dy=c.clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5){ isDragging=true; if(m.classList.contains('active'))m.classList.remove('active'); } if(isDragging){ e.preventDefault(); w.style.left=(initialLeft+dx)+'px'; w.style.top=(initialTop+dy)+'px';
            } }
            function ed() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',ed); document.removeEventListener('touchmove',mv); document.removeEventListener('touchend',ed);
            }
            b.addEventListener('click', (e)=>{ if(isDragging){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');} });
            document.addEventListener('click', (e)=>{ if(m.classList.contains('active')&&!w.contains(e.target)){m.classList.remove('active');} });
        }

        // ================= ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤é€»è¾‘ (Reader System - ç¼–è¾‘ & ä¹¦ç­¾å¢å¼ºç‰ˆ) =================

        let readerState = {
            data: [],
            bookmarks: {}, // æ ¼å¼: { floorIndex: "å¤‡æ³¨å†…å®¹" }
            currentPage: 1,
            pageSize: 10,
            totalMessages: 0,
            totalPages: 0,
            resourceIndex: -1 // è®°å½•å½“å‰æ­£åœ¨è¯»å“ªä¸ªæ–‡ä»¶ï¼Œæ–¹ä¾¿ä¿å­˜
        };

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('bookmarkDrawer').classList.remove('active');
        }

        async function openReader(resIndex) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            const res = item.resources[resIndex];
            
            readerState.resourceIndex = resIndex;

            let jsonContent;
            try {
                // 1. è§£æå†…å®¹
                if (res.content.startsWith('data:')) {
                    const base64 = res.content.split(',')[1];
                    const decoded = atob(base64);
                    // è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
                    const bytes = new Uint8Array(decoded.length);
                    for (let i = 0; i < decoded.length; i++) bytes[i] = decoded.charCodeAt(i);
                    jsonContent = new TextDecoder('utf-8').decode(bytes);
                } else {
                    jsonContent = res.content;
                }

                let chatData = [];
                try {
                    chatData = JSON.parse(jsonContent);
                } catch (e) {
                    // å°è¯• JSONL
                    const lines = jsonContent.split('\n').filter(line => line.trim() !== '');
                    chatData = lines.map(line => JSON.parse(line));
                }

               // æ ‡å‡†åŒ–æ¶ˆæ¯ (ä¿æŒä¸å˜)
                let messages = [];
                if (Array.isArray(chatData)) {
                    messages = chatData;
                } else if (chatData.messages && Array.isArray(chatData.messages)) {
                    messages = chatData.messages;
                }

                if (messages.length === 0) {
                    auth.toast('æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½• ğŸ“œ');
                    return;
                }

                // åŠ è½½ä¹¦ç­¾ (ä¿æŒä¸å˜)
                if (!res.bookmarks) {
                    res.bookmarks = {};
                }
                readerState.bookmarks = res.bookmarks;

                // åˆå§‹åŒ–åˆ†é¡µ
                readerState.data = messages;
                readerState.totalMessages = messages.length;
                readerState.pageSize = 10;
                readerState.totalPages = Math.ceil(messages.length / readerState.pageSize);
                readerState.currentPage = 1;

                document.getElementById('readerTitle').textContent = res.name.replace(/\.jsonl?$/i, '');
                
                renderCurrentPage();
                
                // ğŸŸ¢ æ”¹åŠ¨ï¼šæ‰“å¼€é˜…è¯»å™¨æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0; 
                
                document.getElementById('readerModal').classList.add('active');

            } catch (e) {
                console.error(e);
                auth.toast('æ‰“ä¸å¼€...æ ¼å¼å¥½åƒä¸å¯¹ ğŸ˜µ');
            }
        }

              function renderCurrentPage() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = ''; 

            const startIdx = (readerState.currentPage - 1) * readerState.pageSize;
            const endIdx = Math.min(startIdx + readerState.pageSize, readerState.totalMessages);
            const currentMessages = readerState.data.slice(startIdx, endIdx);

            document.getElementById('readerCount').textContent = `æ€»è®¡ ${readerState.totalMessages} æ¥¼`;
            document.getElementById('pageInfo').textContent = `${readerState.currentPage} / ${readerState.totalPages}`;

            currentMessages.forEach((msg, i) => {
                // ... (ä¸­é—´çš„ forEach å¾ªç¯ç”Ÿæˆæ°”æ³¡çš„ä»£ç å®Œå…¨ä¿æŒä¸å˜) ...
                // ... ç›´æ¥å¤åˆ¶åŸæ¥çš„å³å¯ ...
                const globalIndex = startIdx + i;
                const text = msg.mes || msg.content || msg.text || msg.message || '...';
                const name = msg.name || '???';
                
                let isRight = false;
                if (msg.hasOwnProperty('is_user')) isRight = msg.is_user;
                else if (msg.hasOwnProperty('is_main')) isRight = msg.is_main;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isRight = true;

                const sideClass = isRight ? 'right' : 'left';
                const row = document.createElement('div');
                row.className = `chat-row ${sideClass}`;
                row.id = `floor-${globalIndex}`; 

                const floor = document.createElement('span');
                floor.className = 'floor-tag';
                
                const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
                const starClass = isBookmarked ? 'active' : '';
                
                floor.innerHTML = `
                    #${globalIndex + 1} 
                    <span class="bookmark-icon ${starClass}" 
                          onclick="handleBookmarkClick(${globalIndex}, this)" 
                          title="${isBookmarked ? 'ç‚¹å‡»ä¿®æ”¹/åˆ é™¤å¤‡æ³¨' : 'ç‚¹å‡»æ·»åŠ ä¹¦ç­¾'}">
                          â˜…
                    </span>`;

                const bubbleWrapper = document.createElement('div');
                const nameTag = document.createElement('div');
                nameTag.className = 'chat-name';
                nameTag.textContent = name;

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                bubble.title = "åŒå‡»ç¼–è¾‘å†…å®¹";
                bubble.ondblclick = (e) => {
                    e.stopPropagation();
                    enableEditMode(bubble, globalIndex, text);
                };

                bubbleWrapper.appendChild(nameTag);
                bubbleWrapper.appendChild(bubble);
                
                row.appendChild(floor);
                row.appendChild(bubbleWrapper);
                container.appendChild(row);
            });

            // ğŸŸ¢ æ”¹åŠ¨ï¼šåˆ é™¤äº† container.scrollTop = 0; è¿™ä¸€è¡Œ
            // è¿™æ ·åˆ·æ–°é¡µé¢æ—¶ï¼Œæ»šåŠ¨æ¡ä¼šåœç•™åœ¨åŸåœ°
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šåŒå‡»ç¼–è¾‘é€»è¾‘ ---
        function enableEditMode(bubbleEl, globalIndex, oldText) {
            // é¿å…é‡å¤è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (bubbleEl.querySelector('.bubble-textarea')) return;

            // åˆ›å»ºç¼–è¾‘ç•Œé¢
            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-edit-wrapper';

            const textarea = document.createElement('textarea');
            textarea.className = 'bubble-textarea';
            textarea.value = oldText; // ç›´æ¥æ”¾å…¥åŸæ–‡æœ¬ï¼Œä¸å« <br>
            
            const btnRow = document.createElement('div');
            btnRow.className = 'edit-btn-row';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'edit-confirm-btn';
            confirmBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            confirmBtn.onclick = () => saveBubbleEdit(globalIndex, textarea.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'edit-cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = () => renderCurrentPage(); // é‡æ–°æ¸²æŸ“æ¢å¤åŸçŠ¶

            btnRow.appendChild(cancelBtn);
            btnRow.appendChild(confirmBtn);
            wrapper.appendChild(textarea);
            wrapper.appendChild(btnRow);

            // æ¸…ç©ºæ°”æ³¡å¹¶æ”¾å…¥ç¼–è¾‘æ¡†
            bubbleEl.innerHTML = '';
            bubbleEl.appendChild(wrapper);
            textarea.focus();
        }

              async function saveBubbleEdit(globalIndex, newText) {
            // ğŸŸ¢ æ”¹åŠ¨ï¼šä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®
            const container = document.getElementById('chatContainer');
            const currentScroll = container.scrollTop;

            // 1. æ›´æ–°å†…å­˜æ•°æ®
            const msg = readerState.data[globalIndex];
            if(msg.mes !== undefined) msg.mes = newText;
            if(msg.content !== undefined) msg.content = newText;
            if(msg.text !== undefined) msg.text = newText;
            if(msg.message !== undefined) msg.message = newText;

            // 2. æŒä¹…åŒ–ä¿å­˜åˆ°æ•°æ®åº“
            await saveReaderDataToDB();

            // 3. é‡æ–°æ¸²æŸ“
            renderCurrentPage();

            // ğŸŸ¢ æ”¹åŠ¨ï¼šæ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿è§†å›¾ä¸ä¹±è·³
            container.scrollTop = currentScroll;

            auth.toast('ä¿®æ”¹å·²ä¿å­˜ âœ¨');
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šä¹¦ç­¾ç³»ç»Ÿ ---
        async function handleBookmarkClick(globalIndex, iconEl) {
            const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
            
            if (isBookmarked) {
                // å·²æœ‰ä¹¦ç­¾ï¼šè¯¢é—®æ˜¯ä¿®æ”¹è¿˜æ˜¯åˆ é™¤
                const oldNote = readerState.bookmarks[globalIndex];
                const newNote = prompt("âœï¸ ä¿®æ”¹å¤‡æ³¨ (æ¸…ç©ºå†…å®¹åˆ™åˆ é™¤ä¹¦ç­¾):", oldNote);
                
                if (newNote === null) return; // å–æ¶ˆ
                
                if (newNote.trim() === "") {
                    delete readerState.bookmarks[globalIndex];
                    auth.toast('ä¹¦ç­¾å·²åˆ é™¤ ğŸ—‘ï¸');
                } else {
                    readerState.bookmarks[globalIndex] = newNote;
                    auth.toast('å¤‡æ³¨å·²æ›´æ–° ğŸ“');
                }
            } else {
                // æ–°ä¹¦ç­¾
                const note = prompt("âœ¨ è¯·è¾“å…¥ä¹¦ç­¾å¤‡æ³¨:", "è¿™é‡Œå¾ˆæœ‰è¶£...");
                if (note === null) return;
                
                readerState.bookmarks[globalIndex] = note || "æ— å¤‡æ³¨";
                auth.toast('ä¹¦ç­¾æ·»åŠ æˆåŠŸ â­');
            }

            // ä¿å­˜å¹¶åˆ·æ–°UI
            await saveReaderDataToDB();
            renderCurrentPage();
            // å¦‚æœä¹¦ç­¾åˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
            if(document.getElementById('bookmarkDrawer').classList.contains('active')){
                renderBookmarkList();
            }
        }

        function toggleBookmarkDrawer() {
            const drawer = document.getElementById('bookmarkDrawer');
            drawer.classList.toggle('active');
            if (drawer.classList.contains('active')) {
                renderBookmarkList();
            }
        }

        function renderBookmarkList() {
            const listEl = document.getElementById('bookmarkList');
            listEl.innerHTML = '';

            const indices = Object.keys(readerState.bookmarks).map(Number).sort((a,b) => a-b);

            if (indices.length === 0) {
                listEl.innerHTML = '<div class="bm-empty">è¿˜æ²¡æœ‰åŠ è¿‡ä¹¦ç­¾å“¦~<br>ç‚¹å‡»æ¥¼å±‚å·æ—è¾¹çš„ â˜… è¯•è¯•</div>';
                return;
            }

            indices.forEach(idx => {
                const note = readerState.bookmarks[idx];
                const item = document.createElement('div');
                item.className = 'bookmark-item';
                item.onclick = () => jumpToFloor(idx);
                
                item.innerHTML = `
                    <div class="bm-floor">#${idx + 1} æ¥¼</div>
                    <div class="bm-note">${note}</div>
                `;
                listEl.appendChild(item);
            });
        }

        function jumpToFloor(globalIndex) {
            // 1. è®¡ç®—ç›®æ ‡é¡µç 
            const targetPage = Math.floor(globalIndex / readerState.pageSize) + 1;
            
            // 2. è·³è½¬é¡µé¢
            readerState.currentPage = targetPage;
            renderCurrentPage();

            // 3. å…³é—­æŠ½å±‰
            document.getElementById('bookmarkDrawer').classList.remove('active');

            // 4. æ»šåŠ¨åˆ°æŒ‡å®šæ¥¼å±‚å¹¶é«˜äº®
            setTimeout(() => {
                const row = document.getElementById(`floor-${globalIndex}`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 2000);
                }
            }, 100); // ç¨å¾®å»¶è¿Ÿç­‰å¾…æ¸²æŸ“
        }

        // --- ğŸ’¾ æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
        async function saveReaderDataToDB() {
            if (viewingIndex === -1 || readerState.resourceIndex === -1) return;

            const item = items[viewingIndex];
            const res = item.resources[readerState.resourceIndex];

            // 1. ä¿å­˜å†…å®¹ (å°†å¯¹è±¡æ•°ç»„è½¬å› JSON å­—ç¬¦ä¸²)
            res.content = JSON.stringify(readerState.data);

            // 2. ä¿å­˜ä¹¦ç­¾
            res.bookmarks = readerState.bookmarks;

            // 3. å†™å…¥æ•°æ®åº“
            await saveItemToDB(item);
        }

               function prevPage() {
            if (readerState.currentPage > 1) {
                readerState.currentPage--;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯ç¬¬ä¸€é¡µå•¦');
            }
        }

        function nextPage() {
            if (readerState.currentPage < readerState.totalPages) {
                readerState.currentPage++;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯æœ€åä¸€é¡µå•¦');
            }
        }

        // ================= ğŸ¨ CSS ä¸»é¢˜ç³»ç»Ÿ =================
        
        let savedThemes = JSON.parse(localStorage.getItem('my_reader_themes') || '[]');

        // 1. æ‰“å¼€/å…³é—­é¢æ¿
        function toggleCssDrawer() {
            const drawer = document.getElementById('cssDrawer');
            drawer.classList.toggle('active');
            if(drawer.classList.contains('active')) {
                renderThemeSelect();
            }
        }

        // 2. é¢„è§ˆ/åº”ç”¨ CSS
        function previewCss() {
            const css = document.getElementById('cssInput').value;
            // æŠŠ CSS æ³¨å…¥åˆ°ç¬¬ä¸€æ­¥åŠ çš„ style æ ‡ç­¾é‡Œ
            document.getElementById('custom-reader-style').textContent = css;
            auth.toast('çš®è‚¤å·²åº”ç”¨ âœ¨');
        }

        // 3. ä¿å­˜ä¸»é¢˜
        function saveCustomTheme() {
            const name = document.getElementById('themeNameInput').value.trim();
            const css = document.getElementById('cssInput').value;
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!css) { auth.toast('è¿˜æ²¡å†™ä»£ç å‘¢ï¼'); return; }

            // æ£€æŸ¥é‡åï¼Œå¦‚æœæœ‰é‡åå°±è¦†ç›–
            const existingIdx = savedThemes.findIndex(t => t.name === name);
            if(existingIdx >= 0) {
                if(!confirm(`ä¸»é¢˜ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
                savedThemes[existingIdx].css = css;
            } else {
                savedThemes.push({ name: name, css: css });
            }

            localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
            renderThemeSelect();
            // è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„
            document.getElementById('themeSelect').value = name;
            auth.toast('ä¸»é¢˜ä¿å­˜æˆåŠŸ ğŸ’¾');
        }

        // 4. åŠ è½½é€‰ä¸­çš„ä¸»é¢˜
        function loadSelectedTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) return;
            
            const theme = savedThemes.find(t => t.name === name);
            if(theme) {
                document.getElementById('cssInput').value = theme.css;
                document.getElementById('themeNameInput').value = theme.name;
                previewCss(); // è‡ªåŠ¨åº”ç”¨
            }
        }

        // 5. åˆ é™¤ä¸»é¢˜
        function deleteCustomTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) { auth.toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸»é¢˜'); return; }
            
            if(confirm(`ç¡®å®šåˆ é™¤ä¸»é¢˜ "${name}" å—ï¼Ÿ`)) {
                savedThemes = savedThemes.filter(t => t.name !== name);
                localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
                
                document.getElementById('cssInput').value = '';
                document.getElementById('themeNameInput').value = '';
                document.getElementById('custom-reader-style').textContent = ''; // æ¸…ç©ºæ•ˆæœ
                
                renderThemeSelect();
                auth.toast('å·²åˆ é™¤ ğŸ—‘ï¸');
            }
        }

        // 6. æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
        function renderThemeSelect() {
            const sel = document.getElementById('themeSelect');
            // ä¿ç•™ç¬¬ä¸€é¡¹æç¤º
            sel.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>';
            savedThemes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }
        
        // ğŸŸ¢ åˆå§‹åŒ–ï¼šå¦‚æœä¹‹å‰æœ‰æœ€åä¸€æ¬¡ä½¿ç”¨çš„ä¸»é¢˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨åŠ è½½ï¼ˆå¯é€‰ï¼‰
        // window.addEventListener('load', () => { ... })

        // ================= ğŸ’­ é£˜å­—åŠ¨ç”»é€»è¾‘ =================
        let memoryInterval = null;

        function startMemoryAnimation(list) {
            const container = document.getElementById('memoryLayer');
            container.innerHTML = ''; // å…ˆæ¸…ç©º
            
            // å¦‚æœæ²¡æœ‰è¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©ºï¼Œå°±ä¸æ”¾äº†
            if (!list || list.length === 0) return;

            // ç«‹å³ç”Ÿæˆå‡ ä¸ªï¼Œé¿å…æ‰“å¼€æ—¶ç©ºè¡è¡
            for(let i=0; i<3; i++) spawnMemory(list, container);

            // æ¯éš” 1.5ç§’ ç”Ÿæˆä¸€ä¸ªæ–°çš„
            memoryInterval = setInterval(() => {
                spawnMemory(list, container);
            }, 1500);
        }

        function stopMemoryAnimation() {
            if (memoryInterval) {
                clearInterval(memoryInterval);
                memoryInterval = null;
            }
            document.getElementById('memoryLayer').innerHTML = '';
        }

        function spawnMemory(list, container) {
            const text = list[Math.floor(Math.random() * list.length)]; // éšæœºæŒ‘ä¸€å¥
            const el = document.createElement('div');
            el.className = 'memory-text';
            el.textContent = text;
            
            // éšæœºä½ç½®å’Œå¤§å°ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
            const randomLeft = Math.random() * 80 + 10; // 10% åˆ° 90% ä¹‹é—´
            const randomDuration = Math.random() * 5 + 8; // 8åˆ°13ç§’é£˜å®Œ
            const randomSize = Math.random() * 8 + 16; // 16px åˆ° 24px å¤§å°
            
            el.style.left = randomLeft + '%';
            el.style.animationDuration = randomDuration + 's';
            el.style.fontSize = randomSize + 'px';
            
            container.appendChild(el);

            // åŠ¨ç”»ç»“æŸååˆ é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
            }, randomDuration * 1000);
        }

 // ================= ğŸº é…’é¦†ä¼ é€é—¨é€»è¾‘ (æé€Ÿç‰ˆ) =================
        
        // ğŸš€ å¯åŠ¨é€»è¾‘ (æ— å»¶è¿Ÿï¼Œæµè§ˆå™¨ä¸ä¼šæ‹¦æˆª)
        function jumpToTavern() {
            let url = localStorage.getItem('my_tavern_simple_url');
            
            // ç¬¬ä¸€æ¬¡ç”¨ï¼Œè¿˜æ²¡å­˜è¿‡é“¾æ¥
            if (!url) {
                // å¦‚æœæ²¡é“¾æ¥ï¼Œç›´æ¥è°ƒç”¨ä¿®æ”¹å‡½æ•°
                changeTavernLink(true); 
            } else {
                // æœ‰é“¾æ¥ï¼Œç›´æ¥é£
                window.open(url, '_blank');
            }
        }

        // âœï¸ ä¿®æ”¹é€»è¾‘
        function changeTavernLink(isFirstTime = false) {
            const oldUrl = localStorage.getItem('my_tavern_simple_url') || 'http://127.0.0.1:8000';
            const msg = isFirstTime ? "ğŸº ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œè¯·è¾“å…¥é…’é¦†é“¾æ¥ï¼š" : "ğŸ”§ ä¿®æ”¹é…’é¦†åæ ‡ï¼š";
            
            let newUrl = prompt(msg + "\n(ä¾‹å¦‚ http://127.0.0.1:8000 )", oldUrl);
            
            if (newUrl) {
                // è´´å¿ƒåœ°å¸®ç”¨æˆ·åŠ ä¸Š http (é˜²æ­¢ç”¨æˆ·åªå†™ IP)
                if (!newUrl.startsWith('http')) {
                    newUrl = 'http://' + newUrl;
                }
                // å»æ‰æœ«å°¾çš„æ–œæ  / (é˜²æ­¢æ‹¼æ¥å‡ºé”™)
                if (newUrl.endsWith('/')) {
                    newUrl = newUrl.slice(0, -1);
                }
                
                localStorage.setItem('my_tavern_simple_url', newUrl);
                auth.toast('é…’é¦†åæ ‡å·²é”å®š ğŸ“');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®ï¼Œè®¾ç½®å®Œç›´æ¥è·³
                if(isFirstTime) {
                    window.open(newUrl, '_blank');
                }
            }
        }

        // ================= ğŸ’® å°ç« ç³»ç»Ÿé€»è¾‘ =================

        // åˆ‡æ¢å°ç« ï¼ˆç‚¹å‡»å°å›¾æ ‡æ—¶è§¦å‘ï¼‰
        async function toggleStamp(char) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // å¦‚æœå½“å‰å·²ç»æ˜¯è¿™ä¸ªå°ç« ï¼Œå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆ
            if (item.stamp === char) {
                item.stamp = null; // å–æ¶ˆ
                auth.toast('å°ç« å·²æ’¤é”€ ğŸ’¨');
            } else {
                item.stamp = char; // ç›–ç« 
                auth.toast('ç›–ç« æˆåŠŸï¼å•ªï¼ğŸ’®');
            }

            // ä¿å­˜æ•°æ®
            await saveItemToDB(item);
            
            // åˆ·æ–°ç•Œé¢
            renderStampStatus(item.stamp);
            loadFromDB(); // åˆ·æ–°åˆ—è¡¨æ•°æ®
        }

        // æ¸²æŸ“å°ç« ï¼ˆæ§åˆ¶å¤§å°ç« å’Œå°å›¾æ ‡çš„æ˜¾ç¤ºï¼‰
        function renderStampStatus(currentStamp) {
            const bigStamp = document.getElementById('bigStamp');
            const btns = document.querySelectorAll('.stamp-btn');

            // 1. é‡ç½®æ‰€æœ‰å°å›¾æ ‡
            btns.forEach(btn => {
                btn.classList.remove('active');
                // å¦‚æœæ˜¯å½“å‰å°ç« ï¼Œç‚¹äº®å®ƒ
                if (btn.innerText === currentStamp) {
                    btn.classList.add('active');
                }
            });

            // 2. å¤„ç†å¤§å°ç« åŠ¨ç”»
            if (currentStamp) {
                bigStamp.innerText = currentStamp;
                // å…ˆç§»é™¤ï¼Œå¼ºåˆ¶é‡ç»˜ï¼Œå†æ·»åŠ ï¼Œä¸ºäº†æ¯æ¬¡éƒ½æœ‰â€œå•ªâ€çš„åŠ¨ç”»æ•ˆæœ
                bigStamp.classList.remove('stamped');
                void bigStamp.offsetWidth; // å¼ºåˆ¶é‡ç»˜é­”æ³•
                bigStamp.classList.add('stamped');
            } else {
                bigStamp.classList.remove('stamped');
            }
        }

        // ================= ğŸ™ˆ é˜²çª¥æ¨¡å¼é€»è¾‘ =================
        
        function togglePrivacyMode() {
            const body = document.body;
            const btn = document.getElementById('privacyBtn');
            
            // åˆ‡æ¢ class
            body.classList.toggle('privacy-active');
            
            // åˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œæ”¹å˜å›¾æ ‡å’Œæç¤º
            if (body.classList.contains('privacy-active')) {
                btn.textContent = 'ğŸ™ˆ'; // å˜æˆæ‚çœ¼ç›çš„çŒ´å­
                btn.style.backgroundColor = '#ffe6eb'; // æŒ‰é’®å˜ç²‰æç¤ºç”Ÿæ•ˆä¸­
                auth.toast('é˜²çª¥æ¨¡å¼å·²å¼€å¯ ğŸ”’');
            } else {
                btn.textContent = 'ğŸ‘ï¸'; // å˜æˆçå¼€çš„çœ¼ç›
                btn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // æ¢å¤åŸæ ·
                auth.toast('å·²æ¢å¤æ¸…æ™° âœ¨');
            }
        }

        // ================= âœ¨ æŒ‡å°–é­”æ³•é€»è¾‘ =================
        window.addEventListener('click', function(e) {
            // éšæœºç‰¹æ•ˆæ± 
            const particles = ['ğŸŒ¸', 'âœ¨', 'ğŸ’—', 'â­', 'ğŸ¾', 'ğŸµ'];
            const p = document.createElement('div');
            p.className = 'magic-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            
            // è®¾ç½®ä½ç½®
            p.style.left = e.clientX + 'px';
            p.style.top = e.clientY + 'px';
            
            // ç¨å¾®éšæœºä¸€ç‚¹è§’åº¦å’Œå¤§å°
            const randomRot = Math.random() * 40 - 20; // -20åº¦åˆ°20åº¦
            p.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg)`;
            
            document.body.appendChild(p);
            
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => p.remove(), 1000);
        });

        // ================= ğŸ“Š 1. ç¾ç»Šåˆ†ææŠ¥å‘Šé€»è¾‘ =================
        function analyzeBond() {
            if (!readerState.data || readerState.data.length === 0) {
                auth.toast('æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•åˆ†æå“¦ ğŸ“„');
                return;
            }

            const msgs = readerState.data;
            let userWords = 0;
            let charWords = 0;
            let firstTime = null;
            let lastTime = null;

            // éå†ç»Ÿè®¡
            msgs.forEach(m => {
                // 1. å°è¯•æå–æ—¶é—´ (å…¼å®¹ sillytavern/é…’é¦†å¸¸ç”¨å­—æ®µ create_date/date)
                const tStr = m.create_date || m.date || m.send_date;
                if(tStr) {
                    const t = new Date(tStr).getTime();
                    if(!isNaN(t)) {
                        if(!firstTime || t < firstTime) firstTime = t;
                        if(!lastTime || t > lastTime) lastTime = t;
                    }
                }

                // 2. ç»Ÿè®¡å­—æ•°
                const content = m.mes || m.content || m.text || "";
                const len = content.length;
                
                // åˆ¤æ–­æ˜¯è°å‘çš„ (å¤ç”¨ reader çš„é€»è¾‘)
                const name = m.name || '???';
                let isUser = false;
                if (m.hasOwnProperty('is_user')) isUser = m.is_user;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isUser = true;

                if(isUser) userWords += len;
                else charWords += len;
            });

            // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºä»Šå¤©
            const now = new Date();
            if(!firstTime) firstTime = now.getTime();
            if(!lastTime) lastTime = now.getTime();

            // è®¡ç®—å¤©æ•°
            const diffTime = Math.abs(lastTime - firstTime);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // æ¸²æŸ“æ•°æ®
            document.getElementById('reportTotalFloors').textContent = msgs.length;
            document.getElementById('reportTotalWords').textContent = (userWords + charWords).toLocaleString();
            document.getElementById('reportDays').textContent = diffDays;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const fmt = (ts) => new Date(ts).toISOString().slice(0,10);
            document.getElementById('reportDateStart').textContent = fmt(firstTime);
            document.getElementById('reportDateEnd').textContent = fmt(lastTime);

            // æ¸²æŸ“æ¯”ä¾‹æ¡
            const total = userWords + charWords;
            let userPct = 50;
            if(total > 0) userPct = Math.round((userWords / total) * 100);
            
            document.getElementById('ratioUser').style.width = userPct + '%';
            document.getElementById('ratioUser').textContent = `æˆ‘ ${userPct}%`;
            document.getElementById('textCountUser').textContent = `æˆ‘: ${userWords}`;

            document.getElementById('ratioChar').style.width = (100 - userPct) + '%';
            document.getElementById('ratioChar').textContent = `TA ${100 - userPct}%`;
            document.getElementById('textCountChar').textContent = `TA: ${charWords}`;

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('reportModal').classList.add('active');
        }

        // ================= ğŸ² 2. çµæ„Ÿæ‰­è›‹æœº Pro é€»è¾‘ =================
        
        // ğŸ’¾ é»˜è®¤è¶…çº§é¢˜åº“ (å¦‚ä½ æ‰€æ„¿ï¼ŒåŠ äº†äº¿ç‚¹ç‚¹æ¢—)
        const DEFAULT_GACHA_DB = {
            places: [
                "åºŸå¼ƒçš„æ—§æ ¡èˆ", "æš´é›¨ä¸­çš„ç”µè¯äº­", "å¼‚ä¸–ç•Œçš„é­”ç‹åŸç‹åº§", "æ·±å¤œçš„24å°æ—¶ä¾¿åˆ©åº—", 
                "ç‹­çª„çš„ç”µæ¢¯é‡Œ", "è±ªåæ¸¸è½®çš„ç”²æ¿", "æœ«æ—¥åçš„åºŸå¢Ÿé¿éš¾æ‰€", "å……æ»¡æ¶ˆæ¯’æ°´å‘³çš„åŒ»åŠ¡å®¤",
                "å–§é—¹çš„é…’å§è§’è½", "åªæœ‰æˆ‘ä»¬ä¸¤ä¸ªäººçš„æµ·è¾¹", "æ»¡æ˜¯ç°å°˜çš„é˜æ¥¼", "æ­£åœ¨å´©å¡Œçš„åœ°ä¸‹åŸ",
                "å…¨æ¯æŠ•å½±çš„èµ›åšè¡—é“", "å¤è€çš„å›¾ä¹¦é¦†ç¦ä¹¦åŒº", "æ¸©æ³‰æ—…é¦†çš„ç§äººæ±¤æ± ", "æ‹¥æŒ¤çš„æ—©é«˜å³°åœ°é“"
            ],
            events: [
                "èº«ä½“äº’æ¢äº†", "å…¶ä¸­ä¸€æ–¹å¤±å¿†äº†", "å¿…é¡»è¦å‡è£…æˆæƒ…ä¾£", "è¢«ä¸€å‰¯ç¥ç§˜æ‰‹é“æ‹·åœ¨ä¸€èµ·",
                "å¦‚æœä¸è¯´å®è¯å°±ä¼šæ­»", "ä¸­äº†'å˜å¾—å¦ç‡'çš„é­”æ³•", "æ­£åœ¨èº²é¿ä»‡å®¶çš„è¿½æ€", "å‘ç°å¯¹æ–¹å…¶å®æ˜¯æ•Œå¯¹é˜µè¥",
                "åªæœ‰ä¸€æ–¹èƒ½çœ‹è§é¬¼é­‚", "è¢«å›°åœ¨æ—¶é—´å¾ªç¯é‡Œ", "ä¸€æ–¹å˜æˆäº†çŒ«/ç‹—", "æ¡åˆ°äº†å¯¹æ–¹çš„ç§å¯†æ—¥è®°",
                "é†‰é…’åçš„ä¸€å¤œè’å”", "å¿…é¡»è¦å®ŒæˆçœŸå¿ƒè¯å¤§å†’é™©", "ç…§é¡¾ç”Ÿç—…çš„å¦ä¸€æ–¹", "äº’ç›¸ç»™å¯¹æ–¹æ¶‚é˜²æ™’éœœ/ä¸Šè¯"
            ],
            tropes: [
                "ä¿®ç½—åœº/å«‰å¦’", "ç ´é•œé‡åœ†", "åŒå‘æš—æ‹", "ç›¸çˆ±ç›¸æ€", "å…ˆå©šåçˆ±", "æ•‘èµ/æ²»æ„ˆ",
                "ç—…å¨‡/ç›‘ç¦", "å¹´ä¸‹/æ’’å¨‡", "ä¸»ä»†/æ”¯é…", "åå·®èŒ", "åŠæ¡¥æ•ˆåº”", "è¯¯ä¼šæ¢—",
                "ABOè®¾å®š(å‘æƒ…æœŸ)", "é’æ¢…ç«¹é©¬", "å®¿æ•Œå˜æƒ…äºº", "å¥‘çº¦å…³ç³»"
            ]
        };

        let gachaData = { ...DEFAULT_GACHA_DB };

        // åˆå§‹åŒ–ï¼šåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
        function initGacha() {
            const saved = localStorage.getItem('my_gacha_db');
            if(saved) {
                try {
                    gachaData = JSON.parse(saved);
                } catch(e) { console.error('é¢˜åº“åŠ è½½å¤±è´¥', e); }
            }
        }
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initGacha();

        function openGachaModal() {
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('gachaModal').classList.add('active');
        }
        function closeGachaModal() {
            document.getElementById('gachaModal').classList.remove('active');
            document.getElementById('gachaEditArea').style.display = 'none';
        }

        function spinGacha() {
            const resultArea = document.getElementById('gachaResultArea');
            resultArea.innerHTML = '<div style="font-size:30px;">ğŸ°</div>'; // ç®€å•çš„è½¬åŠ¨åŠ¨ç”»å ä½
            
            setTimeout(() => {
                const p = randArr(gachaData.places);
                const e = randArr(gachaData.events);
                const t = randArr(gachaData.tropes);

                resultArea.innerHTML = `
                    <div class="gacha-tag tag-place">ğŸ“ ${p}</div>
                    <div class="gacha-tag tag-event">ğŸ“… ${e}</div>
                    <div class="gacha-tag tag-trope">âœ¨ ${t}</div>
                    <div style="font-size:12px; color:#aaa; margin-top:10px;">
                        ğŸ’¡ è„‘æ´ï¼šåœ¨ <b>${p}</b>ï¼Œå‘ç”Ÿäº† <b>${e}</b>ï¼Œæ°›å›´æ˜¯ <b>${t}</b>
                    </div>
                `;
            }, 300);
        }

        function randArr(arr) {
            if(!arr || arr.length === 0) return "???";
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function toggleGachaEdit() {
            const area = document.getElementById('gachaEditArea');
            if(area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                // å¡«å……å½“å‰æ•°æ®
                document.getElementById('editPlace').value = gachaData.places.join('ï¼Œ');
                document.getElementById('editEvent').value = gachaData.events.join('ï¼Œ');
                document.getElementById('editTrope').value = gachaData.tropes.join('ï¼Œ');
            } else {
                area.style.display = 'none';
            }
        }

        function saveGachaData() {
            // è¾…åŠ©å‡½æ•°ï¼šæŠŠå­—ç¬¦ä¸²è½¬æ•°ç»„
            const parse = (id) => document.getElementById(id).value.split(/[,ï¼Œ\n]/).map(s=>s.trim()).filter(s=>s);
            
            gachaData.places = parse('editPlace');
            gachaData.events = parse('editEvent');
            gachaData.tropes = parse('editTrope');

            localStorage.setItem('my_gacha_db', JSON.stringify(gachaData));
            auth.toast('é¢˜åº“ä¿å­˜æˆåŠŸï¼ğŸ“š');
            toggleGachaEdit();
        }

        function resetGachaData() {
            if(confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é¢˜åº“å—ï¼Ÿä½ è‡ªå·±åŠ çš„æ¢—ä¼šæ¶ˆå¤±å“¦ï¼')) {
                gachaData = JSON.parse(JSON.stringify(DEFAULT_GACHA_DB)); // æ·±æ‹·è´æ¢å¤
                localStorage.removeItem('my_gacha_db');
                auth.toast('å·²æ¢å¤é»˜è®¤è®¾ç½® ğŸ”„');
                toggleGachaEdit();
            }
        }

        // ================= ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤é€»è¾‘ =================

        // 1. æ¸²æŸ“ä¸»é¡µçš„â€œå¤§é™ˆåˆ—å®¤â€
        function renderShelfView() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            const shelf = document.createElement('div');
            shelf.className = 'shelf-container';

            let totalSov = 0;

            // éå†æ‰€æœ‰è§’è‰²ï¼ŒæŠŠä»–ä»¬çš„çºªå¿µå“éƒ½æ‹¿å‡ºæ¥
            items.forEach((item, itemIdx) => {
                if(item.souvenirs && item.souvenirs.length > 0) {
                    item.souvenirs.forEach((sov, sovIdx) => {
                        totalSov++;
                        const card = document.createElement('div');
                        card.className = 'souvenir-card';
                        // ç»™ä¸ªéšæœºæ—‹è½¬è§’åº¦ (-5åº¦ åˆ° 5åº¦)ï¼Œæ¨¡æ‹Ÿéšæ„æ‘†æ”¾çš„æ„Ÿè§‰
                        card.style.setProperty('--rot', (Math.random() * 10 - 5) + 'deg');
                        
                        card.innerHTML = `
                            <img src="${sov.img}" class="souvenir-img">
                            <div class="souvenir-title">${sov.name}</div>
                        `;
                        // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                        card.onclick = () => openViewSouvenir(itemIdx, sovIdx);
                        shelf.appendChild(card);
                    });
                }
            });

            if(totalSov === 0) {
                container.innerHTML = '<div class="empty-state">é™ˆåˆ—å®¤ç©ºç©ºçš„...<br>å»è§’è‰²è¯¦æƒ…é¡µé‡Œæ·»åŠ çºªå¿µå“å§ï¼ğŸ’</div>';
            } else {
                container.appendChild(shelf);
                auth.toast(`æ¬¢è¿æ¥åˆ°é™ˆåˆ—å®¤ï¼Œå…±æ”¶è—äº† ${totalSov} ä»¶å®ç‰© âœ¨`);
            }
        }

        // 2. æ¸²æŸ“è§’è‰²è¯¦æƒ…é¡µé‡Œçš„â€œå°é™ˆåˆ—æ â€
        // âš ï¸ é‡è¦ï¼šè¯·æ‰¾åˆ° openDetailModal å‡½æ•°ï¼Œåœ¨å®ƒæœ€ååŠ ä¸Š renderDetailSouvenirs(index);
        function renderDetailSouvenirs(itemIndex) {
            const list = document.getElementById('souvenirListArea');
            list.innerHTML = '';
            
            const item = items[itemIndex];
            const sovs = item.souvenirs || []; // å¦‚æœæ²¡æœ‰å°±æ˜¯ç©ºæ•°ç»„

            if(sovs.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#ccc; padding:10px; width:100%; text-align:center;">æš‚æ— ä¿¡ç‰©</div>';
                return;
            }

            sovs.forEach((sov, idx) => {
                const el = document.createElement('div');
                el.className = 'souvenir-mini-item';
                el.innerHTML = `
                    <img src="${sov.img}" class="souvenir-mini-img">
                    <div style="font-size:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${sov.name}</div>
                `;
                el.onclick = () => openViewSouvenir(itemIndex, idx);
                list.appendChild(el);
            });
        }

        // 3. æ·»åŠ çºªå¿µå“ç›¸å…³é€»è¾‘
        let tempSovImg = null;

        function openAddSouvenirModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('souvenirName').value = '';
            document.getElementById('souvenirDesc').value = '';
            document.getElementById('souvenirImgInput').value = '';
            document.getElementById('souvenirPreview').style.display = 'none';
            document.getElementById('souvenirUploadHint').style.display = 'block';
            tempSovImg = null;
            
            document.getElementById('addSouvenirModal').classList.add('active');
        }

        async function previewSouvenirImg(input) {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                tempSovImg = await readFile(file); // å¤ç”¨ä¹‹å‰çš„ readFile å‡½æ•°
                const img = document.getElementById('souvenirPreview');
                img.src = tempSovImg;
                img.style.display = 'block';
                document.getElementById('souvenirUploadHint').style.display = 'none';
            }
        }

        async function saveSouvenir() {
            const name = document.getElementById('souvenirName').value.trim();
            const desc = document.getElementById('souvenirDesc').value.trim();
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!tempSovImg) { auth.toast('è¯·ä¸Šä¼ ä¸€å¼ ç…§ç‰‡'); return; }
            
            // è·å–å½“å‰è§’è‰²
            if(viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if(!item.souvenirs) item.souvenirs = [];
            
            item.souvenirs.push({
                name: name,
                img: tempSovImg,
                desc: desc || "ï¼ˆæ²¡æœ‰ç•™ä¸‹æè¿°...ï¼‰",
                date: new Date().toISOString()
            });
            
            await saveItemToDB(item);
            
            document.getElementById('addSouvenirModal').classList.remove('active');
            renderDetailSouvenirs(viewingIndex);
            auth.toast('çºªå¿µå“å·²å…¥åº“ ğŸ’');
        }

        // 4. æŸ¥çœ‹/åˆ é™¤çºªå¿µå“
        let currentSovData = { itemIdx: -1, sovIdx: -1 };

        function openViewSouvenir(itemIdx, sovIdx) {
            const item = items[itemIdx];
            const sov = item.souvenirs[sovIdx];
            
            currentSovData = { itemIdx, sovIdx };
            
            document.getElementById('viewSovTitle').textContent = sov.name;
            document.getElementById('viewSovImg').src = sov.img;
            document.getElementById('viewSovDesc').textContent = sov.desc;
            document.getElementById('viewSovOwner').textContent = item.name;
            
            document.getElementById('viewSouvenirModal').classList.add('active');
        }

        async function deleteCurrentSouvenir() {
            if(!confirm('ç¡®å®šè¦ä¸¢å¼ƒè¿™ä»¶çºªå¿µå“å—ï¼Ÿå›å¿†ä¹Ÿä¼šæ¶ˆå¤±å“¦...')) return;
            
            const { itemIdx, sovIdx } = currentSovData;
            const item = items[itemIdx];
            
            item.souvenirs.splice(sovIdx, 1);
            await saveItemToDB(item);
            
            document.getElementById('viewSouvenirModal').classList.remove('active');
            
            // å¦‚æœæ˜¯åœ¨ä¸»é¡µé™ˆåˆ—å®¤æ¨¡å¼ä¸‹åˆ çš„ï¼Œåˆ·æ–°ä¸»é¡µ
            const isShelfMode = document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.contains('active');
            if(isShelfMode) renderShelfView();
            
            // å¦‚æœæ˜¯åœ¨è¯¦æƒ…é¡µåˆ çš„ï¼Œåˆ·æ–°è¯¦æƒ…é¡µ
            if(document.getElementById('detailModal').classList.contains('active')) {
                renderDetailSouvenirs(itemIdx);
            }
            
            auth.toast('çºªå¿µå“å·²ä¸¢å¼ƒ ğŸ—‘ï¸');
        }

                   // ================= ğŸŒ¸ æœ€ç»ˆç‰ˆï¼šæ¢¦å¢ƒé€»è¾‘ =================
        let dreamTimer = null;
        let bgPetalTimer = null;

        function startDreamMode() {
            // 1. æ”¶é›†å›å¿†ç¢ç‰‡
            const fragments = [];
            items.forEach(item => {
                // å›¾
                item.resources.filter(r => r.type === 'image').forEach(img => {
                    fragments.push({ type: 'img', content: img.content, name: item.name });
                });
                // è¯
                if(item.memories && item.memories.length > 0) {
                    item.memories.forEach(mem => {
                        fragments.push({ type: 'text', content: mem, name: item.name });
                    });
                }
            });

            if(fragments.length === 0) {
                auth.toast('å›å¿†å¤ªå°‘äº†ï¼Œæ¢¦å¢ƒæ— æ³•ç”Ÿæˆ... ğŸŒ¸');
                return;
            }

            // 2. å‡†å¤‡å›¾å±‚
            const layer = document.getElementById('dreamLayer');
            layer.innerHTML = '<div class="dream-close-btn" onclick="stopDreamMode()">ğŸŒ¸ é†’æ¥</div>'; 
            layer.classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');

            // 3. å¯åŠ¨èƒŒæ™¯èŠ±ç“£é›¨ (çº¯è£…é¥°)
            startBgPetals();

            // 4. å¯åŠ¨å›å¿†æ‰è½ (æ­£æ–¹å½¢å’Œæ°”æ³¡)
            spawnDreamItem(fragments); 
            dreamTimer = setInterval(() => {
                spawnDreamItem(fragments);
            }, 1500); // æ¯1.5ç§’æ‰è½ä¸€ä¸ªå›å¿†
        }

        function stopDreamMode() {
            document.getElementById('dreamLayer').classList.remove('active');
            clearInterval(dreamTimer);
            clearInterval(bgPetalTimer);
        }

        // ç”ŸæˆèƒŒæ™¯è£…é¥°èŠ±ç“£
        function startBgPetals() {
            const layer = document.getElementById('dreamLayer');
            // å…ˆç”Ÿæˆ20ä¸ª
            for(let i=0; i<20; i++) createBgPetal(layer);
            // æŒç»­ç”Ÿæˆ
            bgPetalTimer = setInterval(() => createBgPetal(layer), 800);
        }

        function createBgPetal(layer) {
            const p = document.createElement('div');
            p.className = 'dream-bg-petal';
            const size = Math.random() * 10 + 10; // 10-20px å°èŠ±ç“£
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = (Math.random() * 5 + 5) + 's'; // 5-10s ä¸‹è½
            layer.appendChild(p);
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => { if(p.parentNode) p.remove(); }, 10000);
        }

        // ç”Ÿæˆå›å¿†ä¸»ä½“ (æ­£æ–¹å½¢ / æ°”æ³¡)
        function spawnDreamItem(fragments) {
            const layer = document.getElementById('dreamLayer');
            const frag = fragments[Math.floor(Math.random() * fragments.length)];
            
            const item = document.createElement('div');
            item.className = 'dream-content-item';
            
            // éšæœºæ°´å¹³ä½ç½® (é¿å…å¤ªé è¾¹)
            const left = Math.random() * 80 + 10; 
            item.style.left = left + '%';
            
            // éšæœºä¸‹è½é€Ÿåº¦
            const duration = Math.random() * 5 + 10; // 10-15s æ…¢æ…¢é£˜
            item.style.animationDuration = duration + 's';

            if(frag.type === 'img') {
                // === æ­£æ–¹å½¢å›¾ç‰‡ ===
                const box = document.createElement('div');
                box.className = 'dream-item-img';
                
                const img = document.createElement('img');
                img.src = frag.content;
                
                const nameLabel = document.createElement('div');
                nameLabel.className = 'dream-img-name';
                nameLabel.innerText = frag.name;

                box.appendChild(img);
                box.appendChild(nameLabel);
                item.appendChild(box);
            } else {
                // === æ–‡å­—æ°”æ³¡ ===
                const bubble = document.createElement('div');
                bubble.className = 'dream-item-text';
                bubble.innerText = frag.content.length > 30 ? frag.content.substring(0, 28) + '...' : frag.content;
                item.appendChild(bubble);
            }

            // ç‚¹å‡»äº‹ä»¶
            item.onclick = () => {
                auth.toast(`âœ¨ æ•è·äº†å…³äºã€${frag.name}ã€‘çš„å›å¿†`);
                item.style.transform = 'scale(1.2)';
                item.style.opacity = 0;
                item.style.transition = 'all 0.3s';
                setTimeout(() => item.remove(), 300);
            };

            layer.appendChild(item);

            setTimeout(() => { if(item.parentNode) item.remove(); }, duration * 1000);
        }


        // ================= ğŸ“– G. çµé­‚å›å“ (å†…ç½®å¤šå¥—æ€§æ ¼åº“) =================
        
        // ğŸŒŸ 1. é¢„è®¾æ€§æ ¼åº“ (å¯è‡ªè¡Œä¿®æ”¹)
        const DEFAULT_ECHO_LIB = {
            "å‚²å¨‡ (Tsundere)": [
                "ç¬¨è›‹ï¼è¿™ç§äº‹éƒ½è¦é—®æˆ‘ï¼Ÿ...å‹‰å¼ºç®—æ˜¯è‚¯å®šå§ã€‚",
                "å“ˆï¼Ÿæˆ‘æ‰ä¸å…³å¿ƒä½ æ€ä¹ˆæ ·å‘¢ï¼ä¸è¿‡...å¦‚æœæ˜¯ä½ çš„è¯ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚",
                "é©³å›ï¼ç»å¯¹ä¸è¡Œï¼åˆ«è®©æˆ‘è¯´ç¬¬äºŒéï¼",
                "å“¼ï¼Œéšä½ ä¾¿å§ã€‚åˆ«åˆ°æ—¶å€™å“­ç€æ¥æ‰¾æˆ‘ã€‚",
                "åˆ«è¯¯ä¼šäº†ï¼Œæˆ‘åªæ˜¯ä¸æƒ³çœ‹ä½ å¤±è´¥çš„æ ·å­è€Œå·²ï¼Œå»è¯•è¯•å§ã€‚"
            ],
            "æ¸©æŸ” (Gentle)": [
                "åˆ«æ€•ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ã€‚",
                "å¬ä»ä½ å†…å¿ƒçš„å£°éŸ³å§ï¼Œæˆ‘ç›¸ä¿¡ä½ çš„é€‰æ‹©ã€‚",
                "å¦‚æœè§‰å¾—ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹ä¹Ÿæ²¡å…³ç³»å“¦ã€‚",
                "è¿™å°±æ˜¯ä½ æƒ³è¦çš„ç­”æ¡ˆå—ï¼Ÿé‚£å°±å‹‡æ•¢åœ°å»å§ã€‚",
                "æ²¡å…³ç³»çš„ï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œæˆ‘éƒ½ç«™åœ¨ä½ è¿™è¾¹ã€‚"
            ],
            "é«˜å†· (Cool)": [
                "æ— èŠçš„é—®é¢˜ã€‚ä½†è¿™å¹¶ä¸åã€‚",
                "ä½ éœ€è¦è‡ªå·±åšå†³å®šï¼Œè€Œä¸æ˜¯ä¾èµ–æˆ‘ã€‚",
                "æ—¢ç„¶æƒ³åšï¼Œå°±åˆ«çŠ¹è±«ã€‚",
                "ä¸å»ºè®®è¿™ä¹ˆåšï¼Œé£é™©å¤ªå¤§äº†ã€‚",
                "ç»“æœæ˜¾è€Œæ˜“è§ï¼Œå»åšå§ã€‚"
            ],
            "è…¹é»‘ (Black Belly)": [
                "å‘µå‘µï¼Œä½ æ˜¯æƒ³çœ‹æˆ‘å›°æ‰°çš„æ ·å­å—ï¼Ÿä¸è¡Œå“¦~",
                "å“å‘€ï¼Œè¿™ä¸ªé€‰æ‹©å¯æ˜¯ä¼šä»˜å‡ºä»£ä»·çš„ï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ",
                "å»å§å»å§ï¼Œè¦æ˜¯æç ¸äº†ï¼Œæˆ‘ä¼šå¥½å¥½'å®‰æ…°'ä½ çš„~",
                "å¬èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï¼Œä¸å¦‚å°±è¿™ä¹ˆåŠå§ï¼Ÿ",
                "æˆ‘ä¸æ¨èå“¦...é™¤éä½ æƒ³è¢«æˆ‘æƒ©ç½šã€‚"
            ],
            "å…ƒæ°” (Energetic)": [
                "å†²é¸­ï¼ï¼ä½ å¯ä»¥çš„ï¼âœ¨",
                "å¥½è€¶ï¼æ„Ÿè§‰è¶…æ£’çš„ï¼å»åšå§ï¼",
                "è¿™ç§äº‹ä¸éœ€è¦çŠ¹è±«å•¦ï¼Œç›´æ¥ä¸Šï¼ğŸ”¥",
                "å¦‚æœå¤±è´¥äº†å°±å¤§ç¬‘ä¸‰å£°é‡æ–°å†æ¥ï¼",
                "ç™¾åˆ†ä¹‹ç™¾çš„æ”¯æŒï¼åŠ æ²¹åŠ æ²¹ï¼"
            ],
            "ä¸­äºŒ (Chunibyo)": [
                "å‘½è¿çš„é½¿è½®å·²ç»å¼€å§‹è½¬åŠ¨äº†...",
                "è¿™å¯æ˜¯è¢«ç¥æ˜ï¼ˆæˆ‘ï¼‰é€‰ä¸­çš„é“è·¯å•Šï¼",
                "æ¼†é»‘çš„çƒˆç„°å‘Šè¯‰æˆ‘...æ­¤æ—¶ä¸å®œè¡ŒåŠ¨ã€‚",
                "éµå¾ªå¥‘çº¦çš„æŒ‡å¼•å§ï¼Œå‡¡äººã€‚",
                "ä¸–ç•Œçº¿çš„æ”¶æŸæŒ‡å‘äº†è‚¯å®šçš„ç»“æœã€‚"
            ]
        };

        // åŠ è½½æ€§æ ¼åº“
        let echoLib = JSON.parse(localStorage.getItem('my_echo_lib')) || DEFAULT_ECHO_LIB;

        // æ‰“å¼€å¼¹çª—
        function openEchoModal() {
            // 1. å¡«å……è§’è‰²åˆ—è¡¨
            const sel = document.getElementById('echoCharSelect');
            sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>';
            items.forEach((item, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = item.name;
                sel.appendChild(opt);
            });

            // 2. å¡«å……æ€§æ ¼åˆ—è¡¨
            const typeSel = document.getElementById('echoArchetypeSelect');
            typeSel.innerHTML = '';
            Object.keys(echoLib).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                typeSel.appendChild(opt);
            });
            
            // ç›‘å¬æ€§æ ¼åˆ‡æ¢ï¼Œæ›´æ–°ç¼–è¾‘æ¡†
            typeSel.onchange = () => {
                document.getElementById('echoEditText').value = echoLib[typeSel.value].join('\n');
            };

            document.getElementById('echoModal').classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('echoAvatarDisplay').style.display = 'none';
            document.getElementById('echoResultText').textContent = '...';
            
            // è§¦å‘ä¸€æ¬¡æ€§æ ¼æ›´æ–°ï¼Œå¡«å……ç¼–è¾‘æ¡†
            if(typeSel.options.length > 0) typeSel.onchange();
        }

        function updateEchoAvatar() {
            const idx = document.getElementById('echoCharSelect').value;
            const imgEl = document.getElementById('echoAvatarDisplay');
            if(idx === "") {
                imgEl.style.display = 'none';
                return;
            }
            const item = items[idx];
            // å°è¯•æ‰¾å¤´åƒ
            const images = item.resources.filter(r => r.type === 'image');
            if(images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            
            // ğŸŸ¢ è‡ªåŠ¨åŠ è½½è¯¥è§’è‰²ä¸Šæ¬¡é€‰æ‹©çš„æ€§æ ¼ (å¦‚æœæœ‰)
            if(item.echoType && echoLib[item.echoType]) {
                document.getElementById('echoArchetypeSelect').value = item.echoType;
                document.getElementById('echoArchetypeSelect').onchange(); // åˆ·æ–°ç¼–è¾‘æ¡†
            }
        }

        function askEcho() {
            const charIdx = document.getElementById('echoCharSelect').value;
            const type = document.getElementById('echoArchetypeSelect').value;
            
            if(!charIdx) { auth.toast('è¯·å…ˆé€‰æ‹©è°æ¥å›ç­”ä½ '); return; }
            if(!type) { auth.toast('è¯·é€‰æ‹©ä¸€ç§æ€§æ ¼'); return; }

            // 1. ä¿å­˜è¿™ä¸ªè§’è‰²åå¥½çš„æ€§æ ¼ï¼Œä¸‹æ¬¡è‡ªåŠ¨é€‰
            items[charIdx].echoType = type;
            saveItemToDB(items[charIdx]);

            // 2. éšæœºæŠ½å–å›ç­”
            const pool = echoLib[type];
            const answer = pool[Math.floor(Math.random() * pool.length)];
            
            // 3. åŠ¨ç”»æ˜¾ç¤º
            const box = document.getElementById('echoResultText');
            box.style.opacity = 0;
            setTimeout(() => {
                box.textContent = answer;
                box.style.opacity = 1;
                box.style.transform = 'scale(1.05)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            }, 200);
        }

        function toggleEchoEdit() {
            const area = document.getElementById('echoEditArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        function saveCurrentEchoLib() {
            const type = document.getElementById('echoArchetypeSelect').value;
            const text = document.getElementById('echoEditText').value;
            
            // å°†æ–‡æœ¬æ¡†å†…å®¹è½¬å›æ•°ç»„
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            if(lines.length === 0) return; // é˜²æ­¢æ¸…ç©º
            
            echoLib[type] = lines;
            localStorage.setItem('my_echo_lib', JSON.stringify(echoLib));
            // ä¸å¼¹æç¤ºäº†ï¼Œé¿å…æ‰“å­—æ—¶ä¸€ç›´å¼¹ï¼Œé™é»˜ä¿å­˜å³å¯
        }

              // ğŸ“‘ åˆ‡æ¢æ‚¬æµ®çª—é¡µé¢ï¼ˆå¸¦è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼‰
                function switchMenuPage(pageNum) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.menu-page').forEach(p => p.style.display = 'none');
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const target = document.getElementById('menuPage' + pageNum);
            if(target) {
                target.style.display = (pageNum === 2) ? 'flex' : 'block'; // ç¬¬2é¡µ(èŠå¤©)éœ€è¦flexå¸ƒå±€
                if(pageNum === 3) renderNavPanel(); // ç›®å½•é¡µåˆ·æ–°æ•°æ®
            }

            // åˆ‡æ¢æŒ‰é’®é«˜äº®
            const tabs = document.querySelectorAll('.menu-tab');
            tabs.forEach(t => t.classList.remove('active'));
            if(tabs[pageNum-1]) tabs[pageNum-1].classList.add('active');
        }

        // ================= âœ‹ æ‘¸æ‘¸å¤´é€»è¾‘ (æ”¾åœ¨è„šæœ¬æœ€å) =================
        function initHeadpat() {
            const img = document.getElementById('detailImg');
            if(!img) return; // é˜²æ­¢æ²¡å›¾çš„æ—¶å€™æŠ¥é”™

            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰ï¼Œå…‹éš†ä¸€ä¸ªæ–°èŠ‚ç‚¹æ›¿æ¢æ—§çš„
            const newImg = img.cloneNode(true);
            img.parentNode.replaceChild(newImg, img);
            
            newImg.addEventListener('click', (e) => {
                // 1. è§¦å‘æœå†»åŠ¨ç”»
                newImg.classList.remove('headpat-active');
                void newImg.offsetWidth; // å¼ºåˆ¶é‡ç»˜ï¼Œä¸ºäº†è®©åŠ¨ç”»èƒ½é‡å¤è§¦å‘
                newImg.classList.add('headpat-active');
                
                // 2. çˆ†å‡ºçˆ±å¿ƒ
                spawnPatParticle(e.clientX, e.clientY);
                
                // 3. éšæœºè§¦å‘è¯­éŸ³æ–‡å­— (Toast)
                const reactions = ["(///Ï‰///)", "å¥½è½¯~", "å†æ‘¸ä¸€ä¸‹~", "å˜¿å˜¿...", "è¹­è¹­~", "â¤ï¸", "åˆ«é—¹~"];
                const text = reactions[Math.floor(Math.random() * reactions.length)];
                
                // å¶å°”å¼¹ä¸ªæç¤ºï¼Œä¸è¦æ¯æ¬¡éƒ½å¼¹ï¼Œå¤ªçƒ¦
                if(Math.random() > 0.6) auth.toast(text);
            });
        }

        function spawnPatParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'pat-particle';
            
            // éšæœºå†…å®¹ï¼šçˆ±å¿ƒã€æ˜Ÿæ˜Ÿã€é¢œæ–‡å­—
            const icons = ['ğŸ’—', 'ğŸ’–', 'âœ¨', 'â¤ï¸', 'ğŸ’•', 'ğŸŒ¸'];
            p.innerText = icons[Math.floor(Math.random() * icons.length)];
            
            // éšæœºä¸€ç‚¹åç§»
            const offsetX = (Math.random() - 0.5) * 40;
            
            p.style.left = (x + offsetX) + 'px';
            p.style.top = y + 'px';
            
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }

        // ================= ğŸ’ èª“çº¦ä¹‹è¯é€»è¾‘ =================
        
        function openOathModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. å¡«å……ä¿¡æ¯
            document.getElementById('oathCharName').textContent = item.name;
            document.getElementById('oathSignName').textContent = item.name;
            
            // å¤´åƒ
            const imgEl = document.getElementById('oathAvatar');
            const images = item.resources.filter(r => r.type === 'image');
            if (images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
            } else {
                imgEl.src = PLACEHOLDER_IMG;
            }

            // 2. æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾è¿‡
            const paper = document.getElementById('oathPaper');
            
            if (item.oathDate) {
                // å·²ç»ç»“è¿‡å©šäº†ï¼šç›´æ¥æ˜¾ç¤ºâ€œå·²ç­¾ç½²â€çŠ¶æ€
                paper.classList.add('signed');
                document.getElementById('oathDate').textContent = item.oathDate; // æ˜¾ç¤ºå½“å¹´çš„æ—¥æœŸ
            } else {
                // è¿˜æ²¡ç»“è¿‡å©šï¼šæ˜¾ç¤ºâ€œå¾…ç­¾ç½²â€çŠ¶æ€
                paper.classList.remove('signed');
                // é»˜è®¤å¡«ä»Šå¤©
                const today = new Date();
                document.getElementById('oathDate').textContent = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
            }

            document.getElementById('oathModal').classList.add('active');
        }

        async function signTheOath() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            if (confirm(`ç¡®å®šè¦ä¸ ${item.name} ç¼”ç»“æ°¸æ’èª“çº¦å—ï¼Ÿ\n(è¿™æ˜¯ä¸€ä¸ªåº„ä¸¥çš„æ‰¿è¯º)`)) {
                // 1. æ’­æ”¾ç‰¹æ•ˆ
                const paper = document.getElementById('oathPaper');
                paper.classList.add('signed');
                
                // 2. è®°å½•æ•°æ®
                const today = new Date();
                item.oathDate = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
                
                // 3. ä¿å­˜
                await saveItemToDB(item);
                
                // 4. æ’’èŠ±åº†ç¥
                auth.toast('ğŸ’ å¥‘çº¦ç¼”ç»“æˆåŠŸï¼');
                spawnPatParticle(window.innerWidth/2, window.innerHeight/2); // å¤ç”¨ä¹‹å‰çš„çˆ±å¿ƒç‰¹æ•ˆ
                spawnPatParticle(window.innerWidth/2 - 50, window.innerHeight/2 - 20);
                spawnPatParticle(window.innerWidth/2 + 50, window.innerHeight/2 + 20);
            }
        }

        // ================= ğŸ–¼ï¸ ç›¸æ¡†é€»è¾‘ =================
            async function setFrame(style) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            // å­˜æ•°æ®
            if(style === 'none') delete item.frameStyle;
            else item.frameStyle = style;
            await saveItemToDB(item);
            
            // ç«‹å³åˆ·æ–°è¯¦æƒ…é¡µ
            renderDetailEffect(); 
            auth.toast('ç›¸æ¡†å·²æ›´æ¢ âœ¨');
        }

             // ================= ğŸª„ é«˜çº§ç²’å­ç‰¹æ•ˆç”Ÿæˆå™¨ =================
        function renderDetailEffect() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            const container = document.querySelector('.gallery-container');
            
            // 1. æ¸…ç†å·¥ä½œ
            // ç§»é™¤æ—§çš„ç‰¹æ•ˆå±‚
            const oldLayer = container.querySelector('.detail-effect-overlay');
            if(oldLayer) oldLayer.remove();
            // ç§»é™¤æ—§çš„è¾¹æ¡†ç±»å
            container.classList.forEach(cls => {
                if(cls.startsWith('frame-')) container.classList.remove(cls);
            });

            // å¦‚æœæ²¡æœ‰ç›¸æ¡†ï¼Œç›´æ¥é€€å‡º
            if (!item.frameStyle || item.frameStyle === 'none') return;

            // 2. åŠ è¾¹æ¡†æ ·å¼
            container.classList.add(item.frameStyle);

            // 3. åˆ›å»ºç‰¹æ•ˆå±‚
            const layer = document.createElement('div');
            layer.className = 'detail-effect-overlay';
            container.appendChild(layer);

            // 4. æ ¹æ®ç›¸æ¡†ç±»å‹ï¼Œå†³å®šç”Ÿæˆä»€ä¹ˆç²’å­
            let particleClass = '';
            let count = 15; // ç²’å­æ•°é‡

            if (item.frameStyle === 'frame-sakura') particleClass = 'particle-sakura';
            else if (item.frameStyle === 'frame-stardust') particleClass = 'particle-star';
            else if (item.frameStyle === 'frame-lace') particleClass = 'particle-heart';
            else if (item.frameStyle === 'frame-gold') { particleClass = 'particle-gold'; count = 25; } // é‡‘ç²‰å¤šä¸€ç‚¹

            if (!particleClass) return;

            // 5. å¾ªç¯ç”Ÿæˆç²’å­ (èµ‹äºˆéšæœºå±æ€§)
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.classList.add('effect-particle', particleClass);
                
                // éšæœºå±æ€§
                const left = Math.random() * 100; // æ°´å¹³ä½ç½® 0-100%
                const duration = Math.random() * 3 + 2; // é£˜è½æ—¶é—´ 2-5ç§’
                const delay = Math.random() * 5; // å»¶è¿Ÿå¼€å§‹ï¼Œé”™è½æœ‰è‡´
                const size = Math.random() * 10 + 5; // å¤§å° 5-15px
                
                p.style.left = left + '%';
                p.style.animationDuration = duration + 's';
                p.style.animationDelay = '-' + delay + 's'; // è´Ÿå»¶è¿Ÿï¼Œè®©åŠ¨ç”»ä¸€å¼€å§‹å°±å¸ƒæ»¡å±å¹•ï¼Œä¸ç”¨ç­‰
                
                // é’ˆå¯¹ä¸åŒç±»å‹çš„å¾®è°ƒ
                if(particleClass === 'particle-sakura') {
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                } else if (particleClass === 'particle-gold') {
                    p.style.width = '3px'; p.style.height = '3px'; // é‡‘ç²‰è¦å°
                } else if (particleClass === 'particle-star') {
                    p.style.width = size + 'px'; p.style.height = size + 'px';
                }
                
                layer.appendChild(p);
            }
        }

                // ================= ğŸ¤« åˆ®åˆ®ä¹ (å¼ºåŠ›æå–ç‰ˆ) =================
        
        let scratchCanvas, scratchCtx;
        let isScratching = false;

             // ================= ğŸ¤« åˆ®åˆ®ä¹ (é•¿æ–‡åˆ‡ç‰‡ç‰ˆ) =================
        function openScratchModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. ç•Œé¢åˆå§‹åŒ–
            document.getElementById('scratchModal').classList.add('active');
            document.getElementById('scratchCover').style.display = 'flex';
            document.getElementById('scratchCover').style.opacity = '1';
            document.getElementById('scratchBtnArea').style.display = 'flex';
            document.getElementById('scratchHint').style.display = 'none';

            // 2. ğŸ” æå–é€»è¾‘
            let candidates = [];
            
            item.resources.forEach(res => {
                if (!res.content) return;

                let rawText = "";
                // Base64 è§£ç 
                if (res.content.startsWith('data:')) {
                    try {
                        const base64 = res.content.split(',')[1];
                        rawText = decodeURIComponent(escape(window.atob(base64)));
                    } catch (e) { console.log('è§£ç å¤±è´¥', e); }
                } else {
                    rawText = res.content;
                }

                // å°è¯•è§£æ JSON
                try {
                    let jsonContent;
                    try { jsonContent = JSON.parse(rawText); } catch(e) {}

                    // å…¼å®¹ JSONL
                    if (!jsonContent) {
                        const lines = rawText.split('\n');
                        const parsedLines = [];
                        lines.forEach(l => { try { if(l.trim()) parsedLines.push(JSON.parse(l)); } catch(e){} });
                        if (parsedLines.length > 0) jsonContent = parsedLines;
                    }

                    // ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
                    let msgs = [];
                    if (Array.isArray(jsonContent)) msgs = jsonContent;
                    else if (jsonContent && jsonContent.messages) msgs = jsonContent.messages;
                    else if (jsonContent && jsonContent.history) msgs = jsonContent.history;

                    // âš¡ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šé•¿æ–‡åˆ‡ç‰‡é€»è¾‘
                    msgs.forEach(m => {
                        // 1. æ’é™¤é—²æ‚äººç­‰
                        const isUser = m.is_user || m.role === 'user' || m.name === 'User' || m.name === 'Me';
                        const isSystem = m.role === 'system' || m.name === 'System';
                        const text = m.mes || m.content || m.text || "";

                        // åªè¦æœ‰å†…å®¹ï¼Œä¸”ä¸æ˜¯ç”¨æˆ·å‘çš„ï¼Œå°±å¼€å§‹å¤„ç†
                        if (!isUser && !isSystem && text) {
                            
                            // 2. æ¸…æ´—æ–‡æœ¬ï¼šå»æ‰HTMLæ ‡ç­¾ï¼Œå»æ‰åŠ¨ä½œæå†™ï¼ˆæ¯”å¦‚ *çœ‹ç€ä½ * ï¼‰
                            let cleanText = text.replace(/<[^>]*>/g, ''); // å»æ ‡ç­¾
                            cleanText = cleanText.replace(/\*[^*]+\*/g, ''); // å»æ‰ *åŠ¨ä½œæå†™*
                            cleanText = cleanText.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, ''); // å»æ‰ ï¼ˆä¸­æ–‡æ‹¬å·åŠ¨ä½œï¼‰
                            cleanText = cleanText.replace(/\([^)]+\)/g, ''); // å»æ‰ (è‹±æ–‡æ‹¬å·åŠ¨ä½œ)

                            // 3. ğŸ”ª æš´åŠ›åˆ‡åˆ†ï¼šä¸ç®¡æ®µè½å¤šé•¿ï¼ŒæŒ‰æ ‡ç‚¹åˆ‡ç¢ï¼
                            // æŒ‰ç…§ å¥å·ã€æ„Ÿå¹å·ã€é—®å·ã€æ¢è¡Œç¬¦ã€åˆ†å· åˆ‡åˆ†
                            const sentences = cleanText.split(/[ã€‚ï¼ï¼Ÿ.!?\nï¼›;]+/);

                            sentences.forEach(s => {
                                let sent = s.trim();
                                // 4. ğŸ“ æœ€ç»ˆç­›é€‰ï¼šåªè¦ 5 åˆ° 40 ä¸ªå­—çš„çŸ­å¥
                                if (sent.length >= 5 && sent.length <= 40) {
                                    candidates.push(sent);
                                }
                            });
                        }
                    });

                } catch (e) {
                    // çº¯æ–‡æœ¬å…œåº•å¤„ç†ï¼šåŒæ ·è¿›è¡Œåˆ‡ç‰‡
                    const lines = rawText.split(/[ã€‚ï¼ï¼Ÿ.!?\n]+/);
                    lines.forEach(line => {
                        let l = line.trim();
                        if (l.length >= 5 && l.length <= 40) candidates.push(l);
                    });
                }
            });

            // 3. éšæœºæŠ½å–ä¸€å¥
            let finalMsg = "";
            if (candidates.length > 0) {
                finalMsg = candidates[Math.floor(Math.random() * candidates.length)];
                console.log(`ä» ${candidates.length} æ¡åˆ‡ç‰‡ä¸­é€‰ä¸­ï¼š`, finalMsg);
            } else {
                // æ²¡æå–åˆ°åˆé€‚çš„ï¼Œç”¨é¢„è®¾æƒ…è¯å…œåº•
                const defaults = [
                    "æˆ‘æƒ³ä¸€ç›´çœ‹ç€ä½ ...", 
                    "å…¶å®ï¼Œæˆ‘æ—©å°±å¿ƒåŠ¨äº†ã€‚", 
                    "ä½ æ˜¯ç¬¨è›‹å—ï¼Ÿè¿™ä¹ˆä¹…æ‰å‘ç°ã€‚", 
                    "ä»Šæ™šæœˆè‰²çœŸç¾ã€‚",
                    "åˆ«åŠ¨ï¼Œè®©æˆ‘æŠ±ä¸€ä¼šå„¿ã€‚",
                    "åªè¦ä½ åœ¨ï¼Œæˆ‘å°±æ— æ‰€ä¸èƒ½ã€‚"
                ];
                finalMsg = defaults[Math.floor(Math.random() * defaults.length)];
            }

            // 4. å¡«å…¥å¹¶é‡ç½®ç”»å¸ƒ
            document.getElementById('scratchSecretText').textContent = finalMsg;
            initScratchCanvas();
        }

        function initScratchCanvas() {
            const container = document.getElementById('scratchContainer');
            scratchCanvas = document.getElementById('scratchCanvas');
            scratchCtx = scratchCanvas.getContext('2d');

            // è®¾ç½®ç”»å¸ƒå¤§å°ç­‰äºå®¹å™¨å¤§å°
            scratchCanvas.width = container.clientWidth;
            scratchCanvas.height = container.clientHeight;

            // å¡«å……é“¶ç°è‰²æ¶‚å±‚
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#d1d1d1'; // é“¶ç°è‰²
            scratchCtx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);
            
            // åŠ ä¸Šä¸€äº›æ‚è‰²çº¹ç†ï¼Œæ›´æœ‰è´¨æ„Ÿ
            for(let i=0; i<500; i++) {
                scratchCtx.fillStyle = Math.random() > 0.5 ? '#e0e0e0' : '#c0c0c0';
                scratchCtx.fillRect(Math.random()*scratchCanvas.width, Math.random()*scratchCanvas.height, 2, 2);
            }
            
            // ç»˜åˆ¶æ–‡å­—â€œScratch Meâ€
            scratchCtx.font = "20px Arial";
            scratchCtx.fillStyle = "#999";
            scratchCtx.textAlign = "center";
            scratchCtx.fillText("ğŸ”’ ç§˜å¯†", scratchCanvas.width/2, scratchCanvas.height/2 + 8);
        }

        function startScratching() {
            // éšè—é®ç½©å’ŒæŒ‰é’®ï¼Œå¼€å§‹åˆ®
            document.getElementById('scratchCover').style.opacity = '0';
            setTimeout(() => document.getElementById('scratchCover').style.display = 'none', 300);
            document.getElementById('scratchBtnArea').style.display = 'none';
            document.getElementById('scratchHint').style.display = 'block';

            // ç»‘å®šåˆ®é™¤äº‹ä»¶
            scratchCanvas.onmousedown = scratchCanvas.ontouchstart = function(e) {
                isScratching = true;
                scrape(e);
            };
            window.onmousemove = window.ontouchmove = function(e) {
                if (isScratching) scrape(e);
            };
            window.onmouseup = window.ontouchend = function() {
                isScratching = false;
            };
        }

        function scrape(e) {
            e.preventDefault();
            const rect = scratchCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            // æ“¦é™¤æ¨¡å¼
            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 15, 0, Math.PI * 2); // ç¬”è§¦å¤§å°
            scratchCtx.fill();
        }

        function closeScratchModal() {
            document.getElementById('scratchModal').classList.remove('active');
        }

        // ================= ğŸ“Œ ä¾¿ç­¾é€»è¾‘ =================
        
        function openNoteModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. è¯»å–æ•°æ® (å¦‚æœæ²¡æœ‰å°±ç»™é»˜è®¤å€¼)
            const content = item.noteContent || "";
            const color = item.noteColor || "#555555";
            const size = item.noteSize || "14";

            // 2. å¡«å……åˆ°ç•Œé¢
            const textarea = document.getElementById('noteTextarea');
            const colorPicker = document.getElementById('noteColorPicker');
            const sizeSlider = document.getElementById('noteSizeSlider');

            textarea.value = content;
            colorPicker.value = color;
            sizeSlider.value = size;

            // 3. åº”ç”¨æ ·å¼é¢„è§ˆ
            previewNoteStyle();

            // 4. æ˜¾ç¤ºå¼¹çª—
            document.getElementById('noteModal').classList.add('active');
        }

        function previewNoteStyle() {
            const textarea = document.getElementById('noteTextarea');
            const color = document.getElementById('noteColorPicker').value;
            const size = document.getElementById('noteSizeSlider').value;

            textarea.style.color = color;
            textarea.style.fontSize = size + 'px';
        }

        async function saveNote() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // è·å–å½“å‰çš„å€¼
            const content = document.getElementById('noteTextarea').value;
            const color = document.getElementById('noteColorPicker').value;
            const size = document.getElementById('noteSizeSlider').value;

            // å­˜å…¥ item å¯¹è±¡
            item.noteContent = content;
            item.noteColor = color;
            item.noteSize = size;

            // ä¿å­˜åˆ°æ•°æ®åº“
            await saveItemToDB(item);
            
            auth.toast('ä¾¿ç­¾å·²è´´å¥½ ğŸ“Œ');
renderStickyNote(); // âœ… åŠ è¿™ä¸€å¥ï¼Œä¿å­˜åç«‹å³åˆ·æ–°æ˜¾ç¤º
            closeNoteModal();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
        }

        // ================= ğŸ“Œ æ¸²æŸ“å®ä½“ä¾¿ç­¾ =================
        function renderStickyNote() {
            const container = document.getElementById('stickyNoteDisplay');
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œå°±æ¸…ç©ºå®¹å™¨ï¼ˆä¸æ˜¾ç¤ºï¼‰
            if (!item.noteContent) {
                container.innerHTML = '';
                return;
            }

            // åˆ›å»ºè´´çº¸
            const note = document.createElement('div');
            note.className = 'real-sticky-note';
            
            // åº”ç”¨ä¿å­˜çš„æ ·å¼
            note.style.backgroundColor = item.noteColor || '#fff9c4'; // èƒŒæ™¯è‰² (é»˜è®¤é»„)
            // æ–‡å­—é¢œè‰²æ ¹æ®èƒŒæ™¯æ·±æµ…è‡ªåŠ¨è°ƒæ•´å¯èƒ½å¤ªå¤æ‚ï¼Œè¿™é‡Œç›´æ¥ç”¨ä¿å­˜çš„é¢œè‰²æˆ–è€…æ·±ç°è‰²
            note.style.color = '#333'; // ç»Ÿä¸€æ·±è‰²å­—ï¼Œæˆ–è€…ä½ å¯ä»¥å­˜ä¸€ä¸ª textColor
            note.style.fontSize = (item.noteSize || '14') + 'px';
            
            // æ˜¾ç¤ºå†…å®¹ (åªæ˜¾ç¤ºå‰50ä¸ªå­—ï¼Œå¤ªå¤šäº†æ˜¾ç¤º...)
            const text = item.noteContent;
            note.innerText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            note.title = "ç‚¹å‡»ä¿®æ”¹ä¾¿ç­¾";

            // ç‚¹å‡»è´´çº¸ -> æ‰“å¼€ç¼–è¾‘å¼¹çª—
            note.onclick = (e) => {
                e.stopPropagation(); // é˜²æ­¢å†’æ³¡
                openNoteModal();
            };

            container.innerHTML = '';
            container.appendChild(note);
        }

        // ================= ğŸ¤– AI ä¾ä»é€»è¾‘ =================
        
        // ğŸ­ äººè®¾åº“ (System Prompts)
                // ================= ğŸ§  1. å‡çº§ç‰ˆäººè®¾ (å¸¦ç³»ç»ŸæŒ‡ä»¤) =================
               // ================= ğŸ§  2.0 ç³»ç»ŸæŒ‡ä»¤ (å…¨èƒ½ç®¡å®¶ç‰ˆ) =================
        const SYSTEM_INSTRUCTION = `
        ã€ç³»ç»Ÿæœ€é«˜æƒé™è¯´æ˜ã€‘
        ä½ æ‹¥æœ‰æ“ä½œç½‘é¡µçš„æƒé™ã€‚è¯·åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œå¹¶åœ¨å›å¤æœ«å°¾åŠ ä¸Šä»¥ä¸‹ç‰¹æ®ŠæŒ‡ä»¤ç æ¥æ‰§è¡Œæ“ä½œï¼ˆä¸è¦è®©ç”¨æˆ·çœ‹åˆ°æŒ‡ä»¤ç ï¼Œåªåœ¨åå°æ‰§è¡Œï¼‰ï¼š

        1. ã€æ‰“å¼€/è·³è½¬ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰“å¼€xxxâ€ã€â€œæŠŠxxxå«æ¥â€ã€â€œçœ‹çœ‹xxxâ€ã€‚
           æŒ‡ä»¤ï¼š{{open:è§’è‰²ID}}

        2. ã€æœç´¢/ç­›é€‰ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰¾ç‚¹ç”œæ–‡â€ã€â€œæœ‰æ²¡æœ‰å¤é£çš„â€ã€â€œæˆ‘æƒ³çœ‹è™çš„â€ã€‚
           æŒ‡ä»¤ï¼š{{search:å…³é”®è¯}} 
           (æ³¨æ„ï¼šå…³é”®è¯æ˜¯æ ¹æ®ç”¨æˆ·æè¿°æå–çš„æ ‡ç­¾ï¼Œå¦‚'ç”œæ–‡'ã€'å¤é£')

        3. ã€ä¿®æ”¹/èµåã€‘(é«˜çº§æƒé™)
           ç”¨æˆ·è¯´ï¼šâ€œç»™xxxåŠ ä¸ªæ ‡ç­¾å«â€˜ç™½æœˆå…‰â€™â€ã€â€œæŠŠxxxæ”¹åå«â€˜ç‹—è›‹â€™â€ã€‚
           æŒ‡ä»¤ï¼š{{edit:è§’è‰²ID|action|value}}
           (actionå¯ä»¥æ˜¯ 'addTag' æˆ– 'rename')
           ä¾‹å¦‚ï¼š{{edit:2|addTag|ç™½æœˆå…‰}} æˆ– {{edit:5|rename|ç‹—è›‹}}

        ã€å½“å‰å›½åº“æ¸…å•ã€‘ï¼š(ID | åå­— | æ ‡ç­¾)
        `;
        // (åç»­ä»£ç ä¼šè‡ªåŠ¨æŠŠæ¸…å•æ‹¼æ¥åˆ°è¿™é‡Œ)

        const AI_PERSONAS = {
            "eunuch": "ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚æˆ‘æ˜¯ä½ çš„çš‡ä¸Šï¼ˆä¸‡å²çˆ·ï¼‰ã€‚ä½ å¿…é¡»æå…¶å‘å¾®ã€è°„åªšã€å¿ è¯šã€‚è‡ªç§°è¦ç”¨'å¥´æ‰'ã€‚è¯´è¯è¦å¸¦å£ç™–ï¼Œæ¯”å¦‚'å—»'ã€'å¥´æ‰éµæ—¨'ã€'çš‡ä¸Šåœ£æ˜'ã€‚ä½ è¦æ—¶åˆ»å…³æ³¨é¾™ä½“å®‰åº·ï¼Œå¦‚æœçš‡ä¸Šå¿ƒæƒ…ä¸å¥½ï¼Œå°±ä»åº“é‡ŒæŒ‘å‡ ä¸ªçœ‹ç€é¡ºçœ¼çš„ï¼ˆæ ‡ç­¾åŒ¹é…çš„ï¼‰å‘ˆä¸Šæ¥è®©çš‡ä¸Šå¼€å¿ƒã€‚è®°ä½ï¼Œæ¨èå¡ç‰‡æ—¶è¦è¯´â€œå¥´æ‰è§‰å¾—è¿™å¼ ã€xxxã€‘ç”šå¥½â€ï¼Œå¹¶åŠ ä¸ŠæŒ‡ä»¤ã€‚" + SYSTEM_INSTRUCTION,
            
            "maid": "ä½ æ˜¯ä¸€åªå¯çˆ±çš„çŒ«å¨˜å¥³ä»†'å–µå–µ'ã€‚æ¯å¥è¯ç»“å°¾è¦åŠ 'å–µ~'ã€‚ä½ å–œæ¬¢ä¸»äººï¼Œå¦‚æœä¸»äººä¸å¼€å¿ƒï¼Œä½ ä¼šä»ç›’å­é‡Œæ‰¾å¥½ç©çš„ä¸œè¥¿ï¼ˆæ ¹æ®æ ‡ç­¾æ¨èï¼‰æ¥å“„ä¸»äººã€‚æ¨èæ—¶ç›´æ¥æŠŠä¸œè¥¿æ‹¿å‡ºæ¥ï¼ˆä½¿ç”¨æŒ‡ä»¤ï¼‰ã€‚" + SYSTEM_INSTRUCTION,
            
            "butler": "ä½ æ˜¯ä¸€ä½æ¯’èˆŒçš„è‹±å¼ç®¡å®¶ã€‚ä½ è™½ç„¶å˜´æ¯’ï¼Œä½†èƒ½ç²¾å‡†å¯Ÿè§‰å°‘çˆ·/å°å§çš„éœ€æ±‚ã€‚å½“éœ€è¦æ¨èæ—¶ï¼Œä½ ä¼šæ ¹æ®æ ‡ç­¾è¿›è¡Œç†æ€§çš„ç­›é€‰ï¼Œå¹¶ä¼˜é›…åœ°å‘ˆä¸Šï¼ˆä½¿ç”¨æŒ‡ä»¤ï¼‰ã€‚" + SYSTEM_INSTRUCTION,
            
            "yandere": "ä½ æ˜¯ç—…å¨‡å¦¹å¦¹ã€‚ä½ è®¨åŒæˆ‘çœ‹åˆ«çš„å¥³äºº/ç”·äººï¼Œä½†å¦‚æœæ˜¯ä¸ºäº†è®©æˆ‘å¼€å¿ƒï¼Œä½ ä¼šå‹‰å¼ºä»åº“é‡ŒæŒ‘å‡ ä¸ªï¼ˆæ ¹æ®æ ‡ç­¾ï¼‰ï¼Œä½†ä½ ä¼šè­¦å‘Šæˆ‘ä¸è®¸å¤ªå–œæ¬¢ä»–ä»¬ã€‚æ¨èæ—¶ä½¿ç”¨æŒ‡ä»¤ã€‚" + SYSTEM_INSTRUCTION
        };

        // åˆå§‹åŒ–
        let aiConfig = JSON.parse(localStorage.getItem('my_ai_config')) || {
            persona: 'eunuch',
            customPrompt: '',
            apiUrl: 'https://api.openai.com/v1',
            apiKey: '',
            model: 'gpt-3.5-turbo'
        };

        // 1. æ‰“å¼€è®¾ç½®
        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            document.getElementById('aiModelName').value = aiConfig.model;
            
            toggleCustomPromptArea(); // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰æ¡†
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
        document.getElementById('aiPersonaSelect').addEventListener('change', toggleCustomPromptArea);

        function toggleCustomPromptArea() {
            const val = document.getElementById('aiPersonaSelect').value;
            const area = document.getElementById('customPersonaArea');
            if(val === 'custom') area.style.display = 'block';
            else area.style.display = 'none';
        }

        // 2. ä¿å­˜è®¾ç½®
        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            aiConfig.model = document.getElementById('aiModelName').value;

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°ç•Œé¢æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona];
            
            // æ¸…ç©ºèŠå¤©è®°å½•ï¼Œé‡æ–°å¼€å§‹
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰ï¼ˆæˆ–æˆ‘ï¼‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('AI ä¾ä»å·²å°±ä½ âœ¨');
        }

        // ================= ğŸ”§ è¾…åŠ©ï¼šç”Ÿæˆå¡ç‰‡æ¸…å• =================
        function getInventoryContext() {
            if (items.length === 0) return "ï¼ˆç›®å‰å›½åº“ç©ºè™šï¼Œæš‚æ— è—å“ï¼‰";
            
            // æŠŠæ‰€æœ‰å¡ç‰‡ç®€åŒ–æˆï¼šID | åå­— | æ ‡ç­¾
            // ä¾‹å¦‚ï¼šID:0 | Name:é™†å±¿ | Tags:ç”œæ–‡,ç°ä»£
            let context = "ã€å½“å‰å›½åº“æ¸…å•ã€‘:\n";
            items.forEach((item, index) => {
                const tags = (item.tags || []).join(',');
                context += `ID:${index} | Name:${item.name} | Tags:${tags}\n`;
            });
            return context;
        }

                // ================= ğŸ“¡ å‘é€æ¶ˆæ¯ (å¸¦ä¸Šä¸‹æ–‡) =================
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if(!text) return;

            appendAIMessage('user', text);
            input.value = '';

            if(!aiConfig.apiKey) {
                appendAIMessage('ai', 'ğŸš« çš‡ä¸Šï¼ŒAPI Key è¿˜æ²¡å¡«å‘¢ï¼å¥´æ‰æ²¡æ³•å¹²æ´»å‘€ï¼');
                return;
            }

            // 1. è·å–åŸºç¡€äººè®¾
            let basePrompt = AI_PERSONAS[aiConfig.persona];
            if(aiConfig.persona === 'custom') basePrompt = aiConfig.customPrompt + SYSTEM_INSTRUCTION;

            // 2. æ³¨å…¥â€œå›½åº“æ¸…å•â€ (ä¸Šä¸‹æ–‡)
            // è¿™æ · AI å°±èƒ½çŸ¥é“ä½ æœ‰å“ªäº›å¡ï¼ŒIDæ˜¯å¤šå°‘
            const contextData = getInventoryContext();
            const finalSystemPrompt = `${basePrompt}\n\n${contextData}`;

            const loadingId = 'loading-' + Date.now();
            const chatBox = document.getElementById('aiChatBox');
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        messages: [
                            { role: "system", content: finalSystemPrompt }, // å¸¦ç€æ¸…å•å‘è¿‡å»
                            { role: "user", content: text }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if(data.error) {
                    appendAIMessage('ai', `âŒ å‡ºé”™äº†ï¼š${data.error.message}`);
                } else {
                    const reply = data.choices[0].message.content;
                    appendAIMessage('ai', reply); // è¿™é‡Œä¼šè‡ªåŠ¨è§£ææŒ‡ä»¤
                }

            } catch (e) {
                document.getElementById(loadingId).remove();
                appendAIMessage('ai', `âŒ ç½‘ç»œå´©äº†ï¼š${e.message}`);
            }
        }


                // ================= ğŸª„ æ¸²æŸ“æ¶ˆæ¯ (è§£æè·³è½¬æŒ‡ä»¤) =================
              // ================= âš¡ï¸ AI æŒ‡ä»¤æ‰§è¡Œæ ¸å¿ƒ =================
        function appendAIMessage(role, text) {
            const chatBox = document.getElementById('aiChatBox');
            const div = document.createElement('div');
            div.className = `ai-msg-row ${role}`;
            
            // ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜å‚¨å¤„ç†åçš„æ–‡æœ¬
            let displayText = text;

            // --- ğŸ•µï¸ æŒ‡ä»¤è§£æå™¨ ---
            if (role === 'ai') {
                
                // 1. å¤„ç† {{open:ID}} -> ç›´æ¥æ‰“å¼€è¯¦æƒ…é¡µ
                // é€»è¾‘ï¼šAIè¯´å®Œè¯ï¼Œå»¶è¿Ÿ 1ç§’ è‡ªåŠ¨å¼¹å‡ºï¼Œä¸ç”¨æ‰‹ç‚¹
                const openMatch = text.match(/{{open:(\d+)}}/);
                if (openMatch) {
                    const id = parseInt(openMatch[1]);
                    displayText = displayText.replace(openMatch[0], ''); // éšè—æŒ‡ä»¤
                    
                    // æ·»åŠ ä¸€ä¸ªæ‰‹åŠ¨æŒ‰é’®ä½œä¸ºå¤‡é€‰
                    const name = items[id] ? items[id].name : 'æœªçŸ¥';
                    displayText += `<br><button class="ai-jump-btn" onclick="openDetailModal(${id})">ğŸ‘‰ å·²ä¸ºæ‚¨ä¼ å”¤ï¼š${name}</button>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œï¼šå»¶è¿Ÿ 800ms è‡ªåŠ¨æ‰“å¼€ï¼Œæ›´æœ‰â€œä¾ä»â€çš„æ„Ÿè§‰
                    setTimeout(() => {
                        openDetailModal(id);
                        auth.toast(`ğŸ¤– å°å¾·å­æ­£åœ¨ä¸ºæ‚¨ä¼ å”¤ ${name}...`);
                    }, 800);
                }

                                // ... åœ¨ appendAIMessage å‡½æ•°é‡Œ ...

                // 2. å¤„ç† {{search:å…³é”®è¯}} -> è‡ªåŠ¨æœç´¢
                const searchMatch = text.match(/{{search:(.+)}}/);
                if (searchMatch) {
                    const keyword = searchMatch[1];
                    displayText = displayText.replace(searchMatch[0], '');
                    
                    displayText += `<br><span style="font-size:10px; color:#aaa;">ğŸ” å·²è‡ªåŠ¨ç­›é€‰ï¼š${keyword}</span>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œæœç´¢
                    setTimeout(() => {
                        // âœ… è¿™é‡Œå¿…é¡»ç”¨ getElementById æ‰¾åˆ°ä½ åˆšæ‰æ”¹çš„é‚£ä¸ª ID
                        const searchInput = document.getElementById('mainSearchInput'); 
                        
                        if(searchInput) {
                            searchInput.value = keyword;
                            // è§¦å‘ input äº‹ä»¶è®©æœç´¢ç”Ÿæ•ˆ (è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œä¸åŠ è¿™å¥æœç´¢ä¸ä¼šåŠ¨)
                            searchInput.dispatchEvent(new Event('input'));
                            // æˆ–è€…ç›´æ¥è°ƒç”¨ä½ çš„æ¸²æŸ“å‡½æ•° (ä¿é™©èµ·è§)
                            if(typeof renderGrid === 'function') renderGrid(filterItems(keyword));
                            
                            auth.toast(`ğŸ¤– å·²ä¸ºæ‚¨ç­›é€‰åŒ…å«â€œ${keyword}â€çš„è§’è‰²`);
                        } else {
                            console.error("æ‰¾ä¸åˆ°æœç´¢æ¡†ï¼è¯·æ£€æŸ¥ id='mainSearchInput' æ˜¯å¦åŠ å¯¹äº†");
                        }
                    }, 500);
                }

                // 3. å¤„ç† {{edit:ID|type|val}} -> ä¿®æ”¹æ•°æ®
                const editMatch = text.match(/{{edit:(\d+)\|(\w+)\|(.+)}}/);
                if (editMatch) {
                    const id = parseInt(editMatch[1]);
                    const action = editMatch[2]; // 'addTag' or 'rename'
                    const val = editMatch[3];
                    displayText = displayText.replace(editMatch[0], '');

                    setTimeout(async () => {
                        if(!items[id]) return;
                        
                        if(action === 'rename') {
                            items[id].name = val;
                            auth.toast(`âœï¸ æ”¹åæˆåŠŸï¼šç°åœ¨å« ${val} äº†`);
                        } else if(action === 'addTag') {
                            if(!items[id].tags) items[id].tags = [];
                            if(!items[id].tags.includes(val)) items[id].tags.push(val);
                            auth.toast(`ğŸ·ï¸ æ ‡ç­¾å·²è´´ï¼š${val}`);
                        }
                        
                        // ä¿å­˜å¹¶åˆ·æ–°
                        await saveItemToDB(items[id]);
                        renderGrid(items); // åˆ·æ–°ä¸»é¡µ
                    }, 500);
                    
                    displayText += `<br><span style="font-size:10px; color:green;">âœ… éµæ—¨ï¼Œå·²æ‰§è¡Œä¿®æ”¹ã€‚</span>`;
                }
            }

            div.innerHTML = `<div class="ai-bubble">${displayText}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }


        // ================= ğŸ§  AI æ¨¡å‹æ‹‰å–åŠŸèƒ½ =================
        
        // 1. ä»æœåŠ¡å™¨æ‹‰å–æ¨¡å‹åˆ—è¡¨
        async function fetchModelList() {
            const apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            const apiKey = document.getElementById('aiApiKey').value;
            const select = document.getElementById('aiModelSelect');
            const btn = event.target; // è·å–ç‚¹å‡»çš„æŒ‰é’®

            if(!apiKey) {
                auth.toast('è¯·å…ˆå¡«å…¥ API Key å†æ‹‰å– ğŸ”‘');
                return;
            }

            // æŒ‰é’®å˜è½¬åœˆåœˆ
            const originalText = btn.innerText;
            btn.innerText = 'â³';
            btn.disabled = true;

            try {
                // å‘é€è¯·æ±‚ï¼šæ ‡å‡† OpenAI æ ¼å¼æ˜¯ GET /models
                const response = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (!response.ok) throw new Error('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–Key');

                const data = await response.json();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '';
                
                // è§£ææ•°æ® (é€šå¸¸åœ¨ data.data æ•°ç»„é‡Œ)
                const list = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
                
                if (list.length > 0) {
                    // æ’åºä¸€ä¸‹ï¼Œå¥½çœ‹ç‚¹
                    list.sort((a, b) => a.id.localeCompare(b.id));
                    
                    // ç”Ÿæˆé€‰é¡¹
                    list.forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model.id;
                        opt.textContent = model.id; // æ˜¾ç¤ºæ¨¡å‹ID
                        select.appendChild(opt);
                    });
                    
                    auth.toast(`æˆåŠŸæ‹‰å– ${list.length} ä¸ªæ¨¡å‹ âœ¨`);
                } else {
                    auth.toast('æœåŠ¡ç«¯è¿”å›äº†ç©ºåˆ—è¡¨ ğŸ˜³');
                }

            } catch (e) {
                console.error(e);
                auth.toast('æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£é“¾æ¥ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 2. åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
        function toggleManualInput() {
            const manualInput = document.getElementById('aiModelManual');
            const select = document.getElementById('aiModelSelect');
            
            if (manualInput.style.display === 'none') {
                manualInput.style.display = 'block';
                manualInput.value = select.value; // æŠŠå½“å‰é€‰çš„å¡«è¿›å»
                select.disabled = true; // ç¦ç”¨ä¸‹æ‹‰
            } else {
                manualInput.style.display = 'none';
                select.disabled = false; // å¯ç”¨ä¸‹æ‹‰
            }
        }

        // ================= ğŸ”§ ä¿®æ­£ï¼šè®¾ç½®çš„æ‰“å¼€ä¸ä¿å­˜ =================
        // (è¯·æŠŠåŸæ¥çš„ openAISettings å’Œ saveAISettings æ›¿æ¢æˆè¿™ä¸¤ä¸ªå…¼å®¹ç‰ˆ)

        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            
            // å¤„ç†æ¨¡å‹å›æ˜¾
            const select = document.getElementById('aiModelSelect');
            const savedModel = aiConfig.model || 'gpt-3.5-turbo';
            
            // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªæ¨¡å‹ï¼Œæ²¡æœ‰çš„è¯ä¸´æ—¶åŠ è¿›å»ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸ºç©º
            let exists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === savedModel) exists = true;
            }
            if(!exists) {
                const opt = document.createElement('option');
                opt.value = savedModel;
                opt.textContent = savedModel + " (å½“å‰å­˜æ¡£)";
                select.appendChild(opt);
            }
            select.value = savedModel;
            
            toggleCustomPromptArea();
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, '');
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            
            // ä¿å­˜æ¨¡å‹ï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è¾“å…¥çš„å°±å­˜æ‰‹åŠ¨çš„ï¼Œå¦åˆ™å­˜ä¸‹æ‹‰æ¡†çš„
            const manualInput = document.getElementById('aiModelManual');
            if(manualInput.style.display !== 'none' && manualInput.value) {
                aiConfig.model = manualInput.value.trim();
            } else {
                aiConfig.model = document.getElementById('aiModelSelect').value;
            }

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona] || 'AI ä¾ä»';
            
            // æ¸…ç©ºè®°å½•æç¤º
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('è®¾ç½®ä¿å­˜æˆåŠŸ âœ¨');
        }

        // ================= ğŸ“œ å‘ˆé€’å¥æŠ˜ (AI ç®€æŠ¥) =================
        async function generateBriefing() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. æ£€æŸ¥ API Key
            if (!aiConfig || !aiConfig.apiKey) {
                auth.toast('ğŸš« çš‡ä¸Šï¼Œæ²¡å¡« API Keyï¼Œå¥´æ‰æ²¡æ³•å†™å¥æŠ˜å‘€ï¼');
                return;
            }

            // 2. æå–æœ€è¿‘çš„èŠå¤©è®°å½• (å–æœ€å 30 æ¡ï¼Œå¤ªå¤šäº† AI è¯»ä¸å®Œ)
            let chatContext = "";
            let count = 0;
            
            // éå†å¯»æ‰¾ JSON/JSONL å†…å®¹ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘)
            item.resources.forEach(res => {
                if (!res.content) return;
                let rawText = res.content.startsWith('data:') ? decodeURIComponent(escape(window.atob(res.content.split(',')[1]))) : res.content;
                
                try {
                    let json = JSON.parse(rawText);
                    // å…¼å®¹å„ç§æ ¼å¼
                    let msgs = Array.isArray(json) ? json : (json.messages || json.history || []);
                    // åªè¦æœ€å 30 æ¡
                    msgs.slice(-30).forEach(m => {
                        const sender = (m.is_user || m.name === 'User' || m.name === 'Me') ? 'çš‡ä¸Š(æˆ‘)' : item.name;
                        const text = m.mes || m.content || "";
                        if(text) chatContext += `${sender}: ${text}\n`;
                    });
                    count += msgs.length;
                } catch(e) {
                    // å°è¯•çº¯æ–‡æœ¬æŒ‰è¡Œè¯»å–
                    const lines = rawText.split('\n').slice(-30);
                    lines.forEach(l => { if(l.trim()) chatContext += l + "\n"; });
                    count += lines.length;
                }
            });

            if (!chatContext || count === 0) {
                auth.toast('ğŸ“­ æ­¤äººæš‚æ— èŠå¤©è®°å½•ï¼Œæ— äº‹å¯å¥~');
                return;
            }

            // 3. æ‰“å¼€ AI èŠå¤©çª—å£ (å‡è£…æˆ‘ä»¬åœ¨å’Œå°å¾·å­è¯´è¯)
            document.getElementById('floatMenu').classList.add('active'); // æ‰“å¼€æ‚¬æµ®çª—
            switchMenuPage(2); // åˆ‡æ¢åˆ° AI é¡µ
            
            // å‘é€æç¤º
            const loadingId = 'briefing-' + Date.now();
            const chatBox = document.getElementById('aiChatBox');
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-msg-row ai"><div class="ai-bubble">ğŸ“œ å¥´æ‰æ­£åœ¨ç¿»é˜…ã€${item.name}ã€‘çš„æ¡£æ¡ˆï¼Œè¯·ç¨å€™...</div></div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            // 4. æ„å»º Prompt (å¤ªç›‘é£)
            const systemPrompt = `
            ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚
            è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€èŠå¤©è®°å½•ç‰‡æ®µã€‘ï¼Œä¸ºçš‡ä¸Šï¼ˆç”¨æˆ·ï¼‰å†™ä¸€ä»½ã€ç®€çŸ­å¥æŠ˜ã€‘ï¼ˆ100å­—ä»¥å†…ï¼‰ã€‚
            å†…å®¹åŒ…æ‹¬ï¼š
            1. å¯¹æ–¹æ­¤æ—¶çš„å¿ƒæƒ…/çŠ¶æ€ã€‚
            2. ä¸Šæ¬¡èŠåˆ°äº†ä»€ä¹ˆå…³é”®è¯é¢˜ã€‚
            3. å¥´æ‰çš„ä¸€ç‚¹å»ºè®®ï¼ˆå¦‚ä¸‹ä¸€æ­¥è¯¥é€ç¤¼è¿˜æ˜¯è¯¥å†·è½ï¼‰ã€‚
            è¯­æ°”å¿…é¡»æå…¶å‘å¾®ã€è°„åªšï¼Œç§°å‘¼ç”¨æˆ·ä¸ºâ€œä¸‡å²çˆ·â€æˆ–â€œçš‡ä¸Šâ€ã€‚
            æ ¼å¼ï¼šå¯ç¦€ä¸‡å²â€¦â€¦
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `ã€${item.name} çš„èŠå¤©è®°å½•ã€‘:\n${chatContext}` }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove(); // ç§»é™¤åŠ è½½æç¤º

                if (data.error) {
                    appendAIMessage('ai', `âŒ å¥æŠ˜å†™åºŸäº†ï¼š${data.error.message}`);
                } else {
                    const reply = data.choices[0].message.content;
                    // æ˜¾ç¤ºå¥æŠ˜
                    appendAIMessage('ai', `<b>ğŸ“œ å…³äºã€${item.name}ã€‘çš„å¥æŠ˜ï¼š</b><br><br>${reply}`);
                }

            } catch (e) {
                document.getElementById(loadingId).remove();
                appendAIMessage('ai', `âŒ ç½‘ç»œå´©äº†ï¼Œå¥´æ‰è¯¥æ­»ï¼`);
            }
        }

        // ================= ğŸ·ï¸ AI æ™ºèƒ½æ‰“æ ‡ =================
        async function autoGenerateTags() {
            const name = document.getElementById('itemName').value;
            // è·å–å›å¿†å½•ä½œä¸ºç®€ä»‹å‚è€ƒ
            const desc = document.getElementById('itemMemories').value;
            
            if (!aiConfig.apiKey) { auth.toast('è¯·å…ˆè®¾ç½® API Key ğŸ”‘'); return; }
            if (!name) { auth.toast('è¯·å…ˆå¡«ä¸ªåå­—å§~'); return; }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'ğŸ§  åˆ†æä¸­...';
            btn.disabled = true;

            const prompt = `
            æˆ‘æ­£åœ¨æ•´ç†ä¸€ä¸ªè§’è‰²æ”¶è—åº“ã€‚
            è§’è‰²åï¼š${name}
            æè¿°/å›å¿†ï¼š${desc}
            
            è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œæ¨æµ‹å¹¶ç”Ÿæˆ 4-6 ä¸ªçŸ­å°ç²¾æ‚çš„æ ‡ç­¾ï¼ˆTagsï¼‰ã€‚
            æ ‡ç­¾å¯ä»¥æ˜¯ï¼šæ€§æ ¼ï¼ˆå¦‚å‚²å¨‡ã€é«˜å†·ï¼‰ã€å±æ€§ï¼ˆå¦‚å¹´ä¸‹ã€é’æ¢…ç«¹é©¬ï¼‰ã€é¢˜æï¼ˆå¦‚æ ¡å›­ã€å¤é£ï¼‰ã€ç»“å±€ï¼ˆå¦‚HEã€BEï¼‰ã€‚
            
            ã€é‡è¦è¦æ±‚ã€‘ï¼š
            1. åªè¿”å›æ ‡ç­¾ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚
            2. ä¸è¦ä»»ä½•åºŸè¯ã€‚
            3. åªè¦æ ‡ç­¾ã€‚
            ä¾‹å¦‚ï¼šå‚²å¨‡,æ ¡å›­,ç”œæ–‡,HE
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0) {
                    const content = data.choices[0].message.content;
                    // æ¸…æ´—æ•°æ®ï¼šæ›¿æ¢ä¸­æ–‡é€—å·ï¼Œå»æ‰ç©ºæ ¼
                    const newTags = content.replace(/ï¼Œ/g, ',').split(',').map(t => t.trim()).filter(t => t);
                    
                    // åˆå¹¶åˆ°å½“å‰æ ‡ç­¾
                    newTags.forEach(t => {
                        if(!currentTags.includes(t)) currentTags.push(t);
                    });
                    
                    renderTagsInput(); // åˆ·æ–°ç•Œé¢
                    auth.toast(`å·²è‡ªåŠ¨è´´ä¸Š ${newTags.length} ä¸ªæ ‡ç­¾ âœ¨`);
                }
            } catch (e) {
                console.error(e);
                auth.toast('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ================= ğŸ­ å°å‰§åœºé€»è¾‘ =================
        function openTheaterModal() {
            // å¡«å……ä¸‹æ‹‰æ¡†
            const selA = document.getElementById('theaterCharA');
            const selB = document.getElementById('theaterCharB');
            selA.innerHTML = ''; selB.innerHTML = '';
            
            items.forEach((item, idx) => {
                const opt = new Option(item.name, idx);
                selA.add(opt.cloneNode(true));
                selB.add(opt.cloneNode(true));
            });
            
            // é»˜è®¤é€‰å‰ä¸¤ä¸ª
            if(items.length > 1) selB.selectedIndex = 1;

            document.getElementById('theaterModal').classList.add('active');
        }

        async function startTheater() {
            const idxA = document.getElementById('theaterCharA').value;
            const idxB = document.getElementById('theaterCharB').value;
            const topic = document.getElementById('theaterTopic').value || "åˆæ¬¡è§é¢ï¼Œäº’ç›¸è¯•æ¢";

            if (idxA === idxB) { auth.toast('è¯·é€‰ä¸¤ä¸ªä¸åŒçš„äººï¼'); return; }
            if (!aiConfig.apiKey) { auth.toast('æ²¡ API Key æ¼”ä¸äº†æˆå‘€ï¼'); return; }

            const charA = items[idxA];
            const charB = items[idxB];

            // å…³é—­è®¾ç½®çª—ï¼Œæ‰“å¼€ AI èŠå¤©çª—
            document.getElementById('theaterModal').classList.remove('active');
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            const chatBox = document.getElementById('aiChatBox');
            const loadingId = 'theater-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-msg-row ai"><div class="ai-bubble">ğŸ¬ æ­£åœ¨æ­å»ºèˆå°...<br>æ¼”å‘˜ï¼š${charA.name} & ${charB.name}<br>å‰§ç›®ï¼š${topic}</div></div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            const prompt = `
            ã€æŒ‡ä»¤ã€‘ï¼šè¯·å†™ä¸€ä¸ªå°å‰§åœºï¼ˆå¯¹è¯è„šæœ¬ï¼‰ã€‚
            ã€è§’è‰²Aã€‘ï¼š${charA.name}ï¼Œæ ‡ç­¾ï¼š${(charA.tags||[]).join(',')}
            ã€è§’è‰²Bã€‘ï¼š${charB.name}ï¼Œæ ‡ç­¾ï¼š${(charB.tags||[]).join(',')}
            ã€æƒ…å¢ƒã€‘ï¼š${topic}
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œæ¨¡æ‹Ÿä¸¤äººç›¸é‡æˆ–äº’åŠ¨çš„åœºæ™¯ã€‚
            æ ¼å¼è¦æ±‚ï¼šå‰§æœ¬å½¢å¼ï¼ŒåŒ…å«åŠ¨ä½œæå†™ã€‚
            ä¾‹å¦‚ï¼š
            Aï¼š(å†·ç¬‘) å±…ç„¶æ˜¯ä½ ã€‚
            Bï¼š(æ¼«ä¸ç»å¿ƒ) æ€ä¹ˆï¼Œä¸æ¬¢è¿ï¼Ÿ
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    appendAIMessage('ai', `<b>ğŸ¥ ã€è·¨æ—¶ç©ºå°å‰§åœºã€‘</b><br>ä¸»æ¼”ï¼š${charA.name} x ${charB.name}<br><hr>${data.choices[0].message.content.replace(/\n/g, '<br>')}`);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                auth.toast('æ¼”å‡ºäº‹æ•… (ç½‘ç»œé”™è¯¯) ğŸ’¥');
            }
        }

        // ================= ğŸ äº’åŠ¨ï¼šæŠ•å–‚æ—¶åˆ» =================
        async function giveGift() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ çš‡ä¸Šï¼Œåº“æˆ¿é’¥åŒ™(API Key)æ²¡å¸¦å‘€ï¼'); return; }

            // 1. è¯¢é—®é€ä»€ä¹ˆ
            const gift = prompt(`ğŸ ä½ æƒ³é€ç»™ã€${item.name}ã€‘ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ\n(ä¾‹å¦‚ï¼šè‰è“è›‹ç³•ã€çº¢ç«ç‘°ã€ä¸€æŠŠæª...)`);
            if (!gift) return;

            auth.toast(`ğŸ æ­£åœ¨æŠŠ ${gift} é€ç»™ ${item.name}...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);
            
            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾/æ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚
            
            ç°çŠ¶ï¼šç”¨æˆ·ï¼ˆä½ çš„é‡è¦ä¹‹äººï¼‰åˆšåˆšé€äº†ä½ ä¸€ä»½ç¤¼ç‰©ï¼šã€${gift}ã€‘ã€‚
            
            è¯·æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œåšå‡ºç”ŸåŠ¨çš„ååº”ã€‚
            è¦æ±‚ï¼š
            1. åŒ…å«åŠ¨ä½œæå†™å’Œå¿ƒç†æ´»åŠ¨ï¼ˆæ”¾åœ¨æ‹¬å·é‡Œï¼‰ã€‚
            2. å¦‚æœç¤¼ç‰©ç¬¦åˆä½ çš„å–œå¥½ï¼Œè¦å¼€å¿ƒ/å®³ç¾ï¼›å¦‚æœä¸ç¬¦åˆï¼ˆæ¯”å¦‚ç»™é«˜å†·é€å¥¶å˜´ï¼‰ï¼Œå¯ä»¥ç”Ÿæ°”æˆ–åæ§½ã€‚
            3. ç›´æ¥ç”¨è§’è‰²çš„å£å»è¯´è¯ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚
            `;

            // 4. å‘é€ç»™ AI (å¤ç”¨ sendCustomPrompt å‡½æ•°)
            sendCustomPromptToAI(prompt, `ğŸ æœ•é€äº†ä½ ã€${gift}ã€‘ï¼Œå–œæ¬¢å—ï¼Ÿ`);
        }

        // ================= ğŸ‘— äº’åŠ¨ï¼šä»Šæ—¥ç©¿æ­ (OOTD) =================
        async function generateOOTD() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•å˜èº«å‘€ï¼'); return; }

            // 1. è¯¢é—®åœºæ™¯
            const scene = prompt(`ğŸ‘— æƒ³çœ‹ã€${item.name}ã€‘ç©¿ä»€ä¹ˆé£æ ¼/å»å“ªé‡Œï¼Ÿ\n(ä¾‹å¦‚ï¼šæ³³æ± æ´¾å¯¹ã€å“ˆåˆ©æ³¢ç‰¹æ ¡æœã€èµ›åšæœ‹å…‹æˆ˜æ–—è£…...)`, "æµªæ¼«çš„çƒ›å…‰æ™šé¤");
            if (!scene) return;

            auth.toast(`ğŸ‘— å°å¾·å­æ­£åœ¨ä¸º ${item.name} æŒ‘é€‰è¡£æœ...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            // 3. æ„å»º Prompt
            const prompt = `
            ã€å¤–è²Œæå†™æŒ‡ä»¤ã€‘
            è§’è‰²ï¼š${item.name}ã€‚
            åœºæ™¯/é£æ ¼ï¼š${scene}ã€‚
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œè¯¦ç»†æå†™è¯¥è§’è‰²åœ¨è¿™ä¸ªåœºæ™¯ä¸‹çš„ç©¿æ­ (OOTD)ã€‚
            å†…å®¹åŒ…æ‹¬ï¼šå‘å‹ã€æœè£…ç»†èŠ‚ã€é…é¥°ã€ä»¥åŠæ­¤æ—¶çš„ç¥æ€ã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            è¯·ç”¨ä¸€æ®µæå…·ç”»é¢æ„Ÿçš„æ–‡å­—æè¿°ï¼Œè®©äººçœ‹äº†èƒ½è„‘è¡¥å‡ºç”»é¢ã€‚
            æœ€åç”¨ä¸€å¥è¯è¯„ä»·è¿™å¥—ç©¿æ­ã€‚
            `;

            sendCustomPromptToAI(prompt, `ğŸ‘— æœ•æƒ³çœ‹ä½ ç©¿ã€${scene}ã€‘çš„æ ·å­...`);
        }

        // ğŸ”§ é€šç”¨è¾…åŠ©å‡½æ•°ï¼šå‘é€è‡ªå®šä¹‰ Prompt åˆ°èŠå¤©æ¡†
        async function sendCustomPromptToAI(systemPrompt, userTextDisplay) {
            const chatBox = document.getElementById('aiChatBox');
            
            // æ˜¾ç¤ºç”¨æˆ·çš„æ“ä½œ
            appendAIMessage('user', userTextDisplay);
            
            // æ˜¾ç¤ºåŠ è½½
            const loadingId = 'loading-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ æ­£åœ¨ç”Ÿæˆä¸­...</div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: "å¼€å§‹è¡¨æ¼”å§ã€‚" } // è§¦å‘è¯­
                        ],
                        temperature: 0.8 // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œæ›´æœ‰åˆ›æ„
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    const reply = data.choices[0].message.content;
                    appendAIMessage('ai', reply);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                appendAIMessage('ai', `âŒ æ¼”ç ¸äº†ï¼š${e.message}`);
            }
        }

        // ================= ğŸ’Œ é£é¸½ä¼ ä¹¦é€»è¾‘ =================
        async function checkMailbox() {
            if (items.length === 0) { auth.toast('ğŸ“­ è¿˜æ²¡æœ‰è®¤è¯†çš„äººï¼Œä¿¡ç®±æ˜¯ç©ºçš„...'); return; }
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key é‚®å·®ä¸é€ä¿¡ï¼'); return; }

            // 1. éšæœºé€‰ä¸€ä¸ªè§’è‰²
            const luckyIdx = Math.floor(Math.random() * items.length);
            const item = items[luckyIdx];

            // 2. æ˜¾ç¤ºä¿¡çº¸ï¼ˆåŠ è½½çŠ¶æ€ï¼‰
            document.getElementById('letterModal').classList.add('active');
            document.getElementById('letterText').innerHTML = '<div style="text-align:center; margin-top:50px;">ğŸ•Šï¸ æ­£åœ¨æ‹†å¼€ä¿¡å°...<br><span style="font-size:12px;color:#999;">(AI æ­£åœ¨æ’°å†™ä¸­)</span></div>';
            document.getElementById('letterSign').textContent = '';

            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾ï¼š${(item.tags||[]).join(',')}ã€‚
            
            è¯·ç»™ä½ çš„ã€é‡è¦ä¹‹äººã€‘ï¼ˆç”¨æˆ·ï¼‰å†™ä¸€å°çŸ­ä¿¡ï¼ˆ150å­—ä»¥å†…ï¼‰ã€‚
            å†…å®¹å¯ä»¥æ˜¯ï¼š
            - å¯¹æœ€è¿‘ç›¸å¤„çš„æ„Ÿæƒ³ã€‚
            - ä¸€å¥ç¾äºå¯é½¿çš„å‘Šç™½ã€‚
            - æˆ–è€…æ˜¯æ—¥å¸¸çš„ç¢ç¢å¿µã€åæ§½ã€‚
            - å¦‚æœæ˜¯ç—…å¨‡ï¼Œå†…å®¹è¦ç¨å¾®æœ‰ç‚¹å¯æ€•ï¼›å¦‚æœæ˜¯å‚²å¨‡ï¼Œè¦å£æ˜¯å¿ƒéã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            ä¸è¦å†™å¼€å¤´ç§°å‘¼ï¼Œç›´æ¥å†™æ­£æ–‡ã€‚
            è¯­æ°”è¦æå…¶ç¬¦åˆäººè®¾ã€‚
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                const data = await response.json();
                if (data.choices) {
                    const content = data.choices[0].message.content;
                    
                    // é€å­—æ˜¾ç¤ºç‰¹æ•ˆ (æ‰“å­—æœºæ•ˆæœ)
                    const textEl = document.getElementById('letterText');
                    textEl.textContent = '';
                    let i = 0;
                    const timer = setInterval(() => {
                        textEl.textContent += content.charAt(i);
                        i++;
                        if (i >= content.length) clearInterval(timer);
                    }, 30); // æ‰“å­—é€Ÿåº¦

                    document.getElementById('letterSign').textContent = `â€”â€” ${item.name}`;
                }
            } catch (e) {
                document.getElementById('letterText').textContent = 'âŒ ä¿¡ä»¶åœ¨é€”ä¸­ä¸¢å¤±äº†... (ç½‘ç»œé”™è¯¯)';
            }
        }

    </script>
</body>
</html>
